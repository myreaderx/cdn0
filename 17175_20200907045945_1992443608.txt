{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-09-07 12:59:15","updatedTime":"2020-09-07 12:59:15","title":"智能家居实践（番外篇）—— 接入 HomeKit 实现用 Siri 控制家电","link":"http://kittenyang.com/homebridge-practice/","description":"<p>前面我写了一个系列共三篇的智能家居实践，用的是 Amazon Echo 实现语音控制，但是 Amazon Echo 用户群体太小而且这玩意并没有在中国上市，日常使用中也是各种水土不服，让很多朋友有心无力。然而，正如你早就看到的标题中说的那样，我们还有更容易获得的工具，那就是 Siri。</p>\n\n<p>自从苹果推出了 HomeKit 以来，鉴于苹果庞大的用户量，不断开始有家电厂商开发出兼容 HomeKit 的家电。然而第一个吃螃蟹的人总是有代价的，这些电器的价格不是太贵就是中国买不到，所以使用 HomeKit 的仍然是小众群体。</p>\n\n<p>通过 HomeAssistant 我们实现了把普通家电接到同一个平台，并且实现了 Amazon Echo 进行语音控制，能否把 Amazon Echo 替换成 Siri 呢？答案当然是可以的，不然就不会有这篇文章了。</p>\n\n<p>这回又是美帝的极客站出来拯救世界，隆重介绍这个重量级的开源库：<a href=\"https://github.com/nfarina/homebridge\">homebridge</a>，通过逆向 HomeKit 协议让普通的 Wifi 设备也能接入 HomeKit 从而通过 Siri 控制。你可以<a href=\"https://www.npmjs.com/search?q=homebridge-plugin&#38;page=1&#38;ranking=optimal\">这里</a>找到所有 homebridge  相关的 plugin，已经有超过500个了。</p>\n\n<p>所以 homebridge 诞生之初和 HomeAssistant 并没有关系，但你可能注意到了，如果你每一个设备都安装一个 homebridge 相关的 plugin，太分散也不利于管理，所以，最好的办法是，把一个平台整体迁移过来。毋庸置疑，HomeAssistant 是目前管理智能家居最成熟也是最流行的平台，所以你只管把电器设备加到 HomeAssistant 就行，和 HomeBridge 只需要一个 Plugin 连接就行，这个 Plugin 就是 <a href=\"https://github.com/home-assistant/homebridge-homeassistant\">homebridge-homeassistant</a> ，它在 HomeAssistant 和 HomeKit 之间架起了一座桥梁，让 HomeBridge 可以直接使用 HomeAssistant 平台下的所有设备。所以大致的架构图是这个样子的：</p>\n\n<p><img src=\"http://kittenyang.com/content/images/2017/03/-----2017-03-26-23-06-26.png\" alt=\"\"></p>\n\n<p>HomeBridge 的核心是 <a href=\"https://github.com/KhaosT/HAP-NodeJS\">HAP-NodeJS</a> 这个框架，用 NodeJS 模拟了一个 HomeKit Accessory Server 。作者 <a href=\"https://github.com/KhaosT\">KhaosT</a> 是个在美留学的中国人，曾在苹果的 HomeKit 团队实习过，这也 make sense 了为何是他第一个逆向了苹果的 HomeKit 协议。这里面有个小八卦，当 KhaosT 逆向了 HomeKit 的时候写了篇博客，但由于涉及到商业机密被苹果法务要求删除文章，但好在代码已经早就 fork 开了所以代码才得以流传到现在。试想要是当初代码没有开源，恐怕我们现在还享受不到这一成果。</p>\n\n<p>其实我上面告诉你有 <a href=\"https://github.com/home-assistant/homebridge-homeassistant\">homebridge-homeassistant</a> 这个东西已经可以了，剩下的无非就是看 README 跟着做的事情。所以我不想把安装过程再复制粘贴一遍，我就说一下安装完之后如何和 HomeAssistant 桥接的操作了。</p>\n\n<p>若顺利安装完 HomeBridge，你就能在 pi 用户下找到 .homebridge 这个隐藏目录，把这个目录通过 Samba 共享出来就可以用 Finder 打开了。</p>\n\n<p><img src=\"http://kittenyang.com/content/images/2017/03/-----2017-03-26-22-53-29.png\" alt=\"\"></p>\n\n<p>然后修改 <strong>config.json</strong>：</p>\n\n<pre><code class=\"language-json\">{\n    \"bridge\": {\n        \"name\": \"KittensHome\", //修改\n        \"username\": \"B8:27:EB:A0:2C:A1\", //修改\n        \"port\": 45536, //修改\n        \"pin\": \"775-82-588\" //修改\n    },\n     \"platforms\": [\n      {\n        \"platform\": \"HomeAssistant\",\n        \"name\": \"HomeAssistant\",\n        \"host\": \"http://192.168.10.200:8123\", //修改\n        \"password\": \"xxxxxx\", //修改\n        \"supported_types\": [\"binary_sensor\", \"cover\", \"fan\", \"input_boolean\", \"light\", \"lock\", \"media_player\", \"scene\", \"sensor\", \"switch\"],\n        \"logging\": true\n      }\n    ]\n}\n</code></pre>\n\n<p>你只需要修改我标记修改的六个地方就行了，bridge.username 就是树莓派的 Mac 地址，port 和 pin 就是 HomeBridge 运行的端口和密码。这个密码等会和 HomeKit 配对使用。这里需要注意 \"port\"  必须<strong>大于0小于65536</strong>；username 必须是大写的 Mac 地址。\nplatforms.host 就是你的 HomeAssistant 所在的 IP 和端口，platforms.password 就是 HomeAssistant 的密码。</p>\n\n<p>然后，请严格按照以下步骤操作，如果你 HomeBridge 启动失败了，再次按照下面步骤重新操作：</p>\n\n<p>1.使用改新的 bridge.name, 新的bridge.port</p>\n\n<p>2.输入命令：sudo killall homebridge 关闭所有正在运行的 HomeBridge 服务</p>\n\n<p>3.手动删除 HomeBridge 文件夹下的 <strong>persist</strong> 文件夹。</p>\n\n<p><img src=\"http://kittenyang.com/content/images/2017/03/-----2017-03-27-00-05-17.png\" alt=\"\"></p>\n\n<p>4.输入命令：sudo systemctl restart home-assistant.service 重启 HomeAssistant 服务。</p>\n\n<p>5.务必等 HomeAssistant 服务启动完成，如果你像我之前文章提到的创建了一个 Automation 用于监听启动完成事件然后通过 IFTTT 或其他推送服务就可以很快知道 HA 什么时候启动完成了。或者你也可以通过命令 <em>sudo systemctl status home-assistant.service -l</em> 查看启动进程。然后，命令行输入 <em>homebridge</em> 就可以启动 HomeBridge 服务了。</p>\n\n<p>如果你看到了以下画面，说明 HomeBridge 已经成功启动了，快去看看手机吧。</p>\n\n<p><img src=\"http://kittenyang.com/content/images/2017/03/-----2017-03-26-23-47-48.png\" alt=\"\"></p>\n\n<p>按照以下步骤，找到 HomeBridge，输入刚才你指定的密码，然后一路下一步，最后就能看到所有 HomeAssistant 下的设备都集成到 HomeKit 了。\n<img src=\"http://kittenyang.com/content/images/2017/03/IMG_680F2BE85E86-1.jpeg\" alt=\"\"></p>\n\n<p>不希望显示的设备，你可以在 configuration.yaml 里通过 <code>homebridge_hidden</code> 属性关闭。</p>\n\n<pre><code class=\"language-yaml\">customize:  \n  switch.a_switch:\n    homebridge_hidden: true\n</code></pre>\n\n<p>一旦接入了 HomeKit ，就可以直接用 Siri 控制了，而且能听懂中文了，而且得益于 HomeKit 内建的功能和 Siri 天生具备的语义分析，你可以实现很多 Amazon Echo 做不到的操作，比如改变灯泡颜色，灯泡亮度。</p>\n\n<iframe height=\"498\" width=\"510\" src=\"http://player.youku.com/embed/XMjY2NTU4MzUyNA==\" frameborder=\"0\" 'allowfullscreen'=\"\"></iframe>","descriptionType":"html","publishedDate":"Sun, 26 Mar 2017 16:38:37 +0000","feedId":17175,"bgimg":"http://kittenyang.com/content/images/2017/03/-----2017-03-26-23-06-26.png","linkMd5":"4dcef4675e9517f3a8a4349fb4a88735","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn28@2020_4/2020/09/07/04-59-29-946_98050e133af71067.webp","destWidth":1308,"destHeight":988,"sourceBytes":950494,"destBytes":34688,"author":"KittenYang","articleImgCdnMap":{"http://kittenyang.com/content/images/2017/03/-----2017-03-26-23-06-26.png":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn28@2020_4/2020/09/07/04-59-29-946_98050e133af71067.webp","http://kittenyang.com/content/images/2017/03/-----2017-03-26-22-53-29.png":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn31@2020_6/2020/09/07/04-59-35-614_74a2cc532388a872.webp","http://kittenyang.com/content/images/2017/03/-----2017-03-27-00-05-17.png":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn41@2020_6/2020/09/07/04-59-33-500_2b9aa7c30b957f9d.webp","http://kittenyang.com/content/images/2017/03/-----2017-03-26-23-47-48.png":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn39@2020_4/2020/09/07/04-59-44-524_2200fcbfb2c92d8d.webp","http://kittenyang.com/content/images/2017/03/IMG_680F2BE85E86-1.jpeg":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn33@2020_1/2020/09/07/04-59-42-302_3a2e4acb5b748678.webp"},"publishedOrCreatedDate":1599454755479}],"record":{"createdTime":"2020-09-07 12:59:15","updatedTime":"2020-09-07 12:59:15","feedId":17175,"fetchDate":"Mon, 07 Sep 2020 04:59:15 +0000","fetchMs":606,"handleMs":30,"totalMs":31377,"newArticles":0,"totalArticles":15,"status":1,"type":0,"ip":"cf9af02d3e458080dedc42d3da41bbb4","hostName":"us-031*","requestId":"6f3b4e34839d43bc8896486896549e1c_17175","contentType":"text/xml; charset=utf-8","totalBytes":467938,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":5,"articlesImgsGithubTotal":5,"successGithubMap":{"myreaderx16":1,"myreaderx6":1,"myreaderx10":1,"myreaderx33":1,"myreaderx13":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 02:14:30","updatedTime":"2020-09-07 02:46:51","id":17175,"name":"Kitten 的时间胶囊","url":"http://kittenyang.com/rss/","subscriber":194,"website":null,"icon":"http://kittenyang.com/assets/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx64/cdn43@2020_2/2020/09/06/18-45-32-740_5adfc92982c1f0f8.ico","description":"你好，我是杨骑滔(@KITTEN-YANG)。在成为一个独立 iOS/U3D 开发者 & 独立音乐制作人的路上赶路。如果一定要在这个宝贵的位置写一句话，我希望把我最受益的一句话分享给你：Better late than never.","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":34688,"tmpBodyImgCdnBytes":433250,"tmpBgImgCdnBytes":0,"extra4":{"start":1599454754318,"total":0,"statList":[{"spend":1132,"msg":"获取xml内容"},{"spend":30,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":14923,"msg":"正文链接上传到cdn"}]},"extra5":5,"extra6":5,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://europe65.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe64.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-030.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-029.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"http://kittenyang.com/content/images/2017/03/-----2017-03-26-23-06-26.png","sourceStatusCode":200,"destWidth":1308,"destHeight":988,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn28@2020_4/2020/09/07/04-59-29-946_98050e133af71067.webp","sourceBytes":950494,"destBytes":34688,"targetWebpQuality":75,"feedId":17175,"totalSpendMs":15268,"convertSpendMs":62,"createdTime":"2020-09-07 12:59:15","host":"us-014*","referer":"http://kittenyang.com/homebridge-practice/","linkMd5ListStr":"4dcef4675e9517f3a8a4349fb4a88735,4dcef4675e9517f3a8a4349fb4a88735","githubUser":"myreaderx13","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"928.2 KB","destSize":"33.9 KB","compressRate":"3.6%"},{"code":1,"isDone":false,"source":"http://kittenyang.com/content/images/2017/03/-----2017-03-27-00-05-17.png","sourceStatusCode":200,"destWidth":804,"destHeight":414,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn41@2020_6/2020/09/07/04-59-33-500_2b9aa7c30b957f9d.webp","sourceBytes":90293,"destBytes":16930,"targetWebpQuality":75,"feedId":17175,"totalSpendMs":3391,"convertSpendMs":18,"createdTime":"2020-09-07 12:59:30","host":"us-030*","referer":"http://kittenyang.com/homebridge-practice/","linkMd5ListStr":"4dcef4675e9517f3a8a4349fb4a88735","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"88.2 KB","destSize":"16.5 KB","compressRate":"18.8%"},{"code":1,"isDone":false,"source":"http://kittenyang.com/content/images/2017/03/-----2017-03-26-22-53-29.png","sourceStatusCode":200,"destWidth":1410,"destHeight":236,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn31@2020_6/2020/09/07/04-59-35-614_74a2cc532388a872.webp","sourceBytes":73263,"destBytes":19868,"targetWebpQuality":75,"feedId":17175,"totalSpendMs":5940,"convertSpendMs":17,"createdTime":"2020-09-07 12:59:30","host":"europe64*","referer":"http://kittenyang.com/homebridge-practice/","linkMd5ListStr":"4dcef4675e9517f3a8a4349fb4a88735","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"71.5 KB","destSize":"19.4 KB","compressRate":"27.1%"},{"code":1,"isDone":false,"source":"http://kittenyang.com/content/images/2017/03/IMG_680F2BE85E86-1.jpeg","sourceStatusCode":200,"destWidth":2000,"destHeight":697,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn33@2020_1/2020/09/07/04-59-42-302_3a2e4acb5b748678.webp","sourceBytes":986316,"destBytes":123334,"targetWebpQuality":75,"feedId":17175,"totalSpendMs":12873,"convertSpendMs":87,"createdTime":"2020-09-07 12:59:30","host":"europe65*","referer":"http://kittenyang.com/homebridge-practice/","linkMd5ListStr":"4dcef4675e9517f3a8a4349fb4a88735","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"963.2 KB","destSize":"120.4 KB","compressRate":"12.5%"},{"code":1,"isDone":false,"source":"http://kittenyang.com/content/images/2017/03/-----2017-03-26-23-47-48.png","sourceStatusCode":200,"destWidth":1736,"destHeight":1392,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn39@2020_4/2020/09/07/04-59-44-524_2200fcbfb2c92d8d.webp","sourceBytes":777845,"destBytes":273118,"targetWebpQuality":75,"feedId":17175,"totalSpendMs":14904,"convertSpendMs":144,"createdTime":"2020-09-07 12:59:30","host":"us-029*","referer":"http://kittenyang.com/homebridge-practice/","linkMd5ListStr":"4dcef4675e9517f3a8a4349fb4a88735","githubUser":"myreaderx33","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"759.6 KB","destSize":"266.7 KB","compressRate":"35.1%"}],"successGithubMap":{"myreaderx16":1,"myreaderx6":1,"myreaderx10":1,"myreaderx33":1,"myreaderx13":1},"failGithubMap":{}}