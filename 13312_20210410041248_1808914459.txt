{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2021-04-10 12:08:41","updatedTime":"2021-04-10 12:08:41","title":"429 (Too Many Requests)を回避する(Laravel 8)","link":"http://bashalog.c-brains.jp/20/12/25-170000.php","description":"<p>どうもfujiharaです。先日ステータスコード429というのに出会いました。\n調べると利用していたLaravel8が出していました、今回はこれを回避する方法をご紹介します。</p>\n\n<h2>背景</h2>\n<p>先日アップした<a href=\"http://bashalog.c-brains.jp/20/12/23-190000.php\">分割アップロード</a>の\nバックエンドの処理をLaravel8で行っていました。ローカルでは問題なく動いてたのですが本番で動作確認を行うと\nファイルが大きいときにエラーを出していました。</p>\n<p>レスポンスコードを見ると、&quot;429 (Too Many Requests)&quot;とはじめはNginx側で制限とかあるのかなと\n調べていたのですが、LaravelのApi Routeは1分間で60回のリクエスト制限があることがわかりました。\n</p>\n\n<h2>解決方法</h2>\n<p>変更方法は本サイトの<a href=\"https://laravel.com/docs/8.x/routing#rate-limiting\" target=\"_blank\">Rate Limiting</a>\nを参考にRouteServiceProviderに以下のようにしました。</p>\n\n<pre>\n<code>\n    protected function configureRateLimiting()\n    {\n        //元々設定された 1分間60分\n        RateLimiter::for('api', function (Request $request) {\n            return Limit::perMinute(60)->by(optional($request->user())->id ?: $request->ip());\n        });\n\n<p>        //追加分<br />\n        RateLimiter::for('seventy', function () {<br />\n            return Limit::perMinute(70);<br />\n        });<br />\n    }<br />\n</code><br />\n</pre></p>\n\n<p>また元々設定されているKernel.php内の $middlewareGroups 内のthrottleをコメントアウトします。</p>\n\n<pre>\n<code>\n        'api' => [\n            //'throttle:api',\n            \\Illuminate\\Routing\\Middleware\\SubstituteBindings::class,\n        ],\n</code>\n</pre>\n\n<p>最後にapi.phpを以下のように変えました。</p>\n\n<pre>\n<code>\nRoute::get('/get', [CheckController::class, 'get']);\n↓\nRoute::middleware(['throttle:seventy'])->group(function() {\n    Route::get('/get', [CheckController::class, 'get']);\n});\n\n<p></code><br />\n</pre></p>\n\n<h2>結果</h2>\n\n<p>before (70回リクエスト)</p>\n\n<p><img alt=\"fujihara_20201225_01.gif\" src=\"http://bashalog.c-brains.jp/images/fujihara_20201225_01.gif\" width=\"1976\" height=\"1066\" class=\"mt-image-center\" style=\"text-align: center; display: block; margin: 0 auto 20px;\" /></p>\n\n<p>after (80回リクエスト)</p>\n\n<p><img alt=\"fujihara_20201225_02.gif\" src=\"http://bashalog.c-brains.jp/images/fujihara_20201225_02.gif\" width=\"1976\" height=\"1066\" class=\"mt-image-center\" style=\"text-align: center; display: block; margin: 0 auto 20px;\" /></p>\n\n<h2>まとめ</h2>\n<p>Kernel.phpの記載を削除しないと routes/api.php内のものは駄目でした。api.php とは別のファイルを作り、Kernel.phpはそのままにroutes/xxxx.php を新たに作って\n別個で管理するのも手だと思います。くれぐれも開けすぎにはご注意下さい。もちろんフロントでRequest数を調整するのもありかと思います。それでは皆さん良いお年を</p><img src=\"http://feeds.feedburner.com/~r/bashalog/~4/f5jqfMRRz0s\" height=\"1\" width=\"1\" alt=\"\"/>","descriptionType":"text/html","publishedDate":"Fri, 25 Dec 2020 08:00:00 +0000","feedId":13312,"bgimg":"http://bashalog.c-brains.jp/images/fujihara_20201225_01.gif","linkMd5":"143652631e58a085d78bcb7c74947e06","author":"fujihara","articleImgCdnMap":{"http://bashalog.c-brains.jp/images/fujihara_20201225_01.gif":null,"http://bashalog.c-brains.jp/images/fujihara_20201225_02.gif":null,"http://feeds.feedburner.com/~r/bashalog/~4/f5jqfMRRz0s":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn12@2020_5/2021/04/10/04-10-42-916_39b21cdf89c01a75.webp"},"publishedOrCreatedDate":1618027721175}],"record":{"createdTime":"2021-04-10 12:08:41","updatedTime":"2021-04-10 12:08:41","feedId":13312,"fetchDate":"Sat, 10 Apr 2021 04:08:41 +0000","fetchMs":42,"handleMs":12,"totalMs":247019,"newArticles":0,"totalArticles":30,"status":1,"type":0,"ip":"743e8d13052b973448e1a0678f035e64","hostName":"us-002*","requestId":"22b33468ac424f0592487ef8405ec1e8_13312","contentType":"text/xml; charset=UTF-8","totalBytes":72,"bgimgsTotal":1,"bgimgsGithubTotal":0,"articlesImgsTotal":3,"articlesImgsGithubTotal":1,"successGithubMap":{"myreaderx4":1},"failGithubMap":{}},"feed":{"createdTime":"2020-08-25 04:38:26","updatedTime":"2020-09-05 16:49:26","id":13312,"name":"バシャログ。","url":"http://feeds.feedburner.com/bashalog","subscriber":233,"website":null,"icon":"http://bashalog.c-brains.jp/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx61/cdn54@2020_1/2020/09/05/08-49-23-771_d818c23c759f7b14.ico","description":"横浜のシーブレイン Web制作スタッフによる技術情報ブログ。WebデザインやFireworks、WordPress、EC-CUBE、CakePHPなどの情報が満載！","weekly":null,"link":null},"noPictureArticleList":[{"createdTime":"2021-04-10 12:12:48","updatedTime":"2021-04-10 12:12:48","id":null,"feedId":13312,"linkMd5":"143652631e58a085d78bcb7c74947e06"}],"tmpCommonImgCdnBytes":0,"tmpBodyImgCdnBytes":72,"tmpBgImgCdnBytes":0,"extra4":{"start":1618027721112,"total":0,"statList":[{"spend":51,"msg":"获取xml内容"},{"spend":12,"msg":"解释文章"},{"spend":121931,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":125443,"msg":"正文链接上传到cdn"}]},"extra5":3,"extra6":1,"extra7ImgCdnFailResultVector":[null,null,null,null,null,null,null,null],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-017.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]},"http://europe66.herokuapp.com/":{"failCount":2,"successCount":1,"resultList":[200,null,null]},"http://europe67.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"http://feeds.feedburner.com/~r/bashalog/~4/f5jqfMRRz0s","sourceStatusCode":200,"destWidth":1,"destHeight":1,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn12@2020_5/2021/04/10/04-10-42-916_39b21cdf89c01a75.webp","sourceBytes":43,"destBytes":72,"targetWebpQuality":75,"feedId":13312,"totalSpendMs":425,"convertSpendMs":3,"createdTime":"2021-04-10 12:10:42","host":"europe66*","referer":"http://bashalog.c-brains.jp/20/12/25-170000.php","linkMd5ListStr":"143652631e58a085d78bcb7c74947e06","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"43 B","destSize":"72 B","compressRate":"167.4%"}],"successGithubMap":{"myreaderx4":1},"failGithubMap":{}}