{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-10-20 13:22:32","updatedTime":"2020-10-20 13:22:32","title":"GIPHY Gets Tagged by K-Nearest Neighbors","link":"https://engineering.giphy.com/?p=678","description":"\n<p>When a brand new GIF gets uploaded onto GIPHY.com, there’s usually not a lot of data associated with it to make sure that it’s discoverable via search. While we do rely on machine learning for tag generation, we also allow uploading users and GIPHY’s content team to manually add “tags”, which are keywords that help ensure good content is easy to find. However, how does one decide on the most effective tags?</p>\n\n\n\n<div class=\"wp-block-image\"><figure class=\"aligncenter\"><img src=\"https://lh6.googleusercontent.com/b1FyKys8S_YsPa_1ixvYyNbRYFKchAh8U7s7pO27814TivvjVd1neH9Mq-3MYama7-O1_0g2NeknJozvDyVGXby-Z-23fjg4B-xsHyXpcxo0q8OPkFb7y3dmur2fcUxEKm4f7BnG\" alt=\"\"/><figcaption>&#8220;manually adding tags on GIPHY&#8221;</figcaption></figure></div>\n\n\n\n<p>Tagging can be a fairly laborious and semantic process. Additionally, some GIFs aren’t as straightforward to tag as others which makes the process even more time consuming.&#160;</p>\n\n\n\n<p>What if there was a way to suggest tags to a GIF using underlying data? Not only would automating the process save time, it would also increase the likelihood that every GIF would appear in relevant search results. To test this idea, I built a service called GIPHY Tagz, which recommends tags to a GIF based on its metadata and a K-Nearest Neighbor model.</p>\n\n\n\n<h3><strong>What is K-Nearest Neighbor Algorithm?</strong></h3>\n\n\n\n<p>K-Nearest Neighbor (KNN) is a machine learning algorithm that classifies unlabeled data based on labeled data given to the model. For example, the model can be trained to recognize that GIFs with hand waving motions have been previously tagged with “hello”. Therefore, the model should tag “hello” for new GIFs with hand waving motion.</p>\n\n\n\n<p>To determine which GIFs have hand waving motions (or other features), we use Google Cloud Vision, which detects features in images. In addition to the feature list, GCV data includes a “confidence score” for each feature which conveys how confident the model is that the image contains that feature.</p>\n\n\n\n<div class=\"wp-block-image\"><figure class=\"aligncenter\"><img src=\"https://lh3.googleusercontent.com/90egr1yszJf-UKxxPX1HF7icN1ioj0tLii0mCacBy-FQ-9W91TLD7Na6P0tth16RwJdWWbGrfXe3m8wq97EdEKJ5seJ0P7e5YVP-vzMIc62z63eooQ8t_mmhGtiLjxro8j_RSu8O\" alt=\"\"/></figure></div>\n\n\n\n<p>In this simplified model, the X- and Y-Axes are the confidence values for two features. In a real KNN model, there would be one dimension for each GCV feature. The trained KNN model can take a new GIF and find the K most similar GIFs based on feature similarity, and recommend tags of those GIFs.</p>\n\n\n\n<div class=\"wp-block-image\"><figure class=\"aligncenter\"><img src=\"https://lh4.googleusercontent.com/fH_hXfz90PSXTcLOJiorUcN0PjhIsqfz5lMoZQ2I1zmbwF-OOBE3eQmTuaFdTGZBB4BeXp9tz_JGucRxRApPBtbu6ylamR9kThoVOPBG9f5gIYGh5UhLFZ2yNXlh9BWporLsKKyD\" alt=\"\"/></figure></div>\n\n\n\n<h3><br><strong>Training and Testing the Model</strong></h3>\n\n\n\n<div class=\"wp-block-image\"><figure class=\"aligncenter\"><img src=\"https://lh6.googleusercontent.com/NOeyCW2UD7Sqin2ZIillqETDzk5Gkpisr9a0LuSuDUeV6AcIiTM_gKPzrt8nrZX7G85ZiEBlC_wZ7H-AsvvS0gSRO7hKw_XwoKmwK-5PxFaCiXC0GACbmiNpB-Km1lY2ECzinwyH\" alt=\"\"/></figure></div>\n\n\n\n<p>As with other machine learning models, before we can use the KNN model, we need to train it with a set of training data. For GIPHY Tagz, I created a training set by starting with a list of the top 300 tags/search queries on GIPHY. I used this list to write a SQL query that looked through GIPHY’s Amazon Redshift database to select the top 10 GIFs that perform well for each search term based on click through rate difference. After fetching the metadata for each GIF, I dumped the metadata into a huge JSON file which was used for features and confidence scores.</p>\n\n\n\n<figure class=\"wp-block-image\"><img src=\"https://lh3.googleusercontent.com/hs5Hile_jjqg_YvsI6_gE-tGrumwSbuC2W84Fr_aZj_4zPFS5SpZ17eKVJmnnh8cAt77u1vodRawl5-1ZDJCylQy6_yyCBuCdmCxnIx1b7OpJf4cX3RZXk9vbTEFhzsCLl8EjeNU\" alt=\"\"/></figure>\n\n\n\n<p>Fortunately, there is a Python’s Scikit-Learn library that implemented K-Nearest Neighbors. The training data was in the form of a sparse matrix where the rows are GIF ids, the columns are features, and the values are the confidence scores. I loaded the training data into the KNN model and was ready to test it.</p>\n\n\n\n<p>Major props to anyone who specializes in machine learning because the testing part is incredibly painful. The first time I entered a cat GIF into my KNN model, the tags returned were “spa,” and “food.” Of course, my KNN model was not fully accurate due to the noise in the data and the limitation of working with only the top 300 search queries. However, I spent weeks trying to improve the precision and recall of the tags returned and I lost track of how many times I had to ask our data engineers for different approaches. I reduced the dimensions of the training data through principal component analysis and normalized the scores of the features through TF-IDF which both led to a decrease in the model’s accuracy. One successful approach was to use cosine similarity instead of euclidean metric when measuring the distance between each GIF. When I was finally satisfied with the accuracy of the tags returned by my KNN model, I collaborated with our internal React expert, Kyle, on a simple UI so that the service could be used by anyone in the company.</p>\n\n\n\n<h3><strong>Final Thoughts</strong></h3>\n\n\n\n<figure class=\"wp-block-image\"><img src=\"https://lh3.googleusercontent.com/EBwwKDYtwcJ9j2x-7MvuFOvgjhyucze4x41ZkuDU9fpt5q7HMpUMN__Z6aS294BXRN9HBT8UXil2BwNaJwfWID4UxBaU1-iS18EULJzN1V_bUrErbO39dzkoTH6HuaQL5OhA-Q03\" alt=\"\"/><figcaption>&#8220;GIPHY Tagz in action&#8221;</figcaption></figure>\n\n\n\n<p>GIPHY, at its core, aims to deliver the perfect GIF for every situation and GIPHY Tagz demonstrated that it could play an effective role in future tagging efforts.&#160;</p>\n\n\n\n<p>I would like to give a special shoutout to Jesse Ling, who was my mentor, and the Ad Products team for all the support they have given me throughout my internship whether that be giving career and life advice, introducing data engineering 101, explaining React basics, or even fixing my very many git conflicts.&#160;<br><br>— <a href=\"https://giphy.com/gifs/GrandCanyonTV-grand-canyon-circle-game-grandcanyon-Y0svgFcYkC5HtCYso1\">Alice Phan</a>, Engineering Intern</p>\n","descriptionType":"html","publishedDate":"Wed, 16 Oct 2019 15:14:01 +0000","feedId":47172,"bgimg":"https://lh6.googleusercontent.com/b1FyKys8S_YsPa_1ixvYyNbRYFKchAh8U7s7pO27814TivvjVd1neH9Mq-3MYama7-O1_0g2NeknJozvDyVGXby-Z-23fjg4B-xsHyXpcxo0q8OPkFb7y3dmur2fcUxEKm4f7BnG","linkMd5":"ec025852bf00aa48900e3b5bb6306e8e","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn51@2020_3/2020/10/20/05-22-38-735_ecabb3d49a530f2e.webp","destWidth":1069,"destHeight":536,"sourceBytes":3021199,"destBytes":1026792,"author":"Alice Phan","articleImgCdnMap":{"https://lh6.googleusercontent.com/b1FyKys8S_YsPa_1ixvYyNbRYFKchAh8U7s7pO27814TivvjVd1neH9Mq-3MYama7-O1_0g2NeknJozvDyVGXby-Z-23fjg4B-xsHyXpcxo0q8OPkFb7y3dmur2fcUxEKm4f7BnG":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn51@2020_3/2020/10/20/05-22-38-735_ecabb3d49a530f2e.webp","https://lh3.googleusercontent.com/90egr1yszJf-UKxxPX1HF7icN1ioj0tLii0mCacBy-FQ-9W91TLD7Na6P0tth16RwJdWWbGrfXe3m8wq97EdEKJ5seJ0P7e5YVP-vzMIc62z63eooQ8t_mmhGtiLjxro8j_RSu8O":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn72@2020_2/2020/10/20/05-22-40-899_f6e259af87bc89ce.webp","https://lh4.googleusercontent.com/fH_hXfz90PSXTcLOJiorUcN0PjhIsqfz5lMoZQ2I1zmbwF-OOBE3eQmTuaFdTGZBB4BeXp9tz_JGucRxRApPBtbu6ylamR9kThoVOPBG9f5gIYGh5UhLFZ2yNXlh9BWporLsKKyD":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn55@2020_5/2020/10/20/05-22-41-524_0a485de2b97c3278.webp","https://lh6.googleusercontent.com/NOeyCW2UD7Sqin2ZIillqETDzk5Gkpisr9a0LuSuDUeV6AcIiTM_gKPzrt8nrZX7G85ZiEBlC_wZ7H-AsvvS0gSRO7hKw_XwoKmwK-5PxFaCiXC0GACbmiNpB-Km1lY2ECzinwyH":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn59@2020_4/2020/10/20/05-22-41-490_497e83f9bb27b662.webp","https://lh3.googleusercontent.com/hs5Hile_jjqg_YvsI6_gE-tGrumwSbuC2W84Fr_aZj_4zPFS5SpZ17eKVJmnnh8cAt77u1vodRawl5-1ZDJCylQy6_yyCBuCdmCxnIx1b7OpJf4cX3RZXk9vbTEFhzsCLl8EjeNU":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn64@2020_4/2020/10/20/05-22-40-814_b721419e85aa9fbb.webp","https://lh3.googleusercontent.com/EBwwKDYtwcJ9j2x-7MvuFOvgjhyucze4x41ZkuDU9fpt5q7HMpUMN__Z6aS294BXRN9HBT8UXil2BwNaJwfWID4UxBaU1-iS18EULJzN1V_bUrErbO39dzkoTH6HuaQL5OhA-Q03":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn67@2020_3/2020/10/20/05-22-55-245_8f246ba5d07a74fa.webp"},"publishedOrCreatedDate":1603171352237}],"record":{"createdTime":"2020-10-20 13:22:32","updatedTime":"2020-10-20 13:22:32","feedId":47172,"fetchDate":"Tue, 20 Oct 2020 05:22:32 +0000","fetchMs":440,"handleMs":61,"totalMs":25178,"newArticles":0,"totalArticles":90,"status":1,"type":0,"ip":"05b50c64cd16569d0e135aedb1e28ee2","hostName":"us-010*","requestId":"757c356981bb4b9ab39c6af05d57e911_47172","contentType":"application/rss+xml; charset=UTF-8","totalBytes":5264718,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":6,"articlesImgsGithubTotal":6,"successGithubMap":{"myreaderx25":1,"myreaderx32":1,"myreaderx24":1,"myreaderx30":1,"myreaderx29":1,"myreaderx18":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 03:44:26","updatedTime":"2020-09-07 06:02:47","id":47172,"name":"GIPHY Engineering","url":"https://engineering.giphy.com/rss","subscriber":68,"website":null,"icon":"https://engineering.giphy.com/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx61/cdn70@2020_6/2020/09/06/22-02-33-329_56d71a1d1b1a6cf2.png","description":"GIPHY Engineering","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":1026792,"tmpBodyImgCdnBytes":4237926,"tmpBgImgCdnBytes":0,"extra4":{"start":1603171351655,"total":0,"statList":[{"spend":521,"msg":"获取xml内容"},{"spend":61,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":16668,"msg":"正文链接上传到cdn"}]},"extra5":6,"extra6":6,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-039.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-23.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe61.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-015.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-027.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://lh6.googleusercontent.com/b1FyKys8S_YsPa_1ixvYyNbRYFKchAh8U7s7pO27814TivvjVd1neH9Mq-3MYama7-O1_0g2NeknJozvDyVGXby-Z-23fjg4B-xsHyXpcxo0q8OPkFb7y3dmur2fcUxEKm4f7BnG","sourceStatusCode":200,"destWidth":1069,"destHeight":536,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn51@2020_3/2020/10/20/05-22-38-735_ecabb3d49a530f2e.webp","sourceBytes":3021199,"destBytes":1026792,"targetWebpQuality":75,"feedId":47172,"totalSpendMs":7897,"convertSpendMs":4942,"createdTime":"2020-10-20 13:22:32","host":"us-011*","referer":"https://engineering.giphy.com/?p=678","linkMd5ListStr":"ec025852bf00aa48900e3b5bb6306e8e,ec025852bf00aa48900e3b5bb6306e8e","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"2.9 MB","destSize":"1,002.7 KB","compressRate":"34%"},{"code":1,"isDone":false,"source":"https://lh3.googleusercontent.com/hs5Hile_jjqg_YvsI6_gE-tGrumwSbuC2W84Fr_aZj_4zPFS5SpZ17eKVJmnnh8cAt77u1vodRawl5-1ZDJCylQy6_yyCBuCdmCxnIx1b7OpJf4cX3RZXk9vbTEFhzsCLl8EjeNU","sourceStatusCode":200,"destWidth":1600,"destHeight":793,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn64@2020_4/2020/10/20/05-22-40-814_b721419e85aa9fbb.webp","sourceBytes":148556,"destBytes":44670,"targetWebpQuality":75,"feedId":47172,"totalSpendMs":1517,"convertSpendMs":47,"createdTime":"2020-10-20 13:22:40","host":"us-039*","referer":"https://engineering.giphy.com/?p=678","linkMd5ListStr":"ec025852bf00aa48900e3b5bb6306e8e","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"145.1 KB","destSize":"43.6 KB","compressRate":"30.1%"},{"code":1,"isDone":false,"source":"https://lh3.googleusercontent.com/90egr1yszJf-UKxxPX1HF7icN1ioj0tLii0mCacBy-FQ-9W91TLD7Na6P0tth16RwJdWWbGrfXe3m8wq97EdEKJ5seJ0P7e5YVP-vzMIc62z63eooQ8t_mmhGtiLjxro8j_RSu8O","sourceStatusCode":200,"destWidth":604,"destHeight":480,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn72@2020_2/2020/10/20/05-22-40-899_f6e259af87bc89ce.webp","sourceBytes":229901,"destBytes":113878,"targetWebpQuality":75,"feedId":47172,"totalSpendMs":1700,"convertSpendMs":545,"createdTime":"2020-10-20 13:22:40","host":"us-015*","referer":"https://engineering.giphy.com/?p=678","linkMd5ListStr":"ec025852bf00aa48900e3b5bb6306e8e","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"224.5 KB","destSize":"111.2 KB","compressRate":"49.5%"},{"code":1,"isDone":false,"source":"https://lh4.googleusercontent.com/fH_hXfz90PSXTcLOJiorUcN0PjhIsqfz5lMoZQ2I1zmbwF-OOBE3eQmTuaFdTGZBB4BeXp9tz_JGucRxRApPBtbu6ylamR9kThoVOPBG9f5gIYGh5UhLFZ2yNXlh9BWporLsKKyD","sourceStatusCode":200,"destWidth":480,"destHeight":362,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn55@2020_5/2020/10/20/05-22-41-524_0a485de2b97c3278.webp","sourceBytes":1817774,"destBytes":554740,"targetWebpQuality":75,"feedId":47172,"totalSpendMs":3005,"convertSpendMs":888,"createdTime":"2020-10-20 13:22:40","host":"europe-23*","referer":"https://engineering.giphy.com/?p=678","linkMd5ListStr":"ec025852bf00aa48900e3b5bb6306e8e","githubUser":"myreaderx30","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"1.7 MB","destSize":"541.7 KB","compressRate":"30.5%"},{"code":1,"isDone":false,"source":"https://lh6.googleusercontent.com/NOeyCW2UD7Sqin2ZIillqETDzk5Gkpisr9a0LuSuDUeV6AcIiTM_gKPzrt8nrZX7G85ZiEBlC_wZ7H-AsvvS0gSRO7hKw_XwoKmwK-5PxFaCiXC0GACbmiNpB-Km1lY2ECzinwyH","sourceStatusCode":200,"destWidth":500,"destHeight":281,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn59@2020_4/2020/10/20/05-22-41-490_497e83f9bb27b662.webp","sourceBytes":1194110,"destBytes":729014,"targetWebpQuality":75,"feedId":47172,"totalSpendMs":3131,"convertSpendMs":877,"createdTime":"2020-10-20 13:22:40","host":"europe61*","referer":"https://engineering.giphy.com/?p=678","linkMd5ListStr":"ec025852bf00aa48900e3b5bb6306e8e","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"1.1 MB","destSize":"711.9 KB","compressRate":"61.1%"},{"code":1,"isDone":false,"source":"https://lh3.googleusercontent.com/EBwwKDYtwcJ9j2x-7MvuFOvgjhyucze4x41ZkuDU9fpt5q7HMpUMN__Z6aS294BXRN9HBT8UXil2BwNaJwfWID4UxBaU1-iS18EULJzN1V_bUrErbO39dzkoTH6HuaQL5OhA-Q03","sourceStatusCode":200,"destWidth":1524,"destHeight":862,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn67@2020_3/2020/10/20/05-22-55-245_8f246ba5d07a74fa.webp","sourceBytes":6717685,"destBytes":2795624,"targetWebpQuality":60,"feedId":47172,"totalSpendMs":16653,"convertSpendMs":9989,"createdTime":"2020-10-20 13:22:40","host":"us-027*","referer":"https://engineering.giphy.com/?p=678","linkMd5ListStr":"ec025852bf00aa48900e3b5bb6306e8e","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"6.4 MB","destSize":"2.7 MB","compressRate":"41.6%"}],"successGithubMap":{"myreaderx25":1,"myreaderx32":1,"myreaderx24":1,"myreaderx30":1,"myreaderx29":1,"myreaderx18":1},"failGithubMap":{}}