{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-10-09 23:59:30","updatedTime":"2020-10-09 23:59:30","title":"一种集群跟随路径移动的方法","link":"https://wuzhiwei.net/?p=938","description":"<p>在RTS游戏中，寻路是相对容易的，A*算法可以较高的效率寻到最优解，改变一下估值函数，也可以用更快的速度寻找到次优解，所以寻路在大多数时候并不是问题所在。</p>\n\n<p>假设一个集群，需要从位置A移动到位置B，中间充满了各种障碍，如何移动才显得比较自然？这是一个比较困难的问题。</p>\n\n<p>有一种方案是给每个集群中的单位都做一次寻路，但是寻路算法开销较大，如果集群中的单位较多则会面临性能问题。另一种方案是进行一次寻路，从A到B，然后考虑一种方式使得集群沿着该路径进行移动。</p>\n\n<p>初步的想法很简单，所有单位全部沿路径移动即可。但是由于单位众多，而路径只有一条线，这样所有单位变会在这条线上互相挤压，导致观感很不自然且效率很低。</p>\n\n<p><img src=\"https://wuzhiwei.net/articlePic/follow_path_movement.gif\" alt=\"@集群沿路径移动 | center\"></p>\n\n<p>上图便是一个相对较为自然的集群沿路径移动的效果图，而本文将阐述其背后的方法。</p>\n\n<p>在上世纪80年代，<a href=\"http://www.red3d.com/cwr/\">Craig W. Reynolds</a>便提出了一系列集群移动的分解方法，其将看似很复杂无规律的集群移动分解为多个不相干的小型移动算法。这些算法都被称为Steer算法，在其发表的文章<a href=\"http://www.red3d.com/cwr/steer/gdc99/\">Steering Behaviors For Autonomous Characters</a>中有详细的介绍。</p>\n\n<p>为了简化运算，我们假定所有的单位和障碍都为圆，圆心为其质点。</p>\n\n<h2>通道跟随</h2>\n\n<p>对我们最有启发的便是<a href=\"https://www.red3d.com/cwr/steer/PathFollow.html\">Path Following Steer</a>，与跟随一条线状路径不同，其定义了一个有宽度的通道，集群将沿着这条通道移动。\n<img src=\"https://wuzhiwei.net/articlePic/path_follow_steer.gif\" alt=\"@Path Following|center\"></p>\n\n<p>与线不同，通道具有宽度，就跟马路一样，这样所有单位不会拥挤在一条线上，从而使得竞争更少，移动也更加自然一些。</p>\n\n<p><img src=\"https://wuzhiwei.net/articlePic/follow_path_steer.png\" alt=\"@Follow Channel Steer | center\"></p>\n\n<p>如上图所示，中间一条实线为路径线，上下两条虚线为通道的边界，圆为一个正在移动的集群单位。红色向量$\\vec d$为这个单位此刻的方向向量，K为下一帧的预期位置，P为其在路径上的投影点，N为从P点沿着路径向前移动$|\\vec d|$所得的点，向量$\\vec v$为单位质点指向N点的向量。</p>\n\n<p>计算K到路径的投影距离便可知其大于路径宽度，所以K点在通道范围之外。如果按照预期方向，单位将会跑出通道，所以此时我们需要向单位施加一个通道跟随向量。这个向量即为$ \\vec v &#8211; \\vec d = \\vec m$，我们把蓝色的修正向量$\\vec m$与当前方向向量$\\vec d$相加便可得到经过通道跟随修正的方向向量。</p>\n\n<p>如果K点在通道内，则说明下一帧单位不会移出通道，这时候我们不需要对单位的方向向量做通道跟随的修正，即$\\vec m = 0$。</p>\n\n<h2>避障</h2>\n\n<h3>躲避静态障碍</h3>\n\n<p>对于静态障碍，行军单位需要躲避，以免发生碰撞。</p>\n\n<p>首先，我们需要确定是否会发生碰撞，与哪个障碍发生碰撞。这个比较简单，只需要拿下一帧的预期位置与各个障碍物的质点算距离。如果距离小于单位和障碍的半径和，我们便可知单位与该障碍即将发生碰撞。这一步的距离计算可以求平方以避免距离的开方的开销。</p>\n\n<p>如果预期发生碰撞，那我们便需要对行进方向再次做出修正，这个Steer叫做<a href=\"http://www.red3d.com/cwr/steer/Obstacle.html\">Obstacle Avoid Steer</a>。</p>\n\n<p><img src=\"https://wuzhiwei.net/articlePic/obstacle_avoid_steer.png\" alt=\"@Obstacle Avoid Steer|center\"></p>\n\n<p>如上图所示，当前方向向量为$\\vec u$，我们取单位质心C与障碍质心O的反向连线向量为$\\vec b$，则避障的修正向量$\\vec m = \\vec b &#8211; \\vec u$。</p>\n\n<h3>与同伴保持距离</h3>\n\n<p>在行进过程中，行军单位还需要与同伴保持一定距离，以免互相发生碰撞。</p>\n\n<p>这个Steer叫做Separation，其与Alignment和Cohesion组合可以模拟令人信服的鸟群或者其他集群的运动效果，这些算法的集合叫做<a href=\"http://www.red3d.com/cwr/boids/\">Flocking</a>。</p>\n\n<p><img src=\"https://wuzhiwei.net/articlePic/separation_steer.gif\" alt=\"@Separation Steer|center\"></p>\n\n<p>Separation的原理是搜集自身一定范围内的同伴，然后将其搜索到的同伴与自身连线的反方向的方向向量做加权相加，这个权重一般取为1/r，r为与同伴的距离。可以用以下公式表示：\n$$\n\\vec S =  \\vec V_1  / r_1 + \\vec V_2  / r_2 + &#8230; + \\vec V_n  / r_n\n$$</p>\n\n<h2>Unity Demo</h2>\n\n<p>本文只粗略了阐述了思想，并没有附上具体代码。为此我上传了一个Unity的Demo到Github，文章开头的效果图便是出自该Demo。</p>\n\n<p>Demo地址：<a href=\"https://github.com/iWoz/path_follow_steer\">https://github.com/iWoz/path_follow_steer</a>。</p>\n\n<h2>参考资料</h2>\n\n<ul>\n    <li><a href=\"https://www.red3d.com/cwr/steer/gdc99/\">Steering Behaviors For Autonomous Characters</a></li>\n</ul>\n","descriptionType":"html","publishedDate":"Wed, 23 Oct 2019 15:12:05 +0000","feedId":28801,"bgimg":"https://wuzhiwei.net/articlePic/follow_path_movement.gif","linkMd5":"3004f7ec72722ede6c52776996c28a36","destWidth":612,"destHeight":398,"sourceBytes":2085390,"destBytes":2371048,"author":"Tim","articleImgCdnMap":{"https://wuzhiwei.net/articlePic/follow_path_movement.gif":null,"https://wuzhiwei.net/articlePic/path_follow_steer.gif":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn18@2020_3/2020/10/09/15-59-56-813_511926df1652c907.webp","https://wuzhiwei.net/articlePic/follow_path_steer.png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn7@2020_2/2020/10/09/15-59-57-015_b43fa3f5d3530b5a.webp","https://wuzhiwei.net/articlePic/obstacle_avoid_steer.png":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn10@2020_2/2020/10/09/15-59-56-934_2daf763fa7d8c2c0.webp","https://wuzhiwei.net/articlePic/separation_steer.gif":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn16@2020_6/2020/10/09/15-59-56-576_59bfa4583d5123e2.webp"},"publishedOrCreatedDate":1602259170692}],"record":{"createdTime":"2020-10-09 23:59:30","updatedTime":"2020-10-09 23:59:30","feedId":28801,"fetchDate":"Fri, 09 Oct 2020 15:59:30 +0000","fetchMs":3228,"handleMs":36,"totalMs":31742,"newArticles":0,"totalArticles":10,"status":1,"type":0,"ip":"c9b07c3837817a0a4bbbf2d3e5487579","hostName":"us-021*","requestId":"403ef20383fb4d6a93e344c231e13bfb_28801","contentType":"application/rss+xml; charset=UTF-8","totalBytes":44006,"bgimgsTotal":1,"bgimgsGithubTotal":0,"articlesImgsTotal":5,"articlesImgsGithubTotal":4,"successGithubMap":{"myreaderx25":1,"myreaderx21":1,"myreaderx32":1,"myreaderx12":1},"failGithubMap":{"myreaderx14":1}},"feed":{"createdTime":"2020-09-07 02:45:09","updatedTime":"2020-09-07 04:49:25","id":28801,"name":"Tim's Blog","url":"http://wuzhiwei.net/feed/","subscriber":113,"website":null,"icon":"https://wuzhiwei.net/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx63/cdn28@2020_6/2020/09/06/20-49-17-095_3c720ebe184b9ced.ico","description":"Thinking, Coding && Writing","weekly":null,"link":null},"noPictureArticleList":[{"createdTime":"2020-10-09 23:59:57","updatedTime":"2020-10-09 23:59:57","id":null,"feedId":28801,"linkMd5":"3004f7ec72722ede6c52776996c28a36"}],"tmpCommonImgCdnBytes":0,"tmpBodyImgCdnBytes":44006,"tmpBgImgCdnBytes":0,"extra4":{"start":1602259166146,"total":0,"statList":[{"spend":4511,"msg":"获取xml内容"},{"spend":36,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":2759,"msg":"正文链接上传到cdn"}]},"extra5":5,"extra6":5,"extra7ImgCdnFailResultVector":[{"code":1,"isDone":false,"source":"https://wuzhiwei.net/articlePic/follow_path_movement.gif","sourceStatusCode":200,"destWidth":612,"destHeight":398,"sourceBytes":2085390,"destBytes":2371048,"targetWebpQuality":75,"feedId":28801,"totalSpendMs":15219,"convertSpendMs":4447,"createdTime":"2020-10-09 23:59:30","host":"europe62*","referer":"https://wuzhiwei.net/?p=938","linkMd5ListStr":"3004f7ec72722ede6c52776996c28a36,3004f7ec72722ede6c52776996c28a36","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx14/cdn94/contents/2020/10/09/15-59-45-193_f48dcaf22d0c6172.webp","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 68584859.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Fri, 09 Oct 2020 15:59:46 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["403 Forbidden"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["C860:FB7B:65DF164:7820323:5F8088EE"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, read:packages, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1602260515"],"x-ratelimit-used":["60"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx14/cdn94/contents/2020/10/09/15-59-45-193_f48dcaf22d0c6172.webp","historyStatusCode":[],"spendMs":839},"base64UserPassword":null,"token":"6b67d******************************91b08"},"githubUser":"myreaderx14","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"2 MB","destSize":"2.3 MB","compressRate":"113.7%"},{"code":1,"isDone":false,"source":"https://wuzhiwei.net/articlePic/follow_path_movement.gif","sourceStatusCode":200,"destWidth":612,"destHeight":398,"sourceBytes":2085390,"destBytes":2371048,"targetWebpQuality":75,"feedId":28801,"totalSpendMs":8963,"convertSpendMs":3020,"createdTime":"2020-10-09 23:59:46","host":"europe62*","referer":"https://wuzhiwei.net/?p=938","linkMd5ListStr":"3004f7ec72722ede6c52776996c28a36,3004f7ec72722ede6c52776996c28a36","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx14/cdn94/contents/2020/10/09/15-59-54-151_f48dcaf22d0c6172.webp","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 68584859.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Fri, 09 Oct 2020 15:59:55 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["403 Forbidden"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["C860:FB7B:65DFD26:7820AF3:5F8088F3"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, read:packages, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1602260515"],"x-ratelimit-used":["60"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx14/cdn94/contents/2020/10/09/15-59-54-151_f48dcaf22d0c6172.webp","historyStatusCode":[],"spendMs":914},"base64UserPassword":null,"token":"6b67d******************************91b08"},"githubUser":"myreaderx14","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"2 MB","destSize":"2.3 MB","compressRate":"113.7%"}],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-54.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-55.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-004.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-003.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://wuzhiwei.net/articlePic/separation_steer.gif","sourceStatusCode":200,"destWidth":436,"destHeight":292,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn16@2020_6/2020/10/09/15-59-56-576_59bfa4583d5123e2.webp","sourceBytes":4187,"destBytes":6890,"targetWebpQuality":75,"feedId":28801,"totalSpendMs":2199,"convertSpendMs":24,"createdTime":"2020-10-09 23:59:55","host":"us-54*","referer":"https://wuzhiwei.net/?p=938","linkMd5ListStr":"3004f7ec72722ede6c52776996c28a36","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"4.1 KB","destSize":"6.7 KB","compressRate":"164.6%"},{"code":1,"isDone":false,"source":"https://wuzhiwei.net/articlePic/path_follow_steer.gif","sourceStatusCode":200,"destWidth":436,"destHeight":292,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn18@2020_3/2020/10/09/15-59-56-813_511926df1652c907.webp","sourceBytes":4960,"destBytes":11128,"targetWebpQuality":75,"feedId":28801,"totalSpendMs":2398,"convertSpendMs":17,"createdTime":"2020-10-09 23:59:55","host":"us-55*","referer":"https://wuzhiwei.net/?p=938","linkMd5ListStr":"3004f7ec72722ede6c52776996c28a36","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"4.8 KB","destSize":"10.9 KB","compressRate":"224.4%"},{"code":1,"isDone":false,"source":"https://wuzhiwei.net/articlePic/obstacle_avoid_steer.png","sourceStatusCode":200,"destWidth":547,"destHeight":495,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn10@2020_2/2020/10/09/15-59-56-934_2daf763fa7d8c2c0.webp","sourceBytes":27115,"destBytes":12494,"targetWebpQuality":75,"feedId":28801,"totalSpendMs":2612,"convertSpendMs":17,"createdTime":"2020-10-09 23:59:55","host":"us-004*","referer":"https://wuzhiwei.net/?p=938","linkMd5ListStr":"3004f7ec72722ede6c52776996c28a36","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"26.5 KB","destSize":"12.2 KB","compressRate":"46.1%"},{"code":1,"isDone":false,"source":"https://wuzhiwei.net/articlePic/follow_path_steer.png","sourceStatusCode":200,"destWidth":558,"destHeight":555,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn7@2020_2/2020/10/09/15-59-57-015_b43fa3f5d3530b5a.webp","sourceBytes":20240,"destBytes":13494,"targetWebpQuality":75,"feedId":28801,"totalSpendMs":2735,"convertSpendMs":14,"createdTime":"2020-10-09 23:59:55","host":"us-003*","referer":"https://wuzhiwei.net/?p=938","linkMd5ListStr":"3004f7ec72722ede6c52776996c28a36","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"19.8 KB","destSize":"13.2 KB","compressRate":"66.7%"}],"successGithubMap":{"myreaderx25":1,"myreaderx21":1,"myreaderx32":1,"myreaderx12":1},"failGithubMap":{"myreaderx14":1}}