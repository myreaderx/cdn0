{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2021-04-08 01:43:41","updatedTime":"2021-04-08 01:43:41","title":"我用kafka两年踩过的一些非比寻常的坑","link":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","description":"<div><div><div id=\"media\" class=\"rich_media_thumb_wrp\">\n\n            <img class=\"rich_media_thumb\" src=\"http://content.sov5.cn/mmbiz_jpg/eZzl4LXykQwKZ98uiabceT5icfvHSxQ3T1AKyJ0vxzMEicrwGWMysok4CQrClAuYdIwdnW4H1IzChtKXwIjgJNo6w?imageView2/1/w/600\">\n        </div>\n    \n\n    \n\n    <div class=\"rich_media_content\" id=\"js_content\">\n                    \n\n                    \n                    \n                    \n                    <section style=\"display:none;\" data-tools=\"新媒体管家\" data-label=\"powered by xmt.cn\"><br></section><p style=\"text-align: center;\"><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;color: rgb(255, 41, 65);line-height: 22.4px;\">（给</span><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;line-height: 22.4px;color: rgb(0, 128, 255);\">ImportNew</span><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;color: rgb(255, 41, 65);line-height: 22.4px;\">加星标，提高Java技能）</span></p><h2 data-tool=\"mdnice编辑器\"><strong><span style=\"color: rgb(123, 12, 0);\">前言</span></strong><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></h2><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我的上家公司是做餐饮系统的，每天中午和晚上用餐高峰期，系统的并发量不容小觑。为了保险起见，公司规定各部门都要在吃饭的时间轮流值班，防止出现线上问题时能够及时处理。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我当时在后厨显示系统团队，该系统属于订单的下游业务。用户点完菜下单后，订单系统会通过发<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>消息给我们系统，系统读取消息后，做业务逻辑处理，持久化订单和菜品数据，然后展示到划菜客户端。这样厨师就知道哪个订单要做哪些菜，有些菜做好了，就可以通过该系统出菜。系统自动通知服务员上菜，如果服务员上完菜，修改菜品上菜状态，用户就知道哪些菜已经上了，哪些还没有上。这个系统可以大大提高后厨到用户的效率。</p><p style=\"max-width: 100%;min-height: 1em;color: rgb(89, 89, 89);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif normal rgb center border-box break-word><img class=\"rich_pages\" data-ratio=\"0.4534313725490196\" data-s=\"300,640\" data-type=\"png\" data-w=\"816\" style=\"box-sizing: border-box !important; overflow-wrap: break-word !important; width: 352px !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqoWtdHmibk2ibtpqzdfibDdylu1Ke7qClwkEqT1kzibiabPSjQM88XkKrpqw/640?wx_fmt=png\"></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>事实证明，这一切的关键是消息中间件：<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>，如果它有问题，将会直接影响到后厨显示系统的功能。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>接下来，我跟大家一起聊聊使用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>两年时间踩过哪些坑？</p><h2 data-tool=\"mdnice编辑器\"><strong><span style=\"color: rgb(123, 12, 0);\">顺序问题</span></strong></h2><p><strong><span style=\"color: rgb(123, 12, 0);\"><br></span></strong></p><h3 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>1. 为什么要保证消息的顺序？</strong></span></h3><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>刚开始我们系统的商户很少，为了快速实现功能，我们没想太多。既然是走消息中间件<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>通信，订单系统发消息时将订单详细数据放在消息体，我们后厨显示系统只要订阅<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>，就能获取相关消息数据，然后处理自己的业务即可。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>不过这套方案有个关键因素：<strong style=\"max-width: 100%;color: rgb(119, 48, 152);box-sizing: border-box !important;overflow-wrap: break-word !important;\">要保证消息的顺序</strong>。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>为什么呢？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>订单有很多状态，比如：下单、支付、完成、撤销等，不可能<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>下单</code>的消息都没读取到，就先读取<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>支付</code>或<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>撤销</code>的消息吧，如果真的这样，数据不是会产生错乱？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>好吧，看来保证消息顺序是有必要的。</p><h3 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>2.如何保证消息顺序？</strong></span></h3><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我们都知道<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>是无序的，但是一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>包含多个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>，每个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>内部是有序的。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word><img class=\"rich_pages\" data-ratio=\"0.5851851851851851\" data-s=\"300,640\" data-type=\"png\" data-w=\"1080\" style=\"color: rgb(89, 89, 89); font-size: 15px; text-align: center; box-sizing: border-box !important; overflow-wrap: break-word !important; width: 390px !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqOzug1A48UnG15tonQ3wBkbB5yicVnHpydn5Hq2PwiawKTVj8Vk6DB7sQ/640?wx_fmt=png\"></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>如此一来，思路就变得清晰了：只要保证生产者写消息时，按照一定的规则写到同一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>，不同的消费者读不同的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>的消息，就能保证生产和消费者消息的顺序。<span style=\"max-width: 100%;text-align: center;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.05em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></span></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我们刚开始就是这么做的，同一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>商户编号</code>的消息写到同一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>中创建了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>4</code>个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>，然后部署了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>4</code>个消费者节点，构成<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>消费者组</code>，一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>对应一个消费者节点。从理论上说，这套方案是能够保证消息顺序的。<img data-ratio=\"0.40813464235624125\" data-type=\"png\" data-w=\"1426\" style=\"margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; width: auto !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqrza43TUBKePfwRPaSrtSJiclN6ibdof2qKwyhIfGoicR4Z6C2icQP5vWuA/640?wx_fmt=png\"></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>一切规划得看似“天衣无缝”，我们就这样”顺利“上线了。</p><h3 data-tool=\"mdnice编辑器\"><strong><span style=\"color: rgb(123, 12, 0);\">3.出现意外</span></strong></h3><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>该功能上线了一段时间，刚开始还是比较正常的。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>但是，好景不长，很快就收到用户投诉，说在划菜客户端有些订单和菜品一直看不到，无法划菜。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我定位到了原因，公司在那段时间网络经常不稳定，业务接口时不时报超时，业务请求时不时会连不上数据库。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这种情况对<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>顺序消息</code>的打击，可以说是<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>毁灭性</code>的。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>为什么这么说？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>假设订单系统发了：”下单“、”支付“、”完成“ 三条消息。<img data-ratio=\"0.30303030303030304\" data-type=\"png\" data-w=\"726\" style=\"margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; width: auto !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqlNAGCa9TQnogCS0zxjEdib4ta0Upia4NZLxe9KibnLKu2buS1In7qT27Q/640?wx_fmt=png\">而”下单“消息由于网络原因我们系统处理失败了，而后面的两条消息的数据是无法入库的，因为只有”下单“消息的数据才是完整的数据，其他类型的消息只会更新状态。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>加上，我们当时没有做<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>失败重试机制</code>，使得这个问题被放大了。问题变成：一旦”下单“消息的数据入库失败，用户就永远看不到这个订单和菜品了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>那么这个紧急的问题要如何解决呢？</p><h3 data-tool=\"mdnice编辑器\"><strong><span style=\"color: rgb(123, 12, 0);\">4.解决过程</span></strong></h3><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>最开始我们的想法是：在消费者处理消息时，如果处理失败了，立马重试3-5次。但如果有些请求要第6次才能成功怎么办？不可能一直重试呀，这种同步重试机制，会阻塞其他商户订单消息的读取。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>显然用上面的这种<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>同步重试机制</code>在出现异常的情况，会严重影响消息消费者的消费速度，降低它的吞吐量。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>如此看来，我们不得不用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>异步重试机制</code>了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>如果用异步重试机制，处理失败的消息就得保存到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>重试表</code>下来。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>但有个新问题立马出现：<strong style=\"max-width: 100%;color: rgb(119, 48, 152);box-sizing: border-box !important;overflow-wrap: break-word !important;\">只存一条消息如何保证顺序？</strong></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>存一条消息的确无法保证顺序，假如：”下单“消息失败了，还没来得及异步重试。此时，”支付“消息被消费了，它肯定是不能被正常消费的。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>此时，”支付“消息该一直等着，每隔一段时间判断一次，它前面的消息都有没有被消费?</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>如果真的这么做，会出现两个问题：</p><ol data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">”支付“消息前面只有”下单“消息，这种情况比较简单。但如果某种类型的消息，前面有N多种消息，需要判断多少次呀，这种判断跟订单系统的耦合性太强了，相当于要把他们系统的逻辑搬一部分到我们系统。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">影响消费者的消费速度</section></li></ol><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这时有种更简单的方案浮出水面：消费者在处理消息时，先判断该<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>订单号</code>在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>重试表</code>有没有数据，如果有则直接把当前消息保存到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>重试表</code>。如果没有，则进行业务处理，如果出现异常，把该消息保存到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>重试表</code>。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>后来我们用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>elastic-job</code>建立了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>失败重试机制</code>，如果重试了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>7</code>次后还是失败，则将该消息的状态标记为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>失败</code>，发邮件通知开发人员。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>终于由于网络不稳定，导致用户在划菜客户端有些订单和菜品一直看不到的问题被解决了。现在商户顶多偶尔延迟看到菜品，比一直看不菜品好太多。</p><h2 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>消息积压</strong></span></h2><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>随着销售团队的市场推广，我们系统的商户越来越多。随之而来的是消息的数量越来越大，导致消费者处理不过来，经常出现消息积压的情况。对商户的影响非常直观，划菜客户端上的订单和菜品可能半个小时后才能看到。一两分钟还能忍，半个消息的延迟，对有些暴脾气的商户哪里忍得了，马上投诉过来了。我们那段时间经常接到商户投诉说订单和菜品有延迟。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>虽说，加<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>服务器节点</code>就能解决问题，但是按照公司为了省钱的惯例，要先做系统优化，所以我们开始了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>消息积压</code>问题解决之旅。</p><h3 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>1. 消息体过大</strong></span></h3><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>虽说<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>号称支持<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>百万级的TPS</code>，但从<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>producer</code>发送消息到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>broker</code>需要一次网络<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>IO</code>，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>broker</code>写数据到磁盘需要一次磁盘<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>IO</code>（写操作），<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>consumer</code>从<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>broker</code>获取消息先经过一次磁盘<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>IO</code>（读操作），再经过一次网络<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>IO</code>。<img data-ratio=\"0.5047619047619047\" data-type=\"png\" data-w=\"1050\" style=\"margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; width: auto !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlq0tlViaqySicoAnwRJmPPPqQgnd89BrW3YyiaQUqAx3uLPicVmwpoeSq1dQ/640?wx_fmt=png\"></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>一次简单的消息从生产到消费过程，需要经过<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>2次网络IO</code>和<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>2次磁盘IO</code>。如果消息体过大，势必会增加IO的耗时，进而影响kafka生产和消费的速度。消费者速度太慢的结果，就会出现消息积压情况。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>除了上面的问题之外，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>消息体过大</code>，还会浪费服务器的磁盘空间，稍不注意，可能会出现磁盘空间不足的情况。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>此时，我们已经到了需要优化消息体过大问题的时候。</p><p data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>如何优化呢？</strong></span></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我们重新梳理了一下业务，没有必要知道订单的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>中间状态</code>，只需知道一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>最终状态</code>就可以了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>如此甚好，我们就可以这样设计了：</p><ol data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">订单系统发送的消息体只用包含：id和状态等关键信息。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">后厨显示系统消费消息后，通过id调用订单系统的订单详情查询接口获取数据。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">后厨显示系统判断数据库中是否有该订单的数据，如果没有则入库，有则更新。</section></li></ol><figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;color: rgb(89, 89, 89);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb border-box break-word><img data-ratio=\"0.46782178217821785\" data-type=\"png\" data-w=\"808\" style=\"margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; width: auto !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqib2hB0qSIXBPjxAH1vZQbn97tcMKQBmWBDL1Rc1ytjLXoXcCPic301pQ/640?wx_fmt=png\"></figure><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>果然这样调整之后，消息积压问题很长一段时间都没再出现。</p><h3 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>2. 路由规则不合理</strong></span></h3><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>还真别高兴的太早，有天中午又有商户投诉说订单和菜品有延迟。我们一查kafka的topic竟然又出现了消息积压。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>但这次有点诡异，不是所有<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>上的消息都有积压，而是只有一个。</p><figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;color: rgb(89, 89, 89);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb border-box break-word><img data-ratio=\"0.369620253164557\" data-type=\"png\" data-w=\"1580\" style=\"margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; width: auto !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqdaENvsBRclJSZ2zvNoXxfpDS9IgJvpM6icibHB8Y32Jt4khMicw7wictmw/640?wx_fmt=png\"></figure><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>刚开始，我以为是消费那个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>消息的节点出了什么问题导致的。但是经过排查，没有发现任何异常。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这就奇怪了，到底哪里有问题呢？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>后来，我查日志和数据库发现，有几个商户的订单量特别大，刚好这几个商户被分到同一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>，使得该<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>的消息量比其他<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>要多很多。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这时我们才意识到，发消息时按<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>商户编号</code>路由<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>的规则不合理，可能会导致有些<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>消息太多，消费者处理不过来，而有些<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>却因为消息太少，消费者出现空闲的情况。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>为了避免出现这种分配不均匀的情况，我们需要对发消息的路由规则做一下调整。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我们思考了一下，用订单号做路由相对更均匀，不会出现单个订单发消息次数特别多的情况。除非是遇到某个人一直加菜的情况，但是加菜是需要花钱的，所以其实同一个订单的消息数量并不多。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>调整后按<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>订单号</code>路由到不同的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>，同一个订单号的消息，每次到发到同一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>。</p><p style=\"max-width: 100%;min-height: 1em;color: rgb(89, 89, 89);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif normal rgb center border-box break-word><img class=\"rich_pages\" data-ratio=\"0.3888888888888889\" data-s=\"300,640\" data-type=\"png\" data-w=\"1548\" style=\"box-sizing: border-box !important; overflow-wrap: break-word !important; width: 592px !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqoJO69ia8Fv9p1uc0HEHaJcYg85VaBlsHm25ubexHCFmmicbVWsN6IACA/640?wx_fmt=png\"></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>调整后，消息积压的问题又有很长一段时间都没有再出现。我们的商户数量在这段时间，增长的非常快，越来越多了。</p><h3 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>3. 批量操作引起的连锁反应</strong></span></h3><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>在高并发的场景中，消息积压问题，可以说如影随形，真的没办法从根本上解决。表面上看，已经解决了，但后面不知道什么时候，就会冒出一次，比如这次：</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>有天下午，产品过来说：有几个商户投诉过来了，他们说菜品有延迟，快查一下原因。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这次问题出现得有点奇怪。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>为什么这么说？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>首先这个时间点就有点奇怪，平常出问题，不都是中午或者晚上用餐高峰期吗？怎么这次问题出现在下午？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>根据以往积累的经验，我直接看了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>的数据，果然上面消息有积压，但这次每个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>都积压了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>十几万</code>的消息没有消费，比以往加压的消息数量增加了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>几百倍</code>。这次消息积压得极不寻常。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我赶紧查服务监控看看消费者挂了没，还好没挂。又查服务日志没有发现异常。这时我有点迷茫，碰运气问了问订单组下午发生了什么事情没？他们说下午有个促销活动，跑了一个JOB批量更新过有些商户的订单信息。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这时，我一下子如梦初醒，是他们在JOB中批量发消息导致的问题。怎么没有通知我们呢？实在太坑了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>虽说知道问题的原因了，倒是眼前积压的这<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>十几万</code>的消息该如何处理呢？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>此时，如果直接调大<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>数量是不行的，历史消息已经存储到4个固定的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>，只有新增的消息才会到新的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>。我们重点需要处理的是已有的<span style=\"max-width: 100%;color: rgb(150, 84, 181);font-family: \" operator mono consolas monaco menlo monospace rgba border-box break-word>partition</span>。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>直接加服务节点也不行，因为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>允许同组的多个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>被一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>consumer</code>消费，但不允许一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>partition</code>被同组的多个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>consumer</code>消费，可能会造成资源浪费。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>看来只有用多线程处理了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>为了紧急解决问题，我改成了用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>线程池</code>处理消息，核心线程和最大线程数都配置成了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>50</code>。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>调整之后，果然，消息积压数量不断减少。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>但此时有个更严重的问题出现：我收到了报警邮件，有两个订单系统的节点down机了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>不久，订单组的同事过来找我说，我们系统调用他们订单查询接口的并发量突增，超过了预计的好几倍，导致有2个服务节点挂了。他们把查询功能单独整成了一个服务，部署了6个节点，挂了2个节点，再不处理，另外4个节点也会挂。订单服务可以说是公司最核心的服务，它挂了公司损失会很大，情况万分紧急。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>为了解决这个问题，只能先把线程数调小。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>幸好，线程数是可以通过<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>zookeeper</code>动态调整的，我把核心线程数调成了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>8</code>个，核心线程数改成了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>10</code>个。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>后面，运维把订单服务挂的2个节点重启后恢复正常了，以防万一，再多加了2个节点。为了确保订单服务不会出现问题，就保持目前的消费速度，后厨显示系统的消息积压问题，1小时候后也恢复正常了。<img class=\"rich_pages\" data-ratio=\"0.5266821345707656\" data-s=\"300,640\" data-type=\"png\" data-w=\"862\" style=\"text-align: center; color: rgb(89, 89, 89); font-size: 15px; letter-spacing: 0.05em; box-sizing: border-box !important; overflow-wrap: break-word !important; width: 442px !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqt9gnrBjrNqmrxqjJlghuZszz8ibdGic6KbthGAdYX8yqkSibxFlH1ibFeA/640?wx_fmt=png\"></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>后来，我们开了一次复盘会，得出的结论是：</p><ol data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">订单系统的批量操作一定提前通知下游系统团队。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">下游系统团队多线程调用订单查询接口一定要做压测。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">这次给订单查询服务敲响了警钟，它作为公司的核心服务，应对高并发场景做的不够好，需要做优化。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">对消息积压情况加监控。</section></li></ol><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb border-box break-word><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></section><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb border-box break-word>顺便说一下，对于要求严格保证消息顺序的场景，可以将线程池改成多个队列，每个队列用单线程处理。</section><h3 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>4. 表过大</strong></span></h3><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>为了防止后面再次出现消息积压问题，消费者后面就一直用多线程处理消息。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>但有天中午我们还是收到很多报警邮件，提醒我们kafka的topic消息有积压。我们正在查原因，此时产品跑过来说：又有商户投诉说菜品有延迟，赶紧看看。这次她看起来有些不耐烦，确实优化了很多次，还是出现了同样的问题。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>在外行看来：<strong style=\"max-width: 100%;color: rgb(119, 48, 152);box-sizing: border-box !important;overflow-wrap: break-word !important;\">为什么同一个问题一直解决不了？</strong></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word><strong style=\"max-width: 100%;color: rgb(119, 48, 152);box-sizing: border-box !important;overflow-wrap: break-word !important;\">其实技术心里的苦他们是不知道的。</strong></p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>表面上问题的症状是一样的，都是出现了菜品延迟，他们知道的是因为消息积压导致的。但是他们不知道深层次的原因，导致消息积压的原因其实有很多种。这也许是使用消息中间件的通病吧。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我沉默不语，只能硬着头皮定位原因了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>后来我查日志发现消费者消费一条消息的耗时长达<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>2秒</code>。以前是<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>500毫秒</code>，现在怎么会变成<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>2秒</code>呢？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>奇怪了，消费者的代码也没有做大的调整，为什么会出现这种情况呢？</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>查了一下线上菜品表，单表数据量竟然到了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>几千万</code>，其他的划菜表也是一样，现在单表保存的数据太多了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我们组梳理了一下业务，其实菜品在客户端只展示最近<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>3天</code>的即可。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这就好办了，我们服务端存着<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>多余的数据</code>，不如把表中多余的数据归档。于是，DBA帮我们把数据做了归档，只保留最近<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>7天</code>的数据。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>如此调整后，消息积压问题被解决了，又恢复了往日的平静。</p><h2 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>主键冲突</strong></span></h2><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>别高兴得太早了，还有其他的问题，比如：报警邮件经常报出数据库异常：<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box> Duplicate entry '6' for key 'PRIMARY'</code>，说主键冲突。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>出现这种问题一般是由于有两个以上相同主键的sql，同时插入数据，第一个插入成功后，第二个插入的时候会报主键冲突。表的主键是唯一的，不允许重复。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我仔细检查了代码，发现代码逻辑会先根据主键从表中查询订单是否存在，如果存在则更新状态，不存在才插入数据，没得问题。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这种判断在并发量不大时，是有用的。但是如果在高并发的场景下，两个请求同一时刻都查到订单不存在，一个请求先插入数据，另一个请求再插入数据时就会出现主键冲突的异常。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>解决这个问题最常规的做法是：<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>加锁</code>。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我刚开始也是这样想的，加数据库悲观锁肯定是不行的，太影响性能。加数据库乐观锁，基于版本号判断，一般用于更新操作，像这种插入操作基本上不会用。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>剩下的只能用分布式锁了，我们系统在用redis，可以加基于redis的分布式锁，锁定订单号。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>但后面仔细思考了一下：</p><ol data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">加分布式锁也可能会影响消费者的消息处理速度。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">消费者依赖于redis，如果redis出现网络超时，我们的服务就悲剧了。</section></li></ol><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>所以，我也不打算用分布式锁。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>而是选择使用mysql的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>INSERT INTO ...ON DUPLICATE KEY UPDATE</code>语法：</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.75px;text-align: left;background-color: rgb(255, 255, 255);border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(56, 58, 66);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace rgb border-box break-word><span style=\"max-width: 100%;color: rgb(166, 38, 164);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">INSERT</span> <span style=\"max-width: 100%;color: rgb(166, 38, 164);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">INTO</span> <span style=\"max-width: 100%;color: rgb(166, 38, 164);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">table</span> (column_list)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;color: rgb(166, 38, 164);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">VALUES</span> (value_list)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;color: rgb(166, 38, 164);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">ON</span> <span style=\"max-width: 100%;color: rgb(166, 38, 164);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">DUPLICATE</span> <span style=\"max-width: 100%;color: rgb(166, 38, 164);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">KEY</span> <span style=\"max-width: 100%;color: rgb(166, 38, 164);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">UPDATE</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">c1 = v1, <br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">c2 = v2,<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">...;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>它会先尝试把数据插入表，如果主键冲突的话那么更新字段。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>把以前的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>insert</code>语句改造之后，就没再出现过主键冲突问题。</p><h2 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>数据库主从延迟</strong></span></h2><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>不久之后的某天，又收到商户投诉说下单后，在划菜客户端上看得到订单，但是看到的菜品不全，有时甚至订单和菜品数据都看不到。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这个问题跟以往的都不一样，根据以往的经验先看<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>中消息有没有积压，但这次并没有积压。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>再查了服务日志，发现订单系统接口返回的数据有些为空，有些只返回了订单数据，没返回菜品数据。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这就非常奇怪了，我直接过去找订单组的同事。他们仔细排查服务，没有发现问题。这时我们不约而同的想到，会不会是数据库出问题了，一起去找<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>DBA</code>。果然，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>DBA</code>发现数据库的主库同步数据到从库，由于网络原因偶尔有延迟，有时延迟有<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>3秒</code>。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>如果我们的业务流程从发消息到消费消息耗时小于<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>3秒</code>，调用订单详情查询接口时，可能会查不到数据，或者查到的不是最新的数据。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这个问题非常严重，会导致直接我们的数据错误。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>为了解决这个问题，我们也加了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>重试机制</code>。调用接口查询数据时，如果返回数据为空，或者只返回了订单没有菜品，则加入<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>重试表</code>。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>调整后，商户投诉的问题被解决了。</p><h2 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>重复消费</strong></span></h2><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>消费消息时支持三种模式：</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">at most once模式 最多一次。保证每一条消息commit成功之后，再进行消费处理。消息可能会丢失，但不会重复。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">at least once模式 至少一次。保证每一条消息处理成功之后，再进行commit。消息不会丢失，但可能会重复。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">exactly once模式 精确传递一次。将offset作为唯一id与消息同时处理，并且保证处理的原子性。消息只会处理一次，不丢失也不会重复。但这种方式很难做到。</section></li></ul><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>默认的模式是<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>at least once</code>，但这种模式可能会产生重复消费的问题，所以我们的业务逻辑必须做幂等设计。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>而我们的业务场景保存数据时使用了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>INSERT INTO ...ON DUPLICATE KEY UPDATE</code>语法，不存在时插入，存在时更新，是天然支持幂等性的。</p><h2 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>多环境消费问题</strong></span></h2><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>我们当时线上环境分为：<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>pre</code>(预发布环境) 和 <code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>prod</code>(生产环境)，两个环境共用同一个数据库，并且共用同一个kafka集群。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>需要注意的是，在配置<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>的时候，要加前缀用于区分不同环境。pre环境的以pre_开头，比如：pre_order，生产环境以prod_开头，比如：prod_order，防止消息在不同环境中串了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>但有次运维在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>pre</code>环境切换节点，配置<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>的时候，配错了，配成了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>prod</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>topic</code>。刚好那天，我们有新功能上<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>pre</code>环境。结果悲剧了，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>prod</code>的有些消息被<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>pre</code>环境的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>consumer</code>消费了，而由于消息体做了调整，导致<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>pre</code>环境的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>consumer</code>处理消息一直失败。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>其结果是生产环境丢了部分消息。不过还好，最后生产环境消费者通过重置<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>offset</code>，重新读取了那一部分消息解决了问题，没有造成太大损失。</p><h2 data-tool=\"mdnice编辑器\"><span style=\"color: rgb(123, 12, 0);\"><strong>后记</strong></span></h2><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>除了上述问题之外，我还遇到过：</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>consumer</code>使用自动确认机制，导致<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>cpu使用率100%</code>。</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>集群中的一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>broker</code>节点挂了，重启后又一直挂。</section></li></ul><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>这两个问题说起来有些复杂，我就不一一列举了，有兴趣的朋友可以关注我的公众号，加我的微信找我私聊。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>非常感谢那两年使用消息中间件<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>的经历，虽说遇到过挺多问题，踩了很多坑，走了很多弯路，但是实打实的让我积累了很多宝贵的经验，快速成长了。</p><p data-tool=\"mdnice编辑器\" style=\"margin: 1em 4px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left normal rgb black border-box break-word>其实<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>是一个非常优秀的消息中间件，我所遇到的绝大多数问题，都并非<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;overflow-wrap: break-word;font-size: 14px;border-radius: 4px;background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all rgb border-box>kafka</code>自身的问题（除了cpu使用率100%是它的一个bug导致的之外）。</p><p style=\"white-space: normal;text-align: center;\"><span style=\"font-size: 15px;color: rgb(136, 136, 136);\"><br></span></p><p style=\"white-space: normal;text-align: center;\"><span style=\"font-size: 15px;color: rgb(136, 136, 136);\">- EOF -</span></p><section donone=\"shifuMouseDownCard('shifu_c_030')\" label=\"Copyright Reserved by PLAYHUDONG.\" style=\"margin-top: 1em;margin-bottom: 1em;white-space: normal;text-align: start;max-width: 100%;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);border-width: 0px;border-style: initial;border-color: initial;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-left: 1em;max-width: 100%;line-height: 1.4;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"padding: 3px 8px;max-width: 100%;border-radius: 4px;color: rgb(255, 255, 255);background-color: rgb(255, 105, 31);font-family: inherit;text-align: inherit;text-decoration: inherit;font-size: 16px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">推荐阅读</span>  <span style=\"margin-left: 4px;padding: 3px 8px;max-width: 100%;border-radius: 1.2em;color: rgb(255, 255, 255);line-height: 1.2;background-color: rgb(204, 204, 204);font-family: inherit;text-align: inherit;text-decoration: inherit;border-color: rgb(249, 110, 87);font-size: 12px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">点击标题可跳转</span></section><section style=\"margin-top: -11px;padding: 22px 16px 16px;max-width: 100%;border-width: 1px;border-style: solid;border-color: rgb(255, 105, 31);color: rgb(51, 51, 51);font-size: 1em;font-family: inherit;text-align: inherit;text-decoration: inherit;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651494206&amp;idx=1&amp;sn=da059efbbb4b55038b3cae3df96f4448&amp;chksm=bd25fb418a527257b0aa2871c18ebe6af5404687292e449b9d6a5ac72195adee3f9eb9c00e2a&amp;scene=21#wechat_redirect\" data-itemshowtype=\"11\" tab=\"innerlink\" style=\"font-size: 12px;\" data-linktype=\"2\"><span style=\"font-size: 12px;\">Kafka性能篇：为何Kafka这么\"快\"？</span></a><br></p><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"font-size: 12px;\"><a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651493272&amp;idx=2&amp;sn=053a3817e09cddbc12ed442ab427512c&amp;chksm=bd25ffe78a5276f150dec0565136a055ca1bd7e8168661cc8ef36f81c132b26e9d5d323a04eb&amp;scene=21#wechat_redirect\" data-itemshowtype=\"11\" tab=\"innerlink\" style=\"font-size: 12px;\" data-linktype=\"2\">基于SSD的Kafka应用层缓存架构设计与实现</a></span></p><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651491688&amp;idx=1&amp;sn=3398ad44227fa187ca14a903ebefce90&amp;chksm=bd25e1178a526801c02c99908a00d4ec85ab0bb97253cd840a52cf8517948f9f6ad65e9805b2&amp;scene=21#wechat_redirect\" data-itemshowtype=\"11\" tab=\"innerlink\" style=\"font-size: 12px;\" data-linktype=\"2\"><span style=\"font-size: 12px;\">10 张图告诉你，Kafka 是怎么做到支持百万级 TPS 的？</span></a></p></section></section><p style=\"white-space: normal;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);text-align: start;max-width: 100%;min-height: 1em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><br></p><p style=\"text-align: center;\"><span style=\"max-width: 100%;font-size: 14px;color: rgb(255, 169, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">看完本文有收获？请转发分享给更多人</span><br></p><p style=\"white-space: normal;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><strong style=\"max-width: 100%;color: rgb(255, 169, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">关注「ImportNew」，提升Java技能</strong></p><p style=\"white-space: normal;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><img data-ratio=\"0.9166666666666666\" data-s=\"300,640\" data-type=\"jpeg\" data-w=\"600\" style=\"box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 600px !important; max-width: 600px\" width=\"auto\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg\"></p><p style=\"text-align: right;\"><span style=\"font-size: 14px;text-align: right;\"></span><span style=\"max-width: 100%;font-family: -apple-system-font, system-ui, \" helvetica neue sc sans gb yahei ui arial sans-serif center break-word border-box>点赞和在看就是最大的支持</span><span style=\"max-width: 100%;font-family: -apple-system-font, system-ui, \" helvetica neue sc sans gb yahei ui arial sans-serif center break-word border-box>❤️</span><span style=\"font-size: 14px;text-align: right;\"></span></p><p><br></p>\n                </div>\n\n    \n    <br>\n\n    \n        <a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651494363&amp;idx=2&amp;sn=41c3daa0f863eab05cfe81153e82ae06&amp;chksm=bd25fba48a5272b2a4102af1c1b27f8943674f1ab0b24338dd744b2f81ee97b00e303697fef0&amp;scene=0#rd\" style=\"color: blue\" class=\"media_tool_meta meta_primary\">原文</a>\n        <br>\n    \n\n    \n\n    <img alt=\"\" width=\"1px\" height=\"1px\" class=\"\" style=\"width:1px;height:1px;display:none\" src=\"http://www.jintiankansha.me/rss_static/11757/iKSwRmXamO\"></div></div>","descriptionType":"html","publishedDate":"Wed, 07 Apr 2021 03:46:00 +0000","feedId":2521,"bgimg":"http://content.sov5.cn/mmbiz_jpg/eZzl4LXykQwKZ98uiabceT5icfvHSxQ3T1AKyJ0vxzMEicrwGWMysok4CQrClAuYdIwdnW4H1IzChtKXwIjgJNo6w?imageView2/1/w/600","linkMd5":"e170c4a1c8ad9e41f9e7848a550f2140","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn88@2020_4/2021/04/07/17-43-42-962_88615adb1be61244.webp","destWidth":600,"destHeight":291,"sourceBytes":16782,"destBytes":14990,"author":"","articleImgCdnMap":{"http://content.sov5.cn/mmbiz_jpg/eZzl4LXykQwKZ98uiabceT5icfvHSxQ3T1AKyJ0vxzMEicrwGWMysok4CQrClAuYdIwdnW4H1IzChtKXwIjgJNo6w?imageView2/1/w/600":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn88@2020_4/2021/04/07/17-43-42-962_88615adb1be61244.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqoWtdHmibk2ibtpqzdfibDdylu1Ke7qClwkEqT1kzibiabPSjQM88XkKrpqw/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn100@2020_6/2021/04/07/17-43-48-574_4b3d58332c4eb420.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqOzug1A48UnG15tonQ3wBkbB5yicVnHpydn5Hq2PwiawKTVj8Vk6DB7sQ/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn15@2020_3/2021/04/07/17-43-45-998_0dd4327b0f0b4643.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqrza43TUBKePfwRPaSrtSJiclN6ibdof2qKwyhIfGoicR4Z6C2icQP5vWuA/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn92@2020_3/2021/04/07/17-43-52-034_91f5a03bf15431df.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqlNAGCa9TQnogCS0zxjEdib4ta0Upia4NZLxe9KibnLKu2buS1In7qT27Q/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn27@2020_2/2021/04/07/17-43-45-098_22ce50bef8e019e0.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlq0tlViaqySicoAnwRJmPPPqQgnd89BrW3YyiaQUqAx3uLPicVmwpoeSq1dQ/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn95@2020_1/2021/04/07/17-43-46-089_dc74373f2cbefd88.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqib2hB0qSIXBPjxAH1vZQbn97tcMKQBmWBDL1Rc1ytjLXoXcCPic301pQ/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn98@2020_2/2021/04/07/17-43-47-448_5befb5ca81145170.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqdaENvsBRclJSZ2zvNoXxfpDS9IgJvpM6icibHB8Y32Jt4khMicw7wictmw/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn19@2020_2/2021/04/07/17-43-45-312_17818c776900f332.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqoJO69ia8Fv9p1uc0HEHaJcYg85VaBlsHm25ubexHCFmmicbVWsN6IACA/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn24@2020_5/2021/04/07/17-44-05-102_8223899396f2cc13.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqt9gnrBjrNqmrxqjJlghuZszz8ibdGic6KbthGAdYX8yqkSibxFlH1ibFeA/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn7@2020_4/2021/04/07/17-43-48-030_b87c628faf10c616.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn11@2020_6/2021/04/07/17-43-46-832_f93d0239d4369c75.webp","http://www.jintiankansha.me/rss_static/11757/iKSwRmXamO":null},"publishedOrCreatedDate":1617817421019}],"record":{"createdTime":"2021-04-08 01:43:41","updatedTime":"2021-04-08 01:43:41","feedId":2521,"fetchDate":"Wed, 07 Apr 2021 17:43:41 +0000","fetchMs":195,"handleMs":259,"totalMs":25048,"newArticles":0,"totalArticles":5,"status":1,"type":0,"ip":"ee7dcad84751b3133a91709509a32bb9","hostName":"us-029*","requestId":"d02a118895544024a2bb8ae7ab50f071_2521","contentType":"application/rss+xml","totalBytes":239304,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":12,"articlesImgsGithubTotal":11,"successGithubMap":{"myreaderx25":1,"myreaderx15":1,"myreaderx27":1,"myreaderx4":1,"myreaderx21":1,"myreaderx33":1,"myreaderx11":1,"myreaderx12":1,"myreaderx31":1,"myreaderx18":1,"myreaderx19":1},"failGithubMap":{}},"feed":{"createdTime":"2020-08-24 21:31:41","updatedTime":"2020-09-01 10:09:47","id":2521,"name":"ImportNew","url":"http://feedmaker.kindle4rss.com/feeds/importnew.weixin.xml","subscriber":null,"website":null,"icon":"http://www.sogou.com/images/logo/new/favicon.ico?v=4","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx63/cdn9@2020_3/2020/09/01/02-08-31-388_d24121c9beed1de6.ico","description":"伯乐在线旗下账号，专注Java技术分享，包括Java基础技术、进阶技能、架构设计和Java技术领域动态等。","weekly":null,"link":null},"noPictureArticleList":[{"createdTime":"2021-04-08 01:44:05","updatedTime":"2021-04-08 01:44:05","id":null,"feedId":2521,"linkMd5":"e170c4a1c8ad9e41f9e7848a550f2140"}],"tmpCommonImgCdnBytes":14990,"tmpBodyImgCdnBytes":224314,"tmpBgImgCdnBytes":0,"extra4":{"start":1617817420351,"total":0,"statList":[{"spend":409,"msg":"获取xml内容"},{"spend":259,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":21919,"msg":"正文链接上传到cdn"}]},"extra5":12,"extra6":12,"extra7ImgCdnFailResultVector":[{"code":1,"isDone":false,"source":"http://www.jintiankansha.me/rss_static/11757/iKSwRmXamO","sourceStatusCode":405,"sourceBytes":0,"destBytes":0,"feedId":2521,"totalSpendMs":841,"convertSpendMs":0,"createdTime":"2021-04-08 01:43:43","host":"europe63*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[405],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"http://www.jintiankansha.me/rss_static/11757/iKSwRmXamO","sourceStatusCode":405,"sourceBytes":0,"destBytes":0,"feedId":2521,"totalSpendMs":456,"convertSpendMs":0,"createdTime":"2021-04-08 01:43:44","host":"us-52*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[405],"sourceSize":"0","destSize":"0"}],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-037.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-55.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-007.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe63.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[405]},"http://us-52.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[405]},"http://us-024.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-006.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-25.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe21.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-59.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-008.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-012.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"http://content.sov5.cn/mmbiz_jpg/eZzl4LXykQwKZ98uiabceT5icfvHSxQ3T1AKyJ0vxzMEicrwGWMysok4CQrClAuYdIwdnW4H1IzChtKXwIjgJNo6w?imageView2/1/w/600","sourceStatusCode":200,"destWidth":600,"destHeight":291,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn88@2020_4/2021/04/07/17-43-42-962_88615adb1be61244.webp","sourceBytes":16782,"destBytes":14990,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":2272,"convertSpendMs":19,"createdTime":"2021-04-08 01:43:41","host":"europe67*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140,e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"16.4 KB","destSize":"14.6 KB","compressRate":"89.3%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqlNAGCa9TQnogCS0zxjEdib4ta0Upia4NZLxe9KibnLKu2buS1In7qT27Q/640?wx_fmt=png","sourceStatusCode":200,"destWidth":726,"destHeight":220,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn27@2020_2/2021/04/07/17-43-45-098_22ce50bef8e019e0.webp","sourceBytes":9785,"destBytes":6544,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":1822,"convertSpendMs":12,"createdTime":"2021-04-08 01:43:43","host":"europe-25*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"9.6 KB","destSize":"6.4 KB","compressRate":"66.9%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqdaENvsBRclJSZ2zvNoXxfpDS9IgJvpM6icibHB8Y32Jt4khMicw7wictmw/640?wx_fmt=png","sourceStatusCode":200,"destWidth":1080,"destHeight":399,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn19@2020_2/2021/04/07/17-43-45-312_17818c776900f332.webp","sourceBytes":66343,"destBytes":24434,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":2070,"convertSpendMs":233,"createdTime":"2021-04-08 01:43:43","host":"us-024*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"64.8 KB","destSize":"23.9 KB","compressRate":"36.8%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqOzug1A48UnG15tonQ3wBkbB5yicVnHpydn5Hq2PwiawKTVj8Vk6DB7sQ/640?wx_fmt=png","sourceStatusCode":200,"destWidth":1080,"destHeight":632,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn15@2020_3/2021/04/07/17-43-45-998_0dd4327b0f0b4643.webp","sourceBytes":28406,"destBytes":18462,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":2803,"convertSpendMs":33,"createdTime":"2021-04-08 01:43:43","host":"us-037*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"27.7 KB","destSize":"18 KB","compressRate":"65%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlq0tlViaqySicoAnwRJmPPPqQgnd89BrW3YyiaQUqAx3uLPicVmwpoeSq1dQ/640?wx_fmt=png","sourceStatusCode":200,"destWidth":1050,"destHeight":530,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn95@2020_1/2021/04/07/17-43-46-089_dc74373f2cbefd88.webp","sourceBytes":34704,"destBytes":19334,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":2824,"convertSpendMs":49,"createdTime":"2021-04-08 01:43:43","host":"us-007*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"33.9 KB","destSize":"18.9 KB","compressRate":"55.7%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg","sourceStatusCode":200,"destWidth":600,"destHeight":550,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn11@2020_6/2021/04/07/17-43-46-832_f93d0239d4369c75.webp","sourceBytes":37143,"destBytes":31608,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":3621,"convertSpendMs":26,"createdTime":"2021-04-08 01:43:43","host":"europe-59*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx19","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"36.3 KB","destSize":"30.9 KB","compressRate":"85.1%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqib2hB0qSIXBPjxAH1vZQbn97tcMKQBmWBDL1Rc1ytjLXoXcCPic301pQ/640?wx_fmt=png","sourceStatusCode":200,"destWidth":808,"destHeight":378,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn98@2020_2/2021/04/07/17-43-47-448_5befb5ca81145170.webp","sourceBytes":47983,"destBytes":24044,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":4147,"convertSpendMs":113,"createdTime":"2021-04-08 01:43:43","host":"us-006*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx33","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"46.9 KB","destSize":"23.5 KB","compressRate":"50.1%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqt9gnrBjrNqmrxqjJlghuZszz8ibdGic6KbthGAdYX8yqkSibxFlH1ibFeA/640?wx_fmt=png","sourceStatusCode":200,"destWidth":862,"destHeight":454,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn7@2020_4/2021/04/07/17-43-48-030_b87c628faf10c616.webp","sourceBytes":63348,"destBytes":31344,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":4770,"convertSpendMs":20,"createdTime":"2021-04-08 01:43:43","host":"europe21*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"61.9 KB","destSize":"30.6 KB","compressRate":"49.5%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqoWtdHmibk2ibtpqzdfibDdylu1Ke7qClwkEqT1kzibiabPSjQM88XkKrpqw/640?wx_fmt=png","sourceStatusCode":200,"destWidth":816,"destHeight":370,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn100@2020_6/2021/04/07/17-43-48-574_4b3d58332c4eb420.webp","sourceBytes":36017,"destBytes":17794,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":5300,"convertSpendMs":1695,"createdTime":"2021-04-08 01:43:43","host":"us-008*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"35.2 KB","destSize":"17.4 KB","compressRate":"49.4%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqrza43TUBKePfwRPaSrtSJiclN6ibdof2qKwyhIfGoicR4Z6C2icQP5vWuA/640?wx_fmt=png","sourceStatusCode":200,"destWidth":1080,"destHeight":441,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn92@2020_3/2021/04/07/17-43-52-034_91f5a03bf15431df.webp","sourceBytes":72788,"destBytes":25496,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":8760,"convertSpendMs":53,"createdTime":"2021-04-08 01:43:43","host":"us-55*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"71.1 KB","destSize":"24.9 KB","compressRate":"35%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/uL371281oDHq22JkuhhbPicwggABFQWlqoJO69ia8Fv9p1uc0HEHaJcYg85VaBlsHm25ubexHCFmmicbVWsN6IACA/640?wx_fmt=png","sourceStatusCode":200,"destWidth":1080,"destHeight":420,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn24@2020_5/2021/04/07/17-44-05-102_8223899396f2cc13.webp","sourceBytes":69920,"destBytes":25254,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":21837,"convertSpendMs":22,"createdTime":"2021-04-08 01:43:43","host":"us-012*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E6%88%91%E7%94%A8kafka%E4%B8%A4%E5%B9%B4%E8%B8%A9%E8%BF%87%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9D%9E%E6%AF%94%E5%AF%BB%E5%B8%B8%E7%9A%84%E5%9D%91","linkMd5ListStr":"e170c4a1c8ad9e41f9e7848a550f2140","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"68.3 KB","destSize":"24.7 KB","compressRate":"36.1%"}],"successGithubMap":{"myreaderx25":1,"myreaderx15":1,"myreaderx27":1,"myreaderx4":1,"myreaderx21":1,"myreaderx33":1,"myreaderx11":1,"myreaderx12":1,"myreaderx31":1,"myreaderx18":1,"myreaderx19":1},"failGithubMap":{}}