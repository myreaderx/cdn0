{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-11-15 02:00:52","updatedTime":"2020-11-15 02:00:52","title":"MongoDB 副本集之入门篇","link":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","description":"<h1 id=\"mongodb-副本集之入门篇\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#mongodb-副本集之入门篇\" class=\"headerlink\" title=\"mongodb 副本集之入门篇\"></a>mongodb 副本集之入门篇</h1>\n<p>前言：mongodb 因为高性能、高可用性、支持分片等特性，作为非关系型数据库被大家广泛使用。其高可用性主要是体现在 mongodb 的副本集上面（可以简单理解为一主多从的集群），本篇文章主要从副本集介绍、本地搭建副本集、副本集读写数据这三个方面来带大家认识下 mongodb 副本集。</p>\n<h2 id=\"一、-mongodb-副本集介绍\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#一、-mongodb-副本集介绍\" class=\"headerlink\" title=\"一、 mongodb 副本集介绍\"></a>一、 mongodb 副本集介绍</h2>\n<p>mongodb 副本集（Replica Set）包括主节点（primary）跟副本节点（Secondaries）。</p>\n<p>主节点只能有一个，所有的写操作请求都在主节点上面处理。副本节点可以有多个，通过同步主节点的操作日志（oplog）来备份主节点数据。</p>\n<p>在主节点挂掉后，有选举权限的副本节点会自动发起选举，并从中选举出新的主节点。</p>\n<p>副本节点可以通过配置指定其具体的属性，比如选举、隐藏、延迟同步等，最多可以有50个副本节点，但只能有7个副本节点能参与选举。虽然副本节点不能处理写操作，但可以处理读请求，这个下文会专门讲到。</p>\n<p>搭建一个副本集集群最少需要三个节点：一个主节点，两个备份节点，如果三个节点分布合理，基本可以保证线上数据99.9%安全。三个节点的架构如下图所示：</p>\n<p><img src=\"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-read-write-operations-primary.bakedsvg.svg\" alt=\"\" /></p>\n<p>如果只有一个主节点，一个副本节点，且没有资源拿来当第二个副本节点，那就可以起一个仲裁者节点（arbiter），不存数据，只用来选举用，如下图所示：</p>\n<p><img src=\"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-primary-with-secondary-and-arbiter.bakedsvg.svg\" alt=\"\" /></p>\n<p>当主节点挂掉后，那么两个副本节点会进行选举，从中选举出一个新的主节点，流程如下：</p>\n<p><img src=\"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-trigger-election.bakedsvg.svg\" alt=\"\" /></p>\n<p>对于副本集成员属性，特别需要说明下这几个：priority、hidden、slaveDelay、tags、votes。</p>\n<ul>\n <li><p>priority</p><p>对于副本节点，可以通过该属性来增大或者减小该节点被选举成为主节点的可能性，取值范围为0-1000（如果是arbiters，则取值只有0或者1），数据越大，成为主节点的可能性越大，如果被配置为0，那么他就不能被选举成为主节点，而且也不能主动发起选举。</p><p>这种特性一般会被用在有多个数据中心的情况下，比如一个主数据中心，一个备份数据中心，主数据中心速度会更快，如果主节点挂掉，我们肯定希望新主节点也在主数据中心产生，那么我们就可以设置在备份数据中心的副本节点优先级为0，如下图所示：</p></li>\n</ul>\n<p><img src=\"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-three-members-geographically-distributed.bakedsvg.svg\" alt=\"\" /></p>\n<ul>\n <li><p>hidden</p><p>隐藏节点会从主节点同步数据，但对客户端不可见，在mongo shell 执行 db.isMaster() 方法也不会展示该节点，隐藏节点必须Priority为0，即不可以被选举成为主节点。但是如果有配置选举权限的话，可以参与选举。</p><p>因为隐藏节点对客户端不可见，所以跟客户端不会互相影响，可以用来备份数据或者跑一些后端定时任务之类的操作，具体如下图，4个备份节点都从主节点同步数据，其中1个为隐藏节点：</p></li>\n</ul>\n<p><img src=\"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-hidden-member.bakedsvg.svg\" alt=\"\" /></p>\n<ul>\n <li><p>slaveDelay</p><p>延迟同步即延迟从主节点同步数据，比如延迟时间配置的1小时，现在时间是 09:52，那么延迟节点中只同步到主节点 08:52 之前的数据。另外需要注意延迟节点必须是隐藏节点，且Priority为0。</p><p>那这个延迟节点有什么用呢？有过数据库误操作惨痛经历的开发者肯定知道答案，那就是为了防止数据库误操作，比如更新服务前，一般会先执行数据库更新脚本，如果脚本有问题，且操作前未做备份，那数据可能就找不回了。但如果说配置了延迟节点，那误操作完，还有该节点可以兜底，只能说该功能真是贴心。具体延迟节点如下图所展示：</p></li>\n</ul>\n<p><img src=\"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-delayed-member.bakedsvg.svg\" alt=\"\" /></p>\n<ul>\n <li><p>tags</p><p>支持对副本集成员打标签，在查询数据时会用到，比如找到对应标签的副本节点，然后从该节点读取数据，这点也非常有用，可以根据标签对节点分类，查询数据时不同服务的客户端指定其对应的标签的节点，对某个标签的节点数量进行增加或减少，也不怕会影响到使用其他标签的服务。Tags 的具体使用，文章下面章节也会讲到。</p></li>\n <li><p>votes</p><p>表示节点是否有权限参与选举，最大可以配置7个副本节点参与选举。</p></li>\n</ul>\n<h2 id=\"二、副本集的搭建以及测试\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#二、副本集的搭建以及测试\" class=\"headerlink\" title=\"二、副本集的搭建以及测试\"></a>二、副本集的搭建以及测试</h2>\n<p>安装mongodb 教程：<a href=\"\">https://docs.mongodb.com/manual/installation/</a></p>\n<p>我们来搭建一套 P-S-S 结构的副本集（1个 Primary 节点，2个 Secondary 节点），大致过程为：先启动三个不同端口的 mongod 进程，然后在 mongo shell 中执行命令初始化副本集。</p>\n<p>启动单个mongod 实例的命令为： </p>\n<p><code>mongod --replSet rs0 --port 27017 --bind_ip localhost,&lt;hostname(s)|ip address(es)&gt; --dbpath /data/mongodb/rs0-0 --oplogSize 128</code></p>\n<p>参数说明：</p>\n<table>\n <thead>\n  <tr>\n   <th>参数</th>\n   <th>说明</th>\n   <th>示例</th>\n  </tr>\n </thead>\n <tbody>\n  <tr>\n   <td>replSet</td>\n   <td>副本集名称</td>\n   <td>rs0</td>\n  </tr>\n  <tr>\n   <td>port</td>\n   <td>mongod 实例端口</td>\n   <td>27017</td>\n  </tr>\n  <tr>\n   <td>bind_ip</td>\n   <td>访问该实例的地址列表，只是本机访问可以设置为localhost 或者 127.0.0.1，生产环境建议使用内部域名</td>\n   <td>Localhost</td>\n  </tr>\n  <tr>\n   <td>dbpath</td>\n   <td>数据存放位置</td>\n   <td>/data/mongodb/rs0-0</td>\n  </tr>\n  <tr>\n   <td>oplogSize</td>\n   <td>操作日志大小</td>\n   <td>128</td>\n  </tr>\n </tbody>\n</table>\n<h4 id=\"搭建步骤如下：\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#搭建步骤如下：\" class=\"headerlink\" title=\"搭建步骤如下：\"></a>搭建步骤如下：</h4>\n<ol>\n <li><p>先创建三个目录来分别存放这三个节点的数据</p><p> <code>mkdir -p /data/mongodb/rs0-0 /data/mongodb/rs0-1 /data/mongodb/rs0-2</code></p></li>\n <li><p>分别启动三个mongod 进程，端口分别为：27018，27019，27020</p><p>第一个：<br> <code>mongod --replSet rs0 --port 27018 --bind_ip localhost --dbpath /data/mongodb/rs0-0 --oplogSize 128</code></br></p><p>第二个：<br> <code>mongod --replSet rs0 --port 27019 --bind_ip localhost --dbpath /data/mongodb/rs0-1 --oplogSize 128</code></br></p><p>第三个：<br> <code>mongod --replSet rs0 --port 27020 --bind_ip localhost --dbpath /data/mongodb/rs0-2 --oplogSize 128</code></br></p></li>\n <li><p>使用 mongo 进入第一个 mongod 示例，使用 rs.initiate() 进行初始化</p><p>登录到27018： mongo localhost:27018</p><p>执行：</p>\n  <figure class=\"highlight js\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></pre></td>\n     <td class=\"code\"><pre><span class=\"line\">rsconf = {</span><br><span class=\"line\">    _id: <span class=\"string\">\"rs0\"</span>,</span><br><span class=\"line\">    members: [</span><br><span class=\"line\">      {</span><br><span class=\"line\">        _id: <span class=\"number\">0</span>,</span><br><span class=\"line\"> host: <span class=\"string\">\"localhost:27018\"</span></span><br><span class=\"line\"> },</span><br><span class=\"line\"> {</span><br><span class=\"line\"> _id: <span class=\"number\">1</span>,</span><br><span class=\"line\"> host: <span class=\"string\">\"localhost:27019\"</span></span><br><span class=\"line\"> },</span><br><span class=\"line\"> {</span><br><span class=\"line\"> _id: <span class=\"number\">2</span>,</span><br><span class=\"line\"> host: <span class=\"string\">\"localhost:27020\"</span></span><br><span class=\"line\"> }</span><br><span class=\"line\"> ]</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\">rs.initiate( rsconf )</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></pre></td>\n    </tr>\n   </table>\n  </figure><p>以上就已经完成了一个副本集的搭建，在 mongo shell 中执行 rs.conf() 可以看到每个节点中 host、arbiterOnly、hidden、priority、 votes、slaveDelay等属性，是不是超级简单。。</p><p>执行 rs.conf() ，结果展示如下：</p>\n  <figure class=\"highlight js\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></pre></td>\n     <td class=\"code\"><pre><span class=\"line\">rs.conf()</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"string\">\"_id\"</span> : <span class=\"string\">\"rs0\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"version\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\">    <span class=\"string\">\"protocolVersion\"</span> : NumberLong(<span class=\"number\">1</span>),</span><br><span class=\"line\"> <span class=\"string\">\"writeConcernMajorityJournalDefault\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\"> <span class=\"string\">\"members\"</span> : [</span><br><span class=\"line\"> {</span><br><span class=\"line\"> <span class=\"string\">\"_id\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\"> <span class=\"string\">\"host\"</span> : <span class=\"string\">\"localhost:27018\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"arbiterOnly\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\"> <span class=\"string\">\"buildIndexes\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\"> <span class=\"string\">\"hidden\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\"> <span class=\"string\">\"priority\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"tags\"</span> : {</span><br><span class=\"line\"> </span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"slaveDelay\"</span> : NumberLong(<span class=\"number\">0</span>),</span><br><span class=\"line\"> <span class=\"string\">\"votes\"</span> : <span class=\"number\">1</span></span><br><span class=\"line\"> },</span><br><span class=\"line\"> {</span><br><span class=\"line\"> <span class=\"string\">\"_id\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"host\"</span> : <span class=\"string\">\"localhost:27019\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"arbiterOnly\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\"> <span class=\"string\">\"buildIndexes\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\"> <span class=\"string\">\"hidden\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\"> <span class=\"string\">\"priority\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"tags\"</span> : {</span><br><span class=\"line\"> </span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"slaveDelay\"</span> : NumberLong(<span class=\"number\">0</span>),</span><br><span class=\"line\"> <span class=\"string\">\"votes\"</span> : <span class=\"number\">1</span></span><br><span class=\"line\"> },</span><br><span class=\"line\"> {</span><br><span class=\"line\"> <span class=\"string\">\"_id\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\"> <span class=\"string\">\"host\"</span> : <span class=\"string\">\"localhost:27020\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"arbiterOnly\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\"> <span class=\"string\">\"buildIndexes\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\"> <span class=\"string\">\"hidden\"</span> : <span class=\"literal\">false</span>,</span><br><span class=\"line\"> <span class=\"string\">\"priority\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"tags\"</span> : {</span><br><span class=\"line\"> </span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"slaveDelay\"</span> : NumberLong(<span class=\"number\">0</span>),</span><br><span class=\"line\"> <span class=\"string\">\"votes\"</span> : <span class=\"number\">1</span></span><br><span class=\"line\"> }</span><br><span class=\"line\"> ],</span><br><span class=\"line\"> <span class=\"string\">\"settings\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"chainingAllowed\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\"> <span class=\"string\">\"heartbeatIntervalMillis\"</span> : <span class=\"number\">2000</span>,</span><br><span class=\"line\"> <span class=\"string\">\"heartbeatTimeoutSecs\"</span> : <span class=\"number\">10</span>,</span><br><span class=\"line\"> <span class=\"string\">\"electionTimeoutMillis\"</span> : <span class=\"number\">10000</span>,</span><br><span class=\"line\"> <span class=\"string\">\"catchUpTimeoutMillis\"</span> : <span class=\"number\">-1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"catchUpTakeoverDelayMillis\"</span> : <span class=\"number\">30000</span>,</span><br><span class=\"line\"> <span class=\"string\">\"getLastErrorModes\"</span> : {</span><br><span class=\"line\"> </span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"getLastErrorDefaults\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"w\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"wtimeout\"</span> : <span class=\"number\">0</span></span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"replicaSetId\"</span> : ObjectId(<span class=\"string\">\"5f957f12974186fc616688fb\"</span>)</span><br><span class=\"line\"> }</span><br><span class=\"line\">}</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></pre></td>\n    </tr>\n   </table>\n  </figure></li>\n</ol>\n<p>特别注意下：在 mongo shell 中，有 rs 跟 db。</p>\n<ul>\n <li>rs 是指副本集，有rs.initiate()，rs.conf(), rs.reconfig(), rs.add() 等操作副本集的方法</li>\n <li>db 是指数据库，其下是对数据库的一些操作，比如下面会用到 db.isMaster(), db.collection.find(), db.collection.insert() 等。</li>\n</ul>\n<h4 id=\"我们再来测试下-Automatic-Failover\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#我们再来测试下-Automatic-Failover\" class=\"headerlink\" title=\"我们再来测试下 Automatic Failover\"></a>我们再来测试下 Automatic Failover</h4>\n<ol>\n <li><p>可以直接停掉主节点localhost:27018 来测试下主节点挂掉后，副本节点重新选举出新的主节点，即自动故障转移（Automatic Failover）</p><p>杀掉主节点 27018后，可以看到 27019 的输出日志里面选举部分，27019 发起选举，并成功参选成为主节点：</p>\n  <figure class=\"highlight yaml\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br /></br></br></br></br></pre></td>\n     <td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2020</span><span class=\"number\">-10</span><span class=\"string\">-26T21:43:58.156+0800</span> <span class=\"string\">I</span>  <span class=\"string\">REPL</span>     <span class=\"string\">[replexec-304]</span> <span class=\"attr\">Scheduling remote command request for vote request:</span> <span class=\"string\">RemoteCommand</span> <span class=\"number\">100694</span> <span class=\"string\">--</span> <span class=\"string\">target:localhost:27018</span> <span class=\"string\">db:admin</span> <span class=\"string\">cmd:{</span> <span class=\"attr\">replSetRequestVotes:</span> <span class=\"number\">1</span><span class=\"string\">,</span> <span class=\"attr\">setName:</span> <span class=\"string\">\"rs0\"</span><span class=\"string\">,</span> <span class=\"attr\">dryRun:</span> <span class=\"literal\">false</span><span class=\"string\">,</span> <span class=\"attr\">term:</span> <span class=\"number\">17</span><span class=\"string\">,</span> <span class=\"attr\">candidateIndex:</span> <span class=\"number\">1</span><span class=\"string\">,</span> <span class=\"attr\">configVersion:</span> <span class=\"number\">1</span><span class=\"string\">,</span> <span class=\"attr\">lastCommittedOp:</span> <span class=\"string\">{</span> <span class=\"attr\">ts:</span> <span class=\"string\">Timestamp(1603719830,</span> <span class=\"number\">1</span><span class=\"string\">),</span> <span class=\"attr\">t:</span> <span class=\"number\">16</span> <span class=\"string\">}</span> <span class=\"string\">}</span></span><br><span class=\"line\"><span class=\"number\">2020</span><span class=\"number\">-10</span><span class=\"string\">-26T21:43:58.156+0800</span> <span class=\"string\">I</span>  <span class=\"string\">REPL</span>     <span class=\"string\">[replexec-304]</span> <span class=\"attr\">Scheduling remote command request for vote request:</span> <span class=\"string\">RemoteCommand</span> <span class=\"number\">100695</span> <span class=\"string\">--</span> <span class=\"string\">target:localhost:27020</span> <span class=\"string\">db:admin</span> <span class=\"string\">cmd:{</span> <span class=\"attr\">replSetRequestVotes:</span> <span class=\"number\">1</span><span class=\"string\">,</span> <span class=\"attr\">setName:</span> <span class=\"string\">\"rs0\"</span><span class=\"string\">,</span> <span class=\"attr\">dryRun:</span> <span class=\"literal\">false</span><span class=\"string\">,</span> <span class=\"attr\">term:</span> <span class=\"number\">17</span><span class=\"string\">,</span> <span class=\"attr\">candidateIndex:</span> <span class=\"number\">1</span><span class=\"string\">,</span> <span class=\"attr\">configVersion:</span> <span class=\"number\">1</span><span class=\"string\">,</span> <span class=\"attr\">lastCommittedOp:</span> <span class=\"string\">{</span> <span class=\"attr\">ts:</span> <span class=\"string\">Timestamp(1603719830,</span> <span class=\"number\">1</span><span class=\"string\">),</span> <span class=\"attr\">t:</span> <span class=\"number\">16</span> <span class=\"string\">}</span> <span class=\"string\">}</span></span><br><span class=\"line\"><span class=\"number\">2020</span><span class=\"number\">-10</span><span class=\"string\">-26T21:43:58.159+0800</span> <span class=\"string\">I</span>  <span class=\"string\">ELECTION</span> <span class=\"string\">[replexec-301]</span> <span class=\"string\">VoteRequester(term</span> <span class=\"number\">17</span><span class=\"string\">)</span> <span class=\"attr\">received an invalid response from localhost:27018: ShutdownInProgress:</span> <span class=\"string\">In</span> <span class=\"string\">the</span> <span class=\"string\">process</span> <span class=\"string\">of</span> <span class=\"string\">shutting</span> <span class=\"string\">down;</span> <span class=\"attr\">response message:</span> <span class=\"string\">{</span> <span class=\"attr\">operationTime:</span> <span class=\"string\">Timestamp(1603719830,</span> <span class=\"number\">1</span><span class=\"string\">),</span> <span class=\"attr\">ok:</span> <span class=\"number\">0.0</span><span class=\"string\">,</span> <span class=\"attr\">errmsg:</span> <span class=\"string\">\"In the process of shutting down\"</span><span class=\"string\">,</span> <span class=\"attr\">code:</span> <span class=\"number\">91</span><span class=\"string\">,</span> <span class=\"attr\">codeName:</span> <span class=\"string\">\"ShutdownInProgress\"</span><span class=\"string\">,</span> <span class=\"string\">$clusterTime:</span> <span class=\"string\">{</span> <span class=\"attr\">clusterTime:</span> <span class=\"string\">Timestamp(1603719830,</span> <span class=\"number\">1</span><span class=\"string\">),</span> <span class=\"attr\">signature:</span> <span class=\"string\">{</span> <span class=\"attr\">hash:</span> <span class=\"string\">BinData(0,</span> <span class=\"number\">0000000000000000000000000000000000000000</span><span class=\"string\">),</span> <span class=\"attr\">keyId:</span> <span class=\"number\">0</span> <span class=\"string\">}</span> <span class=\"string\">}</span> <span class=\"string\">}</span></span><br><span class=\"line\"><span class=\"number\">2020</span><span class=\"number\">-10</span><span class=\"string\">-26T21:43:58.164+0800</span> <span class=\"string\">I</span>  <span class=\"string\">ELECTION</span> <span class=\"string\">[replexec-305]</span> <span class=\"string\">VoteRequester(term</span> <span class=\"number\">17</span><span class=\"string\">)</span> <span class=\"string\">received</span> <span class=\"string\">a</span> <span class=\"literal\">yes</span> <span class=\"string\">vote</span> <span class=\"string\">from</span> <span class=\"string\">localhost:27020;</span> <span class=\"attr\">response message:</span> <span class=\"string\">{</span> <span class=\"attr\">term:</span> <span class=\"number\">17</span><span class=\"string\">,</span> <span class=\"attr\">voteGranted:</span> <span class=\"literal\">true</span><span class=\"string\">,</span> <span class=\"attr\">reason:</span> <span class=\"string\">\"\"</span><span class=\"string\">,</span> <span class=\"attr\">ok:</span> <span class=\"number\">1.0</span><span class=\"string\">,</span> <span class=\"string\">$clusterTime:</span> <span class=\"string\">{</span> <span class=\"attr\">clusterTime:</span> <span class=\"string\">Timestamp(1603719830,</span> <span class=\"number\">1</span><span class=\"string\">),</span> <span class=\"attr\">signature:</span> <span class=\"string\">{</span> <span class=\"attr\">hash:</span> <span class=\"string\">BinData(0,</span> <span class=\"number\">0000000000000000000000000000000000000000</span><span class=\"string\">),</span> <span class=\"attr\">keyId:</span> <span class=\"number\">0</span> <span class=\"string\">}</span> <span class=\"string\">},</span> <span class=\"attr\">operationTime:</span> <span class=\"string\">Timestamp(1603719830,</span> <span class=\"number\">1</span><span class=\"string\">)</span> <span class=\"string\">}</span></span><br><span class=\"line\"><span class=\"number\">2020</span><span class=\"number\">-10</span><span class=\"string\">-26T21:43:58.164+0800</span> <span class=\"string\">I</span>  <span class=\"string\">ELECTION</span> <span class=\"string\">[replexec-304]</span> <span class=\"string\">election</span> <span class=\"string\">succeeded,</span> <span class=\"string\">assuming</span> <span class=\"string\">primary</span> <span class=\"string\">role</span> <span class=\"string\">in</span> <span class=\"string\">term</span> <span class=\"number\">17</span></span><br /></br></br></br></br></pre></td>\n    </tr>\n   </table>\n  </figure></li>\n <li><p>然后执行 rs.status() 查看当前副本集情况，可以看到27019变为主节点，27018 显示已挂掉 health = 0</p>\n  <figure class=\"highlight js\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></pre></td>\n     <td class=\"code\"><pre><span class=\"line\">rs.status()</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"string\">\"set\"</span> : <span class=\"string\">\"rs0\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"date\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:44:22.071Z\"</span>),</span><br><span class=\"line\">    <span class=\"string\">\"myState\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"heartbeatIntervalMillis\"</span> : NumberLong(<span class=\"number\">2000</span>),</span><br><span class=\"line\"> <span class=\"string\">\"majorityVoteCount\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\"> <span class=\"string\">\"writeMajorityCount\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\"> <span class=\"string\">\"members\"</span> : [</span><br><span class=\"line\"> {</span><br><span class=\"line\"> <span class=\"string\">\"_id\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\"> <span class=\"string\">\"name\"</span> : <span class=\"string\">\"localhost:27018\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"ip\"</span> : <span class=\"string\">\"127.0.0.1\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"health\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\"> <span class=\"string\">\"state\"</span> : <span class=\"number\">8</span>,</span><br><span class=\"line\"> <span class=\"string\">\"stateStr\"</span> : <span class=\"string\">\"(not reachable/healthy)\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"uptime\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\"> <span class=\"string\">\"optime\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"ts\"</span> : Timestamp(<span class=\"number\">0</span>, <span class=\"number\">0</span>),</span><br><span class=\"line\"> <span class=\"string\">\"t\"</span> : NumberLong(<span class=\"number\">-1</span>)</span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"optimeDurable\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"ts\"</span> : Timestamp(<span class=\"number\">0</span>, <span class=\"number\">0</span>),</span><br><span class=\"line\"> <span class=\"string\">\"t\"</span> : NumberLong(<span class=\"number\">-1</span>)</span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"optimeDate\"</span> : ISODate(<span class=\"string\">\"1970-01-01T00:00:00Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"optimeDurableDate\"</span> : ISODate(<span class=\"string\">\"1970-01-01T00:00:00Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"lastHeartbeat\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:44:20.202Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"lastHeartbeatRecv\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:43:57.861Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"pingMs\"</span> : NumberLong(<span class=\"number\">0</span>),</span><br><span class=\"line\"> <span class=\"string\">\"lastHeartbeatMessage\"</span> : <span class=\"string\">\"Error connecting to localhost:27018 (127.0.0.1:27018) :: caused by :: Connection refused\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"syncingTo\"</span> : <span class=\"string\">\"\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"syncSourceHost\"</span> : <span class=\"string\">\"\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"syncSourceId\"</span> : <span class=\"number\">-1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"infoMessage\"</span> : <span class=\"string\">\"\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"configVersion\"</span> : <span class=\"number\">-1</span></span><br><span class=\"line\"> },</span><br><span class=\"line\"> {</span><br><span class=\"line\"> <span class=\"string\">\"_id\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"name\"</span> : <span class=\"string\">\"localhost:27019\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"ip\"</span> : <span class=\"string\">\"127.0.0.1\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"health\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"state\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"stateStr\"</span> : <span class=\"string\">\"PRIMARY\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"uptime\"</span> : <span class=\"number\">85318</span>,</span><br><span class=\"line\"> <span class=\"string\">\"optime\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"ts\"</span> : Timestamp(<span class=\"number\">1603719858</span>, <span class=\"number\">1</span>),</span><br><span class=\"line\"> <span class=\"string\">\"t\"</span> : NumberLong(<span class=\"number\">17</span>)</span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"optimeDate\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:44:18Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"syncingTo\"</span> : <span class=\"string\">\"\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"syncSourceHost\"</span> : <span class=\"string\">\"\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"syncSourceId\"</span> : <span class=\"number\">-1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"infoMessage\"</span> : <span class=\"string\">\"\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"electionTime\"</span> : Timestamp(<span class=\"number\">1603719838</span>, <span class=\"number\">1</span>),</span><br><span class=\"line\"> <span class=\"string\">\"electionDate\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:43:58Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"configVersion\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"self\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\"> <span class=\"string\">\"lastHeartbeatMessage\"</span> : <span class=\"string\">\"\"</span></span><br><span class=\"line\"> },</span><br><span class=\"line\"> {</span><br><span class=\"line\"> <span class=\"string\">\"_id\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\"> <span class=\"string\">\"name\"</span> : <span class=\"string\">\"localhost:27020\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"ip\"</span> : <span class=\"string\">\"127.0.0.1\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"health\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"state\"</span> : <span class=\"number\">2</span>,</span><br><span class=\"line\"> <span class=\"string\">\"stateStr\"</span> : <span class=\"string\">\"SECONDARY\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"uptime\"</span> : <span class=\"number\">52468</span>,</span><br><span class=\"line\"> <span class=\"string\">\"optime\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"ts\"</span> : Timestamp(<span class=\"number\">1603719858</span>, <span class=\"number\">1</span>),</span><br><span class=\"line\"> <span class=\"string\">\"t\"</span> : NumberLong(<span class=\"number\">17</span>)</span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"optimeDurable\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"ts\"</span> : Timestamp(<span class=\"number\">1603719858</span>, <span class=\"number\">1</span>),</span><br><span class=\"line\"> <span class=\"string\">\"t\"</span> : NumberLong(<span class=\"number\">17</span>)</span><br><span class=\"line\"> },</span><br><span class=\"line\"> <span class=\"string\">\"optimeDate\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:44:18Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"optimeDurableDate\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:44:18Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"lastHeartbeat\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:44:20.200Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"lastHeartbeatRecv\"</span> : ISODate(<span class=\"string\">\"2020-10-26T13:44:21.517Z\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"pingMs\"</span> : NumberLong(<span class=\"number\">0</span>),</span><br><span class=\"line\"> <span class=\"string\">\"lastHeartbeatMessage\"</span> : <span class=\"string\">\"\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"syncingTo\"</span> : <span class=\"string\">\"localhost:27019\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"syncSourceHost\"</span> : <span class=\"string\">\"localhost:27019\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"syncSourceId\"</span> : <span class=\"number\">1</span>,</span><br><span class=\"line\"> <span class=\"string\">\"infoMessage\"</span> : <span class=\"string\">\"\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"configVersion\"</span> : <span class=\"number\">1</span></span><br><span class=\"line\"> }</span><br><span class=\"line\"> ]</span><br><span class=\"line\">}</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></pre></td>\n    </tr>\n   </table>\n  </figure></li>\n <li><p>再次启动27018：<br><code>mongod --replSet rs0 --port 27018 --bind_ip localhost --dbpath /data/mongodb/rs0-0 --oplogSize 128</code></br></p><p>可以在节点 27019 日志中看到已检测到 27018，并且已变为副本节点，通过rs.status 查看结果也是如此。</p>\n  <figure class=\"highlight angelscript\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br /></pre></td>\n     <td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2020</span><span class=\"number\">-10</span><span class=\"number\">-26</span>T21:<span class=\"number\">52</span>:<span class=\"number\">06.871</span>+<span class=\"number\">0800</span> I  REPL     [replexec<span class=\"number\">-305</span>] Member localhost:<span class=\"number\">27018</span> <span class=\"keyword\">is</span> now <span class=\"keyword\">in</span> state SECONDARY</span><br /></pre></td>\n    </tr>\n   </table>\n  </figure></li>\n</ol>\n<h2 id=\"三、副本集写跟读的一些特性\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#三、副本集写跟读的一些特性\" class=\"headerlink\" title=\"三、副本集写跟读的一些特性\"></a>三、副本集写跟读的一些特性</h2>\n<h3 id=\"写关注（Write-concern）\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#写关注（Write-concern）\" class=\"headerlink\" title=\"写关注（Write concern）\"></a>写关注（Write concern）</h3>\n<p> 副本集写关注是指写入一条数据，主节点处理完成后，需要其他承载数据的副本节点也确认写成功后，才能给客户端返回写入数据成功。</p>\n<p> 这个功能主要是解决主节点挂掉后，数据还未来得及同步到副本节点，而导致数据丢失的问题。</p>\n<p> 可以配置节点个数，默认配置 {“w”：1}，这样表示主节点写入数据成功即可给客户端返回成功，“w” 配置为2，则表示除了主节点，还需要收到其中一个副本节点返回写入成功，“w” 还可以配置为 “majority”，表示需要集群中大多数承载数据且有选举权限的节点返回写入成功。</p>\n<p>如下图所示，P-S-S 结构（一个 primary 节点，两个 secondary 节点），写请求里面带了w : “majority” ，那么主节点写入完成后，数据同步到第一个副本节点，且第一个副本节点回复数据写入成功后，才给客户端返回成功。</p>\n<p><img src=\"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/crud-write-concern-w-majority.bakedsvg.svg\" alt=\"\" /></p>\n<p>关于写关注在实际中如何操作，有下面两种方法：</p>\n<ol>\n <li><p>在写请求中指定 writeConcern 相关参数，如下：</p>\n  <figure class=\"highlight js\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br /></br></br></br></pre></td>\n     <td class=\"code\"><pre><span class=\"line\">db.products.insert(</span><br><span class=\"line\">    { <span class=\"attr\">item</span>: <span class=\"string\">\"envelopes\"</span>, <span class=\"attr\">qty</span> : <span class=\"number\">100</span>, <span class=\"attr\">type</span>: <span class=\"string\">\"Clasp\"</span> },</span><br><span class=\"line\">    { <span class=\"attr\">writeConcern</span>: { <span class=\"attr\">w</span>: <span class=\"string\">\"majority\"</span> , <span class=\"attr\">wtimeout</span>: <span class=\"number\">5000</span> } }</span><br><span class=\"line\">)</span><br /></br></br></br></pre></td>\n    </tr>\n   </table>\n  </figure></li>\n <li><p>修改副本集 getLastErrorDefaults 配置，如下：</p>\n  <figure class=\"highlight js\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br /></br></br></pre></td>\n     <td class=\"code\"><pre><span class=\"line\">cfg = rs.conf()</span><br><span class=\"line\">cfg.settings.getLastErrorDefaults = { <span class=\"attr\">w</span>: <span class=\"string\">\"majority\"</span>, <span class=\"attr\">wtimeout</span>: <span class=\"number\">5000</span> }</span><br><span class=\"line\">rs.reconfig(cfg)</span><br /></br></br></pre></td>\n    </tr>\n   </table>\n  </figure></li>\n</ol>\n<h3 id=\"读偏好-（Read-preference）\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#读偏好-（Read-preference）\" class=\"headerlink\" title=\"读偏好 （Read preference）\"></a>读偏好 （Read preference）</h3>\n<p>读跟写不一样，为了保持一致性，写只能通过主节点，但读可以选择主节点，也可以选择副本节点，区别是主节点数据最新，副本节点因为同步问题可能会有延迟，但从副本节点读取数据可以分散对主节点的压力。</p>\n<p><img src=\"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-read-preference-secondary.bakedsvg.svg\" alt=\"\" /></p>\n<p>因为承载数据的节点会有多个，那客户端如何选择从那个节点读呢？主要有3个条件（Tag Sets、 maxStalenessSeconds、Hedged Read），5种模式（primary、primaryPreferred、secondary、secondaryPreferred、nearest）</p>\n<h4 id=\"首先说一下-5种模式，其特点如下表所示：\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#首先说一下-5种模式，其特点如下表所示：\" class=\"headerlink\" title=\"首先说一下 5种模式，其特点如下表所示：\"></a>首先说一下 5种模式，其特点如下表所示：</h4>\n<table>\n <thead>\n  <tr>\n   <th><strong>模式</strong></th>\n   <th><strong>特点</strong></th>\n  </tr>\n </thead>\n <tbody>\n  <tr>\n   <td>primary</td>\n   <td>所有读请求都从主节点读取</td>\n  </tr>\n  <tr>\n   <td>primaryPreferred</td>\n   <td>主节点正常，则所有读请求都从主节点读取，如果主节点挂掉，则从符合条件的副本节点读取</td>\n  </tr>\n  <tr>\n   <td>secondary</td>\n   <td>所有读请求都从副本节点读取</td>\n  </tr>\n  <tr>\n   <td>secondaryPreferred</td>\n   <td>所有读请求都从副本节点读取，但如果副本节点都挂掉了，那就从主节点读取</td>\n  </tr>\n  <tr>\n   <td>nearest</td>\n   <td>主要看网络延迟，选取延迟最小的节点，主节点跟副本节点均可</td>\n  </tr>\n </tbody>\n</table>\n<h4 id=\"再说下3个条件，条件是在符合模式的基础上，再根据条件删选具体的节点\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#再说下3个条件，条件是在符合模式的基础上，再根据条件删选具体的节点\" class=\"headerlink\" title=\"再说下3个条件，条件是在符合模式的基础上，再根据条件删选具体的节点\"></a>再说下3个条件，条件是在符合模式的基础上，再根据条件删选具体的节点</h4>\n<ol>\n <li><p>Tag Sets（标签）</p><p>顾名思义，这个可以给节点加上标签，然后查找数据时，可以根据标签选择对应的节点，然后在该节点查找数据。可以通过mongo shell 使用 rs.conf() 查看当前每个节点下面的 tags， 修改或者添加tags 过程同上面修改 getLastErrorDefaults 配置 ，如：<code>cfg.members[n].tags = { \"region\": \"South\", \"datacenter\": \"A\" }</code></p></li>\n <li><p>maxStalenessSeconds （可容忍的最大同步延迟）</p><p>顾名思义+1，这个值是指副本节点同步主节点写入的时间 跟 主节点实际最近写入时间的对比值，如果主节点挂掉了，那就跟副本集中最新写入的时间做对比。</p><p>这个值建议设置，避免因为部分副本节点网络原因导致比较长时间未同步主节点数据，然后读到比较老的数据。特别注意的是该值需要设置 90s 以上，因为客户端是定时去校验副本节点的同步延迟时间，数据不会特别准确，设置比 90s 小，会抛出异常。</p></li>\n <li><p>Hedged Read （对冲读取）</p><p>该选项是在分片集群 MongoDB 4.4 版本后才支持，指 mongos 实例路由读取请求时会同时发给两个符合条件的副本集节点，然后那个先返回结果就返回这个结果给客户端。</p></li>\n</ol>\n<h4 id=\"那问题来了，如此好用的模式以及条件在查询请求中如何使用呢？\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#那问题来了，如此好用的模式以及条件在查询请求中如何使用呢？\" class=\"headerlink\" title=\"那问题来了，如此好用的模式以及条件在查询请求中如何使用呢？\"></a>那问题来了，如此好用的模式以及条件在查询请求中如何使用呢？</h4>\n<ol>\n <li><p>在代码中连接数据库，使用 connection string uri 时，可以加上下面的这三个参数</p><p>| <strong>参数</strong> | <strong>说明</strong> |<br>| ——————- | ———————————————————— |<br>| readPreference | 模式，枚举值有：primary（默认值）、 primaryPreferred、secondary、secondaryPreferred、nearest |<br>| maxStalenessSeconds | 最大同步延时秒数，取值0 - 90 会报错， -1 表示没有最大值 |<br>| readPreferenceTags | 标签，如果标签是 { “dc”: “ny”, “rack”: “r1” }, 则在uri 为 readPreferenceTags=dc:ny,rack:r1 |</br></br></br></br></p><p>例如下面：</p><p><code>mongodb://db0.example.com,db1.example.com,db2.example.com/?replicaSet=myRepl&amp;readPreference=secondary&amp;maxStalenessSeconds=120&amp;readPreferenceTags=dc:ny,rack:r1</code></p></li>\n</ol>\n<ol start=\"2\">\n <li><p>在mogo shell 中，可以使用 <a href=\"https://docs.mongodb.com/manual/reference/method/cursor.readPref/#cursor.readPref\" target=\"_blank\" rel=\"noopener\">cursor.readPref()</a> 或者 <a href=\"https://docs.mongodb.com/manual/reference/method/Mongo.setReadPref/#Mongo.setReadPref\" target=\"_blank\" rel=\"noopener\">Mongo.setReadPref()</a></p><p>cursor.readPref() 参数分别为： mode、tag set、hedge options, 具体请求例如下面这样</p>\n  <figure class=\"highlight js\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br /></br></br></br></br></pre></td>\n     <td class=\"code\"><pre><span class=\"line\">db.collection.find({ }).readPref(</span><br><span class=\"line\">    <span class=\"string\">\"secondary\"</span>,                      <span class=\"comment\">// mode</span></span><br><span class=\"line\">    [ { <span class=\"string\">\"datacenter\"</span>: <span class=\"string\">\"B\"</span> },  { } ],  <span class=\"comment\">// tag set</span></span><br><span class=\"line\">    { <span class=\"attr\">enabled</span>: <span class=\"literal\">true</span> }                 <span class=\"comment\">// hedge options</span></span><br><span class=\"line\">)</span><br /></br></br></br></br></pre></td>\n    </tr>\n   </table>\n  </figure><p>Mongo.setReadPref() 类似，只是预先设置请求条件，这样就不用每个请求后面带上 readPref 条件。</p></li>\n</ol>\n<h4 id=\"可以在搭建好的集群中简单测试下该功能\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#可以在搭建好的集群中简单测试下该功能\" class=\"headerlink\" title=\"可以在搭建好的集群中简单测试下该功能\"></a>可以在搭建好的集群中简单测试下该功能</h4>\n<ol>\n <li><p>登录主节点： <code>mongo localhost:27018</code></p></li>\n <li><p>插入一条数据： <code>db.nums.insert({name: “num0”})</code></p><p>在当前节点查询: <code>db.nums.find()</code></p><p>可以看到本条数据： <code>{ \"_id\" : ObjectId(\"5f958687233b11771912ced5\"), \"name\" : \"num0\" }</code></p></li>\n <li><p>登录副本节点： <code>mongo localhost:27019</code></p><p>查询：<code>db.nums.find()</code></p><p>因为查询模式默认为 primary，所以在副本节点查询会报错，如下：</p>\n  <figure class=\"highlight js\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></br></pre></td>\n     <td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Error</span>: error: {</span><br><span class=\"line\">  <span class=\"string\">\"operationTime\"</span> : Timestamp(<span class=\"number\">1603788383</span>, <span class=\"number\">1</span>),</span><br><span class=\"line\">  <span class=\"string\">\"ok\"</span> : <span class=\"number\">0</span>,</span><br><span class=\"line\">  <span class=\"string\">\"errmsg\"</span> : <span class=\"string\">\"not master and slaveOk=false\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"code\"</span> : <span class=\"number\">13435</span>,</span><br><span class=\"line\"> <span class=\"string\">\"codeName\"</span> : <span class=\"string\">\"NotMasterNoSlaveOk\"</span>,</span><br><span class=\"line\"> <span class=\"string\">\"$clusterTime\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"clusterTime\"</span> : Timestamp(<span class=\"number\">1603788383</span>, <span class=\"number\">1</span>),</span><br><span class=\"line\"> <span class=\"string\">\"signature\"</span> : {</span><br><span class=\"line\"> <span class=\"string\">\"hash\"</span> : BinData(<span class=\"number\">0</span>,<span class=\"string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span>),</span><br><span class=\"line\"> <span class=\"string\">\"keyId\"</span> : NumberLong(<span class=\"number\">0</span>)</span><br><span class=\"line\"> }</span><br><span class=\"line\"> }</span><br><span class=\"line\">}</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></br></pre></td>\n    </tr>\n   </table>\n  </figure><p>查询时指定模式为 “secondary”： <code>db.nums.find().readPref(“secondary\")</code></p><p>就可以查询到插入的数据：<code>{ \"_id\" : ObjectId(\"5f958687233b11771912ced5\"), \"name\" : \"num0\" }</code></p></li>\n</ol>\n<h2 id=\"结语\"><a href=\"https://aotu.io/notes/2020/11/12/mongo-replica-set/#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h2>\n<p>以上内容都是阅读 MongoDB 官方文档后，然后挑简单且重要的一些点做的总结，如果大家对 MongoDB 感兴趣，建议直接啃一啃<a href=\"https://docs.mongodb.com/manual/replication/\" target=\"_blank\" rel=\"noopener\">官方文档</a>。</p>","descriptionType":"html","publishedDate":"Thu, 12 Nov 2020 12:10:20 +0000","feedId":15705,"bgimg":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-read-write-operations-primary.bakedsvg.svg","linkMd5":"df070705583e16f404252c5b55689130","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn41@2020_2/2020/11/14/18-00-53-542_65f1f9721e4c1e53.svg","destWidth":0,"destHeight":0,"sourceBytes":17518,"destBytes":17518,"author":"","articleImgCdnMap":{"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-read-write-operations-primary.bakedsvg.svg":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn41@2020_2/2020/11/14/18-00-53-542_65f1f9721e4c1e53.svg","https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-primary-with-secondary-and-arbiter.bakedsvg.svg":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn68@2020_6/2020/11/14/18-00-56-290_900ea4d9197f75f5.svg","https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-trigger-election.bakedsvg.svg":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn45@2020_6/2020/11/14/18-00-55-468_01f1a29f30661e62.svg","https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-three-members-geographically-distributed.bakedsvg.svg":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn60@2020_2/2020/11/14/18-00-56-235_98a144e48c0437dd.svg","https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-hidden-member.bakedsvg.svg":null,"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-delayed-member.bakedsvg.svg":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn49@2020_6/2020/11/14/18-00-55-998_035a3506f9915d6a.svg","https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/crud-write-concern-w-majority.bakedsvg.svg":null,"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-read-preference-secondary.bakedsvg.svg":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn66@2020_2/2020/11/14/18-00-55-849_a85265cc57e486ee.svg"},"publishedOrCreatedDate":1605376852677}],"record":{"createdTime":"2020-11-15 02:00:52","updatedTime":"2020-11-15 02:00:52","feedId":15705,"fetchDate":"Sat, 14 Nov 2020 18:00:52 +0000","fetchMs":3089,"handleMs":246,"totalMs":128377,"newArticles":0,"totalArticles":234,"status":1,"type":0,"ip":"c52038f4f02d4346eb87a3f21493621d","hostName":"europe-59*","requestId":"2114c5a37ef7458697640d360bf09433_15705","contentType":"application/xml","totalBytes":97207,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":8,"articlesImgsGithubTotal":6,"successGithubMap":{"myreaderx25":1,"myreaderx27":1,"myreaderx16":1,"myreaderx11":1,"myreaderx3":1,"myreaderx19":1},"failGithubMap":{"myreaderx14":1,"myreaderx23":1}},"feed":{"createdTime":"2020-09-07 02:11:15","updatedTime":"2020-09-07 02:36:40","id":15705,"name":"Aotu.io","url":"https://aotu.io/atom.xml","subscriber":213,"website":null,"icon":"https://aotu.io/img/apple-touch-icon-57x57.png","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx62/cdn17@2020_6/2020/09/06/18-36-25-169_bdbe4587dfaf329c.png","description":"凹凸实验室","weekly":null,"link":null},"noPictureArticleList":[{"createdTime":"2020-11-15 02:00:57","updatedTime":"2020-11-15 02:00:57","id":null,"feedId":15705,"linkMd5":"df070705583e16f404252c5b55689130"}],"tmpCommonImgCdnBytes":17518,"tmpBodyImgCdnBytes":79689,"tmpBgImgCdnBytes":0,"extra4":{"start":1605376728711,"total":0,"statList":[{"spend":123720,"msg":"获取xml内容"},{"spend":246,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":1,"msg":"修正封面图上传失败重新上传"},{"spend":2502,"msg":"正文链接上传到cdn"}]},"extra5":8,"extra6":8,"extra7ImgCdnFailResultVector":[{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/crud-write-concern-w-majority.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"sourceBytes":20725,"destBytes":20725,"feedId":15705,"totalSpendMs":1289,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:54","host":"us-002*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx23/cdn58/contents/2020/11/14/18-00-55-737_1f8d8a71df9b92a9.svg","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 69189253.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Sat, 14 Nov 2020 18:00:55 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["403 Forbidden"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["C4F6:2E0D:9F4440:17E58E4:5FB01B54"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1605378589"],"x-ratelimit-used":["63"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx23/cdn58/contents/2020/11/14/18-00-55-737_1f8d8a71df9b92a9.svg","historyStatusCode":[],"spendMs":69},"base64UserPassword":null,"token":"df0b9******************************93a6e"},"githubUser":"myreaderx23","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"20.2 KB","destSize":"20.2 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-hidden-member.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"sourceBytes":11923,"destBytes":11923,"feedId":15705,"totalSpendMs":1601,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:54","host":"us-027*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx14/cdn51/contents/2020/11/14/18-00-56-271_a66feb4d1971f59c.svg","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 68584859.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Sat, 14 Nov 2020 18:00:56 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["403 Forbidden"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["9F6A:2FC3:1410AB8:20DEDEA:5FB01B40"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1605378587"],"x-ratelimit-used":["63"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx14/cdn51/contents/2020/11/14/18-00-56-271_a66feb4d1971f59c.svg","historyStatusCode":[],"spendMs":45},"base64UserPassword":null,"token":"6b67d******************************91b08"},"githubUser":"myreaderx14","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"11.6 KB","destSize":"11.6 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/crud-write-concern-w-majority.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"sourceBytes":20725,"destBytes":20725,"feedId":15705,"totalSpendMs":404,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:56","host":"us-002*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx23/cdn58/contents/2020/11/14/18-00-56-223_1f8d8a71df9b92a9.svg","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 69189253.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Sat, 14 Nov 2020 18:00:56 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["403 Forbidden"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["C4F6:2E0D:9F444F:17E5AAF:5FB01B57"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1605378589"],"x-ratelimit-used":["63"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx23/cdn58/contents/2020/11/14/18-00-56-223_1f8d8a71df9b92a9.svg","historyStatusCode":[],"spendMs":41},"base64UserPassword":null,"token":"df0b9******************************93a6e"},"githubUser":"myreaderx23","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"20.2 KB","destSize":"20.2 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-hidden-member.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"sourceBytes":11923,"destBytes":11923,"feedId":15705,"totalSpendMs":248,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:56","host":"us-027*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx14/cdn51/contents/2020/11/14/18-00-56-604_a66feb4d1971f59c.svg","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 68584859.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Sat, 14 Nov 2020 18:00:56 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["403 Forbidden"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["9F6A:2FC3:1410ADD:20E00ED:5FB01B58"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1605378587"],"x-ratelimit-used":["63"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx14/cdn51/contents/2020/11/14/18-00-56-604_a66feb4d1971f59c.svg","historyStatusCode":[],"spendMs":40},"base64UserPassword":null,"token":"6b67d******************************91b08"},"githubUser":"myreaderx14","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"11.6 KB","destSize":"11.6 KB","compressRate":"100%"}],"extra10_invalidATagHrefValue":{"https://aotu.io/notes/2020/11/12/mongo-replica-set/_#二、副本集的搭建以及测试":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#二、副本集的搭建以及测试","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#那问题来了，如此好用的模式以及条件在查询请求中如何使用呢？":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#那问题来了，如此好用的模式以及条件在查询请求中如何使用呢？","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#mongodb-副本集之入门篇":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#mongodb-副本集之入门篇","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#首先说一下-5种模式，其特点如下表所示：":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#首先说一下-5种模式，其特点如下表所示：","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#我们再来测试下-Automatic-Failover":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#我们再来测试下-Automatic-Failover","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#三、副本集写跟读的一些特性":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#三、副本集写跟读的一些特性","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#再说下3个条件，条件是在符合模式的基础上，再根据条件删选具体的节点":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#再说下3个条件，条件是在符合模式的基础上，再根据条件删选具体的节点","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#写关注（Write-concern）":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#写关注（Write-concern）","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#可以在搭建好的集群中简单测试下该功能":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#可以在搭建好的集群中简单测试下该功能","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#一、-mongodb-副本集介绍":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#一、-mongodb-副本集介绍","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#搭建步骤如下：":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#搭建步骤如下：","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#读偏好-（Read-preference）":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#读偏好-（Read-preference）","https://aotu.io/notes/2020/11/12/mongo-replica-set/_#结语":"https://aotu.io/notes/2020/11/12/mongo-replica-set/#结语"},"extra111_proxyServerAndStatMap":{"http://us-53.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-002.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]},"http://europe62.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-003.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-52.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-026.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-027.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-read-write-operations-primary.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn41@2020_2/2020/11/14/18-00-53-542_65f1f9721e4c1e53.svg","sourceBytes":17518,"destBytes":17518,"feedId":15705,"totalSpendMs":1858,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:52","host":"europe-24*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130,df070705583e16f404252c5b55689130","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"17.1 KB","destSize":"17.1 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-trigger-election.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn45@2020_6/2020/11/14/18-00-55-468_01f1a29f30661e62.svg","sourceBytes":20822,"destBytes":20822,"feedId":15705,"totalSpendMs":1812,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:54","host":"europe62*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"20.3 KB","destSize":"20.3 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-read-preference-secondary.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn66@2020_2/2020/11/14/18-00-55-849_a85265cc57e486ee.svg","sourceBytes":21178,"destBytes":21178,"feedId":15705,"totalSpendMs":1977,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:54","host":"us-52*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"20.7 KB","destSize":"20.7 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-delayed-member.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn49@2020_6/2020/11/14/18-00-55-998_035a3506f9915d6a.svg","sourceBytes":14229,"destBytes":14229,"feedId":15705,"totalSpendMs":2111,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:54","host":"us-026*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","githubUser":"myreaderx3","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"13.9 KB","destSize":"13.9 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-three-members-geographically-distributed.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn60@2020_2/2020/11/14/18-00-56-235_98a144e48c0437dd.svg","sourceBytes":13048,"destBytes":13048,"feedId":15705,"totalSpendMs":2326,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:54","host":"us-003*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"12.7 KB","destSize":"12.7 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://storage.360buyimg.com/o2-talos-report/aritcle-mongo-replica/replica-set-primary-with-secondary-and-arbiter.bakedsvg.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn68@2020_6/2020/11/14/18-00-56-290_900ea4d9197f75f5.svg","sourceBytes":10412,"destBytes":10412,"feedId":15705,"totalSpendMs":2339,"convertSpendMs":0,"createdTime":"2020-11-15 02:00:54","host":"us-53*","referer":"https://aotu.io/notes/2020/11/12/mongo-replica-set/","linkMd5ListStr":"df070705583e16f404252c5b55689130","githubUser":"myreaderx19","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"10.2 KB","destSize":"10.2 KB","compressRate":"100%"}],"successGithubMap":{"myreaderx25":1,"myreaderx27":1,"myreaderx16":1,"myreaderx11":1,"myreaderx3":1,"myreaderx19":1},"failGithubMap":{"myreaderx14":1,"myreaderx23":1}}