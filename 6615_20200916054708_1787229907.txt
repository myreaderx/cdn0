{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-09-16 13:46:55","updatedTime":"2020-09-16 13:46:55","title":"鸿蒙系统中的 JS 开发框架","link":"https://segmentfault.com/a/1190000024469232","description":"<p>今天鸿蒙终于发布了，开发者们也终于“沸腾”了。</p>\n<p>源码托管在国内知名开源平台码云上，<a href=\"https://gitee.com/openharmony\" rel=\"nofollow noreferrer\">https://gitee.com/openharmony</a></p>\n<p>我也第一时间下载了源码，研究了一个晚上，顺带写了一个 hello world 程序，还顺手给鸿蒙文档提了 2 个 PR。</p>\n<p>当然我最感兴趣的就是鸿蒙的 JS 框架 ace_lite_jsfwk，从名字中可以看出来这是一个非常轻量级的框架，官方介绍说是“轻量级 JS 核心开发框架”。</p>\n<p>当我看完源码后发现它确实轻。其核心代码只有 5 个 js 文件，大概也就 300-400 行代码吧。（没有单元测试）</p>\n<ul>\n <li>runtime-coresrccoreindex.js</li>\n <li>runtime-coresrcobserverobserver.js</li>\n <li>runtime-coresrcobserversubject.js</li>\n <li>runtime-coresrcobserverutils.js</li>\n <li>runtime-coresrcprofilerindex.js</li>\n</ul>\n<p>从名字可以看出来，这些代码实现了一个观察者模式。也就是说，它实现了一个非常轻量级的 MVVM 模式。通过使用和 vue2 相似的属性劫持技术实现了响应式系统。这个应该是目前培训班的“三大自己实现”之一了吧。（自己实现 Promise，自己实现 vue，自己实现 react）</p>\n<p><img src=\"https://segmentfault.com/img/remote/1460000024469235\" alt=\"\" title=\"\" /></p>\n<p>utils 里面定义了一个 Observer 栈，存放了观察者。subject 定义了被观察者。当我们观察某个对象时，也就是劫持这个对象属性的操作，还包括一些数组函数，比如 push、pop 等。这个文件应该是代码最多的，160 行。observer 的代码就更简单了，五六十行。</p>\n<p>而当我们开发的时候，通过 Toolkit 将开发者编写的 HML、CSS 和 JS 文件编译打包成 JS Bundle，然后再将 JS Bundle 解析运行成C++ native UI 的 View 组件进行渲染。</p>\n<p>“通过支持三方开发者使用声明式的 API 进行应用开发，以数据驱动视图变化，避免了大量的视图操作，大大降低了应用开发难度，提升开发者开发体验”。基本上就是一个小程序式的开发体验。</p>\n<p><img src=\"https://segmentfault.com/img/remote/1460000024469236\" alt=\"\" title=\"\" /></p>\n<p>在 srccorebaseframework_min_js.h 文件中，这段编译好的 js 被编译到了 runtime 里面。编译完的 js 文件不到 3K，确实够轻量。</p>\n<p>js runtime 没有使用 V8，也没有使用 jscore。而是选择了 JerryScript。JerryScript 是用于物联网的超轻量 JavaScript 引擎。它能够在内存少于 64 KB 的设备上执行 ECMAScript 5.1 源代码。这也是为什么在文档中说鸿蒙 JS 框架支持 ECMAScript 5.1 的原因。</p>\n<p>从整体看这个 js 框架大概使用了 96% 的 C/C++ 代码，1.8% 的 JS 代码。在 htm 文件中写的组件会被编译为原生组件。而 app_style_manager.cpp 和同级的七八个文件则用来解析 css，最终生成原生布局。</p>\n<p>虽然在 SDK 中有几个 weex 包，也发现了 react 的影子。但是在 C/C++ 代码中并没有看到 yoga 相关的内容（全局搜索没发现）。而 SDK 中的那些包仅仅是做 loader 用的，大概是为了在 webpack 打包时解析 htm 组件用的。将 htm 的 template 编译为 js 代码。</p>\n<p>整体而言，比我预想的要好一些。</p>","descriptionType":"html","publishedDate":"Tue, 15 Sep 2020 09:30:58 +0000","feedId":6615,"bgimg":"https://segmentfault.com/img/remote/1460000024469235","linkMd5":"986eedd756e6099dad2a03840b93f613","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn55@2020_3/2020/09/16/05-47-01-702_d08011062e985378.webp","destWidth":800,"destHeight":376,"sourceBytes":24896,"destBytes":24896,"author":"justjavac","articleImgCdnMap":{"https://segmentfault.com/img/remote/1460000024469235":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn55@2020_3/2020/09/16/05-47-01-702_d08011062e985378.webp","https://segmentfault.com/img/remote/1460000024469236":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn60@2020_3/2020/09/16/05-47-07-767_cd971bc125094b46.webp"},"publishedOrCreatedDate":1600235215704}],"record":{"createdTime":"2020-09-16 13:46:55","updatedTime":"2020-09-16 13:46:55","feedId":6615,"fetchDate":"Wed, 16 Sep 2020 05:46:55 +0000","fetchMs":7757,"handleMs":6722,"totalMs":28427,"newArticles":0,"totalArticles":50,"status":1,"type":0,"ip":"c89ef3265ed2f1111f3f460c951aedc9","hostName":"us-016*","requestId":"e80b1f892e1e4d88b2a2fec0d7894b81_6615","contentType":"application/atom+xml; charset=UTF-8","totalBytes":88624,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":2,"articlesImgsGithubTotal":2,"successGithubMap":{"myreaderx32":1,"myreaderx12":1},"failGithubMap":{}},"feed":{"createdTime":"2020-08-25 04:33:08","updatedTime":"2020-08-25 07:11:24","id":6615,"name":"SegmentFault 最新的文章","url":"http://segmentfault.com/feeds/blogs","subscriber":null,"website":null,"icon":"https://segmentfault.com/favicon.ico","icon_jsdelivr":null,"description":"","weekly":null,"link":"https://segmentfault.com"},"noPictureArticleList":[],"tmpCommonImgCdnBytes":24896,"tmpBodyImgCdnBytes":63728,"tmpBgImgCdnBytes":0,"extra4":{"start":1600235200272,"total":0,"statList":[{"spend":8711,"msg":"获取xml内容"},{"spend":6722,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":1,"msg":"修正封面图上传失败重新上传"},{"spend":5949,"msg":"正文链接上传到cdn"}]},"extra5":2,"extra6":2,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-53.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://segmentfault.com/img/remote/1460000024469235","sourceStatusCode":200,"destWidth":800,"destHeight":376,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn55@2020_3/2020/09/16/05-47-01-702_d08011062e985378.webp","sourceBytes":24896,"destBytes":24896,"feedId":6615,"totalSpendMs":3759,"convertSpendMs":0,"createdTime":"2020-09-16 13:46:58","host":"europe65*","referer":"https://segmentfault.com/a/1190000024469232","linkMd5ListStr":"986eedd756e6099dad2a03840b93f613,986eedd756e6099dad2a03840b93f613","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"24.3 KB","compressRate":"100%","sourceSize":"24.3 KB"},{"code":1,"isDone":false,"source":"https://segmentfault.com/img/remote/1460000024469236","sourceStatusCode":200,"destWidth":800,"destHeight":718,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn60@2020_3/2020/09/16/05-47-07-767_cd971bc125094b46.webp","sourceBytes":63728,"destBytes":63728,"feedId":6615,"totalSpendMs":5914,"convertSpendMs":0,"createdTime":"2020-09-16 13:47:02","host":"us-53*","referer":"https://segmentfault.com/a/1190000024469232","linkMd5ListStr":"986eedd756e6099dad2a03840b93f613","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"62.2 KB","compressRate":"100%","sourceSize":"62.2 KB"}],"successGithubMap":{"myreaderx32":1,"myreaderx12":1},"failGithubMap":{}}