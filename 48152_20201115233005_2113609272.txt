{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-11-16 07:29:31","updatedTime":"2020-11-16 07:29:31","title":"systemdについて","link":"https://oraccha.hatenadiary.org/entry/20140906/1409997978","description":"<p>前回の続きで、systemdを少し調べてみる。systemdはsysvinitに代わって<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Redhat\">Redhat</a>や<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Debian\">Debian</a>で採用されているが、「<a href=\"http://cpplover.blogspot.jp/2014/04/linussystemd.html\">Linus&#x69D8;&#x304C;Systemd&#x306B;&#x3076;&#x3061;&#x304D;&#x308C;&#x308B;</a>」とか<a href=\"http://boycottsystemd.org\">boycott systemd</a>とか、物議を醸しているようだ。</p><p><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/CentOS\">CentOS</a> 6.5だと、PID 1は当然initだけど、<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/CentOS\">CentOS</a> 7はsystemdになっているのがわかる。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>$ pstree -h\ninit─┬─acpid\n     ├─agetty\n     ├─crond\n     ├─6*[mingetty]\n     ├─ntpd\n     ├─rpc.statd\n     ├─rpcbind\n     ├─rsyslogd───3*[{rsyslogd}]\n     ├─sshd───sshd───sshd───bash───pstree\n     └─udevd───2*[udevd]</pre><pre class=\"code\" data-lang=\"\" data-unlink>[vagrant@localhost ~]$ pstree\nsystemd─┬─NetworkManager─┬─dhclient\n        │                └─3*[{NetworkManager}]\n        ├─VBoxService───7*[{VBoxService}]\n        ├─agetty\n        ├─auditd───{auditd}\n        ├─avahi-daemon───avahi-daemon\n        ├─crond\n        ├─dbus-daemon───{dbus-daemon}\n        ├─firewalld───{firewalld}\n        ├─iprdump\n        ├─iprinit\n        ├─iprupdate\n        ├─lvmetad\n        ├─master─┬─pickup\n        │        └─qmgr\n        ├─polkitd───5*[{polkitd}]\n        ├─rsyslogd───2*[{rsyslogd}]\n        ├─sshd───sshd───sshd───bash───pstree\n        ├─systemd-journal\n        ├─systemd-logind\n        ├─systemd-udevd\n        └─tuned───4*[{tuned}]</pre><p>/sbin/initがsystemdへの<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B7%A5%F3%A5%DC%A5%EA%A5%C3%A5%AF%A5%EA%A5%F3%A5%AF\">シンボリックリンク</a>になっているのね。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>[vagrant@localhost ~]$ ls -l /sbin/init \nlrwxrwxrwx. 1 root root 22 Aug  1 08:41 /sbin/init -&gt; ../lib/systemd/systemd</pre><p>systemdは高速起動が売りの一つとのことだけど、systemd-analyzeってコマンドで起動時間や何処で時間を食っているかなどを調べることができる。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>[vagrant@localhost ~]$ systemd-analyze time\nStartup finished in 431ms (kernel) + 1.326s (initrd) + 7.844s (userspace) = 9.603s\n\n[vagrant@localhost ~]$ systemd-analyze blame\n          2.167s firewalld.service\n          1.825s kdump.service\n          1.584s tuned.service\n          1.442s vboxadd.service\n          1.166s network.service\n          1.102s lvm2-monitor.service\n          :</pre><p>また、ログ周りも<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/syslogd\">syslogd</a>からjournaldという独自の実装に変わっている。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>[vagrant@localhost ~]$ sudo journalctl\n-- Logs begin at Fri 2014-09-05 01:45:16 EDT, end at Sat 2014-09-06 00:32:19 EDT. --\nSep 05 01:45:16 localhost.localdomain systemd-journal[80]: Runtime journal is using 4.0M (max 24.5M, leaving 36.7M of free 241.1M, current limit 24.5M).\nSep 05 01:45:16 localhost.localdomain systemd-journal[80]: Runtime journal is using 4.0M (max 24.5M, leaving 36.7M of free 241.1M, current limit 24.5M).\nSep 05 01:45:16 localhost.localdomain kernel: Initializing cgroup subsys cpuset\nSep 05 01:45:16 localhost.localdomain kernel: Initializing cgroup subsys cpu\nSep 05 01:45:16 localhost.localdomain kernel: Initializing cgroup subsys cpuacct\nSep 05 01:45:16 localhost.localdomain kernel: Linux version 3.10.0-123.6.3.el7.x86_64 (builder@kbuilder.dev.centos.org) (gcc version 4.8.2 20140120 (Red Hat 4.8.2-16) (GCC) ) #1 SMP Wed Aug 6 21:12:36 UTC 2014\nSep 05 01:45:16 localhost.localdomain kernel: Command line: BOOT_IMAGE=/vmlinuz-3.10.0-123.6.3.el7.x86_64 root=/dev/mapper/centos-root ro rd.lvm.lv=centos/swap vconsole.font=latarcyrheb-sun16 vconsole.keymap=jp106 rd.lvm.lv=centos/root crashkernel=auto rhgb quiet LANG=en_US.UTF-8\n:</pre><p>オプションに\"-b\"を指定すればブート時のもの、_SYSTEMD_UNIT=<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/sshd\">sshd</a>.serviceまたは'which <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/sshd\">sshd</a>'（デーモンのパス）を指定すればそのログのみが取り出せる。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>[vagrant@localhost ~]$ sudo journalctl _SYSTEMD_UNIT=sshd.service\n-- Logs begin at Fri 2014-09-05 01:45:16 EDT, end at Sat 2014-09-06 00:34:34 EDT. --\nSep 05 01:45:24 localhost.localdomain sshd[1099]: Server listening on 0.0.0.0 port 22.\nSep 05 01:45:24 localhost.localdomain sshd[1099]: Server listening on :: port 22.\nSep 05 01:45:30 localhost.localdomain sshd[2202]: Accepted publickey for vagrant from 10.0.2.2 port 49275 ssh2: RSA dd:3b:b8:2e:85:04:06:e9:ab:ff:a8:0a:c0:0\nSep 05 01:48:34 localhost.localdomain sshd[3895]: Accepted publickey for vagrant from 10.0.2.2 port 49326 ssh2: RSA dd:3b:b8:2e:85:04:06:e9:ab:ff:a8:0a:c0:0</pre><p>systemdのメインコマンドはsystemctl。これでサービス（systemd用語ではユニットというのかな）の有効・無効などを制御できる。serviceコマンドのレベルでは互換性を保っているようなので、取りあえずは戸惑いなく使えるのかなぁ。それに加えて、systemctl rebootとかpoweroffってのもできる。ふむ、/usr/sbin/rebootなどがsystemctlへの<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B7%A5%F3%A5%DC%A5%EA%A5%C3%A5%AF%A5%EA%A5%F3%A5%AF\">シンボリックリンク</a>になっている。結構システム全体に影響あるんだなぁ。</p><p>あと話は脱線するけど、systemd-detect-virtというハイパーバイザを認識するコマンドがある。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>[vagrant@localhost ~]$ systemd-detect-virt \noracle</pre><p>どんな実装になっているのかな。git<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA\">リポジトリ</a>を眺めてみたところ、<a href=\"http://cgit.freedesktop.org/systemd/systemd-stable/tree/src/shared/virt.c?h=v208-stable\">&#x3053;&#x306E;&#x3078;&#x3093;</a>だね。CPUIDや<a href=\"http://www.dmtf.org/standards/dmi\">DMI</a>を使って検出するようね。<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/VirtualBox\">VirtualBox</a>の場合は、/sys/class/dmi/id/sys_vendorが\"innotek <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GmbH\">GmbH</a>\"であれば、<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/VirtualBox\">VirtualBox</a>と判定されるようだ。</p><p>関連して、hostnamectlってコマンドもあるようだ。Chassisは\"<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/vm\">vm</a>\"になりそうなものの、\"n/a\"になっているね。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>[vagrant@localhost ~]$ sudo hostnamectl \n   Static hostname: localhost.localdomain\n         Icon name: computer\n           Chassis: n/a\n        Machine ID: 42223b0ecc4b406f8c15a34a4ad16be9\n           Boot ID: c140fb95493041e7ab58a6ddbe4b74f6\n    Virtualization: oracle\n  Operating System: CentOS Linux 7 (Core)\n       CPE OS Name: cpe:/o:centos:centos:7\n            Kernel: Linux 3.10.0-123.6.3.el7.x86_64\n      Architecture: x86_64</pre>","descriptionType":"html","publishedDate":"Sat, 06 Sep 2014 10:06:18 +0000","feedId":48152,"bgimg":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","linkMd5":"0b77e5002ffb6cd042cac6f810e2288e","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn17@2020_3/2020/11/15/23-30-04-240_826ddd244d633277.webp","destWidth":1500,"destHeight":1051,"sourceBytes":70050,"destBytes":47840,"author":"oraccha","enclosureType":"image/png","enclosureUrl":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","publishedOrCreatedDate":1605482971716}],"record":{"createdTime":"2020-11-16 07:29:31","updatedTime":"2020-11-16 07:29:31","feedId":48152,"fetchDate":"Sun, 15 Nov 2020 23:29:31 +0000","fetchMs":2841,"handleMs":5598,"totalMs":42079,"newArticles":0,"totalArticles":30,"status":1,"type":0,"ip":"05b50c64cd16569d0e135aedb1e28ee2","hostName":"us-038*","requestId":"bc4f28e9f6574564a1aabfa6250a4aa0_48152","contentType":"application/atom+xml; charset=utf-8","totalBytes":0,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":0,"articlesImgsGithubTotal":0,"successGithubMap":{"myreaderx2":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 03:48:01","updatedTime":"2020-09-07 03:48:01","id":48152,"name":"Plan9日記","url":"http://d.hatena.ne.jp/oraccha/rss","subscriber":66,"website":null,"icon":"https://oraccha.hatenadiary.org/favicon.ico","icon_jsdelivr":null,"description":"","weekly":null,"link":"https://oraccha.hatenadiary.org"},"noPictureArticleList":[],"tmpCommonImgCdnBytes":0,"tmpBodyImgCdnBytes":0,"tmpBgImgCdnBytes":0,"extra4":{"start":1605482963100,"total":0,"statList":[{"spend":3018,"msg":"获取xml内容"},{"spend":5598,"msg":"解释文章"},{"spend":0,"msg":"正文链接上传到cdn"},{"spend":33460,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"}]},"extra5":0,"extra6":0,"extra7ImgCdnFailResultVector":[null],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","sourceStatusCode":200,"destWidth":1500,"destHeight":1051,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn17@2020_3/2020/11/15/23-30-04-240_826ddd244d633277.webp","sourceBytes":70050,"destBytes":47840,"targetWebpQuality":75,"feedId":48152,"totalSpendMs":1137,"convertSpendMs":122,"createdTime":"2020-11-16 07:30:04","host":"us-011*","referer":"https://oraccha.hatenadiary.org/entry/20140906/1409997978","linkMd5ListStr":"0b77e5002ffb6cd042cac6f810e2288e","githubUser":"myreaderx2","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"68.4 KB","destSize":"46.7 KB","compressRate":"68.3%"}],"successGithubMap":{"myreaderx2":1},"failGithubMap":{}}