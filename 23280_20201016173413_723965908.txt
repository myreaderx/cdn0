{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-10-17 01:33:57","updatedTime":"2020-10-17 01:33:57","title":"索引失效底层原理分析，这么多年终于有人讲清楚了","link":"https://segmentfault.com/a/1190000037495198","description":"<h2>前言</h2>\n<p><code>吊打面试官</code>又来啦，今天我们讲讲MySQL<code>索引为什么会失效</code>，很多文章和培训机构的教程，都只会告诉你，在什么情况下索引会失效。</p>\n<p>比如：没遵循最佳左前缀法则、范围查询的右边会失效、like查询用不到索引等等</p>\n<p>但是没有一个人告诉你，<code>索引失效的原理</code>是什么，<code>老哥</code>今天就告诉大家，让你们<code>知其然</code>，还要<code>知其所以然</code>。</p>\n<p><img src=\"https://segmentfault.com/img/bVcHumC\" alt=\"image.png\" title=\"image.png\" /></p>\n<h2>单值索引B+树图</h2>\n<p>单值索引在B+树的结构里，一个节点只存一个键值对</p>\n<p><img src=\"https://segmentfault.com/img/bVcHumF\" alt=\"image.png\" title=\"image.png\" /></p>\n<h2>联合索引</h2>\n<p>开局一张图，由数据库的<code>a</code>字段和<code>b</code>字段组成一个<code>联合索引</code>。<br><img src=\"https://segmentfault.com/img/bVcHumI\" alt=\"image.png\" title=\"image.png\" /></br></p>\n<p>从本质上来说，联合索引也是一个B+树，和单值索引不同的是，联合索引的键值对不是1，而是大于1个。</p>\n<h3>a, b 排序分析</h3>\n<p>a顺序：1，1，2，2，3，3</p>\n<p>b顺序：1，2，1，4，1，2</p>\n<p>大家可以发现a字段是有序排列，b字段是无序排列（因为B+树只能选一个字段来构建有序的树）</p>\n<p>一不小心又会发现，在a相等的情况下，b字段是有序的。</p>\n<p>大家想想平时编程中我们要对两个字段排序，是不是先按照第一个字段排序，如果第一个字段出现相等的情况，就用第二个字段排序。这个排序方式同样被用到了B+树里。</p>\n<h3>分析最佳左前缀原理</h3>\n<h4>先举一个遵循最佳左前缀法则的例子</h4>\n<pre><code class=\"sql\">select * from testTable where a=1 and b=2</code></pre>\n<p><strong><code>分析如下：</code></strong></p>\n<p>首先a字段在B+树上是有序的，所以我们可以通过二分查找法来定位到a=1的位置。</p>\n<p>其次在a确定的情况下，b是相对有序的，因为有序，所以同样可以通过二分查找法找到b=2的位置。</p>\n<h4>再来看看不遵循最佳左前缀的例子</h4>\n<pre><code class=\"sql\">select * from testTable where b=2</code></pre>\n<p><strong><code>分析如下：</code></strong></p>\n<p>我们来回想一下b有顺序的前提：在a确定的情况下。</p>\n<p>现在你的a都飞了，那b肯定是不能确定顺序的，在一个无序的B+树上是无法用二分查找来定位到b字段的。</p>\n<p>所以这个时候，是用不上索引的。大家懂了吗？<br><img src=\"https://segmentfault.com/img/bVcHumQ\" alt=\"image.png\" title=\"image.png\" /></br></p>\n<h3>范围查询右边失效原理</h3>\n<h4>举例</h4>\n<pre><code class=\"sql\">select * from testTable where a&gt;1 and b=2</code></pre>\n<p><strong><code>分析如下：</code></strong></p>\n<p>首先a字段在B+树上是有序的，所以可以用二分查找法定位到1，然后将所有大于1的数据取出来，a可以用到索引。</p>\n<p>b有序的前提是a是确定的值，那么现在a的值是取大于1的，可能有10个大于1的a，也可能有一百个a。</p>\n<p>大于1的a那部分的B+树里，b字段是无序的（开局一张图），所以b不能在无序的B+树里用二分查找来查询，b用不到索引。</p>\n<h3>like索引失效原理</h3>\n<pre><code class=\"sql\">where name like \"a%\"\n\nwhere name like \"%a%\"\n\nwhere name like \"%a\"</code></pre>\n<p><strong>我们先来了解一下%的用途</strong></p>\n<ul>\n <li><code>%放在右边</code>，代表查询以\"a\"开头的数据，如：abc</li>\n <li><code>两个%%</code>，代表查询数据中包含\"a\"的数据，如：cab、cba、abc</li>\n <li><code>%放在左边</code>，代表查询以\"a\"为结尾的数据，如cba</li>\n</ul>\n<h4>为什么%放在右边有时候能用到索引</h4>\n<ul>\n <li>%放右边叫做：<code>前缀</code></li>\n <li>%%叫做：<code>中缀</code></li>\n <li>%放在左边叫做：<code>后缀</code></li>\n</ul>\n<p>没错，这里依然是最佳左前缀法则这个概念</p>\n<p><img src=\"https://segmentfault.com/img/bVcHumU\" alt=\"image.png\" title=\"image.png\" /></p>\n<p>大家可以看到，上面的B+树是由字符串组成的。</p>\n<p><code>字符串的排序方式</code>：先按照第一个字母排序，如果第一个字母相同，就按照第二个字母排序。。。以此类推</p>\n<p><strong><code>开始分析</code></strong></p>\n<p><strong>一、%号放右边（前缀）</strong></p>\n<p>由于B+树的索引顺序，是按照首字母的大小进行排序，前缀匹配又是匹配首字母。所以可以在B+树上进行有序的查找，查找首字母符合要求的数据。所以有些时候可以用到索引。</p>\n<p><strong>二、%号放左边</strong></p>\n<p>是匹配字符串尾部的数据，我们上面说了排序规则，尾部的字母是没有顺序的，所以不能按照索引顺序查询，就用不到索引。</p>\n<p><strong>三、两个%%号</strong></p>\n<p>这个是查询任意位置的字母满足条件即可，只有首字母是进行索引排序的，其他位置的字母都是相对无序的，所以查找任意位置的字母是用不上索引的。</p>\n<h2>总结</h2>\n<p>这里把一些经典的索引失效案例给大家分析了，希望能引发大家的思考，能够通过这些案例，明白其他情况索引失效的原理。</p>\n<p>之后我们在讲讲，如何通过索引查询到数据整个流程，<code>InnoDB</code>和<code>MyISAM</code>两个引擎底层索引的实现区别。</p>\n<p><code>授人以鱼不如授人以渔</code>，这一瞬间，老哥感觉自己特别的<code>shuai</code>。</p>\n<p><img src=\"https://segmentfault.com/img/bVcHum1\" alt=\"image.png\" title=\"image.png\" /></p>\n<p><strong>关注我，一个自学进入大厂的高级Java开发工程师</strong></p>","descriptionType":"html","publishedDate":"Fri, 16 Oct 2020 02:40:21 +0000","feedId":23280,"bgimg":"https://segmentfault.com/img/bVcHumC","linkMd5":"e2f29683007f3079f7c7d3d1fdf95779","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn15@2020_2/2020/10/16/17-34-05-839_49566a109516922c.webp","destWidth":263,"destHeight":242,"sourceBytes":13656,"destBytes":13656,"author":"公众号_IT老哥","articleImgCdnMap":{"https://segmentfault.com/img/bVcHumC":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn15@2020_2/2020/10/16/17-34-05-839_49566a109516922c.webp","https://segmentfault.com/img/bVcHumF":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn31@2020_1/2020/10/16/17-34-11-969_cb578a3b20bfd7c2.webp","https://segmentfault.com/img/bVcHumI":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn36@2020_6/2020/10/16/17-34-09-957_cd1598d70f89607b.webp","https://segmentfault.com/img/bVcHumQ":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn23@2020_5/2020/10/16/17-34-09-435_a3d28cffda039ba1.webp","https://segmentfault.com/img/bVcHumU":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn27@2020_6/2020/10/16/17-34-10-332_35fc17e2b2543c40.webp","https://segmentfault.com/img/bVcHum1":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn19@2020_2/2020/10/16/17-34-10-347_9b8471a732a3bebd.webp"},"publishedOrCreatedDate":1602869637546}],"record":{"createdTime":"2020-10-17 01:33:57","updatedTime":"2020-10-17 01:33:57","feedId":23280,"fetchDate":"Fri, 16 Oct 2020 17:33:57 +0000","fetchMs":3123,"handleMs":11358,"totalMs":30980,"newArticles":0,"totalArticles":50,"status":1,"type":0,"ip":"8f63d61dafbb91e16a52716ac9e06b5a","hostName":"us-018*","requestId":"0715fa182bd54fd28ddddf2b3f013325_23280","contentType":"application/atom+xml; charset=UTF-8","totalBytes":81546,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":6,"articlesImgsGithubTotal":6,"successGithubMap":{"myreaderx8":1,"myreaderx10":1,"myreaderx11":1,"myreaderx33":1,"myreaderx29":1,"myreaderx18":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 02:29:58","updatedTime":"2020-09-07 13:26:29","id":23280,"name":"SegmentFault 最新的文章","url":"https://segmentfault.com/feeds/blogs","subscriber":142,"website":null,"icon":"https://segmentfault.com/favicon.ico","icon_jsdelivr":null,"description":"","weekly":null,"link":"https://segmentfault.com"},"noPictureArticleList":[],"tmpCommonImgCdnBytes":13656,"tmpBodyImgCdnBytes":67890,"tmpBgImgCdnBytes":0,"extra4":{"start":1602869622133,"total":0,"statList":[{"spend":4055,"msg":"获取xml内容"},{"spend":11358,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":6402,"msg":"正文链接上传到cdn"}]},"extra5":6,"extra6":6,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-006.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe69.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-031.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-019.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-57.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://segmentfault.com/img/bVcHumC","sourceStatusCode":200,"destWidth":263,"destHeight":242,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn15@2020_2/2020/10/16/17-34-05-839_49566a109516922c.webp","sourceBytes":13656,"destBytes":13656,"feedId":23280,"totalSpendMs":4217,"convertSpendMs":0,"createdTime":"2020-10-17 01:34:02","host":"us-53*","referer":"https://segmentfault.com/a/1190000037495198","linkMd5ListStr":"e2f29683007f3079f7c7d3d1fdf95779,e2f29683007f3079f7c7d3d1fdf95779","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"13.3 KB","destSize":"13.3 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://segmentfault.com/img/bVcHumQ","sourceStatusCode":200,"destWidth":255,"destHeight":255,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn23@2020_5/2020/10/16/17-34-09-435_a3d28cffda039ba1.webp","sourceBytes":11460,"destBytes":11460,"feedId":23280,"totalSpendMs":3473,"convertSpendMs":0,"createdTime":"2020-10-17 01:34:06","host":"us-019*","referer":"https://segmentfault.com/a/1190000037495198","linkMd5ListStr":"e2f29683007f3079f7c7d3d1fdf95779","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"11.2 KB","destSize":"11.2 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://segmentfault.com/img/bVcHumI","sourceStatusCode":200,"destWidth":508,"destHeight":234,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn36@2020_6/2020/10/16/17-34-09-957_cd1598d70f89607b.webp","sourceBytes":15834,"destBytes":15834,"feedId":23280,"totalSpendMs":4118,"convertSpendMs":0,"createdTime":"2020-10-17 01:34:06","host":"europe-57*","referer":"https://segmentfault.com/a/1190000037495198","linkMd5ListStr":"e2f29683007f3079f7c7d3d1fdf95779","githubUser":"myreaderx8","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"15.5 KB","destSize":"15.5 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://segmentfault.com/img/bVcHum1","sourceStatusCode":200,"destWidth":263,"destHeight":242,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn19@2020_2/2020/10/16/17-34-10-347_9b8471a732a3bebd.webp","sourceBytes":15018,"destBytes":15018,"feedId":23280,"totalSpendMs":4491,"convertSpendMs":0,"createdTime":"2020-10-17 01:34:06","host":"us-031*","referer":"https://segmentfault.com/a/1190000037495198","linkMd5ListStr":"e2f29683007f3079f7c7d3d1fdf95779","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"14.7 KB","destSize":"14.7 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://segmentfault.com/img/bVcHumU","sourceStatusCode":200,"destWidth":660,"destHeight":307,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn27@2020_6/2020/10/16/17-34-10-332_35fc17e2b2543c40.webp","sourceBytes":12116,"destBytes":12116,"feedId":23280,"totalSpendMs":4953,"convertSpendMs":0,"createdTime":"2020-10-17 01:34:06","host":"us-006*","referer":"https://segmentfault.com/a/1190000037495198","linkMd5ListStr":"e2f29683007f3079f7c7d3d1fdf95779","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"11.8 KB","destSize":"11.8 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://segmentfault.com/img/bVcHumF","sourceStatusCode":200,"destWidth":498,"destHeight":182,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn31@2020_1/2020/10/16/17-34-11-969_cb578a3b20bfd7c2.webp","sourceBytes":13462,"destBytes":13462,"feedId":23280,"totalSpendMs":6250,"convertSpendMs":0,"createdTime":"2020-10-17 01:34:06","host":"europe69*","referer":"https://segmentfault.com/a/1190000037495198","linkMd5ListStr":"e2f29683007f3079f7c7d3d1fdf95779","githubUser":"myreaderx33","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"13.1 KB","destSize":"13.1 KB","compressRate":"100%"}],"successGithubMap":{"myreaderx8":1,"myreaderx10":1,"myreaderx11":1,"myreaderx33":1,"myreaderx29":1,"myreaderx18":1},"failGithubMap":{}}