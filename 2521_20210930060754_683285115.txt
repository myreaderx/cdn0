{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2021-09-30 14:05:50","updatedTime":"2021-09-30 14:05:50","title":"使用 Spring Boot Operator 部署 Spring Boot 到 K8S","link":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E4%BD%BF%E7%94%A8%20Spring%20Boot%20Operator%20%E9%83%A8%E7%BD%B2%20Spring%20Boot%20%E5%88%B0%20K8S","description":"<div><div><div id=\"media\" class=\"rich_media_thumb_wrp\">\n\n            <img class=\"rich_media_thumb\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_jpg/eZzl4LXykQwA5aibdbgBjgIFIeuicFf4BrM0icNtF5yP6sDRuRfiamBm0LDliaDY7cAUgdHHFNXK5ianuUFBfJLFPRiaQ/0?wx_fmt=jpeg?imageView2/1/w/600\">\n        </div>\n    \n\n    \n\n    <div class=\"rich_media_content\" id=\"js_content\">\n                    \n\n                    \n                    \n                    \n                    <p style=\"text-align: center;\" data-mpa-powered-by=\"yiban.io\"><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;color: rgb(255, 41, 65);line-height: 22.4px;\">（给</span><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;line-height: 22.4px;color: rgb(0, 128, 255);\">ImportNew</span><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;color: rgb(255, 41, 65);line-height: 22.4px;\">加星标，提高Java技能）</span></p><p><br></p><p><strong style=\"color: rgb(171, 25, 66);font-size: 16px;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, \" helvetica neue sc sans gb yahei ui arial sans-serif><span style=\"font-size: 15px;text-align: left;\">前言</span></strong></p><p style=\"text-align: left;\"><br></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">在 Kubernetes 中部署 Spring Boot 应用整体上来说是一件比较繁琐的事情，而 Spring Boot Operator 则能带给你更清爽简单的体验。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">Spring Boot Operator 基于 Kubernetes 的 Custom Resource Definitions (CRDs) 扩展 API 进行的开发。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><h2><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">1. 打包 Docker 镜像</span></strong></span></h2><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">在讲部署之前我们需要先将我们的 Spring Boot 应用打包成标准的 Docker Image。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">Java 项目打包镜像用 Maven/Gradle 插件比较多，这里在介绍一个新的 Google 开源插件 Jib，该插件使用起来比较方便。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"color: rgb(136, 136, 136);font-size: 14px;\">注意：Jib 打包的镜像会导致 Java 应用的 pid=1。在使用 Spring Boot Operator 进行发布时候，Operator 会设置 Kubernetes 的 ShareProcessNamespace 参数为 true（v1.10+版本都可使用）来解决该问题。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">下面就来演示一下通过 https://start.spring.io 生成一个标准的 Spring Boot 项目 operator-demo，然后使用 Jib 插件进行镜像打包。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"cs\"><code><span class=\"code-snippet_outer\">mvn com.google.cloud.tools:jib-maven-plugin:build </span></code><code><span class=\"code-snippet_outer\">-Djib.to.auth.username=${{ secrets.MY_USERNAME }} </span></code><code><span class=\"code-snippet_outer\">-Djib.to.auth.password=${{ secrets.MY_PASSWORD }} </span></code><code><span class=\"code-snippet_outer\">-Djib.container.jvmFlags=--<span class=\"code-snippet__keyword\">add</span>-opens,java.<span class=\"code-snippet__keyword\">base</span>/sun.nio.ch=ALL-UNNAMED </span></code><code><span class=\"code-snippet_outer\">-Djib.<span class=\"code-snippet__keyword\">from</span>.image=freemanliu/oprenjre:<span class=\"code-snippet__number\">11.0</span><span class=\"code-snippet__number\">.5</span> </span></code><code><span class=\"code-snippet_outer\">-Dimage=registry.cn-shanghai.aliyuncs.com/qingmuio/<span class=\"code-snippet__keyword\">operator</span>-demo/<span class=\"code-snippet__keyword\">operator</span>-demo:v1<span class=\"code-snippet__number\">.0</span><span class=\"code-snippet__number\">.0</span></span></code></pre></section><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span></p><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">执行上面的命令之后我们将得到一个标准的 Docker 镜像，该镜像会被推送到远程仓库。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><h2><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">2. Operator 快速体验</span></strong></span></h2><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">完成了镜像的构建之后，我们紧接着来安装我们的 Operator 到 Kubernetes 集群。当然了首先你需要一套集群，可以参考</span><a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651482135&amp;idx=1&amp;sn=230dac3e42d28b603815966e9fee2516&amp;chksm=bd2504688a528d7ebcbe0ec484af04f887fede54aa19c0acc0d5b2fbd473bc0d0067eaf90ea8&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" data-linktype=\"2\" style=\"text-align: start;white-space: normal;caret-color: rgb(0, 0, 0);font-size: 15px;\"><span style=\"font-size: 15px;\">本机搭建三节点 k8s 集群</span></a><span style=\"font-size: 15px;\">。</span></p><p style=\"text-align: left;\"><br></p><h3><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">2.1 快速安装</span></strong></span></h3><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">此处快速安装只是为了快速体验 Demo。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li></ul><pre class=\"code-snippet__js\" data-lang=\"ruby\"><code><span class=\"code-snippet_outer\">kubectl apply -f <span class=\"code-snippet__symbol\">https:</span>/<span class=\"code-snippet__regexp\">/raw.githubusercontent.com/goudai</span><span class=\"code-snippet__regexp\">/spring-boot-operator/master</span><span class=\"code-snippet__regexp\">/manifests/deployment</span>.yaml</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">apply 成功之后控制台输出：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"cpp\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__keyword\">namespace</span>/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-system created</span></code><code><span class=\"code-snippet_outer\">customresourcedefinition.apiextensions.k8s.io/springbootapplications.springboot.qingmu.io created</span></code><code><span class=\"code-snippet_outer\">role.rbac.authorization.k8s.io/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-leader-election-role created</span></code><code><span class=\"code-snippet_outer\">clusterrole.rbac.authorization.k8s.io/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-manager-role created</span></code><code><span class=\"code-snippet_outer\">clusterrole.rbac.authorization.k8s.io/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-proxy-role created</span></code><code><span class=\"code-snippet_outer\">clusterrole.rbac.authorization.k8s.io/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-metrics-reader created</span></code><code><span class=\"code-snippet_outer\">rolebinding.rbac.authorization.k8s.io/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-leader-election-rolebinding created</span></code><code><span class=\"code-snippet_outer\">clusterrolebinding.rbac.authorization.k8s.io/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-manager-rolebinding created</span></code><code><span class=\"code-snippet_outer\">clusterrolebinding.rbac.authorization.k8s.io/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-proxy-rolebinding created</span></code><code><span class=\"code-snippet_outer\">service/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-controller-manager-metrics-service created</span></code><code><span class=\"code-snippet_outer\">deployment.apps/spring-boot-<span class=\"code-snippet__keyword\">operator</span>-controller-manager created</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">稍等片刻查看是否已经安装成功：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li></ul><pre class=\"code-snippet__js\" data-lang=\"cs\"><code><span class=\"code-snippet_outer\">kubectl  <span class=\"code-snippet__keyword\">get</span> po -n spring-boot-<span class=\"code-snippet__keyword\">operator</span>-system</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">成功如下输出：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"cs\"><code><span class=\"code-snippet_outer\">NAME                                                       READY   STATUS    RESTARTS   AGE</span></code><code><span class=\"code-snippet_outer\">spring-boot-<span class=\"code-snippet__keyword\">operator</span>-controller-manager<span class=\"code-snippet__number\">-7f</span>498596bb-wcwtn   <span class=\"code-snippet__number\">2</span>/<span class=\"code-snippet__number\">2</span>     Running   <span class=\"code-snippet__number\">0</span>          <span class=\"code-snippet__number\">2</span>m15s</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h4><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">2.2 部署 OperatorDemo 应用</span></strong></span></h4><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">完成了 Operator 的部署之后，我们来部署我们第一个应用。这里我们就发布上面我们编写的 Spring Boot 应用 opreator-demo。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>首先，我们需要先编写一个 Spring Boot Application 的 CRD 部署 yaml，如下：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\"># Demo.yaml</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">apiVersion</span>: <span class=\"code-snippet__string\">springboot.qingmu.io/v1alpha1</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kind</span>: <span class=\"code-snippet__string\">SpringBootApplication</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">metadata</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">name</span>: <span class=\"code-snippet__string\">operator-demo </span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">spec</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">springBoot</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">version</span>: <span class=\"code-snippet__string\">v1.0.0</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">#    image: registry.cn-shanghai.aliyuncs.com/qingmuio/operator-demo/operator-demo:v1.0.0</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">细心的同学可能发现了，为啥连 Image 都没有这怎么发布？就 name、version 就能完成发布？</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">是的没错！就能完成发布，后面我讲详细讲到他是如何完成的。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>接着我们 apply 一下：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li></ul><pre class=\"code-snippet__js\" data-lang=\"css\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__selector-tag\">kubectl</span> <span class=\"code-snippet__selector-tag\">apply</span> <span class=\"code-snippet__selector-tag\">-f</span> <span class=\"code-snippet__selector-tag\">Demo</span><span class=\"code-snippet__selector-class\">.yaml</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">看到 console 输出：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li></ul><pre class=\"code-snippet__js\" data-lang=\"cs\"><code><span class=\"code-snippet_outer\">springbootapplication.springboot.qingmu.io/<span class=\"code-snippet__keyword\">operator</span>-demo created</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h4><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">2.3 验证</span></strong></span></h4><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">表示创建成功了，接着我们来看下我们部署的第一个应用，这里我们直接用上面的 yaml 中的 name 过滤即可。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br><strong>查看 pod</strong></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"go\"><code><span class=\"code-snippet_outer\">~# kubectl  get po | grep operator-demo</span></code><code><span class=\"code-snippet_outer\">operator-demo<span class=\"code-snippet__number\">-7574f</span>4789c-mg58m             <span class=\"code-snippet__number\">1</span>/<span class=\"code-snippet__number\">1</span>     Running   <span class=\"code-snippet__number\">0</span>          <span class=\"code-snippet__number\">76s</span></span></code><code><span class=\"code-snippet_outer\">operator-demo<span class=\"code-snippet__number\">-7574f</span>4789c-ssr8v             <span class=\"code-snippet__number\">1</span>/<span class=\"code-snippet__number\">1</span>     Running   <span class=\"code-snippet__number\">0</span>          <span class=\"code-snippet__number\">76s</span></span></code><code><span class=\"code-snippet_outer\">operator-demo<span class=\"code-snippet__number\">-7574f</span>4789c-sznww             <span class=\"code-snippet__number\">1</span>/<span class=\"code-snippet__number\">1</span>     Running   <span class=\"code-snippet__number\">0</span>          <span class=\"code-snippet__number\">76s</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">查看下我们的 pid 不等于 1 的设置是否生效。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">根据下面的结果可以看到通过设置 ShareProcessNamespace 该参数我们可以在 Kubernetes 层面来解决这个 pid=1 的问题。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kubectl</span> <span class=\"code-snippet__string\">exec -it operator-demo-7574f4789c-mg58m bash</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__meta\">bash-5.0#</span> <span class=\"code-snippet__string\">ps -ef</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">UID</span>        <span class=\"code-snippet__string\">PID  PPID  C STIME TTY          TIME CMD</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">root</span>         <span class=\"code-snippet__string\">1     0  0 02:06 ?        00:00:00 /pause</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">root</span>         <span class=\"code-snippet__string\">6     0 26 02:06 ?        00:00:09 java --add-opens java.base/sun.nio.ch=ALL-UNNAMED -cp /app/resources:/app/classes:/app/libs/* io.qingmu.operator.operatordemo.Oper...</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">root</span>        <span class=\"code-snippet__string\">38     0  0 02:07 pts/0    00:00:00 bash</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">root</span>        <span class=\"code-snippet__string\">44    38  0 02:07 pts/0    00:00:00 ps -ef</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><strong><span style=\"font-size: 15px;\">查看 svc</span></strong></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"swift\"><code><span class=\"code-snippet_outer\">~# kubectl  <span class=\"code-snippet__keyword\">get</span> svc | grep <span class=\"code-snippet__keyword\">operator</span>-demo</span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__keyword\">operator</span>-demo             <span class=\"code-snippet__type\">ClusterIP</span>   <span class=\"code-snippet__number\">10.101</span>.<span class=\"code-snippet__number\">128.6</span>     &lt;<span class=\"code-snippet__keyword\">none</span>&gt;        <span class=\"code-snippet__number\">8080</span>/<span class=\"code-snippet__type\">TCP</span>            2m52s</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">我们来访问一下试试：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"makefile\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__section\">root@server1:~# curl -i http://10.101.128.6:8080</span></span></code><code><span class=\"code-snippet_outer\">HTTP/1.1 200 </span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__section\">Content-Type: text/plain;charset=UTF-8</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__section\">Content-Length: 9</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__section\">Date: Wed, 08 Apr 2020 08:45:46 GMT</span></span></code><code><span class=\"code-snippet_outer\"><br></span></code><code><span class=\"code-snippet_outer\">hello !!!</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">我们来试着缩减副本数到 1 个。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>编辑我们的 Demo.yaml，加入一个新的属性 replicas：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\"># Demo.yaml</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">apiVersion</span>: <span class=\"code-snippet__string\">springboot.qingmu.io/v1alpha1</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kind</span>: <span class=\"code-snippet__string\">SpringBootApplication</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">metadata</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">name</span>: <span class=\"code-snippet__string\">operator-demo </span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">spec</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">springBoot</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">version</span>: <span class=\"code-snippet__string\">v1.0.0</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">replicas</span>: <span class=\"code-snippet__string\">1</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">应用一下：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"ruby\"><code><span class=\"code-snippet_outer\">root@server1<span class=\"code-snippet__symbol\">:~</span><span class=\"code-snippet__comment\"># kubectl apply -f Demo.yaml </span></span></code><code><span class=\"code-snippet_outer\">springbootapplication.springboot.qingmu.io/operator-demo configured</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">再次查看 pod，会发现我们的 pod 已经缩放为一个副本了：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"swift\"><code><span class=\"code-snippet_outer\">~# kubectl  <span class=\"code-snippet__keyword\">get</span> po | grep <span class=\"code-snippet__keyword\">operator</span>-demo</span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__keyword\">operator</span>-demo-7574f4789c-sznww             <span class=\"code-snippet__number\">1</span>/<span class=\"code-snippet__number\">1</span>     <span class=\"code-snippet__type\">Running</span>   <span class=\"code-snippet__number\">0</span>          8m29s</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h4><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">2.4 清理 operator-demo</span></strong></span></h4><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">要删除该 pod 我们只需要执行 delete 即可：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"css\"><code><span class=\"code-snippet_outer\">~# <span class=\"code-snippet__selector-tag\">kubectl</span> <span class=\"code-snippet__selector-tag\">delete</span> <span class=\"code-snippet__selector-tag\">-f</span> <span class=\"code-snippet__selector-tag\">Demo</span><span class=\"code-snippet__selector-class\">.yaml</span> </span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__selector-tag\">springbootapplication</span><span class=\"code-snippet__selector-class\">.springboot</span><span class=\"code-snippet__selector-class\">.qingmu</span><span class=\"code-snippet__selector-class\">.io</span> \"<span class=\"code-snippet__selector-tag\">operator-demo</span>\" <span class=\"code-snippet__selector-tag\">deleted</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">再次查看 pod，已经没了：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li></ul><pre class=\"code-snippet__js\" data-lang=\"cs\"><code><span class=\"code-snippet_outer\">kubectl  <span class=\"code-snippet__keyword\">get</span> po | grep <span class=\"code-snippet__keyword\">operator</span>-demo</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h2><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">3. 部署自己的应用</span></strong></span></h2><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">部署自己私有仓库的应用需要需要先创建 secret（如果已经创建跳过即可）。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>创建 docker-registry 的 secret：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"sql\"><code><span class=\"code-snippet_outer\">kubectl <span class=\"code-snippet__keyword\">create</span>  </span></code><code><span class=\"code-snippet_outer\">secret docker-registry aliyun-registry-secret </span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">--docker-server=registry-vpc.cn-hangzhou.aliyuncs.com </span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">--docker-username=*** </span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">--docker-password=*** </span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">--docker-email=***</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">自己应用的 crd Yaml：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">apiVersion</span>: <span class=\"code-snippet__string\">springboot.qingmu.io/v1alpha1</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kind</span>: <span class=\"code-snippet__string\">SpringBootApplication</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">metadata</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">name</span>: <span class=\"code-snippet__string\">你的应用的名称</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">spec</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">springBoot</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">version</span>: <span class=\"code-snippet__string\">v1.0.0</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">replicas</span>: <span class=\"code-snippet__string\">1 </span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">image</span>: <span class=\"code-snippet__string\">你的image地址</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">imagePullSecrets</span>: <span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">上面创建的secret</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h1><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">3.1 一个完整的 Spring Boot Application Yaml</span></strong></span></h1><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">下面是一个完整的 yaml 属性结构，大部分属性我们都可以用默认配置的即可。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>不设置属性，默认使用 Operator 中设置的通用值。详见后面的自定义安装 Operator。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">apiVersion</span>: <span class=\"code-snippet__string\">springboot.qingmu.io/v1alpha1</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kind</span>: <span class=\"code-snippet__string\">SpringBootApplication</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">metadata</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">name</span>: <span class=\"code-snippet__string\">operator-demo</span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">namespace</span>: <span class=\"code-snippet__string\">default</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">spec</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">springBoot</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">    # image 可以不设置，如果不设置默认使用 IMAGE_REPOSITORY+/+mate.name+:+spec.springBoot.version</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">    # registry.cn-shanghai.aliyuncs.com/qingmuio + / + operator-demo + : + v1.0.0</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">image</span>: <span class=\"code-snippet__string\">registry.cn-shanghai.aliyuncs.com/qingmuio/operator-demo:v1.0.0</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">clusterIp</span>: <span class=\"code-snippet__string\">\"\" </span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">version</span>: <span class=\"code-snippet__string\">v1.0.0 </span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">replicas</span>: <span class=\"code-snippet__string\">1 </span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">resource</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">cpu</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__attr\">request</span>: <span class=\"code-snippet__string\">50m</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__attr\">limit</span>: <span class=\"code-snippet__string\">\"\" </span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">memory</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__attr\">request</span>: <span class=\"code-snippet__string\">1Gi</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__attr\">limit</span>: <span class=\"code-snippet__string\">1Gi </span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">path</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">liveness</span>: <span class=\"code-snippet__string\">/actuator/health </span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">readiness</span>: <span class=\"code-snippet__string\">/actuator/health </span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">hostLog</span>: <span class=\"code-snippet__string\">/var/applog </span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">shutdown</span>: <span class=\"code-snippet__string\">/spring/shutdown </span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">imagePullSecrets</span>: <span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">aliyun-docker-registry-secret</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">env</span>: <span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: EUREKA_SERVERS</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">http://eureka1:8761/eureka/,http://eureka2:8761/eureka/,http://eureka3:8761/eureka/</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">nodeAffinity</span>: <span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">key</span>: <span class=\"code-snippet__string\">\"failure-domain.beta.kubernetes.io/zone\"</span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">operator</span>: <span class=\"code-snippet__string\">\"In\"</span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">values</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">\"cn-i\"</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">\"cn-h\"</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">\"cn-g\"</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h4><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">3.2 优雅停机的路径</span></strong></span></h4><p style=\"text-align: left;\"><br></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">由于优雅停机默认是关闭的，并且并不支持 GET 请求，所以我们需要开启和搭个桥。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>首先，在 application.yml 中启用：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">management</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">endpoints</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">web</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">exposure</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__attr\">include</span>: <span class=\"code-snippet__string\">\"*\"</span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">endpoint</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">shutdown</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__attr\">enabled</span>: <span class=\"code-snippet__string\">true</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">然后，桥接一个 GET 方法：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"kotlin\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__meta\">@RestController</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__keyword\">public</span> <span class=\"code-snippet__class\"><span class=\"code-snippet__keyword\">class</span> <span class=\"code-snippet__title\">ShutdownController</span> </span>{</span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__meta\">@Autowired</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__keyword\">private</span> ShutdownEndpoint shutdownEndpoint;</span></code><code><span class=\"code-snippet_outer\"><br></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__meta\">@GetMapping(<span class=\"code-snippet__meta-string\">\"/spring/shutdown\"</span>)</span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__keyword\">public</span> Map<string string> shutdown(HttpServletRequest request) {</string></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__keyword\">return</span> shutdownEndpoint.shutdown();</span></code><code><span class=\"code-snippet_outer\">    }</span></code><code><span class=\"code-snippet_outer\">}</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h3><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">3.3 node 亲和的使用</span></strong></span></h3><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">举一个例子：我们有一个 Spring Boot 应用 user-service，希望它能分布到 3 个可用区的 6 个节点上:</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>首先，我们把机器划分多个可用区：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li></ul><pre class=\"code-snippet__js\"><code><span class=\"code-snippet_outer\">cn-i区(node-i1,node-i02)</span></code><code><span class=\"code-snippet_outer\">cn-h区(node-g1,node-g02)</span></code><code><span class=\"code-snippet_outer\">cn-g区(node-h1,node-h02)</span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">现在，我们有 3 个可以区，每个区有2台 workload，一共6台。然后，我们需要给这些机器分别打上 label。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>将全部的 i 区机器标注为 cn-i：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kubectl</span> <span class=\"code-snippet__string\">label node node-i1 failure-domain.beta.kubernetes.io/zone=cn-i</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kubectl</span> <span class=\"code-snippet__string\">label node node-i2 failure-domain.beta.kubernetes.io/zone=cn-i</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">同理将 h 区的标注为 h，g 区同理。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kubectl</span> <span class=\"code-snippet__string\">label node node-h1 failure-domain.beta.kubernetes.io/zone=cn-i</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kubectl</span> <span class=\"code-snippet__string\">label node node-ih2 failure-domain.beta.kubernetes.io/zone=cn-i</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">准备工作我们就绪了，现在我们来设置让它达到我们的调度效果，像如下编写：</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"cs\"><code><span class=\"code-snippet_outer\">spec:</span></code><code><span class=\"code-snippet_outer\">  springBoot:</span></code><code><span class=\"code-snippet_outer\">    nodeAffinity: <span class=\"code-snippet__meta\">#可以不设置 节点亲和 这里演示的是尽量将pod分散到 i h g 三个可用区，默认设置了pod反亲和</span></span></code><code><span class=\"code-snippet_outer\">      key: <span class=\"code-snippet__string\">\"failure-domain.beta.kubernetes.io/zone\"</span></span></code><code><span class=\"code-snippet_outer\">      <span class=\"code-snippet__keyword\">operator</span>: <span class=\"code-snippet__string\">\"In\"</span></span></code><code><span class=\"code-snippet_outer\">      values:</span></code><code><span class=\"code-snippet_outer\">        - <span class=\"code-snippet__string\">\"cn-i\"</span></span></code><code><span class=\"code-snippet_outer\">        - <span class=\"code-snippet__string\">\"cn-h\"</span></span></code><code><span class=\"code-snippet_outer\">        - <span class=\"code-snippet__string\">\"cn-g\"</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h2><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">4. Operator 自定义安装</span></strong></span></h2><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">上面我们快速的安装了好了，接着我们来讲解下如何自定义安装，以及有哪些自定义的参数，可以个性化的参数我们用环境变量的方式注入。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br>下面来修改 Deployment 完成自己个性化的配置部署。从我提供的部署 yaml 中拉到最后，找到 name 是 spring-boot-operator-controller-manager 的 Deployment，我们将修改它。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">apiVersion</span>: <span class=\"code-snippet__string\">apps/v1</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kind</span>: <span class=\"code-snippet__string\">Deployment</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">metadata</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">labels</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__meta\">control-plane</span>: <span class=\"code-snippet__string\">controller-manager</span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">name</span>: <span class=\"code-snippet__string\">spring-boot-operator-controller-manager</span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">namespace</span>: <span class=\"code-snippet__string\">spring-boot-operator-system</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">.....</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        </span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        #注意：一下配置针对通用全局的spring boot默认配置，对crd的spring boot生效，这里不配置也可以在部署的yaml中指定</span></span></code><code><span class=\"code-snippet_outer\"><br></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 私有仓库的地址，比如我的最终打包的镜像地址是 registry.cn-shanghai.aliyuncs.com/qingmuio/operator-demo/operator-demo:v1.0.0</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 那么配置的值是 registry.cn-shanghai.aliyuncs.com/qingmuio/operator-demo</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 配置这个值之后，我们我们如果在发布的yaml中不写image，那么使用的image就是 IMAGE_REPOSITORY+\"/\"+mate.name+spec.springBoot.version</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: IMAGE_REPOSITORY</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">registry.cn-shanghai.aliyuncs.com/qingmuio</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 请求CPU限制</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: REQUEST_CPU</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">50m</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 限制最大能用最大CPU java应用可以不用限制，限制不合理会导致启动异常缓慢</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: LIMIT_CPU</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">\"\"</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 请求内存大小</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: REQUEST_MEMORY</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">500Mi</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 限制最大内存大小 一般和request一样大即可</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: LIMIT_MEMORY</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">500Mi</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 就绪检查Path，spring boot actuator 默认Path</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: READINESS_PATH</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">/actuator/health</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 就绪存活Path，spring boot actuator 默认Path</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: LIVENESS_PATH</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">/actuator/health</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 就绪存活Path，优雅停机Path</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: SHUTDOWN_PATH</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">/spring/shutdown</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 复制级 即副本数</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: REPLICAS</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">\"3\"</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 将日志外挂到主机磁盘Path，默认两者相同</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: HOST_LOG_PATH</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">/var/applog</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 用于pull 镜像的secrets</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: IMAGE_PULL_SECRETS</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">\"\"</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 用于pull 镜像的secrets</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: SPRING_BOOT_DEFAULT_PORT</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">\"8080\"</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # node亲和，比如我可以设置pod尽量分散在不同可用区cn-i,cn-g,cn-h区</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: NODE_AFFINITY_KEY</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">\"\"</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: NODE_AFFINITY_OPERATOR</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">\"\"</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: NODE_AFFINITY_VALUES</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">\"\"</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 全局的环境变量，会追加到每个spring boot的每个pod中，格式 k=v;k1=v2,</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__comment\">        # 如 EUREKA_SERVERS=http://eureka1:8761/eureka/,http://eureka2:8761/eureka/,http://eureka3:8761/eureka/;k=v</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__meta\">-</span> <span class=\"code-snippet__string\">name: SPRING_BOOT_ENV</span></span></code><code><span class=\"code-snippet_outer\">          <span class=\"code-snippet__attr\">value</span>: <span class=\"code-snippet__string\">\"\"</span></span></code><code><span class=\"code-snippet_outer\">        <span class=\"code-snippet__attr\">image</span>: <span class=\"code-snippet__string\">registry.cn-shanghai.aliyuncs.com/qingmuio/spring-boot-operator-controller:latest</span></span></code><code><span class=\"code-snippet_outer\"><br></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">.....</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h3><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">4.1 自定义安装之后部署</span></strong></span></h3><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\">yaml 可以简化为如下。</span></p><p style=\"text-align: left;\"><span style=\"font-size: 15px;\"><br></span></p><section class=\"code-snippet__fix code-snippet__js\"><ul class=\"code-snippet__line-index code-snippet__js\"><li><li><li><li><li><li><li></ul><pre class=\"code-snippet__js\" data-lang=\"properties\"><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">apiVersion</span>: <span class=\"code-snippet__string\">springboot.qingmu.io/v1alpha1</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">kind</span>: <span class=\"code-snippet__string\">SpringBootApplication</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">metadata</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">name</span>: <span class=\"code-snippet__string\">你的应用的名称</span></span></code><code><span class=\"code-snippet_outer\"><span class=\"code-snippet__attr\">spec</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">  <span class=\"code-snippet__attr\">springBoot</span>:<span class=\"code-snippet__string\"></span></span></code><code><span class=\"code-snippet_outer\">    <span class=\"code-snippet__attr\">version</span>: <span class=\"code-snippet__string\">v1.0.0</span></span></code></pre></section><pre style=\"text-align: left;\"><span style=\"font-size: 15px;\"></span><br></pre><h1><span style=\"color: rgb(171, 25, 66);\"><strong><span style=\"color: rgb(171, 25, 66);font-size: 15px;text-align: left;\">附录</span></strong></span></h1><p><span style=\"font-size: 15px;\"><br></span></p><p><strong><span style=\"font-size: 15px;\"><span style=\"font-size: 15px;text-align: left;\">环境变量表格</span></span></strong><span style=\"font-size: 15px;\"><span style=\"font-size: 15px;text-align: left;\"></span></span></p><p><span style=\"font-size: 15px;\"><span style=\"font-size: 15px;text-align: left;\"><br></span></span></p><p style=\"text-align: center;\"><img class=\"rich_pages wxw-img js_insertlocalimg\" data-ratio=\"1.2609375\" data-s=\"300,640\" data-type=\"png\" data-w=\"640\" style=\"max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/eZzl4LXykQxWaAZBibTRu1464m9e9oMSuYtEfXP1Q87WZTmicnibLpCD1oxmy8ownzJSFUjcwEiaqDPxqEHoian60Jg/640?wx_fmt=png\"></p><p><span style=\"font-size: 15px;\"><br></span></p><h1 style=\"text-align: left;\"><strong><span style=\"font-size: 15px;\">Github 仓库</span></strong><span style=\"font-size: 15px;\"></span></h1><p><span style=\"font-size: 15px;\"><br></span></p><p style=\"text-align: left;\"><span style=\"font-size: 12px;color: rgb(136, 136, 136);\">https://github.com/goudai/spring-boot-operator</span></p><p style=\"margin-bottom: 18px;color: rgb(85, 85, 85);font-family: \" microsoft yahei start normal rgb><span style=\"font-size: 14px;color: rgb(154, 154, 154);font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, \" helvetica neue sc sans gb yahei ui arial sans-serif justify></span><br></p><blockquote class=\"js_blockquote_wrap\" data-type=\"2\" data-url=\"\" data-author-name=\"\" data-content-utf8-length=\"18\" data-source-title=\"\"><section class=\"js_blockquote_digest\"><section><p style=\"color: rgb(154, 154, 154);font-size: 15px;white-space: normal;\"><span style=\"font-size: 14px;\">转自：青木，</span></p><p style=\"color: rgb(154, 154, 154);font-size: 15px;white-space: normal;\"><span style=\"font-size: 14px;\">链接：qingmu.io</span></p></section></section></blockquote><p><br></p><p style=\"color: rgb(154, 154, 154);font-size: 15px;white-space: normal;\"><span style=\"font-size: 14px;\"></span></p><p style=\"white-space: normal;text-align: center;\"><span style=\"font-size: 15px;color: rgb(136, 136, 136);\"><br></span></p><p style=\"white-space: normal;text-align: center;\"><span style=\"font-size: 15px;color: rgb(136, 136, 136);\">- EOF -</span></p><section donone=\"shifuMouseDownCard('shifu_c_030')\" label=\"Copyright Reserved by PLAYHUDONG.\" style=\"margin-top: 1em;margin-bottom: 1em;white-space: normal;text-align: start;max-width: 100%;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);border-width: 0px;border-style: initial;border-color: initial;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-left: 1em;max-width: 100%;line-height: 1.4;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"padding: 3px 8px;max-width: 100%;border-radius: 4px;color: rgb(255, 255, 255);background-color: rgb(255, 105, 31);font-family: inherit;text-align: inherit;text-decoration: inherit;font-size: 16px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">推荐阅读</span>  <span style=\"margin-left: 4px;padding: 3px 8px;max-width: 100%;border-radius: 1.2em;color: rgb(255, 255, 255);line-height: 1.2;background-color: rgb(204, 204, 204);font-family: inherit;text-align: inherit;text-decoration: inherit;border-color: rgb(249, 110, 87);font-size: 12px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">点击标题可跳转</span></section><section style=\"margin-top: -11px;padding: 22px 16px 16px;max-width: 100%;border-width: 1px;border-style: solid;border-color: rgb(255, 105, 31);color: rgb(51, 51, 51);font-size: 1em;font-family: inherit;text-align: inherit;text-decoration: inherit;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"text-decoration: underline;font-size: 13px;\">1、<a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651482135&amp;idx=1&amp;sn=230dac3e42d28b603815966e9fee2516&amp;chksm=bd2504688a528d7ebcbe0ec484af04f887fede54aa19c0acc0d5b2fbd473bc0d0067eaf90ea8&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" style=\"font-size: 13px;text-align: start;white-space: normal;caret-color: rgb(0, 0, 0);\" data-linktype=\"2\">本机搭建三节点 k8s 集群</a></span></p><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"text-decoration: underline;font-size: 13px;\">2、<a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651481149&amp;idx=2&amp;sn=f21c0a5b11982279d908b2f7815f33d5&amp;chksm=bd2508428a52815452b87c42a18d6d3461ce38f26608f9305ff49e6cd6b17362dd2eea9f214e&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" style=\"font-size: 13px;text-align: start;white-space: normal;caret-color: rgb(0, 0, 0);\" data-linktype=\"2\">Kubernetes 集群部署 tomcat 容器</a></span></p><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"text-decoration: underline;font-size: 13px;\">3、<a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651481149&amp;idx=2&amp;sn=f21c0a5b11982279d908b2f7815f33d5&amp;chksm=bd2508428a52815452b87c42a18d6d3461ce38f26608f9305ff49e6cd6b17362dd2eea9f214e&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" data-linktype=\"2\"></a><a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651492971&amp;idx=1&amp;sn=dbeea6fb42ff889267a177cdc0106296&amp;chksm=bd25fe148a527702c033c49eaf9b0491d4b20d0367e07fba10a6650ae148d5966a0c10f54ec1&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" style=\"font-size: 13px;text-align: start;white-space: normal;caret-color: rgb(0, 0, 0);\" data-linktype=\"2\">采用jenkins pipeline实现自动构建并部署至k8s</a></span></p></section></section><p style=\"white-space: normal;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);text-align: start;max-width: 100%;min-height: 1em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><br></p><p style=\"text-align: center;\"><span style=\"max-width: 100%;font-size: 14px;color: rgb(255, 169, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">看完本文有收获？请转发分享给更多人</span><br></p><p style=\"white-space: normal;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><strong style=\"max-width: 100%;color: rgb(255, 169, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">关注「ImportNew」，提升Java技能</strong></p><p style=\"white-space: normal;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><img data-ratio=\"0.9166666666666666\" data-s=\"300,640\" data-type=\"jpeg\" data-w=\"600\" style=\"box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 600px !important; max-width: 600px\" width=\"auto\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg\"></p><p style=\"text-align: right;\"><span style=\"font-size: 14px;text-align: right;\"></span><span style=\"max-width: 100%;font-family: -apple-system-font, system-ui, \" helvetica neue sc sans gb yahei ui arial sans-serif center break-word border-box>点赞和在看就是最大的支持</span><span style=\"max-width: 100%;font-family: -apple-system-font, system-ui, \" helvetica neue sc sans gb yahei ui arial sans-serif center break-word border-box>❤️</span><span style=\"font-size: 14px;text-align: right;\"></span></p><h1><br></h1>\n                </div>\n\n    \n    <br>\n\n    \n        <a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651501548&amp;idx=2&amp;sn=0aa07470a19acfc68cda6c8289a03190&amp;chksm=bd25df938a5256853407028ceb0d2796a8650256408ea4686b417648bf273ddcf43911338de7#rd\" style=\"color: blue\" class=\"media_tool_meta meta_primary\">原文</a>\n        <br>\n    \n\n    \n\n    <img alt=\"\" width=\"1px\" height=\"1px\" class=\"\" style=\"width:1px;height:1px;display:none\" src=\"http://www.jintiankansha.me/rss_static/11757/OVa0kViWYA\"></div></div>","descriptionType":"html","publishedDate":"Wed, 29 Sep 2021 03:30:00 +0000","feedId":2521,"bgimg":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_jpg/eZzl4LXykQwA5aibdbgBjgIFIeuicFf4BrM0icNtF5yP6sDRuRfiamBm0LDliaDY7cAUgdHHFNXK5ianuUFBfJLFPRiaQ/0?wx_fmt=jpeg?imageView2/1/w/600","linkMd5":"0f7b29afb815b36e557d2a44fd8f3d81","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn1@2020_3/2021/09/30/06-05-52-389_b27422d5095bf607.webp","destWidth":180,"destHeight":180,"sourceBytes":7597,"destBytes":5782,"author":"","articleImgCdnMap":{"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_jpg/eZzl4LXykQwA5aibdbgBjgIFIeuicFf4BrM0icNtF5yP6sDRuRfiamBm0LDliaDY7cAUgdHHFNXK5ianuUFBfJLFPRiaQ/0?wx_fmt=jpeg?imageView2/1/w/600":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn1@2020_3/2021/09/30/06-05-52-389_b27422d5095bf607.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/eZzl4LXykQxWaAZBibTRu1464m9e9oMSuYtEfXP1Q87WZTmicnibLpCD1oxmy8ownzJSFUjcwEiaqDPxqEHoian60Jg/640?wx_fmt=png":null,"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg":null,"http://www.jintiankansha.me/rss_static/11757/OVa0kViWYA":null},"publishedOrCreatedDate":1632981950101}],"record":{"createdTime":"2021-09-30 14:05:50","updatedTime":"2021-09-30 14:05:50","feedId":2521,"fetchDate":"Thu, 30 Sep 2021 06:05:50 +0000","fetchMs":205,"handleMs":28,"totalMs":124899,"newArticles":0,"totalArticles":5,"status":1,"type":0,"ip":"245d88d7b2d8f26704713c23b090d029","hostName":"us-015*","requestId":"98a9c952b17d4d378bdc8a6548ad26b3_2521","contentType":"application/rss+xml","totalBytes":5782,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":4,"articlesImgsGithubTotal":1,"successGithubMap":{"myreaderx12":1},"failGithubMap":{"myreaderx23":1}},"feed":{"createdTime":"2020-08-24 21:31:41","updatedTime":"2020-09-01 10:09:47","id":2521,"name":"ImportNew","url":"http://feedmaker.kindle4rss.com/feeds/importnew.weixin.xml","subscriber":null,"website":null,"icon":"http://www.sogou.com/images/logo/new/favicon.ico?v=4","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx63/cdn9@2020_3/2020/09/01/02-08-31-388_d24121c9beed1de6.ico","description":"伯乐在线旗下账号，专注Java技术分享，包括Java基础技术、进阶技能、架构设计和Java技术领域动态等。","weekly":null,"link":null},"noPictureArticleList":[{"createdTime":"2021-09-30 14:07:54","updatedTime":"2021-09-30 14:07:54","id":null,"feedId":2521,"linkMd5":"0f7b29afb815b36e557d2a44fd8f3d81"}],"tmpCommonImgCdnBytes":5782,"tmpBodyImgCdnBytes":0,"tmpBgImgCdnBytes":0,"extra4":{"start":1632981949714,"total":0,"statList":[{"spend":359,"msg":"获取xml内容"},{"spend":28,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":3,"msg":"修正封面图上传失败重新上传"},{"spend":121995,"msg":"正文链接上传到cdn"}]},"extra5":4,"extra6":3,"extra7ImgCdnFailResultVector":[{"code":1,"isDone":false,"source":"http://www.jintiankansha.me/rss_static/11757/OVa0kViWYA","sourceStatusCode":405,"sourceBytes":0,"destBytes":0,"feedId":2521,"totalSpendMs":510,"convertSpendMs":0,"createdTime":"2021-09-30 14:05:52","host":"europe-24*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E4%BD%BF%E7%94%A8%20Spring%20Boot%20Operator%20%E9%83%A8%E7%BD%B2%20Spring%20Boot%20%E5%88%B0%20K8S","linkMd5ListStr":"0f7b29afb815b36e557d2a44fd8f3d81","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[405],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"http://www.jintiankansha.me/rss_static/11757/OVa0kViWYA","sourceStatusCode":405,"sourceBytes":0,"destBytes":0,"feedId":2521,"totalSpendMs":464,"convertSpendMs":0,"createdTime":"2021-09-30 14:05:53","host":"us-003*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E4%BD%BF%E7%94%A8%20Spring%20Boot%20Operator%20%E9%83%A8%E7%BD%B2%20Spring%20Boot%20%E5%88%B0%20K8S","linkMd5ListStr":"0f7b29afb815b36e557d2a44fd8f3d81","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[405],"sourceSize":"0","destSize":"0"},null,null,{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg","sourceStatusCode":200,"destWidth":600,"destHeight":550,"sourceBytes":37143,"destBytes":31608,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":21529,"convertSpendMs":12,"createdTime":"2021-09-30 14:06:52","host":"us-013*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E4%BD%BF%E7%94%A8%20Spring%20Boot%20Operator%20%E9%83%A8%E7%BD%B2%20Spring%20Boot%20%E5%88%B0%20K8S","linkMd5ListStr":"0f7b29afb815b36e557d2a44fd8f3d81","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx23/cdn9/contents/2021/09/30/06-07-14-242_f93d0239d4369c75.webp","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 69189253.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Resource, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Thu, 30 Sep 2021 06:07:14 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["D15C:0B29:B9C31D:1766D1F:61555412"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1632985122"],"x-ratelimit-resource":["core"],"x-ratelimit-used":["60"],"x-xss-protection":["0"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx23/cdn9/contents/2021/09/30/06-07-14-242_f93d0239d4369c75.webp","historyStatusCode":[],"spendMs":31},"base64UserPassword":null,"token":"df0b9******************************93a6e"},"githubUser":"myreaderx23","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"36.3 KB","destSize":"30.9 KB","compressRate":"85.1%"},null],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-013.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-24.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[405]},"http://us-039.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]},"http://us-003.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[405]},"http://europe67.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]},"http://us-040.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_jpg/eZzl4LXykQwA5aibdbgBjgIFIeuicFf4BrM0icNtF5yP6sDRuRfiamBm0LDliaDY7cAUgdHHFNXK5ianuUFBfJLFPRiaQ/0?wx_fmt=jpeg?imageView2/1/w/600","sourceStatusCode":200,"destWidth":180,"destHeight":180,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn1@2020_3/2021/09/30/06-05-52-389_b27422d5095bf607.webp","sourceBytes":7597,"destBytes":5782,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":2502,"convertSpendMs":3,"createdTime":"2021-09-30 14:05:50","host":"us-011*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+%E4%BD%BF%E7%94%A8%20Spring%20Boot%20Operator%20%E9%83%A8%E7%BD%B2%20Spring%20Boot%20%E5%88%B0%20K8S","linkMd5ListStr":"0f7b29afb815b36e557d2a44fd8f3d81,0f7b29afb815b36e557d2a44fd8f3d81","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"7.4 KB","destSize":"5.6 KB","compressRate":"76.1%"}],"successGithubMap":{"myreaderx12":1},"failGithubMap":{"myreaderx23":1}}