{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-10-10 05:06:13","updatedTime":"2020-10-10 05:06:13","title":"今天你检查备份了吗？","link":"http://ourmysql.com/?p=1466","description":"<p> &#160; &#160;<a href=\"http://imysql.com/wp-content/uploads/2017/03/640.png\"><img class=\"alignnone size-full wp-image-4250\" src=\"http://imysql.com/wp-content/uploads/2017/03/640.png\" width=\"640\" height=\"382\" srcset=\"http://imysql.com/wp-content/uploads/2017/03/640.png 640w, http://imysql.com/wp-content/uploads/2017/03/640-300x179.png 300w, http://imysql.com/wp-content/uploads/2017/03/640-624x372.png 624w\" sizes=\"(max-width:640px) 100vw, 640px\" /></a></p>\n<p></p>\n<p style=\"padding:0px;border:0px;font-size:14px;vertical-align:baseline;line-height:1.714285714;color:#444444;font-family:helvetica, arial, sans-serif;margin-top:0px;margin-bottom:1.714285714rem;\">0、导读</p>\n<blockquote style=\"margin:0px 0px 1.714285714rem;padding:1.714285714rem;border:0px;font-size:14px;vertical-align:baseline;quotes:none;font-style:italic;color:#444444;font-family:helvetica, arial, sans-serif;\"><p style=\"padding:0px;border:0px;vertical-align:baseline;line-height:1.714285714;margin-top:0px;margin-bottom:1.714285714rem;\">《炉石传说》游戏数据库回档事件反思</p>\n</blockquote>\n<p style=\"padding:0px;border:0px;font-size:14px;vertical-align:baseline;line-height:1.714285714;color:#444444;font-family:helvetica, arial, sans-serif;margin-top:0px;margin-bottom:1.714285714rem;\">今天引爆各大技术群的事情就是网易游戏《炉石传说》游戏数据库发生宕机并引发数据丢失事故，最终决定回档并后续补偿玩家损失。详情可见官网公告：http://hs.blizzard.cn/articles/16/8565</p>\n<p style=\"padding:0px;border:0px;font-size:14px;vertical-align:baseline;line-height:1.714285714;color:#444444;font-family:helvetica, arial, sans-serif;margin-top:0px;margin-bottom:1.714285714rem;\">我以前也在搜狐畅游（http://www.changyou.com，NASDAQ:CYOU）负责游戏数据库维护，也遇到过因为服务器故障最终导致回档的事故，不过都没像这次炉石搞这么大动作。在这里我并不想借机调侃消费他们或搞营销，只想和大家一起聊聊作为DBA，应该注意哪些事。</p>\n<p style=\"padding:0px;border:0px;font-size:14px;vertical-align:baseline;line-height:1.714285714;color:#444444;font-family:helvetica, arial, sans-serif;margin-top:0px;margin-bottom:1.714285714rem;\">我们从公告的内容中，我们看到了几个问题：</p>\n<ol class=\"list-paddingleft-2\" style=\"margin:0px 0px 1.714285714rem;padding:0px;border:0px;font-size:14px;vertical-align:baseline;list-style-position:outside;list-style-image:initial;line-height:1.714285714;color:#444444;font-family:helvetica, arial, sans-serif;\">\n<li style=\"margin:0px 0px 0px 2.571428571rem;padding:0px;border:0px;vertical-align:baseline;\">\n<p>公告发布时间是2017.1.18 18点，决定回档到2017.1.14 15:20，中间这段时间难道一直都在尝试恢复数据库，就不能<strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">快速做出决策尽快直接回档</strong>吗，这是在考验游戏玩家的耐心，很容易引发玩家的“群体事件”；</p>\n</li>\n<li style=\"margin:0px 0px 0px 2.571428571rem;padding:0px;border:0px;vertical-align:baseline;\">\n<p>因为供电意外导致故障，并造成数据库损坏，如果也用MySQL数据库的话，看起来应该是<strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">没开启双1设置</strong>，并且有可能还在使用<strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">老式的锂电池BBU</strong>。所以断电后很容易导致阵列卡cache中的数据丢失，数据库也跟着损坏，以前没少才踩这个坑；</p>\n</li>\n<li style=\"margin:0px 0px 0px 2.571428571rem;padding:0px;border:0px;vertical-align:baseline;\">\n<p>连备份数据库也发生故障，有点不可思议，这样就容易让人产生是人为事故的联想了。不过，我多年前也发生过类似的情况，不过那次是因为用<strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">mysqldump备份时指定了错误的字符集</strong>，并且在<strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">做备份恢复测试时没严格测试数据的有效性</strong>，致使发生故障时不能正常恢复，结果也悲剧了。作为不了解内情的局外人，只能以官方公告为准，无要无端臆测；</p>\n</li>\n</ol>\n<p style=\"padding:0px;border:0px;font-size:14px;vertical-align:baseline;line-height:1.714285714;color:#444444;font-family:helvetica, arial, sans-serif;margin-top:0px;margin-bottom:1.714285714rem;\">关于服务器可靠性以及数据库备份，有几点建议：</p>\n<ol class=\"list-paddingleft-2\" style=\"margin:0px 0px 1.714285714rem;padding:0px;border:0px;font-size:14px;vertical-align:baseline;list-style-position:outside;list-style-image:initial;line-height:1.714285714;color:#444444;font-family:helvetica, arial, sans-serif;\">\n<li style=\"margin:0px 0px 0px 2.571428571rem;padding:0px;border:0px;vertical-align:baseline;\">\n<p><strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">必须定期全备</strong>，并且<strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">优先推荐物理备份</strong>，逻辑备份通常相对更慢。一般至少每天一次全备；</p>\n</li>\n<li style=\"margin:0px 0px 0px 2.571428571rem;padding:0px;border:0px;vertical-align:baseline;\">\n<p>每小时一次<strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">增备或差异备份</strong>，我以前的做法是开binlog，并且利用last_update_time列特征每小时做一次差异备份。这样我要恢复的话，一般最多只损失不到一个小时的数据；</p>\n</li>\n<li style=\"margin:0px 0px 0px 2.571428571rem;padding:0px;border:0px;vertical-align:baseline;\">\n<p>备份文件<strong style=\"margin:0px;padding:0px;border:0px;vertical-align:baseline;\">务必进行恢复测试</strong>，如果有多个备份集，可以采用随机抽取的方式做恢复测试，但一定要保证所有实例的备份最终都会被验证一次；</p>\n</li>\n<li style=\"margin:0px 0px 0px 2.571428571rem;padding:0px;border:0px;vertical-align:baseline;\">\n<p>必须监控服务器硬件健康状况，包括CPU、内存、阵列卡、阵列卡电池等部件，以及服务器温度等。我们曾经有在哈尔滨及西安某机房的服务器，一到夏天就很容易因为温度过高而引发自动重启</p>\n<h2  class=\"related_post_title\">猜您喜欢</h2><ul class=\"related_post\"><li><a href=\"http://ourmysql.com/archives/1353\" title=\"mysqldump加-w参数备份\">mysqldump加-w参数备份</a></li><li><a href=\"http://ourmysql.com/archives/1172\" title=\"linux 定期自动备份mysql的shell\">linux 定期自动备份mysql的shell</a></li></ul>","descriptionType":"html","publishedDate":"Sat, 11 Mar 2017 23:44:28 +0000","feedId":48827,"bgimg":"http://imysql.com/wp-content/uploads/2017/03/640.png","linkMd5":"d6c6ae577b34f88e007d1e34e9854794","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn7@2020_2/2020/10/09/21-07-39-283_4352ebff6a6c1b83.webp","destWidth":640,"destHeight":382,"sourceBytes":135479,"destBytes":40656,"author":"OurMySQL","articleImgCdnMap":{"http://imysql.com/wp-content/uploads/2017/03/640.png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn7@2020_2/2020/10/09/21-07-39-283_4352ebff6a6c1b83.webp"},"publishedOrCreatedDate":1602277573904}],"record":{"createdTime":"2020-10-10 05:06:13","updatedTime":"2020-10-10 05:06:13","feedId":48827,"fetchDate":"Fri, 09 Oct 2020 21:06:13 +0000","fetchMs":1770,"handleMs":17,"totalMs":89403,"newArticles":0,"totalArticles":20,"status":1,"type":0,"ip":"ada05755678bf4340b12baf2b7ec7640","hostName":"us-018*","requestId":"746d4ae01484452ca379636d57026681_48827","contentType":"text/xml; charset=UTF-8","totalBytes":40656,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":1,"articlesImgsGithubTotal":1,"successGithubMap":{"myreaderx12":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 03:50:31","updatedTime":"2020-09-07 06:08:42","id":48827,"name":"OurMySQL","url":"http://ourmysql.com/feed","subscriber":65,"website":null,"icon":"http://ourmysql.com/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx62/cdn64@2020_1/2020/09/06/22-08-41-665_73ff9ebc727a0c64.jpg","description":"我们致力于一个MySQL知识的分享网站","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":40656,"tmpBodyImgCdnBytes":0,"tmpBgImgCdnBytes":0,"extra4":{"start":1602277570731,"total":0,"statList":[{"spend":3156,"msg":"获取xml内容"},{"spend":17,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"正文链接上传到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"}]},"extra5":1,"extra6":1,"extra7ImgCdnFailResultVector":[null],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"http://imysql.com/wp-content/uploads/2017/03/640.png","sourceStatusCode":200,"destWidth":640,"destHeight":382,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn7@2020_2/2020/10/09/21-07-39-283_4352ebff6a6c1b83.webp","sourceBytes":135479,"destBytes":40656,"targetWebpQuality":75,"feedId":48827,"totalSpendMs":26061,"convertSpendMs":19,"createdTime":"2020-10-10 05:07:14","host":"us-54*","referer":"http://ourmysql.com/?p=1466","linkMd5ListStr":"d6c6ae577b34f88e007d1e34e9854794,d6c6ae577b34f88e007d1e34e9854794","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"132.3 KB","destSize":"39.7 KB","compressRate":"30%"}],"successGithubMap":{"myreaderx12":1},"failGithubMap":{}}