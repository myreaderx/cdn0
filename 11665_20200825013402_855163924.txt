{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"程序员的重复劳动陷阱","link":"http://kb.cnblogs.com/page/627035/","description":"<p>　　同样是一样的计算机专业毕业，进入职场的职位和工作都差不多，为何有些程序员短短几年就成长为全能选手或领域专家，有些程序员还在做CRUD？</p>\n<h2 id=\"程序员的重复劳动陷阱\"><span style=\"font-size: 16px;\">　　程序员的重复劳动陷阱</span><p>　　不知道大家有没有这样的感觉，每次加入一个新的公司/组，一开始总是要学这个学那个，可能会花很多时间看现有的代码，然后花一些时间实现一点点小的功能，等到经过一段时间后，自己对工作越来越得心应手，提来的类似需求马上就可以做，以做得多做得快为骄傲，觉的这样可以更受老板青睐，可以升职加薪。</p><p>　　我在毕业第三年的时候加入前公司，在加入公司的第一个季度，我主要再做一些边缘工具以及理解系统，从第二个季度开始在组里的核心业务上开发。当时自己为了能够快速的出成果，会从组里所有的任务里挑看着比较容易实现的做，往往一天就可以做完一个或者两个任务。做完一个任务后，发现backlog里面有相似的任务，我也“赶紧”抢过来assign给自己，然后快速的做完，提交code review。从那个季度开始我每个季度做的工单越来越多，超过组里的所有其他成员，自己也对自己的“高效”洋洋得意，觉的自己工作的非常充实，进步很大。</p><p>　　然而在这个过程中，我已经不知不觉得掉到“重复劳动”的陷阱中去了。</p><p>　　我们在写代码的时候，有一个原则交叫DRY（<strong>D</strong>on't&nbsp;<strong>R</strong>epeat&nbsp;<strong>Y</strong>ouself）原则，简单通俗的说就是不要copy paste代码，能抽象成函数的抽象成函数，能抽象成基类的抽象成基类。但是程序员的工作本身也应该遵循一样的道理，那就是尽量不要做重复的工作。</p><h2 id=\"重复劳动对程序员的危害\"><span style=\"font-size: 16px;\">　　重复劳动对程序员的危害</span><p>　　回到开篇的问题，同样是一样的计算机专业毕业，进入职场的职位和工作都差不多，为何有些程序员短短几年就成长为全能选手或领域专家，有些程序员还在做CRUD？</p><p><br class=\"Apple-interchange-newline\" /><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1694706/201906/1694706-20190617211339162-1142166449.jpg\" alt=\"\" /></p><p>　　大部分的技术学习曲线类似于上图，经历过短暂的入门期和相对长一些的积累期之后，可能大部分技术都会进入到高效期。在入门期和积累期的时候可能技能使用的效率会低一些，进入到高效期之后，随着技能使用的效率大大提高，工作所产生的“输出”也越来越大。因此“高效期“给人以充实的假象。</p><p>　　一旦自己的某项技术进入到高效期，在此基础上的提升会非常困难，可能之前工作三个月所掌握的新知识，比之后一年在工作中积累的要多。有时候我们看一个程序员工作了5年，但是他可能第一年学习并熟悉所用的技术，接下来4年都在做相同的工作，解决类似的需求，那么他的5年工作经验等于1年乘以5。</p><p>　　而有些程序员，他每工作一段时间之后，都会钻研技术更深的部分，或者去学习新的技术，总是保持着在尝试自己并不擅长的领域，那么这样的程序员，他的5年工作经验会比前一种程序员要多。</p><h2 id=\"如何摆脱重复劳动的循环\"><span style=\"font-size: 16px;\">　　如何摆脱重复劳动的循环</span><p>　　既然重复劳动的危害这么大，那么我们是否可以摆脱重复劳动的循环呢？</p><p>　　有的时候，程序员自己也不想老是重复的干类似的东西，但是无奈被派发的任务重复的很多，似乎自己可以选择的不多。</p><p>　　在我自己在第三年大量重复劳动之后，我的经理找到我谈话，说我不应该这样重复自己，同样的事情做一两次就好了，再重复的做对自己的帮助不大。我分享一下我是怎么样避免重复的劳动的：</p>\n   <ol>\n    <li>找到Pattern，解决一类问题而不是一个问题。当你解决了N次类似的需求的时候，是否可以把这些问题抽象出来，是否可以去自动化的实现这类需求？改了N次bug之后，是否可以发现bug的规律，能够开发出静态分析工具来抓住这些bug？</li>\n    <li>尝试用新的技术解决同样的问题。有时当项目的实现并没有多少规定的时候，我们可以在一定的自由度下尝试新的工具。今年年初的时候我去尝试修改一个已有的内部工具前段，持着学习新技术的心理，我用Redux重新实现了前段，而不是在原有的jQuery的前段基础上修改。</li>\n    <li>尝试换岗。换岗位可以直接的让你接受不同的项目，做一些不同的事情。我在上家公司的第一组待了近三年才换组，现在来看应该更早的时候尝试不同的事情。换岗位也会带来一些其他的问题，比如到新岗位之后可能会影响晋升速度，需要重新建立自己的权威等等。</li>\n    <li>换工作。换工作是一个终极大招，它会带来很多其他的变化，不建议只是为了脱离重复劳动而换工作。如果没有养成良好的学习习惯，那么换一份新工作之后也很有可能陷入到新的重复劳动的循环中。</li>\n   </ol><h2 id=\"重复劳动不可以完全避免\"><span style=\"font-size: 16px;\">　　重复劳动不可以完全避免</span><p>　　重复劳动是否可以完全避免呢？</p><p>　　我觉的是不可以避免的。以上的内容都是基于程序员成长的角度去分析问题，重复劳动是有害的。但是将程序员的劳动视为价值输出的话，熟练的价值输出确实也是程序员的价值之一，可以争取到更高的薪酬。</p><p>　　我们站在组织的角度上来看，重复的需求永远存在，这些重复的需求需要被完成。如果在人员配置有限的情况下，不可避免的单个个体成员需要去进行一定的重复劳动。而由于时间上的紧迫性，可能必须要用高效粗暴的方法来实现。</p><p>　　如果你是公司的初创成员，需要在初期做大量的重复工作来从无到有的实现新的产品，那毫无疑问这是应该做的，因为这样的重复劳动带来的收益可能是巨大的。</p><p>　　希望大家在工作中都可以正确的认识到重复劳动的陷阱，让自己能够保持持久的成长。</p></h2></h2></h2></h2>","descriptionType":"html","publishedDate":"Sun, 15 Dec 2019 07:17:25 +0000","feedId":11665,"bgimg":"https://img2018.cnblogs.com/blog/1694706/201906/1694706-20190617211339162-1142166449.jpg","linkMd5":"3c11aa7fbbae093219093acdcc278598","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn14@2020_4/2020/08/25/01-33-51-405_59ad8b3dddd92a9f.webp","destWidth":640,"destHeight":461,"sourceBytes":20469,"destBytes":13084,"author":"","articleImgCdnMap":{"https://img2018.cnblogs.com/blog/1694706/201906/1694706-20190617211339162-1142166449.jpg":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn14@2020_4/2020/08/25/01-33-51-405_59ad8b3dddd92a9f.webp"},"publishedOrCreatedDate":1598319223179},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"中国SaaS为什么不赚钱？","link":"http://kb.cnblogs.com/page/662133/","description":"<p>　　引用恒业资本董事总经理江一的一段话，“我们注意到现在50%的SaaS产品推向市场后，证明是完全跑偏的，只有不到10%的SaaS产品能够盈亏平衡。仅有3%，甚至1%、2%的产品能够对应企业客户，产生效果化的重大影响”（详见<a href=\"http://mp.weixin.qq.com/s?__biz=MzU1MzE1MzYyNQ==&amp;mid=2247492536&amp;idx=1&amp;sn=3b075eb8183bd1627dd8e6ca87df61b3&amp;chksm=fbf5868ecc820f9816f18735cc65d9079cb7935985b2f3ddedf3f463788e5d65a8053516fe73&amp;scene=21#wechat_redirect\" target=\"_blank\" data-itemshowtype=\"0\" data-linktype=\"2\">恒业资本江一：我来谈谈未来ToB吧，你们的分析都水得不行</a>）。</p>\n<p><strong>　　很显然，中国SaaS产业表面风光无限，但内里却未必有那么健康，甚至很难盈利。</strong></p>\n<p>　　本人从95年就开始做MIS软件，在B端软件行业干了20多年，算是这个行业的骨灰级老炮儿。所以，我希望结合自己的从业经验，从多个角度来谈谈中国SaaS不赚钱的根本原因。</p>\n<p><strong>　　【利润=营收-成本】</strong>，这是一个非常简单的公式。但当前的多数文章都是去讲怎么增加营收，却很少有文章从成本角度来讲解这个问题。</p>\n<p>　　其实，成本不但会影响利润，而且也会影响营收。如果营收快速增长了，但成本增长的更快，怎么可能盈利呢？</p>\n<p>　　因此，成本的缰绳一定要把控在自己手里，才有爆发的可能。否则创业只是给他人打工而已。</p>\n<ul class=\"list-paddingleft-2\">\n <li><p><strong>首先C端和B端是完全不同的，C端打法不适合B端。</strong></p><p>C端是统一标准化，一个微信或者淘宝可以让10多亿人使用，非常容易实现规模效应。可B端是非常非常多样化的，行业不同，企业规模不同，经营者理念不同，都会导致需求不同。多样化的需求会导致规模效应很难实现，这造就了一个碎片化的市场。</p></li>\n <li><p>C端产品研究的是人，容易理解和接触，而B端软件研究的行业，没有深度行业经验是无法做出能用的产品的。B端软件是交叉学科领域，产品设计者不但要懂各种软件技术，还要非常懂行业的管理运营。</p></li>\n</ul>\n<ul class=\"list-paddingleft-2\">\n <li><p>C端是靠广告盈利，只要烧钱烧出规模，用户群体大了，后期容易实现盈利。<strong>B端市场和使用人群是碎片化的，而且管理软件是严肃的事情，通过广告盈利的可能性几乎为0。</strong>B端软件根本上还是要靠提供工具来挣钱，企业使用工具提升了效率，自然就愿意付钱。</p></li>\n <li><p>C端互联网的20年高速发展，是因为很多企业抓住成本的缰绳。谷歌发明的大数据技术，让他们彻底摆脱了对IBM和Oracle的依赖，通过技术革命使用廉价的成本取得了比之前强大几十万倍的计算能力。如果没有这些技术，当今我们看到的是更加硕大无比的IBM和Oracle，而不是这些互联网巨头。</p><p>所以，任何商业模式的发展和变革，都需要先解决某些技术问题。而这些互联网技术不能解决B端多样化的问题，所以B端问题要自己解决。</p></li>\n <li><p><strong>B端要盈利，就必须做到产品差异化，找到适合的客户群体。</strong></p><p>现在SaaS产品的同质化非常严重，同质化的结果就是，竞争只能靠价格，大家都把精力投放到市场营销侧，很少关注真正的产品差异化问题。</p></li>\n</ul>\n<p><strong>　　01</strong></p>\n<p><strong>　　SaaS厂商的主要客户是谁？</strong></p>\n<p>　　本人对服装、餐饮、便利店这些零售行业非常熟悉，对服装后端的供应链和生产流程也非常熟悉。本人之前做过餐饮软件，接触过不少餐饮客户，深深地感觉到<strong>客户期望东西和实际软件功能相差很大。</strong>&nbsp;</p>\n<p>　　找到真正有需求的客户非常重要，单店需求非常简单，而且对软件的应用能力也很低，他就需要一辆自行车，你给他再好的汽车也是没有用。&nbsp;本人第一次创业，就是做小服装店生意的，曾经做了3000多家单店和小型连锁店。价格卖不上去，而且后期维护事情很多，很多人因为电脑不熟练，连电脑自身问题也要依靠你来解决，感觉不是在做公司，是在当活雷锋。</p>\n<p>　　之前也有一些餐饮SaaS创业者，跟我谈他们做小门店。小门店虽然看上去很多，但是一个广袤的沙漠之地，没有强大的资金实力，还是不要去碰为好。&nbsp;而且，小门店的死亡率非常高，上海一些餐饮门店开业不到一个月就关门，小门店因为要求不高，所以可以选择的产品也是非常非常多。巨头做小门店是为了占领支付市场，可能也没有指望挣钱。&nbsp;</p>\n<p>　　大型客户群体，没有强大的关系能力，是很难进去的，而且一开始就做大客户群体，很容易进入项目化，很难做到产品化。&nbsp;做大客户做久了，想往下走是非常非常难的。一个人过惯了花钱随意的生活，突然让他学习勤俭治家几乎是不可能的。&nbsp;举个后期维护的例子，大客户可能有自己的开发和技术团队，懂数据库，很多事情可以自己解决，但对中型客户群体是不可能的事情。&nbsp;所以，<strong>做中型客户群体，在后期维护上面更加讲究效率，一定需要实现自动化和工具化，这些对软件公司的能力是一个大挑战。</strong>&nbsp;</p>\n<p>　　第一次创业中，我们2个技术支持维护了3000多个客户群体，就是走的这种路线，否则，售后支持就会像洪水一样压死你。&nbsp;很多人以为大客户难做，那其实是没有真正经历过。大企业贷款从来不是问题，中小企业贷款一直是世界难题。&nbsp;本人认为，<strong>中型企业是一个非常好的标的，数量多，信息化需求比小企业强烈很多，油水虽然不像大企业那么多，但比小微企业还是多的。</strong>&nbsp;而且，如果能够做好中型企业，就说明企业产品化能力非常强，成本把控能力非常强，进入大型企业是相对容易的，因为能够帮助大型企业节约成本。由奢入俭难，由俭入奢易，就是这个道理。&nbsp;</p>\n<p><strong>　　02</strong></p>\n<p><strong>　　中型企业有哪些痛点？</strong></p>\n<p><strong>　　中型企业有强烈的信息化需求，也会有一些个性化的要求，但它们自身却没有能力去像大企业一样自主开发。</strong><strong>&nbsp;</strong>一些中等规模的餐饮企业往往存在选型非常困难的问题，比如餐饮SaaS多是集中在销售收银和营销侧。&nbsp;当然，也有一些SaaS企业开发出了后端的供应链部分，但却太难用，功能编排非常混乱，细节做的不好，流程可能是对的，但很难提升一线员工的工作效率。</p>\n<p><strong>　　其实中型企业已经进入了公司化的运作，管理的需求是多方面的。</strong>&nbsp;比如，一个咨询者跟我谈到酒水管理的问题，还有提出门店固定资产管理问题和移动端管理问题。问题有很多，可当前的软件厂商提供的都是部分解决方案。这就导致企业客户需要去找多家供应商来解决这些问题。&nbsp;这种思路是因为软件企业希望降低成本，没有能力做好全家桶解决方案，即使声称做好了，也不够细化，陷入”什么都有，但什么都不精”的问题。&nbsp;但对接软件真不是对接水管，对接软件成本很高，而且很容易失败。对中型企业来讲，这是不可性的，成本和风险都不能承担。&nbsp;</p>\n<p><strong>　　03</strong></p>\n<p><strong>　　SaaS的续费率为什么那么低？</strong></p>\n<p>　　企业信息化成功不是卖了软件就叫成功的，因为B端软件决策者和使用者是分离的，导致购买后往往真正应用效果不如人意。&nbsp;销售阶段就像是追求美丽的姑娘，用尽花言巧语，勾勒美好未来蓝图，先把姑娘搞到手。&nbsp;实施应用阶段就是结婚，开始处理双方家庭或者家族的各种琐事，任何细小的家庭矛盾都可能导致分手，真正美满幸福的白头偕老，把孩子抚养成才，才是真正的客户成功。&nbsp;现在中国SaaS产品的续费率很低，就说明软件企业没有做到真正的客户成功，只是把软件卖出去，割了一次韭菜，后面导致韭菜越割越难割。&nbsp;<strong>软件能够持续发展，持续满足客户的需求也是至关重要的。</strong></p>\n<p>　　其实，SaaS续费率低不是一个新问题，只是旧问题的新表现。&nbsp;以前没有SaaS的时候，很多企业也是隔几年就换软件的，很多情况就是因为发现软件不能满足现在的需求了。&nbsp;现在软件企业都只关注流程正确，但很少关注用户体验。用户体验好，才能提升一线使用人员的效率，很多人抱怨系统还不如EXCEL表格方便，系统牺牲了一线人员的利益，怎么能得到他们的用户呢。&nbsp;很多软件企业希望让老板去强压一线员工使用，只能导致表面的服从，不多发钱又降低效率，谁心里能愿意呢？&nbsp;虽然这些人员没有决定权，但他们会影响最终的使用效果，就和现在姑娘选老公，虽然自身有决策权，但家庭不会影响吗？&nbsp;所以，客户成功一定要保证一线人员的利益，提升他们的效率，让他们喜欢使用，而且能够积极参与进来。</p>\n<p><strong>　　04</strong><strong>如何做好用户体验？</strong>&nbsp;</p>\n<p>　　讲一个我们服装客户的案例，中型服装连锁企业，门店200家，拥有自己的工厂和品牌，使用我们软件12年。&nbsp;期间因为各种原因，公司希望找大的品牌公司合作，试用了行业前3名的软件，第一次试用持续了1年，后来的试用都只持续了不到1个月。&nbsp;</p>\n<p><strong>　　事后，本人总结了他们愿意留下的主要3个原因：</strong></p>\n<ul class=\"list-paddingleft-2\">\n <li><strong>用户体验好，一线人员使用效率高，容易掌握，全部门店人员支持我们软件，而且很多门店主动联系本人，让本人去公司活动活动；</strong></li>\n <li><strong>软件使用维护和使用成本低，而且大数据量情况下，性能非常好；</strong></li>\n <li><strong>满足了企业的很多个性化需求，这些都是其它大软件不具备的功能。</strong></li>\n</ul>\n<p>　　所以，当你的软件已经和企业运营相互绑定在一起后，软件是几乎不可能被换掉的。所以，能够做到客户成功，SaaS企业的续费率就不是问题。&nbsp;下面讲一个小案例来解释为什么用户体验对一线人员至关重要的，本人假设本文读者没有软件使用经验，所以找了一个非常明细的案例来说明，这样的细节太多太多，只适合跟专业的人讲解。</p>\n<p style=\"text-align: center;\"><img src=\"https://img2020.cnblogs.com/kb/1/202005/1-20200529153355820-1876224561.jpg\" alt=\"\" /></p>\n<p><br /><img class=\"rich_pages img_loading\" src=\"http://kb.cnblogs.com/page/662133/data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\" alt=\"\" data-ratio=\"0.7044776119402985\" data-s=\"300,640\" data-src=\"https://mmbiz.qpic.cn/mmbiz_jpg/jKYeahHQvOu1Sd02qGKvRziabia74UMuXDH2E88b8NN0fyqBPlV0r4owehC5B0NicuYbIs4OVStRu1vnnh8YGUb4g/640?wx_fmt=jpeg\" data-type=\"jpeg\" data-w=\"670\" /><br /><strong>　　</strong>上面两种形式都是用下拉框来做选择，数据不多情况下，二者效率相差不大，但当数据多的时候，左边可以通过拼音缩写快速找到选择项目，而右边就需要找很长很长时间。这对一线人员而言，右边的软件虽然实现了功能，但却要付出几十倍的使用时间成本。&nbsp;而做好B端软件，就是处理好多如牛毛的这些小细节，真正的去提升企业效率，而不是拿标准流程框框限制企业的发展。&nbsp;做好这些细节，我们也是被用户一步步逼的。有些客户是完美主义者，在被逼的同时，我们也感觉到了自身的持续成长。&nbsp;因为众口难调，小客户应用能力差，就更需要软件企业做好细节，让这些能力差的用户体验到使用软件的好处。&nbsp;</p>\n<p>　　归属自己的蓝海是怎么来的？简单的说，就是自己把标杆再提升一倍，自己努力过去，其他企业过不来，就有自己的蓝海了。&nbsp;日本汽车怎么占领美国市场的？美国汽车小问题多，经常需要维修，日本汽车做的非常非常可靠，改变了美国人对汽车的观念，发现原来汽车可以做到这样可靠。&nbsp;韩国现代汽车在2000年左右，在美国市场终于打开了局面，当时本人在美国，人家都是5年保修，它的广告直接就说10年保修，这就是自己把标杆抬高。&nbsp;比如，哪家SaaS企业可以跟客户讲，我们满足你们的个性化需求，而且不满意不收钱，如果真正做到了，怎么可能不挣钱呢，但做不到就是自寻死路。&nbsp;</p>\n<p><strong>　　05</strong></p>\n<p><strong>　　SaaS生态靠谱吗？</strong></p>\n<p>　　还有一种观点，就是不同的SaaS企业做好自己的标准化部分，众多SaaS企业联合形成生态，来解决客户的多样化需求问题，试图建立起行业标准接口来实现不同SaaS之间的整合，腾讯的SaaS生态计划就是基于这种思路。&nbsp;<strong>但本人看来，这种设计表面上很美好，但真正落地起来太多问题。</strong>&nbsp;容易标准化的部分是可以这样操作的，如短信服务，语音识别服务，但行业软件中太多的是行业商业逻辑，这些怎么标准化呢？&nbsp;之前看到一篇文章，讲腾讯的烟囱问题，很多东西在多个团队重复建造，大家的东西不能实现共享，一个大公司内部尚且如此，怎么能希望很多不同公司间实现无缝的亲密合作呢？&nbsp;因为真正落地，里面有太多太多细节问题，这里不再深入讨论了，因为太专业化了。&nbsp;</p>\n<p>　　通过上面的分析，我们可以看到企业是有需求的，用户企业的多样化需求和软件企业的标准化形成了巨大的矛盾，而且现在企业支付能力也越来越弱，软件企业必须能够提供低成本的而且满足多样化需求的产品，最终才能赢得市场，实现规模化。&nbsp;<strong>市场和技术是支撑企业发展的两个轮子，市场是前轮，技术是后轮。当技术门槛解决了，市场方向就变得重要。</strong>&nbsp;比如C端市场，但当后轮没有力量，而市场又是一个漫长爬山的过程，那么技术自然就成了企业发展的瓶颈。&nbsp;</p>\n<p><strong>　　06</strong></p>\n<p><strong>　　照抄美国经验不行</strong></p>\n<p>　　B端软件从90年算起，已经发展30年了，还是这样不温不火，是不是有种强大的力量在阻止这个行业发展呢？&nbsp;现在很多SaaS企业去学习美国企业，想抄美国经验，在本人看来是行不通的。<strong>管理和文化是相关的，美国人民经历了很长的统一标准化时代，接受了标准流程，而中国民众更喜欢多样化。</strong>&nbsp;美国可以有标准化的快餐文化，但谁能让中国人都去吃标准化的早餐呢？中国的饮食文化太丰富了，走美国的标准化路线是走不通的。&nbsp;</p>\n<p>　　信息化也是同样道理，中国有很多的中小型制造企业，行业门类齐全而且复杂度高，而且这些企业是不可能选标准化而放弃效率的，效率灵活多变是这些企业的命根子，所以，照搬美国模式是行不通的。&nbsp;提升产品能力，大大降低各项成本，提供多样化产品化解决方案。虽然前面本人提出的思路实现起来确实难度极大，但应该说是一种颠覆技术创新的思路。&nbsp;而且很多事实都证明了，最难走的路往往是一条活路，容易走的都是死路。&nbsp;</p>\n<p>　　刘邦拿自己当诱饵，给韩信争取到了去击破六国的时间，最终实现了对项羽的合围。面对项羽当诱饵，稍有不慎就会丧命。可中国军队的快速穿插战术就是这种思路，这是可行的。不过，这需要建立在自身能力的基础上的，否则就是自寻死路。&nbsp;<strong>中国软件开发90%以上的精力都是内耗掉的、浪费掉的。前面做的越多，后面包袱越大，阻力越大。</strong>最后，在一片漫骂声中，一个产品或者项目被停掉，然后开始了另外一个产品或者项目，然后还是出现了相同的问题。</p>\n<p>　　SaaS公司成本包含多个部分，销售成本，研发成本，测试成本，运维成本和运营成本，所有的这些成本都有着一个控制点，就是软件的结构设计能力和团队成员单兵能力。&nbsp;下面，本人就使用通俗的语言来讲讲为啥是这样，看看下面一个对比图，代表了2种代码风格。</p>\n<p style=\"text-align: center;\"><img class=\"rich_pages \" src=\"https://img2020.cnblogs.com/news/1/202005/1-20200517180637726-1317256928.jpg\" alt=\"\" data-ratio=\"0.5364806866952789\" data-s=\"300,640\" data-src=\"https://mmbiz.qpic.cn/mmbiz_jpg/jKYeahHQvOu1Sd02qGKvRziabia74UMuXD8cRwXPcD6bNuAmZfVa8mIJFRDlNXSmDmMsrVUibtyFKJ6CbjkOlkHbQ/640?wx_fmt=jpeg\" data-type=\"jpeg\" data-w=\"699\" data-fail=\"0\" /></p>\n<p><strong>　　优质代码是容易实现团队间密切合作的，而且很少产生误沟通，因为非常清晰有条理。左边和右边，显然左边团队协作开发成本是低的，右边不但难找到线头，可能会常常找错线头。</strong></p>\n<p>　　&nbsp;再谈谈测试成本，左边线路调整了，很容易推测出哪些部分受影响，而右边调整了，你可能都不知道影响了哪些地方，开发和测试成本都大大提升了，BUG率后期会出现爆发式增长，因为所有的人都可能修改了一个问题，创造出了10个问题。&nbsp;<strong>那运维成本是怎么幅度提升呢？</strong>&nbsp;之前面试过一个一线大厂的运维，他说他们运维有80多人，我很是奇怪，问他们日常都做啥。&nbsp;他说大量时间都在传递客服提出的问题到开发那里，因为BUG不可控，而且问题不能追溯，导致客服和运维都无法解决问题，只能把问题传递到开发那边，而且因为客户群多，问题多，所以需要传递信息的客服和运维也多。&nbsp;</p>\n<p>　　如果代码是右边那样，运营那边提出新的需求，开发那边一般都会一拖再拖，因为开发都在忙着在Bug堆里混战，而且不小心可能导致更多的问题，谁愿意当背锅侠呀。&nbsp;本人做了20多年技术，而且管理了10多年技术团队，这种事情看到的太多太多，毫不夸张的讲，中国软件开发90%以上的精力都是内耗掉的，浪费掉的，前面做的越多，后面包袱越大，阻力越大。 最后，在一片漫骂声当中，一个产品或者项目被停掉，然后开始了另外一个产品或者项目，然后还是走入了相同的问题。&nbsp;摆脱不了上面问题的原因就是软件结构设计能力不足，不能让结构清晰化，灵活化和柔性化。&nbsp;</p>\n<p>　　<strong>做好结构设计，降低开发、测试、运维和运营成本，这会反过来降低销售成本和提升营收。因为人的本性是无法拒绝低价且优质的东西的。</strong>&nbsp;100万买到一个200万的迈巴赫，开始可能大家不敢买，怕是假货，当证明是货真价实的时候，大家会去抢着买，自然会大大降低营销成本，同时大大提升营收。&nbsp;</p>\n<p>　　当企业自身功力深厚后，只有加上一定的营销外力，自身的内在动力就会爆发出来。&nbsp;淘宝服装电商的成功就是基于这个道理，因为做了很长时间服装企业的生意，非常懂得其中的原因。 之前服装的加价是非常厉害的，出厂到终端会有10倍的差价，电商通过去中间化，即使把价格砍半，商家还是很大利润空间，所有才触发大爆发，这是一次行业成本重新排列的结果，当然现在电商成本也提升了很多，但不能否认之前的爆发原因。&nbsp;O2O电商为啥喊着去中间化，但基本上都全军覆没，因为成本利润空间太小，哪个餐饮企业敢降价50%，还觉得自己大挣钱呢？&nbsp;看行业，真不能忽略成本问题，成本，成本，还是成本，只有大大降低成本才能触发爆发，否则都是伪概念。现在的SaaS软件企业，没有解决这个成本问题，自然也不会实现想象中的大爆发。&nbsp;</p>\n<p><strong>　　07</strong></p>\n<p><strong>　　太多软件只关注当前需求，</strong><strong>不考虑未来变化</strong>&nbsp;</p>\n<p>　　下面讲一个单兵素质问题的案例，下面是我的一个面试题，考察的是开发者的思维能力而不是简单的打印出答案，所有的人都能做到打印出需要的答案，但只有不到十分之一的面试者的思路是正确的。&nbsp;面试题只是一个简单的分组问题，在软件领域普遍应用，就和四则运算一样基础，但就这样一个特别基础的问题，卡掉了非常多的面试者。</p>\n<p style=\"text-align: center;\"><img src=\"https://img2020.cnblogs.com/kb/1/202005/1-20200529220331340-1691781520.jpg\" alt=\"\" /></p>\n<p style=\"text-align: center;\"><img src=\"https://img2020.cnblogs.com/kb/1/202005/1-20200529220411993-1186207191.png\" alt=\"\" /></p>\n<p><br /><img class=\"rich_pages img_loading\" src=\"http://kb.cnblogs.com/page/662133/data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\" alt=\"\" data-ratio=\"0.50187265917603\" data-s=\"300,640\" data-src=\"https://mmbiz.qpic.cn/mmbiz_jpg/jKYeahHQvOu1Sd02qGKvRziabia74UMuXDGSOo9yAbdWD6xaYbFIerXc1QrPia7yKwL1gvhFcBNkJ4Y9NKPyXiazaw/640?wx_fmt=jpeg\" data-type=\"jpeg\" data-w=\"801\" /><img class=\"rich_pages img_loading\" src=\"http://kb.cnblogs.com/page/662133/data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\" alt=\"\" data-ratio=\"0.5801435406698564\" data-s=\"300,640\" data-src=\"https://mmbiz.qpic.cn/mmbiz_png/jKYeahHQvOu1Sd02qGKvRziabia74UMuXDt23aBIfWjOQgTxI5WicPw97ibZkiciaBMfNch9kUdNFOgLOpsVqyiawXfDw/640?wx_fmt=png\" data-type=\"png\" data-w=\"836\" /><br />　　多数人给出的答案类似左边的，很少数人给出了类似右边的答案。你可能不懂编程，但看长度，你就发现左边要长很多，而且这只是部分，不是全部。左边的代码可以说没有任何扩展性，需求稍微一变化，这些代码就是废品，而右边不但简单易懂，而且扩展性非常好，需求变化了，只有稍微调整一下即可。&nbsp;</p>\n<p>　　为啥要讲解这个案例呢？这就是不同软件应对多样化客户需求的不同结果，结构化好的软件，非常灵活和柔性，需求变化了，软件可以非常低成本的随之变化，持续满足客户的需求。&nbsp;现在太多的软件只关注当前需求，而不考虑未来变化，导致今天的努力堵了明天的路，怎么可能会持续的低成本的快速发展。&nbsp;当大量的开发人员还处于只满足当前需求的水平，怎么能做到柔性化和灵活化，为未来考虑呢？&nbsp;</p>\n<p>　　阿里提出中台战略，其实也基于相同的”软件模块重用”思想，重用的越多，则前面讲的多个成本就越低。&nbsp;只不过真正实现重用，光有概念是不行的，做好可重用的软件是需要工匠精神和持续的努力的，思路需要能力来支撑。&nbsp;</p>\n<p>　　前些时间很多国内武术大师被KO，格斗的基础能力就是力量、速度和反应能力，招式是建立在这些基础上面的。&nbsp;软件的基础能力就是灵活、稳定、成本，这些能力都不是短时间能够掌握的，或者学习一些概念就能够掌握的。&nbsp;国内软件行业在可重用方面的实践还是很少的，而且B端领域的重用其实是比计算机标准领域复杂很多，操作系统就是一种重用概念，还有很多软件框架，但在B端软件的重用还是很少的。</p>\n<p>　　PaaS是一种国外的尝试，但本人看来并不适合中国国情。&nbsp;一个校友就职于国内一流的零售连锁企业，使用了Oracle的Netsuite，花费500多万，聘请了国内顶级实施团队，花费大半年时间，结果失败了，钱都打水漂了。&nbsp;行业框架其实是一种跨学科的实践，光有软件知识是不够的，Netsuite缺乏对中国行业逻辑支撑，很难适应中国的企业。&nbsp;做可持续软件，就是需要把变化和不变分开，让变化的业务逻辑体现到参数化当中，通过参数化的框架来应对多变的需求。&nbsp;例如，中学大家开始学习代数，发现小学的很多难题都可以通过代数轻松解决，代数就是参数化，当然B端软件框架的参数化要复杂太多太多。&nbsp;</p>\n<p><strong>　　////</strong></p>\n<p><strong>　　总结</strong></p>\n<p>　　只有做到客户成功，SaaS软件企业才能走出困境，要把客户的个性化需求当作是福气，因为解决越多客户实在问题，提升客户的效率，你和客户的绑定才会越紧密。&nbsp;续费率低只是表象，深层次是因为需求多样化和供给标准化的矛盾没有解决，用户没有深刻体会到软件带来的价值。&nbsp;B端软件不像很多人想象那样简单，客户要的不只是一个能飞的飞机，客户要的是一个快速、舒适、运营成本低而且非常安全的飞机，这就是为什么造大飞机非常非常难，而造能飞的飞机并不难。&nbsp;把标准去提升一倍，甚至几倍，提升自身的软件产品能力，跨域这个标杆。如此，你才能到达一个属于自己的蓝海。</p>\n<p>　　<br /><strong>　　本文作者：黄允聪，</strong>20多年的信息化老兵，对中国2025信息化具有很深的思考，一直在研究如何通过提升软件开发效率，降低成本，提升中国的信息化水平。</p>\n<p>　　<strong>作者公众号【可持续开发】</strong>，文章主要探讨如何普及和提升企业信息化水平，以及过程中面临的困难和解决方法。如何通过提升信息化管理水平来实现新零售，提升企业的盈利能力等。</p>","descriptionType":"html","publishedDate":"Fri, 29 May 2020 14:11:13 +0000","feedId":11665,"bgimg":"https://img2020.cnblogs.com/kb/1/202005/1-20200529153355820-1876224561.jpg","linkMd5":"efeb844d5421407fe9c72ed59a851362","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn29@2020_2/2020/08/25/01-33-51-660_ca8880b595581206.webp","destWidth":670,"destHeight":472,"sourceBytes":55653,"destBytes":39990,"author":"","articleImgCdnMap":{"https://img2020.cnblogs.com/kb/1/202005/1-20200529153355820-1876224561.jpg":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn29@2020_2/2020/08/25/01-33-51-660_ca8880b595581206.webp","http://kb.cnblogs.com/page/662133/data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==":"https://cdn.jsdelivr.net/gh/myreaderx/cdn0@2020_1/404.jpg","https://img2020.cnblogs.com/news/1/202005/1-20200517180637726-1317256928.jpg":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn67@2020_4/2020/08/25/01-33-56-755_ac901ba8c46702ca.webp","https://img2020.cnblogs.com/kb/1/202005/1-20200529220331340-1691781520.jpg":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn99@2020_6/2020/08/25/01-33-58-143_c7c1701d02b09c82.webp","https://img2020.cnblogs.com/kb/1/202005/1-20200529220411993-1186207191.png":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn48@2020_3/2020/08/25/01-34-00-317_cab79dd0af460023.webp"},"publishedOrCreatedDate":1598319223178},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"docker swarm 集群：网络安全 TLS 分析","link":"http://kb.cnblogs.com/page/666541/","description":"<h1 id=\"tls-基础\"><span style=\"font-size: 20px;\"><span style=\"font-size: 14px;\">　　TLS 基础</span></span><p>　　docker swarm 集群间为了保证通信安全，使用TLS进行安全加固。分析TLS安全加固时需要一些网络安全背景知识。</p><p><strong>　　数字签名：</strong>《<a href=\"https://kb.cnblogs.com/page/194742/\" target=\"_blank\">数字证书及CA的扫盲介绍</a>》、《<a href=\"http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html\" target=\"_blank\">数字签名是什么</a>》</p><p><strong>　　CA和证书：</strong>《<a href=\"https://www.jianshu.com/p/e767a4e9252e\" target=\"_blank\">数字证书(Digital Certificate)与数字签名(Digital Signature)</a>》、《<a href=\"https://segmentfault.com/a/1190000002568019\" target=\"_blank\">OpenSSL 与 SSL 数字证书概念贴</a>》、《<a href=\"https://segmentfault.com/a/1190000002569859\" target=\"_blank\">基于OpenSSL自建CA和颁发SSL证书</a>》</p><p><strong>　　SSL/TLS：</strong>《<a href=\"https://segmentfault.com/a/1190000002554673\" target=\"_blank\">SSL/TLS原理详解</a>》、《<a href=\"https://www.cnblogs.com/xiaouisme/p/7156898.html\" target=\"_blank\">grpc tls认证传输</a>》以及很全的关于TLS 证书的文档(英文)《<a href=\"http://www.zytrax.com/tech/survival/ssl.html\" target=\"_blank\">Survival guides - TLS/SSL and SSL (X.509) Certificates</a>》</p><p><strong>　　数字签名过程</strong></p>\n <blockquote>\n  <p>发送人将发送内容使用HASH算法生成一个内容摘要(digest) —&gt; 内容摘要(digest)使用私钥进行加密—&gt;生成数字签名(signature) —&gt; 数字签名(signature)附在信件下面 —&gt; 将信件发送给收件人 —-&gt; 收件人收到信件，并使用发送人的公钥进行解密：证明信件来自于发件人 —&gt; 收件人使用同种Hash算法计算发送内容的摘要(digest)，并和解密得到的digest进行对比：一致则证明信件内容没有别修改</p>\n </blockquote><p>　　一次数字签名涉及到一个哈希函数、发送者的公钥、发送者的私钥（不在签名里）。</p><p>　　数字签名使用私钥对内容摘要用私钥进行加密；加密通信过程中，使用公钥加密，私钥进行解密</p><p><strong>　　数字中心(CA)</strong></p>\n <blockquote>\n  <p>验证公钥的正确性，为公钥做认证，使用自己的私钥为其他公钥和一些信息进行加密； —&gt; 生成”数字证书”Digital Certificate。</p>\n </blockquote><p><strong>　　签名证书</strong></p>\n <blockquote>\n  <p>CA进行对公钥和其他一些内容进行数字签名的信件或消息。</p>\n </blockquote><p><strong>　　证书常用扩展名</strong></p>\n <blockquote>\n  <ol>\n   <li><span style=\"background-color: initial;\">.crt 证书文件 ，可以是DER（二进制）编码的，也可以是PEM（ ASCII (Base64) ）编码的 ，在类unix系统中比较常见</span></li>\n   <li><span style=\"background-color: initial;\">.cer 也是证书 常见于Windows系统 编码类型同样可以是DER或者PEM的，windows 下有工具可以转换crt到cer</span></li>\n   <li><span style=\"background-color: initial;\">.csr 证书签名请求 一般是生成请求以后发送给CA，然后CA会给你签名并发回证书.key 一般公钥或者密钥都会用这种扩展名，可以是DER编码的或者是PEM编码的 查看DER编码的（公钥或者密钥）的文件的命令为 openssl rsa -inform DER -noout -text -in xxx</span></li>\n   <li><span style=\"background-color: initial;\">.key 查看PEM编码的（公钥或者密钥）的文件的命令为 openssl rsa -inform PEM -noout -text -in xxx.key</span></li>\n  </ol>\n </blockquote><h1 id=\"swarmkit-tls加固分析\"><span style=\"font-size: 20px;\"><span style=\"font-size: 14px;\">　　</span></span><span style=\"font-size: 20px;\"><span style=\"font-size: 14px;\">swarmkit TLS加固分析</span></span><h2 id=\"概述\"><span style=\"font-size: 18px;\"><span style=\"font-size: 14px;\">　　概述</span></span><p>　　swarm 集群间个节点通信，先进行身份验证，再进行加密通信。</p><p>　　执行命令：</p><p>&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">docker swarm init --advertise-addr</span>&nbsp;</p><p>　　在 ${docker-root}/ /swarm/certificates/ 目录下生成四个文件</p>\n   <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n    <span style=\"color: #000000;\">[root@localhost certificates]# ls<br />swarm</span>-node.crt swarm-node.key swarm-root-ca.crt swarm-root-ca.key\n   </div><p>　　文件说明：</p><p><strong>　　swarm-root-ca.crt：</strong>CA的自签名证书（执行docker swarm init 节点会启动CA(证书中心)线程，为其他节点颁发签名证书）；</p><p><strong>　　swarm-root-ca.key：</strong>CA的私钥；</p><p><strong>　　</strong><strong>swarm-node.crt：</strong>这个文件不是一个证书而是一个证书集合，包含：当前节点证书和证书中心CA的证书;包含CA的证书的目的是为了;</p><p><strong>　　swarm-node.key：</strong>当前节点的私钥；</p><p>　　docker swarm (LINUX下)的证书使用pem格式，查看证书信息</p>\n   <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n    [root@localhost certificates]# openssl x509 -\n    <span style=\"color: #0000ff;\">in</span> swarm-node.crt -inform pem -noout -\n    <span style=\"color: #000000;\">text<br />Certificate:<br />Data:<br />Version: </span>\n    <span style=\"color: #800080;\">3</span> (\n    <span style=\"color: #800080;\">0x2</span>\n    <span style=\"color: #000000;\">)<br />Serial Number:<br /></span>\n    <span style=\"color: #800080;\">24</span>:\n    <span style=\"color: #800080;\">45</span>:\n    <span style=\"color: #800080;\">68</span>:8a:\n    <span style=\"color: #800080;\">07</span>:b7:e2:e1:2c:\n    <span style=\"color: #800080;\">51</span>:c0:be:\n    <span style=\"color: #800080;\">43</span>:da:1f:\n    <span style=\"color: #800080;\">54</span>:fe:\n    <span style=\"color: #800080;\">09</span>:4e:\n    <span style=\"color: #800080;\">47</span>\n    <span style=\"color: #000000;\"><br />Signature Algorithm: ecdsa</span>-with-\n    <span style=\"color: #000000;\">SHA256<br />Issuer: CN</span>=swarm-ca \n    <span style=\"color: #008000;\">//</span>\n    <span style=\"color: #008000;\">证书颁发结构</span>\n    <br />\n    <span style=\"color: #000000;\">Validity<br />Not Before: Feb </span>\n    <span style=\"color: #800080;\">11</span> \n    <span style=\"color: #800080;\">00</span>:\n    <span style=\"color: #800080;\">24</span>:\n    <span style=\"color: #800080;\">00</span> \n    <span style=\"color: #800080;\">2018</span>\n    <span style=\"color: #000000;\"> GMT<br />Not After : May </span>\n    <span style=\"color: #800080;\">12</span> \n    <span style=\"color: #800080;\">01</span>:\n    <span style=\"color: #800080;\">24</span>:\n    <span style=\"color: #800080;\">00</span> \n    <span style=\"color: #800080;\">2018</span>\n    <span style=\"color: #000000;\"> GMT<br />Subject: O</span>=cvp2afdvt625g5ddhds5t9ldq, OU=swarm-manager, CN=83lp2qgjndo09mgpf96k4jkom \n    <span style=\"color: #008000;\">//</span>\n    <span style=\"color: #008000;\">拥有者信息</span>\n    <br />\n    <span style=\"color: #000000;\">Subject Public Key Info:<br />Public Key Algorithm: id</span>-\n    <span style=\"color: #000000;\">ecPublicKey<br />Public</span>-Key: (\n    <span style=\"color: #800080;\">256</span>\n    <span style=\"color: #000000;\"> bit)<br />pub: <br /></span>\n    <span style=\"color: #800080;\">04</span>:9e:\n    <span style=\"color: #800080;\">27</span>:3c:\n    <span style=\"color: #800080;\">81</span>:2c:ea:\n    <span style=\"color: #800080;\">99</span>:f4:0c:\n    <span style=\"color: #800080;\">45</span>:c8:\n    <span style=\"color: #800080;\">96</span>\n    <span style=\"color: #000000;\">:a4:7d:<br /></span>\n    <span style=\"color: #800080;\">94</span>:5f:\n    <span style=\"color: #800080;\">58</span>:\n    <span style=\"color: #800080;\">14</span>:a9:\n    <span style=\"color: #800080;\">98</span>:\n    <span style=\"color: #800080;\">61</span>:a3:\n    <span style=\"color: #800080;\">31</span>:0a:ab:\n    <span style=\"color: #800080;\">16</span>:b5:7c:\n    <span style=\"color: #800080;\">31</span>\n    <span style=\"color: #000000;\">:<br /></span>\n    <span style=\"color: #800080;\">31</span>:a1:\n    <span style=\"color: #800080;\">57</span>:\n    <span style=\"color: #800080;\">57</span>:\n    <span style=\"color: #800080;\">60</span>:\n    <span style=\"color: #800080;\">47</span>:\n    <span style=\"color: #800080;\">71</span>:\n    <span style=\"color: #800080;\">77</span>:\n    <span style=\"color: #800080;\">64</span>:e6:\n    <span style=\"color: #800080;\">99</span>:\n    <span style=\"color: #800080;\">53</span>:\n    <span style=\"color: #800080;\">25</span>:\n    <span style=\"color: #800080;\">63</span>:\n    <span style=\"color: #800080;\">02</span>\n    <span style=\"color: #000000;\">:<br />c0:b7:7f:1a:eb:</span>\n    <span style=\"color: #800080;\">78</span>:\n    <span style=\"color: #800080;\">92</span>:9b:4b:\n    <span style=\"color: #800080;\">94</span>:a8:\n    <span style=\"color: #800080;\">50</span>\n    <span style=\"color: #000000;\">:a2:f5:c2:<br />8a:1b:</span>\n    <span style=\"color: #800080;\">81</span>:d1:\n    <span style=\"color: #800080;\">77</span>\n    <span style=\"color: #000000;\"><br />ASN1 OID: prime256v1</span>\n   </div><p>　　由上信息，我们可以看出签名证书中保护多种信息，比如证书持有者、证书颁发者、证书的公钥的散列值等，具体证书格式和内容参考文章《OpenSSL 与 SSL 数字证书概念贴》；</p><p>　　一个swarm证书包含内容</p>\n   <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n    <span style=\"color: #008000;\">//</span>\n    <span style=\"color: #008000;\">issueRenewCertificate 函数</span>\n    <br />\n    <span style=\"color: #000000;\">CSR: csr,<br />CN: node.ID,<br />Role: node.Spec.Role,<br />Status: api.IssuanceStatus{<br />State: api.IssuanceStateRenew,}</span>\n   </div><p>　　node.ID在创建证书前被&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">nodeID = identity.NewID()</span>&nbsp;创建并被包含在证书里面，所以docker swarm 集群里节点的nodeID是由leader节点创建。</p><p>　　docker swarm .key文件保留着当前节点的私钥，查看私钥</p>\n   <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n    [root@localhost certificates]# cat swarm-\n    <span style=\"color: #000000;\">node.key <br /></span>-----BEGIN EC PRIVATE KEY-----\n    <span style=\"color: #000000;\"><br />MHcCAQEEIEyyW3De4ix3KOdfv</span>/\n    <span style=\"color: #000000;\">DtxwtvykdTT9Wla7uUxlus4DjEoAoGCCqGSM49<br />AwEHoUQDQgAEnic8gSzqmfQMRciWpH2UX1gUqZhhozEKqxa1fDExoVdXYEdxd2Tm<br />mVMlYwLAt38a63iSm0uUqFCi9cKKG4HRdw</span>==\n    <br />-----END EC PRIVATE KEY-----\n   </div><p>　　docker 加入swarm 集群，执行命令：</p><p>&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">docker swarm join --token ${token-<span style=\"color: #0000ff;\">string</span>} host-ip:port</span>&nbsp;</p><p>　　命令执行成功后，在当前节点的 ${docker-root}/ /swarm/certificates/ 目录下出现三个文件</p>\n   <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n    <span style=\"color: #000000;\">[root@localhost certificates]# ls<br />swarm</span>-node.crt swarm-node.key swarm-root-ca.crt\n   </div><p>　　文件说明：</p><p>　　<strong>swarm-root-ca.crt：</strong>从执行swarm init命令的节点下载的CA证书文件，使用来验证其他节点的签名证书的完整性、安全性</p><p><strong>　　swarm-node.key：</strong>当前节点的x509私钥</p><p><strong>　　swarm-node.crt：</strong>当前节点的公钥签名证书，颁发机构为 swarm-root-ca -→ 执行swarm init 的节点</p><h2 id=\"docker-swarm-certificates-生成\"><span style=\"font-size: 14px;\">　　docker swarm certificates 生成</span><p><strong><span style=\"font-size: 14px;\">　　执行<code>docker swarm init</code>&nbsp;的节点证书</span></strong></p><h4 id=\"swarm-root-cacrt-swarm-root-cakey\">　　<span style=\"font-size: 14px;\">swarm-root-ca.crt swarm-root-ca.key</span><p>　　证书中心(CA)的自签名证书文件，由leader节点生成。</p><p>　　生成过程：</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705203342272-1013989301.png\" alt=\"\" /></p><p>　　1. 执行swarm init 时，会在leader节点启动ca.server协程，响应其他节点的证书请求，颁发证书；</p><p>　　2. 若不适用外部CA，生成的swarm-root-ca.key会保留在本地，而swarm-root-ca.crt会分发给其他节点（其他节点join的时候），所以集群的每个node节点上的swarm-root-ca.crt都是一样的；</p><p><strong>　　swarm-node.crt swarm-node.key</strong></p><p>　　生成流程：</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705203505811-72849174.png\" alt=\"\" /></p><h3 id=\"执行swarm-join-节点证书\"><span style=\"font-size: 18px;\"><span style=\"font-size: 14px;\">　　执行swarm join 节点证书</span></span><p><strong>　　swarm-root-ca.crt</strong></p><p>　　swarm-root-ca.crt文件不是当前节点生成的，从CA.server下载（默认leader节点会启动CA.server进程服务）。由于是第一次连接，没有TLS安全机制进行检测，为了保证根CA证书的安全、完整性，使用 JoinToken 散列验证证书；</p><p><strong>　　swarm-node.crt swarm-node.key</strong></p><p>　　这两个证书文件和leader节点的同名的两个证书生成过程类似，只不过此节点的证书请求CSR通过TLS加密通道发送个leader节点（通信前，会验证leader节点的身份），由leader节点的 Ca.server 使用私钥（swarm-root-ca.key）签名生成签名证书，再有leader节点发送给新加入节点；</p><h2 id=\"swarm-tls安全加固源码分析\"><span style=\"font-size: 20px;\"><span style=\"font-size: 14px;\">　　swarm TLS安全加固源码分析</span></span><h3 id=\"swarm-jointoken源码分析\"><span style=\"font-size: 18px;\"><span style=\"font-size: 14px;\">　　swarm JoinToken源码分析</span></span><h4 id=\"swarm-jointoken产生\">　　Swarm JoinToken产生<p>　　JoinToken产生调用链（JoinToken由Leader产生）</p>\n         <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n          /manager/\n          <span style=\"color: #000000;\">manager.go: Run<br /></span>/ca/\n          <span style=\"color: #000000;\">certificates.go: GenerateJoinToken<br />JoinToken查询：<br />docker swarm join</span>-token work/manager\n         </div><h4 id=\"jointoken使用\">　　JoinToken使用<p>　　当我们将一个节点加入一个集群时，需执行命令：</p><p>&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">docker swarm join --token ${token-<span style=\"color: #0000ff;\">string</span>} host-ip:port</span>&nbsp;</p><p>　　swarm token的作用：在加入集群前，当前节点没有swarm集群的根证书中心(root-ca)的证书，无法根据TLS安全认证验证数据的root-ca的证书完整、安全性，token的作用就是使用散列来验证根CA证书的完整、安全性；</p>\n          <blockquote>\n           <p>token-string -&gt; Digest(split(token)[2]) -&gt; digest.NewDigestVerifier() 获取verifer算法：获取相应的hash算法；</p>\n          </blockquote>\n          <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n           SHA256 Algorithm = \n           <span style=\"color: #800000;\">\"</span>\n           <span style=\"color: #800000;\">sha256</span>\n           <span style=\"color: #800000;\">\"</span> \n           <span style=\"color: #008000;\">//</span>\n           <span style=\"color: #008000;\"> sha256 with hex encoding</span>\n           <br />SHA384 Algorithm = \n           <span style=\"color: #800000;\">\"</span>\n           <span style=\"color: #800000;\">sha384</span>\n           <span style=\"color: #800000;\">\"</span> \n           <span style=\"color: #008000;\">//</span>\n           <span style=\"color: #008000;\"> sha384 with hex encoding</span>\n           <br />SHA512 Algorithm = \n           <span style=\"color: #800000;\">\"</span>\n           <span style=\"color: #800000;\">sha512</span>\n           <span style=\"color: #800000;\">\"</span> \n           <span style=\"color: #008000;\">//</span>\n           <span style=\"color: #008000;\"> sha512 with hex encoding</span>\n          </div><p>　　根据相应的 hash 算法，获取token中的hash值于证书从新计算出的值进行对比验证。</p><p>　　参考代码：&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">ca/certificates.go GetRemoteCA</span>&nbsp;函数</p><h3 id=\"ca-server颁发证书流程分析\"><span style=\"font-size: 18px;\"><span style=\"font-size: 14px;\">　　CA server颁发证书流程分析</span></span><h4 id=\"client和ca-server间通信\">　　client和CA server间通信<p>　　实用protobuf实现客户端和服务端通信，CA相关protobuf定义文件：/swarmkit/api/ca.proto protoc生成文件：ca.pb.go ；</p><h4 id=\"ca-server处理-client端证书请求\">　　CA server处理 client端证书请求<p>　　数据流：</p>\n             <blockquote>\n              <p>底层grpc server收到来自客户端的protobuf格式的序列化流 -→ ca.pb.go：NodeCAServer -→ api.(*authenticatedWrapperNodeCAServer).IssueNodeCertificate -→ ca.(*Server).IssueNodeCertificate</p>\n             </blockquote><p>　　帖上整个调用链堆栈</p>\n             <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n              Feb \n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: github.com/docker/swarmkit/ca.(*Server).IssueNodeCertificate(\n              <span style=\"color: #800080;\">0xc42112a000</span>, \n              <span style=\"color: #800080;\">0x20fde60</span>, \n              <span style=\"color: #800080;\">0xc4217d3bc0</span>, \n              <span style=\"color: #800080;\">0xc4217d3c20</span>, \n              <span style=\"color: #800080;\">0x0</span>, \n              <span style=\"color: #800080;\">0x0</span>, \n              <span style=\"color: #800080;\">0x0</span>\n              <span style=\"color: #000000;\">)<br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/ca/server.go:\n              <span style=\"color: #800080;\">186</span> +\n              <span style=\"color: #800080;\">0x409</span>\n              <span style=\"color: #000000;\"><br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: github.com/docker/swarmkit/api.(*authenticatedWrapperNodeCAServer).IssueNodeCertificate(\n              <span style=\"color: #800080;\">0xc421713da0</span>, \n              <span style=\"color: #800080;\">0x20fde60</span>, \n              <span style=\"color: #800080;\">0xc4217d3bc0</span>, \n              <span style=\"color: #800080;\">0xc4217d3c20</span>, \n              <span style=\"color: #800080;\">0x421137</span>, \n              <span style=\"color: #800080;\">0x1550200</span>, \n              <span style=\"color: #800080;\">0x155ab80</span>\n              <span style=\"color: #000000;\">)<br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/api/ca.pb.go:\n              <span style=\"color: #800080;\">131</span> +\n              <span style=\"color: #800080;\">0x51</span>\n              <span style=\"color: #000000;\"><br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: github.com/docker/swarmkit/api.(*raftProxyNodeCAServer).IssueNodeCertificate(\n              <span style=\"color: #800080;\">0xc42112a140</span>, \n              <span style=\"color: #800080;\">0x20fde60</span>, \n              <span style=\"color: #800080;\">0xc4217d3bc0</span>, \n              <span style=\"color: #800080;\">0xc4217d3c20</span>, \n              <span style=\"color: #800080;\">0x0</span>, \n              <span style=\"color: #800080;\">0x0</span>, \n              <span style=\"color: #800080;\">0x0</span>\n              <span style=\"color: #000000;\">)<br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/api/ca.pb.go:\n              <span style=\"color: #800080;\">791</span> +\n              <span style=\"color: #800080;\">0x9f</span>\n              <span style=\"color: #000000;\"><br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: github.com/docker/swarmkit/api._NodeCA_IssueNodeCertificate_Handler(\n              <span style=\"color: #800080;\">0x155ab80</span>, \n              <span style=\"color: #800080;\">0xc42112a140</span>, \n              <span style=\"color: #800080;\">0x20fde60</span>, \n              <span style=\"color: #800080;\">0xc4217d3bc0</span>, \n              <span style=\"color: #800080;\">0xc42158a440</span>, \n              <span style=\"color: #800080;\">0x0</span>, \n              <span style=\"color: #800080;\">0x0</span>, \n              <span style=\"color: #800080;\">0xc420a2268c</span>, \n              <span style=\"color: #800080;\">0x10</span>, \n              <span style=\"color: #800080;\">0x10</span>\n              <span style=\"color: #000000;\">)<br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/api/ca.pb.go:\n              <span style=\"color: #800080;\">427</span> +\n              <span style=\"color: #800080;\">0x27d</span>\n              <span style=\"color: #000000;\"><br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: google.golang.org/grpc.(*Server).processUnaryRPC(\n              <span style=\"color: #800080;\">0xc4217d6a20</span>, \n              <span style=\"color: #800080;\">0x2101540</span>, \n              <span style=\"color: #800080;\">0xc4210f4090</span>, \n              <span style=\"color: #800080;\">0xc421771180</span>, \n              <span style=\"color: #800080;\">0xc421713e40</span>, \n              <span style=\"color: #800080;\">0x20c9e00</span>, \n              <span style=\"color: #800080;\">0xc4217d3b90</span>, \n              <span style=\"color: #800080;\">0x0</span>, \n              <span style=\"color: #800080;\">0x0</span>\n              <span style=\"color: #000000;\">)<br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/google.golang.org/grpc/server.go:\n              <span style=\"color: #800080;\">522</span> +\n              <span style=\"color: #800080;\">0xa14</span>\n              <span style=\"color: #000000;\"><br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: google.golang.org/grpc.(*Server).handleStream(\n              <span style=\"color: #800080;\">0xc4217d6a20</span>, \n              <span style=\"color: #800080;\">0x2101540</span>, \n              <span style=\"color: #800080;\">0xc4210f4090</span>, \n              <span style=\"color: #800080;\">0xc421771180</span>, \n              <span style=\"color: #800080;\">0xc4217d3b90</span>\n              <span style=\"color: #000000;\">)<br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/google.golang.org/grpc/server.go:\n              <span style=\"color: #800080;\">682</span> +\n              <span style=\"color: #800080;\">0x6ad</span>\n              <span style=\"color: #000000;\"><br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: google.golang.org/grpc.(*Server).serveStreams.func1.\n              <span style=\"color: #800080;\">1</span>(\n              <span style=\"color: #800080;\">0xc42186b0a0</span>, \n              <span style=\"color: #800080;\">0xc4217d6a20</span>, \n              <span style=\"color: #800080;\">0x2101540</span>, \n              <span style=\"color: #800080;\">0xc4210f4090</span>, \n              <span style=\"color: #800080;\">0xc421771180</span>\n              <span style=\"color: #000000;\">)<br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/google.golang.org/grpc/server.go:\n              <span style=\"color: #800080;\">348</span> +\n              <span style=\"color: #800080;\">0xab</span>\n              <span style=\"color: #000000;\"><br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: created by google.golang.org/grpc.(*\n              <span style=\"color: #000000;\">Server).serveStreams.func1<br />Feb </span>\n              <span style=\"color: #800080;\">13</span> \n              <span style=\"color: #800080;\">21</span>:\n              <span style=\"color: #800080;\">33</span>:\n              <span style=\"color: #800080;\">52</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/google.golang.org/grpc/server.go:\n              <span style=\"color: #800080;\">349</span> +\n              <span style=\"color: #800080;\">0xa3</span>\n             </div><p>　　CA server 在 /swarmkit/ca/server.go 的 IssueNodeCertificate 函数中真正处理证书请求</p><p>　　IssueNodeCertificate 函数：</p><p>　　1. 查看申请节点是否为集群中节点，并做相应处理</p><p>　　2. 若是新加入节点，为新节点创建NodeId等信息，并生成cert证书</p>\n             <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n              <span style=\"color: #008000;\">//</span>\n              <span style=\"color: #008000;\">IssueNodeCertificate 函数片段</span>\n              <br />\n              <span style=\"color: #000000;\">......<br />nodeID </span>=\n              <span style=\"color: #000000;\"> identity.NewID()<br /><br /></span>\n              <span style=\"color: #008000;\">//</span>\n              <span style=\"color: #008000;\"> Create a new node</span>\n              <br />err :=\n              <span style=\"color: #000000;\"> s.store.Update(func(tx store.Tx) error {<br /> node :</span>= &amp;\n              <span style=\"color: #000000;\">api.Node {<br /> ID: nodeID,<br /> Certificate: api.Certificate {<br /> CSR: request.CSR,<br /> CN: nodeID,<br /> Role: role,<br /> Status: api.IssuanceStatus {<br /> State: api.IssuanceStatePending,<br /> },<br /> },<br /> Spec: api.NodeSpec{<br /> Role: role,<br /> Membership: api.NodeMembershipAccepted,<br /> },<br /> }<br /> </span>\n              <span style=\"color: #0000ff;\">return</span>\n              <span style=\"color: #000000;\"> store.CreateNode(tx, node)<br />})<br /><br />...</span>\n             </div><p>　　创建证书时，将证书状态置为api.IssuanceStatePending，并调用store.CreateNode创建节点数据库信息，创建完成后产生state.EventCreateNode事件，到现在证书还没有CA签名，当manager被选举为leader时，会创建CA server服务协程，为其他节点开启CA签名服务。（具体代码参见manager.go run函数）</p><p>　　<span style=\"font-size: 14px;\">CA server 主要服务代码：</span></p>\n             <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n              <span style=\"color: #008000;\">//</span>\n              <span style=\"color: #008000;\">ca/server.go run</span>\n              <br />\n              <span style=\"color: #000000;\">...<br /></span>\n              <span style=\"color: #0000ff;\">for</span>\n              <span style=\"color: #000000;\"> {<br /> </span>\n              <span style=\"color: #0000ff;\">select</span>\n              <span style=\"color: #000000;\"> {<br /> </span>\n              <span style=\"color: #0000ff;\">case</span> \n              <span style=\"color: #0000ff;\">event</span> := &lt;-\n              <span style=\"color: #000000;\">updates:<br /> </span>\n              <span style=\"color: #0000ff;\">switch</span> v := \n              <span style=\"color: #0000ff;\">event</span>\n              <span style=\"color: #000000;\">.(type) {<br /> </span>\n              <span style=\"color: #0000ff;\">case</span>\n              <span style=\"color: #000000;\"> state.EventCreateNode:<br /> s.evaluateAndSignNodeCert(ctx, v.Node)<br /> </span>\n              <span style=\"color: #0000ff;\">case</span>\n              <span style=\"color: #000000;\"> state.EventUpdateNode:<br /> </span>\n              <span style=\"color: #008000;\">//</span>\n              <span style=\"color: #008000;\"> If this certificate is already at a final state<br /> </span>\n              <span style=\"color: #008000;\">//</span>\n              <span style=\"color: #008000;\"> no need to evaluate and sign it.</span>\n              <br /> \n              <span style=\"color: #0000ff;\">if</span> !\n              <span style=\"color: #000000;\">isFinalState(v.Node.Certificate.Status) {<br /> s.evaluateAndSignNodeCert(ctx, v.Node)<br /> }<br /> </span>\n              <span style=\"color: #0000ff;\">case</span>\n              <span style=\"color: #000000;\"> state.EventUpdateCluster:<br /> s.updateCluster(ctx, v.Cluster)<br /> }<br /> </span>\n              <span style=\"color: #0000ff;\">case</span> &lt;-\n              <span style=\"color: #000000;\">ctx.Done():<br /> </span>\n              <span style=\"color: #0000ff;\">return</span>\n              <span style=\"color: #000000;\"> ctx.Err()<br /> </span>\n              <span style=\"color: #0000ff;\">case</span> &lt;-\n              <span style=\"color: #000000;\">s.ctx.Done():<br /> </span>\n              <span style=\"color: #0000ff;\">return</span>\n              <span style=\"color: #000000;\"> nil<br /> }<br />}</span>\n             </div><p>　　CA server服务检查三个事件：</p><p>&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">state.EventCreateNode</span>&nbsp;&nbsp;&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">state.EventUpdateNode</span>&nbsp;&nbsp;&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">state.EventUpdateCluster</span>&nbsp;</p><p>　　在&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">IssueNodeCertificate</span>&nbsp; 函数，node信息创建完成，发送&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">state.EventCreateNode</span>&nbsp;事件，被CA server检测到，调用evaluateAndSignNodeCert函数完成证书签名；</p><p>　　新节点加入集群证书申请整体流程：</p>\n             <blockquote>\n              <p>CA rpc server 收到新节点CSR（证书请求，保护公钥） -→ 处理请求为新节点生成NODE信息，并附加到证书 -→ CA server检测到新节点的创建，使用根CA的私钥为证书签名；</p>\n             </blockquote><h4 id=\"新节点加入swarm集群时证书申请\">　　新节点加入swarm集群时证书申请<p>　　签名证书申请主要函数ca/certificates.go GetRemoteSignedCertificate，首先看看此函数的调用链</p>\n              <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n               Feb \n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: github.com/docker/swarmkit/ca.GetRemoteSignedCertificate(\n               <span style=\"color: #800080;\">0x20fde60</span>, \n               <span style=\"color: #800080;\">0xc420f5d200</span>, \n               <span style=\"color: #800080;\">0xc4209fd500</span>, \n               <span style=\"color: #800080;\">0x146</span>, \n               <span style=\"color: #800080;\">0x1c0</span>, \n               <span style=\"color: #800080;\">0xc420222ae0</span>, \n               <span style=\"color: #800080;\">0x55</span>, \n               <span style=\"color: #800080;\">0xc420f709f0</span>, \n               <span style=\"color: #800080;\">0xc42016fd40</span>, \n               <span style=\"color: #800080;\">0x0</span>\n               <span style=\"color: #000000;\">, ...)<br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/ca/certificates.go:\n               <span style=\"color: #800080;\">604</span> +\n               <span style=\"color: #800080;\">0x95</span>\n               <span style=\"color: #000000;\"><br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: github.com/docker/swarmkit/ca.(*RootCA).RequestAndSaveNewCertificates(\n               <span style=\"color: #800080;\">0xc420059020</span>, \n               <span style=\"color: #800080;\">0x20fde60</span>, \n               <span style=\"color: #800080;\">0xc420f5d200</span>, \n               <span style=\"color: #800080;\">0xc420f5d3b0</span>, \n               <span style=\"color: #800080;\">0x2e</span>, \n               <span style=\"color: #800080;\">0xc420f5d410</span>, \n               <span style=\"color: #800080;\">0x2e</span>, \n               <span style=\"color: #800080;\">0xc420222ae0</span>, \n               <span style=\"color: #800080;\">0x55</span>, \n               <span style=\"color: #800080;\">0xc42016fd40</span>\n               <span style=\"color: #000000;\">, ...)<br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/ca/certificates.go:\n               <span style=\"color: #800080;\">174</span> +\n               <span style=\"color: #800080;\">0x1d4</span>\n               <span style=\"color: #000000;\"><br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: github.com/docker/swarmkit/ca.LoadOrCreateSecurityConfig(\n               <span style=\"color: #800080;\">0x20fde60</span>, \n               <span style=\"color: #800080;\">0xc420f5d200</span>, \n               <span style=\"color: #800080;\">0xc420192100</span>, \n               <span style=\"color: #800080;\">0x1f</span>, \n               <span style=\"color: #800080;\">0xc420222ae0</span>, \n               <span style=\"color: #800080;\">0x55</span>, \n               <span style=\"color: #800080;\">0x1720611</span>, \n               <span style=\"color: #800080;\">0xd</span>, \n               <span style=\"color: #800080;\">0xc42016fd40</span>, \n               <span style=\"color: #800080;\">0xc420058fc0</span>\n               <span style=\"color: #000000;\">, ...)<br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/ca/config.go:\n               <span style=\"color: #800080;\">270</span> +\n               <span style=\"color: #800080;\">0x80f</span>\n               <span style=\"color: #000000;\"><br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: github.com/docker/swarmkit/agent.(*Node).run(\n               <span style=\"color: #800080;\">0xc420a9de00</span>, \n               <span style=\"color: #800080;\">0x20fdde0</span>, \n               <span style=\"color: #800080;\">0xc42000c668</span>, \n               <span style=\"color: #800080;\">0x0</span>, \n               <span style=\"color: #800080;\">0x0</span>\n               <span style=\"color: #000000;\">)<br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/agent/node.go:\n               <span style=\"color: #800080;\">216</span> +\n               <span style=\"color: #800080;\">0x56a</span>\n               <span style=\"color: #000000;\"><br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: created by github.com/docker/swarmkit/agent.(*\n               <span style=\"color: #000000;\">Node).Start<br />Feb </span>\n               <span style=\"color: #800080;\">14</span> \n               <span style=\"color: #800080;\">15</span>:\n               <span style=\"color: #800080;\">14</span>:\n               <span style=\"color: #800080;\">00</span> localhost dockerd: /root/dockerbuild/BUILD/docker-engine/vendor/src/github.com/docker/swarmkit/agent/node.go:\n               <span style=\"color: #800080;\">158</span> +\n               <span style=\"color: #800080;\">0x3d8</span>\n              </div><p>　　ca.LoadOrCreateSecurityConfig函数首先在本地找签名证书，如果在本地没有签名证书调用RequestAndSaveNewCertificates函数生成、获取证书。调用GetRemoteSignedCertificate函数前，先生成包含公钥的证书请求(CSR)和私钥。</p><p>　　ca/certificates.go GetRemoteSignedCertificate 函数将CSR封装于api.IssueNodeCertificateRequest请求，使用api.NewNodeCAClien(protobuf相关)和Ca.Server通信，并在未超时时间内等待签名证书返回。（具体细节参考GetRemoteSignedCertificate 函数）</p><p><strong>　　docker swarm 节点间MutableTLS认证、通信</strong></p><p>　　在SSL/TSL协议中，有两种认证通信方式：单向认证(TLS)和双向认证(Mutual TLS)，具体协议认证过程参考《<a href=\"https://www.codeproject.com/articles/326574/an-introduction-to-mutual-ssl-authentication\" target=\"_blank\">An Introduction to Mutual SSL Authentication</a>》。docker swarm 集群两节点间需互相验证身份，所以使用Mutual TLS方式认证身份。</p><p>　　docker swarm MTLS认证、通信流图图：</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705204558388-1246973341.png\" alt=\"\" /></p><p>　　SSL/TLS 在TCP/UDP上应用层下，SSL/TLS协议代码被封装于golang的crypto包中，所以只分析在swarm代码中，如何使用MTLS进行加密通信，不涉及SSL/TLS协议代码。</p><p>　　几个验证过程注意：</p><p>　　1. 在新节点建立从CA server获取根CA的自签名证书时，由于没有CA证书无法进行认证，所以这次通信是没有使用TLS认证授权的，下载文件swarm-root-ca.cert使用token散列验证；</p><p>　　2. 新加入节点，向CA server 请求证书，此时新节点没有CA签名证书，无法和server进行双向认证，这个过程使用单向认证 –→ 客户端验证CA server 身份；</p><p>　　3. 上述情况的外，都使用双向认证(MTLS)；</p><p>　　获取根CA证书代码</p>\n              <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">GetRemoteCA</span>\n               <br />insecureCreds := credentials.NewTLS(&amp;tls.Config{InsecureSkipVerify: \n               <span style=\"color: #0000ff;\">true</span>}) \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">不使用TLS验证</span>\n               <br />opts :=\n               <span style=\"color: #000000;\"> []grpc.DialOption {<br /> grpc.WithTransportCredentials(insecureCreds),<br /> grpc.WithBackoffMaxDelay(</span>\n               <span style=\"color: #800080;\">10</span> *\n               <span style=\"color: #000000;\"> time.Second),<br /> grpc.WithPicker(picker)<br />}<br /><br />firstAddr, err :</span>=\n               <span style=\"color: #000000;\"> picker.PickAddr()<br /></span>\n               <span style=\"color: #0000ff;\">if</span> err !=\n               <span style=\"color: #000000;\"> nil {<br /> </span>\n               <span style=\"color: #0000ff;\">return</span>\n               <span style=\"color: #000000;\"> RootCA{}, err<br />}<br /><br />conn, err :</span>= grpc.Dial(firstAddr, opts...)\n              </div><p><strong><span style=\"font-size: 14px;\">　　获取节点签名证书</span></strong></p>\n              <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">GetRemoteSignedCertificate</span>\n               <br />\n               <span style=\"color: #0000ff;\">if</span> creds == nil { \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">请求签名证书时，此为nil</span>\n               <br /> creds = credentials.NewTLS(&amp;tls.Config{ServerName: CARole, RootCAs: rootCAPool})\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">只验证CARole身份</span>\n               <br />\n               <span style=\"color: #000000;\">}<br />opts :</span>=\n               <span style=\"color: #000000;\"> []grpc.DialOption{<br /> grpc.WithTransportCredentials(creds),<br /> grpc.WithBackoffMaxDelay(</span>\n               <span style=\"color: #800080;\">10</span> *\n               <span style=\"color: #000000;\"> time.Second),<br /> grpc.WithPicker(picker)<br />}<br /><br />firstAddr, err :</span>=\n               <span style=\"color: #000000;\"> picker.PickAddr()<br /></span>\n               <span style=\"color: #0000ff;\">if</span> err !=\n               <span style=\"color: #000000;\"> nil {<br /> </span>\n               <span style=\"color: #0000ff;\">return</span>\n               <span style=\"color: #000000;\"> nil, err<br />}<br /><br />conn, err :</span>= grpc.Dial(firstAddr, opts...)\n              </div><p><strong><span style=\"font-size: 14px;\">　　其他情况双向认证</span></strong></p><p>　　LoadOrCreateSecurityConfig函数:</p>\n              <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">LoadOrCreateSecurityConfig</span>\n               <br />clientTLSCreds, serverTLSCreds, err = LoadTLSCreds(rootCA, paths.Node) \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">加载磁盘中证书和私钥</span>\n               <br />\n               <span style=\"color: #0000ff;\">if</span> err != nil { \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">磁盘没有证书包错（一般节点第一次加入或者创建集群时），加载失败</span>\n               <br /> log.Debugf(\n               <span style=\"color: #800000;\">\"</span>\n               <span style=\"color: #800000;\">no valid local TLS credentials found: %v</span>\n               <span style=\"color: #800000;\">\"</span>\n               <span style=\"color: #000000;\">, err)<br /> </span>\n               <span style=\"color: #0000ff;\">var</span>\n               <span style=\"color: #000000;\"> (<br /> tlsKeyPair </span>*\n               <span style=\"color: #000000;\">tls.Certificate<br /> err error<br /> )<br /> </span>\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">Leader节点，自己为自己创建节点信息，并使用为自己创建证书并用CA签名</span>\n               <br /> \n               <span style=\"color: #0000ff;\">if</span> rootCA.CanSign() { \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">Leader节点才可以启动签名证书服务，所以Leader节点此处为真<br /> </span>\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\"> Create a new random ID for this certificate</span>\n               <br /> cn :=\n               <span style=\"color: #000000;\"> identity.NewID()<br /> org :</span>=\n               <span style=\"color: #000000;\"> identity.NewID()<br /> </span>\n               <span style=\"color: #0000ff;\">if</span> nodeInfo !=\n               <span style=\"color: #000000;\"> nil {<br /> nodeInfo </span>&lt;-\n               <span style=\"color: #000000;\"> api.IssueNodeCertificateResponse{<br /> NodeID: cn,<br /> NodeMembership: api.NodeMembershipAccepted,<br /> }<br /> }<br /> tlsKeyPair, err </span>= rootCA.IssueAndSaveNewCertificates(paths.Node, cn, proposedRole, org) \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">创建并签名证书</span>\n               <br /> \n               <span style=\"color: #0000ff;\">if</span> err !=\n               <span style=\"color: #000000;\"> nil {<br /> </span>\n               <span style=\"color: #0000ff;\">return</span>\n               <span style=\"color: #000000;\"> nil, err<br /> }<br />} </span>\n               <span style=\"color: #0000ff;\">else</span> { \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">非Leader节点，创建证书请求并向Leader 或CA 服务请求签名证书<br /> </span>\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\"> There was an error loading our Credentials, let's get a new certificate issued<br /> </span>\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\"> Last argument is nil because at this point we don't have any valid TLS creds</span>\n               <br /> tlsKeyPair, err =\n               <span style=\"color: #000000;\"> rootCA.RequestAndSaveNewCertificates(ctx, paths.Node, token, picker, nil, nodeInfo)<br /> </span>\n               <span style=\"color: #0000ff;\">if</span> err !=\n               <span style=\"color: #000000;\"> nil {<br /> </span>\n               <span style=\"color: #0000ff;\">return</span>\n               <span style=\"color: #000000;\"> nil, err<br /> }<br />}<br /></span>\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\"> Create the Server TLS Credentials for this node. These will not be used by agents.</span>\n               <br /> serverTLSCreds, err = rootCA.NewServerTLSCredentials(tlsKeyPair) \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">客户端TLS连接配置</span>\n               <br /> \n               <span style=\"color: #0000ff;\">if</span> err !=\n               <span style=\"color: #000000;\"> nil {<br /> </span>\n               <span style=\"color: #0000ff;\">return</span>\n               <span style=\"color: #000000;\"> nil, err<br /> }<br /><br /></span>\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\"> Create a TLSConfig to be used when this node connects as a client to another remote node.<br /></span>\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\"> We're using ManagerRole as remote serverName for TLS host verification</span>\n               <br />clientTLSCreds, err = rootCA.NewClientTLSCredentials(tlsKeyPair, ManagerRole) \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">服务端TLS连接配置</span>\n               <br />\n               <span style=\"color: #0000ff;\">if</span> err !=\n               <span style=\"color: #000000;\"> nil {<br /> </span>\n               <span style=\"color: #0000ff;\">return</span>\n               <span style=\"color: #000000;\"> nil, err<br />}<br />log.Debugf(</span>\n               <span style=\"color: #800000;\">\"</span>\n               <span style=\"color: #800000;\">new TLS credentials generated: %s.</span>\n               <span style=\"color: #800000;\">\"</span>\n               <span style=\"color: #000000;\">, paths.Node.Cert)<br />} </span>\n               <span style=\"color: #0000ff;\">else</span>\n               <span style=\"color: #000000;\"> {<br /> </span>\n               <span style=\"color: #0000ff;\">if</span> nodeInfo !=\n               <span style=\"color: #000000;\"> nil {<br /> nodeInfo </span>&lt;-\n               <span style=\"color: #000000;\"> api.IssueNodeCertificateResponse{<br /> NodeID: clientTLSCreds.NodeID(),<br /> NodeMembership: api.NodeMembershipAccepted,<br /> }<br /> }<br /> log.Debugf(</span>\n               <span style=\"color: #800000;\">\"</span>\n               <span style=\"color: #800000;\">loaded local TLS credentials: %s.</span>\n               <span style=\"color: #800000;\">\"</span>\n               <span style=\"color: #000000;\">, paths.Node.Cert)<br />}<br /><br /></span>\n               <span style=\"color: #0000ff;\">return</span> NewSecurityConfig(&amp;rootCA, clientTLSCreds, serverTLSCreds), nil \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">LTS连接配置</span>\n              </div><p>　　LoadOrCreateSecurityConfig函数返回了TLS安全双向认证的连接配置，此后使用安全连接配置进行安全通行；</p><p>　　例如&nbsp;</p>\n              <div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">agent/node.go run函数</span>\n               <br />\n               <span style=\"color: #000000;\">...<br />securityConfig, err :</span>=\n               <span style=\"color: #000000;\"> ca.LoadOrCreateSecurityConfig(ctx, certDir, n.config.JoinToken, ca.ManagerRole, picker.NewPicker(n.remotes), issueResponseChan)<br />...<br />managerErr </span>= n.runManager(ctx, securityConfig, managerReady) \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\"> 使用securityConfig安全配置</span>\n               <br />\n               <span style=\"color: #000000;\">...<br />agentErr </span>= n.runAgent(ctx, db, securityConfig.ClientTLSCreds, agentReady) \n               <span style=\"color: #008000;\">//</span>\n               <span style=\"color: #008000;\">使用securityConfig安全配置</span>\n              </div><p>　　由于manager既要做服务端又要做客户端，所以服务端和客户端的双向安全配置；</p><p>　　NewClientTLSCredentials、NewServerTLSCredentials 底层调用 golang crypto 包里面tls安全认证类。</p></h4></h4></h4></h3></h4></h4></h3></h2></h3></h4></h2></h2></h1></h1>","descriptionType":"html","publishedDate":"Thu, 09 Jul 2020 08:10:14 +0000","feedId":11665,"bgimg":"https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705203342272-1013989301.png","linkMd5":"ae89a1e36d4ff8ae2c5aa8aeb2e1ebfb","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn26@2020_4/2020/08/25/01-33-52-239_a0b5660a2ef72424.webp","destWidth":1456,"destHeight":426,"sourceBytes":40100,"destBytes":93938,"author":"","articleImgCdnMap":{"https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705203342272-1013989301.png":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn26@2020_4/2020/08/25/01-33-52-239_a0b5660a2ef72424.webp","https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705203505811-72849174.png":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn88@2020_4/2020/08/25/01-33-56-143_443a628cc9b67571.webp","https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705204558388-1246973341.png":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn80@2020_5/2020/08/25/01-34-00-352_48bf3b627620c16d.webp"},"publishedOrCreatedDate":1598319223187},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"Nginx 详解：Nginx 是什么? 能干嘛?","link":"http://kb.cnblogs.com/page/661047/","description":"<p><strong><span style=\"font-size: 18px;\">Nginx的产生</span></strong></p>\n<p>　　没有听过Nginx？那么一定听过它的\"同行\"Apache吧！Nginx同Apache一样都是一种WEB服务器。基于REST架构风格，以统一资源描述符(Uniform Resources Identifier)URI或者统一资源定位符(Uniform Resources Locator)URL作为沟通依据，通过HTTP协议提供各种网络服务。</p>\n<p>　　然而，这些服务器在设计之初受到当时环境的局限，例如当时的用户规模，网络带宽，产品特点等局限并且各自的定位和发展都不尽相同。这也使得各个WEB服务器有着各自鲜明的特点。</p>\n<p>　　Apache的发展时期很长，而且是毫无争议的世界第一大服务器。它有着很多优点：稳定、开源、跨平台等等。它出现的时间太长了，它兴起的年代，互联网产业远远比不上现在。所以它被设计为一个重量级的。它不支持高并发的服务器。在Apache上运行数以万计的并发访问，会导致服务器消耗大量内存。操作系统对其进行进程或线程间的切换也消耗了大量的CPU资源，导致HTTP请求的平均响应速度降低。</p>\n<p>　　这些都决定了Apache不可能成为高性能WEB服务器，轻量级高并发服务器Nginx就应运而生了。</p>\n<p>　　俄罗斯的工程师Igor Sysoev，他在为Rambler Media工作期间，使用C语言开发了Nginx。Nginx作为WEB服务器一直为Rambler Media提供出色而又稳定的服务。</p>\n<p>　　然后呢，Igor Sysoev将Nginx代码开源，并且赋予自由软件许可证。</p>\n<p>　　由于：</p>\n<ul>\n <li>Nginx使用基于事件驱动架构，使得其可以支持数以百万级别的TCP连接</li>\n <li>高度的模块化和自由软件许可证使得第三方模块层出不穷（这是个开源的时代啊~）</li>\n <li>Nginx是一个跨平台服务器，可以运行在Linux，Windows，FreeBSD，Solaris，AIX，Mac OS等操作系统上</li>\n <li>这些优秀的设计带来的是极大的稳定性</li>\n</ul>\n<p>　　所以，Nginx火了！</p>\n<p><strong><span style=\"font-size: 18px;\">Nginx的用武之地</span></strong></p>\n<p>　　Nginx是一款自由的、开源的、高性能的HTTP服务器和反向代理服务器；同时也是一个IMAP、POP3、SMTP代理服务器；Nginx可以作为一个HTTP服务器进行网站的发布处理，另外Nginx可以作为反向代理进行负载均衡的实现。</p>\n<p><strong><span style=\"font-size: 16px;\">关于代理</span></strong></p>\n<p>　　说到代理，首先我们要明确一个概念，所谓代理就是一个代表、一个渠道；</p>\n<p>　　此时就涉及到两个角色，一个是被代理角色，一个是目标角色，被代理角色通过这个代理访问目标角色完成一些任务的过程称为代理操作过程；如同生活中的专卖店~客人到adidas专卖店买了一双鞋，这个专卖店就是代理，被代理角色就是adidas厂家，目标角色就是用户。</p>\n<p><strong><span style=\"font-size: 16px;\">正向代理</span></strong></p>\n<p>　　说反向代理之前，我们先看看正向代理，正向代理也是大家最常接触的到的代理模式，我们会从两个方面来说关于正向代理的处理模式，分别从软件方面和生活方面来解释一下什么叫正向代理。</p>\n<p>　　在如今的网络环境下，我们如果由于技术需要要去访问国外的某些网站，此时你会发现位于国外的某网站我们通过浏览器是没有办法访问的，此时大家可能都会用一个操作FQ进行访问，FQ的方式主要是找到一个可以访问国外网站的代理服务器，我们将请求发送给代理服务器，代理服务器去访问国外的网站，然后将访问到的数据传递给我们！</p>\n<p>　　上述这样的代理模式称为正向代理，正向代理最大的特点是客户端非常明确要访问的服务器地址；服务器只清楚请求来自哪个代理服务器，而不清楚来自哪个具体的客户端；正向代理模式屏蔽或者隐藏了真实客户端信息。来看个示意图（我把客户端和正向代理框在一块，同属于一个环境，后面我有介绍）：</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211123717325-1261206014.png\" alt=\"\" /></p>\n<p>　　</p>\n<p>　　客户端必须设置正向代理服务器，当然前提是要知道正向代理服务器的IP地址，还有代理程序的端口。如图。</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211121039404-1910765480.png\" alt=\"\" /></p>\n<p>　　总结来说：正向代理，\"它代理的是客户端，代客户端发出请求\"，是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。</p>\n<p>　　正向代理的用途：<br />　　（1）访问原来无法访问的资源，如Google<br />　　（2） 可以做缓存，加速访问资源<br />　　（3）对客户端访问授权，上网进行认证<br />　　（4）代理可以记录用户访问记录（上网行为管理），对外隐藏用户信息</p>\n<p><strong><span style=\"font-size: 16px;\">反向代理</span></strong></p>\n<p>　　明白了什么是正向代理，我们继续看关于反向代理的处理方式，举例如我大天朝的某宝网站，每天同时连接到网站的访问人数已经爆表，单个服务器远远不能满足人民日益增长的购买欲望了，此时就出现了一个大家耳熟能详的名词：分布式部署；也就是通过部署多台服务器来解决访问人数限制的问题；某宝网站中大部分功能也是直接使用Nginx进行反向代理实现的，并且通过封装Nginx和其他的组件之后起了个高大上的名字：Tengine，有兴趣的童鞋可以访问Tengine的官网查看具体的信息：http://tengine.taobao.org/。那么反向代理具体是通过什么样的方式实现的分布式的集群操作呢，我们先看一个示意图（我把服务器和反向代理框在一块，同属于一个环境，后面我有介绍）：</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406175939873-925019958.png\" alt=\"\" width=\"657\" height=\"288\" /></p>\n<p>　　通过上述的图解大家就可以看清楚了，多个客户端给服务器发送的请求，Nginx服务器接收到之后，按照一定的规则分发给了后端的业务处理服务器进行处理了。此时~请求的来源也就是客户端是明确的，但是请求具体由哪台服务器处理的并不明确了，Nginx扮演的就是一个反向代理角色。</p>\n<p>　　客户端是无感知代理的存在的，反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。因为客户端不需要任何配置就可以访问。</p>\n<p>　　反向代理，\"它代理的是服务端，代服务端接收请求\"，主要用于服务器集群分布式部署的情况下，反向代理隐藏了服务器的信息。</p>\n<p>　　反向代理的作用：<br />　　（1）保证内网的安全，通常将反向代理作为公网访问地址，Web服务器是内网<br />　　（2）负载均衡，通过反向代理服务器来优化网站的负载</p>\n<p><strong>项目场景</strong></p>\n<p>　　通常情况下，我们在实际项目操作时，正向代理和反向代理很有可能会存在在一个应用场景中，正向代理代理客户端的请求去访问目标服务器，目标服务器是一个反向单利服务器，反向代理了多台真实的业务处理服务器。具体的拓扑图如下：</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406180130452-1246060303.png\" alt=\"\" width=\"636\" height=\"275\" /></p>\n<p><strong><span style=\"font-size: 16px;\">二者区别</span></strong></p>\n<p>　　截了一张图来说明正向代理和反向代理二者之间的区别，如图。</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211122806997-940664368.png\" alt=\"\" /></p>\n<p>　　<strong>图解：</strong></p>\n<p>　　在正向代理中，Proxy和Client同属于一个LAN（图中方框内），隐藏了客户端信息；</p>\n<p>　　在反向代理中，Proxy和Server同属于一个LAN（图中方框内），隐藏了服务端信息；</p>\n<p>　　实际上，Proxy在两种代理中做的事情都是替服务器代为收发请求和响应，不过从结构上看正好左右互换了一下，所以把后出现的那种代理方式称为反向代理了。</p>\n<p><strong><span style=\"font-size: 16px;\">负载均衡</span></strong></p>\n<p>　　我们已经明确了所谓代理服务器的概念，那么接下来，Nginx扮演了反向代理服务器的角色，它是以依据什么样的规则进行请求分发的呢？不用的项目应用场景，分发的规则是否可以控制呢？</p>\n<p>　　这里提到的客户端发送的、Nginx反向代理服务器接收到的请求数量，就是我们说的负载量。</p>\n<p>　　请求数量按照一定的规则进行分发到不同的服务器处理的规则，就是一种均衡规则。</p>\n<p>　　所以，将服务器接收到的请求按照规则分发的过程，称为负载均衡。</p>\n<p>　　负载均衡在实际项目操作过程中，有硬件负载均衡和软件负载均衡两种，硬件负载均衡也称为硬负载，如F5负载均衡，相对造价昂贵成本较高，但是数据的稳定性安全性等等有非常好的保障，如中国移动中国联通这样的公司才会选择硬负载进行操作；更多的公司考虑到成本原因，会选择使用软件负载均衡，软件负载均衡是利用现有的技术结合主机硬件实现的一种消息队列分发机制。</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406180405961-333776342.png\" alt=\"\" width=\"641\" height=\"281\" /></p>\n<p>　　Nginx支持的负载均衡调度算法方式如下：</p>\n<ol>\n <li>weight轮询(默认，常用)：接收到的请求按照权重分配到不同的后端服务器，即使在使用过程中，某一台后端服务器宕机，Nginx会自动将该服务器剔除出队列，请求受理情况不会受到任何影响。 这种方式下，可以给不同的后端服务器设置一个权重值(weight)，用于调整不同的服务器上请求的分配率；权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的。</li>\n <li>ip_hash（常用）：每个请求按照发起客户端的ip的hash结果进行匹配，这样的算法下一个固定ip地址的客户端总会访问到同一个后端服务器，这也在一定程度上解决了集群部署环境下session共享的问题。</li>\n <li>fair：智能调整调度算法，动态的根据后端服务器的请求处理到响应的时间进行均衡分配，响应时间短处理效率高的服务器分配到请求的概率高，响应时间长处理效率低的服务器分配到的请求少；结合了前两者的优点的一种调度算法。但是需要注意的是Nginx默认不支持fair算法，如果要使用这种调度算法，请安装upstream_fair模块。</li>\n <li>url_hash：按照访问的url的hash结果分配请求，每个请求的url会指向后端固定的某个服务器，可以在Nginx作为静态服务器的情况下提高缓存效率。同样要注意Nginx默认不支持这种调度算法，要使用的话需要安装Nginx的hash软件包。</li>\n</ol>\n<p><strong>&nbsp;<span style=\"font-size: 18px;\">几种常用web服务器对比</span></strong></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2020.cnblogs.com/kb/1621547/202005/1621547-20200502201958036-357435668.png\" alt=\"\" /></p>","descriptionType":"html","publishedDate":"Sun, 03 May 2020 03:00:38 +0000","feedId":11665,"bgimg":"https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211123717325-1261206014.png","linkMd5":"fd4597d220dfcebef9ff69d32bf14aa0","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn11@2020_1/2020/08/25/01-33-51-632_42b618459ce7c6d9.webp","destWidth":1240,"destHeight":420,"sourceBytes":199913,"destBytes":21274,"author":"","articleImgCdnMap":{"https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211123717325-1261206014.png":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn11@2020_1/2020/08/25/01-33-51-632_42b618459ce7c6d9.webp","https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211121039404-1910765480.png":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn56@2020_2/2020/08/25/01-34-00-536_a75960a08cfa8dec.webp","https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406175939873-925019958.png":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn31@2020_3/2020/08/25/01-33-59-923_d4a664be95cb980d.webp","https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406180130452-1246060303.png":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn88@2020_3/2020/08/25/01-33-57-158_afc2fddf34bd8f8b.webp","https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211122806997-940664368.png":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn51@2020_1/2020/08/25/01-34-00-148_dae60d704c3bb3c4.webp","https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406180405961-333776342.png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn15@2020_3/2020/08/25/01-34-00-118_93f5639b2900b3f9.webp","https://img2020.cnblogs.com/kb/1621547/202005/1621547-20200502201958036-357435668.png":"https://cdn.jsdelivr.net/gh/myreaderx/cdn36@2020_2/2020/08/25/01-33-58-888_9af831aa167794cb.webp"},"publishedOrCreatedDate":1598319223178},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"60年前美国军方的这个编程原则，造就了多少伟大的框架","link":"http://kb.cnblogs.com/page/654057/","description":"<p>　　大约在60年前，美国军方的软件开发开始遵循一个原则，叫KISS原则。他们希望武器系统中所用的每个指令都是极其简单和傻瓜式的。这个原则后来在编程领域中被广泛采用，如今好多著名的开源框架都是遵循这一原则来开发，并最终取得了巨大的成功。</p>\n<p>　　在上一文中《<a href=\"http://mp.weixin.qq.com/s?__biz=MzA5MzQ2NTY0OA==&amp;mid=2650798277&amp;idx=1&amp;sn=97afe157dc1627713b729d9ef058b477&amp;chksm=8856259abf21ac8c9744a0c3a0b3e2b2e73d9d26a19cbbca2b57eb4237470533e29bcbec3ddc&amp;scene=21#wechat_redirect\" target=\"_blank\" data-itemshowtype=\"0\" data-linktype=\"2\">Apache的架构师们遵循的30条设计原则</a>》，第一个原则便是KISS原则，几年前简单的了解过这个原则，前几日又翻出来，仔细查看后，倍感震惊，这篇原文可以说道破了编程的天机。以下原文的翻译：</p>\n<p><strong>　　KISS表示的是什么？</strong></p>\n<p>　　KISS 是Keep It Stupid Simple 或 Keep It Simple,Stupid的缩写。</p>\n<p><strong>　　KISS的含义</strong></p>\n<p>　　该原则在我的多年的软件工程生涯中取得关键、巨大的成功。当今的软件工程师和开发者们有个共同的问题，那就是他们总是慢慢地使得问题复杂化。正确的做法应该是当开发者遇到一个问题后，把问题拆分成一个个能够明白的小块，然后进入编码阶段。但我会说，10个开发者中有8个或9个都没有把问题分解成足够小或可以理解的足够小的部分。这就导致了即使是一个非常简单的问题最后也变成了非常复杂的实现，另外一个副作用就是意大利面代码，在BASIC里只是一个goto语句的事情，在Java中却需要500到1000行代码，每个方法都有几百行代码。</p>\n<p>　　你需要先想好问题的解决步骤一共分为几步，然后再进入编码。而不是拿到需求后，就开始一边写代码一边去满足需求。这样做的好处就是你的代码会变的足够容易理解和足够清晰。</p>\n<p><strong>　　我们能从KISS中获取到什么好处？</strong></p>\n<ol class=\"list-paddingleft-2\">\n <li><p>你可以更好地解决更多问题。</p></li>\n <li><p>你将可以通过很少的几行代码去解决复杂的问题。</p></li>\n <li><p>你将可以产出高质量的代码。</p></li>\n <li><p>你将可以构建更大更易维护的系统。</p></li>\n <li><p>当新的需求来了后，你的代码将会更加的灵活，易于扩展、易于修改和重构。</p></li>\n <li><p>你将完成比你想象得更多的事情。</p></li>\n <li><p>你将能够工作在一个大型开发团队和大型项目中，因为所有的代码都是stupid simple。</p></li>\n</ol>\n<p><strong>　　我如何把KISS原则用到我的工作中？</strong></p>\n<p>　　这里有几个简单的步骤可供执行，但有一定挑战。就像说起来的那么简单，keep it simple，主要是需要耐心，更多的靠你自己。</p>\n<ul class=\"list-paddingleft-2\">\n <li><p>要谦虚，不要认为自己是个天才，这是你第一个误解。只有谦虚了，你才能真正达到超级天才的水平，即使不行，who cares！你的代码那么stupid simple，所以你不需要是个天才！</p></li>\n <li><p>将你的任务分解为4-12小时的子任务。</p></li>\n <li><p>把你的问题拆分成多个小问题。每个问题用一个或者很少的几个类来解决掉。</p></li>\n <li><p><strong>保持你的方法足够小，每个方法永远不要超过30-40行代码</strong>。每个方法都应该只处理一个小小的问题，不要搞太多uses case进去。如果你的方法中有多个分支，尝试把他们拆分成多个小的方法。这样不仅容易阅读和维护，找bug也更快。慢慢的你将学会爱。</p></li>\n <li><p>让你的类也小点，原则和上面的方法是一样的。</p></li>\n <li><p>先解决问题，然后开始编码。不要一边编码，一边解决问题。这样做也没什么错，但你有能力提前把事情切分成多个小的块，然后开始编码可能是比较好的。但也请你不要害怕一遍遍重构你的代码。另外行数还不是为了衡量质量的标准，只是有个基本的尺子而已。</p></li>\n <li><p>不要害怕干掉代码。重构和重做是两个非常重要的方面。如果你遵循上面的建议，重写代码的数量将会最小化，如果你不遵循，那么代码很可能会被重写。</p></li>\n <li><p>其他的任何场景，都请你尝试尽可能的简单，simple，这也是最难的一步，但一旦你拥有了它，你再回头看，就会说，之前的事情就是一坨屎。</p></li>\n</ul>\n<p><strong>　　有没有一些KISS原则的例子</strong></p>\n<p>　　太多了，以后我会把一些不错的案例po到这里。但现在我想先给你一些我的观点和想法：</p>\n<p>　　世界上的很多伟大的算法几乎总是有很少的数行代码。当我们去看这些的时候，会发现很容易理解。这些算法发明者，他们把问题拆分，直到容易理解的程度，然后去实现它。</p>\n<blockquote data-type=\"2\" data-url=\"\" data-author-name=\"\" data-content-utf8-length=\"70\" data-source-title=\"\">\n Many great problem solvers were not great coders, but yet they produced great code!\n</blockquote>\n<p><strong>　　许多伟大的问题解决者（problem solver）都曾不是伟大的程序员，但他们却产出了伟大的代码！</strong></p>\n<p><strong>　　KISS只能用于java代码？</strong></p>\n<p>　　显然不是，它可以用于很多编程语言，并且甚至可用于你生活的其他的领域。当然不能用于你的感情、爱，更重要的是，不能用在你的婚姻上。</p>\n<p>　　相关阅读：</p>\n<p>　　<a href=\"http://mp.weixin.qq.com/s?__biz=MzA5MzQ2NTY0OA==&amp;mid=2650798277&amp;idx=1&amp;sn=97afe157dc1627713b729d9ef058b477&amp;chksm=8856259abf21ac8c9744a0c3a0b3e2b2e73d9d26a19cbbca2b57eb4237470533e29bcbec3ddc&amp;scene=21#wechat_redirect\" target=\"_blank\" data-itemshowtype=\"0\" data-linktype=\"2\">Apache的架构师们遵循的30条设计原则</a></p>\n<p>　　<a href=\"http://mp.weixin.qq.com/s?__biz=MzA5MzQ2NTY0OA==&amp;mid=2650798269&amp;idx=1&amp;sn=d1d2d5114674ae6653457f992d2855ae&amp;chksm=885625e2bf21acf4181a7579888be4a697e9fc69b042e750644da55c8b5b47e6601ecdda516c&amp;scene=21#wechat_redirect\" target=\"_blank\" data-itemshowtype=\"0\" data-linktype=\"2\">如何写一个清晰明了的bug</a></p>","descriptionType":"html","publishedDate":"Thu, 23 Jan 2020 11:52:25 +0000","feedId":11665,"bgimg":"","linkMd5":"c7961e0fe8496b23a62da1a485e9b6d9","bgimgJsdelivr":"","metaImg":"","author":"","publishedOrCreatedDate":1598319223178},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"如何高效的学习技术","link":"http://kb.cnblogs.com/page/651963/","description":"<p>　　我们相信努力学习一定会有收获，但是方法不当，既让人身心疲惫，也没有切实的回报。高中时代，我的同桌是个漂亮女同学。她的物理成绩很差，虽然她非常勤奋的学习，但成绩总是不理想。为了巩固纯洁的同学关系，我亲密无间地辅导她的物理，发现她不知道题目考什么。我们的教科书与试题都围绕着考试大纲展开，看到一道题，应该先想想它在考哪些定理和公式的运用。</p>\n<p>  不少朋友每天都阅读技术文章，但是第二天就忘干净了。工作中领导和同事都认可你的沟通和技术能力，但是跳槽面试却屡屡碰壁。面试官问技术方案，明明心里清楚，用嘴说出来却前言不搭后语。面试官再问底层算法，你说看过但是忘记了。他不在乎你看没看过，答不上就是零分。正如男女相亲，男方谈吐潇洒才能吸引姑娘。可是男方紧张了，平时挺能说，关键时候却支支吾吾，姑娘必然认为他不行。人生充满了许多考试，有形的和无形的，每次考试的机会只有一次。</p>\n<p>  工作五年十年后，别人成了架构师，自己还在基层打滚，原因是什么？职场上无法成功升迁的原因有很多，没有持续学习、学习效果不好、无法通过心仪公司的的面试，一定是很重要的原因。</p>\n<p>  <strong>把自己当成一台计算机，既有输入，也要有输出，用输出倒逼输入</strong>。</p>\n<h3 id=\"学什么\">　　<span style=\"font-size: 16px;\">学什么</span><h4 id=\"基础与应用\">　　基础与应用<p>  近些年诞生了许多新技术，比如最时髦的AI(目前还在智障阶段)，数学基础是初中就接触过的概率统计。万丈高楼从地起，不要被新工具或者中间件迷住双眼，一味地追新求快。基础知识是所有技术的基石，在未来很长的时间都不会变化，应该花费足够的时间巩固基础。</p><p>  以数据结构和算法为例，大家阅读一下Java的BitSet的源码，里面有大量的移位操作，移位运算掌握的好，看这份源码就没问题。Java同步工具类AQS用到了双向链表，链表知识不过关，肯定搞不懂它的原理。互联网大厂都喜欢考算法，为了通过面试也要精通算法。</p><p>  以Java工程师应该掌握的知识为例，按重要程度排出六个梯度：</p>\n  <ul>\n   <li>第一梯度：计算机组成原理、数据结构和算法、网络通信原理、操作系统原理；</li>\n   <li>第二梯度：Java基础、JVM内存模型和GC算法、JVM性能调优、JDK工具、设计模式；</li>\n   <li>第三梯度：Spring系列、Mybatis、Dubbo等主流框架的运用和原理；</li>\n   <li>第四梯度：MySQL(含SQL编程)、Redis、RabbitMQ/RocketMQ/Kafka、ZooKeeper等数据库或者中间件的运用和原理；</li>\n   <li>第五梯度：CAP理论、BASE理论、Paxos和Raft算法等其他分布式理论；</li>\n   <li>第六梯度：容器化、大数据、AI、区块链等等前沿技术理论。</li>\n  </ul><p>　　有同学认为第五梯度应该在移到第一梯度。其实很多小公司的日活犹如古天乐一样平平无奇，离大型分布式架构还远得很。学习框架和中间件的时候，顺手掌握分布式理论，效果更好。</p><h4 id=\"广度与深度\">　　广度与深度<p>  许多公司的招聘JD没有设定技术人员年龄门槛，但是会加上一句“具备与年龄相当的知识的广度与深度”。多广才算广，多深才算深？这是很主观的话题，这里不展开讨论。</p><p>  如何变得更广更深呢？<strong>突破收入上升的瓶颈，发掘自己真正的兴趣</strong>。</p><p>  大多数人只是公司的普通职员，收入上升的瓶颈就是升职加薪。许多IT公司会对技术人员有个评级，如果你的评级不高，那就依照晋级章程努力升级。如果你在一个小公司，收入一般，发展前景不明，准备大厂的面试就是最好的学习过程。在这些过程中，你必然学习更多知识，变得更广更深。</p><p>  个人兴趣是前进的动力之一，许多知名开源项目都源于作者的兴趣。个人兴趣并不局限技术领域，可以是其他学科。我有个朋友喜欢玩山地自行车，还给一些做自行车话题的自媒体投稿。久而久之，居然能够写一手好文章了，我相信他也能写好技术文档。</p><h4 id=\"哲学\">　　哲学<p>  哲学不是故作高深的学科，它的现实意义就是解决问题。年轻小伙是怎么泡妞的？三天两头花不断，大庭广众跪求爱。这类套路为什么总是能成功呢？礼物满足女人的物欲，当众求爱满足女人的虚荣心，投其所好。食堂大妈打菜的手越来越抖，辣子鸡丁变成辣子辣丁，为什么呢？食堂要控制成本，直接提价会惹众怒。</p><p>  科学上的哲学，一般指研究事物发展的规律，归纳终极的解决方案。软件行业充满哲学味道的作品非常多，比如《人月神话》。举个例子，当软件系统遇到性能问题，尝试下面两种哲学思想提升性能：</p>\n    <ul>\n     <li>空间换时间：比如引入缓存，消耗额外的存储提高响应速度。</li>\n     <li>时间换空间：比如大文件的分片处理，分段处理后再汇总结果。</li>\n    </ul><p>　　设计稳健高可用的系统，尝试从三个方面考虑问题：</p>\n    <ul>\n     <li>存储：数据会丢失吗，数据一致性怎么解决。</li>\n     <li>计算：计算怎么扩容，应用允许任意增加节点吗。</li>\n     <li>传输：网络中断或拥塞怎么办。</li>\n    </ul><p>　　从无数的失败或者成功的经验中，总结出高度概括性的方案，让我们下一步做的更好。</p><h4 id=\"英语\">　　英语<p>  英语是极为重要的基础，学好英语与掌握编程语言一样重要。且不说外企对英语的要求，许多知名博客就是把英文翻译成中文，充当知识的搬运工。如果英语足够好，直接阅读一手英语资料，避免他人翻译存在的谬误。</p><p>　　<strong><span style=\"font-size: 16px;\">怎么学</span></strong></p><h4 id=\"知识体系\">　　知识体系<p>  体系化的知识比零散的更容易记忆和理解，这正如一部好的电视剧，剧情环环相扣才能吸引观众。建议大家使用思维导图罗列知识点，构建体系结构，如下图所示：</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/31085/201906/31085-20190607182832666-1215142380.png\" alt=\"\" width=\"60%\" /></p><h4 id=\"克服遗忘\">　　克服遗忘<p>  高中是我们知识的巅峰时刻，每周小考每月大考，教辅资料堆成山，地狱式的反复操练强化记忆。复习是对抗遗忘的唯一办法。大脑的遗忘是有规律的，先快后慢。一天后，学到的知识只剩下原来的25%，甚至更低。随着时间的推移，遗忘的速度减慢，遗忘的数量也就减少。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/kb/1621547/201912/1621547-20191215183832794-1874553792.png\" alt=\"\" width=\"196\" height=\"293\" /></p><p>　　每个人的遗忘程度都不一样，建议第二天复习前一天的内容，七天后复习这段时间的所有内容。</p><h4 id=\"碎片时间\">　　碎片时间<p>  不少朋友利用碎片时间学习，比如在公交上看公众号的推送。其实我们都高估了自己的抗干扰能力，如果处在嘈杂的环境，注意力容易被打断，记忆留存度也很低。碎片时间适合学习简单孤立的知识点，比如链表的定义与实现。</p><p>  学习复杂的知识，需要大段的连续时间。图书馆是个好地方，安静氛围好。手机放一边，不要理会QQ微信，最好阅读纸质书，泡上一整天。有些城市出现了付费自习室，提供格子间、茶水等等，也是非常好的选择。</p><h3 id=\"用起来\">　　<span style=\"font-size: 16px;\">用起来</span><h3 id=\"技术分享\">　　技术分享<p>  从下面这张图我们可以看到，教授他人是知识留存率最高的方式。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/31085/201905/31085-20190527232022474-1815067006.png\" alt=\"\" /></p><p>  准备PPT和演讲内容，给同事来一场技术分享。不光复习知识，还锻炼口才。曾经有个同事说话又快又急，口头禅也多，比如\"对吧、是不是”，别人经常听不清，但是他本人不以为然。领导让他做了几次技术分享，听众的反应可想而知，他才彻底认清缺点。</p><p>  坚持写技术博客，别在意你写的东西在网上已经重复千百遍。当自己动手的时候，才会意识到眼高手低。让文章读起来流畅清晰，需要呕心沥血的删改。写作是对大脑的长期考验，想不到肯定写不出，想不清楚肯定写不清楚。</p><h3 id=\"造个轮子\">　　造个轮子<p>　　我们经常说不要重复造轮子。为了开发效率，可以不造轮子，但是必须具备造轮子的能力。建议造一个简单的MQ，你能用到通信协议、设计模式、队列等许多知识。在造轮子的过程中，你会频繁的翻阅各种手册或者博客，这就是用输出倒逼输入。</p></h3></h3></h3></h4></h4></h4></h4></h4></h4></h4></h3>","descriptionType":"html","publishedDate":"Thu, 21 May 2020 07:59:38 +0000","feedId":11665,"bgimg":"","linkMd5":"62c2dbb40a268e0c77ad389b073e5b9e","bgimgJsdelivr":"","metaImg":"","author":"","articleImgCdnMap":{"https://img2018.cnblogs.com/blog/31085/201906/31085-20190607182832666-1215142380.png":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn12@2020_3/2020/08/25/01-33-57-089_20a206a378b6cec2.webp","https://img2018.cnblogs.com/kb/1621547/201912/1621547-20191215183832794-1874553792.png":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn59@2020_3/2020/08/25/01-33-57-128_0148eb5df51c6af3.webp","https://img2018.cnblogs.com/blog/31085/201905/31085-20190527232022474-1815067006.png":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn36@2020_2/2020/08/25/01-33-57-006_76ed34a6216f1ec1.webp"},"publishedOrCreatedDate":1598319223180},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"CPU 瞒着内存竟干出这种事","link":"http://kb.cnblogs.com/page/662118/","description":"<p>　　还记得我吗，我是阿Q，CPU一号车间的那个阿Q。</p>\n<p>　　今天忙里偷闲，来到厂里<code>地址翻译部门</code>转转，负责这项工作的小黑正忙得满头大汗。</p>\n<p>　　看到我的到来，小黑指着旁边的座椅示意让我坐下。</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/5da0baeb-0324-4518-b8b5-aa8f2a067bbb.png\" alt=\"\" /></p>\n<p>　　坐了好一会儿，小黑才从工位上忙完转过身来，“实在不好意思阿Q，今天活太多，没来得及招待你”</p>\n<p>　　“刚忙什么呢，看你满头大汗的”，我问道。</p>\n<p>　　“嗨，别提了，老是发现内存页面错误，不停地要通知操作系统那边去处理，真是怀念以前啊，没有这么多破事儿要管”，小黑叹了口气。</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/29773cfd-8594-4770-8d44-6fb3b9d6a2c0.png\" alt=\"\" width=\"967\" height=\"647\" /></p>\n<p>　　我一听来了兴趣，“小黑你给我说说你们的工作呗，地址翻译是怎么一回事儿，为什么怀念以前呢？”</p>\n<p>　　小黑调整了下坐姿，咕噜咕噜喝了几口水说道，“这话说来可就话长了”</p>\n<p>　　接下来小黑开始给我讲起了历史故事······</p>\n<h2 id=\"8086\"><span style=\"font-size: 18px;\">8086</span><p>　　原来咱们的祖先叫8086，小黑还给我看了他的照片</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/6b29f841-6ec4-4860-9dd7-bf41dd8993f1.png\" alt=\"\" /></p><p>　　那是一个纯真质朴的年代，虽然工作性能不高，不过那个年代的程序都很简单，我们的祖先一问世就成为了明星，称得上那个时代的顶流了。</p><p>　　看到照片中的那些金属针脚了吗？那是我们CPU和外界打交道的触角，每一根都有不同的作用。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/3ec514b6-7b4a-4c09-875b-ccefe3cbffb2.png\" alt=\"\" /></p><p>　　通过这些触角，CPU就可以跟内存打交道，获取指令和数据，辛勤的干活啦。</p><p>　　那个年代，条件比较差，能凑合的就凑合，能共用的就共用。这不，你看祖先CPU的地址总线针脚和数据总线针脚就共用了。</p><p>　　祖先是一个16位的CPU，数据(Data)总线就有16位，一次性可以传输16个比特位。和地址(Address)总线凑合着一起共用，于是就取名AD0-AD15。</p><p>　　不过祖先的地址总线却不止16个，还多出了A16-A19整整4个呢！这样有20个地址线，可以寻址1MB的内存了！</p><p>　　但是祖先的寄存器都是16位的啊，只能存放16位的地址。不过他们很聪明，发明了一个叫<code>分段式存储管理</code>的方法，把内存划分为最大64KB的小块，为什么是64KB呢，因为16位地址最多只能寻址这么大了。然后又加了几个叫做段寄存器的东西，指向这些块的开头，这样，通过段地址+段内偏移地址的方式，就能访问更多的内存了。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/bbc550e2-5508-4c08-9a50-a3a19294eb58.png\" alt=\"\" /></p><h2 id=\"32位时代\">　　<p><strong><span style=\"font-size: 18px;\">32位时代</span></strong></p><p>　　后来啊，祖先的那点计算能力越来越捉襟见肘，实在是跟不上时代了。家族中的年轻一代开始挑大梁，80286和80386CPU相继问世，尤其是80386，成为了划时代的存在。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/d39143e1-43f2-4dfb-9b73-cc0041b3f3ca.png\" alt=\"\" /></p><p>　　到了80386时代，我们与外界通信的引脚就更多了，并且变成了32位的CPU，那个时候，生活条件就变好了，地址线和数据线再也不用共享引脚了。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/fcb5fe93-f0d3-4188-86a5-5671dad302ef.png\" alt=\"\" /></p><p>　　后来，人类变得越来越贪心，想要一边听音乐，一边还要上网，同时还要编辑文档，这就同时需要运行多个程序。</p><p>　　这个时候，有人发现了商机，开发了一个叫<code>操作系统</code>的东西，原来那些程序不再直接和我们CPU打交道了，而是和操作系统打交道，操作系统再和我们打交道，中间商赚差价说的就是他们！</p><p>　　操作系统这玩意儿很聪明啊，通过时间片划分让我们CPU来轮流执行多个程序，一会儿让我们执行音乐播放，一会儿让我们执行浏览器程序，一会儿又让我们执行文档编辑程序。我们是无所谓啊，给什么代码不是代码啊，我们不挑，埋头苦干就是了。人类的反应速度跟我们就差得远了，他们还以为这些程序真的是同时执行的呢。</p><h2 id=\"虚拟内存\">　<p><strong><span style=\"font-size: 18px;\">虚拟内存</span></strong></p><p>　　不过随之而来出现了一个大问题，这么多程序都要运行，大家挤在一个内存里，经常发生摩擦，冲突不断。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/1cbd8de1-1aa8-41ce-8229-d2b158a2ede1.png\" alt=\"\" /></p><p>　　先祖们为了此事殚精竭虑，终于想出了一个好办法，一直沿用至今。</p><p>　　他们提出了一个<code>虚拟地址</code>的东西，所有程序使用的地址都是一个虚拟的地址，在真正和内存打交道的时候，咱们CPU内部工作人员再给翻译成真实的内存地址，关于这事儿，内存那家伙一直被我们蒙在鼓里。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/544dafd1-0bda-4bb0-a48c-34bfc0c2c8a7.png\" alt=\"\" />　</p><p>　　这样一来，每个程序都可以用的是0x00000000到0xffffffff总共4GB这么大范围的地址空间，当然不会真的给他们那么多空间，内存那家伙总共才4GB呢，而是要按需申请分配。分配的单元是按照<code>页</code>来进行的，32位的CPU一个页是4KB。这些分配管理的累活就让操作系统来干了，中间商不能光拿好处不干正事，至于我们CPU，做好地址翻译的工作就好了。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/d6f6c9e5-97d7-464e-9186-00e776b64888.png\" alt=\"\" /></p><p>　　为此，在我们寄存器内部专门添置了一个新的寄存器CR3，用来指向一个地址翻译查询字典，字典划分了两级目录。我们把一个32位的地址划分了3部分，前面两部分分别指向两级目录中的条目，用来定位这个地址在物理内存的哪个页面，最后一部分就是指向物理内存页面的偏移，这样就完成了地址的翻译工作。</p><p>　　每个进程有不同的地址空间，切换进程的时候，把CR3的内容换一下就使用新进程的翻译字典，特别的方便。</p><p>　　我们把这种内存管理方式叫做<code>分页式内存管理</code>。</p><p>　　真佩服先祖们的智慧，这样巧妙的把各个程序隔离开来，后来我们把这种工作模式叫做<code>保护模式</code>，把之前那种直接使用真实内存地址的工作模式叫做<code>实地址模式</code>。</p><h2 id=\"分页交换\">　　<p><strong><span style=\"font-size: 18px;\">分页交换</span></strong></p><p>　　人类变得越来越贪婪，程序变得越来越多，对内存的需求也越来越大。随着这些程序都不断申请内存页面，内存空间很快就要耗尽了。</p><p>　　我们看在眼里，急在心里，后来找操作系统协商，看看这问题该怎么办。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/8a2948d1-f3c9-4125-b794-2b41ad24e109.png\" alt=\"\" /></p><p>　　操作系统那家伙也不赖，想出了一个好办法。内存的大小有限，但是硬盘给力啊，硬盘空间大的多，去硬盘上划一块区域来，把内存里长时间没有用到的页面给换到这块区域里去，然后做个标记。如果后面谁要访问那个页面，咱们CPU就检查如果有这个标记，就发送一个页错误的中断信号告诉操作系统去把这个页面换回来。</p><p>　　通过我们之间的配合，解决了内存紧张的危机。后来我们把这个技术叫做<code>内存分页交换</code>。</p><h2 id=\"现在\">　　　<p><strong><span style=\"font-size: 18px;\">现在</span></strong></p><p>　　时间过得很快，到了我们这一辈，内存变得更大了，16GB都是小case，32GB也很常见。</p><p>　　除了内存，我们CPU本身也更先进了，别的不说，你光看看咱们现在的引脚数那比先祖们那几辈就不可同日而语。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://imgkr.cn-bj.ufileos.com/0450d6fd-e391-40ad-b8f1-461bb6e7e44a.png\" alt=\"\" /></p><p>　　我们不仅从32位变成了64位，还从单核变成了多核，像我所在的CPU就有8个车间，8核并行执行，比起先祖那个年代简直有云泥之别。</p><p>　</p><p><strong><span style=\"font-size: 18px;\">彩蛋</span></strong></p>\n     <blockquote>\n      和小黑闲谈间，我们车间的老K突然出现在了门口。&nbsp;\n      <p>“阿Q原来你在这里，让我好找，赶快回去吧，隔壁二号车间的虎子说我们改了他们的数据，上门来闹事了······”&nbsp;</p>\n      <p><em>预知后事如何，请关注后续精彩······</em></p>\n     </blockquote></h2></h2></h2></h2></h2>","descriptionType":"html","publishedDate":"Sun, 24 May 2020 07:48:27 +0000","feedId":11665,"bgimg":"https://imgkr.cn-bj.ufileos.com/5da0baeb-0324-4518-b8b5-aa8f2a067bbb.png","linkMd5":"cb048ef412c5ec36a5d9347e830fa460","sourceBytes":0,"destBytes":0,"author":"","articleImgCdnMap":{"https://imgkr.cn-bj.ufileos.com/5da0baeb-0324-4518-b8b5-aa8f2a067bbb.png":null,"https://imgkr.cn-bj.ufileos.com/29773cfd-8594-4770-8d44-6fb3b9d6a2c0.png":null,"https://imgkr.cn-bj.ufileos.com/6b29f841-6ec4-4860-9dd7-bf41dd8993f1.png":null,"https://imgkr.cn-bj.ufileos.com/3ec514b6-7b4a-4c09-875b-ccefe3cbffb2.png":null,"https://imgkr.cn-bj.ufileos.com/bbc550e2-5508-4c08-9a50-a3a19294eb58.png":null,"https://imgkr.cn-bj.ufileos.com/d39143e1-43f2-4dfb-9b73-cc0041b3f3ca.png":null,"https://imgkr.cn-bj.ufileos.com/fcb5fe93-f0d3-4188-86a5-5671dad302ef.png":null,"https://imgkr.cn-bj.ufileos.com/1cbd8de1-1aa8-41ce-8229-d2b158a2ede1.png":null,"https://imgkr.cn-bj.ufileos.com/544dafd1-0bda-4bb0-a48c-34bfc0c2c8a7.png":null,"https://imgkr.cn-bj.ufileos.com/d6f6c9e5-97d7-464e-9186-00e776b64888.png":null,"https://imgkr.cn-bj.ufileos.com/8a2948d1-f3c9-4125-b794-2b41ad24e109.png":null,"https://imgkr.cn-bj.ufileos.com/0450d6fd-e391-40ad-b8f1-461bb6e7e44a.png":null},"publishedOrCreatedDate":1598319223179},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"从零开始入门 K8s | 手把手带你理解 etcd","link":"http://kb.cnblogs.com/page/653528/","description":"<p>　　作者&nbsp;| 曾凡松（逐灵）&nbsp;阿里云容器平台高级技术专家</p>\n<p>　　本文整理自<a href=\"https://edu.aliyun.com/roadmap/cloudnative\">《CNCF x Alibaba 云原生技术公开课》</a>第 16 讲。</p>\n<blockquote>\n <p><strong>导读</strong>：etcd&nbsp;是用于共享配置和服务发现的分布式、一致性的 KV 存储系统。本文从 etcd 项目发展所经历的几个重要时刻开始，为大家介绍了 etcd 的总体架构及其设计中的基本原理。希望能够帮助大家更好的理解和使用 etcd。</p>\n</blockquote>\n<h1 id=\"一etcd-项目的发展历程\">　　一、etcd 项目的发展历程<p>　　etcd 诞生于 CoreOS 公司，它最初是用于解决集群管理系统中 OS 升级的分布式并发控制以及配置文件的存储与分发等问题。基于此，etcd 被设计为提供高可用、强一致的小型 keyvalue 数据存储服务。</p><p>　　项目当前隶属于 CNCF 基金会，被 AWS、Google、Microsoft、Alibaba 等大型互联网公司广泛使用。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144649364-2049336422.png\" alt=\"1.png\" /></p><p>　　最初，在 2013 年 6 月份由 CoreOS 公司向 GitHub 中提交了第一个版本的初始代码。</p><p>　　到了 2014 年的 6 月，社区发生了一件事情，Kubernetes v0.4 版本发布。这里有必要介绍一下 Kubernetes 项目，它首先是一个容器管理平台，由谷歌开发并贡献给社区，因为它集齐了谷歌在容器调度以及集群管理等领域的多年经验，从诞生之初就备受瞩目。在 Kubernetes v0.4 版本中，它使用了 etcd 0.2 版本作为实验核心元数据的存储服务，自此 etcd 社区得到了飞速的发展。</p><p>　　很快，在 2015 年 2 月份，etcd 发布了第一个正式的稳定版本 2.0。在 2.0 版本中，etcd 重新设计了 Raft 一致性算法，并为用户提供了一个简单的树形数据视图，在 2.0 版本中 etcd 支持每秒超过 1000 次的写入性能，满足了当时绝大多数的应用场景需求。2.0 版本发布之后，经过不断的迭代与改进，其原有的数据存储方案逐渐成为了新时期的性能瓶颈，之后 etcd 启动了 v3 版本的方案设计。</p><p>　　2017 年 1 月份的时候，etcd 发布了 3.1 版本，v3 版本方案基本上标志着 etcd 技术上全面成熟。在 v3 版本中 etcd 提供了一套全新的 API，重新实现了更高效的一致性读取方法，并且提供了一个 gRPC 的 proxy 用于扩展 etcd 的读取性能。同时，在 v3 版本的方案中包含了大量的 GC 优化，在性能优化方面取得了长足的进步，在该版本中 etcd 可以支持每秒超过 10000 次的写入。</p><p>　　2018 年，CNCF 基金会下的众多项目都使用了 etcd 作为其核心的数据存储。据不完全统计，使用 etcd 的项目超过了 30 个，在同年 11 月份，etcd 项目自身也成为了 CNCF 旗下的孵化项目。进入 CNCF 基金会后，etcd 拥有了超过 400 个贡献组，其中包含了来自 AWS、Google、Alibaba 等 8 个公司的 9 个项目维护者。</p><p>　　2019 年，etcd 即将发布全新的 3.4 版本，该版本由 Google、Alibaba 等公司联合打造，将进一步改进 etcd 的性能及稳定性，以满足在超大型公司使用中苛刻的场景要求。</p><h1 id=\"二架构及内部机制解析\">　　二、架构及内部机制解析<h2 id=\"总体架构\">　　总体架构<p>　　etcd 是一个分布式的、可靠的 key-value 存储系统，它用于存储分布式系统中的关键数据，这个定义非常重要。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144654998-1464017813.png\" alt=\"2.png\" /></p><p>　　一个 etcd 集群，通常会由 3 个或者 5 个节点组成，多个节点之间通过 Raft 一致性算法的完成分布式一致性协同，算法会选举出一个主节点作为 leader，由 leader 负责数据的同步与数据的分发。当 leader 出现故障后系统会自动地选取另一个节点成为 leader，并重新完成数据的同步。客户端在多个节点中，仅需要选择其中的任意一个就可以完成数据的读写，内部的状态及数据协同由 etcd 自身完成。</p><p>　　在 etcd 整个架构中，有一个非常关键的概念叫做 quorum，quorum 的定义是 （n+1）/2，也就是说超过集群中半数节点组成的一个团体，在 3 个节点的集群中，etcd 可以容许 1 个节点故障，也就是只要有任何 2 个节点可用，etcd 就可以继续提供服务。同理，在 5 个节点的集群中，只要有任何 3 个节点可用，etcd 就可以继续提供服务，这也是 etcd 集群高可用的关键。</p><p>　　在允许部分节点故障之后继续提供服务，就需要解决一个非常复杂的问题：分布式一致性。在 etcd 中，该分布式一致性算法由 Raft 一致性算法完成，这个算法本身是比较复杂的有机会再详细展开，这里仅做一个简单的介绍以方便大家对其有一个基本的认知。Raft 一致性算法能够工作的一个关键点是：任意两个 quorum 的成员之间一定会有一个交集（公共成员），也就是说只要有任意一个 quorum 存活，其中一定存在某一个节点（公共成员），它包含着集群中所有的被确认提交的数据。正是基于这一原理，Raft 一致性算法设计了一套数据同步机制，在 Leader 任期切换后能够重新同步上一个 quorum 被提交的所有数据，从而保证整个集群状态向前推进的过程中保持数据的一致。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144657309-1185117051.png\" alt=\"3.png\" /></p><p>　　etcd 内部的机制比较复杂，但 etcd 给客户提供的接口是简单直接的。如上图所示，我们可以通过 etcd 提供的客户端去访问集群的数据，也可以直接通过 http 的方式（类似 curl 命令）直接访问 etcd。在 etcd 内部，其数据表示也是比较简单的，我们可以直接把 etcd 的数据存储理解为一个有序的 map，它存储着 key-value 数据。同时 etcd 为了方便客户端去订阅数据的变更，也支持了一个 watch 机制，通过 watch 实时地拿到 etcd 中数据的增量更新，从而实现与 etcd 中的数据同步等业务逻辑。</p><h2 id=\"api-介绍\">　　API 介绍<p>　　接下来我们看一下 etcd 提供的接口，这里将 etcd 的接口分为了 5 组：</p><p><img src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144658685-2109075926.png\" alt=\"4.png\" /></p>\n    <ul>\n     <li>第一组是 Put 与 Delete。上图可以看到 put 与 delete 的操作都非常简单，只需要提供一个 key 和一个 value，就可以向集群中写入数据了，删除数据的时候只需要指定 key 即可；</li>\n     <li>第二组是查询操作。etcd 支持两种类型的查询：第一种是指定单个 key 的查询，第二种是指定的一个 key 的范围；</li>\n     <li>第三组是数据订阅。etcd 提供了 Watch 机制，我们可以利用 watch 实时订阅到 etcd 中增量的数据更新，watch 支持指定单个 key，也可以指定一个 key 的前缀，在实际应用场景中的通常会采用第二种形势；</li>\n     <li>第四组事务操作。etcd 提供了一个简单的事务支持，用户可以通过指定一组条件满足时执行某些动作，当条件不成立的时候执行另一组操作，类似于代码中的 if else 语句，etcd 确保整个操作的原子性；</li>\n     <li>第五组是 Leases 接口。Leases 接口是分布式系统中常用的一种设计模式，其用法后面会具体展开。</li>\n    </ul><h2 id=\"数据版本机制\">　　数据版本机制<p>　　要正确使用 etcd 的 API，必须要知道内部对应数据版本号的基本原理。</p><p>　　首先 etcd 中有个 term 的概念，代表的是整个集群 Leader 的任期。当集群发生 Leader 切换，term 的值就会 +1。在节点故障，或者 Leader 节点网络出现问题，再或者是将整个集群停止后再次拉起，都会发生 Leader 的切换。</p><p>　　第二个版本号叫做 revision，revision 代表的是全局数据的版本。当数据发生变更，包括创建、修改、删除，其 revision 对应的都会 +1。特别的，在集群中跨 Leader 任期之间，revision 都会保持全局单调递增。正是 revision 的这一特性，使得集群中任意一次的修改都对应着一个唯一的 revision，因此我们可以通过 revision 来支持数据的 MVCC，也可以支持数据的 Watch。</p><p>　　对于每一个 KeyValue 数据节点，etcd 中都记录了三个版本：</p>\n     <ul>\n      <li>第一个版本叫做 create_revision，是 KeyValue 在创建时对应的 revision；</li>\n      <li>第二个叫做 mod_revision，是其数据被操作的时候对应的 revision；</li>\n      <li>第三个 version 就是一个计数器，代表了 KeyValue 被修改了多少次。</li>\n     </ul><p>　　这里可以用图的方式给大家展示一下：</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144659805-1383290847.png\" alt=\"5.png\" /></p><p>　　在同一个 Leader 任期之内，我们发现所有的修改操作，其对应的 term 值始终都等于 2，而 revision 则保持单调递增。当重启集群之后，我们会发现所有的修改操作对应的 term 值都变成了 3。在新的 Leader 任期内，所有的 term 值都等于3，且不会发生变化，而对应的 revision 值同样保持单调递增。从一个更大的维度去看，可以发现在 term=2 和 term=3 的两个 Leader 任期之间，数据对应的 revision 值依旧保持了全局单调递增。</p><h2 id=\"mvcc-streaming-watch\">　　mvcc &amp; streaming watch<p>　　了解 etcd 的版本号控制后，接下来如何使用 etcd 多版本号来实现并发控制以及数据订阅（Watch）。</p><p>　　在 etcd 中支持对同一个 Key 发起多次数据修改，每次数据修改都对应一个版本号。etcd 在实现上记录了每一次修改对应的数据，也就就意味着一个 key 在 etcd 中存在多个历史版本。在查询数据的时候如果不指定版本号，etcd 会返回 Key 对应的最新版本，当然 etcd 也支持指定一个版本号来查询历史数据。</p><p><img src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144700352-40629753.png\" alt=\"6.png\" /></p><p>　　因为 etcd 将每一次修改都记录了下来，使用 watch 订阅数据时，可以支持从任意历史时刻（指定 revision）开始创建一个 watcher，在客户端与 etcd 之间建立一个数据管道，etcd 会推送从指定 revision 开始的所有数据变更。etcd 提供的 watch 机制保证，该 Key 的数据后续的被修改之后，通过这个数据管道即时的推送给客户端。</p><p>　　如下图所示，etcd 中所有的数据都存储在一个 b+tree 中（灰色），该 b+tree 保存在磁盘中，并通过&nbsp;mmap 的方式映射到内存用来支持快速的访问。灰色的 b+tree 中维护着 revision 到 value 的映射关系，支持通过 revision 查询对应的数据。因为 revision 是单调递增的，当我们通过 watch 来订阅指定 revision 之后的数据时，仅需要订阅该 b+ tree 的数据变化即可。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144701136-1541745017.png\" alt=\"7.png\" /></p><p>　　在 etcd 内部还维护着另外一个 btree（蓝色），它管理着 key 到 revision 的映射关系。当客户端使用 key 查询数据时，首先需要经过蓝色的 btree 将 key 转化为对应的 revision，再通过灰色的 btree 查询到对应的数据。</p><p>　　细心的读者会发现，etcd 将每一次修改都记录下来会导致数据持续增长，这会带来内存及磁盘的空间消耗，同时也会影响 b+tree 的查询效率。为了解决这一问题，在 etcd 中会运行一个<strong>周期性的 Compaction 的机制</strong>来清理历史数据，将一段时间之前的同一个 Key 的多个历史版本数据清理掉。最终的结果是灰色的 b+tree 依旧保持单调递增，但可能会出现一些空洞。</p><h2 id=\"mini-transactions\">　　mini-transactions<p>　　在理解了 mvcc 机制及 watch 机制之后，继续看 etcd 提供的 mini-transactions 机制。etcd 的 transaction 机制比较简单，基本可以理解为一段 if-else 程序，在 if 中可以提供多个操作，如下图所示：</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144701612-2119498232.png\" alt=\"8.png\" /></p><p>　　If 里面写了两个条件，当 Value(key1) 大于 \"bar\" 并且 Version(key1) 的版本等于 2 的时候，执行 Then 里面指定的操作：修改 Key2 的数据为 valueX，同时删除 Key3 的数据。如果不满足条件，则执行另外一个操作：Key2 修改为 valueY。</p><p>　　在 etcd 内部会保证整个事务操作的原子性。也就是说 If 操作所有的比较条件，其看到的视图一定是一致的。同时它能够确保多个操作的原子性不会出现 Then 中的操作仅执行了一半的情况。</p><p>　　通过 etcd 提供的事务操作，我们可以在多个竞争中去保证数据读写的一致性，比如说前面已经提到过的 Kubernetes 项目，它正是利用了 etcd 的事务机制，来实现多个 KubernetesAPI server 对同样一个数据修改的一致性。</p><h2 id=\"lease-的概念及用法\">　　lease 的概念及用法<p>　　lease 是分布式系统中一个常见的概念，用于代表一个分布式租约。典型情况下，在分布式系统中需要去检测一个节点是否存活的时，就需要租约机制。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144702764-1012478859.png\" alt=\"9.png\" /></p><p>　　上图示例中的代码示例首先创建了一个 10s 的租约，如果创建租约后不做任何的操作，那么 10s 之后，这个租约就会自动过期。接着将 key1 和 key2 两个 key value 绑定到这个租约之上，这样当租约过期时 etcd 就会自动清理掉 key1 和 key2，使得节点 key1 和 key2 具备了超时自动删除的能力。</p><p>　　如果希望这个租约永不过期，需要周期性的调用 KeeyAlive 方法刷新租约。比如说需要检测分布式系统中一个进程是否存活，可以在进程中去创建一个租约，并在该进程中周期性的调用 KeepAlive 的方法。如果一切正常，该节点的租约会一致保持，如果这个进程挂掉了，最终这个租约就会自动过期。</p><p>　　在 etcd 中，允许将多个 key 关联在同一个 lease 之上，这个设计是非常巧妙的，可以大幅减少 lease 对象刷新带来的开销。试想一下，如果有大量的 key 都需要支持类似的租约机制，每一个 key 都需要独立的去刷新租约，这会给&nbsp; etcd 带来非常大的压力。通过多个 key 绑定在同一个 lease 的模式，我们可以将超时间相似的 key 聚合在一起，从而大幅减小租约刷新的开销，在不失灵活性同时能够大幅提高 etcd 支持的使用规模。</p><h1 id=\"三典型的使用场景介绍\">　　三、典型的使用场景介绍<h2 id=\"元数据存储\">　　元数据存储<p>　　Kubernetes 将自身所用的状态存储在 etcd 中，其状态数据的高可用交给 etcd 来解决，Kubernetes 系统自身不需要再应对复杂的分布式系统状态处理，自身的系统架构得到了大幅的简化。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144704588-1066652639.png\" alt=\"10.png\" /></p><h2 id=\"server-discovery-naming-service\">　　Server Discovery （Naming Service）<p>　　第二个场景是 Service Discovery，也叫做名字服务。在分布式系统中，通常会出现的一个模式就是需要多个后端（可能是成百上千个进程）来提供一组对等的服务，比如说检索服务、推荐服务。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144706712-855721709.png\" alt=\"11.png\" /></p><p>　　对于这样一种后端服务，通常情况下为了简化后端服务的运维成本（节点故障时随时被替换），后端的这一进程会被类似 Kubernetes 这样的集群管理系统所调度，这样当用户（或上游服务）调用过来时，我们就需要一个服务发现机制来解决服务路由问题。这一服务发现问题可以利用 etcd 来高效解决，方式如下：</p>\n           <ul>\n            <li>在进程内部启动之后，可以将自身所在的地址注册到 etcd；</li>\n            <li>API 网关够通过 etcd 及时感知到后端进程的地址，当后端进程发生故障迁移时会重新注册到 etcd 中，API 网关也能够及时地感知到新的地址；</li>\n            <li>利用 etcd 提供的&nbsp;Lease 机制，如果提供服务的进程运行过程中出现了异常（crash），API 网关也可以摘除其流量避免调用超时。</li>\n           </ul><p>　　在这一架构中，服务状态数据被 etcd 接管，API 网关本身也是无状态的，可以水平地扩展来服务更多的客户。同时得益于 etcd 的良好性能，可以支持上万个后端进程的节点，使得这一架构可以服务于大型的企业。</p><h2 id=\"distributed-coordination-leader-election\">　　Distributed Coordination: leader election<p>　　在分布式系统中，有一种典型的设计模式就是 Master+Slave。通常情况下，Slave 提供了 CPU、内存、磁盘以及网络等各种资源 ，而 Master 用来调和这些节点以使其对外提供一个服务（比如分布式存储，分布式计算）。典型的分布式存储服务（HDFS）以及分布式计算服务（Hadoop）它们都是采用了类似这样的设计模式。这样的设计模式会有一个典型的问题：<strong>Master 节点的可用性</strong>。当 Master 故障以后，整个集群的服务就挂掉了，没有办法再服务用户的请求。</p><p>　　为了解决这个问题，典型的做法就是启动多个 Master 节点。因为 Master 节点内会包含控制逻辑，多个节点之间的状态同步是非常复杂的，这里最典型的做法就是通过选主的方式，选出其中一个节点作为主节点来提供服务，另一个节点处于等待状态。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144707551-1195034411.png\" alt=\"12.png\" /></p><p>　　通过 etcd 提供的机制可以很容易的实现分布式进程的选主功能，比如可以通过对同一个 key 的事务写来实现抢主的逻辑。一般而言，被选主的 Leader 会将自己的 IP 注册到 etcd 中，使得 Slave 节点能够及时获取到当前的 Leader 地址，从而使得系统按照之前单个 Master 节点的方式继续工作。当 Leader 节点发生异常之后，通过 etcd 能够选取出一个新的节点成为主节点，并且注册新的 IP 之后，Slave 又能够拉取新的主节点的 IP，继续恢复服务。</p><h2 id=\"distributed-coordination-分布式系统并发控制\">　　Distributed Coordination 分布式系统并发控制<p>　　在分布式系统中，当我们去执行一些任务，比如说去升级 OS、或者说升级 OS 上的软件的时候、又或者去执行一些计算任务的时候，出于对后端服务的瓶颈或者是业务稳定性的考虑，通常情况下需要控制任务的并发度。如果该任务缺少一个调和的 Master 节点，可以通过 etcd 来完成这样的分布式系统工作。</p><p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144708811-339049697.png\" alt=\"13.png\" /></p><p>　　在这个模式中通过 etcd 去实现一个分布式的信号量，并且可以利用 etcd leases 机制来实现自动地剔除掉故障节点。在进程执行过程中，如果进程的运行周期比较长，我们可以将进程运行过程中的一些状态数据存储到 etcd，从而使得当进程故障之后且需要恢复到其他地方时，能够从 etcd 中去恢复一些执行状态，而不需要重新去完成整个的计算逻辑，以此来加速整个任务的执行效率。</p><h1 id=\"本文总结\">　　本文总结<p>　　本文分享的主要内容就到此为止了，这里为大家简单总结一下：</p>\n              <ul>\n               <li>第一部分，为大家介绍了 etcd 项目是如何诞生的，以及在 etcd 发展过程中经历的几个重要时刻；</li>\n               <li>第二部分，为大家介绍了 etcd 的架构以及其内部的基本操作接口，在理解 etcd 是如何实现高可用的基础之上，展示了 etcd 数据的一些基本操作以及其内部的实现原理；</li>\n               <li>第三部分，介绍了三种典型的 etcd 使用场景，以及在对应的场景下，分布式系统的设计思路。</li>\n              </ul></h1></h2></h2></h2></h2></h1></h2></h2></h2></h2></h2></h2></h1></h1>","descriptionType":"html","publishedDate":"Mon, 13 Jan 2020 03:16:52 +0000","feedId":11665,"bgimg":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144649364-2049336422.png","linkMd5":"0999877fc2802ef25e7074ed2db0874d","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn33@2020_3/2020/08/25/01-33-52-574_03357b4e33ba508f.webp","destWidth":1051,"destHeight":581,"sourceBytes":154650,"destBytes":40850,"author":"","articleImgCdnMap":{"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144649364-2049336422.png":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn33@2020_3/2020/08/25/01-33-52-574_03357b4e33ba508f.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144654998-1464017813.png":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn39@2020_5/2020/08/25/01-33-57-832_762bf598ad1c5c11.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144657309-1185117051.png":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn95@2020_1/2020/08/25/01-33-56-935_96d22ad4554419ac.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144658685-2109075926.png":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn40@2020_2/2020/08/25/01-33-57-013_2db599098354b4c6.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144659805-1383290847.png":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn19@2020_5/2020/08/25/01-33-57-295_5593a7ae04fc613d.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144700352-40629753.png":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn64@2020_6/2020/08/25/01-33-59-579_b5cd55ac5785d1a0.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144701136-1541745017.png":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn43@2020_6/2020/08/25/01-33-56-180_54acf7710571c73f.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144701612-2119498232.png":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn23@2020_2/2020/08/25/01-33-59-327_70289f5a98cf3a07.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144702764-1012478859.png":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn92@2020_1/2020/08/25/01-33-56-666_ce4c3dd68528fdff.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144704588-1066652639.png":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn47@2020_2/2020/08/25/01-33-56-569_4d09a529d8bcc3f2.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144706712-855721709.png":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn55@2020_4/2020/08/25/01-33-57-374_5481c06cc437fe07.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144707551-1195034411.png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn91@2020_5/2020/08/25/01-33-56-748_8660e7b5a049fdb3.webp","https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144708811-339049697.png":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn60@2020_6/2020/08/25/01-33-59-616_c2ba519d646a4d56.webp"},"publishedOrCreatedDate":1598319223181},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"K8s GC设计原则","link":"http://kb.cnblogs.com/page/651942/","description":"<p>　　<a href=\"https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/garbage-collection.md#orphaning-the-descendants-with-orphan-finalizer\" target=\"_blank\"><em>Ref</em></a></p>\n<p>　　<em>Warning：设计文档的对应的 k8s 版本为1.7</em></p>\n<blockquote>\n <p><em>Q: What is GC of Kuernetes ?</em></p>\n</blockquote>\n<p><em>　　GC 是 Garbage Collector 的简称。从功能层面上来说，它和编程语言当中的「GC」 基本上是一样的。它清理 Kubernetes 中「符合特定条件」的 Resource Object。（在 k8s 中，你可以认为万物皆资源，很多逻辑的操作对象都是 Resource Object。）</em></p>\n<blockquote>\n <p><em><em>Q: What are dependent mechanisms to clear needless resource objects?</em></em></p>\n</blockquote>\n<p style=\"text-align: left;\"><em>　　Kubernetes 在不同的 Resource Objects 中维护一定的「从属关系」。内置的 Resource Objects 一般会默认在一个 Resource Object 和它的创建者之间建立一个「从属关系」。</em></p>\n<p style=\"text-align: left;\"><em>　　当然，你也可以利用&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">ObjectMeta.OwnerReferences</span>&nbsp;自由的去给两个 Resource Object 建立关系，前提是被建立关系的两个对象必须在一个 Namespace 下。</em></p>\n<div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n <span style=\"color: #008080;\"> 1</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> OwnerReference contains enough information to let you identify an owning<br /></span>\n <span style=\"color: #008080;\"> 2</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> object. Currently, an owning object must be in the same namespace, so there<br /></span>\n <span style=\"color: #008080;\"> 3</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> is no namespace field.</span>\n <br />\n <span style=\"color: #008080;\"> 4</span> type OwnerReference \n <span style=\"color: #0000ff;\">struct</span>\n <span style=\"color: #000000;\"> {<br /></span>\n <span style=\"color: #008080;\"> 5</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> API version of the referent.</span>\n <br />\n <span style=\"color: #008080;\"> 6</span> APIVersion \n <span style=\"color: #0000ff;\">string</span> `json:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">apiVersion</span>\n <span style=\"color: #800000;\">\"</span> protobuf:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">bytes,5,opt,name=apiVersion</span>\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #000000;\">`<br /></span>\n <span style=\"color: #008080;\"> 7</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> Kind of the referent.<br /></span>\n <span style=\"color: #008080;\"> 8</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> More info: </span>\n <span style=\"color: #008000; text-decoration: underline;\">https://git.k8s.io/community/contributors/devel/api-conventions.md</span>\n <span style=\"color: #008000;\">#types-kinds</span>\n <br />\n <span style=\"color: #008080;\"> 9</span> Kind \n <span style=\"color: #0000ff;\">string</span> `json:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">kind</span>\n <span style=\"color: #800000;\">\"</span> protobuf:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">bytes,1,opt,name=kind</span>\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #000000;\">`<br /></span>\n <span style=\"color: #008080;\">10</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> Name of the referent.<br /></span>\n <span style=\"color: #008080;\">11</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> More info: </span>\n <span style=\"color: #008000; text-decoration: underline;\">http://kubernetes.io/docs/user-guide/identifiers</span>\n <span style=\"color: #008000;\">#names</span>\n <br />\n <span style=\"color: #008080;\">12</span> Name \n <span style=\"color: #0000ff;\">string</span> `json:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">name</span>\n <span style=\"color: #800000;\">\"</span> protobuf:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">bytes,3,opt,name=name</span>\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #000000;\">`<br /></span>\n <span style=\"color: #008080;\">13</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> UID of the referent.<br /></span>\n <span style=\"color: #008080;\">14</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> More info: </span>\n <span style=\"color: #008000; text-decoration: underline;\">http://kubernetes.io/docs/user-guide/identifiers</span>\n <span style=\"color: #008000;\">#uids</span>\n <br />\n <span style=\"color: #008080;\">15</span> UID types.UID `json:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">uid</span>\n <span style=\"color: #800000;\">\"</span> protobuf:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">bytes,4,opt,name=uid,casttype=k8s.io/apimachinery/pkg/types.UID</span>\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #000000;\">`<br /></span>\n <span style=\"color: #008080;\">16</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> If true, this reference points to the managing controller.<br /></span>\n <span style=\"color: #008080;\">17</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> +optional</span>\n <br />\n <span style=\"color: #008080;\">18</span> Controller *\n <span style=\"color: #0000ff;\">bool</span> `json:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">controller,omitempty</span>\n <span style=\"color: #800000;\">\"</span> protobuf:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">varint,6,opt,name=controller</span>\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #000000;\">`<br /></span>\n <span style=\"color: #008080;\">19</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> If true, AND if the owner has the \"foregroundDeletion\" finalizer, then<br /></span>\n <span style=\"color: #008080;\">20</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> the owner cannot be deleted from the key-value store until this<br /></span>\n <span style=\"color: #008080;\">21</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> reference is removed.<br /></span>\n <span style=\"color: #008080;\">22</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> Defaults to false.<br /></span>\n <span style=\"color: #008080;\">23</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> To set this field, a user needs \"delete\" permission of the owner,<br /></span>\n <span style=\"color: #008080;\">24</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> otherwise 422 (Unprocessable Entity) will be returned.<br /></span>\n <span style=\"color: #008080;\">25</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> +optional</span>\n <br />\n <span style=\"color: #008080;\">26</span> BlockOwnerDeletion *\n <span style=\"color: #0000ff;\">bool</span> `json:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">blockOwnerDeletion,omitempty</span>\n <span style=\"color: #800000;\">\"</span> protobuf:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">varint,7,opt,name=blockOwnerDeletion</span>\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #000000;\">`<br /></span>\n <span style=\"color: #008080;\">27</span> }\n</div>\n<p><code>　　&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">OwnerReference</span>&nbsp;</code>一般存在于某一个 Resource Object 信息中的 metadata 部分。</p>\n<p>　　&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">OwnerReference</span>&nbsp;中的字段可以唯一的确定 k8s 中的一个 Resource Object。两个 Object 可以通过这种方式建立一个&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">owner-dependent</span>&nbsp;的关系。</p>\n<p>　　K8s 实现了一种「Cascading deletion」（级联删除）的机制，它利用已经建立的「从属关系」进行资源对象的清理工作。例如，当一个 dependent 资源的 owner 已经被删除或者不存在的时候，从某种角度就可以判定，这个 dependent 的对象已经是异常（无人管辖）的了，需要进行清理。而 「cascading deletion」则是被 k8s 中的一个 controller 组件实现的：&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Garbage Collector</span>&nbsp;</p>\n<p>　　所以，k8s 是通过&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Garbage Collector</span>&nbsp;和&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">ownerReference</span>&nbsp;一起配合实现了「垃圾回收」的功能。</p>\n<blockquote>\n <p>Q: What is the relationship like ?(owner-dependent)</p>\n</blockquote>\n<p><em>　　我们可以通过一个实际的例子来了解这个「从属关系」：</em></p>\n<div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n <span style=\"color: #008080;\"> 1</span> apiVersion: extensions/\n <span style=\"color: #000000;\">v1beta1<br /></span>\n <span style=\"color: #008080;\"> 2</span> \n <span style=\"color: #000000;\">kind: ReplicaSet<br /></span>\n <span style=\"color: #008080;\"> 3</span> \n <span style=\"color: #000000;\">metadata:<br /></span>\n <span style=\"color: #008080;\"> 4</span> \n <span style=\"color: #000000;\"> annotations:<br /></span>\n <span style=\"color: #008080;\"> 5</span> deployment.kubernetes.io/desired-replicas: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">2</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\"> 6</span> deployment.kubernetes.io/max-replicas: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">3</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\"> 7</span> deployment.kubernetes.io/revision: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">1</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\"> 8</span> creationTimestamp: \n <span style=\"color: #800080;\">2018</span>-\n <span style=\"color: #800080;\">09</span>-07T07:\n <span style=\"color: #800080;\">11</span>\n <span style=\"color: #000000;\">:52Z<br /></span>\n <span style=\"color: #008080;\"> 9</span> generation: \n <span style=\"color: #800080;\">1</span>\n <br />\n <span style=\"color: #008080;\">10</span> \n <span style=\"color: #000000;\"> labels:<br /></span>\n <span style=\"color: #008080;\">11</span> \n <span style=\"color: #000000;\"> app: coffee<br /></span>\n <span style=\"color: #008080;\">12</span> pod-template-hash: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">3866135192</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">13</span> name: coffee-\n <span style=\"color: #000000;\">7dbb5795f6<br /></span>\n <span style=\"color: #008080;\">14</span> \n <span style=\"color: #0000ff;\">namespace</span>: \n <span style=\"color: #0000ff;\">default</span>\n <br />\n <span style=\"color: #008080;\">15</span> \n <span style=\"color: #000000;\"> ownerReferences:<br /></span>\n <span style=\"color: #008080;\">16</span> - apiVersion: apps/\n <span style=\"color: #000000;\">v1<br /></span>\n <span style=\"color: #008080;\">17</span> blockOwnerDeletion: \n <span style=\"color: #0000ff;\">true</span>\n <br />\n <span style=\"color: #008080;\">18</span> controller: \n <span style=\"color: #0000ff;\">true</span>\n <br />\n <span style=\"color: #008080;\">19</span> \n <span style=\"color: #000000;\"> kind: Deployment<br /></span>\n <span style=\"color: #008080;\">20</span> \n <span style=\"color: #000000;\"> name: coffee<br /></span>\n <span style=\"color: #008080;\">21</span> uid: 4b807ee6-b26d-11e8-b891-\n <span style=\"color: #000000;\">fa163eebca40<br /></span>\n <span style=\"color: #008080;\">22</span> resourceVersion: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">476159</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">23</span> selfLink: /apis/extensions/v1beta1/namespaces/\n <span style=\"color: #0000ff;\">default</span>/replicasets/coffee-\n <span style=\"color: #000000;\">7dbb5795f6<br /></span>\n <span style=\"color: #008080;\">24</span> uid: 4b81e76c-b26d-11e8-b891-\n <span style=\"color: #000000;\">fa163eebca40<br /></span>\n <span style=\"color: #008080;\">25</span> \n <span style=\"color: #000000;\">spec:<br /></span>\n <span style=\"color: #008080;\">26</span> replicas: \n <span style=\"color: #800080;\">2</span>\n <br />\n <span style=\"color: #008080;\">27</span> ....\n</div>\n<p>　　上面截取了一个 ReplicaSet Object 中的 metadata 的部分信息。</p>\n<p>　　我们可以注意到，它的&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">ownerReferences</span>&nbsp;字段标识了一个 Deployment Object。我们都清楚的是，ReplicaSet 会创建一系列的 Pod。通过&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">spec.replicas:<span style=\"color: #800080;\">2</span></span>&nbsp;可以知道，他会创建两个pod。</p>\n<div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n <span style=\"color: #008080;\">1</span> root@xr-service-mesh-lab:~/istio-\n <span style=\"color: #800080;\">1.0</span>.\n <span style=\"color: #800080;\">2</span># kubectl \n <span style=\"color: #0000ff;\">get</span> pods |\n <span style=\"color: #000000;\"> grep coffee<br /></span>\n <span style=\"color: #008080;\">2</span> coffee-7dbb5795f6-6crxz \n <span style=\"color: #800080;\">1</span>/\n <span style=\"color: #800080;\">1</span> Running \n <span style=\"color: #800080;\">0</span>\n <span style=\"color: #000000;\"> 9d<br /></span>\n <span style=\"color: #008080;\">3</span> coffee-7dbb5795f6-hv7tr \n <span style=\"color: #800080;\">1</span>/\n <span style=\"color: #800080;\">1</span> Running \n <span style=\"color: #800080;\">0</span>\n <span style=\"color: #000000;\"> 5d<br /></span>\n <span style=\"color: #008080;\">4</span> root@xr-service-mesh-lab:~/istio-\n <span style=\"color: #800080;\">1.0</span>.\n <span style=\"color: #800080;\">2</span>#\n</div>\n<p>　　让我们来观察其中一个 Pod：</p>\n<div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n <span style=\"color: #008080;\"> 1</span> \n <span style=\"color: #000000;\">apiVersion: v1<br /></span>\n <span style=\"color: #008080;\"> 2</span> \n <span style=\"color: #000000;\">kind: Pod<br /></span>\n <span style=\"color: #008080;\"> 3</span> \n <span style=\"color: #000000;\">metadata:<br /></span>\n <span style=\"color: #008080;\"> 4</span> \n <span style=\"color: #000000;\"> annotations:<br /></span>\n <span style=\"color: #008080;\"> 5</span> cni.projectcalico.org/podIP: \n <span style=\"color: #800080;\">192.168</span>.\n <span style=\"color: #800080;\">0.14</span>/\n <span style=\"color: #800080;\">32</span>\n <br />\n <span style=\"color: #008080;\"> 6</span> creationTimestamp: \n <span style=\"color: #800080;\">2018</span>-\n <span style=\"color: #800080;\">09</span>-07T07:\n <span style=\"color: #800080;\">11</span>\n <span style=\"color: #000000;\">:52Z<br /></span>\n <span style=\"color: #008080;\"> 7</span> generateName: coffee-7dbb5795f6-\n <br />\n <span style=\"color: #008080;\"> 8</span> \n <span style=\"color: #000000;\"> labels:<br /></span>\n <span style=\"color: #008080;\"> 9</span> \n <span style=\"color: #000000;\"> app: coffee<br /></span>\n <span style=\"color: #008080;\">10</span> pod-template-hash: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">3866135192</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">11</span> name: coffee-7dbb5795f6-\n <span style=\"color: #000000;\">6crxz<br /></span>\n <span style=\"color: #008080;\">12</span> \n <span style=\"color: #0000ff;\">namespace</span>: \n <span style=\"color: #0000ff;\">default</span>\n <br />\n <span style=\"color: #008080;\">13</span> \n <span style=\"color: #000000;\"> ownerReferences:<br /></span>\n <span style=\"color: #008080;\">14</span> - apiVersion: apps/\n <span style=\"color: #000000;\">v1<br /></span>\n <span style=\"color: #008080;\">15</span> blockOwnerDeletion: \n <span style=\"color: #0000ff;\">true</span>\n <br />\n <span style=\"color: #008080;\">16</span> controller: \n <span style=\"color: #0000ff;\">true</span>\n <br />\n <span style=\"color: #008080;\">17</span> \n <span style=\"color: #000000;\"> kind: ReplicaSet<br /></span>\n <span style=\"color: #008080;\">18</span> name: coffee-\n <span style=\"color: #000000;\">7dbb5795f6<br /></span>\n <span style=\"color: #008080;\">19</span> uid: 4b81e76c-b26d-11e8-b891-\n <span style=\"color: #000000;\">fa163eebca40<br /></span>\n <span style=\"color: #008080;\">20</span> resourceVersion: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">76727</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">21</span> selfLink: /api/v1/namespaces/\n <span style=\"color: #0000ff;\">default</span>/pods/coffee-7dbb5795f6-\n <span style=\"color: #000000;\">6crxz<br /></span>\n <span style=\"color: #008080;\">22</span> uid: 4b863e4d-b26d-11e8-b891-fa163eebca40\n</div>\n<p>　　我们可以看出，pod 中的&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">ownerReferences</span>&nbsp;所标识的 Object 正式我们上面看到过的 ReplicaSet。最后让我们来检查一下 ReplicaSet 所对应的 Deployment 的情况：</p>\n<div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n <span style=\"color: #008080;\"> 1</span> apiVersion: extensions/\n <span style=\"color: #000000;\">v1beta1<br /></span>\n <span style=\"color: #008080;\"> 2</span> \n <span style=\"color: #000000;\">kind: Deployment<br /></span>\n <span style=\"color: #008080;\"> 3</span> \n <span style=\"color: #000000;\">metadata:<br /></span>\n <span style=\"color: #008080;\"> 4</span> \n <span style=\"color: #000000;\"> annotations:<br /></span>\n <span style=\"color: #008080;\"> 5</span> deployment.kubernetes.io/revision: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">1</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\"> 6</span> creationTimestamp: \n <span style=\"color: #800080;\">2018</span>-\n <span style=\"color: #800080;\">09</span>-07T07:\n <span style=\"color: #800080;\">11</span>\n <span style=\"color: #000000;\">:52Z<br /></span>\n <span style=\"color: #008080;\"> 7</span> generation: \n <span style=\"color: #800080;\">1</span>\n <br />\n <span style=\"color: #008080;\"> 8</span> \n <span style=\"color: #000000;\"> labels:<br /></span>\n <span style=\"color: #008080;\"> 9</span> \n <span style=\"color: #000000;\"> app: coffee<br /></span>\n <span style=\"color: #008080;\">10</span> \n <span style=\"color: #000000;\"> name: coffee<br /></span>\n <span style=\"color: #008080;\">11</span> \n <span style=\"color: #0000ff;\">namespace</span>: \n <span style=\"color: #0000ff;\">default</span>\n <br />\n <span style=\"color: #008080;\">12</span> resourceVersion: \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">476161</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">13</span> selfLink: /apis/extensions/v1beta1/namespaces/\n <span style=\"color: #0000ff;\">default</span>/deployments/\n <span style=\"color: #000000;\">coffee<br /></span>\n <span style=\"color: #008080;\">14</span> uid: 4b807ee6-b26d-11e8-b891-fa163eebca40\n</div>\n<p>　　对比一下 ReplicaSet Object 中 ownerReference 标识的 Object 可知，这个 Deployment 是 ReplicaSet 的 owner。至此，我们通过观察三个 Object 中的 ownerReference 的信息，可以建立起如下的「从属关系」：</p>\n<ul>\n <li>Deployment（owner）—&gt; ReplicaSet (dependent)</li>\n <li>ReplicaSet (owner) —&gt; Pod (dependent)</li>\n</ul>\n<p><img class=\"origin_image zh-lightbox-thumb lazy\" style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214212453004-211640216.jpg\" alt=\"\" width=\"811\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"811\" data-rawheight=\"586\" data-original=\"https://pic4.zhimg.com/v2-aa3cf3451a5d190501df2d6cf7b9bd57_r.jpg\" data-actualsrc=\"https://pic4.zhimg.com/v2-aa3cf3451a5d190501df2d6cf7b9bd57_b.jpg\" data-lazy-status=\"ok\" /></p>\n<blockquote>\n <p><em>Q: What is the working mechanism of Garbage Collector?</em></p>\n</blockquote>\n<p>　　一个 Garbage Collector 通常由三部分实现：</p>\n<ul>\n <li>Scanner： 它负责收集目前系统中已存在的 Resource，并且周期性的将这些资源对象放入一个队列中，等待处理（检测是否要对某一个Resource Object 进行 GC 操作）</li>\n <li>Garbage Processor: Garbage Processor 由两部分组成</li>\n <ul>\n  <li>Dirty Queue： Scanner 会将周期性扫描到的 Resource Object 放入这个队列中等待处理</li>\n  <li>Worker：worker 负责从这个队列中取出元素进行处理</li>\n  <ul>\n   <li>检查 Object 的 metaData 部分，查看&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">ownerReference</span>&nbsp;字段是否为空</li>\n   <ul>\n    <li>如果为空，则本次处理结束</li>\n    <li>如果不为空，检测&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">ownerReference</span>&nbsp;字段内标识的 Owner Resource Object是否存在</li>\n    <ul>\n     <li>存在：则本次处理结束</li>\n     <li>不存在：删除这个 Object</li>\n    </ul>\n   </ul>\n  </ul>\n </ul>\n</ul>\n<p>　　其实，在有了 Scanner 和 Garbage Processor 之后，Garbage Collector 就已经能够实现「垃圾回收」的功能了。但是有一个明显的问题：Scanner 的扫描频率设置多少好呢？太长了，k8s 内部就会积累过多的「废弃资源」；太短了，尤其是在集群内部资源对象较多的时候，频繁的拉取信息对 API-Server 也是一个不小的压力。</p>\n<p>　　k8s 作为一个分布式的服务编排系统，其内部执行任何一项逻辑或者行为，都依赖一种机制：「事件驱动」。说的简单点，k8s 中一些看起来「自动」的行为，其实都是由一些神秘的「力量」在驱动着。而这个「力量」就是我们所说的「Event」。任意一个 Resource Object 发生变动的时候（新建，更新，删除），都会触发一个 k8s 的事件（Event），这个事件在 k8s 的内部是公开的，也就是说，我们可以在任意一个地方监听这些事件。</p>\n<p>　　总的来说，无论是「事件的监听机制」还是「周期性访问 API-Server 批量获取 Resource Object 信息」，其目的都是为了能够掌握 Resource Object 的最新信息。两者是各有优势的：</p>\n<ol>\n <li>批量拉取：一次性拉取所有的 Resource Object，全面</li>\n <li>监听 Resource 的 Event：实时性强， 且对 API—SERVER 不会造成太大的压力</li>\n</ol>\n<p>　　综上所述，在实现 Garbage Collector 的过程中，k8s 向其添加了一个「增强型」的组件：Propagator</p>\n<ul>\n <li>Propagator： Propagator 由三个部分构成</li>\n <ul>\n  <li>EventQueue：负责存储 k8s 中资源对象的事件（Eg：ADD，UPDATE，DELETE）</li>\n  <li>DAG(有向无环图)：负责存储 k8s 中所有资源对象的「owner-dependent」 关系</li>\n  <li>Worker：从 EventQueue 中，取出资源对象的事件，根据事件的类型会采取以下两种操作</li>\n  <ul>\n   <li>ADD/UPDATE: 将该事件对应的资源对象加入 DAG，且如果该对象有 owner 且 owner 不在 DAG 中，将它同时加入 Garbage Processor 的 Dirty Queue 中</li>\n   <li>DELETE：将该事件对应的资源对象从 DAG 中删除，并且将其「管辖」的对象（只向下寻找一级，如删除 Deployment，那么只操作 ReplicaSet ）加入 Garbage Processor 的 Dirty Queue 中</li>\n  </ul>\n </ul>\n</ul>\n<p>　　在有了 Propagator 的加入之后，我们完全可以仅在 GC 开始运行的时候，让 Scanner 扫描一下系统中所有的 Object，然后将这些信息传递给 Propagator 和 Dirty Queue。只要 DAG 一建立起来之后，那么 Scanner 其实就没有再工作的必要了。「事件驱动」的机制提供了一种增量的方式让 GC 来监控 k8s 集群内部的资源对象变化情况。</p>\n<blockquote>\n <p><em>Q: How can I delete the owner and reserve dependents ?</em></p>\n</blockquote>\n<p><em>　　没错，需求就是这么奇怪，k8s 还兼容一种情况：删除 owner，留下 dependents。剩余的 dependents 被称为是「orphan」</em></p>\n<p><strong>　　你想怎么实现?</strong></p>\n<p>　　如果暂时先不看设计文档中关于这部分的内容，根据之前对 k8s GC 的了解，让你来实现这个功能，你会怎么做呢？这里给出一下笔者的想法：</p>\n<p>　　首先，我们先来根据上面对于 GC 的了解，给出一幅大致架构图：</p>\n<p><img class=\"origin_image zh-lightbox-thumb lazy\" style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214213013527-827332693.jpg\" alt=\"\" width=\"1068\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1068\" data-rawheight=\"797\" data-original=\"https://pic2.zhimg.com/v2-c590e54eca8035f4b70144299a9487e5_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-c590e54eca8035f4b70144299a9487e5_b.jpg\" data-lazy-status=\"ok\" /></p>\n<p class=\"ztext-empty-paragraph\">&nbsp;</p>\n<p>　　在上图中，我用三种颜色分别标记了三条较为重要的处理过程：</p>\n<ul>\n <li>红色：worker 从 dirtyQueue 中取出资源对象，检查其是否带有 owner ，如果没带，则不处理。否则检测其 owner是否存在，存在，则处理下一个资源对象，不存在，删除这个 object。</li>\n <li>绿色： scanner 从 api-server 中扫描存在于 k8s 集群中的资源对象并加入至 dirtyQueue</li>\n <li>粉色：propagator.worker 从 eventQueue 中取出相应的事件并且获得对应的资源对象，根据事件的类型以及相应资源对象所属 owner 对象的情况来进行判定，是否要进行两个操作：</li>\n <ul>\n  <li>从 DAG 中删除相应节点（多为响应 DELETE 事件的逻辑）</li>\n  <li>将有级联关系但是 owner 不存在的对象送入 diryQueue 中</li>\n </ul>\n</ul>\n<p>　　其中红色是「数据处理」过程，而绿色和粉色是「数据收集」的过程。在「数据处理」的过程中（即我们上面分析过的 GC 的 Worker 的工作过程），worker 做的较为重要的工作有两步：</p>\n<ul>\n <li>检查资源对象信息的「ownerReference」字段，判断其是否处在一个级联关系中</li>\n <li>若资源对象有所属 owner 且不存在，则删除这个对象</li>\n</ul>\n<p>　　此时，回头看下我们的需求:「owner 删除，dependents 留下」。如果想在「数据处理」这条链路上做些修改达到我们目的的话，唯一可行的办法就是：在删除了 dependents 对应的 owner 对象之后，同时删除 dependents 信息中 「ownerReference」字段和对应的值。这样一来，在检测资源对象是否应该被删除的过程就会因为其没有「ownerReference」字段而放过它，最终实现了 dependents 对象的“孤立”。</p>\n<p><strong>　　k8s 是怎么实现的?</strong></p>\n<p><em>　　如果你了解 gRPC-intercepter 的工作机制，那么会加快你理解下面的内容</em></p>\n<p>　　k8s 在系统内部实现了一种类似「删除拦截器链」的机制：即在删除某个资源对象的「删除链路」上，执行一个或多个「拦截逻辑」。并且这种「拦截逻辑」可以自主实现，然后像插件一样注入到这个删除链路上。这种机制在 k8s 当中统称为：&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Finalizers</span>&nbsp;。</p>\n<p>　　&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Finalizers</span>&nbsp;的声明非常简单，就是一个&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">[]<span style=\"color: #0000ff;\">string</span></span>&nbsp;。这个 Slice 的内部填充的是要执行拦截器的名称。它存在于任何一个资源对象的 Meta 信息中:&nbsp;<a class=\" wrap external\" href=\"https://link.zhihu.com/?target=https%3A//github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/types.go%23L246\" rel=\"nofollow noreferrer\" target=\"_blank\" data-za-detail-view-id=\"1043\">apimachinery/types.go at master · kubernetes/apimachinery · GitHub</a>。</p>\n<p><code>　　&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Finalizers</span>&nbsp;</code>中的拦截器在其宿主资源对象触发删除操作之后顺序执行（资源对象的deletionTimestamp不为 nil），每执行完一个，就会从&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Finalizers</span>&nbsp;中移除一个，直到&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Finalizers</span>&nbsp;为空的 Slice，其宿主资源对象才可以被真正的删除。</p>\n<p>　　于「删除 owner 但是不删除 dependents」 的需求，k8s 则是实现了一个：orphan finalizer。一般情况下，正常利用 GC 级连删除一个资源对象是不会涉及到 orphan finalizer 的。它执行的是我们之前提到的 GC 的工作逻辑。如果你想启用这个特性，就需要在删除资源对象的时候，根据 K8s 版本的不同，将名为&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">DeleteOption.OrphanDependents</span>&nbsp;的参数赋值为 True（1.7版本以前）</p>\n<p>　　或者将&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">DeleteOption.PropagationPolicy</span>&nbsp;参数赋值为&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">metav1.DeletePropagationOrphan</span>&nbsp;：<a class=\" wrap external\" href=\"https://link.zhihu.com/?target=https%3A//github.com/kubernetes/apimachinery/blob/9dc1de72c0f3996657ffc88895f89f3844d8cf01/pkg/apis/meta/v1/types.go%23L457\" rel=\"nofollow noreferrer\" target=\"_blank\" data-za-detail-view-id=\"1043\">apimachinery/types.go at 9dc1de72c0f3996657ffc88895f89f3844d8cf01 · kubernetes/apimachinery · GitHub</a>。</p>\n<p>　　通过这个参数的注释也可以看出：如果设置好之后，将会在它的 Finalizers 中加入 orphan finalizer。而加入 orphan finalizer 这部分的逻辑是在 api-server 的 package 中：<a class=\" wrap external\" href=\"https://link.zhihu.com/?target=https%3A//github.com/kubernetes/apiserver/blob/master/pkg/registry/generic/registry/store.go%23L719\" rel=\"nofollow noreferrer\" target=\"_blank\" data-za-detail-view-id=\"1043\">apiserver/store.go at master · kubernetes/apiserver · GitHub</a></p>\n<p>　　加入了 orphan finalizer 之后，在 GC 的 worker 从 dirtyQueue 中取出 owner 资源对象进行处理的时候，就会执行它的逻辑：删除 dependents 的 OwnerReference 部分：&nbsp;<a class=\" wrap external\" href=\"https://link.zhihu.com/?target=https%3A//github.com/kubernetes/kubernetes/blob/0972ce1accf859b73abb5a68c0adf4174245d4bf/pkg/controller/garbagecollector/garbagecollector.go%23L543\" rel=\"nofollow noreferrer\" target=\"_blank\" data-za-detail-view-id=\"1043\">kubernetes/garbagecollector.go at 0972ce1accf859b73abb5a68c0adf4174245d4bf · kubernetes/kubernetes · GitHub</a>。最终，在「保留 dependents」 的逻辑完成之后，orphan finalizer 也会从相应资源对象的&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Finalizers</span>&nbsp;中删除。</p>\n<p><strong>　　一个隐含的 Race 问题</strong></p>\n<p>　　对于 Controller 来说，它会周期性的通过 Selector 来寻找它所创建的资源。</p>\n<p>　　如果在筛选到了符合自己 label 的 资源，但是发现它的 Meta.OwnerReference 字段中没有自己相关的信息的时候，就会执行一个<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Adoption</span>&nbsp;的操作，也就是将和自己有关的 OwnerReference 信息注入到这个 Pod 的 Meta 部分。这种逻辑虽然看起来是比较「保险」，但是实际上它和 orphan finalizer 的逻辑是有冲突的。前者是对 dependents 增加 OwnerReference 信息， 后者则是删除它。两个逻辑在执行的时候，如果不保证「互斥」的话，很可能就会出现一个很严重的竞争问题：指定了 orphan finalizer 的 对象，其 dependents 最终也会被删除。</p>\n<p>　　借鉴操作系统对于「竞争」问题的处理方式，对 OwnerReference操作的的逻辑（即临界区），应该被「互斥」机制保护起来。而在 k8s 中，实现这种互斥保护机制的方式也很简单：Controller 在想执行 Adoption 操作之前，会检查一下当前资源对象的meta.DeletionTimestamp。如果这个字段的值为非 nil，那么就证明这个资源对象已经在被删除中了。所以就不会再继续执行 Adoption 操作。</p>\n<p>　　但是仔细想一下，这种「互斥」保护机制的实现方式，看起来是借助了一个「锁变量」(meta.DeletionTimestamp)的帮助。不过，我们并不需要担心这个字段的「竞争」问题，因为能修改它的操作，只有「删除」操作，而删除操作是肯定会发生在 orphan finalizer 执行之前的。也就是说，当 orphan finalizer 执行的时候，这个值早就被设置进去了。&nbsp;<a class=\" wrap external\" href=\"https://link.zhihu.com/?target=https%3A//github.com/kubernetes/kubernetes/blob/7f23a743e8c23ac6489340bbb34fa6f1d392db9d/pkg/controller/replicaset/replica_set.go%23L644\" rel=\"nofollow noreferrer\" target=\"_blank\" data-za-detail-view-id=\"1043\">kubernetes/replica_set.go at 7f23a743e8c23ac6489340bbb34fa6f1d392db9d · kubernetes/kubernetes · GitHub</a></p>\n<blockquote>\n <p><em>Q: How Kubernetes defines delete operation of resource object?</em></p>\n</blockquote>\n<p>　　K8s 在对资源对象「删除」操作的定义上，思考了一个较为重要的问题：「删除」操作真正完成的标志是什么？（达到什么样的条件才可以通知用户「删除」操作成功）。这个问题出现的源头是在用户侧，当用户在使用 k8s 提供的资源对象的「删除」操作时，有个问题会影响到他们：</p>\n<ol>\n <li>「删除」操作成功多久后才可以在同一个 ns 下创建同名资源对象？</li>\n</ol>\n<p>　　如果你了解过构建一个 k8s 集群所需要的服务组件，就可以很清楚的知道：k8s 中的资源对象的信息都是存于一个key-value 的数据库当中的（etcd），且是以名字来做索引的。</p>\n<p>　　通过命令行&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">kubectl <span style=\"color: #0000ff;\">get</span> xxx</span>&nbsp;查询的资源对象的信息都来自于那。而且，当&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">kubelet</span>&nbsp;组件删除掉其所在节点上的一些资源的时候，会调用 API-Server 提供的接口删除掉key-value 数据库中相应的记录。所以，在 k8s 中，给「删除」操作下了这样一个定义：</p>\n<blockquote>\n <p>在没有 orphanFinalizer 参与的前提下，直到被删除对象及其「管辖」对象的信息在 key-value 数据库中都被清除，才认为该对象真正的被 GC 回收。即达到了返回给用户「删除成功」的标准。</p>\n</blockquote>\n<p>　　本质上来说，上述所表示的删除操作是「同步」的。因为有「级联关系」（owner-dependent） 关系的存在，删除一个资源对象往往影响的不是他自己，还有他的 dependents。只有将因它出现的所有资源都删除，才可以认为这个对象被删除了。</p>\n<p>　　若想指定这种同步的删除模式，需要在两个不同的位置设置两个参数：</p>\n<ol>\n <li>dependents 对象 meta 信息中 OwnerReference.BlockOwnerDeletion</li>\n <li>在发送删除对象请求时，设置 DeleteOptions.PropagationPolicy</li>\n</ol>\n<p><code>　　&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">OwnerReference.BlockOwnerDeletion</span>&nbsp;</code>参数大多数情况下在相应的 dependents 对象创建的时候就设置进去了。</p>\n<p>　　如果想在 dependents 对象创建之后更新这个参数的值，可能需要使用&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">admission controller</span>&nbsp;&nbsp;(1.7及以上版本)提供的一些权限相关的功能。</p>\n<p><code>　　&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">DeleteOptions.PropagationPolicy</span>&nbsp;</code>一共有3个候选值：</p>\n<div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n <span style=\"color: #008080;\"> 1</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> DeletionPropagation decides if a deletion will propagate to the dependents of<br /></span>\n <span style=\"color: #008080;\"> 2</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> the object, and how the garbage collector will handle the propagation.</span>\n <br />\n <span style=\"color: #008080;\"> 3</span> type DeletionPropagation \n <span style=\"color: #0000ff;\">string</span>\n <br />\n <span style=\"color: #008080;\"> 4</span> \n <br />\n <span style=\"color: #008080;\"> 5</span> \n <span style=\"color: #0000ff;\">const</span>\n <span style=\"color: #000000;\"> (<br /></span>\n <span style=\"color: #008080;\"> 6</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> Orphans the dependents.</span>\n <br />\n <span style=\"color: #008080;\"> 7</span> DeletePropagationOrphan DeletionPropagation = \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">Orphan</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\"> 8</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> Deletes the object from the key-value store, the garbage collector will<br /></span>\n <span style=\"color: #008080;\"> 9</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> delete the dependents in the background.</span>\n <br />\n <span style=\"color: #008080;\">10</span> DeletePropagationBackground DeletionPropagation = \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">Background</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">11</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> The object exists in the key-value store until the garbage collector<br /></span>\n <span style=\"color: #008080;\">12</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> deletes all the dependents whose ownerReference.blockOwnerDeletion=true<br /></span>\n <span style=\"color: #008080;\">13</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> from the key-value store. API sever will put the \"foregroundDeletion\"<br /></span>\n <span style=\"color: #008080;\">14</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> finalizer on the object, and sets its deletionTimestamp. This policy is<br /></span>\n <span style=\"color: #008080;\">15</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> cascading, i.e., the dependents will be deleted with Foreground.</span>\n <br />\n <span style=\"color: #008080;\">16</span> DeletePropagationForeground DeletionPropagation = \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">Foreground</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">17</span> )\n</div>\n<p>　　再结合&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">OwnerReference.BlockOwnerDeletion</span>&nbsp;参数的注释</p>\n<div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n <span style=\"color: #008080;\">1</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> If true, AND if the owner has the \"foregroundDeletion\" finalizer, then<br /></span>\n <span style=\"color: #008080;\">2</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> the owner cannot be deleted from the key-value store until this<br /></span>\n <span style=\"color: #008080;\">3</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> reference is removed.<br /></span>\n <span style=\"color: #008080;\">4</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> Defaults to false.<br /></span>\n <span style=\"color: #008080;\">5</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> To set this field, a user needs \"delete\" permission of the owner,<br /></span>\n <span style=\"color: #008080;\">6</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> otherwise 422 (Unprocessable Entity) will be returned.<br /></span>\n <span style=\"color: #008080;\">7</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> +optional</span>\n <br />\n <span style=\"color: #008080;\">8</span> BlockOwnerDeletion *\n <span style=\"color: #0000ff;\">bool</span> `json:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">blockOwnerDeletion,omitempty</span>\n <span style=\"color: #800000;\">\"</span> protobuf:\n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">varint,7,opt,name=blockOwnerDeletion</span>\n <span style=\"color: #800000;\">\"</span>`\n</div>\n<p>　　我们可以了解到。同步删除的开启方式如下：</p>\n<ol>\n <li>DeleteOptions.PropagationPolicy = DeletePropagationForeground</li>\n <li>OwnerReference. BlockOwnerDeletion = True</li>\n</ol>\n<p>　　开启之后，在删除身份为 owner 的资源对象的时候，就会先将 denpendents 对象中&nbsp;OwnerReference.BlockOwnerDeletion&nbsp;为 true 的资源对象先删除，然后再删除 owner 身份的对象。这里的「删除」就指的是我们前面说过的「真正的删除」：从 k8s 存储资源对象信息的 key-value 数据库中删除所有与其相关的信息。需要注意的是，&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">OwnerReference.BlockOwnerDeletion</span>&nbsp;为 false 的dependent 对象不会阻碍 owner 对象的删除操作。</p>\n<p>　　Foreground 是 k8s 提供的两种级联删除方式其中之一，另外一种为 Background。通过上面相关的注释可以看到 Foreground 级联删除也是通过 Finalizer 来实现的，查看 Finalizer 相关的定义可知，标准的 Finalizer，一个是 orphan 的，另一个就是Foreground的：</p>\n<div style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">\n <span style=\"color: #008080;\">1</span> \n <span style=\"color: #008000;\">//</span>\n <span style=\"color: #008000;\"> These are internal finalizer values for Kubernetes-like APIs, must be qualified name unless defined here</span>\n <br />\n <span style=\"color: #008080;\">2</span> \n <span style=\"color: #0000ff;\">const</span>\n <span style=\"color: #000000;\"> (<br /></span>\n <span style=\"color: #008080;\">3</span> FinalizerOrphanDependents \n <span style=\"color: #0000ff;\">string</span> = \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">orphan</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">4</span> FinalizerDeleteDependents \n <span style=\"color: #0000ff;\">string</span> = \n <span style=\"color: #800000;\">\"</span>\n <span style=\"color: #800000;\">foregroundDeletion</span>\n <span style=\"color: #800000;\">\"</span>\n <br />\n <span style=\"color: #008080;\">5</span> )\n</div>\n<p>　　API-Server 的&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">Delete</span>&nbsp;函数，在接受到删除请求的时候，会检查&nbsp;DeleteOptions.PropagationPolicy&nbsp;参数，若其值为&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">DeletePropagationForeground</span>&nbsp;, API-Server 随即会对该资源对象进行 Update 操作：</p>\n<ol>\n <li>插入&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">FinalizerDeleteDependents</span>&nbsp;&nbsp;Finalizer</li>\n <li>设置&nbsp;<span style=\"background-color: #F5F5F5;border: 1px solid #CCCCCC;padding:10px;\">ObjectMeta.DeletionTimestamp </span>&nbsp;为当前值</li>\n</ol>\n<p>　　然后，在 GC 处理 owner 对象的 Update 事件的逻辑中，还会给 owner 对象打上一个「正在删除 dependents」 对象的标签。之后，我们会将 owner 对象管辖的 dependent 对象和他自己都加入到 dirtyQueue。dirtyQueue 的 worker 在处理 owner 对象的时候，会检查 owner 对象 「正在删除 dependents」的标签是否存在，如果仍有 dependent 对象没有被删掉，owner 会被轮询处理。而 dependent 对象将会被正常删除。当 dependent 对象相应的删除事件被 Propagator 感知到后，会将其从 DAG 和其 owner 的 dependents 信息中删除。几个循环之后，dependents 机会被删光，而 owner 对象中的 finalizer 和自身也会随之被删掉。</p>\n<p>　　Background 模式的级联删除不会因 dependent 对象而影响 owner 对象的删除操作。当我们发送给 API-Server 删除一个 owner 身份的对象的请求之后，这个资源对象会立即被删除。它「管辖」的 dependent 对象会以「静默」的方式删除。</p>\n<blockquote>\n <p><em>Q: What problems GC handles in k8s?</em></p>\n</blockquote>\n<p>　　通过对 k8s GC 设计文档的阅读，可以大致的概括一下：GC 主要是按照用户的需求来清理系统中「异常」的资源，用户可以自定义「清理方式」和「清理策略」。不难发现，在 GC 中，到底是保留一个资源还是删除一个资源都参照了资源之间的「从属关系」。资源的「从属关系」可以大致分为几个形态：</p>\n<ol>\n <li>无从属关系：这部分资源基本不会被 GC 做处理</li>\n <li>有从属关系</li>\n <ol>\n  <li>不符合用户预期：删除异常资源</li>\n  <li>符合用户预期：解绑异常资源之间的级联关系</li>\n </ol>\n</ol>\n<p>　　在有从属关系的资源之间，即使被探测到关系异常，也并不代表一定要将他们都清除。如果有 Orphan Finalizer 的存在，可能某种「异常」正是用户想要的。所以，这就回到了我们一开始所说到的「清理策略」问题。GC 有一定的默认的清理策略，但是用户可以通过加入 Finalizer 的形式来修改「清理策略」，从而保持一个「符合用户期望」的资源之间的从属关系。</p>\n<p>　　同时，用户可以还可以通过参数来制定特定的「清理方式」，如 Foreground 或者 Background。总体上来说，GC 的行为会受到如下几个因素的影响：</p>\n<ul>\n <li>默认：</li>\n <ul>\n  <li>依据：资源之间默认的从属关系</li>\n  <li>行为：删除级联关系异常的资源</li>\n  <li>方式：Foreground 或者 Background</li>\n </ul>\n</ul>\n<ul>\n <li>可定制</li>\n <ul>\n  <li>依据：用户定义的从属关系（通过 Finalizer）</li>\n  <li>行为：删除级联关系异常的资源</li>\n  <li>方式：Foreground 或者 Background</li>\n </ul>\n</ul>\n<p>　　目前看来，GC 主要是解决了「资源清理」 的问题。那么再抽象一点来看的话，GC 解决的是「资源管理」这个大问题中的一个关于「清理」的小问题。既然说到「资源管理」，那么肯定就不止「清理」一个问题需要处理：</p>\n<p><img class=\"origin_image zh-lightbox-thumb lazy\" style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214214427792-2114717553.jpg\" alt=\"\" width=\"1998\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1998\" data-rawheight=\"1532\" data-original=\"https://pic3.zhimg.com/v2-98ec16ca74c686aca3525f471616006e_r.jpg\" data-actualsrc=\"https://pic3.zhimg.com/v2-98ec16ca74c686aca3525f471616006e_b.jpg\" data-lazy-status=\"ok\" /></p>\n<p class=\"ztext-empty-paragraph\">&nbsp;</p>\n<p>　　其中，对于资源的创建部分，除了正常的新建操作之外，controller 还有定期执行一个「Adoption」 的操作，用来维护其创建的资源之间那些「本应该建立但是却断开的从属关系」。而对于更新操作来说，controller_manager 需要处理用户对于资源的扩缩容请求，如将 deployment.replicaset.replicacount 减少或者增大，相应资源对应的 controller 需要对可见资源的数量进行调整。至于「资源超卖」的问题，一定会涉及到 scheduler。因为物理资源是固定的，「超卖」本质上来说就是按照实时的需求，动态的调整服务所在的 Node，以便恰好满足服务对于资源的需求。</p>\n<p>　　如果不把资源管理问题讨论的范围局限在 k8s 中的话，那么「审计」和「复用」同样也是「资源管理」问题中不得不考虑的两个点。前者可以增加整个系统资源的「可控性」，后者则可以最大限度的提升资源的利用率，从而降低成本。其实「复用」和「超卖」的目的是一样的，都是想最大限度的利用物理资源。不过这两个功能笔者暂时还没有去查看它们是否在 k8s 已经实现。</p>\n<p><strong>　　总结</strong></p>\n<p>　　之所以去了解 k8s 的 GC，是因为在将 k8s 集群从1.7版本升级至1.9版本的过程中，因为我错误的设置了资源之间的从属关系，导致该资源被 GC 给回收掉了。问题在1.7版本没有出现的原因是那时 k8s 还没有支持对自定义资源（CRD）的级联删除。通过对 GC 设计理念的了解，我们可以初步的感受到 k8s 对于「资源管理」这个问题域中「资源清理」这个小问题的解决思路。以此为起点，我们可以顺藤摸瓜，去观察 k8s 对于「资源管理」问题域中的其他难题是如何处理的。后续，我也将会根据设计文档中的思路，在代码级别上去了解 GC 的实现细节，从而贡献出更加详细的 blog。</p>","descriptionType":"html","publishedDate":"Sat, 14 Dec 2019 15:31:38 +0000","feedId":11665,"bgimg":"","linkMd5":"0b26462e72b48901f1b66ef9a08866cf","bgimgJsdelivr":"","metaImg":"","author":"","articleImgCdnMap":{"https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214212453004-211640216.jpg":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn55@2020_3/2020/08/25/01-34-00-864_003624186bba9bbb.webp","https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214213013527-827332693.jpg":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn71@2020_3/2020/08/25/01-33-56-415_0bf82cf17ef782c6.webp","https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214214427792-2114717553.jpg":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn27@2020_5/2020/08/25/01-33-56-443_7ddcf8f610944d06.webp"},"publishedOrCreatedDate":1598319223184},{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","title":"推荐系统的架构","link":"http://kb.cnblogs.com/page/662938/","description":"<p>　　本文从互联网收集并整理了推荐系统的架构，其中包括一些大公司的推荐系统框架（数据流存储、计算、模型应用），可以参考这些资料，取长补短，最后根据自己的业务需求，技术选型来设计相应的框架。后续持续更新并收集。。。</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/blog/568636/201402/261557521663748.png\" alt=\"\" /></p>\n<p style=\"text-align: center;\">图1</p>\n<p>　　界面UI那一块包含3块东西：1) 通过一定方式展示推荐物品(物品标题、缩略图、简介等)；2) 给的推荐理由；3) 数据反馈改进个性化推荐；关于用户数据的存放地方：1)数据库/缓存用来实时取数据；2) hdfs文件上面；</p>\n<p>　　抽象出来的三种推荐方式</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/blog/568636/201402/261558030273600.png\" alt=\"\" /></p>\n<p style=\"text-align: center;\">图2</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/blog/568636/201402/261558133703892.png\" alt=\"\" /></p>\n<p style=\"text-align: center;\">图3</p>\n<p>　　图3中，推荐引擎的构建来源于不同的数据源(也就是用户的特征有很多种类，例如统计的、行为的、主题的)+不同的推荐模型算法，推荐引擎的架构可以试多样化的(实时推荐的+离线推荐的)，然后融合推荐结果（人工规则+模型结果），融合方式多样的，有线性加权的或者切换式的等</p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/blog/568636/201402/261558231495314.png\" alt=\"\" /></p>\n<p style=\"text-align: center;\">图4</p>\n<p>　　图4中，A模块负责用户各类型特征的收集，B模块的相关表是根据图3中的推荐引擎来生成的，B模块的输出推荐结果用来C模块的输入，中间经过过滤模块(用户已经产生行为的物品，非候选物品，业务方提供的物品黑名单等)，排名模块也根据预设定的推荐目标来制定，最后推荐解释的生成（这是可能是最容易忽视，但很关键的一环，微信的好友推荐游戏，这一解释已经胜过后台的算法作用了）</p>\n<p><span style=\"font-size: 18px;\"><strong>HULU的推荐系统</strong></span></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/blog/568636/201402/261558471321974.png\" alt=\"\" />&nbsp; &nbsp; &nbsp;&nbsp;</p>\n<p>　　总结：这个也就跟图3有点类似了，葫芦的推荐系统，至少在他blog中写的比较简单。更多的是对推荐系统在线部分的一种描述，离线部分我猜想也是通过分布式计算或者不同的计算方式将算法产生的数据存储进入一种介质中，供推荐系统在线部分调用。系统的整个流程是这样的，首先获取用户的行为，包括(watch、subscribe、vote)，这样行为会到后台获取show-show对应的推荐数据。同时这些行为也会产生对应的topic，系统也会根据topic到后台获取topic-show对应的推荐数据。两种数据进行混合，然后经过fliter、explanation、ranking这一系列过程，最后生成用户看到的推荐数据。</p>\n<p><span style=\"font-size: 18px;\"><strong>淘宝的推荐系统(详细跟简单版)</strong></span></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/blog/568636/201402/261558580734083.png\" alt=\"\" /></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/blog/568636/201402/261559110965092.png\" alt=\"\" /></p>\n<p>　　总结：淘宝的推荐系统，描述了推荐引擎搭建的整体架构，包括离线的分布式计算和存储、监控、数据统计和分析、实验平台等。给我们搭建推荐引擎提供了很好的建议。整体流程大致这样。通过后台的分布式计算，将算法产生的算法结果数据存储进入一种介质中，首推hbase。然后，通过一种叫做云梯的机制将算法结果推入中间层介质中，供推荐系统在线部分调用。在线部分提供引擎和实验分流，用户的行为将存储进入hadoop中，数据统计分析平台由hive来搭建，主要用来分析和统计hadoop中的用户行为log。这张图不仅讲了，推荐系统的架构流程，也讲了跟这个平台有关系的人，是怎么介入的，我觉得提供的信息可很好的参考。</p>\n<p><span style=\"font-size: 18px;\"><strong>Netflix的推荐系统</strong></span></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/blog/568636/201402/261559277343677.png\" alt=\"\" /></p>\n<p>　　总结：netflix的推荐系统，描述了推荐引擎搭建的整体架构，采用了三种计算方式的结合。整体流程：用户通过UI产生事件跟行为，然后分发给离线（我理解的是按天存储）、近线存储（不提供历史，存储当天用户实时行为。不知道理解是否有误），离线的计算利用离线的数据建好模型供实时调用，近线的计算利用用户的实时行为计算得出规则供实时调用，最后在线的计算通过前两种方式来得到最终的推荐结果，关键问题，就是如何以无缝方式结合、管理在线和离线计算过程，当然找到这些要求之间恰当的平衡并不容易，需要深思熟虑的需求分析，细心的技术选择，战略性的推荐算法分解，最终才能为客户达成最佳的结果。</p>\n<p><span style=\"font-size: 18px;\"><strong>优酷</strong><strong>的推荐系统</strong></span></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/i/568636/201402/272011015588144.png\" alt=\"\" /></p>\n<p>　　备注：上图来至easyhadoop举办的技术沙龙中优酷数据挖掘工程师的演讲，有关详细信息请移步 http://virtual.51cto.com/exp/Hadoop_20130330/index.html#top。作者在演讲中讲的一些\"干货\"跟推荐议题是很有价值的，下图简单描述。</p>\n<p><span style=\"font-size: 18px;\"><strong>模型前数据准备(理解数据源，用户，物品)</strong></span></p>\n<p><strong><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/i/568636/201402/272011243838819.png\" alt=\"\" /></strong></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/i/568636/201402/272011298214981.png\" alt=\"\" /></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/i/568636/201402/272011364236128.png\" alt=\"\" /></p>\n<p><span style=\"font-size: 18px;\"><strong>模型策略</strong></span></p>\n<p><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/i/568636/201402/272011499981710.png\" alt=\"\" /></p>\n<p><strong><span style=\"font-size: 18px;\">其他考虑的场景</span><img style=\"display: block; margin-left: auto; margin-right: auto;\" src=\"https://images0.cnblogs.com/i/568636/201402/272011592351032.png\" alt=\"\" /></strong></p>\n<p>　　参考资料：推荐系统实践，互联网资料</p>","descriptionType":"html","publishedDate":"Thu, 28 May 2020 08:45:08 +0000","feedId":11665,"bgimg":"https://images0.cnblogs.com/blog/568636/201402/261557521663748.png","linkMd5":"899abe6b8a3c66b5966d8229e6dcccc2","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn22@2020_6/2020/08/25/01-33-51-864_17ff295a6a1c28a3.webp","destWidth":894,"destHeight":237,"sourceBytes":20747,"destBytes":12554,"author":"","articleImgCdnMap":{"https://images0.cnblogs.com/blog/568636/201402/261557521663748.png":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn22@2020_6/2020/08/25/01-33-51-864_17ff295a6a1c28a3.webp","https://images0.cnblogs.com/blog/568636/201402/261558030273600.png":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn77@2020_2/2020/08/25/01-33-56-240_66e9b462fdfb32ee.webp","https://images0.cnblogs.com/blog/568636/201402/261558133703892.png":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn95@2020_2/2020/08/25/01-33-56-717_960c0361a1130346.webp","https://images0.cnblogs.com/blog/568636/201402/261558231495314.png":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn83@2020_1/2020/08/25/01-33-57-442_d8b674b5dd8c6cfb.webp","https://images0.cnblogs.com/blog/568636/201402/261558471321974.png":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn44@2020_4/2020/08/25/01-33-57-035_169b2c58273c2bc4.webp","https://images0.cnblogs.com/blog/568636/201402/261558580734083.png":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn67@2020_1/2020/08/25/01-33-57-331_49f4372adef52a23.webp","https://images0.cnblogs.com/blog/568636/201402/261559110965092.png":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn47@2020_5/2020/08/25/01-33-59-758_e9c78d46df710519.webp","https://images0.cnblogs.com/blog/568636/201402/261559277343677.png":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn44@2020_4/2020/08/25/01-34-00-518_3e84aacf1960fd1e.webp","https://images0.cnblogs.com/i/568636/201402/272011015588144.png":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn16@2020_4/2020/08/25/01-33-56-514_a09f99d099fb3667.webp","https://images0.cnblogs.com/i/568636/201402/272011243838819.png":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn23@2020_4/2020/08/25/01-33-56-280_87a58e9656b1a335.webp","https://images0.cnblogs.com/i/568636/201402/272011298214981.png":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn64@2020_5/2020/08/25/01-33-56-194_9a46c9393e99f7d0.webp","https://images0.cnblogs.com/i/568636/201402/272011364236128.png":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn32@2020_5/2020/08/25/01-33-57-427_05063362e1c32527.webp","https://images0.cnblogs.com/i/568636/201402/272011499981710.png":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn71@2020_3/2020/08/25/01-33-56-521_b63d885a686bc385.webp","https://images0.cnblogs.com/i/568636/201402/272011592351032.png":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn75@2020_1/2020/08/25/01-33-56-093_f1b300fc774a2a95.webp"},"publishedOrCreatedDate":1598319223178}],"record":{"createdTime":"2020-08-25 09:33:43","updatedTime":"2020-08-25 09:33:43","feedId":11665,"fetchDate":"Tue, 25 Aug 2020 01:33:43 +0000","fetchMs":978,"handleMs":5489,"totalMs":30762,"newArticles":0,"totalArticles":10,"status":1,"type":0,"ip":"54.198.12.21","hostName":"us-53.herokuapp.com","requestId":"2a57f014a9d246bd9d949f417963e3eb_11665","contentType":"application/xml; charset=utf-8","totalBytes":1622992,"bgimgsTotal":7,"bgimgsGithubTotal":6,"articlesImgsTotal":61,"articlesImgsGithubTotal":49,"successGithubMap":{"myreaderx14":1,"myreaderx8":2,"myreaderx7":2,"myreaderx15":2,"myreaderx6":3,"myreaderx16":1,"myreaderx10":2,"myreaderx32":2,"myreaderx4":1,"myreaderx11":3,"myreaderx3":2,"myreaderx33":1,"myreaderx12":2,"myreaderx13":2,"myreaderx1":1,"myreaderx30":1,"myreaderx31":2,"myreaderx18":1,"myreaderx19":1,"myreaderx":1,"myreaderx25":1,"myreaderx27":2,"myreaderx21":2,"myreaderx22":2,"myreaderx23":1,"myreaderx24":2,"myreaderx5oss":2,"myreaderx29":3},"failGithubMap":{}},"feed":{"createdTime":"2020-08-25 04:36:57","updatedTime":"2020-08-25 04:36:57","id":11665,"name":"博客园_知识库","url":"http://feed.cnblogs.com/kb/","subscriber":null,"website":null,"icon":"http://common.cnblogs.com/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx63/cdn52@2020_2/2020/08/25/01-33-42-395_80b651675565e225.png","description":"代码改变世界","weekly":null,"link":"http://kb.cnblogs.com"},"noPictureArticleList":[{"createdTime":"2020-08-25 09:34:02","updatedTime":"2020-08-25 09:34:02","id":null,"feedId":11665,"linkMd5":"cb048ef412c5ec36a5d9347e830fa460"}],"tmpCommonImgCdnBytes":221690,"tmpBodyImgCdnBytes":1401302,"tmpBgImgCdnBytes":0,"extra4":{"start":1598319211925,"total":0,"statList":[{"spend":5777,"msg":"获取xml内容"},{"spend":5489,"msg":"解释文章"},{"spend":2,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":9009,"msg":"正文链接上传到cdn"}]},"extra5":61,"extra6":61,"extra7ImgCdnFailResultVector":[{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/5da0baeb-0324-4518-b8b5-aa8f2a067bbb.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1559,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:48","host":"us-005*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460,cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/5da0baeb-0324-4518-b8b5-aa8f2a067bbb.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1383,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:50","host":"europe21*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460,cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/29773cfd-8594-4770-8d44-6fb3b9d6a2c0.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1357,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:53","host":"us-040*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/8a2948d1-f3c9-4125-b794-2b41ad24e109.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1424,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:53","host":"us-012*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/3ec514b6-7b4a-4c09-875b-ccefe3cbffb2.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1373,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:53","host":"europe21*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/bbc550e2-5508-4c08-9a50-a3a19294eb58.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1481,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:53","host":"us-036*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/1cbd8de1-1aa8-41ce-8229-d2b158a2ede1.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1490,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:53","host":"us-004*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/0450d6fd-e391-40ad-b8f1-461bb6e7e44a.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1438,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:53","host":"europe-25*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/6b29f841-6ec4-4860-9dd7-bf41dd8993f1.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1915,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:53","host":"us-008*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/d6f6c9e5-97d7-464e-9186-00e776b64888.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1774,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:54","host":"us-032*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/8a2948d1-f3c9-4125-b794-2b41ad24e109.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1282,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:55","host":"europe-57*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/bbc550e2-5508-4c08-9a50-a3a19294eb58.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1320,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:55","host":"us-030*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/3ec514b6-7b4a-4c09-875b-ccefe3cbffb2.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1364,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:55","host":"us-013*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/1cbd8de1-1aa8-41ce-8229-d2b158a2ede1.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1478,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:55","host":"us-55*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/0450d6fd-e391-40ad-b8f1-461bb6e7e44a.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1361,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:55","host":"europe67*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/29773cfd-8594-4770-8d44-6fb3b9d6a2c0.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1679,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:55","host":"europe-23*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/6b29f841-6ec4-4860-9dd7-bf41dd8993f1.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1433,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:55","host":"us-015*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/d6f6c9e5-97d7-464e-9186-00e776b64888.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1632,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:55","host":"europe-59*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/544dafd1-0bda-4bb0-a48c-34bfc0c2c8a7.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1278,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:56","host":"europe67*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/d39143e1-43f2-4dfb-9b73-cc0041b3f3ca.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1409,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:56","host":"us-52*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/fcb5fe93-f0d3-4188-86a5-5671dad302ef.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1536,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:57","host":"us-001*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"http://kb.cnblogs.com/page/662133/data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","sourceStatusCode":404,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1938,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:56","host":"us-023*","referer":"http://kb.cnblogs.com/page/662133/","linkMd5ListStr":"efeb844d5421407fe9c72ed59a851362,efeb844d5421407fe9c72ed59a851362,efeb844d5421407fe9c72ed59a851362","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[404],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/544dafd1-0bda-4bb0-a48c-34bfc0c2c8a7.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1416,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:58","host":"us-039*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/d39143e1-43f2-4dfb-9b73-cc0041b3f3ca.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1360,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:58","host":"us-039*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://imgkr.cn-bj.ufileos.com/fcb5fe93-f0d3-4188-86a5-5671dad302ef.png","sourceStatusCode":401,"sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1717,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:58","host":"us-024*","referer":"http://kb.cnblogs.com/page/662118/","linkMd5ListStr":"cb048ef412c5ec36a5d9347e830fa460","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[401],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"http://kb.cnblogs.com/page/662133/data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","sourceStatusCode":404,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx/cdn0@2020_1/404.jpg","sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1830,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:59","host":"us-020*","referer":"http://kb.cnblogs.com/page/662133/","linkMd5ListStr":"efeb844d5421407fe9c72ed59a851362,efeb844d5421407fe9c72ed59a851362,efeb844d5421407fe9c72ed59a851362","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[404],"sourceSize":"0","destSize":"0"}],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-032.herokuapp.com/":{"failCount":1,"successCount":1,"resultList":[401,200]},"http://europe63.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]},"http://us-028.herokuapp.com/":{"failCount":0,"successCount":3,"resultList":[200,200,200]},"http://us-015.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[401]},"http://us-024.herokuapp.com/":{"failCount":1,"successCount":2,"resultList":[200,200,401]},"http://us-52.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[401]},"http://europe70.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-020.herokuapp.com/":{"failCount":1,"successCount":2,"resultList":[200,404,200]},"http://us-025.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]},"http://europe-23.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[401]},"http://europe21.herokuapp.com/":{"failCount":1,"successCount":1,"resultList":[401,200]},"http://us-004.herokuapp.com/":{"failCount":1,"successCount":2,"resultList":[401,200,200]},"http://us-033.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-57.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[401]},"http://us-008.herokuapp.com/":{"failCount":1,"successCount":1,"resultList":[401,200]},"http://us-016.herokuapp.com/":{"failCount":0,"successCount":3,"resultList":[200,200,200]},"http://us-029.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-012.herokuapp.com/":{"failCount":1,"successCount":2,"resultList":[401,200,200]},"http://us-013.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[401]},"http://us-039.herokuapp.com/":{"failCount":2,"successCount":1,"resultList":[200,401,401]},"http://us-55.herokuapp.com/":{"failCount":1,"successCount":2,"resultList":[401,200,200]},"http://us-035.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]},"http://europe66.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-030.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[401]},"http://us-026.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-25.herokuapp.com/":{"failCount":1,"successCount":2,"resultList":[401,200,200]},"http://us-001.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[401]},"http://us-036.herokuapp.com/":{"failCount":1,"successCount":1,"resultList":[401,200]},"http://europe-59.herokuapp.com/":{"failCount":1,"successCount":2,"resultList":[401,200,200]},"http://europe67.herokuapp.com/":{"failCount":2,"successCount":3,"resultList":[401,200,200,401,200]},"http://us-023.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[404]},"http://us-040.herokuapp.com/":{"failCount":1,"successCount":2,"resultList":[401,200,200]},"http://us-027.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1694706/201906/1694706-20190617211339162-1142166449.jpg","sourceStatusCode":200,"destWidth":640,"destHeight":461,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn14@2020_4/2020/08/25/01-33-51-405_59ad8b3dddd92a9f.webp","sourceBytes":20469,"destBytes":13084,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3499,"convertSpendMs":12,"createdTime":"2020-08-25 09:33:48","host":"us-007*","referer":"http://kb.cnblogs.com/page/627035/","linkMd5ListStr":"3c11aa7fbbae093219093acdcc278598,3c11aa7fbbae093219093acdcc278598","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"20 KB","destSize":"12.8 KB","compressRate":"63.9%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211123717325-1261206014.png","sourceStatusCode":200,"destWidth":1240,"destHeight":420,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn11@2020_1/2020/08/25/01-33-51-632_42b618459ce7c6d9.webp","sourceBytes":199913,"destBytes":21274,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3816,"convertSpendMs":36,"createdTime":"2020-08-25 09:33:48","host":"us-006*","referer":"http://kb.cnblogs.com/page/661047/","linkMd5ListStr":"fd4597d220dfcebef9ff69d32bf14aa0,fd4597d220dfcebef9ff69d32bf14aa0","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"195.2 KB","destSize":"20.8 KB","compressRate":"10.6%"},{"code":1,"isDone":false,"source":"https://img2020.cnblogs.com/kb/1/202005/1-20200529153355820-1876224561.jpg","sourceStatusCode":200,"destWidth":670,"destHeight":472,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn29@2020_2/2020/08/25/01-33-51-660_ca8880b595581206.webp","sourceBytes":55653,"destBytes":39990,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3910,"convertSpendMs":16,"createdTime":"2020-08-25 09:33:48","host":"us-035*","referer":"http://kb.cnblogs.com/page/662133/","linkMd5ListStr":"efeb844d5421407fe9c72ed59a851362,efeb844d5421407fe9c72ed59a851362","githubUser":"myreaderx8","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"54.3 KB","destSize":"39.1 KB","compressRate":"71.9%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/blog/568636/201402/261557521663748.png","sourceStatusCode":200,"destWidth":894,"destHeight":237,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn22@2020_6/2020/08/25/01-33-51-864_17ff295a6a1c28a3.webp","sourceBytes":20747,"destBytes":12554,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4132,"convertSpendMs":9,"createdTime":"2020-08-25 09:33:48","host":"europe70*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2,899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"20.3 KB","destSize":"12.3 KB","compressRate":"60.5%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144649364-2049336422.png","sourceStatusCode":200,"destWidth":1051,"destHeight":581,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn33@2020_3/2020/08/25/01-33-52-574_03357b4e33ba508f.webp","sourceBytes":154650,"destBytes":40850,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4780,"convertSpendMs":42,"createdTime":"2020-08-25 09:33:48","host":"us-023*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d,0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx7","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"151 KB","destSize":"39.9 KB","compressRate":"26.4%"},{"code":1,"isDone":false,"source":"https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705203342272-1013989301.png","sourceStatusCode":200,"destWidth":1456,"destHeight":426,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn26@2020_4/2020/08/25/01-33-52-239_a0b5660a2ef72424.webp","sourceBytes":40100,"destBytes":93938,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4924,"convertSpendMs":55,"createdTime":"2020-08-25 09:33:48","host":"europe-58*","referer":"http://kb.cnblogs.com/page/666541/","linkMd5ListStr":"ae89a1e36d4ff8ae2c5aa8aeb2e1ebfb,ae89a1e36d4ff8ae2c5aa8aeb2e1ebfb","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"39.2 KB","destSize":"91.7 KB","compressRate":"234.3%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/i/568636/201402/272011592351032.png","sourceStatusCode":200,"destWidth":835,"destHeight":469,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn75@2020_1/2020/08/25/01-33-56-093_f1b300fc774a2a95.webp","sourceBytes":22514,"destBytes":18774,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3161,"convertSpendMs":25,"createdTime":"2020-08-25 09:33:53","host":"us-039*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx33","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"22 KB","destSize":"18.3 KB","compressRate":"83.4%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144701136-1541745017.png","sourceStatusCode":200,"destWidth":450,"destHeight":286,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn43@2020_6/2020/08/25/01-33-56-180_54acf7710571c73f.webp","sourceBytes":45329,"destBytes":8572,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3192,"convertSpendMs":11,"createdTime":"2020-08-25 09:33:53","host":"us-020*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx8","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"44.3 KB","destSize":"8.4 KB","compressRate":"18.9%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/i/568636/201402/272011298214981.png","sourceStatusCode":200,"destWidth":811,"destHeight":555,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn64@2020_5/2020/08/25/01-33-56-194_9a46c9393e99f7d0.webp","sourceBytes":36029,"destBytes":35536,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3264,"convertSpendMs":28,"createdTime":"2020-08-25 09:33:53","host":"us-024*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx1","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"35.2 KB","destSize":"34.7 KB","compressRate":"98.6%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/blog/568636/201402/261558030273600.png","sourceStatusCode":200,"destWidth":639,"destHeight":391,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn77@2020_2/2020/08/25/01-33-56-240_66e9b462fdfb32ee.webp","sourceBytes":17933,"destBytes":9136,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3261,"convertSpendMs":13,"createdTime":"2020-08-25 09:33:53","host":"us-040*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx5oss","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"17.5 KB","destSize":"8.9 KB","compressRate":"50.9%"},{"code":1,"isDone":false,"source":"https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705203505811-72849174.png","sourceStatusCode":200,"destWidth":1579,"destHeight":383,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn88@2020_4/2020/08/25/01-33-56-143_443a628cc9b67571.webp","sourceBytes":43053,"destBytes":69684,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3380,"convertSpendMs":54,"createdTime":"2020-08-25 09:33:53","host":"us-016*","referer":"http://kb.cnblogs.com/page/666541/","linkMd5ListStr":"ae89a1e36d4ff8ae2c5aa8aeb2e1ebfb","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"42 KB","destSize":"68.1 KB","compressRate":"161.9%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/i/568636/201402/272011243838819.png","sourceStatusCode":200,"destWidth":859,"destHeight":625,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn23@2020_4/2020/08/25/01-33-56-280_87a58e9656b1a335.webp","sourceBytes":57210,"destBytes":53420,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3426,"convertSpendMs":27,"createdTime":"2020-08-25 09:33:53","host":"us-016*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx3","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"55.9 KB","destSize":"52.2 KB","compressRate":"93.4%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214213013527-827332693.jpg","sourceStatusCode":200,"destWidth":720,"destHeight":537,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn71@2020_3/2020/08/25/01-33-56-415_0bf82cf17ef782c6.webp","sourceBytes":31934,"destBytes":22124,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3509,"convertSpendMs":13,"createdTime":"2020-08-25 09:33:53","host":"us-55*","referer":"http://kb.cnblogs.com/page/651942/","linkMd5ListStr":"0b26462e72b48901f1b66ef9a08866cf","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"31.2 KB","destSize":"21.6 KB","compressRate":"69.3%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214214427792-2114717553.jpg","sourceStatusCode":200,"destWidth":720,"destHeight":552,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn27@2020_5/2020/08/25/01-33-56-443_7ddcf8f610944d06.webp","sourceBytes":32304,"destBytes":23758,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3544,"convertSpendMs":22,"createdTime":"2020-08-25 09:33:53","host":"us-004*","referer":"http://kb.cnblogs.com/page/651942/","linkMd5ListStr":"0b26462e72b48901f1b66ef9a08866cf","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"31.5 KB","destSize":"23.2 KB","compressRate":"73.5%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/i/568636/201402/272011015588144.png","sourceStatusCode":200,"destWidth":977,"destHeight":562,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn16@2020_4/2020/08/25/01-33-56-514_a09f99d099fb3667.webp","sourceBytes":44933,"destBytes":31966,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3591,"convertSpendMs":20,"createdTime":"2020-08-25 09:33:53","host":"us-040*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"43.9 KB","destSize":"31.2 KB","compressRate":"71.1%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144702764-1012478859.png","sourceStatusCode":200,"destWidth":938,"destHeight":450,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn92@2020_1/2020/08/25/01-33-56-666_ce4c3dd68528fdff.webp","sourceBytes":78517,"destBytes":25018,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3722,"convertSpendMs":32,"createdTime":"2020-08-25 09:33:53","host":"us-004*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"76.7 KB","destSize":"24.4 KB","compressRate":"31.9%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144704588-1066652639.png","sourceStatusCode":200,"destWidth":1106,"destHeight":521,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn47@2020_2/2020/08/25/01-33-56-569_4d09a529d8bcc3f2.webp","sourceBytes":155937,"destBytes":40606,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3774,"convertSpendMs":78,"createdTime":"2020-08-25 09:33:53","host":"us-008*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx7","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"152.3 KB","destSize":"39.7 KB","compressRate":"26%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/i/568636/201402/272011499981710.png","sourceStatusCode":200,"destWidth":828,"destHeight":393,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn71@2020_3/2020/08/25/01-33-56-521_b63d885a686bc385.webp","sourceBytes":20387,"destBytes":18216,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3790,"convertSpendMs":12,"createdTime":"2020-08-25 09:33:53","host":"europe-25*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx13","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"19.9 KB","destSize":"17.8 KB","compressRate":"89.4%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144657309-1185117051.png","sourceStatusCode":200,"destWidth":1270,"destHeight":884,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn95@2020_1/2020/08/25/01-33-56-935_96d22ad4554419ac.webp","sourceBytes":212217,"destBytes":38674,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4030,"convertSpendMs":86,"createdTime":"2020-08-25 09:33:53","host":"us-036*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"207.2 KB","destSize":"37.8 KB","compressRate":"18.2%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/blog/568636/201402/261558133703892.png","sourceStatusCode":200,"destWidth":946,"destHeight":261,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn95@2020_2/2020/08/25/01-33-56-717_960c0361a1130346.webp","sourceBytes":23890,"destBytes":17004,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3948,"convertSpendMs":11,"createdTime":"2020-08-25 09:33:53","host":"europe67*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx30","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"23.3 KB","destSize":"16.6 KB","compressRate":"71.2%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144707551-1195034411.png","sourceStatusCode":200,"destWidth":925,"destHeight":435,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn91@2020_5/2020/08/25/01-33-56-748_8660e7b5a049fdb3.webp","sourceBytes":65472,"destBytes":15360,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3967,"convertSpendMs":15,"createdTime":"2020-08-25 09:33:53","host":"europe-59*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"63.9 KB","destSize":"15 KB","compressRate":"23.5%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/31085/201905/31085-20190527232022474-1815067006.png","sourceStatusCode":200,"destWidth":698,"destHeight":400,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn36@2020_2/2020/08/25/01-33-57-006_76ed34a6216f1ec1.webp","sourceBytes":356714,"destBytes":28298,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4159,"convertSpendMs":21,"createdTime":"2020-08-25 09:33:53","host":"us-55*","referer":"http://kb.cnblogs.com/page/651963/","linkMd5ListStr":"62c2dbb40a268e0c77ad389b073e5b9e","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"348.4 KB","destSize":"27.6 KB","compressRate":"7.9%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/kb/1621547/201912/1621547-20191215183832794-1874553792.png","sourceStatusCode":200,"destWidth":360,"destHeight":538,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn59@2020_3/2020/08/25/01-33-57-128_0148eb5df51c6af3.webp","sourceBytes":35453,"destBytes":12134,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4193,"convertSpendMs":11,"createdTime":"2020-08-25 09:33:53","host":"us-016*","referer":"http://kb.cnblogs.com/page/651963/","linkMd5ListStr":"62c2dbb40a268e0c77ad389b073e5b9e","githubUser":"myreaderx13","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"34.6 KB","destSize":"11.8 KB","compressRate":"34.2%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144658685-2109075926.png","sourceStatusCode":200,"destWidth":1224,"destHeight":806,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn40@2020_2/2020/08/25/01-33-57-013_2db599098354b4c6.webp","sourceBytes":182203,"destBytes":46988,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4197,"convertSpendMs":35,"createdTime":"2020-08-25 09:33:53","host":"us-032*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"177.9 KB","destSize":"45.9 KB","compressRate":"25.8%"},{"code":1,"isDone":false,"source":"https://img2020.cnblogs.com/news/1/202005/1-20200517180637726-1317256928.jpg","sourceStatusCode":200,"destWidth":699,"destHeight":375,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn67@2020_4/2020/08/25/01-33-56-755_ac901ba8c46702ca.webp","sourceBytes":48789,"destBytes":37372,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4110,"convertSpendMs":13,"createdTime":"2020-08-25 09:33:53","host":"europe67*","referer":"http://kb.cnblogs.com/page/662133/","linkMd5ListStr":"efeb844d5421407fe9c72ed59a851362","githubUser":"myreaderx5oss","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"47.6 KB","destSize":"36.5 KB","compressRate":"76.6%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144659805-1383290847.png","sourceStatusCode":200,"destWidth":442,"destHeight":462,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn19@2020_5/2020/08/25/01-33-57-295_5593a7ae04fc613d.webp","sourceBytes":58706,"destBytes":17626,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4376,"convertSpendMs":9,"createdTime":"2020-08-25 09:33:53","host":"us-028*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"57.3 KB","destSize":"17.2 KB","compressRate":"30%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/blog/568636/201402/261558471321974.png","sourceStatusCode":200,"destWidth":585,"destHeight":374,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn44@2020_4/2020/08/25/01-33-57-035_169b2c58273c2bc4.webp","sourceBytes":119009,"destBytes":18204,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4297,"convertSpendMs":34,"createdTime":"2020-08-25 09:33:53","host":"europe-25*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"116.2 KB","destSize":"17.8 KB","compressRate":"15.3%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/blog/568636/201402/261558580734083.png","sourceStatusCode":200,"destWidth":1024,"destHeight":860,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn67@2020_1/2020/08/25/01-33-57-331_49f4372adef52a23.webp","sourceBytes":463260,"destBytes":40752,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4400,"convertSpendMs":36,"createdTime":"2020-08-25 09:33:53","host":"us-012*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx22","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"452.4 KB","destSize":"39.8 KB","compressRate":"8.8%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144706712-855721709.png","sourceStatusCode":200,"destWidth":947,"destHeight":384,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn55@2020_4/2020/08/25/01-33-57-374_5481c06cc437fe07.webp","sourceBytes":85811,"destBytes":22296,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4563,"convertSpendMs":21,"createdTime":"2020-08-25 09:33:53","host":"us-028*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx22","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"83.8 KB","destSize":"21.8 KB","compressRate":"26%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/blog/568636/201402/261558231495314.png","sourceStatusCode":200,"destWidth":952,"destHeight":637,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn83@2020_1/2020/08/25/01-33-57-442_d8b674b5dd8c6cfb.webp","sourceBytes":200436,"destBytes":42106,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4116,"convertSpendMs":27,"createdTime":"2020-08-25 09:33:54","host":"us-028*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"195.7 KB","destSize":"41.1 KB","compressRate":"21%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/31085/201906/31085-20190607182832666-1215142380.png","sourceStatusCode":200,"destWidth":990,"destHeight":1553,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn12@2020_3/2020/08/25/01-33-57-089_20a206a378b6cec2.webp","sourceBytes":148287,"destBytes":59182,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4587,"convertSpendMs":80,"createdTime":"2020-08-25 09:33:53","host":"europe63*","referer":"http://kb.cnblogs.com/page/651963/","linkMd5ListStr":"62c2dbb40a268e0c77ad389b073e5b9e","githubUser":"myreaderx19","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"144.8 KB","destSize":"57.8 KB","compressRate":"39.9%"},{"code":1,"isDone":false,"source":"https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406180130452-1246060303.png","sourceStatusCode":200,"destWidth":1240,"destHeight":537,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn88@2020_3/2020/08/25/01-33-57-158_afc2fddf34bd8f8b.webp","sourceBytes":273969,"destBytes":41744,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4628,"convertSpendMs":40,"createdTime":"2020-08-25 09:33:53","host":"europe21*","referer":"http://kb.cnblogs.com/page/661047/","linkMd5ListStr":"fd4597d220dfcebef9ff69d32bf14aa0","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"267.5 KB","destSize":"40.8 KB","compressRate":"15.2%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/i/568636/201402/272011364236128.png","sourceStatusCode":200,"destWidth":809,"destHeight":559,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn32@2020_5/2020/08/25/01-33-57-427_05063362e1c32527.webp","sourceBytes":32787,"destBytes":27542,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4652,"convertSpendMs":19,"createdTime":"2020-08-25 09:33:53","host":"europe67*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"32 KB","destSize":"26.9 KB","compressRate":"84%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144654998-1464017813.png","sourceStatusCode":200,"destWidth":1920,"destHeight":972,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn39@2020_5/2020/08/25/01-33-57-832_762bf598ad1c5c11.webp","sourceBytes":499194,"destBytes":76792,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":5086,"convertSpendMs":101,"createdTime":"2020-08-25 09:33:53","host":"us-012*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx23","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"487.5 KB","destSize":"75 KB","compressRate":"15.4%"},{"code":1,"isDone":false,"source":"https://img2020.cnblogs.com/kb/1/202005/1-20200529220331340-1691781520.jpg","sourceStatusCode":200,"destWidth":801,"destHeight":402,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn99@2020_6/2020/08/25/01-33-58-143_c7c1701d02b09c82.webp","sourceBytes":44424,"destBytes":32684,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":5192,"convertSpendMs":20,"createdTime":"2020-08-25 09:33:53","host":"us-024*","referer":"http://kb.cnblogs.com/page/662133/","linkMd5ListStr":"efeb844d5421407fe9c72ed59a851362","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"43.4 KB","destSize":"31.9 KB","compressRate":"73.6%"},{"code":1,"isDone":false,"source":"https://img2020.cnblogs.com/kb/1621547/202005/1621547-20200502201958036-357435668.png","sourceStatusCode":200,"destWidth":788,"destHeight":866,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx/cdn36@2020_2/2020/08/25/01-33-58-888_9af831aa167794cb.webp","sourceBytes":102486,"destBytes":37042,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3020,"convertSpendMs":45,"createdTime":"2020-08-25 09:33:56","host":"us-026*","referer":"http://kb.cnblogs.com/page/661047/","linkMd5ListStr":"fd4597d220dfcebef9ff69d32bf14aa0","githubUser":"myreaderx","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"100.1 KB","destSize":"36.2 KB","compressRate":"36.1%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144701612-2119498232.png","sourceStatusCode":200,"destWidth":403,"destHeight":488,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn23@2020_2/2020/08/25/01-33-59-327_70289f5a98cf3a07.webp","sourceBytes":35888,"destBytes":12018,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3579,"convertSpendMs":8,"createdTime":"2020-08-25 09:33:56","host":"europe66*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"35 KB","destSize":"11.7 KB","compressRate":"33.5%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144708811-339049697.png","sourceStatusCode":200,"destWidth":854,"destHeight":397,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn60@2020_6/2020/08/25/01-33-59-616_c2ba519d646a4d56.webp","sourceBytes":77997,"destBytes":19350,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3294,"convertSpendMs":13,"createdTime":"2020-08-25 09:33:57","host":"us-035*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"76.2 KB","destSize":"18.9 KB","compressRate":"24.8%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1411156/201912/1411156-20191210144700352-40629753.png","sourceStatusCode":200,"destWidth":606,"destHeight":256,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn64@2020_6/2020/08/25/01-33-59-579_b5cd55ac5785d1a0.webp","sourceBytes":31141,"destBytes":10376,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3262,"convertSpendMs":7,"createdTime":"2020-08-25 09:33:57","host":"europe70*","referer":"http://kb.cnblogs.com/page/653528/","linkMd5ListStr":"0999877fc2802ef25e7074ed2db0874d","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"30.4 KB","destSize":"10.1 KB","compressRate":"33.3%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/blog/568636/201402/261559110965092.png","sourceStatusCode":200,"destWidth":561,"destHeight":672,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn47@2020_5/2020/08/25/01-33-59-758_e9c78d46df710519.webp","sourceBytes":113133,"destBytes":43334,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3552,"convertSpendMs":18,"createdTime":"2020-08-25 09:33:57","host":"us-027*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"110.5 KB","destSize":"42.3 KB","compressRate":"38.3%"},{"code":1,"isDone":false,"source":"https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406175939873-925019958.png","sourceStatusCode":200,"destWidth":1240,"destHeight":544,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn31@2020_3/2020/08/25/01-33-59-923_d4a664be95cb980d.webp","sourceBytes":362088,"destBytes":44196,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3926,"convertSpendMs":37,"createdTime":"2020-08-25 09:33:56","host":"us-025*","referer":"http://kb.cnblogs.com/page/661047/","linkMd5ListStr":"fd4597d220dfcebef9ff69d32bf14aa0","githubUser":"myreaderx14","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"353.6 KB","destSize":"43.2 KB","compressRate":"12.2%"},{"code":1,"isDone":false,"source":"http://kb.cnblogs.com/page/662133/data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","sourceStatusCode":404,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx/cdn0@2020_1/404.jpg","sourceBytes":0,"destBytes":0,"feedId":11665,"totalSpendMs":1830,"convertSpendMs":0,"createdTime":"2020-08-25 09:33:59","host":"us-020*","referer":"http://kb.cnblogs.com/page/662133/","linkMd5ListStr":"efeb844d5421407fe9c72ed59a851362,efeb844d5421407fe9c72ed59a851362,efeb844d5421407fe9c72ed59a851362","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[404],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211122806997-940664368.png","sourceStatusCode":200,"destWidth":590,"destHeight":621,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn51@2020_1/2020/08/25/01-34-00-148_dae60d704c3bb3c4.webp","sourceBytes":77142,"destBytes":13782,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":3914,"convertSpendMs":16,"createdTime":"2020-08-25 09:33:57","host":"us-029*","referer":"http://kb.cnblogs.com/page/661047/","linkMd5ListStr":"fd4597d220dfcebef9ff69d32bf14aa0","githubUser":"myreaderx3","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"75.3 KB","destSize":"13.5 KB","compressRate":"17.9%"},{"code":1,"isDone":false,"source":"https://images2018.cnblogs.com/blog/1202586/201804/1202586-20180406180405961-333776342.png","sourceStatusCode":200,"destWidth":1240,"destHeight":543,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn15@2020_3/2020/08/25/01-34-00-118_93f5639b2900b3f9.webp","sourceBytes":283375,"destBytes":43696,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4476,"convertSpendMs":38,"createdTime":"2020-08-25 09:33:56","host":"us-035*","referer":"http://kb.cnblogs.com/page/661047/","linkMd5ListStr":"fd4597d220dfcebef9ff69d32bf14aa0","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"276.7 KB","destSize":"42.7 KB","compressRate":"15.4%"},{"code":1,"isDone":false,"source":"https://img2020.cnblogs.com/kb/1621547/202007/1621547-20200705204558388-1246973341.png","sourceStatusCode":200,"destWidth":1109,"destHeight":830,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn80@2020_5/2020/08/25/01-34-00-352_48bf3b627620c16d.webp","sourceBytes":69284,"destBytes":53504,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":7500,"convertSpendMs":131,"createdTime":"2020-08-25 09:33:53","host":"us-020*","referer":"http://kb.cnblogs.com/page/666541/","linkMd5ListStr":"ae89a1e36d4ff8ae2c5aa8aeb2e1ebfb","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"67.7 KB","destSize":"52.2 KB","compressRate":"77.2%"},{"code":1,"isDone":false,"source":"https://images0.cnblogs.com/blog/568636/201402/261559277343677.png","sourceStatusCode":200,"destWidth":581,"destHeight":640,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn44@2020_4/2020/08/25/01-34-00-518_3e84aacf1960fd1e.webp","sourceBytes":302276,"destBytes":45746,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4381,"convertSpendMs":21,"createdTime":"2020-08-25 09:33:56","host":"us-025*","referer":"http://kb.cnblogs.com/page/662938/","linkMd5ListStr":"899abe6b8a3c66b5966d8229e6dcccc2","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"295.2 KB","destSize":"44.7 KB","compressRate":"15.1%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/news/1621547/201912/1621547-20191214212453004-211640216.jpg","sourceStatusCode":200,"destWidth":720,"destHeight":520,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn55@2020_3/2020/08/25/01-34-00-864_003624186bba9bbb.webp","sourceBytes":26262,"destBytes":15238,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":4492,"convertSpendMs":12,"createdTime":"2020-08-25 09:33:57","host":"us-033*","referer":"http://kb.cnblogs.com/page/651942/","linkMd5ListStr":"0b26462e72b48901f1b66ef9a08866cf","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"25.6 KB","destSize":"14.9 KB","compressRate":"58%"},{"code":1,"isDone":false,"source":"https://img2020.cnblogs.com/kb/1/202005/1-20200529220411993-1186207191.png","sourceStatusCode":200,"destWidth":836,"destHeight":485,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn48@2020_3/2020/08/25/01-34-00-317_cab79dd0af460023.webp","sourceBytes":157636,"destBytes":75676,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":7843,"convertSpendMs":33,"createdTime":"2020-08-25 09:33:53","host":"europe63*","referer":"http://kb.cnblogs.com/page/662133/","linkMd5ListStr":"efeb844d5421407fe9c72ed59a851362","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"153.9 KB","destSize":"73.9 KB","compressRate":"48%"},{"code":1,"isDone":false,"source":"https://img2018.cnblogs.com/blog/1202586/201812/1202586-20181211121039404-1910765480.png","sourceStatusCode":200,"destWidth":1336,"destHeight":687,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn56@2020_2/2020/08/25/01-34-00-536_a75960a08cfa8dec.webp","sourceBytes":187107,"destBytes":55776,"targetWebpQuality":75,"feedId":11665,"totalSpendMs":8836,"convertSpendMs":51,"createdTime":"2020-08-25 09:33:53","host":"europe-59*","referer":"http://kb.cnblogs.com/page/661047/","linkMd5ListStr":"fd4597d220dfcebef9ff69d32bf14aa0","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"182.7 KB","destSize":"54.5 KB","compressRate":"29.8%"}],"successGithubMap":{"myreaderx14":1,"myreaderx8":2,"myreaderx7":2,"myreaderx15":2,"myreaderx6":3,"myreaderx16":1,"myreaderx10":2,"myreaderx32":2,"myreaderx4":1,"myreaderx11":3,"myreaderx3":2,"myreaderx33":1,"myreaderx12":2,"myreaderx13":2,"myreaderx1":1,"myreaderx30":1,"myreaderx31":2,"myreaderx18":1,"myreaderx19":1,"myreaderx":1,"myreaderx25":1,"myreaderx27":2,"myreaderx21":2,"myreaderx22":2,"myreaderx23":1,"myreaderx24":2,"myreaderx5oss":2,"myreaderx29":3},"failGithubMap":{}}