{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-11-16 09:04:03","updatedTime":"2020-11-16 09:04:03","title":"странности кэширования","link":"https://ru-root.livejournal.com/2926628.html","description":"диспозиция<br />nginx<br />сайт a.com, в котором a.com/blog проксируется на<br />b.net, живущий на другом хостере.<br /><br /><br />location ~* ^/blog/(.*)$ {<br />  proxy_pass <a target='_blank' href='https://b.net/$1$is_args$args;' rel='nofollow'>https://b.net/$1$is_args$args;</a><br />}<br /><a name='cutid1-end'></a><br /><br />На b.net крутится wordpress, настроенный на домен a.com, те все отдаваемые url содержат явным образом a.com. Все работает великолепно пока не возникают проблемы коннективи между хостерами. Самое простое решение это кэширование на уровне nginx.<br /><br /><br />location ~* ^/blog/(.*)$ {<br />  if ($http_cookie ~* \".+\" ) {<br />         set $do_not_cache 1;<br />  }<br />  proxy_cache_bypass $do_not_cache;<br />  proxy_cache all;<br />  proxy_cache_valid 404 502 503 1m;<br />  proxy_cache_valid any 1h;<br />  add_header X-Cache-Status $upstream_cache_status;<br />  proxy_pass <a target='_blank' href='https://b.net/$1$is_args$args;' rel='nofollow'>https://b.net/$1$is_args$args;</a><br />}<br /><a name='cutid2-end'></a><br /><br />Но тут вылазит странность - часть url перестает нормально отдаваться <br /><br /><br />если до включения кэширования<br /># curl -I '<a target='_blank' href='https://a.com/blog/wp-includes/css/dist/block-library/style.min.css?ver=5.0.8' rel='nofollow'>https://a.com/blog/wp-includes/css/dist/block-library/style.min.css?ver=5.0.8</a>'<br />HTTP/1.1 200 OK<br />Server: nginx/1.10.3<br />Date: Mon, 03 Feb 2020 07:49:36 GMT<br />Content-Type: text/css<br /><br />то после<br /># curl -I '<a target='_blank' href='https://a.com/blog/wp-includes/css/dist/block-library/style.min.css?ver=5.0.8' rel='nofollow'>https://a.com/blog/wp-includes/css/dist/block-library/style.min.css?ver=5.0.8</a>'<br />HTTP/1.1 200 OK<br />Server: nginx/1.10.3<br />Date: Mon, 03 Feb 2020 07:48:20 GMT<br />Content-Type: text/html; charset=UTF-8<br /><br />причем в кэше оно лежит судя по всему в виде<br />KEY: <a target='_blank' href='https://b.net/?ver=5.0.8' rel='nofollow'>https://b.net/?ver=5.0.8</a><br />HTTP/1.1 200 OK<br />Server: nginx/1.14.1<br />Date: Mon, 03 Feb 2020 08:01:14 GMT<br />Content-Type: text/html; charset=UTF-8<br />Connection: close<br />Link: &lt;https://a.com/blog/wp-json/&gt;; rel=\"<a target='_blank' href='https://api.w.org/' rel='nofollow'>https://api.w.org/</a>\"<br />Link: &lt;https://wp.me/axreg&gt;; rel=shortlink<br />Vary: Accept-Encoding<br /><br />что ессно получит с той стороны не css, а рутовый index.php<br /><br /><a name='cutid3-end'></a><br /><br />экспериментальным путем было выяснено, что все ломает<br /><br />if ($http_cookie ~* \".+\" ) {<br />       set $do_not_cache 1;<br />}<br />proxy_cache_bypass $do_not_cache;<br /><br />но я не могу для себя объяснить как принудительный запрет брать из кэша может вызывать такой эффект...","descriptionType":"text/html","publishedDate":"Mon, 03 Feb 2020 08:39:13 +0000","feedId":42490,"bgimg":"","linkMd5":"fc72e33919adc2a3dc2deb47fc87f42d","bgimgJsdelivr":"","metaImg":"","author":"ext_422262","publishedOrCreatedDate":1605488643680}],"record":{"createdTime":"2020-11-16 09:04:03","updatedTime":"2020-11-16 09:04:03","feedId":42490,"fetchDate":"Mon, 16 Nov 2020 01:04:03 +0000","fetchMs":51421,"handleMs":12,"totalMs":51437,"newArticles":0,"totalArticles":25,"status":1,"type":0,"ip":"0b4009930f9af5660966c5695d71af7c","hostName":"us-012*","requestId":"4fb47f508e9d4dde9ee58994081ab9b1_42490","contentType":"text/xml; charset=utf-8","totalBytes":0,"bgimgsTotal":0,"bgimgsGithubTotal":0,"articlesImgsTotal":0,"articlesImgsGithubTotal":0,"successGithubMap":{},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 03:27:43","updatedTime":"2020-09-07 05:44:47","id":42490,"name":"Клуб Сисадминов","url":"https://community.livejournal.com/ru_root/data/rss","subscriber":75,"website":null,"icon":"https://l-userpic.livejournal.com/4063377/908311","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx63/cdn3@2020_4/2020/09/06/21-44-44-501_3ed0172f425e6dd8.png","description":"Клуб Сисадминов - LiveJournal.com","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":0,"tmpBodyImgCdnBytes":0,"tmpBgImgCdnBytes":0,"extra4":{"start":1605488592245,"total":0,"statList":[{"spend":51423,"msg":"获取xml内容"},{"spend":12,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":0,"msg":"正文链接上传到cdn"}]},"extra5":0,"extra6":0,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{},"extra12ImgCdnSuccessResultVector":[],"successGithubMap":{},"failGithubMap":{}}