{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2021-05-02 13:47:17","updatedTime":"2021-05-02 13:47:17","title":"西瓜视频稳定性治理体系建设二：Raphael 原理及实践","link":"https://www.infoq.cn/article/YVpSAStyyBycBuA3pO1Q?utm_source=rss&utm_medium=article","description":"<h2>摘要</h2><p>Raphael [1]是西瓜视频基础技术团队开发的一款 native 内存泄漏检测工具，广泛用于字节跳动旗下各大 App 的 native 内存泄漏治理，收益显著。工具现已开源，本文将通过原理、方案和实践来剖析 Raphael 的相关细节。</p><h2>背景</h2><p>Android 平台上的内存问题一直是性能优化和稳定性治理的焦点和痛点，Java 堆内存因为有比较成熟的工具和方法论，加上 hprof 快照作为补充，定位和治理都很方便。而 native 内存问题一直缺乏稳定、高效的工具，仅有的 malloc debug [6]不仅性能和稳定性难以满足需要，还存在 Android 版本兼容的问题。</p><h2>现状</h2><p>事实上，native 内存泄漏治理一直不乏优秀的工具，已知的可用于调查 native 内存泄漏问题的工具主要有：LeakTracer、MTrace、MemWatch、Valgrind-memcheck、TCMalloc、LeakSanitizer 等。但由于 Android 平台的特殊性，这些工具要么不兼容，要么接入成本过高，很难在 Android 平台上落地。这些工具的原理基本都是：先代理内存分配/释放相关的函数（如：malloc/calloc/realloc/memalign/free），再通过 unwind 回溯调用堆栈，最后借助缓存管理过滤出未释放的内存分配记录。因此，这些工具的主要差异也就体现在代理实现、栈回溯和缓存管理三个方面。根据这些工具代理实现的差异，大致可以分为 hook 和 LD_PRELOAD 两大类，典型的如 malloc debug [5] 和 LeakTracer。</p><p></p><img src=\"https://static001.geekbang.org/infoq/c2/c2ae99ef5328e3cc3eb0e404fcdbf620.png\" alt=\"图片\"/><h3>malloc debug</h3><p>malloc debug 是 Android 系统自带的内存调试工具（官方 Native 内存调试 有相关介绍 <strong>）</strong> ，虽然没有额外的接入代码，但开启方式和核心功能等都受 Android 版本限制。</p><p></p><img src=\"https://static001.geekbang.org/infoq/27/27e4aed6efca2d594c038a03ab6dffbc.png\" alt=\"图片\"/><p></p><div align='right'><a href='https://www.infoq.cn/article/YVpSAStyyBycBuA3pO1Q?utm_source=rss&utm_medium=article'>点击查看原文></a></div>","descriptionType":"text/html","publishedDate":"Sun, 02 May 2021 07:00:00 +0000","feedId":5627,"bgimg":"https://static001.geekbang.org/infoq/c2/c2ae99ef5328e3cc3eb0e404fcdbf620.png","linkMd5":"f68dd0043e6c6df4ea7017f2bf249ec7","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn29@2020_1/2021/05/02/05-47-22-782_c99b898f98904de6.webp","destWidth":1038,"destHeight":384,"sourceBytes":109076,"destBytes":27288,"author":"字节跳动技术团队","articleImgCdnMap":{"https://static001.geekbang.org/infoq/c2/c2ae99ef5328e3cc3eb0e404fcdbf620.png":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn29@2020_1/2021/05/02/05-47-22-782_c99b898f98904de6.webp","https://static001.geekbang.org/infoq/27/27e4aed6efca2d594c038a03ab6dffbc.png":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn33@2020_6/2021/05/02/05-47-41-343_3fab79689cd79fb1.webp"},"publishedOrCreatedDate":1619934437657}],"record":{"createdTime":"2021-05-02 13:47:17","updatedTime":"2021-05-02 13:47:17","feedId":5627,"fetchDate":"Sun, 02 May 2021 05:47:17 +0000","fetchMs":1604,"handleMs":5,"totalMs":28717,"newArticles":0,"totalArticles":20,"status":1,"type":0,"ip":"79b59b7ab14b8d981e3d8a220e20848a","hostName":"us-007*","requestId":"c4981e3eb20042508584ecb5f57bb997_5627","contentType":"application/xml; charset=utf-8","totalBytes":86402,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":2,"articlesImgsGithubTotal":2,"successGithubMap":{"myreaderx16":1,"myreaderx5oss":1},"failGithubMap":{}},"feed":{"createdTime":"2020-08-25 04:30:14","updatedTime":"2020-09-01 11:14:23","id":5627,"name":"InfoQ - 促进软件开发领域知识与创新的传播","url":"http://www.infoq.com/cn/feed","subscriber":null,"website":null,"icon":"https://static001.infoq.cn/static/infoq/www/img/InfoQ-share-icon2.jpg","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx62/cdn24@2020_5/2020/09/01/03-14-20-436_123a279c4390b9d1.jpg","description":"InfoQ 是一个实践驱动的社区资讯站点，致力于促进软件开发领域知识与创新的传播。","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":27288,"tmpBodyImgCdnBytes":59114,"tmpBgImgCdnBytes":0,"extra4":{"start":1619934435990,"total":0,"statList":[{"spend":1662,"msg":"获取xml内容"},{"spend":5,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":18545,"msg":"正文链接上传到cdn"}]},"extra5":2,"extra6":2,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://europe-58.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://static001.geekbang.org/infoq/c2/c2ae99ef5328e3cc3eb0e404fcdbf620.png","sourceStatusCode":200,"destWidth":1038,"destHeight":384,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn29@2020_1/2021/05/02/05-47-22-782_c99b898f98904de6.webp","sourceBytes":109076,"destBytes":27288,"targetWebpQuality":75,"feedId":5627,"totalSpendMs":7273,"convertSpendMs":16,"createdTime":"2021-05-02 13:47:18","host":"europe70*","referer":"https://www.infoq.cn/article/YVpSAStyyBycBuA3pO1Q?utm_source=rss&utm_medium=article","linkMd5ListStr":"f68dd0043e6c6df4ea7017f2bf249ec7,f68dd0043e6c6df4ea7017f2bf249ec7","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"106.5 KB","destSize":"26.6 KB","compressRate":"25%"},{"code":1,"isDone":false,"source":"https://static001.geekbang.org/infoq/27/27e4aed6efca2d594c038a03ab6dffbc.png","sourceStatusCode":200,"destWidth":1042,"destHeight":698,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn33@2020_6/2021/05/02/05-47-41-343_3fab79689cd79fb1.webp","sourceBytes":240689,"destBytes":59114,"targetWebpQuality":75,"feedId":5627,"totalSpendMs":17499,"convertSpendMs":29,"createdTime":"2021-05-02 13:47:26","host":"europe-58*","referer":"https://www.infoq.cn/article/YVpSAStyyBycBuA3pO1Q?utm_source=rss&utm_medium=article","linkMd5ListStr":"f68dd0043e6c6df4ea7017f2bf249ec7","githubUser":"myreaderx5oss","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"235 KB","destSize":"57.7 KB","compressRate":"24.6%"}],"successGithubMap":{"myreaderx16":1,"myreaderx5oss":1},"failGithubMap":{}}