{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-10-13 21:34:46","updatedTime":"2020-10-13 21:34:46","title":"Pragmatic Testing with GraphQL","link":"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/","description":"<p>We’ve been using GraphQL at OpenTable for a little over half a year now. I won’t go into detail as to why we started using it, but suffice to say, we really enjoyed creating our very first GraphQL endpoint. It eased a lot of the inconsistencies that we were experiencing with some of our REST-ful services.</p> \n<p>This post assumes you have some experience building a GraphQL endpoint. For those of who you aren’t familiar with it, it feels a lot like having a querying language via an HTTP endpoint. If you want to try it for yourself, I recommend <a href=\"https://developer.github.com/v4/explorer/\" target=\"_blank\" rel=\"noopener\">GitHub’s endpoint</a>. To get started with GraphQL, <a href=\"http://graphql.org/learn/\" target=\"_blank\" rel=\"noopener\">the official documentation</a> is a perfect place.</p> \n<h2 id=\"The-Problem\"><a href=\"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/#The-Problem\" class=\"headerlink\" title=\"The Problem\"></a>The Problem</h2> \n<p>Now, let’s get back to writing tests for an endpoint. When we were creating our first endpoint, we started facing regression testing problems while expanding our schema. It seemed our existing testing methods were ill-equipped to handle it.</p> \n<p>Finding a good solution to this is important because I’ve had such a love–hate affair with testing. All tests are not created equal and a naive developer would say, “write a test in case something changes”. This certainly isn’t a good measure. I’ve also found that just attempting to write tests immediately without forethought can be a costly distraction if you grow your codebase.</p> \n<h2 id=\"The-Approach\"><a href=\"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/#The-Approach\" class=\"headerlink\" title=\"The Approach\"></a>The Approach</h2> \n<p>So we took a step back and looked at the code we were writing. Most of the connectors we wrote were fairly anemic. We didn’t have much logic for our API nor did we want any. We could have written unit tests for each parts of the schema but mocking portions of the system seemed more work than it was worth.</p> \n<p>So where did we start? I personally enjoy the outside-in approach and started writing a few acceptance tests. So, we wrote a test for each query in the schema that we had. It would fire an HTTP request and expect a 200 status code and have no errors in the resulting JSON body. Thanks to GraphQL most errors are handily reported using this mechanism so we would be able to make a decent impact using little work.</p> \n<img src=\"http://tech.opentable.co.uk/images/posts/graphql-base-tests.gif\" class=\"left\"><p>As you can see, we found that this would be good enough at the time but eventually found that it would not scale very well. If you forget to update one of these queries, you could leave out a major section out accidentally. Being a big fan of automation, we wondered how we could scale this out.</p><h2 id=\"The-Solution\"><a href=\"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/#The-Solution\" class=\"headerlink\" title=\"The Solution\"></a>The Solution</h2><p>We knew GraphiQL (the web interface for testing GraphQL queries) was using introspection to give us intellisense. What a great idea: we could leverage introspection in a similar way to discover all the possible queries for a given endpoint. After doing so, we repeated our previous tests, which was to fire an HTTP request.</p><p>So how would you generate queries with parameters? For example numDice is required for this query:</p> \n <figure class=\"highlight plain\"> \n  <table> \n   <tr> \n    <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br /></br></br></pre></td> \n    <td class=\"code\"><pre><span class=\"line\">rollDice(numDice: 4, numSides: 6) {</span><br><span class=\"line\">name</span><br><span class=\"line\">}</span><br /></br></br></pre></td> \n   </tr> \n  </table> \n </figure><p>So, how would we be able to provide a valid parameter to a query that we’ve discovered in this endpoint? We believe, this is a great opportunity to kill two birds with one stone! Write an example in your documentation/comments for your query and we’ll re-use it as a test!</p> \n <figure class=\"highlight plain\"> \n  <table> \n   <tr> \n    <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></pre></td> \n    <td class=\"code\"><pre><span class=\"line\">type Query {</span><br><span class=\"line\">  # RollDice has four examples</span><br><span class=\"line\">  #</span><br><span class=\"line\">  # Examples:</span><br><span class=\"line\">  # rollDice(numDice: 4, numSides: 2)</span><br><span class=\"line\"> # rollDice( numDice : 40 , numSides:2)</span><br><span class=\"line\"> # rollDice ( numDice: 2, numSides: 299 )</span><br><span class=\"line\"> # rollDice (</span><br><span class=\"line\"> # numDice:4,</span><br><span class=\"line\"> # numSides: 2342</span><br><span class=\"line\"> # )</span><br><span class=\"line\"> rollDice(numDice: Int!, numSides: Int): RandomDie</span><br><span class=\"line\">}</span><br /></br></br></br></br></br></br></br></br></br></br></br></br></pre></td> \n   </tr> \n  </table> \n </figure><p>From this, all we did is write examples for every single one of our queries and re-run our methodology.</p><p>We thought that we wouldn’t be the only ones running into this problem so we decided to open source this tool: <a href=\"https://github.com/opentable/graphql-query-generator\" target=\"_blank\" rel=\"noopener\">graphql-query-generator</a>. It can be used as a CLI or a library (if you need more tweaking). Feel free to give constructive feedback. Here is a quick demonstration.</p><p><img src=\"http://tech.opentable.co.uk/images/posts/graphql-tool-test.gif\" alt=\"Demonstration of GraphQL Testing Tool\" /></p><p>If you’re not seeing the above commands and want to run it for yourself. Just follow these three steps:</p> \n <figure class=\"highlight plain\"> \n  <table> \n   <tr> \n    <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br /></br></br></pre></td> \n    <td class=\"code\"><pre><span class=\"line\">1. npm i -g graphql-query-generator</span><br><span class=\"line\">2. gql-test http://www.example.com/graphql</span><br><span class=\"line\">3. Have a cup of tea :)</span><br /></br></br></pre></td> \n   </tr> \n  </table> \n </figure><p>… And that’s it! You have a full suite of acceptance tests running against your own GraphQL endpoint!</p><p>Please check out: <a href=\"https://www.npmjs.com/package/graphql-query-generator\" target=\"_blank\" rel=\"noopener\">https://www.npmjs.com/package/graphql-query-generator</a> for more information and updates!</p><p>We are always looking for contributors and feedback here: <a href=\"https://github.com/opentable/graphql-query-generator/issues\" target=\"_blank\" rel=\"noopener\">https://github.com/opentable/graphql-query-generator/issues</a></p><p>Finally, if you find it valuable in anyway, perhaps you could throw a star :)</p><h5 id=\"Disclaimer-we-do-have-performance-and-unit-tests-on-top-of-this\"><a href=\"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/#Disclaimer-we-do-have-performance-and-unit-tests-on-top-of-this\" class=\"headerlink\" title=\"Disclaimer: we do have performance and unit tests on top of this :)\"></a>Disclaimer: we do have performance and unit tests on top of this :)</h5></img>","descriptionType":"html","publishedDate":"Fri, 16 Jun 2017 15:41:16 +0000","feedId":16926,"bgimg":"http://tech.opentable.co.uk/images/posts/graphql-base-tests.gif","linkMd5":"dafaca25e30e1928fc723b6097e9a3f1","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn94@2020_3/2020/10/13/13-34-49-669_149f8ca5f1f47d5b.webp","destWidth":452,"destHeight":548,"sourceBytes":116401,"destBytes":431880,"author":"","articleImgCdnMap":{"http://tech.opentable.co.uk/images/posts/graphql-base-tests.gif":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn94@2020_3/2020/10/13/13-34-49-669_149f8ca5f1f47d5b.webp","http://tech.opentable.co.uk/images/posts/graphql-tool-test.gif":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn98@2020_1/2020/10/13/13-35-09-354_d89e1f91c1a3e3ac.webp"},"publishedOrCreatedDate":1602596086781}],"record":{"createdTime":"2020-10-13 21:34:46","updatedTime":"2020-10-13 21:34:46","feedId":16926,"fetchDate":"Tue, 13 Oct 2020 13:34:46 +0000","fetchMs":247,"handleMs":821,"totalMs":26634,"newArticles":0,"totalArticles":20,"status":1,"type":0,"ip":"25831ba229ab386e6c9fb33b53312d7f","hostName":"us-020*","requestId":"d56b4e4e45b546ef85fbde140e943662_16926","contentType":"text/xml","totalBytes":4467048,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":2,"articlesImgsGithubTotal":2,"successGithubMap":{"myreaderx3":1,"myreaderx24":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 02:13:56","updatedTime":"2020-09-07 02:13:56","id":16926,"name":"OpenTable Tech UK Blog","url":"http://tech.opentable.co.uk/atom.xml","subscriber":197,"website":null,"icon":"http://tech.opentable.co.uk/favicon.png","icon_jsdelivr":null,"description":"The technology blog for OpenTable UK.","weekly":null,"link":"http://tech.opentable.co.uk"},"noPictureArticleList":[],"tmpCommonImgCdnBytes":431880,"tmpBodyImgCdnBytes":4035168,"tmpBgImgCdnBytes":0,"extra4":{"start":1602596085420,"total":0,"statList":[{"spend":540,"msg":"获取xml内容"},{"spend":821,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":20657,"msg":"正文链接上传到cdn"}]},"extra5":2,"extra6":2,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/_#The-Problem":"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/#The-Problem","http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/_#The-Solution":"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/#The-Solution","http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/_#Disclaimer-we-do-have-performance-and-unit-tests-on-top-of-this":"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/#Disclaimer-we-do-have-performance-and-unit-tests-on-top-of-this","http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/_#The-Approach":"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/#The-Approach"},"extra111_proxyServerAndStatMap":{"http://europe-56.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"http://tech.opentable.co.uk/images/posts/graphql-base-tests.gif","sourceStatusCode":200,"destWidth":452,"destHeight":548,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn94@2020_3/2020/10/13/13-34-49-669_149f8ca5f1f47d5b.webp","sourceBytes":116401,"destBytes":431880,"targetWebpQuality":75,"feedId":16926,"totalSpendMs":3766,"convertSpendMs":1991,"createdTime":"2020-10-13 21:34:47","host":"europe68*","referer":"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/","linkMd5ListStr":"dafaca25e30e1928fc723b6097e9a3f1,dafaca25e30e1928fc723b6097e9a3f1","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"421.8 KB","compressRate":"371%","sourceSize":"113.7 KB"},{"code":1,"isDone":false,"source":"http://tech.opentable.co.uk/images/posts/graphql-tool-test.gif","sourceStatusCode":200,"destWidth":650,"destHeight":482,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn98@2020_1/2020/10/13/13-35-09-354_d89e1f91c1a3e3ac.webp","sourceBytes":1010675,"destBytes":4035168,"targetWebpQuality":75,"feedId":16926,"totalSpendMs":20500,"convertSpendMs":17635,"createdTime":"2020-10-13 21:34:51","host":"europe-56*","referer":"http://tech.opentable.co.uk//blog/2017/06/16/pragmatic-testing-with-graphql/","linkMd5ListStr":"dafaca25e30e1928fc723b6097e9a3f1","githubUser":"myreaderx3","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"3.8 MB","compressRate":"399.3%","sourceSize":"987 KB"}],"successGithubMap":{"myreaderx3":1,"myreaderx24":1},"failGithubMap":{}}