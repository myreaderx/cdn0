{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-11-18 13:50:06","updatedTime":"2020-11-18 13:50:06","title":"Creating a chat application from scratch using Rails and WebSockets","link":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","description":"<p>Hey! It’s been a while since my last post.</p> \n<p>I recently familiarized myself with the awesomeness of WebSockets and I finally found the time to write a tutorial about it. I hope you find it helpful.</p> \n<p><strong>Update</strong>: I also published another post for <a href=\"https://twitter.com/lazaru_s/status/1182193506430984193\">dockerizing the application</a> of this tutorial, you can find it <a href=\"https://iridakos.com/programming/2019/04/07/dockerizing-a-rails-application\"><strong>here</strong></a>.</p> \n<h2 id=\"introduction\">Introduction</h2> \n<p>In this tutorial we are going to create a <strong>chat</strong> web application from scratch using Rails and WebSockets.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/rails-chat-tutorial.gif\" alt=\"Rails chat tutorial gif\" /></p> \n<div class=\"alert alert-light\"> \n <div class=\"alert-heading\">\n  <i class=\"fa fa-comments\"></i> Code and comments\n </div> You can find the code of this tutorial on \n <a class=\"alert-link\" href=\"https://github.com/iridakos/rails-chat-tutorial\"><i class=\"fa fa-github\"></i> GitHub</a>. \n <hr /> For feedback, comments, typos etc. please open an \n <a class=\"alert-link\" href=\"https://github.com/iridakos/rails-chat-tutorial/issues\">issue</a> in the repository. \n</div> \n<h3 id=\"what-are-websockets\">What are WebSockets</h3> \n<p>WebSocket is actually a protocol that enables bidirectional communication between the client and the server of a web application over a single long living TCP connection.</p> \n<blockquote> \n <p>The WebSocket protocol enables interaction between a web browser (or other client application) and a web server <strong>with lower overheads, facilitating real-time data transfer from and to the server</strong>. <br /><br />This is made possible by providing a standardized way for the server to send content to the client without being first requested by the client, and allowing messages to be passed back and forth while keeping the connection open. In this way, a two-way ongoing conversation can take place between the client and the server.<br /><br />The communications are done over TCP port number 80 (or 443 in the case of TLS-encrypted connections), which is of benefit for those environments which block non-web Internet connections using a firewall. Similar two-way browser-server communications have been achieved in non-standardized ways using stopgap technologies such as Comet. <cite>– <a href=\"https://en.wikipedia.org/wiki/WebSocket\">WebSocket @ Wikipedia</a></cite></p> \n</blockquote> \n<h3 id=\"why-websockets\">Why WebSockets</h3> \n<p>Suppose you have to create a web page that shows the statuses of running processes. Without WebSockets you would have to either:</p> \n<ul> \n <li>Use AJAX with Javascript intervals to request and render the latest state of the processes or</li> \n <li>Automatically reload the page every x seconds (<code class=\"highlighter-rouge\">&lt;meta http-equiv=\"refresh\" content=\"x\"&gt;</code>) or</li> \n <li>Add a message on the page <em>“The statuses are not updated automatically <span class=\"text-nowrap\">¯\\_(ツ)_/¯</span> Press <a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets\">here</a> to reload the page.”</em></li> \n</ul> \n<p>All of these methods would request the process statuses from the server even if nothing has changed.</p> \n<p>WebSockets are here to allow this communication to take place on demand. The cost is having to keep alive TCP connections between the server and all its clients (each for every open browser tab).</p> \n<h2 id=\"building-the-application\">Building the application</h2> \n<p>We are going to build the web application using:</p> \n<ul> \n <li><strong>Ruby</strong>: version <strong>2.6.2</strong></li> \n <li><strong>Rails</strong>: version <strong>5.2.3</strong></li> \n</ul> \n<h3 id=\"setting-up-the-environment\">Setting up the environment</h3> \n<p>We are going to install the proper ruby and rails versions.</p> \n<h4 id=\"install-ruby\">Install ruby</h4> \n<p>I use <a href=\"https://rvm.io/\">rvm</a> to manage the <strong>Ruby</strong> versions installed on my system. To install the desired ruby version use:</p> \n<div class=\"language-bash highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rvm <span class=\"nb\">install </span>ruby 2.6.2\n</code></pre>\n </div>\n</div> \n<h4 id=\"install-rails\">Install rails</h4> \n<p>Create a directory in your system with the name <code class=\"highlighter-rouge\">rails-chat-tutorial</code>.</p> \n<p><strong>Navigate to that directory</strong> and create the following two files:</p> \n<p><em>.ruby-version</em></p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>ruby-2.6.2\n</code></pre>\n </div>\n</div> \n<p><em>.ruby-gemset</em></p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails-chat-tutorial\n</code></pre>\n </div>\n</div> \n<p>With these file we are letting <em>rvm</em> know that when working on this directory, we want to use the specific ruby version (<code class=\"highlighter-rouge\">.ruby-version</code>) and the gems from the specific gemset (<code class=\"highlighter-rouge\">.ruby-gemset</code>)</p> \n<p>Now, re-entering in the directory you should see something like this:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>$ cd .\n\nruby-2.6.2 - #gemset created /home/iridakos/.rvm/gems/ruby-2.6.2@rails-chat-tutorial\nruby-2.6.2 - #generating rails-chat-tutorial wrappers...........\n</code></pre>\n </div>\n</div> \n<p>Install the desired rails version with:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>gem install rails -v 5.2.3\n</code></pre>\n </div>\n</div> \n<h4 id=\"create-the-rails-application\">Create the rails application</h4> \n<p>We are ready to create our new <em>rails</em> application:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails new .\n</code></pre>\n </div>\n</div> \n<p><strong>Note</strong>: We didn’t define a name for the application and rails will resolve it using the directory name: <code class=\"highlighter-rouge\">rails-chat-tutorial</code>.</p> \n<p>Rails will create all the application’s files and install the required gems.</p> \n<p>Let’s start the application to make sure that everything is fine.</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails server\n</code></pre>\n </div>\n</div> \n<p>You should see something like:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>=&gt; Booting Puma\n=&gt; Rails 5.2.3 application starting in development\n=&gt; Run `rails server -h` for more startup options\nPuma starting in single mode...\n* Version 3.12.1 (ruby 2.6.2-p47), codename: Llamas in Pajamas\n* Min threads: 5, max threads: 5\n* Environment: development\n* Listening on tcp://localhost:3000\nUse Ctrl-C to stop\n</code></pre>\n </div>\n</div> \n<p>Open a browser and visit <code class=\"highlighter-rouge\">http://localhost:3000</code>, if you see this we are good to go.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/01-rails-new.png\" alt=\"Rails new application\" /></p> \n<h3 id=\"users-and-devise\">Users and devise</h3> \n<p>We are going to use the awesome <a href=\"https://github.com/plataformatec/devise\">devise</a> solution for authentication.</p> \n<p>Append the following gem requirement at the bottom of the <code class=\"highlighter-rouge\">Gemfile</code> file located at the root of the application’s directory.</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"n\">gem</span> <span class=\"s1\">'devise'</span>\n</code></pre>\n </div>\n</div> \n<p>On your terminal, install the new gem by executing:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>bundle\n</code></pre>\n </div>\n</div> \n<p>Finish integration with devise using:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails generate devise:install\n</code></pre>\n </div>\n</div> \n<p>We will create the model representing our users using the devise generators.</p> \n<p>On your terminal, execute:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails generate devise User username:string\n</code></pre>\n </div>\n</div> \n<p><strong>Note</strong>: we have added an extra attribute <code class=\"highlighter-rouge\">username</code> to our model (besides the defaults generated by devise) so that we have something more friendly to present when displaying users instead of their email.</p> \n<p>Open the generated migration which you will find under <code class=\"highlighter-rouge\">db/migrate/&lt;datetime&gt;_devise_create_users.rb</code> and append the username’s unique index definition with<sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[4]</a></sup>:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>  <span class=\"n\">add_index</span> <span class=\"ss\">:users</span><span class=\"p\">,</span>  <span class=\"ss\">:username</span><span class=\"p\">,</span>             <span class=\"ss\">unique: </span><span class=\"kp\">true</span>\n</code></pre>\n </div>\n</div> \n<p>Find the line in the file that defines the <code class=\"highlighter-rouge\">username</code> column and change it to:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"n\">t</span><span class=\"p\">.</span><span class=\"nf\">string</span> <span class=\"ss\">:username</span><span class=\"p\">,</span> <span class=\"ss\">null: </span><span class=\"kp\">false</span>\n</code></pre>\n </div>\n</div> \n<p>to make the attribute required.</p> \n<p>Then in the User model which is located at <code class=\"highlighter-rouge\">app/models/user.rb</code> add the validation rule for uniqueness and presence:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>  <span class=\"n\">validates</span> <span class=\"ss\">:username</span><span class=\"p\">,</span> <span class=\"ss\">uniqueness: </span><span class=\"kp\">true</span><span class=\"p\">,</span> <span class=\"ss\">presence: </span><span class=\"kp\">true</span>\n</code></pre>\n </div>\n</div> \n<p>Finally, apply the database migration using:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails db:migrate\n</code></pre>\n </div>\n</div> \n<h3 id=\"rooms-and-messages\">Rooms and messages</h3> \n<p>Each chat message is going to take place in the context of a room.</p> \n<p>Let’s build them all.</p> \n<p>Use the following command to create the <code class=\"highlighter-rouge\">Room</code>:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails generate resource Room name:string:uniq\n</code></pre>\n </div>\n</div> \n<p>and the following command to create the <code class=\"highlighter-rouge\">RoomMessage</code>:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails generate resource RoomMessage room:references user:references message:text\n</code></pre>\n </div>\n</div> \n<p>We are now going to define the appropriate relations<sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[7]</a></sup>.</p> \n<p>Open <code class=\"highlighter-rouge\">app/models/room.rb</code> and add the relation inside the class:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"n\">has_many</span> <span class=\"ss\">:room_messages</span><span class=\"p\">,</span> <span class=\"ss\">dependent: :destroy</span><span class=\"p\">,</span>\n                         <span class=\"ss\">inverse_of: :room</span>\n</code></pre>\n </div>\n</div> \n<p>Open <code class=\"highlighter-rouge\">app/models/room_message.rb</code> and add the relations inside the class:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"n\">belongs_to</span> <span class=\"ss\">:user</span>\n<span class=\"n\">belongs_to</span> <span class=\"ss\">:room</span><span class=\"p\">,</span> <span class=\"ss\">inverse_of: :room_messages</span>\n</code></pre>\n </div>\n</div> \n<p>Migrate the database with:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails db:migrate\n</code></pre>\n </div>\n</div> \n<p>We can now setup our routes so that the root request is served by the <code class=\"highlighter-rouge\">RoomsController#index</code> action.</p> \n<p>Open your <code class=\"highlighter-rouge\">config/routes.rb</code> file and change its contents to:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"no\">Rails</span><span class=\"p\">.</span><span class=\"nf\">application</span><span class=\"p\">.</span><span class=\"nf\">routes</span><span class=\"p\">.</span><span class=\"nf\">draw</span> <span class=\"k\">do</span>\n  <span class=\"n\">devise_for</span> <span class=\"ss\">:users</span>\n\n  <span class=\"n\">root</span> <span class=\"ss\">controller: :rooms</span><span class=\"p\">,</span> <span class=\"ss\">action: :index</span>\n\n  <span class=\"n\">resources</span> <span class=\"ss\">:room_messages</span>\n  <span class=\"n\">resources</span> <span class=\"ss\">:rooms</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p>Restart the server and try to navigate to the application’s root url.</p> \n<p>You should see an error message, no worries:</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/02.png\" alt=\"No action index for the RoomsController\" /></p> \n<p>We have to create the <code class=\"highlighter-rouge\">index</code> action in the <code class=\"highlighter-rouge\">RoomsController</code>. Open the controller <code class=\"highlighter-rouge\">app/controllers/rooms_controller.rb</code> and change its contents to the following:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">RoomsController</span> <span class=\"o\">&lt;</span> <span class=\"no\">ApplicationController</span>\n  <span class=\"k\">def</span> <span class=\"nf\">index</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p>Then create the file <code class=\"highlighter-rouge\">app/views/rooms/index.html.erb</code> and for now just add the following:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;h1&gt;</span>Rooms index<span class=\"nt\">&lt;/h1&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Reload and voilà.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/03.png\" alt=\"Rooms index\" /></p> \n<h3 id=\"adding-authentication\">Adding authentication</h3> \n<p>We want all users to be authenticated before start chatting, so we are going to add the following line in the <code class=\"highlighter-rouge\">ApplicationController</code> located at <em>app/controllers/application_controller.rb</em>:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>  <span class=\"n\">before_action</span> <span class=\"ss\">:authenticate_user!</span>\n</code></pre>\n </div>\n</div> \n<p>If we navigate to <code class=\"highlighter-rouge\">http://localhost:3000</code> now we should be redirected to the sign in page <sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[10]</a></sup>.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/04.png\" alt=\"Sign in\" /></p> \n<p>Before continuing with the good stuff, let’s gear up the application with some good features.</p> \n<h3 id=\"add-bootstrap\">Add bootstrap</h3> \n<p>We are going to use <a href=\"https://getbootstrap.com/\">Bootstrap</a> and we will integrate it in the application using the <a href=\"https://github.com/twbs/bootstrap-rubygem\">bootstrap-rubygem</a> gem.</p> \n<p>Following the instructions of the gem, append the dependencies in your <code class=\"highlighter-rouge\">Gemfile</code>.</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"n\">gem</span> <span class=\"s1\">'bootstrap'</span><span class=\"p\">,</span> <span class=\"s1\">'~&gt; 4.3.1'</span>\n<span class=\"n\">gem</span> <span class=\"s1\">'jquery-rails'</span>\n</code></pre>\n </div>\n</div> \n<p>and execute <code class=\"highlighter-rouge\">bundle</code> to fetch and install it.</p> \n<p>Change the <code class=\"highlighter-rouge\">app/assets/stylesheets/application.css</code> file’s extension to <code class=\"highlighter-rouge\">scss</code> and <strong>replace its contents</strong> with:</p> \n<div class=\"language-css highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">@import</span> <span class=\"s1\">\"bootstrap\"</span><span class=\"p\">;</span>\n</code></pre>\n </div>\n</div> \n<p>Add the following lines to the <code class=\"highlighter-rouge\">app/assets/javascript/application.js</code> just before the <code class=\"highlighter-rouge\">//= require_tree .</code> line<sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[9]</a></sup>:</p> \n<div class=\"language-js highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"c1\">//= require jquery3</span>\n<span class=\"c1\">//= require popper</span>\n<span class=\"c1\">//= require bootstrap-sprockets</span>\n</code></pre>\n </div>\n</div> \n<h3 id=\"add-simple_form\">Add simple_form</h3> \n<p>We are going to use this great gem to generate forms easily.</p> \n<p>Append the gem dependency in your <code class=\"highlighter-rouge\">Gemfile</code> and bundle to install it.</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"n\">gem</span> <span class=\"s1\">'simple_form'</span>\n</code></pre>\n </div>\n</div> \n<p>Then complete the integration using:</p> \n<div class=\"language-bash highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails generate simple_form:install <span class=\"nt\">--bootstrap</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Note</strong>: We used the <em>–bootstrap</em> directive since that’s the framework we are using.</p> \n<h3 id=\"devise-views-with-bootstrap-and-simple-form\">Devise views with bootstrap and simple form</h3> \n<p>Devise uses its own views for sign in, register etc. But we do have a way to customize these views and now that we have ended up using bootstrap and simple forms, we can generate these views in a way that our choices are respected.</p> \n<p>In your terminal:</p> \n<div class=\"language-bash highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails generate devise:views\n</code></pre>\n </div>\n</div> \n<p>The view for signing in is under <code class=\"highlighter-rouge\">app/views/devise/sessions/new.html.erb</code> and for signing up is under <code class=\"highlighter-rouge\">app/views/devise/registrations/new.html.erb</code>. Open these two files and change the submit button’s class by replacing the following line<sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[6]</a></sup>:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"cp\">&lt;%=</span> <span class=\"n\">f</span><span class=\"p\">.</span><span class=\"nf\">button</span> <span class=\"ss\">:submit</span><span class=\"p\">,</span> <span class=\"s2\">\"Sign up\"</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>with</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"cp\">&lt;%=</span> <span class=\"n\">f</span><span class=\"p\">.</span><span class=\"nf\">button</span> <span class=\"ss\">:submit</span><span class=\"p\">,</span> <span class=\"s2\">\"Sign up\"</span><span class=\"p\">,</span> <span class=\"ss\">class: </span><span class=\"s1\">'btn btn-success'</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>to render the buttons <em>bootstrap style</em>.</p> \n<p>Before viewing our changes, let’s do one last thing in our default layout.</p> \n<p>Open <code class=\"highlighter-rouge\">app/views/layouts/application.html.erb</code> and replace its contents with:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;title&gt;</span>RailsChatTutorial<span class=\"nt\">&lt;/title&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">csrf_meta_tags</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">csp_meta_tag</span> <span class=\"cp\">%&gt;</span>\n\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">stylesheet_link_tag</span>    <span class=\"s1\">'application'</span><span class=\"p\">,</span> <span class=\"ss\">media: </span><span class=\"s1\">'all'</span><span class=\"p\">,</span> <span class=\"s1\">'data-turbolinks-track'</span><span class=\"p\">:</span> <span class=\"s1\">'reload'</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">javascript_include_tag</span> <span class=\"s1\">'application'</span><span class=\"p\">,</span> <span class=\"s1\">'data-turbolinks-track'</span><span class=\"p\">:</span> <span class=\"s1\">'reload'</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"container\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-12\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"cp\">&lt;%=</span> <span class=\"k\">yield</span> <span class=\"cp\">%&gt;</span>\n        <span class=\"nt\">&lt;/div&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>This last one was to use <a href=\"https://getbootstrap.com/docs/4.0/layout/grid/\">Bootstrap’s grid</a> in our views.</p> \n<p>Navigate to <code class=\"highlighter-rouge\">http://localhost:3000</code> and view what we have created.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/05.png\" alt=\"Sign in with Devise and simple form\" /></p> \n<p>Let’s try to sign up following the <code class=\"highlighter-rouge\">Sign up</code> link of the form:</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/06.png\" alt=\"Sign up without username\" /></p> \n<p>As you can see, there is no field to fill in the username. For that to work we have to:</p> \n<ul> \n <li>Add the field in the sign up form</li> \n <li>Configure devise to accept the new attribute (<code class=\"highlighter-rouge\">username</code>) or else the <code class=\"highlighter-rouge\">ApplicationController</code> will <a href=\"https://api.rubyonrails.org/classes/ActionController/Parameters.html\">ignore it</a> once submitted from the form.</li> \n</ul> \n<p>To add the field in the sign up form, open <code class=\"highlighter-rouge\">app/views/devise/registrations/new.html.erb</code> and add these lines between the email and password fields.</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>  <span class=\"cp\">&lt;%=</span> <span class=\"n\">f</span><span class=\"p\">.</span><span class=\"nf\">input</span> <span class=\"ss\">:username</span><span class=\"p\">,</span>\n              <span class=\"ss\">required: </span><span class=\"kp\">true</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Then, open the <code class=\"highlighter-rouge\">app/controllers/application_controller.rb</code> file to configure the new attribute. Change the contents to:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">ApplicationController</span> <span class=\"o\">&lt;</span> <span class=\"no\">ActionController</span><span class=\"o\">::</span><span class=\"no\">Base</span>\n  <span class=\"n\">before_action</span> <span class=\"ss\">:authenticate_user!</span>\n\n  <span class=\"n\">before_action</span> <span class=\"ss\">:configure_permitted_parameters</span><span class=\"p\">,</span> <span class=\"ss\">if: :devise_controller?</span>\n\n  <span class=\"kp\">protected</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">configure_permitted_parameters</span>\n    <span class=\"n\">devise_parameter_sanitizer</span><span class=\"p\">.</span><span class=\"nf\">permit</span><span class=\"p\">(</span><span class=\"ss\">:sign_up</span><span class=\"p\">,</span> <span class=\"ss\">keys: </span><span class=\"p\">[</span><span class=\"ss\">:email</span><span class=\"p\">,</span> <span class=\"ss\">:username</span><span class=\"p\">])</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p>Done, reload and sign up<sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[5]</a></sup>.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/07.png\" alt=\"Sign up with username\" /></p> \n<h3 id=\"cleanup-unused-components\">Cleanup unused components</h3> \n<p>We will not be using <code class=\"highlighter-rouge\">coffee script</code> or <code class=\"highlighter-rouge\">turbolinks</code> so let’s remove all the related stuff.</p> \n<p>Open <code class=\"highlighter-rouge\">Gemfile</code> and remove the following lines:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"c1\"># Use CoffeeScript for .coffee assets and views</span>\n<span class=\"n\">gem</span> <span class=\"s1\">'coffee-rails'</span><span class=\"p\">,</span> <span class=\"s1\">'~&gt; 4.2'</span>\n<span class=\"c1\"># Turbolinks makes navigating your web application faster. Read more: https://github.com/turbolinks/turbolinks</span>\n<span class=\"n\">gem</span> <span class=\"s1\">'turbolinks'</span><span class=\"p\">,</span> <span class=\"s1\">'~&gt; 5'</span>\n</code></pre>\n </div>\n</div> \n<p>Open <code class=\"highlighter-rouge\">app/assets/javascripts/application.js</code> and remove the following line:</p> \n<div class=\"language-js highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"c1\">//= require turbolinks</span>\n</code></pre>\n </div>\n</div> \n<p>Open <code class=\"highlighter-rouge\">app/views/layouts/application.html.erb</code> and change the following lines <sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[3]</a></sup>:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>    <span class=\"cp\">&lt;%=</span> <span class=\"n\">stylesheet_link_tag</span>    <span class=\"s1\">'application'</span><span class=\"p\">,</span> <span class=\"ss\">media: </span><span class=\"s1\">'all'</span><span class=\"p\">,</span> <span class=\"s1\">'data-turbolinks-track'</span><span class=\"p\">:</span> <span class=\"s1\">'reload'</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">javascript_include_tag</span> <span class=\"s1\">'application'</span><span class=\"p\">,</span> <span class=\"s1\">'data-turbolinks-track'</span><span class=\"p\">:</span> <span class=\"s1\">'reload'</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>to</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>    <span class=\"cp\">&lt;%=</span> <span class=\"n\">stylesheet_link_tag</span>    <span class=\"s1\">'application'</span><span class=\"p\">,</span> <span class=\"ss\">media: </span><span class=\"s1\">'all'</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">javascript_include_tag</span> <span class=\"s1\">'application'</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Check that your <code class=\"highlighter-rouge\">app/assets/javascripts</code> folder doesn’t have any files with extension <code class=\"highlighter-rouge\">.coffee</code> and if you find any, remove them.<sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">2</a><sup></sup></sup></p> \n<p>In the terminal, also execute the following command:</p> \n<div class=\"language-bash highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>rails tmp:cache:clear\n</code></pre>\n </div>\n</div> \n<p>to clear any cached compiled coffee scripts.</p> \n<p>Done. Restart you server.</p> \n<h3 id=\"adding-a-navigation-bar\">Adding a navigation bar</h3> \n<p>To improve the usability of the web pages will add a top <a href=\"https://getbootstrap.com/docs/4.0/components/navbar/\">navigation bar</a>.</p> \n<p>Create the directory <code class=\"highlighter-rouge\">app/views/shared</code> and a file inside it named <code class=\"highlighter-rouge\">_navigation_bar.html.erb</code>. This is going to be the partial responsible for rendering the navigation bar and which later on we will add to the application’s default layout in order to be rendered on all web pages. Add these contents:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;nav</span> <span class=\"na\">class=</span><span class=\"s\">\"navbar navbar-expand-lg navbar-dark bg-dark justify-content-between\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;a</span> <span class=\"na\">class=</span><span class=\"s\">\"navbar-brand\"</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span><span class=\"nt\">&gt;</span>Rails chat tutorial<span class=\"nt\">&lt;/a&gt;</span>\n  <span class=\"nt\">&lt;button</span> <span class=\"na\">class=</span><span class=\"s\">\"navbar-toggler\"</span> <span class=\"na\">type=</span><span class=\"s\">\"button\"</span> <span class=\"na\">data-toggle=</span><span class=\"s\">\"collapse\"</span> <span class=\"na\">data-target=</span><span class=\"s\">\"#nav-bar-collapse\"</span> <span class=\"na\">aria-controls=</span><span class=\"s\">\"navbarColor01\"</span> <span class=\"na\">aria-expanded=</span><span class=\"s\">\"false\"</span> <span class=\"na\">aria-label=</span><span class=\"s\">\"Toggle navigation\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;span</span> <span class=\"na\">class=</span><span class=\"s\">\"navbar-toggler-icon\"</span><span class=\"nt\">&gt;&lt;/span&gt;</span>\n  <span class=\"nt\">&lt;/button&gt;</span>\n\n  <span class=\"cp\">&lt;%</span> <span class=\"k\">if</span> <span class=\"n\">current_user</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;a</span> <span class=\"na\">class=</span><span class=\"s\">\"nav-link dropdown-toggle\"</span> <span class=\"na\">href=</span><span class=\"s\">\"#\"</span> <span class=\"na\">id=</span><span class=\"s\">\"navbarDropdown\"</span> <span class=\"na\">role=</span><span class=\"s\">\"button\"</span> <span class=\"na\">data-toggle=</span><span class=\"s\">\"dropdown\"</span> <span class=\"na\">aria-haspopup=</span><span class=\"s\">\"true\"</span> <span class=\"na\">aria-expanded=</span><span class=\"s\">\"false\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"nt\">&lt;img</span> <span class=\"na\">class=</span><span class=\"s\">\"avatar\"</span> <span class=\"na\">src=</span><span class=\"s\">\"</span><span class=\"cp\">&lt;%=</span> <span class=\"n\">gravatar_url</span><span class=\"p\">(</span><span class=\"n\">current_user</span><span class=\"p\">)</span> <span class=\"cp\">%&gt;</span><span class=\"s\">\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"cp\">&lt;%=</span> <span class=\"n\">current_user</span><span class=\"p\">.</span><span class=\"nf\">username</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"nt\">&lt;/a&gt;</span>\n\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"dropdown-menu dropdown-menu-right\"</span> <span class=\"na\">aria-labelledby=</span><span class=\"s\">\"navbarDropdown\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"cp\">&lt;%=</span> <span class=\"n\">link_to</span> <span class=\"s1\">'Logout'</span><span class=\"p\">,</span> <span class=\"n\">destroy_user_session_path</span><span class=\"p\">,</span> <span class=\"ss\">method: :delete</span><span class=\"p\">,</span> <span class=\"ss\">class: </span><span class=\"s1\">'dropdown-item'</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n<span class=\"nt\">&lt;/nav&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Mind the <code class=\"highlighter-rouge\">gravatar_url(current_user)</code> line. This is a helper method that we are going to use in order to resolve the gravatar url of the signed in user. This is not a builtin method, we have to defined it but it’s pretty straightforward.</p> \n<p>Edit <code class=\"highlighter-rouge\">app/helpers/application_helper.rb</code> and add the following method:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">gravatar_url</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">)</span>\n  <span class=\"n\">gravatar_id</span> <span class=\"o\">=</span> <span class=\"no\">Digest</span><span class=\"o\">::</span><span class=\"no\">MD5</span><span class=\"o\">::</span><span class=\"n\">hexdigest</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">.</span><span class=\"nf\">email</span><span class=\"p\">).</span><span class=\"nf\">downcase</span>\n  <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s2\">\"https://gravatar.com/avatar/</span><span class=\"si\">#{</span><span class=\"n\">gravatar_id</span><span class=\"si\">}</span><span class=\"s2\">.png\"</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Note</strong>:</p> \n<ul> \n <li>As you can see, the user’s username, avatar and sign out link will only be rendered if the user is signed in.</li> \n</ul> \n<p>The avatar image has a css class <code class=\"highlighter-rouge\">avatar</code>. We have to define this class in the application’s stylesheets. Create a css file in which we will gather all css class that we will use in the application under the name <code class=\"highlighter-rouge\">app/assets/stylesheets/rails-chat-tutorial.scss</code>.</p> \n<p>For now add the rule for the avatar:</p> \n<div class=\"language-css highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nc\">.avatar</span> <span class=\"p\">{</span>\n  <span class=\"nl\">max-height</span><span class=\"p\">:</span><span class=\"m\">30px</span><span class=\"p\">;</span>\n  <span class=\"nl\">border-radius</span><span class=\"p\">:</span> <span class=\"m\">15px</span><span class=\"p\">;</span>\n  <span class=\"nl\">width</span><span class=\"p\">:</span><span class=\"nb\">auto</span><span class=\"p\">;</span>\n  <span class=\"nl\">vertical-align</span><span class=\"p\">:</span><span class=\"nb\">middle</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre>\n </div>\n</div> \n<p>and open <code class=\"highlighter-rouge\">application.scss</code> to import the newly created stylesheet. Add the line:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>@import \"rails-chat-tutorial\"\n</code></pre>\n </div>\n</div> \n<p>We have to add this partial in the application layout. Edit <code class=\"highlighter-rouge\">app/views/layouts/application.html.erb</code> and change its contents to:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;head&gt;</span>\n    <span class=\"nt\">&lt;title&gt;</span>RailsChatTutorial<span class=\"nt\">&lt;/title&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">csrf_meta_tags</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">csp_meta_tag</span> <span class=\"cp\">%&gt;</span>\n\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">stylesheet_link_tag</span>    <span class=\"s1\">'application'</span><span class=\"p\">,</span> <span class=\"ss\">media: </span><span class=\"s1\">'all'</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">javascript_include_tag</span> <span class=\"s1\">'application'</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/head&gt;</span>\n\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"container\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-12\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"cp\">&lt;%=</span> <span class=\"n\">render</span> <span class=\"ss\">partial: </span><span class=\"s1\">'shared/navigation_bar'</span> <span class=\"cp\">%&gt;</span>\n          <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"my-3\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"cp\">&lt;%=</span> <span class=\"k\">yield</span> <span class=\"cp\">%&gt;</span>\n          <span class=\"nt\">&lt;/div&gt;</span>\n        <span class=\"nt\">&lt;/div&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Reload to view the bar.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/08.png\" alt=\"Sign up with navigation bar\" /></p> \n<p>Awesome. Fill in with your desired credentials and submit the form.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/09.png\" alt=\"Signed in\" /></p> \n<h3 id=\"room-management\">Room management</h3> \n<p>We are going to create a simple layout for groups.</p> \n<ul> \n <li>One narrow column displaying vertically all the available rooms</li> \n <li>One wide column which is going to host the chat messages and form.</li> \n</ul> \n<p>The rooms index page will have the second column empty since this column will be present only when user is inside a specific room.</p> \n<p>In the index page we will provide the option to create a room.</p> \n<h4 id=\"room-index\">Room index</h4> \n<p>First we have to load all rooms in the <code class=\"highlighter-rouge\">RoomsController</code>. Open <code class=\"highlighter-rouge\">app/controllers/rooms_controller.rb</code> and change the index action as:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">index</span>\n  <span class=\"vi\">@rooms</span> <span class=\"o\">=</span> <span class=\"no\">Room</span><span class=\"p\">.</span><span class=\"nf\">all</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p>Open <code class=\"highlighter-rouge\">app/views/rooms/index.html.erb</code> and change its contents to<sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[8]</a></sup>:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-12 col-md-3\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"mb-3\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"cp\">&lt;%=</span> <span class=\"n\">link_to</span> <span class=\"n\">new_room_path</span><span class=\"p\">,</span> <span class=\"ss\">class: </span><span class=\"s2\">\"btn btn-primary\"</span> <span class=\"k\">do</span> <span class=\"cp\">%&gt;</span>\n        Create a room\n      <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n\n    <span class=\"cp\">&lt;%</span> <span class=\"k\">if</span> <span class=\"vi\">@rooms</span><span class=\"p\">.</span><span class=\"nf\">present?</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"nt\">&lt;nav</span> <span class=\"na\">class=</span><span class=\"s\">\"nav flex-column\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"cp\">&lt;%</span> <span class=\"vi\">@rooms</span><span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">room</span><span class=\"o\">|</span> <span class=\"cp\">%&gt;</span>\n          <span class=\"cp\">&lt;%=</span> <span class=\"n\">link_to</span> <span class=\"n\">room</span><span class=\"p\">.</span><span class=\"nf\">name</span><span class=\"p\">,</span> <span class=\"n\">room_path</span><span class=\"p\">(</span><span class=\"n\">room</span><span class=\"p\">),</span> <span class=\"ss\">class: </span><span class=\"s2\">\"nav-link room-nav-link\"</span> <span class=\"cp\">%&gt;</span>\n        <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"nt\">&lt;/nav&gt;</span>\n    <span class=\"cp\">&lt;%</span> <span class=\"k\">else</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"text-muted\"</span><span class=\"nt\">&gt;</span>\n        The are no rooms\n      <span class=\"nt\">&lt;/div&gt;</span>\n    <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"alert alert-primary\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;h4</span> <span class=\"na\">class=</span><span class=\"s\">\"alert-heading\"</span><span class=\"nt\">&gt;</span>\n        Welcome to the RailsChatTutorial!\n      <span class=\"nt\">&lt;/h4&gt;</span>\n\n      <span class=\"nt\">&lt;p&gt;</span>\n        We need to talk.\n      <span class=\"nt\">&lt;/p&gt;</span>\n\n      <span class=\"nt\">&lt;hr</span> <span class=\"nt\">/&gt;</span>\n\n      <span class=\"nt\">&lt;p&gt;</span>\n        You can create or join a room from the sidebar.\n      <span class=\"nt\">&lt;/p&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n<span class=\"nt\">&lt;/div&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>If there are rooms, the left column of the page will render a vertical navigation with links leading to each room’s page. The right column displays a simple welcome message.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/10.png\" alt=\"Room index\" /></p> \n<p>Pressing the <code class=\"highlighter-rouge\">Create a room</code> button we get the expected error for the non-existent action.</p> \n<h4 id=\"room-newedit\">Room new/edit</h4> \n<p>We have to define the actions for creating and updating a room.</p> \n<p>Open the <code class=\"highlighter-rouge\">app/controllers/rooms_controller.rb</code> and change its contents to:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">RoomsController</span> <span class=\"o\">&lt;</span> <span class=\"no\">ApplicationController</span>\n  <span class=\"c1\"># Loads:</span>\n  <span class=\"c1\"># @rooms = all rooms</span>\n  <span class=\"c1\"># @room = current room when applicable</span>\n  <span class=\"n\">before_action</span> <span class=\"ss\">:load_entities</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">index</span>\n    <span class=\"vi\">@rooms</span> <span class=\"o\">=</span> <span class=\"no\">Room</span><span class=\"p\">.</span><span class=\"nf\">all</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">new</span>\n    <span class=\"vi\">@room</span> <span class=\"o\">=</span> <span class=\"no\">Room</span><span class=\"p\">.</span><span class=\"nf\">new</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">create</span>\n    <span class=\"vi\">@room</span> <span class=\"o\">=</span> <span class=\"no\">Room</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">permitted_parameters</span>\n\n    <span class=\"k\">if</span> <span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">save</span>\n      <span class=\"n\">flash</span><span class=\"p\">[</span><span class=\"ss\">:success</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"Room </span><span class=\"si\">#{</span><span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">name</span><span class=\"si\">}</span><span class=\"s2\"> was created successfully\"</span>\n      <span class=\"n\">redirect_to</span> <span class=\"n\">rooms_path</span>\n    <span class=\"k\">else</span>\n      <span class=\"n\">render</span> <span class=\"ss\">:new</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">edit</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">update</span>\n    <span class=\"k\">if</span> <span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">update_attributes</span><span class=\"p\">(</span><span class=\"n\">permitted_parameters</span><span class=\"p\">)</span>\n      <span class=\"n\">flash</span><span class=\"p\">[</span><span class=\"ss\">:success</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"Room </span><span class=\"si\">#{</span><span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">name</span><span class=\"si\">}</span><span class=\"s2\"> was updated successfully\"</span>\n      <span class=\"n\">redirect_to</span> <span class=\"n\">rooms_path</span>\n    <span class=\"k\">else</span>\n      <span class=\"n\">render</span> <span class=\"ss\">:new</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"kp\">protected</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">load_entities</span>\n    <span class=\"vi\">@rooms</span> <span class=\"o\">=</span> <span class=\"no\">Room</span><span class=\"p\">.</span><span class=\"nf\">all</span>\n    <span class=\"vi\">@room</span> <span class=\"o\">=</span> <span class=\"no\">Room</span><span class=\"p\">.</span><span class=\"nf\">find</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">[</span><span class=\"ss\">:id</span><span class=\"p\">])</span> <span class=\"k\">if</span> <span class=\"n\">params</span><span class=\"p\">[</span><span class=\"ss\">:id</span><span class=\"p\">]</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">permitted_parameters</span>\n    <span class=\"n\">params</span><span class=\"p\">.</span><span class=\"nf\">require</span><span class=\"p\">(</span><span class=\"ss\">:room</span><span class=\"p\">).</span><span class=\"nf\">permit</span><span class=\"p\">(</span><span class=\"ss\">:name</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Note</strong>: we preload the <code class=\"highlighter-rouge\">@rooms</code> and the <code class=\"highlighter-rouge\">@room</code> variables making them available to all actions with the <code class=\"highlighter-rouge\">before_action :load_entities</code> hook.</p> \n<p>We will create a simple form for the <code class=\"highlighter-rouge\">Room</code> object and we will use it both when creating and editing a room. Create the <code class=\"highlighter-rouge\">app/views/rooms/_form.html.erb</code> and add:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"cp\">&lt;%=</span> <span class=\"n\">simple_form_for</span> <span class=\"vi\">@room</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">form</span><span class=\"o\">|</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"cp\">&lt;%=</span> <span class=\"n\">form</span><span class=\"p\">.</span><span class=\"nf\">input</span> <span class=\"ss\">:name</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"cp\">&lt;%=</span> <span class=\"n\">form</span><span class=\"p\">.</span><span class=\"nf\">submit</span> <span class=\"s2\">\"Save\"</span><span class=\"p\">,</span> <span class=\"ss\">class: </span><span class=\"s1\">'btn btn-success'</span> <span class=\"cp\">%&gt;</span>\n<span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Then, create the views for the <code class=\"highlighter-rouge\">new</code>/<code class=\"highlighter-rouge\">edit</code> action accordingly:</p> \n<p><em>app/views/rooms/new.html.erb</em></p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;h1&gt;</span>\n  Creating a room  \n<span class=\"nt\">&lt;/h1&gt;</span>\n\n<span class=\"cp\">&lt;%=</span> <span class=\"n\">render</span> <span class=\"ss\">partial: </span><span class=\"s1\">'form'</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p><em>app/views/rooms/edit.html.erb</em></p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;h1&gt;</span>\n  Editing room <span class=\"cp\">&lt;%=</span> <span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">name</span> <span class=\"cp\">%&gt;</span>\n<span class=\"nt\">&lt;/h1&gt;</span>\n\n<span class=\"cp\">&lt;%=</span> <span class=\"n\">render</span> <span class=\"ss\">partial: </span><span class=\"s1\">'form'</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Time to create the first room. From the rooms’ index page, press the <code class=\"highlighter-rouge\">Create a room</code></p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/11.png\" alt=\"New room\" /></p> \n<p>Save and here it is.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/12.png\" alt=\"Room index with rooms\" /></p> \n<p>Add this class in <code class=\"highlighter-rouge\">app/assets/stylesheets/rails-chat-tutorial.scss</code> to improve the display of the rooms.</p> \n<div class=\"language-css highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nc\">.room-nav-link</span> <span class=\"p\">{</span>\n  <span class=\"nl\">border</span><span class=\"p\">:</span> <span class=\"m\">1px</span> <span class=\"nb\">solid</span> <span class=\"n\">lighten</span><span class=\"p\">(</span><span class=\"err\">$</span><span class=\"n\">primary</span><span class=\"p\">,</span> <span class=\"m\">40%</span><span class=\"p\">);</span>\n  <span class=\"nl\">background</span><span class=\"p\">:</span> <span class=\"n\">lighten</span><span class=\"p\">(</span><span class=\"err\">$</span><span class=\"n\">primary</span><span class=\"p\">,</span> <span class=\"m\">45%</span><span class=\"p\">);</span>\n\n  <span class=\"err\">&amp;</span> <span class=\"err\">+</span> <span class=\"err\">.room-nav-link</span> <span class=\"err\">{</span>\n    <span class=\"nl\">border-top</span><span class=\"p\">:</span> <span class=\"m\">0</span> <span class=\"nb\">none</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n<span class=\"err\">}</span>\n</code></pre>\n </div>\n</div> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/13.png\" alt=\"Room index with improved rooms\" /></p> \n<p><strong>Note</strong>: We will add the <code class=\"highlighter-rouge\">edit</code> link in the room’s page a.k.a. <code class=\"highlighter-rouge\">show</code> action.</p> \n<p>Before moving on to the Room page, we will refactor the index page so as to be able to use the left column’s content inside the room page as well.</p> \n<p>Create the partial <code class=\"highlighter-rouge\">app/views/rooms/_rooms.html.erb</code> with contents:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"mb-3\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"cp\">&lt;%=</span> <span class=\"n\">link_to</span> <span class=\"n\">new_room_path</span><span class=\"p\">,</span> <span class=\"ss\">class: </span><span class=\"s1\">'btn btn-primary'</span> <span class=\"k\">do</span> <span class=\"cp\">%&gt;</span>\n    Create a room\n  <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n<span class=\"nt\">&lt;/div&gt;</span>\n\n<span class=\"cp\">&lt;%</span> <span class=\"k\">if</span> <span class=\"vi\">@rooms</span><span class=\"p\">.</span><span class=\"nf\">present?</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;nav</span> <span class=\"na\">class=</span><span class=\"s\">\"nav flex-column\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"cp\">&lt;%</span> <span class=\"vi\">@rooms</span><span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">room</span><span class=\"o\">|</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"cp\">&lt;%=</span> <span class=\"n\">link_to</span> <span class=\"n\">room</span><span class=\"p\">.</span><span class=\"nf\">name</span><span class=\"p\">,</span> <span class=\"n\">room_path</span><span class=\"p\">(</span><span class=\"n\">room</span><span class=\"p\">),</span> <span class=\"ss\">class: </span><span class=\"s1\">'nav-link room-nav-link'</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/nav&gt;</span>\n<span class=\"cp\">&lt;%</span> <span class=\"k\">else</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"text-muted\"</span><span class=\"nt\">&gt;</span>\n    The are no rooms\n  <span class=\"nt\">&lt;/div&gt;</span>\n<span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>and change the <code class=\"highlighter-rouge\">app/views/rooms/index.html.erb</code> to use it:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-12 col-md-3\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">render</span> <span class=\"ss\">partial: </span><span class=\"s1\">'rooms'</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"alert alert-primary\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;h4</span> <span class=\"na\">class=</span><span class=\"s\">\"alert-heading\"</span><span class=\"nt\">&gt;</span>\n        Welcome to the RailsChatTutorial!\n      <span class=\"nt\">&lt;/h4&gt;</span>\n\n      <span class=\"nt\">&lt;p&gt;</span>\n        We need to talk.\n      <span class=\"nt\">&lt;/p&gt;</span>\n\n      <span class=\"nt\">&lt;hr</span> <span class=\"nt\">/&gt;</span>\n\n      <span class=\"nt\">&lt;p&gt;</span>\n        You can create or join a room from the sidebar.\n      <span class=\"nt\">&lt;/p&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n<span class=\"nt\">&lt;/div&gt;</span>\n</code></pre>\n </div>\n</div> \n<h4 id=\"room-page\">Room page</h4> \n<p>Add the <code class=\"highlighter-rouge\">show</code> action in the <code class=\"highlighter-rouge\">app/controllers/rooms_controller.rb</code>:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">show</span>\n  <span class=\"vi\">@room_message</span> <span class=\"o\">=</span> <span class=\"no\">RoomMessage</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"ss\">room: </span><span class=\"vi\">@room</span>\n  <span class=\"vi\">@room_messages</span> <span class=\"o\">=</span> <span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">room_messages</span><span class=\"p\">.</span><span class=\"nf\">includes</span><span class=\"p\">(</span><span class=\"ss\">:user</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Notes:</strong></p> \n<ul> \n <li>We construct a new room message which we are going to use in the view to build a form for creating the chat messages.</li> \n <li>When displaying the room message, we access its user’s email attribute to resolve the gravatar hash. We used <code class=\"highlighter-rouge\">.includes(:user)</code> in the query for the <code class=\"highlighter-rouge\">@room_messages</code> to fetch them along with their users avoiding <a href=\"https://medium.com/@bretdoucette/n-1-queries-and-how-to-avoid-them-a12f02345be5\">N+1 queries</a><sup><a href=\"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments\">[1]</a></sup>.</li> \n</ul> \n<p>Create the view <code class=\"highlighter-rouge\">app/views/rooms/show.html.erb</code>:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;h1&gt;</span>\n  <span class=\"cp\">&lt;%=</span> <span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">name</span> <span class=\"cp\">%&gt;</span>\n<span class=\"nt\">&lt;/h1&gt;</span>\n\n<span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-12 col-md-3\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">render</span> <span class=\"ss\">partial: </span><span class=\"s1\">'rooms'</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"chat\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"cp\">&lt;%</span> <span class=\"vi\">@room_messages</span><span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">room_message</span><span class=\"o\">|</span> <span class=\"cp\">%&gt;</span>\n        <span class=\"cp\">&lt;%=</span> <span class=\"n\">room_message</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">simple_form_for</span> <span class=\"vi\">@room_message</span><span class=\"p\">,</span> <span class=\"ss\">remote: </span><span class=\"kp\">true</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">form</span><span class=\"o\">|</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"input-group mb-3\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"cp\">&lt;%=</span> <span class=\"n\">form</span><span class=\"p\">.</span><span class=\"nf\">input</span> <span class=\"ss\">:message</span><span class=\"p\">,</span> <span class=\"ss\">as: :string</span><span class=\"p\">,</span>\n                                 <span class=\"ss\">wrapper: </span><span class=\"kp\">false</span><span class=\"p\">,</span>\n                                 <span class=\"ss\">label: </span><span class=\"kp\">false</span><span class=\"p\">,</span>\n                                 <span class=\"ss\">input_html: </span><span class=\"p\">{</span>\n                                   <span class=\"ss\">class: </span><span class=\"s1\">'chat-input'</span>\n                                 <span class=\"p\">}</span> <span class=\"cp\">%&gt;</span>\n        <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"input-group-append\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"cp\">&lt;%=</span> <span class=\"n\">form</span><span class=\"p\">.</span><span class=\"nf\">submit</span> <span class=\"s2\">\"Send\"</span><span class=\"p\">,</span> <span class=\"ss\">class: </span><span class=\"s1\">'btn btn-primary chat-input'</span> <span class=\"cp\">%&gt;</span>\n        <span class=\"nt\">&lt;/div&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n\n      <span class=\"cp\">&lt;%=</span> <span class=\"n\">form</span><span class=\"p\">.</span><span class=\"nf\">input</span> <span class=\"ss\">:room_id</span><span class=\"p\">,</span> <span class=\"ss\">as: :hidden</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n<span class=\"nt\">&lt;/div&gt;</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Notes:</strong></p> \n<ul> \n <li>We reused the <code class=\"highlighter-rouge\">app/views/rooms/_rooms.html.erb</code> partial that we created in the previous step</li> \n <li>We added a <code class=\"highlighter-rouge\">div</code> with class <code class=\"highlighter-rouge\">.chat</code> and this is where the room’s messages are rendered.</li> \n <li>We added a form for the <code class=\"highlighter-rouge\">@room_message</code> that we instantiated in the controller. We also used the directive <code class=\"highlighter-rouge\">remote: true</code> when we instantiated the form thus the form is going to be submitted by <strong>Ajax</strong>.</li> \n <li>We added a hidden field for the attribute <code class=\"highlighter-rouge\">:room_id</code> so that the value reaches the <code class=\"highlighter-rouge\">RoomMessagesController</code> once we submit the form.</li> \n</ul> \n<p>Style the chat components by adding the following lines to the <code class=\"highlighter-rouge\">app/assets/stylesheets/rails-chat-tutorial.scss</code>:</p> \n<div class=\"language-css highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nc\">.chat</span> <span class=\"p\">{</span>\n  <span class=\"nl\">border</span><span class=\"p\">:</span> <span class=\"m\">1px</span> <span class=\"nb\">solid</span> <span class=\"n\">lighten</span><span class=\"p\">(</span><span class=\"err\">$</span><span class=\"n\">secondary</span><span class=\"p\">,</span> <span class=\"m\">40%</span><span class=\"p\">);</span>\n  <span class=\"nl\">background</span><span class=\"p\">:</span> <span class=\"n\">lighten</span><span class=\"p\">(</span><span class=\"err\">$</span><span class=\"n\">secondary</span><span class=\"p\">,</span> <span class=\"m\">50%</span><span class=\"p\">);</span>\n  <span class=\"nl\">height</span><span class=\"p\">:</span> <span class=\"m\">50vh</span><span class=\"p\">;</span>\n  <span class=\"nl\">border-radius</span><span class=\"p\">:</span> <span class=\"m\">5px</span> <span class=\"m\">5px</span> <span class=\"m\">0</span> <span class=\"m\">0</span><span class=\"p\">;</span>\n  <span class=\"nl\">overflow-y</span><span class=\"p\">:</span> <span class=\"nb\">auto</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"nc\">.chat-input</span> <span class=\"p\">{</span>\n  <span class=\"nl\">border-top</span><span class=\"p\">:</span> <span class=\"m\">0</span> <span class=\"nb\">none</span><span class=\"p\">;</span>\n  <span class=\"nl\">border-radius</span><span class=\"p\">:</span> <span class=\"m\">0</span> <span class=\"m\">0</span> <span class=\"m\">5px</span> <span class=\"m\">5px</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre>\n </div>\n</div> \n<p>Navigate to a room to see what has been done.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/14.png\" alt=\"Room page with chat\" /></p> \n<p>Pressing the <code class=\"highlighter-rouge\">Send</code> button nothing happens on the page but if you check the server’s console you will notice:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>AbstractController::ActionNotFound (The action 'create' could not be found for RoomMessagesController):\n</code></pre>\n </div>\n</div> \n<p>Let’s fix that.</p> \n<h4 id=\"creating-room-messages\">Creating room messages</h4> \n<p>This is going to be easy. All we have to do is implement the <code class=\"highlighter-rouge\">create</code> action in the <code class=\"highlighter-rouge\">RoomMessagesController</code>.</p> \n<p><em>app/controllers/room_messages_controller.rb</em></p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">RoomMessagesController</span> <span class=\"o\">&lt;</span> <span class=\"no\">ApplicationController</span>\n  <span class=\"n\">before_action</span> <span class=\"ss\">:load_entities</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">create</span>\n    <span class=\"vi\">@room_message</span> <span class=\"o\">=</span> <span class=\"no\">RoomMessage</span><span class=\"p\">.</span><span class=\"nf\">create</span> <span class=\"ss\">user: </span><span class=\"n\">current_user</span><span class=\"p\">,</span>\n                                       <span class=\"ss\">room: </span><span class=\"vi\">@room</span><span class=\"p\">,</span>\n                                       <span class=\"ss\">message: </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"ss\">:room_message</span><span class=\"p\">,</span> <span class=\"ss\">:message</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n\n  <span class=\"kp\">protected</span>\n\n  <span class=\"k\">def</span> <span class=\"nf\">load_entities</span>\n    <span class=\"vi\">@room</span> <span class=\"o\">=</span> <span class=\"no\">Room</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"n\">params</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"ss\">:room_message</span><span class=\"p\">,</span> <span class=\"ss\">:room_id</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Notes:</strong></p> \n<ul> \n <li>we preload the room using the <code class=\"highlighter-rouge\">room_id</code> parameter that we added as a hidden field in the form in the previous step</li> \n <li>we create a new message for the room setting its user to the currently signed in user</li> \n</ul> \n<p>If you try to submit a message now, again you will see nothing but in the server console you can see from the log that the room message has been created.</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>Started POST \"/room_messages\" for ::1 at 2019-04-04 19:24:33 +0300\nProcessing by RoomMessagesController#create as JS\n  Parameters: {\"utf8\"=&gt;\"✓\", \"room_message\"=&gt;{\"message\"=&gt;\"My first message\", \"room_id\"=&gt;\"8\"}, \"commit\"=&gt;\"Send\"}\n  User Load (0.2ms)  SELECT  \"users\".* FROM \"users\" WHERE \"users\".\"id\" = ? ORDER BY \"users\".\"id\" ASC LIMIT ?  [[\"id\", 1], [\"LIMIT\", 1]]\n  ↳ /home/iridakos/.rvm/gems/ruby-2.6.2@rails-chat-tutorial/gems/activerecord-5.2.3/lib/active_record/log_subscriber.rb:98\n  Room Load (0.2ms)  SELECT  \"rooms\".* FROM \"rooms\" WHERE \"rooms\".\"id\" = ? LIMIT ?  [[\"id\", 8], [\"LIMIT\", 1]]\n  ↳ app/controllers/room_messages_controller.rb:13\n   (0.1ms)  begin transaction\n  ↳ app/controllers/room_messages_controller.rb:5\n  RoomMessage Create (0.7ms)  INSERT INTO \"room_messages\" (\"room_id\", \"user_id\", \"message\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?, ?)  [[\"room_id\", 8], [\"user_id\", 1], [\"message\", \"My first message\"], [\"created_at\", \"2019-04-04 16:24:33.456641\"], [\"updated_at\", \"2019-04-04 16:24:33.456641\"]]\n  ↳ app/controllers/room_messages_controller.rb:5\n   (4.0ms)  commit transaction\n  ↳ app/controllers/room_messages_controller.rb:5\nNo template found for RoomMessagesController#create, rendering head :no_content\nCompleted 204 No Content in 88ms (ActiveRecord: 5.1ms)\n</code></pre>\n </div>\n</div> \n<p>A user would expect to have the message field cleared after sending a new message. We don’t disappoint users.</p> \n<p>Create a file <code class=\"highlighter-rouge\">app/assets/javascripts/room.js</code> and add the following:</p> \n<div class=\"language-js highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n  <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">#new_room_message</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">ajax:success</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">a</span><span class=\"p\">,</span> <span class=\"nx\">b</span><span class=\"p\">,</span><span class=\"nx\">c</span> <span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">).</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">input[type=\"text\"]</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nx\">val</span><span class=\"p\">(</span><span class=\"dl\">''</span><span class=\"p\">);</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">});</span>\n</code></pre>\n </div>\n</div> \n<p>We bind to the <code class=\"highlighter-rouge\">ajax:success</code> event triggered by <a href=\"https://guides.rubyonrails.org/working_with_javascript_in_rails.html#form-with\">Rails</a> on successful submission of the form and all we want to do is clear the text field’s value.</p> \n<p>Reload the page and try submitting again and check it out. The field value should be emptied after sending the message.</p> \n<h4 id=\"displaying-room-messages\">Displaying room messages</h4> \n<p>If you reload the page you will see something like this:</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/15.png\" alt=\"Room message to string\" /></p> \n<p>Let’s beautify the messages.</p> \n<p>Replace the contents of <code class=\"highlighter-rouge\">app/views/rooms/show.html.erb</code> with:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;h1&gt;</span>\n  <span class=\"cp\">&lt;%=</span> <span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">name</span> <span class=\"cp\">%&gt;</span>\n<span class=\"nt\">&lt;/h1&gt;</span>\n\n<span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-12 col-md-3\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">render</span> <span class=\"ss\">partial: </span><span class=\"s1\">'rooms'</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"chat\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"cp\">&lt;%</span> <span class=\"vi\">@room_messages</span><span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">room_message</span><span class=\"o\">|</span> <span class=\"cp\">%&gt;</span>\n        <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"chat-message-container\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row no-gutters\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-auto text-center\"</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">\"</span><span class=\"cp\">&lt;%=</span> <span class=\"n\">gravatar_url</span><span class=\"p\">(</span><span class=\"n\">room_message</span><span class=\"p\">.</span><span class=\"nf\">user</span><span class=\"p\">)</span> <span class=\"cp\">%&gt;</span><span class=\"s\">\"</span> <span class=\"na\">class=</span><span class=\"s\">\"avatar\"</span> <span class=\"na\">alt=</span><span class=\"s\">\"\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;/div&gt;</span>\n\n            <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col\"</span><span class=\"nt\">&gt;</span>\n              <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"message-content\"</span><span class=\"nt\">&gt;</span>\n                <span class=\"nt\">&lt;p</span> <span class=\"na\">class=</span><span class=\"s\">\"mb-1\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"cp\">&lt;%=</span> <span class=\"n\">room_message</span><span class=\"p\">.</span><span class=\"nf\">message</span> <span class=\"cp\">%&gt;</span>\n                <span class=\"nt\">&lt;/p&gt;</span>\n\n                <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"text-right\"</span><span class=\"nt\">&gt;</span>\n                  <span class=\"nt\">&lt;small&gt;</span>\n                    <span class=\"cp\">&lt;%=</span> <span class=\"n\">room_message</span><span class=\"p\">.</span><span class=\"nf\">created_at</span> <span class=\"cp\">%&gt;</span>\n                  <span class=\"nt\">&lt;/small&gt;</span>\n                <span class=\"nt\">&lt;/div&gt;</span>\n              <span class=\"nt\">&lt;/div&gt;</span>\n            <span class=\"nt\">&lt;/div&gt;</span>\n          <span class=\"nt\">&lt;/div&gt;</span>\n        <span class=\"nt\">&lt;/div&gt;</span>\n      <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n\n    <span class=\"cp\">&lt;%=</span> <span class=\"n\">simple_form_for</span> <span class=\"vi\">@room_message</span><span class=\"p\">,</span> <span class=\"ss\">remote: </span><span class=\"kp\">true</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">form</span><span class=\"o\">|</span> <span class=\"cp\">%&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"input-group mb-3\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"cp\">&lt;%=</span> <span class=\"n\">form</span><span class=\"p\">.</span><span class=\"nf\">input</span> <span class=\"ss\">:message</span><span class=\"p\">,</span> <span class=\"ss\">as: :string</span><span class=\"p\">,</span>\n                                 <span class=\"ss\">wrapper: </span><span class=\"kp\">false</span><span class=\"p\">,</span>\n                                 <span class=\"ss\">label: </span><span class=\"kp\">false</span><span class=\"p\">,</span>\n                                 <span class=\"ss\">input_html: </span><span class=\"p\">{</span>\n                                   <span class=\"ss\">class: </span><span class=\"s1\">'chat-input'</span>\n                                 <span class=\"p\">}</span> <span class=\"cp\">%&gt;</span>\n        <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"input-group-append\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"cp\">&lt;%=</span> <span class=\"n\">form</span><span class=\"p\">.</span><span class=\"nf\">submit</span> <span class=\"s2\">\"Send\"</span><span class=\"p\">,</span> <span class=\"ss\">class: </span><span class=\"s1\">'btn btn-primary chat-input'</span> <span class=\"cp\">%&gt;</span>\n        <span class=\"nt\">&lt;/div&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n\n      <span class=\"cp\">&lt;%=</span> <span class=\"n\">form</span><span class=\"p\">.</span><span class=\"nf\">input</span> <span class=\"ss\">:room_id</span><span class=\"p\">,</span> <span class=\"ss\">as: :hidden</span> <span class=\"cp\">%&gt;</span>\n    <span class=\"cp\">&lt;%</span> <span class=\"k\">end</span> <span class=\"cp\">%&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n<span class=\"nt\">&lt;/div&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>and add the following css classes <strong>inside the .chat class</strong>:</p> \n<div class=\"language-css highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nc\">.chat-message-container</span> <span class=\"p\">{</span>\n  <span class=\"nl\">padding</span><span class=\"p\">:</span> <span class=\"m\">5px</span><span class=\"p\">;</span>\n\n  <span class=\"err\">.avatar</span> <span class=\"err\">{</span>\n    <span class=\"nl\">margin</span><span class=\"p\">:</span> <span class=\"m\">5px</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nc\">.message-content</span> <span class=\"p\">{</span>\n    <span class=\"nl\">padding</span><span class=\"p\">:</span> <span class=\"m\">5px</span><span class=\"p\">;</span>\n    <span class=\"nl\">border</span><span class=\"p\">:</span> <span class=\"m\">1px</span> <span class=\"nb\">solid</span> <span class=\"err\">$</span><span class=\"n\">primary</span><span class=\"p\">;</span>\n    <span class=\"nl\">border-radius</span><span class=\"p\">:</span> <span class=\"m\">5px</span><span class=\"p\">;</span>\n    <span class=\"nl\">background</span><span class=\"p\">:</span> <span class=\"n\">lighten</span><span class=\"p\">(</span><span class=\"err\">$</span><span class=\"n\">primary</span><span class=\"p\">,</span> <span class=\"m\">10%</span><span class=\"p\">);</span>\n    <span class=\"nl\">color</span><span class=\"p\">:</span> <span class=\"err\">$</span><span class=\"no\">white</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"o\">&amp;</span> <span class=\"o\">+</span> <span class=\"nc\">.chat-message-container</span> <span class=\"p\">{</span>\n    <span class=\"nl\">margin-top</span><span class=\"p\">:</span> <span class=\"m\">10px</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n<span class=\"err\">}</span>\n</code></pre>\n </div>\n</div> \n<p>Reload the page. Magic.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/16.png\" alt=\"Improved display of room messages\" /></p> \n<h2 id=\"introducing-websockets---actioncable\">Introducing WebSockets - ActionCable</h2> \n<p>Time to start using WebSockets with ActionCable.</p> \n<blockquote> \n <p>Action Cable seamlessly integrates WebSockets with the rest of your Rails application. It allows for real-time features to be written in Ruby in the same style and form as the rest of your Rails application, while still being performant and scalable. It’s a full-stack offering that provides both a client-side JavaScript framework and a server-side Ruby framework. You have access to your full domain model written with Active Record or your ORM of choice. <cite>– <a href=\"https://guides.rubyonrails.org/action_cable_overview.html\">Action Cable Overview @ Ruby on Rails Guides (v5.2.3)</a></cite></p> \n</blockquote> \n<h3 id=\"install-redis\">Install redis</h3> \n<p>We are going to use the <code class=\"highlighter-rouge\">redis</code> adapter which is <a href=\"https://guides.rubyonrails.org/action_cable_overview.html#redis-adapter\">a safe option for production environments</a> unlike the <code class=\"highlighter-rouge\">async</code> one.</p> \n<p>You first must install <a href=\"https://redis.io/\">redis</a> on your system.</p> \n<p>To install it on Ubuntu you just have to execute the following commands in your terminal:</p> \n<div class=\"language-bash highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nb\">sudo </span>apt update\n<span class=\"nb\">sudo </span>apt <span class=\"nb\">install </span>redis-server\n</code></pre>\n </div>\n</div> \n<p>To check that installation is successful, in your terminal make sure you get a PONG:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>$ redis-cli\n127.0.0.1:6379&gt; ping\nPONG\n</code></pre>\n </div>\n</div> \n<h3 id=\"configure-actioncable\">Configure ActionCable</h3> \n<p>Since we are working on the development environment, open your <code class=\"highlighter-rouge\">config/cable.yml</code> and replace its contents with:</p> \n<div class=\"language-yml highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"na\">development</span><span class=\"pi\">:</span>\n  <span class=\"na\">adapter</span><span class=\"pi\">:</span> <span class=\"s\">redis</span>\n  <span class=\"na\">url</span><span class=\"pi\">:</span> <span class=\"s\">&lt;%= ENV.fetch(\"REDIS_URL\") { \"redis://localhost:6379/1\" } %&gt;</span>\n  <span class=\"na\">channel_prefix</span><span class=\"pi\">:</span> <span class=\"s\">rails-chat-tutorial_development</span>\n\n<span class=\"na\">test</span><span class=\"pi\">:</span>\n  <span class=\"na\">adapter</span><span class=\"pi\">:</span> <span class=\"s\">async</span>\n\n<span class=\"na\">production</span><span class=\"pi\">:</span>\n  <span class=\"na\">adapter</span><span class=\"pi\">:</span> <span class=\"s\">redis</span>\n  <span class=\"na\">url</span><span class=\"pi\">:</span> <span class=\"s\">&lt;%= ENV.fetch(\"REDIS_URL\") { \"redis://localhost:6379/1\" } %&gt;</span>\n  <span class=\"na\">channel_prefix</span><span class=\"pi\">:</span> <span class=\"s\">rails-chat-tutorial_production</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Note:</strong> we have added an option <code class=\"highlighter-rouge\">channel_prefix</code> because:</p> \n<blockquote> \n <p>Additionally, a channel_prefix may be provided to avoid channel name collisions when using the same Redis server for multiple applications <cite>– <a href=\"https://guides.rubyonrails.org/action_cable_overview.html#redis-adapter\">Action Cable Overview # Redis Adapter @ Ruby on Rails Guides (v5.2.3)</a></cite></p> \n</blockquote> \n<p>Finally, we are going to add the dependency in the <code class=\"highlighter-rouge\">Gemfile</code>:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"n\">gem</span> <span class=\"s1\">'redis'</span>\n</code></pre>\n </div>\n</div> \n<p>Don’t forget to bundle after altering the <code class=\"highlighter-rouge\">Gemfile</code>.</p> \n<h3 id=\"configure-devise-for-authenticating-websocket-connections\">Configure Devise for authenticating websocket connections</h3> \n<p>When establishing a websocket connection, we don’t have access to the user session but we do have access to the cookies. So, in order to be able to authenticate the user we need to do some devise related stuff first (<a href=\"https://rubytutorial.io/actioncable-devise-authentication/\">credits to Greg Molnar</a>).</p> \n<p>Create an initializer for warden hooks under the name <code class=\"highlighter-rouge\">config/initializers/warden_hooks.rb</code> and add the following lines:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"no\">Warden</span><span class=\"o\">::</span><span class=\"no\">Manager</span><span class=\"p\">.</span><span class=\"nf\">after_set_user</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">user</span><span class=\"p\">,</span><span class=\"n\">auth</span><span class=\"p\">,</span><span class=\"n\">opts</span><span class=\"o\">|</span>\n  <span class=\"n\">scope</span> <span class=\"o\">=</span> <span class=\"n\">opts</span><span class=\"p\">[</span><span class=\"ss\">:scope</span><span class=\"p\">]</span>\n  <span class=\"n\">auth</span><span class=\"p\">.</span><span class=\"nf\">cookies</span><span class=\"p\">.</span><span class=\"nf\">signed</span><span class=\"p\">[</span><span class=\"s2\">\"</span><span class=\"si\">#{</span><span class=\"n\">scope</span><span class=\"si\">}</span><span class=\"s2\">.id\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">user</span><span class=\"p\">.</span><span class=\"nf\">id</span>\n<span class=\"k\">end</span>\n\n<span class=\"no\">Warden</span><span class=\"o\">::</span><span class=\"no\">Manager</span><span class=\"p\">.</span><span class=\"nf\">before_logout</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">user</span><span class=\"p\">,</span> <span class=\"n\">auth</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">|</span>\n  <span class=\"n\">scope</span> <span class=\"o\">=</span> <span class=\"n\">opts</span><span class=\"p\">[</span><span class=\"ss\">:scope</span><span class=\"p\">]</span>\n  <span class=\"n\">auth</span><span class=\"p\">.</span><span class=\"nf\">cookies</span><span class=\"p\">.</span><span class=\"nf\">signed</span><span class=\"p\">[</span><span class=\"s2\">\"</span><span class=\"si\">#{</span><span class=\"n\">scope</span><span class=\"si\">}</span><span class=\"s2\">.id\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kp\">nil</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Explain:</strong> We add a cookie with the user’s id upon successful sign in and we remove it once the user logs out.</p> \n<h3 id=\"configure-the-websocket-connection\">Configure the websocket connection</h3> \n<p>Open <code class=\"highlighter-rouge\">app/channels/application_cable/connection.rb</code> and change its contents to the following:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">module</span> <span class=\"nn\">ApplicationCable</span>\n  <span class=\"k\">class</span> <span class=\"nc\">Connection</span> <span class=\"o\">&lt;</span> <span class=\"no\">ActionCable</span><span class=\"o\">::</span><span class=\"no\">Connection</span><span class=\"o\">::</span><span class=\"no\">Base</span>\n    <span class=\"n\">identified_by</span> <span class=\"ss\">:current_user</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">connect</span>\n      <span class=\"nb\">self</span><span class=\"p\">.</span><span class=\"nf\">current_user</span> <span class=\"o\">=</span> <span class=\"n\">find_verified_user</span>\n    <span class=\"k\">end</span>\n\n    <span class=\"kp\">private</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">find_verified_user</span>\n      <span class=\"k\">if</span> <span class=\"n\">verified_user</span> <span class=\"o\">=</span> <span class=\"no\">User</span><span class=\"p\">.</span><span class=\"nf\">find_by</span><span class=\"p\">(</span><span class=\"ss\">id: </span><span class=\"n\">cookies</span><span class=\"p\">.</span><span class=\"nf\">signed</span><span class=\"p\">[</span><span class=\"s1\">'user.id'</span><span class=\"p\">])</span>\n        <span class=\"n\">verified_user</span>\n      <span class=\"k\">else</span>\n        <span class=\"n\">reject_unauthorized_connection</span>\n      <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Explain:</strong></p> \n<blockquote> \n <p>Here identified_by is a connection identifier that can be used to find the specific connection later. Note that anything marked as an identifier will automatically create a delegate by the same name on any channel instances created off the connection. <cite>– <a href=\"https://guides.rubyonrails.org/action_cable_overview.html#connection-setup\">Action Cable Overview # Connection setup @ Ruby on Rails Guides (v5.2.3)</a></cite></p> \n</blockquote> \n<p>In the <code class=\"highlighter-rouge\">find_verified_user</code> method we access the cookie that we previously set in the warden hook.</p> \n<h3 id=\"create-the-room-channel\">Create the room channel</h3> \n<blockquote> \n <p>A channel encapsulates a logical unit of work, similar to what a controller does in a regular MVC setup. <cite>– <a href=\"https://guides.rubyonrails.org/action_cable_overview.html#channelsp\">Action Cable Overview # Channels @ Ruby on Rails Guides (v5.2.3)</a></cite></p> \n</blockquote> \n<p>We will create the <code class=\"highlighter-rouge\">RoomChannel</code> in which all Room pages will subscribe to.</p> \n<p>Create <code class=\"highlighter-rouge\">app/channels/room_channel.rb</code> with the following contents:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">RoomChannel</span> <span class=\"o\">&lt;</span> <span class=\"no\">ApplicationCable</span><span class=\"o\">::</span><span class=\"no\">Channel</span>\n  <span class=\"k\">def</span> <span class=\"nf\">subscribed</span>\n    <span class=\"n\">room</span> <span class=\"o\">=</span> <span class=\"no\">Room</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"n\">params</span><span class=\"p\">[</span><span class=\"ss\">:room</span><span class=\"p\">]</span>\n    <span class=\"n\">stream_for</span> <span class=\"n\">room</span>\n\n    <span class=\"c1\"># or</span>\n    <span class=\"c1\"># stream_from \"room_#{params[:room]}\"</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Explain</strong>:</p> \n<ul> \n <li>The <code class=\"highlighter-rouge\">subscribed</code> method gets called once a subscription to the channel is established and it is responsible to setup the stream from which data will be sent back and forth.</li> \n</ul> \n<p>We are going to configure the room page code later on to request subscriptions to this channel passing the <code class=\"highlighter-rouge\">room</code> parameter.</p> \n<p>We have two options:</p> \n<ul> \n <li>Use <code class=\"highlighter-rouge\">stream_for</code>: this way Rails automatically generates a stream name for the given object (<code class=\"highlighter-rouge\">room</code> in our case), for example: “room:asdfwer234”. When we want afterwards to broadcast data to the stream, all we have to do is call <code class=\"highlighter-rouge\">RoomChannel.broadcast_to(room_object, data)</code> in which case Rails resolves the stream name from the <code class=\"highlighter-rouge\">room_object</code>. In other words, we don’t have to manually resolve the stream name in which the data have to be send (see next item). \n  <ul> \n   <li>This option is available when the channel handles subscriptions bound to models like in our case, a specific room</li> \n  </ul> </li> \n <li>Use <code class=\"highlighter-rouge\">stream_from</code>: we manually define the name of the stream and later on, when we want to broadcast to the stream, we have to use: <code class=\"highlighter-rouge\">ActionCable.server.broadcast(\"room_#{a_room_id_here}\", data)</code>.</li> \n</ul> \n<p>Read more <a href=\"https://guides.rubyonrails.org/action_cable_overview.html#streams\">here</a>.</p> \n<h3 id=\"broadcast-room-messages\">Broadcast room messages</h3> \n<p>Every time a room message is being created, we just need to broadcast to the message’s room stream. To do so, alter the <code class=\"highlighter-rouge\">create</code> action of the <code class=\"highlighter-rouge\">app/controllers/room_messages_controller.rb</code> to this:</p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">create</span>\n  <span class=\"vi\">@room_message</span> <span class=\"o\">=</span> <span class=\"no\">RoomMessage</span><span class=\"p\">.</span><span class=\"nf\">create</span> <span class=\"ss\">user: </span><span class=\"n\">current_user</span><span class=\"p\">,</span>\n                                     <span class=\"ss\">room: </span><span class=\"vi\">@room</span><span class=\"p\">,</span>\n                                     <span class=\"ss\">message: </span><span class=\"n\">params</span><span class=\"p\">.</span><span class=\"nf\">dig</span><span class=\"p\">(</span><span class=\"ss\">:room_message</span><span class=\"p\">,</span> <span class=\"ss\">:message</span><span class=\"p\">)</span>\n\n  <span class=\"no\">RoomChannel</span><span class=\"p\">.</span><span class=\"nf\">broadcast_to</span> <span class=\"vi\">@room</span><span class=\"p\">,</span> <span class=\"vi\">@room_message</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Explain</strong>: we added the line <code class=\"highlighter-rouge\">RoomChannel.broadcast_to @room, @room_message</code> which will broadcast to the room’s specific stream (as explained above) the <code class=\"highlighter-rouge\">@room_message</code> transformed to json via the <code class=\"highlighter-rouge\">to_json</code> method.</p> \n<p>So, on the other side, the client side, we are going to be receiving the json representation of the <code class=\"highlighter-rouge\">RoomMessage</code> model. Let’s see what that is:</p> \n<div class=\"language-json highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"nl\">\"id\"</span><span class=\"p\">:</span><span class=\"mi\">29</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"room_id\"</span><span class=\"p\">:</span><span class=\"mi\">8</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"user_id\"</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"message\"</span><span class=\"p\">:</span><span class=\"s2\">\"My first message\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"created_at\"</span><span class=\"p\">:</span><span class=\"s2\">\"2019-04-04T17:09:00.637Z\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"updated_at\"</span><span class=\"p\">:</span><span class=\"s2\">\"2019-04-04T17:09:00.637Z\"</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre>\n </div>\n</div> \n<p>We plan to add the new messages in the room’s page via Javascript and this information is not adequate. The only thing we are missing is the user avatar. Time to refactor.</p> \n<p>Open <code class=\"highlighter-rouge\">app/models/user.rb</code> and add the following method:</p> \n<div class=\"highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code>def gravatar_url\n  gravatar_id = Digest::MD5::hexdigest(email).downcase\n  \"https://gravatar.com/avatar/#{gravatar_id}.png\"\nend\n</code></pre>\n </div>\n</div> \n<p>We had already implemented this in the <code class=\"highlighter-rouge\">app/helpers/application_helper.rb</code> file and we won’t be using it anymore so <strong>remove it</strong>.</p> \n<p>Update <code class=\"highlighter-rouge\">app/views/shared/_navigation_bar.html.erb</code> and change the previous gravatar resolution to this:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;img</span> <span class=\"na\">class=</span><span class=\"s\">\"avatar\"</span> <span class=\"na\">src=</span><span class=\"s\">\"</span><span class=\"cp\">&lt;%=</span> <span class=\"n\">current_user</span><span class=\"p\">.</span><span class=\"nf\">gravatar_url</span> <span class=\"cp\">%&gt;</span><span class=\"s\">\"</span><span class=\"nt\">&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Update <code class=\"highlighter-rouge\">app/views/rooms/show.html.erb</code> and change it there too, with:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">\"</span><span class=\"cp\">&lt;%=</span> <span class=\"n\">room_message</span><span class=\"p\">.</span><span class=\"nf\">user</span><span class=\"p\">.</span><span class=\"nf\">gravatar_url</span> <span class=\"cp\">%&gt;</span><span class=\"s\">\"</span> <span class=\"na\">class=</span><span class=\"s\">\"avatar\"</span> <span class=\"na\">alt=</span><span class=\"s\">\"\"</span><span class=\"nt\">&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>Finally, we will change the <code class=\"highlighter-rouge\">JSON</code> representation of the <code class=\"highlighter-rouge\">RoomMessage</code> to include the user’s url:</p> \n<p><em>app/models/room_message.rb</em></p> \n<div class=\"language-ruby highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">as_json</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">)</span>\n  <span class=\"k\">super</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">).</span><span class=\"nf\">merge</span><span class=\"p\">(</span><span class=\"ss\">user_avatar_url: </span><span class=\"n\">user</span><span class=\"p\">.</span><span class=\"nf\">gravatar_url</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre>\n </div>\n</div> \n<p>Let’s confirm that the new JSON transformation is valid:</p> \n<div class=\"language-json highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"nl\">\"id\"</span><span class=\"p\">:</span><span class=\"mi\">29</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"room_id\"</span><span class=\"p\">:</span><span class=\"mi\">8</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"user_id\"</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"message\"</span><span class=\"p\">:</span><span class=\"s2\">\"My first message\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"created_at\"</span><span class=\"p\">:</span><span class=\"s2\">\"2019-04-04T17:09:00.637Z\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"updated_at\"</span><span class=\"p\">:</span><span class=\"s2\">\"2019-04-04T17:09:00.637Z\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"user_avatar_url\"</span><span class=\"p\">:</span><span class=\"s2\">\"https://gravatar.com/avatar/02a28db6886d578f75a820b50f2dd334.png\"</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre>\n </div>\n</div> \n<p>Great, moving on.</p> \n<h3 id=\"subscribe-to-the-room-stream\">Subscribe to the room stream</h3> \n<p>We are going to add some data in the room page in order to use them via Javascript to subscribe to the appropriate streams each time we visit a room.</p> \n<p>Open the file <code class=\"highlighter-rouge\">app/views/rooms/show.html.erb</code> and alter the line in which we define the chat div, to this:</p> \n<div class=\"language-erb highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"chat\"</span> <span class=\"na\">data-channel-subscribe=</span><span class=\"s\">\"room\"</span> <span class=\"na\">data-room-id=</span><span class=\"s\">\"</span><span class=\"cp\">&lt;%=</span> <span class=\"vi\">@room</span><span class=\"p\">.</span><span class=\"nf\">id</span> <span class=\"cp\">%&gt;</span><span class=\"s\">\"</span><span class=\"nt\">&gt;</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Explain</strong>: We added two data attributes, one defining to which channel we want to subscribe and one defining to which room we are.</p> \n<p>At the end of the file, add the following snippet:</p> \n<div class=\"language-html highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"d-none\"</span> <span class=\"na\">data-role=</span><span class=\"s\">\"message-template\"</span><span class=\"nt\">&gt;</span>\n  <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"chat-message-container\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"row no-gutters\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col-auto text-center\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">\"\"</span> <span class=\"na\">class=</span><span class=\"s\">\"avatar\"</span> <span class=\"na\">alt=</span><span class=\"s\">\"\"</span> <span class=\"na\">data-role=</span><span class=\"s\">\"user-avatar\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n\n      <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"col\"</span><span class=\"nt\">&gt;</span>\n        <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"message-content\"</span><span class=\"nt\">&gt;</span>\n          <span class=\"nt\">&lt;p</span> <span class=\"na\">class=</span><span class=\"s\">\"mb-1\"</span> <span class=\"na\">data-role=</span><span class=\"s\">\"message-text\"</span><span class=\"nt\">&gt;&lt;/p&gt;</span>\n\n          <span class=\"nt\">&lt;div</span> <span class=\"na\">class=</span><span class=\"s\">\"text-right\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;small</span> <span class=\"na\">data-role=</span><span class=\"s\">\"message-date\"</span><span class=\"nt\">&gt;&lt;/small&gt;</span>\n          <span class=\"nt\">&lt;/div&gt;</span>\n        <span class=\"nt\">&lt;/div&gt;</span>\n      <span class=\"nt\">&lt;/div&gt;</span>\n    <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n<span class=\"nt\">&lt;/div&gt;</span>\n</code></pre>\n </div>\n</div> \n<p>This snippet is going to be used as a template for each incoming message. Every time a message arrives, we will</p> \n<ul> \n <li>clone this html</li> \n <li>alter the appropriate elements’ values and</li> \n <li>append the resulting html to the end of the chat div.</li> \n</ul> \n<p>Now we will create the Javascript that will do the work of subscribing and handling incoming channel data.</p> \n<p>Create the file <code class=\"highlighter-rouge\">app/assets/javascripts/channels/room_channel.js</code> and add the following code:</p> \n<div class=\"language-js highlighter-rouge\">\n <div class=\"highlight\">\n  <pre class=\"highlight\"><code><span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n  <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">[data-channel-subscribe=\"room\"]</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nx\">each</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">index</span><span class=\"p\">,</span> <span class=\"nx\">element</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">$element</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"nx\">element</span><span class=\"p\">),</span>\n        <span class=\"nx\">room_id</span> <span class=\"o\">=</span> <span class=\"nx\">$element</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">room-id</span><span class=\"dl\">'</span><span class=\"p\">)</span>\n        <span class=\"nx\">messageTemplate</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">[data-role=\"message-template\"]</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n\n    <span class=\"nx\">$element</span><span class=\"p\">.</span><span class=\"nx\">animate</span><span class=\"p\">({</span> <span class=\"na\">scrollTop</span><span class=\"p\">:</span> <span class=\"nx\">$element</span><span class=\"p\">.</span><span class=\"nx\">prop</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">scrollHeight</span><span class=\"dl\">\"</span><span class=\"p\">)},</span> <span class=\"mi\">1000</span><span class=\"p\">)</span>        \n\n    <span class=\"nx\">App</span><span class=\"p\">.</span><span class=\"nx\">cable</span><span class=\"p\">.</span><span class=\"nx\">subscriptions</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span>\n      <span class=\"p\">{</span>\n        <span class=\"na\">channel</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">RoomChannel</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n        <span class=\"na\">room</span><span class=\"p\">:</span> <span class=\"nx\">room_id</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"na\">received</span><span class=\"p\">:</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n          <span class=\"kd\">var</span> <span class=\"nx\">content</span> <span class=\"o\">=</span> <span class=\"nx\">messageTemplate</span><span class=\"p\">.</span><span class=\"nx\">children</span><span class=\"p\">().</span><span class=\"nx\">clone</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">);</span>\n          <span class=\"nx\">content</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">[data-role=\"user-avatar\"]</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nx\">attr</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">src</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">user_avatar_url</span><span class=\"p\">);</span>\n          <span class=\"nx\">content</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">[data-role=\"message-text\"]</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nx\">text</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">);</span>\n          <span class=\"nx\">content</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">[data-role=\"message-date\"]</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nx\">text</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">updated_at</span><span class=\"p\">);</span>\n          <span class=\"nx\">$element</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"nx\">content</span><span class=\"p\">);</span>\n          <span class=\"nx\">$element</span><span class=\"p\">.</span><span class=\"nx\">animate</span><span class=\"p\">({</span> <span class=\"na\">scrollTop</span><span class=\"p\">:</span> <span class=\"nx\">$element</span><span class=\"p\">.</span><span class=\"nx\">prop</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">scrollHeight</span><span class=\"dl\">\"</span><span class=\"p\">)},</span> <span class=\"mi\">1000</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">);</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">});</span>\n</code></pre>\n </div>\n</div> \n<p><strong>Explain</strong>:</p> \n<ul> \n <li>For each element that has a data attribute <code class=\"highlighter-rouge\">channel-subscribe</code> with value <code class=\"highlighter-rouge\">room</code> \n  <ul> \n   <li>Create a subscription to the “RoomChannel” passing the element’s <code class=\"highlighter-rouge\">room-id</code> data attribute as a parameter with name <code class=\"highlighter-rouge\">room</code> (remember this line of the <code class=\"highlighter-rouge\">RoomChannel</code>: <code class=\"highlighter-rouge\">Room.find params[:room]</code> ?) \n    <ul> \n     <li>When data is received, clone the template snippet and alter its contents based on the incoming object attributes.</li> \n     <li>Append the newly generated content to the chat div and finally</li> \n     <li>Do some animation to impress by scrolling smoothly to the bottom of the div.</li> \n    </ul> </li> \n  </ul> </li> \n</ul> \n<h2 id=\"acknowledgments\">Acknowledgments</h2> \n<p>Thank you very much for your feedback.</p> \n<ul> \n <li>[1] Armando Andini - <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/3\">N+1 queries</a></li> \n <li>[2] Rodolfo Ruiz - <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/5\">Coffeescript leftovers</a></li> \n <li>[3] Felix Wolfsteller - <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/1\">Turbolinks leftovers</a></li> \n <li>[4] Maria Kravtsova - <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/2\">Migration typo</a></li> \n <li>[5][7][8] Tony Dehnke - <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/6\">Sign up step</a>, <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/8\">Missing step for adding model relations</a>, <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/7\">Missing line from html code block</a></li> \n <li>[6] keytonw - <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/9\">Devise view missing button class</a></li> \n <li>[9] Martin - <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/11\">Mention order of requirements in application.js</a></li> \n <li>[10] Sumak - <a href=\"https://github.com/iridakos/rails-chat-tutorial/issues/15\">Remove duplicate authentication related code</a></li> \n</ul> \n<p>That’s all! Long post, tired cat photo.</p> \n<p><img src=\"https://iridakos.com/assets/images/posts/rails-chat-tutorial/irida.jpg\" alt=\"Tired cat photo\" /></p> \n<div class=\"alert alert-light\"> \n <div class=\"alert-heading\">\n  <i class=\"fa fa-comments\"></i> Code and comments\n </div> You can find the code of this tutorial on \n <a class=\"alert-link\" href=\"https://github.com/iridakos/rails-chat-tutorial\"><i class=\"fa fa-github\"></i> GitHub</a>. \n <hr /> For feedback, comments, typos etc. please open an \n <a class=\"alert-link\" href=\"https://github.com/iridakos/rails-chat-tutorial/issues\">issue</a> in the repository. \n <hr /> \n <strong>Thanks for visiting!</strong> \n</div>","descriptionType":"text/html","publishedDate":"Thu, 04 Apr 2019 20:00:00 +0000","feedId":45746,"bgimg":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/rails-chat-tutorial.gif","linkMd5":"b083687e9fb744afb17cc5914561979b","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn48@2020_4/2020/11/18/05-50-29-639_a94a4d2f428f9e8f.webp","destWidth":1158,"destHeight":863,"sourceBytes":167245,"destBytes":86896,"author":"","articleImgCdnMap":{"https://iridakos.com/assets/images/posts/rails-chat-tutorial/rails-chat-tutorial.gif":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn48@2020_4/2020/11/18/05-50-29-639_a94a4d2f428f9e8f.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/01-rails-new.png":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn100@2020_2/2020/11/18/05-50-30-842_4b0a7d4bd07b3b5c.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/02.png":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn60@2020_1/2020/11/18/05-50-31-008_da55d2000fe67bd2.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/03.png":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn56@2020_5/2020/11/18/05-50-30-789_f871168941d09859.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/04.png":"https://cdn.jsdelivr.net/gh/myreaderx/cdn8@2020_3/2020/11/18/05-50-31-082_69219012aa5233f0.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/05.png":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn4@2020_6/2020/11/18/05-50-31-030_90623d4058ddf0af.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/06.png":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn12@2020_5/2020/11/18/05-50-30-740_b1e83714d4ec28de.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/07.png":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn16@2020_3/2020/11/18/05-50-30-773_1e4825e7e3aeb8a3.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/08.png":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn79@2020_3/2020/11/18/05-50-30-778_1a19dda27d2d4a02.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/09.png":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn88@2020_2/2020/11/18/05-50-30-769_44668db4a0062396.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/10.png":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn51@2020_3/2020/11/18/05-50-30-750_340dd0e26f8e5baa.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/11.png":null,"https://iridakos.com/assets/images/posts/rails-chat-tutorial/12.png":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn64@2020_5/2020/11/18/05-50-31-004_72d7931b48450ff6.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/13.png":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn76@2020_4/2020/11/18/05-50-30-808_b82a8759fc2b7f48.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/14.png":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn71@2020_3/2020/11/18/05-50-30-788_f48b5da51ec98c86.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/15.png":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn96@2020_3/2020/11/18/05-50-30-829_dd23b8aedfc4f842.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/16.png":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn84@2020_1/2020/11/18/05-50-31-112_f3450bdae6282e85.webp","https://iridakos.com/assets/images/posts/rails-chat-tutorial/irida.jpg":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn92@2020_4/2020/11/18/05-50-30-885_7d028bd74be96130.webp"},"publishedOrCreatedDate":1605678606128}],"record":{"createdTime":"2020-11-18 13:50:06","updatedTime":"2020-11-18 13:50:06","feedId":45746,"fetchDate":"Wed, 18 Nov 2020 05:50:06 +0000","fetchMs":89,"handleMs":211,"totalMs":26361,"newArticles":0,"totalArticles":30,"status":1,"type":0,"ip":"1bc2e11d54d94d2e8b384096218a63f0","hostName":"us-011*","requestId":"892ba200f6ad49fd9c50121c3e3806a4_45746","contentType":"application/xml","totalBytes":464682,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":18,"articlesImgsGithubTotal":17,"successGithubMap":{"myreaderx8":1,"myreaderx25":1,"myreaderx15":1,"myreaderx6":1,"myreaderx16":1,"myreaderx4":1,"myreaderx32":1,"myreaderx10":1,"myreaderx3":1,"myreaderx22":1,"myreaderx2":1,"myreaderx13":1,"myreaderx31":1,"myreaderx5oss":1,"myreaderx18":1,"myreaderx19":1,"myreaderx":1},"failGithubMap":{"myreaderx14":1}},"feed":{"createdTime":"2020-09-07 03:39:19","updatedTime":"2020-09-07 05:58:16","id":45746,"name":"iridakos","url":"https://iridakos.com/feed.xml","subscriber":70,"website":null,"icon":"https://iridakos.com/assets/images/site.png","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx64/cdn1@2020_1/2020/09/06/21-57-23-464_da9f1a871df2fb3f.png","description":"Lazarus Lazaridis' personal blog with posts mostly related to programming and opensource. And cats.","weekly":null,"link":null},"noPictureArticleList":[{"createdTime":"2020-11-18 13:50:32","updatedTime":"2020-11-18 13:50:32","id":null,"feedId":45746,"linkMd5":"b083687e9fb744afb17cc5914561979b"}],"tmpCommonImgCdnBytes":86896,"tmpBodyImgCdnBytes":377786,"tmpBgImgCdnBytes":0,"extra4":{"start":1605678605809,"total":0,"statList":[{"spend":108,"msg":"获取xml内容"},{"spend":211,"msg":"解释文章"},{"spend":1,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":1514,"msg":"正文链接上传到cdn"}]},"extra5":18,"extra6":18,"extra7ImgCdnFailResultVector":[{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/11.png","sourceStatusCode":200,"destWidth":1129,"destHeight":271,"sourceBytes":19220,"destBytes":9240,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":169,"convertSpendMs":34,"createdTime":"2020-11-18 13:50:30","host":"us-039*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx14/cdn67/contents/2020/11/18/05-50-30-779_bba9efbaccc618cd.webp","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 68584859.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Wed, 18 Nov 2020 05:50:30 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["403 Forbidden"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["B7F0:070B:3D1F3B1:653FC4C:5FB4B620"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1605681027"],"x-ratelimit-used":["60"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx14/cdn67/contents/2020/11/18/05-50-30-779_bba9efbaccc618cd.webp","historyStatusCode":[],"spendMs":39},"base64UserPassword":null,"token":"6b67d******************************91b08"},"githubUser":"myreaderx14","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"9 KB","compressRate":"48.1%","sourceSize":"18.8 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/11.png","sourceStatusCode":200,"destWidth":1129,"destHeight":271,"sourceBytes":19220,"destBytes":9240,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":156,"convertSpendMs":43,"createdTime":"2020-11-18 13:50:30","host":"us-039*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx14/cdn67/contents/2020/11/18/05-50-30-940_bba9efbaccc618cd.webp","resp":{"code":403,"msg":"Forbidden","body":"{\n  \"message\": \"API rate limit exceeded for user ID 68584859.\",\n  \"documentation_url\": \"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Wed, 18 Nov 2020 05:50:30 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["403 Forbidden"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"transfer-encoding":["chunked"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":["repo"],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["B7F0:070B:3D1F3C4:6540166:5FB4B626"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["60"],"x-ratelimit-remaining":["0"],"x-ratelimit-reset":["1605681027"],"x-ratelimit-used":["60"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 403,url is : https://api.github.com/repos/myreaderx14/cdn67/contents/2020/11/18/05-50-30-940_bba9efbaccc618cd.webp","historyStatusCode":[],"spendMs":45},"base64UserPassword":null,"token":"6b67d******************************91b08"},"githubUser":"myreaderx14","githubHttpCode":403,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"9 KB","compressRate":"48.1%","sourceSize":"18.8 KB"}],"extra10_invalidATagHrefValue":{"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets_/programming/2019/04/07/dockerizing-a-rails-application":"https://iridakos.com/programming/2019/04/07/dockerizing-a-rails-application","https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets_/programming/2019/04/04/creating-chat-application-rails-websockets":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets_#acknowledgments":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets#acknowledgments"},"extra111_proxyServerAndStatMap":{"http://us-039.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]},"http://us-53.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe65.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-002.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-035.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe61.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-015.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-006.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-23.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe69.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-031.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-019.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-57.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-010.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-023.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]},"http://us-027.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/rails-chat-tutorial.gif","sourceStatusCode":200,"destWidth":1158,"destHeight":863,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn48@2020_4/2020/11/18/05-50-29-639_a94a4d2f428f9e8f.webp","sourceBytes":167245,"destBytes":86896,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":24412,"convertSpendMs":23356,"createdTime":"2020-11-18 13:50:06","host":"us-035*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b,b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx3","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"84.9 KB","compressRate":"52%","sourceSize":"163.3 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/10.png","sourceStatusCode":200,"destWidth":1150,"destHeight":275,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn51@2020_3/2020/11/18/05-50-30-750_340dd0e26f8e5baa.webp","sourceBytes":25842,"destBytes":12842,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":871,"convertSpendMs":15,"createdTime":"2020-11-18 13:50:30","host":"us-023*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx8","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"12.5 KB","compressRate":"49.7%","sourceSize":"25.2 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/08.png","sourceStatusCode":200,"destWidth":1129,"destHeight":555,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn79@2020_3/2020/11/18/05-50-30-778_1a19dda27d2d4a02.webp","sourceBytes":20470,"destBytes":10814,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":883,"convertSpendMs":34,"createdTime":"2020-11-18 13:50:30","host":"us-002*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"10.6 KB","compressRate":"52.8%","sourceSize":"20 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/14.png","sourceStatusCode":200,"destWidth":1130,"destHeight":834,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn71@2020_3/2020/11/18/05-50-30-788_f48b5da51ec98c86.webp","sourceBytes":22858,"destBytes":12102,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":879,"convertSpendMs":33,"createdTime":"2020-11-18 13:50:30","host":"us-027*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx22","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"11.8 KB","compressRate":"52.9%","sourceSize":"22.3 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/03.png","sourceStatusCode":200,"destWidth":1173,"destHeight":76,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn56@2020_5/2020/11/18/05-50-30-789_f871168941d09859.webp","sourceBytes":3206,"destBytes":3156,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":886,"convertSpendMs":16,"createdTime":"2020-11-18 13:50:30","host":"us-010*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"3.1 KB","compressRate":"98.4%","sourceSize":"3.1 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/06.png","sourceStatusCode":200,"destWidth":1177,"destHeight":437,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn12@2020_5/2020/11/18/05-50-30-740_b1e83714d4ec28de.webp","sourceBytes":15453,"destBytes":8392,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":920,"convertSpendMs":24,"createdTime":"2020-11-18 13:50:30","host":"us-035*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"8.2 KB","compressRate":"54.3%","sourceSize":"15.1 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/07.png","sourceStatusCode":200,"destWidth":1150,"destHeight":497,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn16@2020_3/2020/11/18/05-50-30-773_1e4825e7e3aeb8a3.webp","sourceBytes":17165,"destBytes":8924,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":956,"convertSpendMs":41,"createdTime":"2020-11-18 13:50:30","host":"us-023*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"8.7 KB","compressRate":"52%","sourceSize":"16.8 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/09.png","sourceStatusCode":200,"destWidth":1126,"destHeight":134,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn88@2020_2/2020/11/18/05-50-30-769_44668db4a0062396.webp","sourceBytes":13552,"destBytes":6758,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":978,"convertSpendMs":8,"createdTime":"2020-11-18 13:50:30","host":"us-53*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx19","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"6.6 KB","compressRate":"49.9%","sourceSize":"13.2 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/15.png","sourceStatusCode":200,"destWidth":1126,"destHeight":836,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn96@2020_3/2020/11/18/05-50-30-829_dd23b8aedfc4f842.webp","sourceBytes":29347,"destBytes":15374,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":970,"convertSpendMs":51,"createdTime":"2020-11-18 13:50:30","host":"us-019*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"15 KB","compressRate":"52.4%","sourceSize":"28.7 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/13.png","sourceStatusCode":200,"destWidth":1138,"destHeight":278,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn76@2020_4/2020/11/18/05-50-30-808_b82a8759fc2b7f48.webp","sourceBytes":26827,"destBytes":13622,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":994,"convertSpendMs":20,"createdTime":"2020-11-18 13:50:30","host":"us-015*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx13","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"13.3 KB","compressRate":"50.8%","sourceSize":"26.2 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/01-rails-new.png","sourceStatusCode":200,"destWidth":579,"destHeight":683,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn100@2020_2/2020/11/18/05-50-30-842_4b0a7d4bd07b3b5c.webp","sourceBytes":251146,"destBytes":48024,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":1185,"convertSpendMs":50,"createdTime":"2020-11-18 13:50:30","host":"us-006*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"46.9 KB","compressRate":"19.1%","sourceSize":"245.3 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/04.png","sourceStatusCode":200,"destWidth":941,"destHeight":259,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx/cdn8@2020_3/2020/11/18/05-50-31-082_69219012aa5233f0.webp","sourceBytes":10194,"destBytes":6268,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":1182,"convertSpendMs":39,"createdTime":"2020-11-18 13:50:30","host":"europe-57*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"6.1 KB","compressRate":"61.5%","sourceSize":"10 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/irida.jpg","sourceStatusCode":200,"destWidth":1280,"destHeight":1433,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn92@2020_4/2020/11/18/05-50-30-885_7d028bd74be96130.webp","sourceBytes":395431,"destBytes":186518,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":1313,"convertSpendMs":101,"createdTime":"2020-11-18 13:50:30","host":"us-031*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"182.1 KB","compressRate":"47.2%","sourceSize":"386.2 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/16.png","sourceStatusCode":200,"destWidth":1133,"destHeight":842,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn84@2020_1/2020/11/18/05-50-31-112_f3450bdae6282e85.webp","sourceBytes":29476,"destBytes":14174,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":1284,"convertSpendMs":28,"createdTime":"2020-11-18 13:50:30","host":"europe65*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx5oss","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"13.8 KB","compressRate":"48.1%","sourceSize":"28.8 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/02.png","sourceStatusCode":200,"destWidth":691,"destHeight":105,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn60@2020_1/2020/11/18/05-50-31-008_da55d2000fe67bd2.webp","sourceBytes":10228,"destBytes":7948,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":1296,"convertSpendMs":6,"createdTime":"2020-11-18 13:50:30","host":"europe-23*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"7.8 KB","compressRate":"77.7%","sourceSize":"10 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/12.png","sourceStatusCode":200,"destWidth":1178,"destHeight":286,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn64@2020_5/2020/11/18/05-50-31-004_72d7931b48450ff6.webp","sourceBytes":26462,"destBytes":13098,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":1307,"convertSpendMs":13,"createdTime":"2020-11-18 13:50:30","host":"europe61*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"12.8 KB","compressRate":"49.5%","sourceSize":"25.8 KB"},{"code":1,"isDone":false,"source":"https://iridakos.com/assets/images/posts/rails-chat-tutorial/05.png","sourceStatusCode":200,"destWidth":1132,"destHeight":355,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn4@2020_6/2020/11/18/05-50-31-030_90623d4058ddf0af.webp","sourceBytes":14572,"destBytes":9772,"targetWebpQuality":75,"feedId":45746,"totalSpendMs":1338,"convertSpendMs":21,"createdTime":"2020-11-18 13:50:30","host":"europe69*","referer":"https://iridakos.com/programming/2019/04/04/creating-chat-application-rails-websockets","linkMd5ListStr":"b083687e9fb744afb17cc5914561979b","githubUser":"myreaderx2","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"destSize":"9.5 KB","compressRate":"67.1%","sourceSize":"14.2 KB"}],"successGithubMap":{"myreaderx8":1,"myreaderx25":1,"myreaderx15":1,"myreaderx6":1,"myreaderx16":1,"myreaderx4":1,"myreaderx32":1,"myreaderx10":1,"myreaderx3":1,"myreaderx22":1,"myreaderx2":1,"myreaderx13":1,"myreaderx31":1,"myreaderx5oss":1,"myreaderx18":1,"myreaderx19":1,"myreaderx":1},"failGithubMap":{"myreaderx14":1}}