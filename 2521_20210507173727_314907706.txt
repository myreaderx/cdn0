{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2021-05-08 01:35:23","updatedTime":"2021-05-08 01:35:23","title":"Java 8 ConcurrentHashMap源码中竟然隐藏着两个BUG","link":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+Java%C2%A08%C2%A0ConcurrentHashMap%E6%BA%90%E7%A0%81%E4%B8%AD%E7%AB%9F%E7%84%B6%E9%9A%90%E8%97%8F%E7%9D%80%E4%B8%A4%E4%B8%AABUG","description":"<div><div><div id=\"media\" class=\"rich_media_thumb_wrp\">\n\n            <img class=\"rich_media_thumb\" src=\"http://content.sov5.cn/mmbiz_jpg/eZzl4LXykQxR3KWMVyX3rJRiaRriczKLxL3BUapNG3SMcZQy6gicicOLfzibTPpee9pMtibV6IicXQIIFzxH4UxpswvSw?imageView2/1/w/600\">\n        </div>\n    \n\n    \n\n    <div class=\"rich_media_content\" id=\"js_content\">\n                    \n\n                    \n                    \n                    \n                    <p style=\"text-align: center;\"><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;color: rgb(255, 41, 65);line-height: 22.4px;\">（给</span><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;line-height: 22.4px;color: rgb(0, 128, 255);\">ImportNew</span><span style=\"font-size: 14px;letter-spacing: 0.5440000295639038px;text-align: center;max-width: 100%;color: rgb(255, 41, 65);line-height: 22.4px;\">加星标，提高Java技能）</span></p><blockquote><p><span style=\"font-size: 14px;\">转自：石杉的架构笔记</span></p></blockquote><section style=\"margin-top: 5px;margin-bottom: 5px;padding-top: 8px;padding-bottom: 8px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 7</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrenHashMap</code>的<a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=Mzk0NjExMjU3Mg==&amp;mid=2247484661&amp;idx=1&amp;sn=0005cd08cf76c6bab5727ec532983415&amp;chksm=c30a55a6f47ddcb04891349eef82f61830c6df7495944184fd98f1253913edd9e3187e73ddae&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" data-linktype=\"2\" hasload=\"1\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">源码</a>我建议大家都看看，那个版本的源码就是<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java</code>多线程编程的教科书。在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 7</code>的源码中，作者对悲观锁的使用非常谨慎，大多都转换为自旋锁加<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>volatile</code>获得相同的语义，即使最后迫不得已要用，作者也会通过各种技巧减少锁的临界区。在上一篇文章中我们也有讲到，自旋锁在临界区比较小的时候是一个较优的选择是因为它避免了线程由于阻塞而切换上下文，但本质上它也是个锁，在自旋等待期间只有一个线程能进入临界区，其他线程只会自旋消耗<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CPU</code>的时间片。<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>中<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>的实现通过一些巧妙的设计和技巧，避开了自旋锁的局限，提供了更高的并发性能。如果说<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 7</code>版本的源码是在教我们如何将悲观锁转换为自旋锁，那么在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>中我们甚至可以看到如何将自旋锁转换为无锁的方法和技巧。</section><h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 18px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>把书读薄</h2><figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left flex column center border-box break-word><img data-ratio=\"0.28793103448275864\" data-type=\"png\" data-w=\"2320\" style=\"margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; width: 677px !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvicIeiaDmgzDGzAh50zu8uibcTzY7acGCJI84Y9J86iaJ0aPK0mD9ASTdR6Q/640?wx_fmt=png\"><figcaption style=\"margin-top: 5px;max-width: 100%;text-align: center;color: rgb(136, 136, 136);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">image</figcaption></figure><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>图片来源：https://www.zhenchao.org/2019/01/31/java/cas-based-concurrent-hashmap/</p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>在开始本文之前，大家首先在心里还是要有这样的一张图，如果有同学对<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>HashMap</code>比较熟悉，那这张图也应该不会陌生。事实上在整体的数据结构的设计上<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>和<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>HashMap</code>基本上是一致的。</p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 7</code>中<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>为了提升性能使用了很多的编程技巧，但是引入<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Segment</code>的设计还是有很大的改进空间的，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 7</code>中<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrrentHashMap</code>的设计有下面这几个可以改进的点：</p><ol data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Segment</code>在扩容的时候非扩容线程对本<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Segment</code>的写操作时都要挂起等待的</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">对<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>的读操作需要做两次哈希寻址，在读多写少的情况下其实是有额外的性能损失的</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">尽管<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>size()</code>方法的实现中先尝试无锁读，但是如果在这个过程中有别的线程做写入操作，那调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>size()</code>的这个线程就会给整个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>加锁，这是整个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrrentHashMap</code>唯一一个全局锁，这点对底层的组件来说还是有性能隐患的</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">极端情况下（比如客户端实现了一个性能很差的哈希函数）<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>get()</code>方法的复杂度会退化到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>O(n)</code>。</section></li></ol><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>针对1和2，在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>的设计是废弃了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Segment</code>的使用，将悲观锁的粒度降低至桶维度，因此调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>get</code>的时候也不需要再做两次哈希了。<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>size()</code>的设计是<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>版本中最大的亮点，我们在后面的文章中会详细说明。至于红黑树，这篇文章仍然不做过多阐述。接下来的篇幅会深挖细节，把书读厚，涉及到的模块有：初始化，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>put</code>方法, 扩容方法<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transfer</code>以及<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>size()</code>方法，而其他模块，比如<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>hash</code>函数等改变较小，故不再深究。</p><h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 18px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"color: rgb(123, 12, 0);\">准备知识</span></h2><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">ForwardingNode</code></span></h3><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">static</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">class</span> <span style=\"max-width: 100%;color: rgb(68, 85, 136);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">ForwardingNode</span>&lt;<span style=\"max-width: 100%;color: rgb(68, 85, 136);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">K</span>,<span style=\"max-width: 100%;color: rgb(68, 85, 136);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">V</span>&gt; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">extends</span> <span style=\"max-width: 100%;color: rgb(68, 85, 136);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">Node</span>&lt;<span style=\"max-width: 100%;color: rgb(68, 85, 136);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">K</span>,<span style=\"max-width: 100%;color: rgb(68, 85, 136);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">V</span>&gt; </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> Node<k>[] nextTable;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    ForwardingNode(Node<k>[] tab) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// MOVED = -1，ForwardingNode的哈希值为-1</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">super</span>(MOVED, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>.nextTable = tab;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></k></k></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>除了普通的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Node</code>和<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>TreeNode</code>之外，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>还引入了一个新的数据类型<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ForwardingNode</code>，我们这里只展示他的构造方法，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ForwardingNode</code>的作用有两个：</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">在动态扩容的过程中标志某个桶已经被复制到了新的桶数组中</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">如果在动态扩容的时候有<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>get</code>方法的调用，则<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ForwardingNode</code>将会把请求转发到新的桶数组中，以避免阻塞<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>get</code>方法的调用，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ForwardingNode</code>在构造的时候会将扩容后的桶数组<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>nextTable</code>保存下来。</section></li></ul><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 5px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">UNSAFE.compareAndSwap***</code></span></h3><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>这是在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>版本的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>实现<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>的工具，以<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>int</code>类型为例其方法定义如下：</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">/**<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">* Atomically update Java variable to <tt>x</tt> if it is currently<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">* holding <tt>expected</tt>.<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">* <span style=\"max-width: 100%;color: rgb(221, 17, 68);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">@return</span> <tt>true</tt> if successful<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">*/</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">public</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">native</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">compareAndSwapInt</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(Object o, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> offset,<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                              <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> expected,<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                              <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> x)</span></span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>相应的语义为：</p><blockquote data-tool=\"mdnice编辑器\" style=\"margin-top: 20px;margin-bottom: 20px;padding: 10px 10px 10px 20px;border-left-color: rgba(0, 0, 0, 0.4);color: rgb(106, 115, 125);font-size: 0.9em;max-width: 100%;letter-spacing: 0.544px;white-space: normal;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left none auto rgba border-box break-word><p style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-size: 14px;color: black;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">如果对象<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>o</code>起始地址偏移量为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>offset</code>的值等于<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>expected</code>，则将该值设为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>x</code>，并返回<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>true</code>表明更新成功，否则返回<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>false</code>，表明<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>失败</p></blockquote><h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"color: rgb(123, 12, 0);\">初始化</span></h2><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">public</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">ConcurrentHashMap</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> initialCapacity, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">float</span> loadFactor, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> concurrencyLevel)</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (!(loadFactor &gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0.0f</span>) || initialCapacity 0 || concurrencyLevel &lt;= <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 检查参数</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">throw</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> IllegalArgumentException();<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (initialCapacity         initialCapacity = concurrencyLevel;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> size = (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span>)(<span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1.0</span> + (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span>)initialCapacity / loadFactor);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> cap = (size &gt;= (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span>)MAXIMUM_CAPACITY) ?<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        MAXIMUM_CAPACITY : tableSizeFor((<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span>)size); <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// tableSizeFor，求不小于size的 2^n的算法，jdk1.8的HashMap中说过</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>.sizeCtl = cap; <br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>即使是最复杂的一个初始化方法代码也是比较简单的，这里我们只需要注意两个点：</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>concurrencyLevel</code>在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 7</code>中是<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Segment</code>数组的长度，由于在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>中已经废弃了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Segment</code>，因此<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>concurrencyLevel</code>只是一个保留字段，无实际意义</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>这个值第一次出现，这个值如果等于-1则表明系统正在初始化，如果是其他负数则表明系统正在扩容，在扩容时<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>二进制的低十六位等于扩容的线程数加一，高十六位（除符号位之外）包含桶数组的大小信息</section></li></ul><h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"color: rgb(123, 12, 0);\">put</span></code><span style=\"color: rgb(123, 12, 0);\">方法</span></h2><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">public</span> V <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">put</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(K key, V value)</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> putVal(key, value, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>put</code>方法将调用转发到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>putVal</code>方法：</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> V <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">putVal</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(K key, V value, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> onlyIfAbsent)</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (key == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> || value == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">throw</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> NullPointerException();<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> hash = spread(key.hashCode());<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> binCount = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">for</span> (Node<k>[] tab = table;;) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        Node<k> f; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> n, i, fh;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【A】延迟初始化</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (tab == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> || (n = tab.length) == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            tab = initTable();<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【B】当前桶是空的，直接更新</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((f = tabAt(tab, i = (n - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>) &amp; hash)) == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (casTabAt(tab, i, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>,<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> Node<k>(hash, key, value, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>)))<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;                   <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// no lock when adding to empty bin</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【C】如果当前的桶的第一个元素是一个ForwardingNode节点，则该线程尝试加入扩容</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((fh = f.hash) == MOVED)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            tab = helpTransfer(tab, f);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【D】否则遍历桶内的链表或树，并插入</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 暂时折叠起来，后面详细看</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【F】流程走到此处，说明已经put成功，map的记录总数加一</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    addCount(<span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1L</span>, binCount);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></k></k></k></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>从整个代码结构上来看流程还是比较清楚的，我用括号加字母的方式标注了几个非常重要的步骤，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>put</code>方法依然牵扯出很多的知识点</p><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">桶数组的初始化</span></h3><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">private</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> Node<k>[] initTable() {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    Node<k>[] tab; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> sc;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">while</span> ((tab = table) == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> || tab.length == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((sc = sizeCtl) 0)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 说明已经有线程在初始化了，本线程开始自旋</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            Thread.yield(); <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// lost initialization race; just spin</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (U.compareAndSwapInt(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, SIZECTL, sc, -<span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// CAS保证只有一个线程能走到这个分支</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">try</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((tab = table) == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> || tab.length == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> n = (sc &gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) ? sc : DEFAULT_CAPACITY;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    <span style=\"max-width: 100%;color: rgb(153, 153, 153);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">@SuppressWarnings</span>(<span style=\"max-width: 100%;color: rgb(221, 17, 68);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">\"unchecked\"</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    Node<k>[] nt = (Node<k>[])<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> Node,?&gt;[n];<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    table = tab = nt;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// sc = n - n/4 = 0.75n</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    sc = n - (n &gt;&gt;&gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">2</span>);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            } <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">finally</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 恢复sizeCtl &gt; 0相当于释放锁</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                sizeCtl = sc;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> tab;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></k></k></k></k></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>在初始化桶数组的过程中，系统如何保证不会出现并发问题呢，关键点在于自旋锁的使用，当有多个线程都执行<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>initTable</code>方法的时候，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>可以保证只有一个线程能够进入到真正的初始化分支，其他线程都是自旋等待。这段代码中我们关注三点即可：</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">依照前文所述，当有线程开始初始化桶数组时，会通过<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>将<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>置为-1，其他线程以此为标志开始自旋等待</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">当桶数组初始化结束后将<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>的值恢复为正数，其值等于0.75倍的桶数组长度，这个值的含义和之前<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>HashMap</code>中的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>THRESHOLD</code>一致，是系统触发扩容的临界点</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>finally</code>语句中对<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>的操作并没有使用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>是因为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>保证只有一个线程能够执行到这个地方</section></li></ul><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">添加桶数组第一个元素</span></h3><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">static</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <k> <span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">Node<k> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">tabAt</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(Node<k>[] tab, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> i)</k></span> </k></span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> (Node<k>)U.getObjectVolatile(tab, ((<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span>)i <br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">static</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <k> <span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">casTabAt</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(Node<k>[] tab, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> i,<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                    Node<k> c, Node<k> v)</k></k></k></span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> U.compareAndSwapObject(tab, ((<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span>)i </k></k></k></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>put</code>方法的第二个分支会用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>tabAt</code>判断当前桶是否是空的，如果是则会通过<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>写入，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>tabAt</code>通过<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>UNSAFE</code>接口会拿到桶中的最新元素，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>casTabAt</code>通过<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>保证不会有并发问题，如果<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>失败，则通过循环再进入其他分支</p><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">判断是否需要新增线程扩容</span></h3><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> Node<k>[] helpTransfer(Node<k>[] tab, Node<k> f) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    Node<k>[] nextTab; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> sc;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (tab != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> &amp;&amp; (f <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">instanceof</span> ForwardingNode) &amp;&amp;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        (nextTab = ((ForwardingNode<k>)f).nextTable) != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> rs = resizeStamp(tab.length);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                (sc = sizeCtl) 0) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// RESIZE_STAMP_SHIFT = 16</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span> ||<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                sc == rs + MAX_RESIZERS || transferIndex &lt;= <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 这里将sizeCtl的值自增1，表明参与扩容的线程数量+1</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (U.compareAndSwapInt(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, SIZECTL, sc, sc + <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                transfer(tab, nextTab);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> nextTab;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> table;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></k></k></k></k></k></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>在这个地方我们就要详细说下<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>这个标志位了，临时变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>rs</code>由<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>resizeStamp</code>这个方法返回</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">static</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">resizeStamp</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> n)</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// RESIZE_STAMP_BITS = 16</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> Integer.numberOfLeadingZeros(n) | (<span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span> &lt;1));<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>因为入参<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>n</code>是一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>int</code>类型的值，所有<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Integer.numberOfLeadingZeros(n)</code>的返回值介于0到32之间，如果转换成二进制</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Integer.numberOfLeadingZeros(n)</code>的最大值是：00000000 00000000 00000000 00100000</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Integer.numberOfLeadingZeros(n)</code>的最小值是：00000000 00000000 00000000 00000000</section></li></ul><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>因此<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>resizeStampd</code>的返回值也就介于<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>00000000 00000000 10000000 00000000</code>到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>00000000 00000000 10000000 00100000</code>之间，从这个返回值的范围可以看出来<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>resizeStamp</code>的返回值高16位全都是0，是不包含任何信息的。因此在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrrentHashMap</code>中，会把<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>resizeStamp</code>的返回值左移16位拼到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>中，这就是为什么<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>的高16位包含整个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Map</code>大小的原理。有了这个分析，这段代码中比较长的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>if</code>判断也就能看懂了</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span> ||<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    sc == rs + MAX_RESIZERS || transferIndex &lt;= <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs</code>保证所有线程要基于同一个旧的桶数组扩容</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transferIndex &lt;= 0</code>已经有线程完成扩容任务了</section></li></ul><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>至于<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sc == rs + 1 || sc == rs + MAX_RESIZERS</code>这两个判断条件如果是细心的同学一定会觉得难以理解，这个地方确实是JDK的一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>BUG</code>，这个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>BUG</code>已经在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>JDK 12</code>中修复，详细情况可以参考一下Oracle的官网：https://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8214427，这两个判断条件应该写成这样：<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 1 || sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + MAX_RESIZERS</code>,因为直接比较<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>rs</code>和<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sc</code>是没有意义的，必须要有移位操作。它表达的含义是</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 1</code>当前扩容的线程数为0，即已经扩容完成了，就不需要再新增线程扩容</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + MAX_RESIZERS</code>参与扩容的线程数已经到了最大，就不需要再新增线程扩容</section></li></ul><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>真正扩容的逻辑在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transfer</code>方法中，我们后面会详细看，不过有个小细节可以提前注意，如果<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>nextTable</code>已经初始化了，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transfer</code>会返回<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>nextTable</code>的的引用，后续可以直接操作新的桶数组。</p><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">插入新值</span></h3><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>如果桶数组已经初始化好了，该扩容的也扩容了，并且根据哈希定位到的桶中已经有元素了，那流程就跟普通的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>HashMap</code>一样了，唯一一点不同的就是，这时候要给当前的桶加锁，且看代码：</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> V <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">putVal</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(K key, V value, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> onlyIfAbsent)</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (key == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> || value == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">throw</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> NullPointerException();<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> hash = spread(key.hashCode());<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> binCount = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">for</span> (Node<k>[] tab = table;;) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        Node<k> f; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> n, i, fh;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (tab == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> || (n = tab.length) == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>)<span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 折叠</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((f = tabAt(tab, i = (n - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>) &amp; hash)) == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {<span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 折叠}</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((fh = f.hash) == MOVED)<span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 折叠</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            V oldVal = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">synchronized</span> (f) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 要注意这里这个不起眼的判断条件</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (tabAt(tab, i) == f) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (fh &gt;= <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) { <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// fh&gt;=0的节点是链表，否则是树节点或者ForwardingNode</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        binCount = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">for</span> (Node<k> e = f;; ++binCount) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            K ek;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (e.hash == hash &amp;&amp;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                ((ek = e.key) == key ||<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                    (ek != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> &amp;&amp; key.equals(ek)))) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                oldVal = e.val; <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 如果链表中有值了，直接更新</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (!onlyIfAbsent)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                    e.val = value;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            Node<k> pred = e;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((e = e.next) == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 如果流程走到这里，则说明链表中还没值，直接连接到链表尾部</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                pred.next = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> Node<k>(hash, key, value, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 红黑树的操作先略过</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// put成功，map的元素个数+1</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    addCount(<span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1L</span>, binCount);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></k></k></k></k></k></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>这段代码中要特备注意一个不起眼的判断条件（上下文在源码上已经标注出来了）：<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>tabAt(tab, i) == f</code>，这个判断的目的是为了处理调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>put</code>方法的线程和扩容线程的竞争。因为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>synchronized</code>是阻塞锁，如果调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>put</code>方法的线程恰好和扩容线程同时操作同一个桶，且调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>put</code>方法的线程竞争锁失败，等到该线程重新获取到锁的时候，当前桶中的元素就会变成一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ForwardingNode</code>，那就会出现<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>tabAt(tab, i) != f</code>的情况。</p><h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 18px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"color: rgb(123, 12, 0);\">多线程动态扩容</span></h2><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">private</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">void</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">transfer</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(Node<k>[] tab, Node<k>[] nextTab)</k></k></span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> n = tab.length, stride;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((stride = (NCPU &gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>) ? (n &gt;&gt;&gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">3</span>) / NCPU : n)         stride = MIN_TRANSFER_STRIDE; <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// subdivide range</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (nextTab == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 初始化新的桶数组</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">try</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;color: rgb(153, 153, 153);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">@SuppressWarnings</span>(<span style=\"max-width: 100%;color: rgb(221, 17, 68);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">\"unchecked\"</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            Node<k>[] nt = (Node<k>[])<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> Node,?&gt;[n &lt;1];<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            nextTab = nt;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        } <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">catch</span> (Throwable ex) {      <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// try to cope with OOME</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            sizeCtl = Integer.MAX_VALUE;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        nextTable = nextTab;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        transferIndex = n;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> nextn = nextTab.length;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    ForwardingNode<k> fwd = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> ForwardingNode<k>(nextTab);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> finishing = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>; <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// to ensure sweep before committing nextTab</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">for</span> (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> i = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>, bound = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>;;) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        Node<k> f; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> fh;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">while</span> (advance) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> nextIndex, nextBound;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (--i &gt;= bound || finishing)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((nextIndex = transferIndex) &lt;= <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                i = -<span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (U.compareAndSwapInt<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, TRANSFERINDEX, nextIndex,<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        nextBound = (nextIndex &gt; stride ?<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                    nextIndex - stride : <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>))) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                bound = nextBound;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                i = nextIndex - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (i 0 || i &gt;= n || i + n &gt;= nextn) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> sc;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (finishing) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                nextTable = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                table = nextTab;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                sizeCtl = (n &lt;1) - (n &gt;&gt;&gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (U.compareAndSwapInt(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, SIZECTL, sc = sizeCtl, sc - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 判断是会否是最后一个扩容线程</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((sc - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">2</span>) != resizeStamp(n) return;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                finishing = advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                i = n; <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// recheck before commit</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((f = tabAt(tab, i)) == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            advance = casTabAt(tab, i, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>, fwd);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((fh = f.hash) == MOVED) <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 只有最后一个扩容线程才有机会执行这个分支</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>; <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// already processed</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> { <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 复制过程与HashMap类似，这里不再赘述</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">synchronized</span> (f) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">               <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 折叠</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></k></k></k></k></k></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>在深入到源码细节之前我们先根据下图看一下在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>中<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>扩容的几个特点：</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><p style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;line-height: 26px;color: black;box-sizing: border-box !important;overflow-wrap: break-word !important;\">新的桶数组<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>nextTable</code>是原先桶数组长度的2倍，这与之前<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>HashMap</code>一致</p></section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><p style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;line-height: 26px;color: black;box-sizing: border-box !important;overflow-wrap: break-word !important;\">参与扩容的线程也是分段将<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>table</code>中的元素复制到新的桶数组<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>nextTable</code>中</p></section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><p style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;line-height: 26px;color: black;box-sizing: border-box !important;overflow-wrap: break-word !important;\">桶一个桶数组中的元素在新的桶数组中均匀的分布在两个桶中，桶下标相差n(旧的桶数组的长度)，这一点依然与<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>HashMap</code>保持一致</p></section></li></ul><figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left flex column center border-box break-word><img data-ratio=\"0.5167130919220055\" data-type=\"png\" data-w=\"1436\" style=\"margin-right: auto; margin-left: auto; background-color: rgb(238, 237, 235); border-width: 1px; border-style: solid; border-color: rgb(238, 237, 235); background-size: 22px; background-position: center center; background-repeat: no-repeat; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; height: 350.781px !important; width: 677px !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvicbxGEW9kDNPnKUEtTMLSXuDl75TlvaDVQ40UPcfdVkrBHNGG9FeGVnQ/640?wx_fmt=png\"><figcaption style=\"margin-top: 5px;max-width: 100%;text-align: center;color: rgb(136, 136, 136);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">image-20210424202636495</figcaption></figure><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">各个线程之间如何通力协作</span></h3><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>先看一个关键的变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transferIndex</code>，这是一个被<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>volatile</code>修饰的变量，这一点可以保证所有线程读到的一定是最新的值。</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">private</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">transient</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">volatile</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> transferIndex;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>这个值会被第一个参与扩容的线程初始化，因为只有第一个参与扩容的线程才满足条件<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>nextTab == null</code></p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (nextTab == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// initiating</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">try</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 153);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">@SuppressWarnings</span>(<span style=\"max-width: 100%;color: rgb(221, 17, 68);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">\"unchecked\"</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        Node<k>[] nt = (Node<k>[])<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> Node,?&gt;[n &lt;1];<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        nextTab = nt;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    } <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">catch</span> (Throwable ex) {      <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// try to cope with OOME</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        sizeCtl = Integer.MAX_VALUE;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    nextTable = nextTab;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    transferIndex = n;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></k></k></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>在了解了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transferIndex</code>属性的基础上，上面的这个循环就好理解了</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">while</span> (advance) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> nextIndex, nextBound;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">      <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 当bound &lt;= i &lt;= transferIndex的时候i自减跳出这个循环继续干活</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (--i &gt;= bound || finishing)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 扩容的所有任务已经被认领完毕，本线程结束干活</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((nextIndex = transferIndex) &lt;= <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        i = -<span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 否则认领新的一段复制任务，并通过`CAS`更新transferIndex的值</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (U.compareAndSwapInt<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, TRANSFERINDEX, nextIndex,<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                nextBound = (nextIndex &gt; stride ?<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            nextIndex - stride : <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>))) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        bound = nextBound;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        i = nextIndex - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transferIndex</code>就像是一个游标，每个线程认领一段复制任务的时候都会通过CAS将其更新为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transferIndex - stride</code>， <code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>可以保证<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transferIndex</code>可以按照<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>stride</code>这个步长降到0。</p><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">最后一个扩容线程需要二次确认？</span></h3><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>对于每一个扩容线程，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>for</code>循环的变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>i</code>代表要复制的桶的在桶数组中的下标，这个值的上限和下限通过游标<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>transferIndex</code>和步长<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>stride</code>计算得来，当<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>i</code>减小为负数，则说明当前扩容线程完成了扩容任务，这时候流程会走到这个分支：</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// i &gt;= n || i + n &gt;= nextn现在看来取不到</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (i 0 || i &gt;= n || i + n &gt;= nextn) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> sc;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (finishing) { <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【A】完成整个扩容过程</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        nextTable = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        table = nextTab;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        sizeCtl = (n &lt;1) - (n &gt;&gt;&gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>); <br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【B】判断是否是最后一个扩容线程，如果是，则需要重新扫描一遍桶数组，做二次确认</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (U.compareAndSwapInt(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, SIZECTL, sc = sizeCtl, sc - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// (sc - 2) == resizeStamp(n) &lt;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((sc - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">2</span>) != resizeStamp(n) return</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 重新扫描一遍桶数组，做二次确认</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        finishing = advance = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        i = n; <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// recheck before commit</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>因为变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>finishing</code>被初始化为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>false</code>，所以当线程第一次进入这个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>if</code>分支的话，会先执行注释为【B】的这个分支，同时因为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>sizeCtl</code>的低16位被初始化为参与扩容的线程数加一，因此，当条件<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>(sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT</code>满足时，就能证明当前线程就是最后一个扩容线程了，这这时候将<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>i</code>置为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>n</code>重新扫描一遍桶数组，并且将<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>finishing</code>置为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>true</code>保证当桶数组被扫描结束后能够进入注释为【A】的分支结束扩容。</p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>这里就有一个问题，按照我们前面的分析，扩容线程能够通力协作，保证各自负责的桶数组的分段不重不漏，这里为什么还需要做二次确认么？有一个开发者在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>concurrency-interest</code>这个邮件列表中也关于这件事咨询了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Doug Lea</code>(地址：http://cs.oswego.edu/pipermail/concurrency-interest/2020-July/017171.html)，他给出的回复是：</p><blockquote data-tool=\"mdnice编辑器\" style=\"margin-top: 20px;margin-bottom: 20px;padding: 10px 10px 10px 20px;border-left-color: rgba(0, 0, 0, 0.4);color: rgb(106, 115, 125);font-size: 0.9em;max-width: 100%;letter-spacing: 0.544px;white-space: normal;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left none auto rgba border-box break-word><p style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;font-size: 14px;color: black;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">Yes, this is a valid point; thanks. The post-scan was needed in a previous version, and could be removed. It does not trigger often enough to matter though, so is for now another minor tweak that might be included next time CHM is updated.</p></blockquote><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>虽然<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Doug</code>在邮件中的措辞用了could be, not often enough等，但也确认了最后一个扩容线程的二次检查是没有必要的。具体的复制过程与<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>HashMap</code>类似，感兴趣的读者可以翻一下<a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=Mzk0NjExMjU3Mg==&amp;mid=2247484593&amp;idx=1&amp;sn=1329f371cc600813034535411c3a987f&amp;chksm=c30a55e2f47ddcf47a6fc2fbd67be93ec4a87dd00dccbd60d9b602f591f9218cb526ac739a16&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" data-linktype=\"2\" hasload=\"1\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">高端的面试从来不会在HashMap的红黑树上纠缠太多</a>这篇文章。</p><h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 18px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"color: rgb(123, 12, 0);\">size()</span></code><span style=\"color: rgb(123, 12, 0);\">方法</span></h2><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">addCount()方法</code></span></h3><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 记录map元素总数的成员变量</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">private</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">transient</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">volatile</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> baseCount;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>put</code>方法的最后，有一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>addCount</code>方法，因为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>putVal</code>执行到此处说明已经成功新增了一个元素，所以<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>addCount</code>方法的作用就是维护当前<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>的元素总数，在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>中有一个变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>用来记录<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>map</code>中元素的个数，如下图所示，如果同一时刻有n个线程通过CAS同时操作<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>变量，有且仅有一个线程会成功，其他线程都会陷入无休止的自旋当中，那一定会带来性能瓶颈。</p><figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left flex column center border-box break-word><img data-ratio=\"0.7146529562982005\" data-type=\"png\" data-w=\"778\" style=\"margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; width: 677px !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvicicpvz83aPVKX1sKpeGFaz03AC1hKrETicTPQPibhx7iaDHlY5v8pDWkpTg/640?wx_fmt=png\"><figcaption style=\"margin-top: 5px;max-width: 100%;text-align: center;color: rgb(136, 136, 136);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">image-20210420221407349</figcaption></figure><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>为了避免大量线程都在自旋等待写入<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>，<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>引入了一个辅助队列，如下图所示，现在操作<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>的线程可以分散到这个辅助队列中去了，调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>size()</code>的时候只需要将<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>和辅助队列中的数值相加即可，这样就实现了调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>size()</code>无需加锁。</p><figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left flex column center border-box break-word><img data-ratio=\"0.7933673469387755\" data-type=\"png\" data-w=\"784\" style=\"margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; width: 677px !important; visibility: visible !important; max-width: 600px\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvic9ZRof5VEibHagFM61yARZy4ZHgLSsGgRbxXadDYy8ibYZsPDemEY0Clg/640?wx_fmt=png\"><figcaption style=\"margin-top: 5px;max-width: 100%;text-align: center;color: rgb(136, 136, 136);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><br></figcaption></figure><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>辅助队列是一个类型为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CounterCell</code>的数组：</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;color: rgb(153, 153, 153);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">@sun</span>.misc.Contended <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">static</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">class</span> <span style=\"max-width: 100%;color: rgb(68, 85, 136);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">CounterCell</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">volatile</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> value;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    CounterCell(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> x) { value = x; }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>可以简单理解为只是包装了一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>long</code>型的变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>value</code>，还需要解决一个问题是，对于某个具体的线程它是如何知道操作辅助队列中的哪个值呢？答案是下面的这个方法：</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">static</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">getProbe</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">()</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> UNSAFE.getInt(Thread.currentThread(), PROBE);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>getProbe</code>方法会返回当前线程的一个唯一身份码，这个值是不会变的，因此可以将<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>getProbe</code>的返回值与辅助队列的长度作求余运算得到具体的下标，它的返回值可能是0，如果返回0则需要调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ThreadLocalRandom.localInit()</code>初始化。<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>addCount</code>方法中有两个细节需要注意</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">private</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">void</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">addCount</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> x, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> check)</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    CounterCell[] as; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> b, s;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 注意这里的判断条件，是有技巧的</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((as = counterCells) != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> ||<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        !U.compareAndSwapLong(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, BASECOUNT, b = baseCount, s = b + x)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        CounterCell a; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> v; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> m;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> uncontended = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (as == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> || (m = as.length - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>) 0 ||<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> ||<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 变量uncontended记录着这个CAS操作是否成功</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            !(uncontended =<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            fullAddCount(x, uncontended);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (check &lt;= <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        s = sumCount();<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (check &gt;= <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 检查是否需要扩容，后面再详细看</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;color: rgb(255, 41, 65);box-sizing: border-box !important;overflow-wrap: break-word !important;\">细节一：</span></p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>首先我们要注意方法中刚进来的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>if</code>判断条件：</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((as = counterCells) != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> ||<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    !U.compareAndSwapLong(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, BASECOUNT, b = baseCount, s = b + x)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>作者在这里巧妙的运用了逻辑短路，如果<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>(as = counterCells) != null</code>则后面的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>是不会执行的，为什么要这么设置呢？作者有两点考虑：</p><ol data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">原因在于如果<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>(as = counterCells) != null</code>，则说明辅助队列已经初始化好了，相比于所有的线程都自旋等待<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>这一个变量，让线程通过<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>去操作队列中的值有更大的可能性成功，因为辅助队列的最大长度为大于当前处理器个数的2的正整数幂，可以支持更大的并发</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">如果辅助队列还没有初始化好，直到有必要的时候再去创建队列，如何判断“必要性”呢？就看对<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>操作能否成功，如果失败，就说明当前系统的并发已经比较高了，需要队列的辅助，否则直接操作<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code></section></li></ol><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;color: rgb(255, 41, 65);box-sizing: border-box !important;overflow-wrap: break-word !important;\">细节二：</span></p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>只有当辅助队列已存在，且由<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ThreadLocalRandom.getProbe()</code>在辅助队列中确定的位置不为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>null</code>时，才对其做<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>操作，这本来是一个正常的防御性判断，但是<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>uncontended</code>记录了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>是否成功，如果失败，则会在<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>fullAddCount</code>中调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ThreadLocalRandom.advanceProbe</code>换一个身份码调整下当前线程在辅助队列的位置，避免所有线程都在辅助队列的同一个坑位自旋等待。</p><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">fullAddCount()</code>方法</span></h3><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// See LongAdder version for explanation</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// wasUncontended 记录着调用方CAS是否成功，如果失败则换一个辅助队列的元素继续CAS</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">private</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">void</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">fullAddCount</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> x, <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> wasUncontended)</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> h;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((h = ThreadLocalRandom.getProbe()) == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        ThreadLocalRandom.localInit();      <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// force initialization</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        h = ThreadLocalRandom.getProbe();<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        wasUncontended = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> collide = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;                <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// True if last slot nonempty</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">for</span> (;;) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        CounterCell[] as; CounterCell a; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> n; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> v;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【A】如果辅助队列已经创建，则直接操作辅助队列</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((as = counterCells) != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> &amp;&amp; (n = as.length) &gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((a = as[(n - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>) &amp; h]) == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (cellsBusy == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>) {            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Try to attach new Cell</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    CounterCell r = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> CounterCell(x); <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Optimistic create</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (cellsBusy == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span> &amp;&amp;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        U.compareAndSwapInt(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, CELLSBUSY, <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>, <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> created = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">try</span> {               <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Recheck under lock</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            CounterCell[] rs; <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> m, j;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((rs = counterCells) != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span> &amp;&amp;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                (m = rs.length) &gt; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span> &amp;&amp;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                rs[j = (m - <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>) &amp; h] == <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                rs[j] = r;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                                created = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        } <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">finally</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            cellsBusy = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (created)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">continue</span>;           <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Slot is now non-empty</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                collide = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (!wasUncontended)       <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 如果调用方CAS失败了，本轮空跑，下一个循环换下标继续操作</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                wasUncontended = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;      <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Continue after rehash</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (counterCells != as || n &gt;= NCPU) <br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 如果辅助队列长度已经超过了CPU个数，本轮空跑，下一个循环换下标继续操作</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                collide = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// At max size or stale</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (!collide) <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 如果上一次操作失败了(CAS失败或者新建CounterCell失败)，本轮空跑，下一个循环换下标继续操作</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                collide = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (cellsBusy == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span> &amp;&amp; <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 如果连续两次操作辅助队列失败，则考虑扩容</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        U.compareAndSwapInt(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, CELLSBUSY, <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>, <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">try</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (counterCells == as) {<span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Expand table unless stale</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        CounterCell[] rs = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> CounterCell[n &lt;1];<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">for</span> (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> i = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>; i                             rs[i] = as[i];<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                        counterCells = rs;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                } <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">finally</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    cellsBusy = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                collide = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">continue</span>;                   <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Retry with expanded table</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 如果上一次操作失败或者调用方CAS失败，都会走到这里，变换要操作的辅助队列下标</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            h = ThreadLocalRandom.advanceProbe(h);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【B】如果辅助队列还未创建，则加锁创建</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (cellsBusy == <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span> &amp;&amp; counterCells == as &amp;&amp;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    U.compareAndSwapInt(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, CELLSBUSY, <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>, <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>)) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">boolean</span> init = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">false</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">try</span> {                           <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Initialize table</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (counterCells == as) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    CounterCell[] rs = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> CounterCell[<span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">2</span>];<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    rs[h &amp; <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">1</span>] = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">new</span> CounterCell(x);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    counterCells = rs;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                    init = <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">true</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            } <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">finally</span> {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                cellsBusy = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (init)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// 【C】如果辅助队列创建失败(拿锁失败)，则尝试直接操作`baseCount`</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">else</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (U.compareAndSwapLong(<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">this</span>, BASECOUNT, v = baseCount, v + x))<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">break</span>;                          <span style=\"max-width: 100%;color: rgb(153, 153, 136);font-style: italic;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">// Fall back on using base</span><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>因为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>counterCells</code>是一个普通的数组，因此对其的写操作，包括初始化，扩容以及元素的写都需要加锁，加锁的方式是对全局变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>cellsBusy</code>的自旋锁。先看最外层的三个分支：</p><ul data-tool=\"mdnice编辑器\" class=\"list-paddingleft-2\" style=\"margin-top: 8px;margin-bottom: 8px;padding-left: 25px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);width: 543.391px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left break-word><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">【B】如果辅助队列还没有创建，则加锁创建</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">【C】如果因为拿锁失败导致辅助队列创建失败，则尝试自旋写入变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>，万一真的成功了呢</section></li><li style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-top: 5px;margin-bottom: 5px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);box-sizing: border-box !important;overflow-wrap: break-word !important;\">【A】如果辅助队列已经创建了，则直接去操作辅助队列相应的元素</section></li></ul><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>注释中标注【A】的这个分支代码较多，其主要思路是如果通过<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>或者加锁操作辅助队列中的某个元素失败，则首先通过调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ThreadLocalRandom.advanceProbe(h)</code>换一个队列中的元素继续操作，这次操作是否成功会记录在临时变量<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>collide</code>中。如果下一次操作还是失败，则说明此时的并发量比较大需要扩容了。如果辅助队列的长度已经超过了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CPU</code>的个数，那就不再扩容，继续换一个元素操作，因为同一时间能运行的线程数最大不会超过计算机的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CPU</code>个数。</p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>在这个过程中有四个细节仍然需要注意：</p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;color: rgb(255, 41, 65);box-sizing: border-box !important;overflow-wrap: break-word !important;\">细节一：</span></p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>counterCells</code>只是一个普通的数组，因此并不是线程安全的，所以对其写操作需要加锁保证并发安全</p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;color: rgb(255, 41, 65);box-sizing: border-box !important;overflow-wrap: break-word !important;\">细节二：</span></p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>加锁的时候，作者做了一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>double-check</code>的动作，我看有的文章将其解读为“类似于单例模式的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>double-check</code>”，这个是不对的，作者这样做的原因我们在上一篇文章中有讲过，首先第一个检查<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>cellsBusy == 0</code>是流程往下走的基础，如果<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>cellsBusy == 1</code>则直接拿锁失败退出，调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>h = ThreadLocalRandom.advanceProbe(h);</code>更新<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>h</code>后重试，如果<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>cellsBusy == 0</code>校验通过，则调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CounterCell r = new CounterCell(x);</code>初始化一个<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CounterCell</code>，这样做是为了减少自旋锁的临界区的大小，以此来提升并发性能</p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;color: rgb(255, 41, 65);box-sizing: border-box !important;overflow-wrap: break-word !important;\">细节三：</span></p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>在加锁的时候先判断下<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>cellsBusy</code>是否为0，如果为1那直接宣告拿锁失败，为什么这么做呢？因为相比于调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>UNSAFE</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>操作，直接读取<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>volatile</code>的消耗更少，如果直接读取<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>cellsBusy</code>已经能判断出拿锁失败，那就没必要再调用耗时更多的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>了</p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;color: rgb(255, 41, 65);box-sizing: border-box !important;overflow-wrap: break-word !important;\">细节四：</span></p><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>对<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>cellsBusy</code>从0到1的更改调用了<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>但是从1置为0却只用了赋值操作，这是因为<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>CAS</code>可以保证能走到这条语句的只有一个线程，因此可以用赋值操作来更改<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>cellsBusy</code>的值。</p><h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 5px;margin-bottom: 15px;font-weight: bold;font-size: 20px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"max-width: 100%;font-size: 16px;color: rgb(123, 12, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">sumCount</code></span></h3><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>前面两个方法主要是把<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>中的元素个数分散的记录到<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>baseCount</code>和辅助队列中，调用<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>size()</code>方法的时候只需要把这些值相加即可。</p><pre data-tool=\"mdnice编辑器\" style=\"margin-top: 10px;margin-bottom: 10px;padding: 0.4em 0.6em;max-width: 100%;letter-spacing: 0.544px;border-radius: 5px;background: rgb(248, 248, 248);color: rgb(0, 0, 0);font-size: 16px;text-align: left;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><code style=\"padding: 15px 16px 16px;max-width: 100%;overflow-x: auto;color: rgb(51, 51, 51);display: -webkit-box;font-family: \" operator mono consolas monaco menlo monospace initial border-box break-word><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">public</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">size</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">()</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> n = sumCount();<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> ((n 0L) ? <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span> :<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            (n &gt; (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">            (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span>)n);<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">final</span> <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> <span style=\"max-width: 100%;color: rgb(153, 0, 0);font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">sumCount</span><span style=\"max-width: 100%;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">()</span> </span>{<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    CounterCell[] as = counterCells; CounterCell a;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">long</span> sum = baseCount;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> (as != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>) {<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">for</span> (<span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">int</span> i = <span style=\"max-width: 100%;color: rgb(0, 128, 128);line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">0</span>; i             <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">if</span> ((a = as[i]) != <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">null</span>)<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">                sum += a.value;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">        }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    }<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">    <span style=\"max-width: 100%;font-weight: bold;line-height: 26px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">return</span> sum;<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\">}<br style=\"max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;\"></code></pre><h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word><span style=\"color: rgb(123, 12, 0);\">后记</span></h2><p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px;padding-bottom: 8px;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, \" pingfang sc cambria cochin georgia times new roman serif left border-box break-word>从代码来看<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 8</code>对<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>的优化都在点子上，理论上性能会比<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>Java 7</code>的<code style=\"margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.047);font-family: \" operator mono consolas monaco menlo monospace break-all border-box break-word>ConcurrentHashMap</code>提升不少，但是我暂时还没有找到有对比的两个版本的benchmark，如果有读者朋友做过相关的验证或者看到过有关的benchmark，也欢迎和我沟通。</p><p><span style=\"font-size: 15px;text-align: left;\"></span><br></p><p style=\"white-space: normal;text-align: center;\"><span style=\"font-size: 15px;color: rgb(136, 136, 136);\"><br></span></p><p style=\"white-space: normal;text-align: center;\"><span style=\"font-size: 15px;color: rgb(136, 136, 136);\">- EOF -</span></p><section donone=\"shifuMouseDownCard('shifu_c_030')\" label=\"Copyright Reserved by PLAYHUDONG.\" style=\"margin-top: 1em;margin-bottom: 1em;white-space: normal;text-align: start;max-width: 100%;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);border-width: 0px;border-style: initial;border-color: initial;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><section style=\"margin-left: 1em;max-width: 100%;line-height: 1.4;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><span style=\"padding: 3px 8px;max-width: 100%;border-radius: 4px;color: rgb(255, 255, 255);background-color: rgb(255, 105, 31);font-family: inherit;text-align: inherit;text-decoration: inherit;font-size: 16px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">推荐阅读</span>  <span style=\"margin-left: 4px;padding: 3px 8px;max-width: 100%;border-radius: 1.2em;color: rgb(255, 255, 255);line-height: 1.2;background-color: rgb(204, 204, 204);font-family: inherit;text-align: inherit;text-decoration: inherit;border-color: rgb(249, 110, 87);font-size: 12px;box-sizing: border-box !important;overflow-wrap: break-word !important;\">点击标题可跳转</span></section><section style=\"margin-top: -11px;padding: 22px 16px 16px;max-width: 100%;border-width: 1px;border-style: solid;border-color: rgb(255, 105, 31);color: rgb(51, 51, 51);font-size: 1em;font-family: inherit;text-align: inherit;text-decoration: inherit;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651488902&amp;idx=1&amp;sn=a874279eb3ee3091ea7e94f8f870a6a3&amp;chksm=bd25eef98a5267ef30593492dd8c81dc240b3acb7850e8117e2d6c80b5ea0021f0b74e4214ca&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" style=\"font-size: 12px;\" data-linktype=\"2\"><span style=\"font-size: 12px;\">震惊！ConcurrentHashMap里面也有死循环，作者留下的“彩蛋”了解一下？</span></a><br></p><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651485661&amp;idx=1&amp;sn=cc98b4eb443ef81be2d3718549645a70&amp;chksm=bd2519a28a5290b47b7285aa17d14ce2c1b099bd349c35e76bf006cd32621b497af4f51640f0&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" style=\"font-size: 12px;\" data-linktype=\"2\"><span style=\"font-size: 12px;\">为什么 ConcurrentHashMap 的读操作不需要加锁？</span></a><br></p><p style=\"max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651484030&amp;idx=1&amp;sn=843f26d81e677c58a466f1b38d001a89&amp;chksm=bd2503018a528a17cbde27e7f8365b0db1e03c0c65988319cf0701f9bd9ce02870887d7e710e&amp;scene=21#wechat_redirect\" data-itemshowtype=\"0\" tab=\"innerlink\" style=\"font-size: 12px;\" data-linktype=\"2\"><span style=\"font-size: 12px;\">ConcurrentHashMap 使用：每个 Key 只调用 1 个方法</span></a></p></section></section><p style=\"white-space: normal;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);text-align: start;max-width: 100%;min-height: 1em;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><br></p><p style=\"text-align: center;\"><span style=\"max-width: 100%;font-size: 14px;color: rgb(255, 169, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">看完本文有收获？请转发分享给更多人</span><br></p><p style=\"white-space: normal;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><strong style=\"max-width: 100%;color: rgb(255, 169, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;\">关注「ImportNew」，提升Java技能</strong></p><p style=\"white-space: normal;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;\"><img data-ratio=\"0.9166666666666666\" data-s=\"300,640\" data-type=\"jpeg\" data-w=\"600\" style=\"box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 600px !important; max-width: 600px\" width=\"auto\" src=\"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg\"></p><p style=\"text-align: right;\"><span style=\"font-size: 14px;text-align: right;\"></span><span style=\"max-width: 100%;font-family: -apple-system-font, system-ui, \" helvetica neue sc sans gb yahei ui arial sans-serif center break-word border-box>点赞和在看就是最大的支持</span><span style=\"max-width: 100%;font-family: -apple-system-font, system-ui, \" helvetica neue sc sans gb yahei ui arial sans-serif center break-word border-box>❤️</span><span style=\"font-size: 14px;text-align: right;\"></span></p><p><br></p>\n                </div>\n\n    \n    <br>\n\n    \n        <a target=\"_blank\" href=\"http://mp.weixin.qq.com/s?__biz=MjM5NzMyMjAwMA==&amp;mid=2651494985&amp;idx=1&amp;sn=20b1903925eabbef5bb0c2aeaca8cb85&amp;chksm=bd25f6368a527f20d9b727f9d5b19c9f7c32b05aee31b8676a53c975bf47ca317763db0bebc0&amp;scene=0#rd\" style=\"color: blue\" class=\"media_tool_meta meta_primary\">原文</a>\n        <br>\n    \n\n    \n\n    <img alt=\"\" width=\"1px\" height=\"1px\" class=\"\" style=\"width:1px;height:1px;display:none\" src=\"http://www.jintiankansha.me/rss_static/54540/otiWawSbh3\"></div></div>","descriptionType":"html","publishedDate":"Fri, 07 May 2021 03:30:00 +0000","feedId":2521,"bgimg":"http://content.sov5.cn/mmbiz_jpg/eZzl4LXykQxR3KWMVyX3rJRiaRriczKLxL3BUapNG3SMcZQy6gicicOLfzibTPpee9pMtibV6IicXQIIFzxH4UxpswvSw?imageView2/1/w/600","linkMd5":"d3282309cc930bda5132358edf3af4c1","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx/cdn55@2020_4/2021/05/07/17-35-25-436_2ae746ae412a574c.webp","destWidth":600,"destHeight":544,"sourceBytes":67880,"destBytes":62492,"author":"","articleImgCdnMap":{"http://content.sov5.cn/mmbiz_jpg/eZzl4LXykQxR3KWMVyX3rJRiaRriczKLxL3BUapNG3SMcZQy6gicicOLfzibTPpee9pMtibV6IicXQIIFzxH4UxpswvSw?imageView2/1/w/600":"https://cdn.jsdelivr.net/gh/myreaderx/cdn55@2020_4/2021/05/07/17-35-25-436_2ae746ae412a574c.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvicIeiaDmgzDGzAh50zu8uibcTzY7acGCJI84Y9J86iaJ0aPK0mD9ASTdR6Q/640?wx_fmt=png":null,"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvicbxGEW9kDNPnKUEtTMLSXuDl75TlvaDVQ40UPcfdVkrBHNGG9FeGVnQ/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn61@2020_3/2021/05/07/17-36-32-972_22b286d85d5141a3.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvicicpvz83aPVKX1sKpeGFaz03AC1hKrETicTPQPibhx7iaDHlY5v8pDWkpTg/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn67@2020_5/2021/05/07/17-35-29-440_3d5beb85adeed658.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvic9ZRof5VEibHagFM61yARZy4ZHgLSsGgRbxXadDYy8ibYZsPDemEY0Clg/640?wx_fmt=png":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn77@2020_6/2021/05/07/17-35-53-687_b0010643d342d34e.webp","http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn70@2020_2/2021/05/07/17-35-42-733_f93d0239d4369c75.webp","http://www.jintiankansha.me/rss_static/54540/otiWawSbh3":null},"publishedOrCreatedDate":1620408923337}],"record":{"createdTime":"2021-05-08 01:35:23","updatedTime":"2021-05-08 01:35:23","feedId":2521,"fetchDate":"Fri, 07 May 2021 17:35:23 +0000","fetchMs":200,"handleMs":75,"totalMs":124406,"newArticles":0,"totalArticles":5,"status":1,"type":0,"ip":"245d88d7b2d8f26704713c23b090d029","hostName":"us-036*","requestId":"ed86da844e9b4e5e90d9be1618b52a88_2521","contentType":"application/rss+xml","totalBytes":158820,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":7,"articlesImgsGithubTotal":5,"successGithubMap":{"myreaderx27":1,"myreaderx12":1,"myreaderx13":1,"myreaderx18":1,"myreaderx":1},"failGithubMap":{}},"feed":{"createdTime":"2020-08-24 21:31:41","updatedTime":"2020-09-01 10:09:47","id":2521,"name":"ImportNew","url":"http://feedmaker.kindle4rss.com/feeds/importnew.weixin.xml","subscriber":null,"website":null,"icon":"http://www.sogou.com/images/logo/new/favicon.ico?v=4","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx63/cdn9@2020_3/2020/09/01/02-08-31-388_d24121c9beed1de6.ico","description":"伯乐在线旗下账号，专注Java技术分享，包括Java基础技术、进阶技能、架构设计和Java技术领域动态等。","weekly":null,"link":null},"noPictureArticleList":[{"createdTime":"2021-05-08 01:37:27","updatedTime":"2021-05-08 01:37:27","id":null,"feedId":2521,"linkMd5":"d3282309cc930bda5132358edf3af4c1"}],"tmpCommonImgCdnBytes":62492,"tmpBodyImgCdnBytes":96328,"tmpBgImgCdnBytes":0,"extra4":{"start":1620408922841,"total":0,"statList":[{"spend":422,"msg":"获取xml内容"},{"spend":75,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":121479,"msg":"正文链接上传到cdn"}]},"extra5":7,"extra6":6,"extra7ImgCdnFailResultVector":[{"code":1,"isDone":false,"source":"http://www.jintiankansha.me/rss_static/54540/otiWawSbh3","sourceStatusCode":405,"sourceBytes":0,"destBytes":0,"feedId":2521,"totalSpendMs":665,"convertSpendMs":0,"createdTime":"2021-05-08 01:35:25","host":"us-016*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+Java%C2%A08%C2%A0ConcurrentHashMap%E6%BA%90%E7%A0%81%E4%B8%AD%E7%AB%9F%E7%84%B6%E9%9A%90%E8%97%8F%E7%9D%80%E4%B8%A4%E4%B8%AABUG","linkMd5ListStr":"d3282309cc930bda5132358edf3af4c1","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[405],"sourceSize":"0","destSize":"0"},{"code":1,"isDone":false,"source":"http://www.jintiankansha.me/rss_static/54540/otiWawSbh3","sourceStatusCode":405,"sourceBytes":0,"destBytes":0,"feedId":2521,"totalSpendMs":728,"convertSpendMs":0,"createdTime":"2021-05-08 01:35:26","host":"us-009*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+Java%C2%A08%C2%A0ConcurrentHashMap%E6%BA%90%E7%A0%81%E4%B8%AD%E7%AB%9F%E7%84%B6%E9%9A%90%E8%97%8F%E7%9D%80%E4%B8%A4%E4%B8%AABUG","linkMd5ListStr":"d3282309cc930bda5132358edf3af4c1","extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[405],"sourceSize":"0","destSize":"0"},null,null,null],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://europe-25.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]},"http://europe-24.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]},"http://us-015.herokuapp.com/":{"failCount":1,"successCount":1,"resultList":[200,null]},"http://us-016.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[405]},"http://us-009.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[405]},"http://us-040.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]},"http://us-027.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"http://content.sov5.cn/mmbiz_jpg/eZzl4LXykQxR3KWMVyX3rJRiaRriczKLxL3BUapNG3SMcZQy6gicicOLfzibTPpee9pMtibV6IicXQIIFzxH4UxpswvSw?imageView2/1/w/600","sourceStatusCode":200,"destWidth":600,"destHeight":544,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx/cdn55@2020_4/2021/05/07/17-35-25-436_2ae746ae412a574c.webp","sourceBytes":67880,"destBytes":62492,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":2407,"convertSpendMs":15,"createdTime":"2021-05-08 01:35:23","host":"us-024*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+Java%C2%A08%C2%A0ConcurrentHashMap%E6%BA%90%E7%A0%81%E4%B8%AD%E7%AB%9F%E7%84%B6%E9%9A%90%E8%97%8F%E7%9D%80%E4%B8%A4%E4%B8%AABUG","linkMd5ListStr":"d3282309cc930bda5132358edf3af4c1,d3282309cc930bda5132358edf3af4c1","githubUser":"myreaderx","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"66.3 KB","destSize":"61 KB","compressRate":"92.1%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvicicpvz83aPVKX1sKpeGFaz03AC1hKrETicTPQPibhx7iaDHlY5v8pDWkpTg/640?wx_fmt=png","sourceStatusCode":200,"destWidth":778,"destHeight":556,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn67@2020_5/2021/05/07/17-35-29-440_3d5beb85adeed658.webp","sourceBytes":36149,"destBytes":17584,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":3892,"convertSpendMs":26,"createdTime":"2021-05-08 01:35:25","host":"us-040*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+Java%C2%A08%C2%A0ConcurrentHashMap%E6%BA%90%E7%A0%81%E4%B8%AD%E7%AB%9F%E7%84%B6%E9%9A%90%E8%97%8F%E7%9D%80%E4%B8%A4%E4%B8%AABUG","linkMd5ListStr":"d3282309cc930bda5132358edf3af4c1","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"35.3 KB","destSize":"17.2 KB","compressRate":"48.6%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/2A8tXicCG8ylbWIGfdoDED35IRRySQZTXUkJ1eop9MHApzFibKnOo0diboXpl0rmS5mH78YJhsWQv0dhv718A6kUA/640?wx_fmt=jpeg","sourceStatusCode":200,"destWidth":600,"destHeight":550,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn70@2020_2/2021/05/07/17-35-42-733_f93d0239d4369c75.webp","sourceBytes":37143,"destBytes":31608,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":17240,"convertSpendMs":11,"createdTime":"2021-05-08 01:35:25","host":"us-027*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+Java%C2%A08%C2%A0ConcurrentHashMap%E6%BA%90%E7%A0%81%E4%B8%AD%E7%AB%9F%E7%84%B6%E9%9A%90%E8%97%8F%E7%9D%80%E4%B8%A4%E4%B8%AABUG","linkMd5ListStr":"d3282309cc930bda5132358edf3af4c1","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"36.3 KB","destSize":"30.9 KB","compressRate":"85.1%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvic9ZRof5VEibHagFM61yARZy4ZHgLSsGgRbxXadDYy8ibYZsPDemEY0Clg/640?wx_fmt=png","sourceStatusCode":200,"destWidth":784,"destHeight":622,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn77@2020_6/2021/05/07/17-35-53-687_b0010643d342d34e.webp","sourceBytes":64234,"destBytes":30012,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":28202,"convertSpendMs":31,"createdTime":"2021-05-08 01:35:25","host":"us-015*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+Java%C2%A08%C2%A0ConcurrentHashMap%E6%BA%90%E7%A0%81%E4%B8%AD%E7%AB%9F%E7%84%B6%E9%9A%90%E8%97%8F%E7%9D%80%E4%B8%A4%E4%B8%AABUG","linkMd5ListStr":"d3282309cc930bda5132358edf3af4c1","githubUser":"myreaderx13","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"62.7 KB","destSize":"29.3 KB","compressRate":"46.7%"},{"code":1,"isDone":false,"source":"http://img2.jintiankansha.me/get?src=http://mmbiz.qpic.cn/mmbiz_png/R7PtjL3tdA8G9gcTVIgP3JZWCv0UibUvicbxGEW9kDNPnKUEtTMLSXuDl75TlvaDVQ40UPcfdVkrBHNGG9FeGVnQ/640?wx_fmt=png","sourceStatusCode":200,"destWidth":1080,"destHeight":558,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn61@2020_3/2021/05/07/17-36-32-972_22b286d85d5141a3.webp","sourceBytes":25641,"destBytes":17124,"targetWebpQuality":75,"feedId":2521,"totalSpendMs":6057,"convertSpendMs":40,"createdTime":"2021-05-08 01:36:27","host":"us-040*","referer":"http://weixin.sogou.com/weixin?type=2&query=ImportNew+Java%C2%A08%C2%A0ConcurrentHashMap%E6%BA%90%E7%A0%81%E4%B8%AD%E7%AB%9F%E7%84%B6%E9%9A%90%E8%97%8F%E7%9D%80%E4%B8%A4%E4%B8%AABUG","linkMd5ListStr":"d3282309cc930bda5132358edf3af4c1","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"25 KB","destSize":"16.7 KB","compressRate":"66.8%"}],"successGithubMap":{"myreaderx27":1,"myreaderx12":1,"myreaderx13":1,"myreaderx18":1,"myreaderx":1},"failGithubMap":{}}