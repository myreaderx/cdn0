{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2021-04-05 15:13:16","updatedTime":"2021-04-05 15:13:16","title":"Open sourcing Querybook, Pinterest’s collaborative big data hub","link":"https://medium.com/p/ba2605558883","description":"<p><em>An efficient big data solution for an increasingly remote-working world.</em></p>\n<p>Charlie Gu | Tech Lead, Analytics Platform, Lena Ryoo | Software Engineer, Analytics Platform, and Justin Mejorada-Pier | Engineering Manager, Analytics Platform</p>\n<p>With more than 300 billion Pins, Pinterest is powering an ever-growing and unique dataset that maps interests, ideas, and intent. As a data-driven company, Pinterest uses data insights and analysis to make product decisions and evaluations to improve the Pinner experience for more than 450 million monthly users. To continuously make these improvements, especially in an increasingly remote environment, it’s more important than ever for teams to be able to compose queries, create analyses, and collaborate with one another. Today we’re taking <a href=\"http://querybook.org\">Querybook</a>, our solution for more efficient and collaborative big data access, and open sourcing it for the community.</p>\n<p>The common starting point for any analysis at Pinterest is an ad-hoc query that gets executed on a SparkSQL, Hive, Presto cluster, or any Sqlalchemy compatible engine. We built Querybook to provide a responsive and simple web UI for such analysis so data scientists, product managers, and engineers can discover the right data, compose their queries, and share their findings. In this post, we’ll discuss the motivation to build Querybook, its features, architecture, and our work to open source the&nbsp;project.</p>\n<h3>The Journey</h3>\n<p>The proposal to build Querybook started in 2017 as an intern project. During that time, we used a vendor-supplied web application as the query UI. There were often user complaints about that tool regarding its UI, speed &amp; stability, lack of visualizations, as well as difficulty in sharing. Before long, we realized there was a great opportunity to build a better querying interface.</p>\n<p>We started to interview data scientists and engineers about their workflows while scoping out technical details. Shortly, we realized most were organizing their queries outside of the official tool, and many used apps like Evernote. Although Jupyter had a notebook user experience, its requirement to use Python/R and the lack of table metadata integration deterred many users. Based on this finding, our team decided Querybook’s query interface would be a document where users can compose queries and write analyses all in one place with the power of collocated metadata and the simplicity of a note-taking app.</p>\n<p>Released internally in March 2018, Querybook became the official solution to query big data at Pinterest. Nowadays, Querybook on average has 500 DAUs and 7k daily query runs. With an internal user rating of 8.1/10, it’s one of the highest-rated internal tools at Pinterest.</p>\n<h3>Feature Highlights</h3>\n<figure>\n <img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/1*yURLyhEfi7ZWs993NBL0uw.gif\" />\n <figcaption>\n  Figure 1. Querybook’s Doc&nbsp;UI\n </figcaption>\n</figure>\n<p>When a user first visits, they‘ll quickly notice its distinctive DataDoc interface. This is the primary place for users to query and analyze. Each DataDoc is composed of a list of cells which can be one of three types: text, query, or&nbsp;chart.</p>\n<ul>\n <li>The text cell comes with built-in rich-text support for users to jot down their ideas or insights.</li>\n <li>The query cell is used to compose and execute&nbsp;queries.</li>\n <li>The chart cell is used to create visualizations based on execution results. Similar to Google Docs, when users are granted access to a DataDoc, they can collaborate with each other in real-time.</li>\n</ul>\n<p>With the intuitive charting UI, users can easily turn a DataDoc into an illustrative dashboard. You can choose from different visualization options, such as time-series, pie-charts, scatter plots, and more. You can then connect your visualization to the results of any query on your DataDoc and post-process them with sorting and aggregation as needed. To automatically update these charts, you can use the scheduling options and select your desired cadence. The scheduler can notify users of success or failure. Combined with the templating option powered by <a href=\"https://jinja.palletsprojects.com/en/2.11.x/\">Jinja</a>, creating a live updating DataDoc is very&nbsp;quick.</p>\n<p>Scheduling and visualization features aren’t intended to replace tools such as Airflow or Superset. Rather, these features provide users a simple and fast way to experiment with their queries and iterate on them. Often, Pinterest engineers use Querybook as the first step to compose queries before creating production-level workflows and dashboards.</p>\n<p>Last but not least, Querybook comes with an automated query analytics system. Every query executed gets analyzed to extract metadata such as referenced tables and query runners. Querybook uses this information to automatically update its data schema and search ranking, as well as to show a table’s frequent users and query examples. The more queries, the more documented the tables&nbsp;become.</p>\n<h3>Architecture</h3>\n<figure>\n <img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*ZpA0Sqpf5X96zRFt\" />\n <figcaption>\n  Figure 2. Overview of Querybook’s architecture\n </figcaption>\n</figure>\n<p>To understand how Querybook works, we’ll walk through the process of composing and executing a&nbsp;query.</p>\n<ol>\n <li>The first step is to create a DataDoc and write the query in a cell. While the user types, the user’s query gets streamed to the server via Socket.IO.</li>\n <li>The server then pushes the delta to all users reading that DataDoc via Redis. At the same time, the server would save the updated DataDoc in the database and create an async job for the worker to update the DataDoc content in ElasticSearch. This allows the DataDoc to be searched&nbsp;later.</li>\n <li>Once the query is written, the user can execute the query by clicking the run button. The server would then create a record in the database and insert a query job into the Redis task queue. The worker receives the task and sends the query to the query engine (Presto, Hive, SparkSQL, or any Sqlalchemy compatible engine). While the query is running, the worker pushes live updates to the UI via Socket.IO.</li>\n <li>When the execution is completed, the worker loads the query result and uploads it in batches to a configurable storage service (e.g. S3). Finally, the browser gets notified of the query completion and makes a request to the server to load the query result and display it to the&nbsp;user.</li>\n</ol>\n<p>For brevity, this section only focused on one user flow of Querybook. However, all the infrastructure used is covered. Querybook allows some of it to be customized. For example, you can choose to upload execution results to either S3, Google Cloud Storage, or a local file. In addition, MySQL can also be swapped with any Sqlalchemy-compatible database such as Postgres.</p>\n<h3>The Path To Open&nbsp;Source</h3>\n<p>After noticing the success that Querybook had internally, we decided to open source it. One challenge we bumped into was how to make it generic while preserving some of the Pinterest-specific integrations. For this, we decided to have a two-layer organization through a plugin system and to add an Admin&nbsp;UI.</p>\n<p>The Admin UI lets companies configure Querybook’s query engines, table metadata ingestion, and access permissions from a single friendly interface. Previously, these configurations were done inside configuration files and required a code change as well as a deployment to be reflected. With this new UI, admins can make live Querybook changes without going through code or config&nbsp;files.</p>\n<figure>\n <img alt=\"\" src=\"https://cdn-images-1.medium.com/max/1024/0*99yZKtlHnnMoGmkO\" />\n</figure>\n<p>Figure 3. The Admin&nbsp;UI</p>\n<p>The plugin system integrates Querybook with the internal systems at Pinterest by utilizing Python’s importlib. With the plugin system, developers can configure auth, customize query engines, and implement exporters to internal sites. Customized behaviors provided by the plugin system allow Querybook to be optimized for the user’s workflow at Pinterest while ensuring the open-source is generic for the&nbsp;public.</p>\n<p>You can check out more of Querybook’s features and its documentation on <a href=\"http://querybook.org/\">Querybook.org</a>, and you can reach us at <a href=\"mailto:querybook@pinterest.com\">querybook@pinterest.com</a>.</p>\n<p><em>Acknowledgments: We want to thank the following engineers that have made contributions to Querybook: Lauren Mitchell, Langston Dziko, Mohak Nahta, and Franklin Shiao. And to Chunyan Wang, Dave Burgess, and David Chaiken for their critical advice and&nbsp;support.</em></p>\n<img src=\"https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=ba2605558883\" width=\"1\" height=\"1\" alt=\"\">\n <hr>\n  <p><a href=\"https://medium.com/pinterest-engineering/open-sourcing-querybook-pinterests-collaborative-big-data-hub-ba2605558883\">Open sourcing Querybook, Pinterest’s collaborative big data hub</a> was originally published in <a href=\"https://medium.com/pinterest-engineering\">Pinterest Engineering Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>\n </hr></img>","descriptionType":"html","publishedDate":"Tue, 30 Mar 2021 14:58:17 +0000","feedId":12742,"bgimg":"https://cdn-images-1.medium.com/max/1024/1*yURLyhEfi7ZWs993NBL0uw.gif","linkMd5":"c3f1428324dcad3579cb06524fde15aa","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn63@2020_3/2021/04/05/07-14-41-149_abee29a05f5d4d5a.webp","destWidth":1590,"destHeight":922,"sourceBytes":3886690,"destBytes":2168722,"author":"Pinterest Engineering","articleImgCdnMap":{"https://cdn-images-1.medium.com/max/1024/1*yURLyhEfi7ZWs993NBL0uw.gif":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn63@2020_3/2021/04/05/07-14-41-149_abee29a05f5d4d5a.webp","https://cdn-images-1.medium.com/max/1024/0*ZpA0Sqpf5X96zRFt":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn90@2020_4/2021/04/05/07-14-42-460_850c16f9c42c879f.webp","https://cdn-images-1.medium.com/max/1024/0*99yZKtlHnnMoGmkO":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn94@2020_6/2021/04/05/07-14-42-577_dae71911dfbe7439.webp","https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=ba2605558883":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn95@2020_3/2021/04/05/07-14-42-425_ce1541b8a3e900db.webp"},"publishedOrCreatedDate":1617606796826}],"record":{"createdTime":"2021-04-05 15:13:16","updatedTime":"2021-04-05 15:13:16","feedId":12742,"fetchDate":"Mon, 05 Apr 2021 07:13:16 +0000","fetchMs":215,"handleMs":9,"totalMs":86251,"newArticles":0,"totalArticles":10,"status":1,"type":0,"ip":"5a83433cfcfaaa59e1cf4213bd6b7738","hostName":"europe-25*","requestId":"1a12d71ff3a34ebb9112f10055c34597_12742","contentType":"text/xml; charset=UTF-8","totalBytes":2291276,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":4,"articlesImgsGithubTotal":4,"successGithubMap":{"myreaderx6":1,"myreaderx4":1,"myreaderx32":1,"myreaderx10":1},"failGithubMap":{}},"feed":{"createdTime":"2020-08-25 04:37:55","updatedTime":"2020-09-05 16:39:59","id":12742,"name":"Stories by Pinterest Engineering on Medium","url":"https://medium.com/feed/@Pinterest_Engineering","subscriber":243,"website":null,"icon":"https://cdn-images-1.medium.com/fit/c/150/150/1*FNWs-r9nA_QNtBbYvUkAtg.png","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx63/cdn22@2020_4/2020/09/05/08-39-56-919_f192d8eb546d06ef.png","description":"Stories by Pinterest Engineering on Medium","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":2168722,"tmpBodyImgCdnBytes":122554,"tmpBgImgCdnBytes":0,"extra4":{"start":1617606796589,"total":0,"statList":[{"spend":229,"msg":"获取xml内容"},{"spend":9,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":720,"msg":"正文链接上传到cdn"}]},"extra5":4,"extra6":4,"extra7ImgCdnFailResultVector":[null],"extra10_invalidATagHrefValue":{"https://medium.com/p/ba2605558883_mailto:querybook@pinterest.com":"mailto:querybook@pinterest.com"},"extra111_proxyServerAndStatMap":{"http://us-018.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-017.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://us-52.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://cdn-images-1.medium.com/max/1024/1*yURLyhEfi7ZWs993NBL0uw.gif","sourceStatusCode":200,"destWidth":1590,"destHeight":922,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn63@2020_3/2021/04/05/07-14-41-149_abee29a05f5d4d5a.webp","sourceBytes":3886690,"destBytes":2168722,"targetWebpQuality":75,"feedId":12742,"totalSpendMs":23731,"convertSpendMs":22483,"createdTime":"2021-04-05 15:14:18","host":"europe62*","referer":"https://medium.com/p/ba2605558883","linkMd5ListStr":"c3f1428324dcad3579cb06524fde15aa,c3f1428324dcad3579cb06524fde15aa","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"3.7 MB","destSize":"2.1 MB","compressRate":"55.8%"},{"code":1,"isDone":false,"source":"https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=ba2605558883","sourceStatusCode":200,"destWidth":1,"destHeight":1,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn95@2020_3/2021/04/05/07-14-42-425_ce1541b8a3e900db.webp","sourceBytes":43,"destBytes":72,"targetWebpQuality":75,"feedId":12742,"totalSpendMs":431,"convertSpendMs":2,"createdTime":"2021-04-05 15:14:42","host":"us-018*","referer":"https://medium.com/p/ba2605558883","linkMd5ListStr":"c3f1428324dcad3579cb06524fde15aa","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"43 B","destSize":"72 B","compressRate":"167.4%"},{"code":1,"isDone":false,"source":"https://cdn-images-1.medium.com/max/1024/0*ZpA0Sqpf5X96zRFt","sourceStatusCode":200,"destWidth":1024,"destHeight":743,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn90@2020_4/2021/04/05/07-14-42-460_850c16f9c42c879f.webp","sourceBytes":138663,"destBytes":93264,"targetWebpQuality":75,"feedId":12742,"totalSpendMs":478,"convertSpendMs":87,"createdTime":"2021-04-05 15:14:42","host":"us-52*","referer":"https://medium.com/p/ba2605558883","linkMd5ListStr":"c3f1428324dcad3579cb06524fde15aa","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"135.4 KB","destSize":"91.1 KB","compressRate":"67.3%"},{"code":1,"isDone":false,"source":"https://cdn-images-1.medium.com/max/1024/0*99yZKtlHnnMoGmkO","sourceStatusCode":200,"destWidth":1024,"destHeight":607,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn94@2020_6/2021/04/05/07-14-42-577_dae71911dfbe7439.webp","sourceBytes":70988,"destBytes":29218,"targetWebpQuality":75,"feedId":12742,"totalSpendMs":551,"convertSpendMs":159,"createdTime":"2021-04-05 15:14:42","host":"us-017*","referer":"https://medium.com/p/ba2605558883","linkMd5ListStr":"c3f1428324dcad3579cb06524fde15aa","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"69.3 KB","destSize":"28.5 KB","compressRate":"41.2%"}],"successGithubMap":{"myreaderx6":1,"myreaderx4":1,"myreaderx32":1,"myreaderx10":1},"failGithubMap":{}}