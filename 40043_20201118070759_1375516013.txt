{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-11-18 15:06:54","updatedTime":"2020-11-18 15:06:54","title":"PythonでWebアプリケーション作る練習をした","link":"https://hakobe932.hatenablog.com/entry/2017/01/17/090000","description":"<p>最近流行っている雰囲気があるPythonだけど、<a href=\"https://twitter.com/hakobe/status/814458876800077824\">僕も年末にふと気分が高まった</a>ので、練習をしてみた。</p>\n<p>自分にとってはPerlやRubyよりも先に勉強した、初めてのスクリプト言語がPythonだったので、ちょっとだけ思い入れがある。とはいえ、何年も前に<a href=\"http://d.hatena.ne.jp/asin/4873113938/hakobenoharap-22\">初めてのPython</a>で勉強した後は、<a href=\"http://hakobe932.hatenablog.com/entry/2016/04/15/142756\">稀に使うくらいだった</a>のでPythonならではの良い書き方とか、良いライブラリの知見とかは全然持ってなかった。</p>\n<p>そこで、Pythonに入門しなおしてPython流を思い出した後、自分が気になっているWeb開発をやってみてどういうもんなのかを一通りやってみた。</p>\n<p>このエントリは、<a href=\"http://hakobe932.hatenablog.com/entry/2016/11/25/141348\">GoでWebアプリケーション作る練習をした</a>の続編です(さらに続きはないでしょう)。</p> \n<div class=\"section\"> \n <h3>入門 Python3 を読んだ</h3> \n <p>\n  <div class=\"hatena-asin-detail\">\n   <a href=\"http://www.amazon.co.jp/exec/obidos/ASIN/4873117380/hakobenoharap-22/\"><img src=\"https://images-fe.ssl-images-amazon.com/images/I/51%2Bxv65qdBL._SL160_.jpg\" class=\"hatena-asin-detail-image\" alt=\"入門 Python 3\" title=\"入門 Python 3\" /></a>\n   <div class=\"hatena-asin-detail-info\">\n    <p class=\"hatena-asin-detail-title\"><a href=\"http://www.amazon.co.jp/exec/obidos/ASIN/4873117380/hakobenoharap-22/\">入門 Python 3</a></p>\n    <ul>\n     <li><span class=\"hatena-asin-detail-label\">作者:</span> Bill Lubanovic,斎藤康毅,長尾高弘</li>\n     <li><span class=\"hatena-asin-detail-label\">出版社/メーカー:</span> オライリージャパン</li>\n     <li><span class=\"hatena-asin-detail-label\">発売日:</span> 2015/12/01</li>\n     <li><span class=\"hatena-asin-detail-label\">メディア:</span> 単行本（ソフトカバー）</li>\n     <li><a href=\"http://d.hatena.ne.jp/asin/4873117380/hakobenoharap-22\" target=\"_blank\">この商品を含むブログ (2件) を見る</a></li>\n    </ul>\n   </div>\n   <div class=\"hatena-asin-detail-foot\"></div>\n  </div></p>\n <p>一通りの文法を思い出そうということでとりあえず読んでみた。他の言語を一通りやっていれば新しい概念はほとんどないのでサクサク読める。僕は3,4日くらいでだいたい目を通せた。</p>\n <p>ざっと読んだことで、Pythonならではのリスト内包表記とか、関数デコレータの話題とかを思い出せることが出来てよかった。PythonってリテラルにSet型があるんだなーとか。</p>\n <p>Pythonの文法の話題だけにとどまらず、テストやデータベースへのアクセス、HTTPクライアントやサーバ(WSGI)の話題について一通り教えてくれるのも良い。最近の本らしく、NoSQL(Redis)やメッセージングキュー(ZeroMQ)あたりの話題も取り上げられていた。各章に練習問題がついてるので実際に手を動かすこともできる。</p> \n</div> \n<div class=\"section\"> \n <h3>はてなインターンの事前課題</h3> \n <p>はてなインターン参加者は、はてなオフィスにやってくるまでの予習として、事前課題というのをやることになっている。<a href=\"https://github.com/hatena/Hatena-Intern-Exercise2015\">ちょっと古いけど公開されていて</a>、Perl版とScala版がある。その課題をPythonで解いた。ソースコードの <a href=\"https://github.com/hakobe/python-Intern-Exercise\">python-Intern-Exercise はこちら</a>。</p>\n <p>この事前課題は、プログラムの基本的な書き方、ファイルI/O、テストなどを網羅しているので、同じ内容の課題をPerlやScala以外の言語でやると良い練習になっておすすめ。ちょっと前に <a href=\"http://blog.hatena.ne.jp/shiba_yu36/\" class=\"hatena-id-icon\"><img src=\"https://cdn1.www.st-hatena.com/users/sh/shiba_yu36/profile.gif\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\">id:shiba_yu36</img></a> さんがやっていた、 <a href=\"http://blog.shibayu36.org/entry/2016/12/18/160604\">Java版はこちら</a>。</p> \n</div> \n<div class=\"section\"> \n <h3>Webアプリケーションの実装</h3> \n <p>さらに練習として、PythonでWebアプリケーションを作ってみることにした。あれこれ調べながら、自分がよくやるスタイルでWebアプリケーションを書くとどういう感じになるかを調べてみた。</p>\n <p><iframe src=\"//hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fhakobe%2Fhakoblog-python\" title=\"hakobe/hakoblog-python\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"></iframe><cite class=\"hatena-citation\"><a href=\"https://github.com/hakobe/hakoblog-python\">github.com</a></cite></p>\n <p>結論としては、Pythonでどういう書き方をすると良いのかとか、どのライブラリを使うのかといったことを調べるのには時間がかかったものの、それさえわかれば、だいたいやりたいことはできるということがわかった。</p>\n <p>普段はPerlを使っているのだけど、Perlで使っているテクニックやライブラリはだいたい対応するものがあって同じやり方が通用する感じ。例えば、<a href=\"https://github.com/hakobe/hakoblog-python/blob/master/tests/web/test_index.py#L22-L43\">テストの感じ</a>とかは、いつも書いているPerlのコードに近いインターフェースのサポート関数を利用できるようにできた。</p>\n <p>もしかすると何かの参考になるかもしれないので、実装の方針を紹介しておいてみる。</p>\n <p>PerlでWebアプリケーションを作るときにもよくやっている、薄いフレームワークの上になるべくシンプルにアプリケーションを構築するという方針でつくっている。複雑なしくみは使わず見通しの良さを重視してる。使っているライブラリは最低限で以下の様な感じ。</p> \n <ul> \n  <li>Webフレームワーク: <a href=\"http://flask.pocoo.org/\">Flask</a></li> \n  <li>データベース: ORMは使わずに <a href=\"https://github.com/PyMySQL/mysqlclient-python\">mysqlclient</a> をそのまま利用</li> \n  <li>テスト: <a href=\"http://nose.readthedocs.io/en/latest/index.html\">nose</a> (追記: 識者によると今開発止まってるのであんまり使わないほうがいいらしかった！)</li> \n </ul>\n <p>ファイルツリーは以下のような感じになっていて、それぞれの役割も書いた。</p> \n <pre class=\"code\" data-lang=\"\" data-unlink=\"\">.\n├── db/\n│&nbsp;&nbsp; └── schema.sql\n├── hakoblog/\n│&nbsp;&nbsp; ├── config.py  # アプリケーション設定用のクラス定義\n│&nbsp;&nbsp; ├── model/     # アプリケーションのモデル定義(BlogやEntryなど)\n│&nbsp;&nbsp; ├── loader/    # モデルオブジェクトをデータベースから取得するクラスが入ってる\n│&nbsp;&nbsp; ├── action/    # アプリケーションに対して破壊的な操作を行うクラスが入ってる\n│&nbsp;&nbsp; ├── db.py      # データベース接続を抽象化したクラスの定義\n│&nbsp;&nbsp; └── web.py     # Webアプリケーションのルーティングとコントローラ\n│&nbsp;&nbsp; ├── templates/ # HTMLテンプレート\n└── tests</pre>\n <p>ORMは使わないので、<code>model</code>の定義は単純なPythonのクラスになっている(例: <a href=\"https://github.com/hakobe/hakoblog-python/blob/1be96bbaec8fb06ba79e07d52771e55e80f3f2a7/hakoblog/model/entry.py\">Entryクラス</a>)。</p>\n <p>モデルオブジェクトをデータベースから取得するには<code>loader</code>内で定義されたクラスを使う。クラスはただのネームスペースで、クラスメソッドとして処理を定義する。例えば、<code>UserLoader</code>は以下のような雰囲気になる。</p> \n <pre class=\"code lang-python\" data-lang=\"python\" data-unlink=\"\"><span class=\"synPreProc\">from</span> hakoblog.model.user <span class=\"synPreProc\">import</span> User\n\n\n<span class=\"synStatement\">class</span> <span class=\"synIdentifier\">UserLoader</span>():\n    <span class=\"synPreProc\">@</span><span class=\"synIdentifier\">classmethod</span>\n    <span class=\"synStatement\">def</span> <span class=\"synIdentifier\">find_by_name</span>(cls, db, name):\n        <span class=\"synStatement\">with</span> db.cursor() <span class=\"synStatement\">as</span> cursor:\n            cursor.execute(\n                <span class=\"synConstant\">'''</span>\n<span class=\"synConstant\">                SELECT id, name</span>\n<span class=\"synConstant\">                FROM user</span>\n<span class=\"synConstant\">                WHERE name = %s</span>\n<span class=\"synConstant\">                LIMIT 1</span>\n<span class=\"synConstant\">                '''</span>,\n                (name, )\n            )\n            row = cursor.fetchone()\n\n            <span class=\"synStatement\">if</span> row <span class=\"synStatement\">is</span> <span class=\"synIdentifier\">None</span>:\n                <span class=\"synStatement\">return</span> <span class=\"synIdentifier\">None</span>\n\n        <span class=\"synStatement\">return</span> User(**row)\n</pre>\n <p>SQL内に%sが出て来るのでドキッとするけど、これでちゃんとplaceholderになっている(mysqlclientの仕様で%sを使う)。</p>\n <p>破壊的な操作をするときは<code>action</code>に同様のクラスを定義することに、ざっくり責任をわけておく。こうすることでデータを読み込みつつ破壊的な操作を定義しにくくなる狙いがあったりする。</p>\n <p><code>db.py</code>はDBクラスが定義してあって<code>mysqlclient</code>ライブラリを薄くラップしてある。接続のための設定を読み込んだり、ちょっとしたユーティリティ関数(例: <a href=\"https://github.com/hakobe/hakoblog-python/blob/1be96bbaec8fb06ba79e07d52771e55e80f3f2a7/hakoblog/db.py#L24-L27\">uuid_short関数</a>)を定義するのに便利。</p>\n <p><code>web.py</code>では、HTTPのルーティングとコントローラを定義してある。アプリケーションのエントリポイントはここになる。</p>\n <p>実装を試すのが主目的なので実用性はまったくない。記事書いたり記事を読んだりはできるけど、ユーザ認証などはないし、スタイルも書いてなくてみためは限界に近くしょぼい。</p> \n</div> \n<div class=\"section\"> \n <h3>感想</h3> \n <p>ちょっとPythonに入門したあと、あれこれ調べながらPythonでWebアプリを0から書いてみた。</p>\n <p>当然、普通にWebアプリケーションは書けるわけだけど、Perlでいつもよく使う設計スタイルも無理なく採用することができることがわかったのは良かった。コードを書いてみると、標語<a href=\"https://hakobe932.hatenablog.com/entry/2017/01/17/090000#f-8f07d2ef\" name=\"fn-8f07d2ef\" title=\"There should be one-- and preferably only one --obvious way to do it.\">*1</a>のとおりで、一つのことをやるやり方がだいたい決まっているので、迷わずにどんどん書き進められるのは心地よかった。</p>\n <p>あんまり凝ったことをしない文化っぽいけど、必要になったらやっていくという感じがあるのもなんとなくわかってきた。例えば、テストのために時間をとめるライブラリ(<a href=\"https://github.com/spulec/freezegun\">freezegun</a>)とかはちゃんとあったりして、柔軟性も大事にされていそう。</p>\n <p>スクリプト言語としてなかなか良いバランスだし、Web開発がうまくできそうなことも体験できた。そうでなくても、機械学習やデータサイエンス分野で勢いのある言語だと思うので、もうちょっと練習して使えるようにしておいても良さそう。</p> \n</div>\n<div class=\"footnote\"> \n <p class=\"footnote\"><a href=\"https://hakobe932.hatenablog.com/entry/2017/01/17/090000#fn-8f07d2ef\" name=\"f-8f07d2ef\" class=\"footnote-number\">*1</a><span class=\"footnote-delimiter\">:</span><span class=\"footnote-text\">There should be one-- and preferably only one --obvious way to do it.</span></p> \n</div>","descriptionType":"html","publishedDate":"Tue, 17 Jan 2017 00:00:00 +0000","feedId":40043,"bgimg":"https://images-fe.ssl-images-amazon.com/images/I/51%2Bxv65qdBL._SL160_.jpg","linkMd5":"9c51dfe67f80fa04f9fbb381caf88b88","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn83@2020_1/2020/11/18/07-06-54-979_50758248f394f4ab.webp","destWidth":113,"destHeight":160,"sourceBytes":5310,"destBytes":4478,"author":"hakobe932","enclosureType":"image/jpeg","enclosureUrl":"https://images-fe.ssl-images-amazon.com/images/I/51%2Bxv65qdBL._SL160_.jpg","articleImgCdnMap":{"https://images-fe.ssl-images-amazon.com/images/I/51%2Bxv65qdBL._SL160_.jpg":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn83@2020_1/2020/11/18/07-06-54-979_50758248f394f4ab.webp","https://cdn1.www.st-hatena.com/users/sh/shiba_yu36/profile.gif":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn88@2020_4/2020/11/18/07-07-58-726_dc02eb609c29019c.webp"},"publishedOrCreatedDate":1605683214896}],"record":{"createdTime":"2020-11-18 15:06:54","updatedTime":"2020-11-18 15:06:54","feedId":40043,"fetchDate":"Wed, 18 Nov 2020 07:06:54 +0000","fetchMs":1412,"handleMs":5504,"totalMs":71697,"newArticles":0,"totalArticles":30,"status":1,"type":0,"ip":"13ceeb0da42989d3de6751ce913d735f","hostName":"us-51*","requestId":"87c7bf92a8e34608b67009459efc40d8_40043","contentType":"application/atom+xml; charset=utf-8","totalBytes":6002,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":2,"articlesImgsGithubTotal":2,"successGithubMap":{"myreaderx4":1,"myreaderx5oss":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 03:19:24","updatedTime":"2020-11-17 02:02:06","id":40043,"name":"はこべにっき ♨","url":"http://hakobe932.hatenablog.com/feed","subscriber":80,"website":null,"icon":"https://hakobe932.hatenablog.com/favicon.ico","icon_jsdelivr":null,"description":"","weekly":null,"link":"https://hakobe932.hatenablog.com"},"noPictureArticleList":[],"tmpCommonImgCdnBytes":4478,"tmpBodyImgCdnBytes":1524,"tmpBgImgCdnBytes":0,"extra4":{"start":1605683207811,"total":0,"statList":[{"spend":1581,"msg":"获取xml内容"},{"spend":5504,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":63731,"msg":"正文链接上传到cdn"}]},"extra5":2,"extra6":2,"extra7ImgCdnFailResultVector":[null],"extra10_invalidATagHrefValue":{"https://hakobe932.hatenablog.com/entry/2017/01/17/090000_#f-8f07d2ef":"https://hakobe932.hatenablog.com/entry/2017/01/17/090000#f-8f07d2ef","https://hakobe932.hatenablog.com/entry/2017/01/17/090000_#fn-8f07d2ef":"https://hakobe932.hatenablog.com/entry/2017/01/17/090000#fn-8f07d2ef"},"extra111_proxyServerAndStatMap":{"http://us-025.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe65.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://images-fe.ssl-images-amazon.com/images/I/51%2Bxv65qdBL._SL160_.jpg","sourceStatusCode":200,"destWidth":113,"destHeight":160,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn83@2020_1/2020/11/18/07-06-54-979_50758248f394f4ab.webp","sourceBytes":5310,"destBytes":4478,"targetWebpQuality":75,"feedId":40043,"totalSpendMs":862,"convertSpendMs":5,"createdTime":"2020-11-18 15:06:54","host":"us-002*","referer":"https://hakobe932.hatenablog.com/entry/2017/01/17/090000","linkMd5ListStr":"9c51dfe67f80fa04f9fbb381caf88b88,9c51dfe67f80fa04f9fbb381caf88b88","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"5.2 KB","destSize":"4.4 KB","compressRate":"84.3%"},{"code":1,"isDone":false,"source":"https://cdn1.www.st-hatena.com/users/sh/shiba_yu36/profile.gif","sourceStatusCode":200,"destWidth":64,"destHeight":64,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn88@2020_4/2020/11/18/07-07-58-726_dc02eb609c29019c.webp","sourceBytes":2477,"destBytes":1524,"targetWebpQuality":75,"feedId":40043,"totalSpendMs":2326,"convertSpendMs":39,"createdTime":"2020-11-18 15:07:57","host":"us-025*","referer":"https://hakobe932.hatenablog.com/entry/2017/01/17/090000","linkMd5ListStr":"9c51dfe67f80fa04f9fbb381caf88b88","githubUser":"myreaderx5oss","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"2.4 KB","destSize":"1.5 KB","compressRate":"61.5%"}],"successGithubMap":{"myreaderx4":1,"myreaderx5oss":1},"failGithubMap":{}}