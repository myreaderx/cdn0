{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"Stack Overflow: How We Do Deployment - 2016 Edition","link":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","description":"<blockquote> \n <p>This is #3 in a <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">very long series of posts</a> on Stack Overflow’s architecture.<br /> Previous post (#2): <a href=\"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/\">Stack Overflow: The Hardware - 2016 Edition</a></p> \n</blockquote> \n<p>We’ve talked about <a href=\"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/\">Stack Overflow’s architecture</a> and <a href=\"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/\">the hardware behind it</a>. The next <a href=\"https://trello.com/b/0zgQjktX/blog-post-queue-for-stack-overflow-topics\">most requested topic</a> was Deployment. How do we get code a developer (or some random stranger) writes into production? Let’s break it down. Keep in mind that we’re talking about deploying Stack Overflow for the example, but most of our projects follow almost an identical pattern to deploy a website or a service.</p> \n<!-- I typed this late at night; I probably should have slept instead.\n### The Codez\nFirst, we have some code. It's usually made up of letters, numbers, dots, squiggly braces, not-so-squiggly braces, line returns, apostrophes, quotes, hashes, equals, bangs, slashes, have we weeded out the weak yet, brackets, parens, dollar signs, and probably some others people are going to let me know I missed in the comments. And colons and semicolons. Oh and all the symbols you need a shift key to make. And commas and greater than, less than, backticks, pipes and holy crap there's a lot of lexicon here.\n--> \n<p>I’m going ahead and inserting a set of section links here because this post got a bit long with all of the bits that need an explanation: \n <!--more--></p> \n<ul> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#source\">Source &amp; Context</a></li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#the-human-steps\">The Human Steps</a></li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#branches\">Branches</a></li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#git-on-premises\">Git On-Premises</a></li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#the-build-system\">The Build System</a></li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#whats-in-the-build\">What’s In The Build?</a> \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#steps-1--2-migrations\">Steps 1 &amp; 2: Migrations</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-3-finding-moonspeak-translation\">Step 3: Finding Moonspeak (Translation)</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-4-translation-dump-javascript-edition\">Step 4: Translation Dump (JavaScript Edition)</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-5-msbuild\">Step 5: MSBuild</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-6-translation-dump-c-edition\">Step 6: Translation Dump (C# Edition)</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-7-importing-english-strings\">Step 7: Importing English Strings</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-8-deploy-website\">Step 8: Deploy Website</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-9-new-strings-hook\">Step 9: New Strings Hook</a></li> \n  </ul> </li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#tiers\">Tiers</a></li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#database-migrations\">Database Migrations</a></li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#localizationtranslations-moonspeak\">Localization/Translations (Moonspeak)</a></li> \n <li><a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#building-without-breaking\">Building Without Breaking</a></li> \n <li>Extra resources because I love you all \n  <ul> \n   <li><a href=\"https://gist.github.com/NickCraver/b59ff38567b32936e2a3440e439d5d5c\">GitHub Gist (scripts)</a></li> \n   <li><a href=\"https://gist.github.com/NickCraver/d22d285e35ea6816bc4efe8e81ff152c\">GitHub Gist (logs)</a></li> \n  </ul> </li> \n</ul> \n<h3 id=\"source\">Source</h3> \n<p>This is our starting point for this article. We have the Stack Overflow repository on a developer’s machine. For the sake of discussing the process, let’s say they added a column to a database table and the corresponding property to the C# object — that way we can dig into how database migrations work along the way.</p> \n<h3 id=\"a-little-context\">A Little Context</h3> \n<p>We deploy roughly 25 times per day to development (our CI build) just for Stack Overflow Q&amp;A. Other projects also push many times. We deploy to production about 5-10 times on a typical day. A deploy from first push to full deploy is under 9 minutes (2:15 for dev, 2:40 for meta, and 3:20 for all sites). We have roughly 15 people pushing to the repository used in this post. The repo contains the code for these applications: <a href=\"https://stackoverflow.com/\">Stack Overflow</a> (every single Q&amp;A site), <a href=\"https://stackexchange.com/\">stackexchange.com</a> (root domain only), <a href=\"https://stacksnippets.net/\">Stack Snippets</a> (for Stack Overflow JavaScript snippets), <a href=\"https://stackauth.com/\">Stack Auth</a> (for OAuth), <a href=\"https://sstatic.net/\">sstatic.net</a> (cookieless CDN domain), <a href=\"https://api.stackexchange.com/\">Stack Exchange API v2</a>, <a href=\"https://mobile.stackexchange.com/\">Stack Exchange Mobile</a> (iOS and Android API), Stack Server (Tag Engine and Elasticsearch indexing Windows service), and Socket Server (our WebSocket Windows service).</p> \n<h3 id=\"the-human-steps\">The Human Steps</h3> \n<p>When we’re coding, if a database migration is involved then we have some extra steps. First, we check the chatroom (and confirm in the local repo) which SQL migration number is available next (we’ll get to how this works). Each project with a database has their own migration folder and number. For this deploy, we’re talking about the Q&amp;A migrations folder, which applies to all Q&amp;A databases. Here’s what chat and the local repo look like before we get started:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Stars.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Stars.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Stars.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Stars.png\" loading=\"lazy\" alt=\"Chat Stars\" /> \n  </picture></a></p> \n<p>And here’s the local <code class=\"language-plaintext highlighter-rouge\">%Repo%\\StackOverflow.Migrations\\</code> folder: <a href=\"https://nickcraver.com/blog/content/SO-Deployment-Migrations.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Migrations.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Migrations.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Migrations.png\" loading=\"lazy\" alt=\"StackOverflow.Migrations\" /> \n  </picture></a></p> \n<p>You can see both in chat and locally that 726 was the last migration number taken. So we’ll issue a “taking 727 - Putting JSON in SQL to see who it offends” message in chat. This will claim the next migration so that we don’t collide with someone else also doing a migration. We just type a chat message, a bot pins it. Fun fact: it also pins when I say “taking web 2 offline”, but we think it’s funny and refuse to fix it. Here’s our little Pinbot trolling:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Pinbot.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Pinbot.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Pinbot.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Pinbot.png\" loading=\"lazy\" alt=\"Oh Pinbot\" /> \n  </picture></a></p> \n<p>Now let’s add some code — we’ll keep it simple here:</p> \n<p>A <code class=\"language-plaintext highlighter-rouge\">\\StackOverflow\\Models\\User.cs</code> diff:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-diff\" data-lang=\"diff\"><span class=\"gi\">+ public string PreferencesJson { get; set; }</span></code></pre> \n</figure> \n<p>And our new <code class=\"language-plaintext highlighter-rouge\">\\StackOverflow.Migrations\\727 - Putting JSON in SQL to see who it offends.sql</code>:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-sql\" data-lang=\"sql\"><span class=\"n\">If</span> <span class=\"n\">dbo</span><span class=\"p\">.</span><span class=\"n\">fnColumnExists</span><span class=\"p\">(</span><span class=\"s1\">'Users'</span><span class=\"p\">,</span> <span class=\"s1\">'PreferencesJson'</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"k\">Begin</span>\n    <span class=\"k\">Alter</span> <span class=\"k\">Table</span> <span class=\"n\">Users</span> <span class=\"k\">Add</span> <span class=\"n\">PreferencesJson</span> <span class=\"n\">nvarchar</span><span class=\"p\">(</span><span class=\"k\">max</span><span class=\"p\">);</span>\n<span class=\"k\">End</span></code></pre> \n</figure> \n<p>We’ve tested the migration works by running it against our local Q&amp;A database of choice in SSMS and that the code on top of it works. Before deploying though, we need to make sure it runs <em>as a migration</em>. For example, sometimes you may forget to put a <a href=\"https://msdn.microsoft.com/en-us/library/ms188037.aspx\">GO</a> separating something that must be the first or only operation in a batch such as creating a view. So, we test it in the runner. To do this, we run the <code class=\"language-plaintext highlighter-rouge\">migrate.local.bat</code> you see in the screenshot above. The contents are simple:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-bat\" data-lang=\"bat\">..\\Build\\Migrator<span class=\"na\">-Fast </span><span class=\"o\">-</span><span class=\"na\">-tier</span><span class=\"o\">=</span><span class=\"kd\">local</span> \n  <span class=\"o\">-</span><span class=\"na\">-sites</span><span class=\"o\">=</span><span class=\"s2\">\"Data Source=.;Initial Catalog=Sites.Database;Integrated Security=True\"</span> <span class=\"err\">%</span><span class=\"o\">*</span>\n<span class=\"kd\">PAUSE</span></code></pre> \n</figure> \n<p>Note: the migrator is a project, but we simply drop the .exe in the solutions using it, since that’s the simplest and most portable thing that works.</p> \n<p>What does this migrator do? It hits our local copy of the <code class=\"language-plaintext highlighter-rouge\">Sites</code> database. It contains a list of all the Q&amp;A sites that developer runs locally and the migrator uses that list to connect and run all migrations against all databases, in Parallel. Here’s what a run looks like on a simple install with a single Q&amp;A database:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Migration-Log.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Migration-Log.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Migration-Log.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Migration-Log.png\" loading=\"lazy\" alt=\"Migration Log\" /> \n  </picture></a></p> \n<p>So far, so good. We have code and a migration that works and code that does…some stuff (which isn’t relevant to this process). Now it’s time to take our little code baby and send it out into the world. It’s time to fly little code, be <a href=\"https://youtu.be/LnlFDduJV8E?t=48s\">freeeeee</a>! Okay now that we’re excited, the typical process is:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-cmd\" data-lang=\"cmd\">git add &lt;files&gt; (usually --all for small commits)\ngit commit -m \"Migration 727: Putting JSON in SQL to see who it offends\"\ngit pull --rebase\ngit push</code></pre> \n</figure> \n<p>Note: we first check our team chatroom to see if anyone is in the middle of a deploy. Since our deployments are pretty quick, the chances of this aren’t <em>that</em> big. But, given how often we deploy, collisions can and do happen. Then we yell at the designer responsible. \n <!-- I kid, everyone does this sooner or later...and our designers are AWESOME. But they're still our scape goats. And we're their scapegoats. <3 --></p> \n<p>With respect to the Git commands above: if a command line works for you, use it. If a GUI works for you, use it. Use the best tooling for you and don’t give a damn what anyone else thinks. The entire point of tooling from an ancient hammer to a modern Git install is to save time and effort of the user. Use whatever saves <em>you</em> the most time and effort. Unless it’s Emacs, then consult a doctor immediately.</p> \n<h3 id=\"branches\">Branches</h3> \n<p>I didn’t cover branches above because compared to many teams, we very rarely use them. Most commits are on <code class=\"language-plaintext highlighter-rouge\">master</code>. Generally, we branch for only one of a few reasons:</p> \n<ul> \n <li>A developer is new, and early on we want code reviews</li> \n <li>A developer is working on a big (or risky) feature and wants a one-off code review</li> \n <li>Several developers are working on a big feature</li> \n</ul> \n<p>Other than the (generally rare) cases above, almost all commits are directly to <code class=\"language-plaintext highlighter-rouge\">master</code> and deployed soon after. We don’t like a big build queue. This encourages us to make small to medium size commits often and deploy often. It’s just how we choose to operate. I’m not recommending it for most teams or any teams for that matter. <em>Do what works for you</em>. This is simply what works for us.</p> \n<p>When we do branch, merging back in is always a topic people are interested in. In the vast majority of cases, we’ll squash when merging into master so that rolling back the changes is straightforward. We also keep the original branch around a few days (for anything major) to ensure we don’t need to reference what that <em>specific</em> change was about. That being said, we’re practical. If a squash presents a ton of developer time investment, then we just eat the merge history and go on with our lives.</p> \n<h3 id=\"git-on-premises\">Git On-Premises</h3> \n<p>Alright, so our code is sent to the server-side repo. Which repo? We’re currently using <a href=\"https://about.gitlab.com/\">Gitlab</a> for repositories. It’s pretty much <a href=\"https://github.com/\">GitHub</a>, hosted on-prem. If Gitlab pricing keeps getting crazier (note: I said “crazier”, not “more expensive”), we’ll certainly re-evaluate <a href=\"https://enterprise.github.com/home\">GitHub Enterprise</a> again.</p> \n<p>Why on-prem for Git hosting? For the sake of argument, let’s say we used GitHub instead (we did evaluate this option). What’s the difference? First, builds are slower. While GitHub’s protocol implementation of Git is much faster, latency and bandwidth making the builds slower than pulling over 2x10Gb locally. But to be fair, GitHub is far faster than Gitlab at <em>most</em> operations (especially search and viewing large diffs).</p> \n<p>However, depending on GitHub (or any offsite third party) has a few critical downsides for us. The main downside is the dependency chain. We aren’t just relying on GitHub servers to be online (their uptime is pretty good). We’re relying on them to be online <em>and being able to get to them</em>. For that matter, we’re also relying on all of our remote developers to be able to push code in the first place. That’s a lot of switching, routing, fiber, and DDoS surface area in-between us and the bare essentials needed to build: <strong>code</strong>. We can drastically shorten that dependency chain by being on a local server. It also alleviates <em>most</em> security concerns we have with any sensitive code being on a third-party server. We have no inside knowledge of any GitHub security issues or anything like that, we’re just extra careful with such things. Quite simply: if something doesn’t need to leave your network, the best security involves it not leaving your network.</p> \n<p>All of that being said, our open source projects <a href=\"https://github.com/StackExchange/\">are hosted on GitHub</a> and it works great. The critical ones are also mirrored internally on Gitlab for the same reasons as above. We have no issues with GitHub (they’re awesome), only the dependency chain. For those unaware, even this website <a href=\"https://github.com/NickCraver/nickcraver.github.com\">is running on GitHub pages</a>…so if you see a typo in this post, <a href=\"https://github.com/NickCraver/nickcraver.github.com/pulls\">submit a PR</a>.</p> \n<h3 id=\"the-build-system\">The Build System</h3> \n<p>Once the code is in the repo, the <a href=\"https://en.wikipedia.org/wiki/Continuous_integration\">continuous integration</a> build takes over. This is just a fancy term for a build kicked off by a commit. For builds, we use <a href=\"https://www.jetbrains.com/teamcity/\">TeamCity</a>. The TeamCity server is actually on the same VM as Gitlab since neither is useful without the other and it makes TeamCity’s polling for changes a fast and cheap operation. Fun fact: since Linux has no built-in DNS caching, most of the DNS queries are looking for…itself. Oh wait, that’s not a fun fact — it’s actually a pain in the ass.</p> \n<p>As you may have heard, we like to keep things really simple. We have extra compute capacity on our web tier, so…we use it. Builds for all of the websites run on agents right on the web tier itself, this means we have 11 build agents local to each data center. There are a few additional Windows and Linux build agents (for puppet, rpms, and internal applications) on other VMs, but they’re not relevant to this deploy process.</p> \n<p>Like most CI builds, we simply poll the Git repo on an interval to see if there are changes. This repo is heavy hit, so we poll for changes every 15 seconds. We don’t like waiting. Waiting sucks. Once a change is detected, the build server instructs an agent to run a build.</p> \n<p>Since our repos are large (we include dependencies like NuGet packages, though <a href=\"https://github.com/NuGet/NuGetGallery/issues/3004\">this is changing</a>), we use what TeamCity calls <a href=\"https://confluence.jetbrains.com/display/TCD9/VCS+Checkout+Mode\">agent-side checkout</a>. This means the agent does the actual fetching of content directly from the repository, rather than the default of the web server doing the checkout and sending all of the source to the agent. On top of this, we’re using <a href=\"https://confluence.jetbrains.com/display/TCD9/Git#Git-AgentSettings\">Git mirrors</a>. Mirrors maintain a full repository (one per repo) on the agent. This means the very first time the agent builds a given repository, it’s a full <code class=\"language-plaintext highlighter-rouge\">git clone</code>. However, every time <em>after</em> that it’s just a <code class=\"language-plaintext highlighter-rouge\">git pull</code>. Without this optimization, we’re talking about a <code class=\"language-plaintext highlighter-rouge\">git clone --depth 1</code>, which grabs the current file state and no history — just what we need for a build. With the very small delta we’ve pushed above (like most commits) a <code class=\"language-plaintext highlighter-rouge\">git pull</code> of <em>only</em> that delta will always beat the pants off grabbing all of files across the network. That first-build cost is a no-brainer tradeoff.</p> \n<p>As I said earlier, there are many projects in this repo (all connected), so we’re really talking about several builds running each commit (5 total):</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Dev-Builds.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Dev-Builds.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Dev-Builds.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Dev-Builds.png\" loading=\"lazy\" alt=\"Dev Builds\" /> \n  </picture></a></p> \n<h3 id=\"whats-in-the-build\">What’s In The Build?</h3> \n<p>Okay…what’s that build actually doing? Let’s take a top level look and break it down. Here are the 9 build steps in our development/CI build:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Steps.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Dev-Build-Steps.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Dev-Build-Steps.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Steps.png\" loading=\"lazy\" alt=\"Dev Build Steps\" /> \n  </picture></a></p> \n<p>And here’s what the log of the build we triggered above looks like (<a href=\"https://gist.github.com/NickCraver/d22d285e35ea6816bc4efe8e81ff152c#file-teamcity-dev-build-log-txt\">you can see the full version in a gist here</a>):</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Log.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Dev-Build-Log.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Dev-Build-Log.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Log.png\" loading=\"lazy\" alt=\"Dev Build Log\" /> \n  </picture></a></p> \n<h4 id=\"steps-1--2-migrations\">Steps 1 &amp; 2: Migrations</h4> \n<p>The first 2 steps are migrations. In development, we automatically migrate the “Sites” database. This database is our central store that contains the master list of sites and other network-level items like the inbox. This same migration isn’t automatic in production since “should this run be before or after code is deployed?” is a 50/50 question. The second step is what we ran locally, just against dev. In dev, it’s acceptable to be down for a second, but that still shouldn’t happen. In the Meta build, we migrate <strong>all</strong> production databases. This means Stack Overflow’s database gets new SQL bits <em>minutes</em> before code. We order deploys appropriately.</p> \n<p>The important part here is <strong>databases are always migrated before code is deployed</strong>. Database migrations are a topic all in themselves and something people have expressed interest in, so I detail them a bit more <a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#database-migrations\">a little later in this post</a>.</p> \n<h4 id=\"step-3-finding-moonspeak-translation\">Step 3: Finding Moonspeak (Translation)</h4> \n<p>Due to the structure and limitations of the build process, we have to locate our Moonspeak tooling since we don’t know the location for sure (it changes with each version due to the version being in the path). Okay, what’s Moonspeak? Moonspeak is the <a href=\"https://meta.stackexchange.com/a/25529/135201\">codename</a> for our localization tooling. Don’t worry, <a href=\"https://trello.com/c/GdywwBgb/24-localization-moonspeak-translations\">we’ll cover it in-depth later</a>. The step itself is simple:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-powershell\" data-lang=\"powershell\"><span class=\"nf\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"##teamcity[setParameter name='system.moonspeaktools' \n  value='</span><span class=\"si\">$(</span><span class=\"p\">(</span><span class=\"nf\">get-childitem</span><span class=\"w\"> </span><span class=\"nt\">-directory</span><span class=\"w\"> </span><span class=\"nx\">packages/StackExchange.MoonSpeak.2</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"nf\">FullName</span><span class=\"p\">)</span><span class=\"nf\">\\tools</span><span class=\"s1\">']\"</span></code></pre> \n</figure> \n<p>It’s just grabbing a directory path and setting the <code class=\"language-plaintext highlighter-rouge\">system.moonspeaktools</code> TeamCity variable to the result. If you’re curious about all of the various ways to interact with TeamCity’s build, <a href=\"https://confluence.jetbrains.com/display/TCD9/Build+Script+Interaction+with+TeamCity\">there’s an article here</a>.</p> \n<h4 id=\"step-4-translation-dump-javascript-edition\">Step 4: Translation Dump (JavaScript Edition)</h4> \n<p>In dev specifically, we run the dump of all of our need-to-be-translated strings in JavaScript for localization. Again the command is pretty simple:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-cmd\" data-lang=\"cmd\">%system.moonspeaktools%\\Jerome.exe extract \n  %system.translationsDumpPath%\\artifact-%build.number%-js.{0}.txt en;pt-br;mn-mn;ja;es;ru\n  \".\\StackOverflow\\Content\\Js\\*.js;.\\StackOverflow\\Content\\Js\\PartialJS\\**\\*.js\"</code></pre> \n</figure> \n<p>Phew, that was easy. I don’t know why everyone hates localization. Just kidding, localization sucks here too. Now I don’t want to dive too far into localization because that’s a whole (very long) post on its own, but here are the translation basics:</p> \n<p>Strings are surrounded by <code class=\"language-plaintext highlighter-rouge\">_s()</code> (regular string) or <code class=\"language-plaintext highlighter-rouge\">_m()</code> (markdown) in code. We love <code class=\"language-plaintext highlighter-rouge\">_s()</code> and <code class=\"language-plaintext highlighter-rouge\">_m()</code>. It’s almost identical for both JavaScript and C#. During the build, we extract these strings by analyzing the JavaScript (with <a href=\"https://www.nuget.org/packages/AjaxMin/\">AjaxMin</a>) and C#/Razor (with a custom <a href=\"https://github.com/dotnet/roslyn\">Roslyn</a>-based build). We take these strings and stick them in files to use for the translators, our community team, and ultimately back into the build later. There’s obviously <em>way</em> more going on - but those are the relevant bits. It’s worth noting here that we’re excited about the proposed <a href=\"https://github.com/dotnet/roslyn/blob/features/source-generators/docs/features/generators.md\">Source Generators</a> feature specced for a future Roslyn release. We hope in its final form we’ll be able to re-write this portion of Moonspeak as a much simpler generator while still avoiding as many runtime allocations as possible.</p> \n<h4 id=\"step-5-msbuild\">Step 5: MSBuild</h4> \n<p>This is where most of the magic happens. It’s a single step, but behind the scenes, we’re doing unspeakable things to MSBuild that I’m going to…speak about, I guess. The full <code class=\"language-plaintext highlighter-rouge\">.msbuild</code> file <a href=\"https://gist.github.com/NickCraver/b59ff38567b32936e2a3440e439d5d5c#file-build-msbuild\">is in the earlier Gist</a>. The most relevant section is the description of crazy:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-md\" data-lang=\"md\">THIS IS HOW WE ROLL:  \nCompileWeb - ReplaceConfigs - - - - - - BuildViews - - - - - - - - - - - - - PrepareStaticContent  \n                   <span class=\"se\">\\ </span>                                                           /|  \n                    '- BundleJavaScript - TranslateJsContent - CompileNode   - '  \nNOTE:  \nsince msbuild requires separate projects for parallel execution of targets, this build file is copied\n2 times, the DefaultTargets of each copy is set to one of BuildViews, CompileNode or CompressJSContent. \nthus the absence of the DependesOnTarget=\"ReplaceConfigs\" on those _call_ targets</code></pre> \n</figure> \n<p>While we maintain 1 copy of the file in the repo, during the build it actually forks into 2 parallel MSBuild processes. We simply copy the file, change the <code class=\"language-plaintext highlighter-rouge\">DefaultTargets</code>, and kick it off in parallel <a href=\"https://gist.github.com/NickCraver/b59ff38567b32936e2a3440e439d5d5c#file-build-xml-L146\">here</a>.</p> \n<p>The first process is building the ASP.NET MVC views with our custom Roslyn-based build in <a href=\"https://github.com/StackExchange/StackExchange.Precompilation\">StackExchange.Precompilation</a>, <a href=\"https://stackoverflow.blog/2015/07/23/announcing-stackexchange-precompilation/\">explained by Samo Prelog here</a>. It’s not only building the views but also plugging in localized strings for each language via <code class=\"language-plaintext highlighter-rouge\">switch</code> statements. There’s a hint at how that works <a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#localizationtranslations-moonspeak\">a bit further down</a>. We wrote this process for localization, but it turns out controlling the speed and batching of the view builds allows us to be <em>much</em> faster than <code class=\"language-plaintext highlighter-rouge\">aspnet_compiler</code> used to be. Rumor is performance has gotten better there lately, though.</p> \n<p>The second process is the <code class=\"language-plaintext highlighter-rouge\">.less</code>, <code class=\"language-plaintext highlighter-rouge\">.css</code>, and <code class=\"language-plaintext highlighter-rouge\">.js</code> compilation and minification which involves a few components. First up are the <code class=\"language-plaintext highlighter-rouge\">.jsbundle</code> files. They are simple files that look like this example:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-json\" data-lang=\"json\"><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"nl\">\"items\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"s2\">\"full-anon.jsbundle\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"PartialJS</span><span class=\"se\">\\\\</span><span class=\"s2\">full</span><span class=\"se\">\\\\</span><span class=\"s2\">*.js\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"bounty.js\"</span><span class=\"w\"> </span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"p\">}</span></code></pre> \n</figure> \n<p>These files are true to their name, they are simply concatenated bundles of files for use further on. This allows us to maintain JavaScript divided up nicely across many files but handle it as one file for the rest of the build. The same bundler code runs as an HTTP handler locally to combine on the fly for local development. This sharing allows us to mimic production as best we can.</p> \n<p>After bundling, we have regular old <code class=\"language-plaintext highlighter-rouge\">.js</code> files with JavaScript in them. They have letters, numbers, and even some semicolons. They’re delightful. After that, they go through the translator <em>of doom</em>. We think. No one really knows. It’s black magic. Really what happens here isn’t relevant, but we get a <code class=\"language-plaintext highlighter-rouge\">full.en.js</code>, <code class=\"language-plaintext highlighter-rouge\">full.ru.js</code>, <code class=\"language-plaintext highlighter-rouge\">full.pt.js</code>, etc. with the appropriate translations plugged in. It’s the same <code class=\"language-plaintext highlighter-rouge\">&lt;filename&gt;.&lt;locale&gt;.js</code> pattern for every file. I’ll do a deep-dive with Samo on <a href=\"https://trello.com/c/GdywwBgb/24-localization\">the localization post</a> (go vote it up if you’re curious).</p> \n<p>After JavaScript translation completes (10-12 seconds), we move on to the Node.js piece of the build. Note: node is not installed on the build servers; we have everything needed inside the repo. Why do we use Node.js? Because it’s the native platform for <a href=\"http://lesscss.org/\">Less.js</a> and <a href=\"https://github.com/mishoo/UglifyJS2\">UglifyJS</a>. Once upon a time we used <a href=\"http://www.dotlesscss.org/\">dotLess</a>, but we got tired of maintaining the fork and went with a node build process for faster absorption of new versions.</p> \n<p>The <code class=\"language-plaintext highlighter-rouge\">node-compile.js</code> is <a href=\"https://gist.github.com/NickCraver/b59ff38567b32936e2a3440e439d5d5c#file-node-compile-js\">also in the Gist</a>. It’s a simple forking script that sets up <code class=\"language-plaintext highlighter-rouge\">n</code> node worker processes to handle the hundreds of files we have (due to having hundreds of sites) with the main thread dishing out work. Files that are identical (e.g. the beta sites) are calculated once then cached, so we don’t do the same work a hundred times. It also does things like add cache breakers on our SVG URLs based on a hash of their contents. Since we also serve the CSS with a cache breaker at the application level, we have a cache-breaker that changes from bottom to top, properly cache-breaking at the client when anything changes. The script can probably be vastly improved (and I’d welcome it), it was just the simplest thing that worked and met our requirements when it was written and hasn’t needed to change much since.</p> \n<p>Note: a (totally unintentional) benefit of the cache-breaker calculation has been that we never deploy an incorrect image path in CSS. That situation blows up because we can’t find the file to calculate the hash…and the build fails.</p> \n<p>The totality of node-compile’s job is minifying the <code class=\"language-plaintext highlighter-rouge\">.js</code> files (in place, not something like <code class=\"language-plaintext highlighter-rouge\">.min.js</code>) and turning <code class=\"language-plaintext highlighter-rouge\">.less</code> into <code class=\"language-plaintext highlighter-rouge\">.css</code>. After that’s done, MSBuild has produced all the output we need to run a fancy schmancy website. Or at least something like Stack Overflow. Note that we’re slightly odd in that we share styles across many site themes, so we’re transforming hundreds of <code class=\"language-plaintext highlighter-rouge\">.less</code> files at once. That’s the reason for spawning workers — the number spawned scales based on core count.</p> \n<h4 id=\"step-6-translation-dump-c-edition\">Step 6: Translation Dump (C# Edition)</h4> \n<p>This step we call the transmogulator. It copies all of the to-be-localized strings we use in C# and Razor inside <code class=\"language-plaintext highlighter-rouge\">_s()</code> and <code class=\"language-plaintext highlighter-rouge\">_m()</code> out so we have the total set to send to the translators. This isn’t a direct extraction, it’s a collection of some custom attributes added when we translated things during compilation in the previous step. This step is just a slightly more complicated version of what’s happening in step #4 for JavaScript. We dump the files in raw <code class=\"language-plaintext highlighter-rouge\">.txt</code> files for use later (and as a history of sorts). We also dump the overrides here, where we supply overrides directly <em>on top of</em> what our translators have translated. These are typically community fixes we want to upstream.</p> \n<p>I realize a lot of that doesn’t make a ton of sense without going heavily into how the translation system works - which will be a topic for <a href=\"https://trello.com/c/GdywwBgb/24-localization\">a future post</a>. The basics are: we’re dumping all the strings from our codebase so that people can translate them. When they are translated, they’ll be available for step #5 above in the next build after.</p> \n<p>Here’s the entire step:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-cmd\" data-lang=\"cmd\">%system.moonspeaktools%\\Transmogulator.exe .\\StackOverflow\\bin en;pt-br;mn-mn;ja;es;ru\n  \"%system.translationsDumpPath%\\artifact-%build.number%.{0}.txt\" MoonSpeak\n%system.moonspeaktools%\\OverrideExporter.exe export \"%system.translationConnectionString%\"\n  \"%system.translationsDumpPath%\"</code></pre> \n</figure> \n<h4 id=\"step-7-importing-english-strings\">Step 7: Importing English Strings</h4> \n<p>One of the weird things to think about in localization is the <em>simplest</em> way to translate is to <em>not</em> special case English. To that end, here we are special casing it. Dammit, we already screwed up. But, by special casing it at build time, we prevent having to special case it later. Almost every string we put in would be correct in English, only needing the translation overrides for multiples and such (e.g. “1 item” vs “2 items”), so we want to immediately import anything added to the English result set so that it’s ready for Stack Overflow as soon as it’s built the first time (e.g. no delay on the translators for deploying a new feature). Ultimately, this step takes the text files created for English in Steps 4 and 6 and turns around and inserts them (into our translations database) for the English entries.</p> \n<p>This step also posts all new strings added to a special internal chatroom alerting our translators in all languages so that they can be translated ASAP. Though we don’t want to delay builds and deploys on new strings (they may appear in English for a build and we’re okay with that), we want to minimize it - so we have an alert pipe so to speak. Localization delays are binary: either you wait on all languages or you don’t. We choose faster deploys.</p> \n<p>Here’s the call for step 7:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-cmd\" data-lang=\"cmd\">%system.moonspeaktools%\\MoonSpeak.Importer.exe \"%system.translationConnectionString%\"\n  \"%system.translationsDumpPath%\\artifact-%build.number%.en.txt\" 9 false \n  \"https://teamcity/viewLog.html?buildId=%teamcity.build.id%&amp;tab=buildChangesDiv\"\n%system.moonspeaktools%\\MoonSpeak.Importer.exe \"%system.translationConnectionString%\"\n  \"%system.translationsDumpPath%\\artifact-%build.number%-js.en.txt\" 9 false\n  \"https://teamcity/viewLog.html?buildId=%teamcity.build.id%&amp;tab=buildChangesDiv\"</code></pre> \n</figure> \n<h4 id=\"step-8-deploy-website\">Step 8: Deploy Website</h4> \n<p>Here’s where all of our hard work pays off. Well, the build server’s hard work really…but we’re taking credit. We have one goal here: take our built code and turn it into the active code on all target web servers. This is where you can get really complicated when you really just need to do something simple. What do you <em>really</em> need to perform to deploy updated code to a web server? Three things:</p> \n<ol> \n <li>Stop the website</li> \n <li>Overwrite the files</li> \n <li>Start the website</li> \n</ol> \n<p>That’s it. That’s all the major pieces. So let’s get as close to the stupidest, simplest process as we can. Here’s the call for that step, it’s a PowerShell script we pre-deploy on all build agents (with a build) that very rarely changes. We use the same set of scripts for all IIS website deployments, even the Jekyll-based blog. Here are the arguments we pass to the <code class=\"language-plaintext highlighter-rouge\">WebsiteDeploy.ps1</code> script:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-powershell\" data-lang=\"powershell\"><span class=\"nt\">-HAProxyServers</span><span class=\"w\"> </span><span class=\"s2\">\"%deploy.HAProxy.Servers%\"</span><span class=\"w\"> \n</span><span class=\"nt\">-HAProxyPort</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"nf\">deploy.HAProxy.Port</span><span class=\"o\">%</span><span class=\"w\">\n</span><span class=\"nt\">-Servers</span><span class=\"w\"> </span><span class=\"s2\">\"%deploy.ServerNames%\"</span><span class=\"w\">\n</span><span class=\"nt\">-Backends</span><span class=\"w\"> </span><span class=\"s2\">\"%deploy.HAProxy.Backends%\"</span><span class=\"w\"> \n</span><span class=\"nt\">-Site</span><span class=\"w\"> </span><span class=\"s2\">\"%deploy.WebsiteName%\"</span><span class=\"w\">\n</span><span class=\"nt\">-Delay</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"nf\">deploy.HAProxy.Delay.IIS</span><span class=\"o\">%</span><span class=\"w\">\n</span><span class=\"nt\">-DelayBetween</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"nf\">deploy.HAProxy.Delay.BetweenServers</span><span class=\"o\">%</span><span class=\"w\">\n</span><span class=\"nt\">-WorkingDir</span><span class=\"w\"> </span><span class=\"s2\">\"%teamcity.build.workingDir%\\%deploy.WebsiteDirectory%\"</span><span class=\"w\">\n</span><span class=\"nt\">-ExcludeFolders</span><span class=\"w\"> </span><span class=\"s2\">\"%deploy.RoboCopy.ExcludedFolders%\"</span><span class=\"w\">\n</span><span class=\"nt\">-ExcludeFiles</span><span class=\"w\"> </span><span class=\"s2\">\"%deploy.RoboCopy.ExcludedFiles%\"</span><span class=\"w\">\n</span><span class=\"nt\">-ContentSource</span><span class=\"w\"> </span><span class=\"s2\">\"%teamcity.build.workingDir%\\%deploy.contentSource%\"</span><span class=\"w\">\n</span><span class=\"nt\">-ContentSStaticFolder</span><span class=\"w\"> </span><span class=\"s2\">\"%deploy.contentSStaticFolder%\"</span></code></pre> \n</figure> \n<p>I’ve included script <a href=\"https://gist.github.com/NickCraver/b59ff38567b32936e2a3440e439d5d5c#file-deployscripts-ps1\">in the Gist here</a>, with all the relevant functions from the profile included for completeness. The meat of the main script is here (lines shortened for fit below, but the complete version is in the Gist):</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-powershell\" data-lang=\"powershell\"><span class=\"nv\">$ServerSession</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">Get-ServerSession</span><span class=\"w\"> </span><span class=\"nv\">$s</span><span class=\"w\">\n</span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">$ServerSession</span><span class=\"w\"> </span><span class=\"o\">-ne</span><span class=\"w\"> </span><span class=\"bp\">$null</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"nf\">Execute</span><span class=\"w\"> </span><span class=\"s2\">\"Server: </span><span class=\"nv\">$s</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n        </span><span class=\"nf\">HAProxyPost</span><span class=\"w\"> </span><span class=\"nt\">-Server</span><span class=\"w\"> </span><span class=\"nv\">$s</span><span class=\"w\"> </span><span class=\"nt\">-Action</span><span class=\"w\"> </span><span class=\"s2\">\"drain\"</span><span class=\"w\">\n        </span><span class=\"c\"># delay between taking a server out and killing the site, so current requests can finish</span><span class=\"w\">\n        </span><span class=\"nf\">Delay</span><span class=\"w\"> </span><span class=\"nt\">-Delay</span><span class=\"w\"> </span><span class=\"nv\">$Delay</span><span class=\"w\">\n        </span><span class=\"c\"># kill website in IIS</span><span class=\"w\">\n        </span><span class=\"nf\">ToggleSite</span><span class=\"w\"> </span><span class=\"nt\">-ServerSession</span><span class=\"w\"> </span><span class=\"nv\">$ServerSession</span><span class=\"w\"> </span><span class=\"nt\">-Action</span><span class=\"w\"> </span><span class=\"s2\">\"stop\"</span><span class=\"w\"> </span><span class=\"nt\">-Site</span><span class=\"w\"> </span><span class=\"nv\">$Site</span><span class=\"w\">\n        </span><span class=\"c\"># inform HAProxy this server is down, so we don't come back up immediately</span><span class=\"w\">\n        </span><span class=\"nf\">HAProxyPost</span><span class=\"w\"> </span><span class=\"nt\">-Server</span><span class=\"w\"> </span><span class=\"nv\">$s</span><span class=\"w\"> </span><span class=\"nt\">-Action</span><span class=\"w\"> </span><span class=\"s2\">\"hdown\"</span><span class=\"w\">\n        </span><span class=\"c\"># robocopy!</span><span class=\"w\">\n        </span><span class=\"nf\">CopyDirectory</span><span class=\"w\"> </span><span class=\"nt\">-Server</span><span class=\"w\"> </span><span class=\"nv\">$s</span><span class=\"w\"> </span><span class=\"nt\">-Source</span><span class=\"w\"> </span><span class=\"nv\">$WorkingDir</span><span class=\"w\"> </span><span class=\"nt\">-Destination</span><span class=\"w\"> </span><span class=\"s2\">\"\\\\</span><span class=\"nv\">$s</span><span class=\"s2\">\\...\"</span><span class=\"w\">\n        </span><span class=\"c\"># restart website in IIS</span><span class=\"w\">\n        </span><span class=\"nf\">ToggleSite</span><span class=\"w\"> </span><span class=\"nt\">-ServerSession</span><span class=\"w\"> </span><span class=\"nv\">$ServerSession</span><span class=\"w\"> </span><span class=\"nt\">-Action</span><span class=\"w\"> </span><span class=\"s2\">\"start\"</span><span class=\"w\"> </span><span class=\"nt\">-Site</span><span class=\"w\"> </span><span class=\"nv\">$Site</span><span class=\"w\"> \n        </span><span class=\"c\"># stick the site back in HAProxy rotation</span><span class=\"w\">\n        </span><span class=\"nf\">HAProxyPost</span><span class=\"w\"> </span><span class=\"nt\">-Server</span><span class=\"w\"> </span><span class=\"nv\">$s</span><span class=\"w\"> </span><span class=\"nt\">-Action</span><span class=\"w\"> </span><span class=\"s2\">\"ready\"</span><span class=\"w\">\n        </span><span class=\"c\"># session cleanup</span><span class=\"w\">\n        </span><span class=\"nv\">$ServerSession</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nf\">Remove-PSSession</span><span class=\"w\">\n    </span><span class=\"p\">}</span><span class=\"w\">\n</span><span class=\"p\">}</span></code></pre> \n</figure> \n<p>The steps here are the minimal needed to <em>gracefully</em> update a website, informing the load balancer of what’s happening and impacting users as little as possible. Here’s what happens:</p> \n<ol> \n <li>Tell <a href=\"https://www.haproxy.org/\">HAProxy</a> to stop sending new traffic</li> \n <li>Wait a few seconds for all current requests to finish</li> \n <li>Tell IIS to stop the site (<a href=\"https://technet.microsoft.com/en-us/library/ee790607.aspx\"><code class=\"language-plaintext highlighter-rouge\">Stop-Website</code></a>)</li> \n <li>Tell HAProxy that this webserver is down (rather than waiting for it to detect)</li> \n <li>Copy the new code (<a href=\"https://technet.microsoft.com/en-us/library/cc733145.aspx\"><code class=\"language-plaintext highlighter-rouge\">robocopy</code></a>)</li> \n <li>Tell IIS to start the new site (<a href=\"https://technet.microsoft.com/en-us/library/hh867884(v=wps.630).aspx\"><code class=\"language-plaintext highlighter-rouge\">Start-Website</code></a>)</li> \n <li>Tell HAProxy this website is ready to come back up</li> \n</ol> \n<p>Note that HAProxy doesn’t <em>immediately</em> bring the site back online. It will do so after 3 successful polls, this is a key difference between <code class=\"language-plaintext highlighter-rouge\">MAINT</code> and <code class=\"language-plaintext highlighter-rouge\">DRAIN</code> in HAProxy. <code class=\"language-plaintext highlighter-rouge\">MAINT</code> -&gt; <code class=\"language-plaintext highlighter-rouge\">READY</code> assumes the server is instantly up. <code class=\"language-plaintext highlighter-rouge\">DRAIN</code> -&gt; <code class=\"language-plaintext highlighter-rouge\">READY</code> assumes down. The former has a very nasty effect on <a href=\"https://msdn.microsoft.com/en-us/library/system.threading.threadpool.aspx\">ThreadPool</a> growth waiting with the initial slam while things are spinning up.</p> \n<p>We repeat the above for all webservers in the build. There’s also a slight pause between each server, all of which is tunable with TeamCity settings.</p> \n<p>Now the above is what happens <em>for a single website</em>. In reality, this step deploys twice. The reason why is race conditions. For the best client-side performance, our static assets have headers set to cache for 7 days. We break this cache <em>only when it changes</em>, not on every build. After all, you only need to fetch new CSS, SVGs, or JavaScript if they actually changed. Since <a href=\"https://cdn.sstatic.net/\"><code class=\"language-plaintext highlighter-rouge\">cdn.sstatic.net</code></a> comes from our web tier underneath, here’s what <em>could</em> happen due to the nature of a rolling build:</p> \n<p>You hit <code class=\"language-plaintext highlighter-rouge\">ny-web01</code> and get a brand spanking new querystring for the new version. Your browser then hits our CDN at <code class=\"language-plaintext highlighter-rouge\">cdn.sstatic.net</code>, which let’s say hits <code class=\"language-plaintext highlighter-rouge\">ny-web07</code>…which has the old content. Oh crap, now we have old content cached with the new hash for a hell of a long time. That’s no good, that’s a hard reload to fix, <em>after</em> you purge the CDN. We avoid that by pre-deploying the static assets to another website in IIS specifically serving the CDN. This way <code class=\"language-plaintext highlighter-rouge\">sstatic.net</code> gets the content in one rolling deploy, just before the new code issuing new hashes goes out. This means that there is a slight chance that someone will get <em>new</em> static content with an <em>old</em> hash (if they hit a CDN miss for a piece of content that actually changed this build). The big difference is that (rarely hit) problem fixes itself on a page reload, since the hash will change as soon as the new code is running a minute later. It’s a much better direction to fail in.</p> \n<p>At the end of this step (in production), 7 of 9 web servers are typically online and serving users. The last 2 will finish their spin-up shortly after. The step takes about 2 minutes for 9 servers. But yay, our code is live! Now we’re free to deploy again for that bug we probably just sent out.</p> \n<h4 id=\"step-9-new-strings-hook\">Step 9: New Strings Hook</h4> \n<p>This dev-only step isn’t particularly interesting, but useful. All it does is call a webhook telling it that some new strings were present in this build if there were any. The hook target triggers an upload to our translation service to tighten the iteration time on translations (similar to our chat mechanism above). It’s last because strictly speaking it’s optional and we don’t want it to interfere.</p> \n<p>That’s it. Dev build complete. Put away the <a href=\"https://xkcd.com/303/\">rolly chairs and swords</a>.</p> \n<h3 id=\"tiers\">Tiers</h3> \n<p>What we covered above was the entire development CI build with all the things™. All of the translation bits are development only because we just need to get the strings once. The meta and production builds are a simpler subset of the steps. Here’s a simple visualization that compares the build steps across tiers:</p> \n<table class=\"comparison\"> \n <tr> \n  <th>Build Step</th> \n  <th>Dev</th> \n  <th>Meta</th> \n  <th>Prod</th> \n </tr> \n <tr> \n  <td>1 - Migrate Sites DB</td> \n  <td class=\"lit\"></td> \n  <td></td> \n  <td></td> \n </tr> \n <tr> \n  <td>2 - Migrate Q&amp;A DBs</td> \n  <td class=\"lit\"></td> \n  <td class=\"lit\"></td> \n  <td></td> \n </tr> \n <tr> \n  <td>3 - Find MoonSpeak Tools</td> \n  <td class=\"lit\"></td> \n  <td class=\"lit\"></td> \n  <td class=\"lit\"></td> \n </tr> \n <tr> \n  <td>4 - Translation Dump (JavaScript)</td> \n  <td class=\"lit\"></td> \n  <td></td> \n  <td></td> \n </tr> \n <tr> \n  <td>5 - MSBuild (Compile Compress and Minify)</td> \n  <td class=\"lit\"></td> \n  <td class=\"lit\"></td> \n  <td class=\"lit\"></td> \n </tr> \n <tr> \n  <td>6 - Translation Dump (C#)</td> \n  <td class=\"lit\"></td> \n  <td></td> \n  <td></td> \n </tr> \n <tr> \n  <td>7 - Translations Import English Strings</td> \n  <td class=\"lit\"></td> \n  <td></td> \n  <td></td> \n </tr> \n <tr> \n  <td>8 - Deploy Website</td> \n  <td class=\"lit\"></td> \n  <td class=\"lit\"></td> \n  <td class=\"lit\"></td> \n </tr> \n <tr> \n  <td>9 - New Strings Hook</td> \n  <td class=\"lit\"></td> \n  <td></td> \n  <td></td> \n </tr> \n</table> \n<!-- Since you were bored enough to look at the source, here's something to do: https://www.youtube.com/watch?v=W3TtS1wkb7M --> \n<p>What do the tiers really translate to? All of our development sites are on WEB10 and WEB11 servers (under different application pools and websites). Meta runs on WEB10 and WEB11 servers, this is specifically <a href=\"https://meta.stackexchange.com/\">meta.stackexchange.com</a> and <a href=\"https://meta.stackoverflow.com/\">meta.stackoverflow.com</a>. Production (all other Q&amp;A sites and metas) like Stack Overflow are on WEB01-WEB09.</p> \n<p>Note: we do a chat notification for build as someone goes through the tiers. Here’s me (against all sane judgement) building out some changes at 5:17pm on a Friday. Don’t try this at home, I’m a professional. Sometimes. Not often.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Chat.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Chat.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Chat.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Chat.png\" loading=\"lazy\" alt=\"Chat Messages\" /> \n  </picture></a></p> \n<h3 id=\"database-migrations\">Database Migrations</h3> \n<p>See? I promised we’d come back to these. To reiterate: if new code is needed to handle the database migrations, <em>it must be deployed first</em>. In practice though, you’re likely dropping a table, or adding a table/column. For the removal case, we remove it from code, deploy, then deploy again (or later) with the drop migration. For the addition case, we would typically add it as nullable or unused in code. If it needs to be <code class=\"language-plaintext highlighter-rouge\">not null</code>, a foreign key, etc. we’d do that in a later deploy as well.</p> \n<p>The database migrator we use is a very simple repo we could open source, but honestly, there are dozens out there and the “same migration against n databases” is fairly specific. The others are probably much better and ours is very specific to <em>only</em> our needs. The migrator connects to the Sites database, gets the list of databases to run against, and executes all migrations against every one (running multiple databases in parallel). This is done by looking at the passed-in migrations folder and loading it (once) as well as hashing the contents of every file. Each database has a <code class=\"language-plaintext highlighter-rouge\">Migrations</code> table that keeps track of what has already been run. It looks like this (descending order):</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Migrations-Table.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Migrations-Table.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Migrations-Table.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Migrations-Table.png\" loading=\"lazy\" alt=\"Migrations Table\" /> \n  </picture></a></p> \n<p>Note that the above aren’t all in file number order. That’s because 724 and 725 were in a branch for a few days. That’s not an issue, order is not guaranteed. <strong>Each migration itself is written to be idempotent</strong>, e.g. “don’t try to add the column if it’s already there”, but the specific order isn’t usually relevant. Either they’re all per-feature, or they’re actually going in-order anyway. The migrator respects the <code class=\"language-plaintext highlighter-rouge\">GO</code> operator to separate batches and by default runs all migrations in a transaction. The transaction behavior can be changed with a first-line comment in the <code class=\"language-plaintext highlighter-rouge\">.sql</code> file: <code class=\"language-plaintext highlighter-rouge\">-- no transaction --</code>. Perhaps the most useful explanation to the migrator is the README.md I wrote for it. <a href=\"https://gist.github.com/NickCraver/b59ff38567b32936e2a3440e439d5d5c#file-sql-migrator-readme-md\">Here it is in the Gist</a>.</p> \n<p>In memory, we compare the list of migrations that already ran to those needing to run then execute what needs running, in file order. If we find the hash of a filename doesn’t match the migration with the same file name in the table, we abort as a safety measure. We can <code class=\"language-plaintext highlighter-rouge\">--force</code> to resolve this in the rare cases a migration <em>should</em> have changed (almost always due to developer error). After all migrations have run, we’re done.</p> \n<p>Rollbacks. We rarely do them. In fact, I can’t remember ever having done one. We avoid them through the approach in general: we deploy small and often. It’s often quicker to fix code and deploy than reverse a migration, especially across hundreds of databases. We also make development mimic production as often as possible, restoring production data periodically. If we needed to reverse something, we could just push another migration negating whatever we did that went boom. The tooling has no concept of rollback though. Why roll back when you can roll forward?</p> \n<h3 id=\"localizationtranslations-moonspeak\">Localization/Translations (Moonspeak)</h3> \n<p>This will get its own post, but I wanted to hint at why we do all of this work at compile time. After all, I always advocate strongly for simplicity (yep, even in this 6,000-word blog post - the irony is not lost on me). You should only do something more complicated when you <em>need</em> to do something more complicated. This is one of those cases, for performance. <a href=\"https://twitter.com/m0sa\">Samo</a> does a lot of work to make our localizations have as little <strong>runtime</strong> impact as possible. We’ll gladly trade a bit of build complexity to make that happen. While there are options such as <a href=\"https://msdn.microsoft.com/en-us/library/ekyft91f.aspx\"><code class=\"language-plaintext highlighter-rouge\">.resx</code> files</a> or <a href=\"https://github.com/aspnet/localization\">the new localization in ASP.NET Core 1.0</a>, most of these allocate more than necessary especially with tokenized strings. Here’s what strings look like in our code:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Deployment-Translations-1.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Translations-1.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Translations-1.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Translations-1.png\" loading=\"lazy\" alt=\"Translations: IDE\" /> \n  </picture></a></p> \n<p>And here’s what that line looks like compiled (via Reflector): <a href=\"https://nickcraver.com/blog/content/SO-Deployment-Translations-2.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Translations-2.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Translations-2.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Translations-2.png\" loading=\"lazy\" alt=\"Translations: Reflected\" /> \n  </picture></a> …and most importantly, the compiled implementation: <a href=\"https://nickcraver.com/blog/content/SO-Deployment-Translations-3.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Deployment-Translations-3.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Deployment-Translations-3.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Deployment-Translations-3.png\" loading=\"lazy\" alt=\"Translations: Reflected 2\" /> \n  </picture></a></p> \n<p>Note that we aren’t allocating the entire string together, only the pieces (with most interned). This may seem like a small thing, but at scale that’s a <em>huge</em> number of allocations and a lot of time in a garbage collector. I’m sure that just raises a ton of questions about how Moonspeak works. If so, <a href=\"https://trello.com/c/GdywwBgb/24-localization-moonspeak-translations\">go vote it up</a>. It’s a big topic in itself, I only wanted to justify the compile-time complication it adds here. To us, it’s worth it.</p> \n<h3 id=\"building-without-breaking\">Building Without Breaking</h3> \n<p>A question I’m often asked is how we prevent breaks while rolling out new code constantly. Here are some common things we run into and how we avoid them.</p> \n<ul> \n <li>Cache object changes: \n  <ul> \n   <li>If we have a cache object that totally changes. That’s a new cache key and we let the old one fall out naturally with time.</li> \n   <li>If we have a cache object that only changes <em>locally</em> (in-memory): nothing to do. The new app domain doesn’t collide.</li> \n   <li>If we have a cache object that changes <em>in redis</em>, then we need to make sure the old and new <a href=\"https://github.com/mgravell/protobuf-net\">protobuf</a> signatures are compatible…or change the key.</li> \n  </ul> </li> \n <li>Tag Engine: \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/#service-tier-iis-aspnet-mvc-523-net-461-and-httpsys\">The tag engine</a> reloads on every build (currently). This is triggered by checking every minute for a new build hash on the web tier. If one is found, the application <code class=\"language-plaintext highlighter-rouge\">\\bin</code> and a few configs are downloaded to the Stack Server host process and spun up as a new app domain. This sidesteps the need for a deploy to those boxes and keeps local development setup simple (we run no separate process locally).</li> \n   <li>This one is changing drastically soon, since reloading every build is way more often that necessary. We’ll be moving to a more traditional deploy-it-when-it-changes model there soon. Possibly using GPUs. Stay tuned.</li> \n  </ul> </li> \n <li>Renaming SQL objects: \n  <ul> \n   <li>“Doctor it hurts when I do that!”</li> \n   <li>“Don’t do that.”</li> \n   <li>We may add and migrate, but a live rename is almost certain to cause an outage of some sort. We don’t do that outside of dev.</li> \n  </ul> </li> \n <li>APIs: \n  <ul> \n   <li>Deploy the new endpoint before the new consumer.</li> \n   <li>If changing an existing endpoint, it’s usually across 3 deploys: add (endpoint), migrate (consumer), cleanup (endpoint).</li> \n  </ul> </li> \n <li>Bugs: \n  <ul> \n   <li>Try not to deploy bugs.</li> \n   <li>If you screw up, try not to do it the same way twice.</li> \n   <li>Accept that crap happens, live, learn, and move on.</li> \n  </ul> </li> \n</ul> \n<p>That’s all of the major bits of our deployment process. But as always, ask any questions you have in comments below and you’ll get an answer.</p> \n<p>I want to take a minute and thank the teams at Stack Overflow here. We build all of this, together. Many people help me review these blog posts before they go out to make sure everything is accurate. The posts are not short, and several people are reviewing them in off-hours because they simply saw a post in chat and wanted to help out. These same people hop into comment threads here, on Reddit, on Hacker News, and other places discussions pop up. They answer questions as they arise or relay them to someone who can answer. They do this on their own, out of a love for the community. I’m tremendously appreciative of their effort and it’s a privilege to work with some of the best programmers and sysadmins in the world. <a href=\"https://twitter.com/E_Craver\">My lovely wife Elise</a> also gives her time to help edit these before they go live. To all of you: thanks.</p> \n<p>What’s next? The way <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">this series</a> works is I blog in order of what the community wants to know about most. Going by <a href=\"https://trello.com/b/0zgQjktX/blog-post-queue-for-stack-overflow-topics\">the Trello board</a>, it looks like <a href=\"https://trello.com/c/1Oc9cC6u/11-monitoring\">Monitoring</a> is the next most interesting topic. So next time expect to learn how we monitor all of the systems here at Stack. I’ll cover how we monitor servers and services as well as the performance of Stack Overflow 24/7 as users see it all over the world. I’ll also cover many of the monitoring tools we’re using and have built; we’ve open sourced several big ones. Thanks for reading this post which ended up way longer than I envisioned and see you next time.</p>","descriptionType":"text/html","publishedDate":"Tue, 03 May 2016 00:00:00 +0000","feedId":12609,"bgimg":"https://nickcraver.com/blog/content/SO-Deployment-Stars.png","linkMd5":"98f7d9bbe42bf70a9d5975a7fdda0f94","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn13@2020_2/2020/08/25/02-05-18-394_1d1733ddc311fae4.webp","destWidth":692,"destHeight":202,"sourceBytes":21171,"destBytes":17610,"author":"","articleImgCdnMap":{"https://nickcraver.com/blog/content/SO-Deployment-Stars.png":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn13@2020_2/2020/08/25/02-05-18-394_1d1733ddc311fae4.webp","https://nickcraver.com/blog/content/SO-Deployment-Migrations.png":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn25@2020_3/2020/08/25/02-05-20-008_5f890e42625d97b2.webp","https://nickcraver.com/blog/content/SO-Deployment-Pinbot.png":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn2@2020_4/2020/08/25/02-05-21-784_876df4b594f1b846.webp","https://nickcraver.com/blog/content/SO-Deployment-Migration-Log.png":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn30@2020_6/2020/08/25/02-05-20-170_43d8067036221185.webp","https://nickcraver.com/blog/content/SO-Deployment-Dev-Builds.png":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn78@2020_6/2020/08/25/02-05-20-206_40905c86d0e476b1.webp","https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Steps.png":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn69@2020_5/2020/08/25/02-05-20-418_0e1118c2d90e2cdb.webp","https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Log.png":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn54@2020_4/2020/08/25/02-05-22-675_d68bc522d4a388b6.webp","https://nickcraver.com/blog/content/SO-Deployment-Chat.png":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn53@2020_2/2020/08/25/02-05-20-085_d9b0524a848fd69e.webp","https://nickcraver.com/blog/content/SO-Deployment-Migrations-Table.png":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn86@2020_6/2020/08/25/02-05-20-563_dd9c133c81405e9b.webp","https://nickcraver.com/blog/content/SO-Deployment-Translations-1.png":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn33@2020_1/2020/08/25/02-05-20-150_c5277baef17c65a1.webp","https://nickcraver.com/blog/content/SO-Deployment-Translations-2.png":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn66@2020_5/2020/08/25/02-05-20-084_e0a1733547566164.webp","https://nickcraver.com/blog/content/SO-Deployment-Translations-3.png":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn45@2020_6/2020/08/25/02-05-22-842_0d980df37fcf38e4.webp"},"publishedOrCreatedDate":1598321095275},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"Binding Redirects","link":"https://nickcraver.com/blog/2020/02/11/binding-redirects/","description":"<blockquote> \n <p>This isn’t part of the <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">series on Stack Overflow’s architecture</a>, but is a topic that has bitten us many times. Hopefully, some of this information helps you sort out issues you hit.</p> \n</blockquote> \n<p>You’re probably here because of an error like this:</p> \n<blockquote> \n <p>Could not load file or assembly ‘System.&lt;…&gt;, Version=4.x.x.x, Culture=neutral, PublicKeyToken=&lt;…&gt;’ or one of its dependencies. The system cannot find the file specified.</p> \n</blockquote> \n<p>And you likely saw a build warning like this:</p> \n<blockquote> \n <p>warning MSB3277: Found conflicts between different versions of “System.&lt;…&gt;” that could not be resolved.</p> \n</blockquote> \n<p>Whelp, you’re not alone. We’re thinking about starting a survivors group. The most common troublemakers here are:</p> \n<ul> \n <li><code class=\"language-plaintext highlighter-rouge\">System.Memory</code> (<a href=\"https://www.nuget.org/packages/System.Memory/\">NuGet link</a>)</li> \n <li><code class=\"language-plaintext highlighter-rouge\">System.Net.Http</code> (<a href=\"https://www.nuget.org/packages/System.Net.Http/\">NuGet link</a>)</li> \n <li><code class=\"language-plaintext highlighter-rouge\">System.Numerics.Vectors</code> (<a href=\"https://www.nuget.org/packages/System.Numerics.Vectors/\">NuGet link</a>)</li> \n <li><code class=\"language-plaintext highlighter-rouge\">System.Runtime.CompilerServices.Unsafe</code> (<a href=\"https://www.nuget.org/packages/System.Runtime.CompilerServices.Unsafe/\">NuGet link</a>)</li> \n <li><code class=\"language-plaintext highlighter-rouge\">System.ValueTuple</code> (<a href=\"https://www.nuget.org/packages/System.ValueTuple/\">NuGet link</a>)</li> \n</ul> \n<p>If you just want out of this fresh version of DLL Hell you’ve found yourself in…</p> \n<h3 id=\"the-best-fix\">The best fix</h3> \n<p>The best fix is “go to .NET Core”. Since .NET Framework (e.g. 4.5, 4.8, etc.) has a heavy backward compatibility burden, meaning that the assembly loader itself is basically made of unstable plutonium with a hair trigger coated in flesh eating bacteria behind a gate made of unobtanium above a moat of napalm filled with those jellyfish that kill you…that won’t ever really be fixed.</p> \n<p>However, .NET Core’s simplified assembly loading means it <em>just works</em>. I’m not saying a migration to .NET Core is trivial, that depends on your situation, but it is generally the best long-term play. We’re almost done porting Stack Overflow to .NET Core, and this kind of pain is one of the things we’re very much looking forward to not fighting ever again.</p> \n<h3 id=\"the-fix-if-youre-using-net-framework\">The fix if you’re using .NET Framework</h3> \n<p>The fix for .NET Framework is “<a href=\"https://docs.microsoft.com/en-us/dotnet/framework/configure-apps/redirect-assembly-versions\">binding redirects</a>”. When you are trying to load an assembly (and if it’s <a href=\"https://docs.microsoft.com/en-us/dotnet/standard/assembly/strong-named\">strongly named</a>, like the ones in the framework and many libs are), it’ll try to load the <em>specific version</em> you specified. Unless it’s told to load another (likely newer) version. Think of it as “Hey little buddy. It’s okay! Don’t cry! That API you want is still available…it’s just over here”. I don’t want to replicate the official documentation here since it’ll be updated much better by the awesome people on Microsoft Docs these days. Your options to fix it are:</p> \n<ul> \n <li><a href=\"https://docs.microsoft.com/en-us/dotnet/framework/configure-apps/how-to-enable-and-disable-automatic-binding-redirection\">Enable <code class=\"language-plaintext highlighter-rouge\">&lt;AutoGenerateBindingRedirects&gt;</code></a> (<em>this doesn’t work for web projects</em> - it doesn’t handle <code class=\"language-plaintext highlighter-rouge\">web.config</code>) \n  <ul> \n   <li>Note: this isn’t always perfect. It doesn’t handle all transitive cases especially around multi-targeting and conditional references.</li> \n  </ul> </li> \n <li>Build with Visual Studio and hope it has warnings and a click to fix (this <em>usually</em> works) \n  <ul> \n   <li>Note: this isn’t always perfect either, hence the “hope”.</li> \n  </ul> </li> \n <li><a href=\"https://docs.microsoft.com/en-us/dotnet/framework/configure-apps/redirect-assembly-versions#manually-editing-the-app-config-file\"><strong>Manually edit your *.config file</strong></a>. \n  <ul> \n   <li>This is the surest way (and what Visual Studio is doing above), but also the most manual and/or fun on upgrades.</li> \n  </ul> </li> \n</ul> \n<p>Unfortunately, what that “manual editing” article doesn’t mention is the <strong><em>assembly versions are not the NuGet versions</em></strong>. For instance, <a href=\"https://www.nuget.org/packages/System.Runtime.CompilerServices.Unsafe/4.7.0\">System.Runtime.CompilerServices.Unsafe 4.7.0</a> on NuGet is <em>assembly</em> version 4.0.6.0. The assembly version is what matters. The easiest way I use to figure this out on Windows is the <a href=\"https://github.com/NuGetPackageExplorer/NuGetPackageExplorer\">NuGet Package Explorer</a> (<a href=\"https://www.microsoft.com/en-us/p/nuget-package-explorer/9wzdncrdmdm3\">Windows Store link</a> - easiest install option) maintained by <a href=\"https://github.com/clairernovotny\">Claire Novotny</a>. Either from within NPE’s feed browser or from NuGet.org (there’s a “Download package” option in the right sidebar), open the package. Select the framework you’re loading (they <em>should</em> all match really) and double click the DLL. It’ll have a section that says “Strong Name: Yes, version: <code class=\"language-plaintext highlighter-rouge\">4.x.x.x</code>”</p> \n<p>For example, if you had libraries wanting various versions of <code class=\"language-plaintext highlighter-rouge\">System.Numerics.Vectors</code>, the most likely fix is to prefer the latest (as of writing this, <a href=\"https://www.nuget.org/packages/System.Runtime.CompilerServices.Unsafe/4.7.0\">4.7.0 on NuGet</a> which is assembly version 4.0.6.0 from earlier). Part of your config would look something like this:</p> \n<div class=\"language-xml highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;configuration&gt;</span>\n  <span class=\"nt\">&lt;runtime&gt;</span>\n    <span class=\"nt\">&lt;assemblyBinding</span> <span class=\"na\">xmlns=</span><span class=\"s\">\"urn:schemas-microsoft-com:asm.v1\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;dependentAssembly&gt;</span>\n        <span class=\"nt\">&lt;assemblyIdentity</span> <span class=\"na\">name=</span><span class=\"s\">\"System.Runtime.CompilerServices.Unsafe\"</span> <span class=\"na\">publicKeyToken=</span><span class=\"s\">\"b03f5f7f11d50a3a\"</span> <span class=\"na\">culture=</span><span class=\"s\">\"neutral\"</span><span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;bindingRedirect</span> <span class=\"na\">oldVersion=</span><span class=\"s\">\"0.0.0.0-4.0.6.0\"</span> <span class=\"na\">newVersion=</span><span class=\"s\">\"4.0.6.0\"</span><span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;/dependentAssembly&gt;</span>\n      <span class=\"c\">&lt;!-- ...and maybe some more... --&gt;</span>\n    <span class=\"nt\">&lt;/assemblyBinding&gt;</span>\n  <span class=\"nt\">&lt;/runtime&gt;</span>\n<span class=\"nt\">&lt;/configuration&gt;</span>\n</code></pre> \n </div> \n</div> \n<p>This means “anyone asking for any version before 4.0.6.0, send them to that one…it’s what in my <code class=\"language-plaintext highlighter-rouge\">bin\\</code> folder”. For a quick practical breakdown of these fields:</p> \n<ul> \n <li><code class=\"language-plaintext highlighter-rouge\">name</code>: The name of the strongly named DLL</li> \n <li><code class=\"language-plaintext highlighter-rouge\">publicKeyToken</code>: The public key of the strongly named DLL (this comes from key used to sign it)</li> \n <li><code class=\"language-plaintext highlighter-rouge\">culture</code>: Pretty much always <code class=\"language-plaintext highlighter-rouge\">neutral</code></li> \n <li><code class=\"language-plaintext highlighter-rouge\">oldVersion</code>: A <strong>range</strong> of versions, starting at <code class=\"language-plaintext highlighter-rouge\">0.0.0.0</code> (almost always what you want) means “redirect everything from X to Y”</li> \n <li><code class=\"language-plaintext highlighter-rouge\">newVersion</code>: The new version to “redirect” to, instead of any old one (usually matches end of the <code class=\"language-plaintext highlighter-rouge\">oldVersion</code> range)</li> \n</ul> \n<h3 id=\"when-do-i-need-to-do-this\">When do I need to do this?</h3> \n<p>Any of the above approaches to fixing it need to be revisited when a conflict arises again. This can happen when:</p> \n<ul> \n <li>Updating a NuGet package (Remember: <a href=\"https://docs.microsoft.com/en-us/nuget/concepts/dependency-resolution\">NuGet uses transitive dependencies</a>…so anything in the chain can cause it)</li> \n <li>Updating your target framework</li> \n</ul> \n<p>Note that binding redirects are to remedy <em>differences</em> in the reference chain (more on that below), so when all of your things reference the same version down their transitive chains, you don’t need one. So sometimes <em>removing</em> a binding redirect is the quick fix in an upgrade.</p> \n<p>But seriously, .NET Core. Of all the reasons we’re migrating over at Stack Overflow, binding redirects are in my top 5. We’ve lost soooo many days to this over the years.</p> \n<h3 id=\"whats-going-on-why-do-i-need-this\">What’s going on? Why do I need this?</h3> \n<p>The overall problem is that you have two different libraries ultimately wanting two different versions of one of these (and potentially anything else — this is a general case the three above are just the <em>most</em> common). Since dependencies are transitive, this means you just reference a library and the tooling will get what it needs. (That’s what <code class=\"language-plaintext highlighter-rouge\">&lt;PackageReference&gt;</code> does in your projects.) But what that means is you could have library <code class=\"language-plaintext highlighter-rouge\">A → B → System.Vectors</code> (version 1.0), and another reference to something like <code class=\"language-plaintext highlighter-rouge\">D → E → F → System.Vectors</code> (version 1.2).</p> \n<p>Uh oh, we have two things wanting two different versions. You may be thinking (for Windows) “but…won’t they be the same file in the <code class=\"language-plaintext highlighter-rouge\">bin\\</code> directory? How can you have both? How does that <em>even work</em>?” You’re not crazy. You’re hitting the error because <em>one of those two versions won</em>. It <em>should</em> be the newer one.</p> \n<p>Okay, so it’s broken. The code wanting the <em>other</em> version is what’s erroring. But maybe not on startup! That’s another fun part. It happens <em>the first time you touch a type that references types in that assembly</em>. Bonus: if this is in a static constructor, that type you’re trying to touch will most likely disappear. Poof. Gone. What does the app do without it? WHO KNOWS?! But buckle up, because you can bet your butt it’ll be fun. Imagine the compiler said “okay” but that type wasn’t really there later…because that’s basically the situation you find yourself in.</p> \n<p>So, we need to redirect things. In theory, the framework takes care of some of these indirections, but with some pieces deployed via NuGet it’s a bit of a mess and it’s far from perfect. That’s why you’re here. I hope this helped.</p> \n<p>In some versions of the framework, things aren’t quite right in what shipped - the few libraries up top are troublemakers more than all the others for this reason. Those are the versions that were glitched in various versions of .NET Framework. “Why don’t you fix .NET 4. \n <version>\n   ??\" is a question Microsoft gets a lot. They did — it's called \"the next version\". Being unable to break people, that's the only real way to fix it and not cause *other* damage. Keep in mind, we're talking about over a billion computers to update here. So, when you update to .NET 4.7.2 (most of the redirects are fixed here), .NET 4.8, etc. — more and more of the cases do go away. But with NuGet and later versions...yeah, they can come back. Generally speaking though, the later version of .NET Framework you're targeting and running on, the better. There has been progress. \n </version></p> \n<p>Anyway, I hope this helps some people out there. I should have written this up 5 years ago, and wish I had this info available to me 10 years ago. Good luck on fixing whatever brought you here!</p>","descriptionType":"text/html","publishedDate":"Tue, 11 Feb 2020 00:00:00 +0000","feedId":12609,"bgimg":"","linkMd5":"6091ca2d5973e683f57a26b17380e749","bgimgJsdelivr":"","metaImg":"","author":"","publishedOrCreatedDate":1598321095268},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"(tiny) Life At Stack Overflow: My Developers Are Smarter Than Your DBAs","link":"https://nickcraver.com/talks/tiny/developers-and-dbas","description":"<section> \n <h1>My Developers Are Smarter Than Your DBAs</h1> \n <p> \n  <svg class=\"stackoverflow-logo\" viewBox=\"0 0 400 116\" enable-background=\"new 0 0 400 116\" height=\"100px\"> \n   <g class=\"so-text\"> \n    <path d=\"M94.4,92.2c-4.6,0-8.2-1.1-11.2-3.9l2.7-2.7c2.2,2.3,5.1,3.2,8.5,3.2c4.5,0,7.2-1.6,7.2-4.8\n        c0-2.4-1.4-3.7-4.5-4l-4.5-0.4c-5.3-0.4-8.1-2.8-8.1-7.3c0-5,4.2-8,10-8c3.9,0,7.4,0.9,9.8,2.9l-2.6,2.6c-1.9-1.5-4.4-2.2-7.2-2.2\n        c-4,0-6.1,1.7-6.1,4.5c0,2.3,1.3,3.7,4.8,4l4.4,0.4c4.8,0.4,8,2.3,8,7.4C105.5,89.2,101,92.2,94.4,92.2z\" /> \n    <path d=\"M117.6,91.9c-4.6,0-7-3.3-7-7.3V67.9h-3.4v-3h3.4v-8.5h4v8.5h5.8v3h-5.8v16.6c0,2.5,1.2,4,3.7,4h2.1v3.4\n        H117.6z\" /> \n    <path d=\"M141,91.9v-2.6c-2.2,2.2-4.2,2.9-7.9,2.9c-3.8,0-6-0.7-7.7-2.5c-1.3-1.3-2-3.4-2-5.5c0-4.8,3.3-7.9,9.4-7.9\n        h8.2v-2.6c0-4-2-6-7-6c-3.5,0-5.3,0.8-6.9,3.1l-2.7-2.5c2.4-3.2,5.2-4,9.6-4c7.3,0,10.9,3.2,10.9,9.1v18.5H141z M141,79.3h-7.6\n        c-4.1,0-6.1,1.7-6.1,4.8c0,3.2,1.9,4.6,6.3,4.6c2.3,0,4.4-0.2,6.1-1.8c0.9-0.9,1.4-2.4,1.4-4.7V79.3z\" /> \n    <path d=\"M160.6,92.2c-6.9,0-12.1-4.6-12.1-13.9c0-9.3,5.2-13.9,12.1-13.9c3.8,0,6.1,1,9,4l-2.7,2.5\n        c-2-2.3-3.7-3-6.3-3c-2.7,0-4.9,1.1-6.3,3.1c-1.3,1.8-1.8,3.9-1.8,7.3c0,3.4,0.5,5.5,1.8,7.3c1.4,2,3.7,3.1,6.3,3.1\n        c2.6,0,4.2-0.8,6.3-3.1l2.7,2.6C166.7,91.2,164.4,92.2,160.6,92.2z\" /> \n    <path d=\"M191.4,91.9l-8.6-13.9l-5.3,6.1v7.9h-4V52.5h4v26.3l12.3-14.2h5l-9.2,10.4l10.8,16.8H191.4z\" /> \n    <path d=\"M217.7,88.9c-1.7,1.8-4.5,3.4-8.5,3.4c-4,0-6.8-1.6-8.4-3.4c-2.5-2.6-3.1-5.7-3.1-10.6\n        c0-4.9,0.6-8,3.1-10.6c1.7-1.8,4.4-3.4,8.4-3.4c4,0,6.8,1.6,8.5,3.4c2.5,2.6,3.1,5.7,3.1,10.6C220.8,83.2,220.1,86.3,217.7,88.9z\n         M212.4,71.6c-0.8-0.8-1.8-1.2-3.2-1.2s-2.4,0.4-3.1,1.2c-1.4,1.4-1.6,3.8-1.6,6.6c0,2.8,0.2,5.2,1.6,6.7c0.8,0.8,1.8,1.2,3.1,1.2\n        s2.4-0.4,3.2-1.2c1.4-1.4,1.6-3.8,1.6-6.7C213.9,75.4,213.8,73,212.4,71.6z\" /> \n    <path d=\"M236.1,91.9h-5.3l-10.1-27.3h7.2l5.6,16.9l5.5-16.9h7.2L236.1,91.9z\" /> \n    <path d=\"M252.5,80.4c0,3.5,2.1,6.1,6,6.1c3,0,4.5-0.8,6.2-2.6l4.1,4c-2.8,2.8-5.5,4.3-10.4,4.3\n        c-6.5,0-12.6-2.9-12.6-14c0-8.9,4.8-13.9,11.9-13.9c7.6,0,11.9,5.6,11.9,13.1v3H252.5z M262.3,72.8c-0.7-1.6-2.3-2.8-4.6-2.8\n        c-2.3,0-3.8,1.2-4.6,2.8c-0.4,1-0.6,1.7-0.6,2.9h10.4C262.8,74.5,262.7,73.8,262.3,72.8z\" /> \n    <path d=\"M287.8,72c-1-1-1.9-1.6-3.6-1.6c-2.1,0-4.4,1.6-4.4,5v16.5H273V64.6h6.7v2.6c1.3-1.6,3.9-2.9,6.9-2.9\n        c2.7,0,4.6,0.7,6.5,2.6L287.8,72z\" /> \n    <path d=\"M304.5,69.8v22.1h-6.8V69.8h-2.8v-5.2h2.8v-3.4c0-3.9,2.4-7.8,8-7.8h3.9v5.8h-2.6c-1.6,0-2.4,0.9-2.4,2.5v3\n        h5v5.2H304.5z M320.8,91.9c-5.6,0-8-3.9-8-7.8V53.4h6.8v30.3c0,1.6,0.7,2.5,2.4,2.5h2.6v5.8H320.8z\" /> \n    <path d=\"M345.6,88.9c-1.7,1.8-4.5,3.4-8.5,3.4c-4,0-6.8-1.6-8.4-3.4c-2.5-2.6-3.1-5.7-3.1-10.6\n        c0-4.9,0.6-8,3.1-10.6c1.7-1.8,4.4-3.4,8.4-3.4c4,0,6.8,1.6,8.5,3.4c2.5,2.6,3.1,5.7,3.1,10.6C348.7,83.2,348.1,86.3,345.6,88.9z\n         M340.3,71.6c-0.8-0.8-1.8-1.2-3.2-1.2c-1.4,0-2.4,0.4-3.1,1.2c-1.4,1.4-1.6,3.8-1.6,6.6c0,2.8,0.2,5.2,1.6,6.7\n        c0.8,0.8,1.8,1.2,3.1,1.2c1.4,0,2.4-0.4,3.2-1.2c1.4-1.4,1.6-3.8,1.6-6.7C341.9,75.4,341.8,73,340.3,71.6z\" /> \n    <path d=\"M379.3,91.9h-5.6L368,74.8l-5.7,17.1h-5.6l-8.4-27.3h7.2l4.4,16.9l5.6-16.9h5l5.6,16.9l4.4-16.9h7.2\n        L379.3,91.9z\" /> \n   </g> \n   <g> \n    <rect x=\"26.3\" y=\"58\" transform=\"matrix(0.9718 0.2357 -0.2357 0.9718 15.6501 -8.3368)\" fill=\"#BF9452\" width=\"32.8\" height=\"6.6\" /> \n    <rect x=\"30.5\" y=\"47\" transform=\"matrix(0.8905 0.455 -0.455 0.8905 28.0333 -15.8267)\" fill=\"#D28B29\" width=\"32.8\" height=\"6.6\" /> \n    <rect x=\"37.9\" y=\"36.2\" transform=\"matrix(0.7531 0.6579 -0.6579 0.7531 39.4192 -25.9804)\" fill=\"#F68A1F\" width=\"32.8\" height=\"6.6\" /> \n    <rect x=\"48.4\" y=\"27.1\" transform=\"matrix(0.5616 0.8274 -0.8274 0.5616 53.5922 -40.3072)\" fill=\"#F47920\" width=\"32.8\" height=\"6.6\" /> \n    <rect x=\"24.7\" y=\"68.9\" transform=\"matrix(0.9985 5.452314e-02 -5.452314e-02 0.9985 3.9961 -2.1364)\" fill=\"#A68A6E\" width=\"32.8\" height=\"6.6\" /> \n    <polygon fill=\"#818185\" points=\"64.2,91.8 64.2,64.6 70.7,64.6 70.7,98.4 11.4,98.4 11.4,64.6 17.9,64.6 17.9,91.8     \" /> \n    <rect x=\"24.5\" y=\"78.7\" fill=\"#818185\" width=\"33.1\" height=\"6.6\" /> \n   </g> \n  </svg> </p> \n <p> <small>by <a href=\"https://twitter.com/Nick_Craver\">@Nick_Craver</a></small> </p> \n</section> \n<section> \n <h2>What would you say...you do here?<h2> <h4>Last month at Stack Overflow:</h4> \n   <ul> \n    <li>1,468,389,303 Page Views</li> \n    <li>5,183,954,727 HTTP Hits</li> \n    <li>71,562,833,811,315 Bytes Sent</li> \n    <li>3,202,505,376 CDN Hits</li> \n    <li>54,400,000,000,000 CDN Bytes</li> \n    <li>19,532,899,854 SQL Queries</li> \n    <li>81,505,688,410 Redis Ops</li> \n    <li>18.2ms Average Render Time</li> \n    <li>...at roughly 5-10% capacity</li> \n   </ul> </h2></h2>\n</section> \n<section> \n <section> \n  <h2>How do we do that?<h2> </h2></h2>\n </section> \n <section> \n  <h2>Go that way, really fast.</h2> \n  <h2 class=\"fragment\">If something gets in your way...turn.</h2> \n </section> \n <section> \n  <h2>We're not ready to turn yet.</h2> \n </section> \n</section> \n<section> \n <section> \n  <h2>Being part of a team</h2> \n </section> \n <section> \n  <h2>Disadvantages:</h2> \n  <p class=\"fragment\">You no longer know all the things</p> \n  <p class=\"fragment\">You don't have time to learn all the things</p> \n  <p class=\"fragment\">Merge conflicts</p> \n </section> \n <section> \n  <h2>Advantages:</h2> \n  <p class=\"fragment\">You have help</p> \n  <p class=\"fragment\">Lots of help</p> \n  <p class=\"fragment\">More victims for the wheel of blame</p> \n </section> \n</section> \n<section> \n <section> \n  <h2>Pipelines</h2> \n </section> \n <section> \n  <h2>Most interactions with a DBA require 2 people</h2> \n  <p>This is true of anyone you're asking for a service</p> \n </section> \n</section> \n<section> \n <section> \n  <h2>Perspective &amp; Scope</h2> \n </section> \n <section> \n  <h2>We know the things we know</h2> \n  <p class=\"fragment\">Except knowing what we know</p> \n </section> \n <section> \n  <h2>Insight and decisions are based on our world</h2> \n  <p class=\"fragment\">Specifically, the world as we see it</p> \n </section> \n <section> \n  <h2>Fog of war</h2> \n </section> \n <section data-background=\"/talks/content/developers-and-dbas/dba.svg\"></section> \n <section data-background=\"/talks/content/developers-and-dbas/developer.svg\"></section> \n <section data-background=\"/talks/content/developers-and-dbas/overview.svg\"></section> \n</section> \n<section> \n <section> \n  <h2>What does this allow us to do?</h2> \n  <p class=\"fragment\">Tag Engine</p> \n  <p class=\"fragment\">Elasticsearch</p> \n  <p class=\"fragment\">Moving /users into redis</p> \n  <p class=\"fragment\" style=\"font-style: italic;\">Anything we want</p> \n </section> \n</section> \n<section> \n <h2>Q&amp;A?</h2> \n <p>We love Q&amp;A.</p> \n</section>","descriptionType":"text/html","publishedDate":"Fri, 24 Jul 2015 00:00:00 +0000","feedId":12609,"bgimg":"","linkMd5":"e343b6ecb684a93fcc24dfbe638f5e87","bgimgJsdelivr":"","metaImg":"","author":"","publishedOrCreatedDate":1598321095275},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"HTTPS on Stack Overflow: The End of a Long Road","link":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","description":"<p>Today, we deployed HTTPS by default on <a href=\"https://stackoverflow.com/\">Stack Overflow</a>. All traffic is now redirected to <code class=\"language-plaintext highlighter-rouge\">https://</code> and Google links will change over the next few weeks. The activation of this is quite literally flipping a switch (feature flag), but getting to that point has taken years of work. As of now, HTTPS is the default on all Q&amp;A websites.</p> \n<p>We’ve been rolling it out across the Stack Exchange network <a href=\"https://meta.stackoverflow.com/q/345012/13249\">for the past 2 months</a>. Stack Overflow is the last site, and by far the largest. This is a huge milestone for us, but by no means the end. There’s still more work to do, which <a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#next-steps\">we’ll get to</a>. But the end is finally in sight, hooray!</p> \n<p>Fair warning: This is the story of a long journey. Very long. As indicated by your scroll bar being very tiny right now. While Stack Exchange/Overflow is not unique in the problems we faced along the way, the combination of problems is fairly rare. I hope you find some details of our trials, tribulations, mistakes, victories, and even some open source projects that resulted along the way to be helpful. It’s hard to structure such an intricate dependency chain into a chronological post, so I’ll break this up by topic: infrastructure, application code, mistakes, etc. \n <!--more--></p> \n<p>I think it’s first helpful to preface with a list of problems that makes our situation somewhat unique:</p> \n<ul> \n <li>We have hundreds of domains (<a href=\"https://stackexchange.com/sites\">many sites</a> and other services) \n  <ul> \n   <li>Many second-level domains (<a href=\"https://stackoverflow.com/\">stackoverflow.com</a>, <a href=\"https://stackexchange.com/\">stackexchange.com</a>, <a href=\"https://askubuntu.com/\">askubuntu.com</a>, etc.)</li> \n   <li>Many 4th level domains (e.g. <a href=\"http://meta.gaming.stackexchange.com\">meta.gaming.stackexchange.com</a>)</li> \n  </ul> </li> \n <li>We allow user submitted &amp; embedded content (e.g. images and YouTube videos in posts)</li> \n <li>We serve from a single data center (latency to a single origin)</li> \n <li>We have ads (and ad networks)</li> \n <li>We use websockets, north of 500,000 active at any given (connection counts)</li> \n <li>We get DDoSed (proxy)</li> \n <li>We have many sites &amp; apps communicating via HTTP APIs (proxy issues)</li> \n <li>We’re obsessed with performance (<em>maybe</em> a little too much)</li> \n</ul> \n<p>Since this post is a bit crazy, links for your convenience:</p> \n<ul> \n <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#the-beginning\">The Beginning</a></li> \n <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#quick-specs\">Quick Specs</a></li> \n <li>Infrastructure \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#certificates\">Certificates</a> \n    <ul> \n     <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#certificates-child-metas-metastackexchangecom\">Child Metas (meta.*.stackexchange.com)</a></li> \n    </ul> </li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#performance-http2\">Performance: HTTP/2</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#haproxy-serving-up-https\">HAProxy: Serving up HTTPS</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#cdnproxy-countering-latency-with-cloudflare--fastly\">CDN/Proxy: Countering Latency with Cloudflare &amp; Fastly</a> \n    <ul> \n     <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#preparing-for-a-proxy-client-timings\">Preparing for a Proxy: Client Timings</a></li> \n     <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#cloudflare\">CloudFlare</a> \n      <ul> \n       <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#cloudflare-railgun\">Railgun</a></li> \n      </ul> </li> \n     <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#fastly\">Fastly</a></li> \n    </ul> </li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#global-dns\">Global DNS</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#testing\">Testing</a></li> \n  </ul> </li> \n <li>Applications/Code \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#preparing-the-applications\">Preparing the Applications</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#global-login\">Global Login</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#local-https-development\">Local HTTPS Development</a></li> \n   <li>Mixed Content \n    <ul> \n     <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mixed-content-from-you\">From You</a></li> \n     <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mixed-content-from-us\">From Us</a></li> \n    </ul> </li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#redirects-301s\">Redirects (301s)</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#websockets\">Websockets</a></li> \n  </ul> </li> \n <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#unknowns\">Unknowns</a></li> \n <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes\">Mistakes</a> \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes-protocol-relative-urls\">Protocol-Relative URLs</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes-apis-and-internal\">APIs and .internal</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes-301-caching\">301 Caching</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes-help-center-snafu\">Help Center SNAFU</a></li> \n  </ul> </li> \n <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#open-source\">Open Source</a></li> \n <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#next-steps\">Next Steps</a> \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#hsts-preloading\">HSTS Preloading</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#chat\">Chat</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#today\">Today</a></li> \n  </ul> </li> \n</ul> \n<h3 id=\"the-beginning\">The Beginning</h3> \n<p>We began thinking about deploying HTTPS on Stack Overflow <a href=\"https://nickcraver.com/blog/2013/04/23/stackoverflow-com-the-road-to-ssl/\">back in 2013</a>. So the obvious question: It’s 2017. <strong>What the hell took 4 years?</strong> The same 2 reasons that delay almost any IT project: dependencies and priorities. Let’s be honest, the information on Stack Overflow isn’t as valuable (to secure) as most other data. We’re not a bank, we’re not a hospital, we don’t handle credit card payments, and <a href=\"https://archive.org/details/stackexchange\">we even publish most of our database both by HTTP and via torrent once a quarter</a>. That means from a security standpoint, it’s just not as high of a priority as it is in other situations. We also had far more dependencies than most, a rather unique combination of some huge problem areas when deploying HTTPS. As you’ll see later, some of the domain problems are also permanent.</p> \n<p>The biggest areas that caused us problems were:</p> \n<ul> \n <li>User content (users can upload images or specify URLs)</li> \n <li>Ad networks (contracts and support)</li> \n <li>Hosting from a single data center (latency)</li> \n <li><a href=\"https://stackexchange.com/sites\"><strong>Hundreds</strong> of domains</a>, at multiple levels (certificates)</li> \n</ul> \n<p>Okay, so why <strong>do</strong> we want HTTPS on our websites? Well, the data isn’t the only thing that needs security. We have moderators, developers, and employees with various levels of access via the web. We want to secure their communications with the site. We want to secure every user’s browsing history. Some people live in fear every day knowing that someone may find out they secretly like monads. Google also <a href=\"https://webmasters.googleblog.com/2014/08/https-as-ranking-signal.html\">gives a boost to HTTPS websites</a> in ranking (though we have no clue how much).</p> \n<p>Oh, and <strong>performance</strong>. We love performance. I love performance. You love performance. My dog loves performance. Let’s have a performance hug. That was nice. Thank you. You smell nice.</p> \n<h3 id=\"quick-specs\">Quick Specs</h3> \n<p>Some people just want the specs, so quick Q&amp;A here (we love Q&amp;A!):</p> \n<ul> \n <li>Q: Which protocols do you support? \n  <ul> \n   <li>A: TLS 1.0, 1.1, 1.2 (Note: <a href=\"https://www.fastly.com/blog/phase-two-our-tls-10-and-11-deprecation-plan\">Fastly has a TLS 1.0 and 1.1 deprecation plan</a>). TLS 1.3 support is coming</li> \n  </ul> </li> \n <li>Q: Do you support SSL v2, v3? \n  <ul> \n   <li>A: No, these are <a href=\"http://disablessl3.com/\">broken, insecure protocols</a>. Everyone should disable them ASAP.</li> \n  </ul> </li> \n <li>Q: Which ciphers do you support? \n  <ul> \n   <li>A: At the CDN, we use <a href=\"https://www.ssllabs.com/ssltest/analyze.html?d=meta.stackexchange.com&amp;s=151.101.129.69#suitesHeading\">Fastly’s default suite</a></li> \n   <li>A: At our load balancer, we use <a href=\"https://wiki.mozilla.org/Security/Server_Side_TLS#Modern_compatibility\">Mozilla’s Modern compatibility suite</a></li> \n  </ul> </li> \n <li>Q: Does Fastly connect to the origin over HTTPS? \n  <ul> \n   <li>A: Yes, if the CDN request is HTTPS, the origin request is HTTPS.</li> \n  </ul> </li> \n <li>Q: Do you support forward secrecy? \n  <ul> \n   <li>A: Yes</li> \n  </ul> </li> \n <li>Q: Do you support <a href=\"https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security\">HSTS</a>? \n  <ul> \n   <li>A: Yes, we’re ramping it up across Q&amp;A sites now. Once done we’ll move it to the edge.</li> \n  </ul> </li> \n <li>Q: Do you support HPKP? \n  <ul> \n   <li>A: No, and we likely won’t.</li> \n  </ul> </li> \n <li>Q: Do you support SNI? \n  <ul> \n   <li>A: No, we have a combined wildcard certificate for HTTP/2 performance reasons (details below).</li> \n  </ul> </li> \n <li>Q: Where do you get certificates? \n  <ul> \n   <li>A: We use <a href=\"https://www.digicert.com/\">DigiCert</a>, they’ve been awesome.</li> \n  </ul> </li> \n <li>Q: Do you support IE 6? \n  <ul> \n   <li>A: This move finally kills it, completely. IE 6 does not support TLS (default - though 1.0 can be enabled), we do not support SSL. With 301 redirects in place, most IE6 users can no longer access Stack Overflow. When TLS 1.0 is removed, none can.</li> \n  </ul> </li> \n <li>Q: What load balancer do you use? \n  <ul> \n   <li>A: <a href=\"https://www.haproxy.org/\">HAProxy</a> (it uses <a href=\"https://www.openssl.org/\">OpenSSL</a> internally).</li> \n  </ul> </li> \n <li>Q: What’s the motivation for HTTPS? \n  <ul> \n   <li>A: People kept attacking our admin routes like <a href=\"https://stackoverflow.com/admin.php\">stackoverflow.com/admin.php</a>.</li> \n  </ul> </li> \n</ul> \n<h3 id=\"certificates\">Certificates</h3> \n<p>Let’s talk about certificates, because there’s a lot of misinformation out there. I’ve lost count of the number of people who say you just install a certificate and you’re ready to go on HTTPS. Take another look at the tiny size of your scroll bar and take a wild guess if I agree. We prefer <a href=\"https://en.wikipedia.org/wiki/Scientific_wild-ass_guess\">the SWAG method</a> for our guessing.</p> \n<p>The most common question we get: “Why not use <a href=\"https://letsencrypt.org/\">Let’s Encrypt</a>?”</p> \n<p>Answer: because they don’t work for us. Let’s Encrypt is doing a great thing. I hope they keep at it. If you’re on a single domain or only a few domains, they’re a pretty good option for a wide variety of scenarios. We are simply not in that position. Stack Exchange has <a href=\"https://stackexchange.com/sites\">hundreds of domains</a>. Let’s Encrypt <a href=\"https://letsencrypt.org/docs/faq/\">doesn’t offer wildcards</a>. These two things are at odds with each other. We’d have to get a certificate (or two) every time we deployed a new Q&amp;A site (or any other service). That greatly complicates deployment, and either a) drops non-SNI clients (around 2% of traffic these days) or b) requires far more IP space than we have.</p> \n<p>Another reason we want to control the certificate is we need to install the exact same certificates on both our local load balancers and our CDN/proxy provider. Unless we can do that, we can’t failover (away from a proxy) cleanly in all cases. Anyone that has the certificate pinned <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Public_Key_Pinning\">via HPKP</a> (HTTP Public Key Pinning) would fail validation. We’re evaluating whether we’ll deploy HPKP, but we’ve prepped as if we will later.</p> \n<p>I’ve gotten a lot of raised eyebrows at our main certificate having all of our primary domains + wildcards. Here’s what that looks like:</p> \n<p><a href=\"https://nickcraver.com/blog/content/HTTPS-MainCertificate.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/HTTPS-MainCertificate.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/HTTPS-MainCertificate.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/HTTPS-MainCertificate.png\" loading=\"lazy\" alt=\"Main Certificate\" /> \n  </picture></a></p> \n<p>Why do this? Well, to be fair, <a href=\"https://www.digicert.com/\">DigiCert</a> is the one who does this for us upon request. Why go through the pain of a manual certificate merge for every change? First, because we wanted to support as many people as possible. That includes clients that don’t support SNI (for example, Android 2.3 was a big thing when we started). But also because of HTTP/2 and reality. We’ll cover that in a minute.</p> \n<h4 id=\"certificates-child-metas-metastackexchangecom\">Certificates: Child Metas (meta.*.stackexchange.com)</h4> \n<p>One of the tenets of the Stack Exchange network is having a place to talk about each Q&amp;A site. We call it the <a href=\"https://stackoverflow.blog/2010/04/29/do-trilogy-sites-need-a-third-place/\">“second place”</a>. As an example, <code class=\"language-plaintext highlighter-rouge\">meta.gaming.stackexchange.com</code> exists to talk about <code class=\"language-plaintext highlighter-rouge\">gaming.stackexchange.com</code>. So why does that matter? Well, it doesn’t really. We only care about the domain here. It’s 4 levels deep.</p> \n<p>I’ve <a href=\"https://nickcraver.com/blog/2013/04/23/stackoverflow-com-the-road-to-ssl/\">covered this before</a>, but where did we end up? First the problem: <code class=\"language-plaintext highlighter-rouge\">*.stackexchange.com</code> <em>does</em> cover <code class=\"language-plaintext highlighter-rouge\">gaming.stackexchange.com</code> (and hundreds of other sites), but it <strong>does not</strong> cover <code class=\"language-plaintext highlighter-rouge\">meta.gaming.stackexchange.com</code>. <a href=\"https://tools.ietf.org/html/rfc6125#section-6.4.3\">RFC 6125 (Section 6.4.3)</a> states that:</p> \n<blockquote> \n <p>The client SHOULD NOT attempt to match a presented identifier in which the wildcard character comprises a label other than the left-most label (e.g., do not match <code class=\"language-plaintext highlighter-rouge\">bar.*.example.net</code>)</p> \n</blockquote> \n<p>That means we cannot have a wildcard of <code class=\"language-plaintext highlighter-rouge\">meta.*.stackexchange.com</code>. Well, shit. So what do we do?</p> \n<ul> \n <li>Option 1: Deploying <a href=\"https://www.digicert.com/subject-alternative-name.htm\">SAN certificates</a> \n  <ul> \n   <li>We’d need 3 (the limit is ~100 domains per), we’d need to dedicate 3 IPs, and we’d complicate new site launches (until the scheme changed, which it already has)</li> \n   <li>We’d have to pay for 3 custom certs for all time at the CDN/proxy</li> \n   <li>We’d have to have a DNS entry for every child meta under the <code class=\"language-plaintext highlighter-rouge\">meta.*</code> scheme \n    <ul> \n     <li>Due to the rules of DNS, we’d actually have to add a DNS entry for every single site, complicating site launches and maintenance.</li> \n    </ul> </li> \n  </ul> </li> \n <li>Option 2: Move all domains to <code class=\"language-plaintext highlighter-rouge\">*.meta.stackexchange.com</code>? \n  <ul> \n   <li>We’d have a painful move, but it’s 1-time and simplifies all maintenance and certificates</li> \n   <li>We’d have to build a global login system (<a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#global-login\">details here</a>)</li> \n   <li>This solution also creates a <code class=\"language-plaintext highlighter-rouge\">includeSubDomains</code> HSTS preloading problem (<a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#hsts-preloading\">details here</a>)</li> \n  </ul> </li> \n <li>Option 3: We’ve had a good run, shut ‘er down \n  <ul> \n   <li>This one is the easiest, but was not approved</li> \n  </ul> </li> \n</ul> \n<p>We <a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#global-login\">built a global login system</a> and later moved the child meta domains (with 301s), and they’re now at their new homes. For example, <a href=\"https://gaming.meta.stackexchange.com\">https://gaming.meta.stackexchange.com</a>. After doing this, we realized how much of a problem the HSTS preload list was going to be simply because those domains <em>ever</em> existed. I’ll cover that <a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#hsts-preloading\">near the end</a>, as it’s still in progress. Note that the problems here are mirrored on our journey for things like <code class=\"language-plaintext highlighter-rouge\">meta.pt.stackoverflow.com</code>, but were more limited in scale since only 4 non-English versions of Stack Overflow exist.</p> \n<p>Oh, and this created <em>another</em> problem in itself. By moving cookies to the top-level domain and relying on the subdomain inheritance of them, we now had to move domains. As an example, we use SendGrid to send email in our new system (rolling out now). The reason that it sends from <code class=\"language-plaintext highlighter-rouge\">stackoverflow.email</code> with links pointed at <code class=\"language-plaintext highlighter-rouge\">sg-links.stackoverflow.email</code> (a <a href=\"https://en.wikipedia.org/wiki/CNAME_record\">CNAME</a> pointed to them), is so that your browser doesn’t send any sensitive cookies. If it was <code class=\"language-plaintext highlighter-rouge\">sg-links.stackoverflow.com</code> (or anything beneath <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code>), your browser would send our cookies to them. This is a concrete example of new things, but there were also miscellaneous not-hosted-by-us services under our DNS. Each one of these subdomains had to be moved or retired to get out from under our authenticated domains…or else we’d be sending your cookies to not-our-servers. It’d be a shame to do all this work just to be leaking cookies to other servers at the end of it.</p> \n<p>We tried to work around this in one instance by proxying one of our Hubspot properties for a while, stripping the cookies on the way through. But unfortunately, Hubspot uses <a href=\"https://www.akamai.com/\">Akamai</a> which started treating our HAProxy instance as a bot and blocking it in oh so fun various ways on a weekly basis. It was fun, the first 3 times. So anyway, that <em>really</em> didn’t work out. It went so badly we’ll never do it again.</p> \n<p>Were you curious why we have the Stack Overflow Blog at <a href=\"https://stackoverflow.blog/\">https://stackoverflow.blog/</a>? Yep, security. It’s hosted on an external service so that the marketing team and others can iterate faster. To facilitate this, we needed it off the cookied domains.</p> \n<p>The above issues with meta subdomains also introduced related problems with <a href=\"https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security\">HSTS</a>, <a href=\"https://hstspreload.org/\">preloading</a>, and the <code class=\"language-plaintext highlighter-rouge\">includeSubDomains</code> directive. But we’ll see why that’s become a moot point later.</p> \n<h3 id=\"performance-http2\">Performance: HTTP/2</h3> \n<p>The conventional wisdom long ago was that HTTPS was slower. And it was. But times change. We’re not talking about HTTPS anymore. We’re talking about HTTPS with HTTP/2. While <a href=\"https://http2.github.io/faq/#does-http2-require-encryption\">HTTP/2 doesn’t require encryption</a>, <em>effectively</em> it does. This is because the major browsers require a secure connection to enable most of its features. You can argue specs and rules all day long, but browsers are the reality we all live in. I wish they would have just called it HTTPS/2 and saved everyone a lot of time. Dear browser makers, it’s not too late. Please, listen to reason, you’re our only hope!</p> \n<p>HTTP/2 has a lot of performance benefits, especially with pushing resources opportunistically to the user ahead of asking for them. I won’t write in detail about those benefits, <a href=\"https://hpbn.co/http2/\">Ilya Grigorik has done a fantastic job of that already</a>. As a quick overview, the largest optimizations (for us) include:</p> \n<ul> \n <li><a href=\"https://hpbn.co/http2/#request-and-response-multiplexing\">Request/Response Multiplexing</a></li> \n <li><a href=\"https://hpbn.co/http2/#server-push\">Server Push</a></li> \n <li><a href=\"https://hpbn.co/http2/#header-compression\">Header Compression</a></li> \n <li><a href=\"https://hpbn.co/http2/#stream-prioritization\">Stream Prioritization</a></li> \n <li><a href=\"https://hpbn.co/http2/#one-connection-per-origin\">Fewer Origin Connections</a></li> \n</ul> \n<p>Hey wait a minute, what about that silly certificate?</p> \n<p>A lesser-known feature of HTTP/2 is that <a href=\"https://hpbn.co/optimizing-application-delivery/#eliminate-domain-sharding\">you can push content not on the same domain</a>, as long as certain criteria are met:</p> \n<ol> \n <li>The origins resolve to the same server IP address.</li> \n <li>The origins are covered by the same TLS certificate (bingo!)</li> \n</ol> \n<p>So, let’s take a peek at our current DNS:</p> \n<div class=\"language-plaintext highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code>λ dig stackoverflow.com +noall +answer\n; &lt;&lt;&gt;&gt; DiG 9.10.2-P3 &lt;&lt;&gt;&gt; stackoverflow.com +noall +answer\n;; global options: +cmd\nstackoverflow.com.      201     IN      A       151.101.1.69\nstackoverflow.com.      201     IN      A       151.101.65.69\nstackoverflow.com.      201     IN      A       151.101.129.69\nstackoverflow.com.      201     IN      A       151.101.193.69\n\nλ dig cdn.sstatic.net +noall +answer\n; &lt;&lt;&gt;&gt; DiG 9.10.2-P3 &lt;&lt;&gt;&gt; cdn.sstatic.net +noall +answer\n;; global options: +cmd\ncdn.sstatic.net.        724     IN      A       151.101.193.69\ncdn.sstatic.net.        724     IN      A       151.101.1.69\ncdn.sstatic.net.        724     IN      A       151.101.65.69\ncdn.sstatic.net.        724     IN      A       151.101.129.69\n</code></pre> \n </div> \n</div> \n<p>Heyyyyyy, those IPs match, and they have the same certificate! This means that we can get all the wins of HTTP/2 server pushes <strong>without harming HTTP/1.1 users</strong>. HTTP/2 gets push and HTTP/1.1 gets <a href=\"https://blog.stackpath.com/glossary/domain-sharding/\">domain sharding</a> (via <code class=\"language-plaintext highlighter-rouge\">sstatic.net</code>). We haven’t deployed server push quite yet, but all of this is in preparation.</p> \n<p>So in regards to performance, HTTPS is only a means to an end. And I’m okay with that. I’m okay saying that our primary drive is performance, and security for the site is not. We want security, but security alone in our situation is not enough justification for the time investment needed to deploy HTTPS across our network. When you combine all the factors above though, we can justify the immense amount of time and effort required to get this done. In 2013, HTTP/2 wasn’t a big thing, but that changed as support increased and ultimately helped as a driver for us to invest time in HTTPS.</p> \n<p>It’s also worth noting that the HTTP/2 landscape changed quite a bit during our deployment. The web moved from <a href=\"https://en.wikipedia.org/wiki/SPDY\">SPDY</a> to <a href=\"https://en.wikipedia.org/wiki/HTTP/2\">HTTP/2</a> and <a href=\"https://tools.ietf.org/id/draft-agl-tls-nextprotoneg-03.html\">NPN</a> to <a href=\"https://en.wikipedia.org/wiki/Application-Layer_Protocol_Negotiation\">ALPN</a>. I won’t cover all that because we didn’t do anything there. We watched, and benefited, but the giants of the web were driving all of that. If you’re curious though, <a href=\"https://blog.cloudflare.com/introducing-http2/\">Cloudflare has a good write up of these moves</a>.</p> \n<h3 id=\"haproxy-serving-up-https\">HAProxy: Serving up HTTPS</h3> \n<p>We deployed initial HTTPS support in HAProxy back in 2013. Why <a href=\"https://www.haproxy.org/\">HAProxy</a>? Because we’re already using it and they added support back in 2013 (released as GA in 2014) <a href=\"https://www.haproxy.org/news.html\">with version 1.5</a>. We had, for a time, nginx in front of HAProxy (<a href=\"https://nickcraver.com/blog/2013/04/23/stackoverflow-com-the-road-to-ssl/\">as you can see in the last blog post</a>). But simpler is often better, and eliminating a lot of conntrack, deployment, and general complexity issues is usually a good idea.</p> \n<p>I won’t cover a lot of detail here because there’s simply not much to cover. HAProxy supports HTTPS natively via OpenSSL since 1.5 and the configuration is straightforward. Our configuration highlights are:</p> \n<ul> \n <li>Run on 4 processes \n  <ul> \n   <li>1 is dedicated to HTTP/front-end handling</li> \n   <li>2-4 are dedicated to HTTPS negotiation</li> \n  </ul> </li> \n <li>HTTPS front-ends are connected to HTTP backends via <a href=\"https://unix.stackexchange.com/a/206395/400\">an abstract named socket</a>. This reduces overhead tremendously.</li> \n <li>Each front-end or “tier” (we have 4: Primary, Secondary, Websockets, and dev) has corresponding :443 listeners.</li> \n <li>We append request headers (and strip ones you’d send - nice try) when forwarding to the web tier to indicate how a connection came in.</li> \n <li>We use the <a href=\"https://wiki.mozilla.org/Security/Server_Side_TLS#Modern_compatibility\">Modern compatibility cipher suite recommended by Mozilla</a>. Note: this is not the same suite our CDN runs.</li> \n</ul> \n<p>HAProxy was the relatively simple and first step of supporting a :443 endpoint with valid SSL certificates. In retrospect, it was only a tiny spec of the effort needed.</p> \n<p>Here’s a logical layout of what I described above…and we’ll cover that little cloud in front next:</p> \n<p><a href=\"https://nickcraver.com/blog/content/HTTPS-Layout.svg\"><img src=\"https://nickcraver.com/blog/content/HTTPS-Layout.svg\" alt=\"Logical Architecture\" /></a></p> \n<h3 id=\"cdnproxy-countering-latency-with-cloudflare--fastly\">CDN/Proxy: Countering Latency with Cloudflare &amp; Fastly</h3> \n<p>One of the things I’m most proud of at Stack Overflow is <a href=\"https://stackexchange.com/performance\">the efficiency</a> of <a href=\"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/\">our stack</a>. That’s awesome, right? Running a major website on a small set of servers from one data center? Nope. Not so much. Not this time. While it’s awesome to be efficient for some things, when it comes to latency it suddenly becomes a problem. We’ve never needed a lot of servers. We’ve never needed to expand to multiple locations (but yes, we have another for DR). This time, that’s a problem. We can’t (yet!) solve fundamental problems with latency, due to the speed of light. We’re told someone else is working on this, but there was a minor setback with tears in the fabric of space-time and losing the gerbils.</p> \n<p>When it comes to latency, let’s look at the numbers. It’s almost exactly 40,000km around the equator (worst case for speed of light round-trip). The <a href=\"https://en.wikipedia.org/wiki/Speed_of_light\">speed of light</a> is 299,792,458 meters/second <strong>in a vacuum</strong>. Unfortunately, a lot of people use this number, but most fiber isn’t in a vacuum. Realistically, most optical fiber is <a href=\"https://physics.stackexchange.com/q/80043/653\">30-31% slower</a>. So we’re looking at (40,075,000 m) / (299,792,458 m/s * .70) = 0.191 seconds, or 191ms for a round-trip in the worst case, right? Well…no, not really. That’s also assuming an optimal path, but going between two destinations on the internet is very rarely a straight line. There are routers, switches, buffers, processor queues, and all sorts of additional little delays in the way. They add up to measurable latency. Let’s not even talk about Mars, yet.</p> \n<p>So why does that matter to Stack Overflow? This is an area where the cloud wins. It’s very likely that the server you’re hitting with a cloud provider is relatively local. With us, it’s not. With a direct connection, the further you get away from our New York or Denver data centers (whichever one is active), the slower your experience gets. When it comes to HTTPS, there’s an <em>additional</em> round trip to negotiate the connection before any data is sent. That’s under the best of circumstances (though <a href=\"https://blog.cloudflare.com/introducing-0-rtt/\">that’s improving with TLS 1.3 and 0-RTT</a>). And <a href=\"https://twitter.com/igrigorik\">Ilya Grigorik</a> has <a href=\"https://istlsfastyet.com/\">a great summary here</a>.</p> \n<p>Enter <a href=\"https://www.cloudflare.com/\">Cloudflare</a> and <a href=\"https://www.fastly.com/\">Fastly</a>. HTTPS wasn’t a project deployed in a silo; as you read on, you’ll see that several other projects multiplex in along the way. In the case of a local-to-the-user HTTPS termination endpoint (to minimize that round trip duration), we were looking for a few main criteria:</p> \n<ul> \n <li>Local HTTPS termination</li> \n <li>DDoS protection</li> \n <li>CDN functionality</li> \n <li>Performance equivalent or better than direct-to-us</li> \n</ul> \n<h3 id=\"preparing-for-a-proxy-client-timings\">Preparing for a Proxy: Client Timings</h3> \n<p>Before moving to any proxy, testing for performance had to be in place. To do this, we set up a full pipeline of timings to get performance metrics from browsers. For years now, browsers have included performance timings accessible via JavaScript, <a href=\"https://www.w3.org/TR/navigation-timing/\">via <code class=\"language-plaintext highlighter-rouge\">window.performance</code></a>. Go ahead, open up the inspector and try it! We want to be very transparent about this, that’s why details have <a href=\"https://teststackoverflow.com/\">been available on teststackoverflow.com</a> since day 1. There’s no sensitive data transferred, only the URIs of resources <em>directly</em> loaded by the page and their timings. For each page load recorded, we get timings that look like this:</p> \n<p><a href=\"https://nickcraver.com/blog/content/HTTPS-Teststackoverflow.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/HTTPS-Teststackoverflow.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/HTTPS-Teststackoverflow.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/HTTPS-Teststackoverflow.png\" loading=\"lazy\" alt=\"teststackoverflow.com\" /> \n  </picture></a></p> \n<p>Currently we attempt to record performance timings from 5% of traffic. The process isn’t that complicated, but all the pieces had to be built:</p> \n<ol> \n <li>Transform the timings into JSON</li> \n <li>Upload the timings after a page load completes</li> \n <li>Relay those timings to our backend Traffic Processing Service (it has reports)</li> \n <li>Store those timings in a <a href=\"http://www.nikoport.com/columnstore/\">clustered columnstore</a> in SQL Server</li> \n <li>Relay aggregates of the timings to <a href=\"https://bosun.org/\">Bosun</a> (via <a href=\"https://github.com/bretcope/BosunReporter.NET\">BosunReporter.NET</a>)</li> \n</ol> \n<p>The end result is we now have a great real-time overview of <em>actual</em> user performance all over the world that we can readily view, alert on, and use for evaluating any changes. Here’s a view of timings coming in live:</p> \n<p><a href=\"https://nickcraver.com/blog/content/HTTPS-ClientTimings.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/HTTPS-ClientTimings.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/HTTPS-ClientTimings.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/HTTPS-ClientTimings.png\" loading=\"lazy\" alt=\"Client Timings Dashboard\" /> \n  </picture></a></p> \n<p>Luckily, we have enough sustained traffic to get useful data here. At this point, we have over 5 billion points (and growing) of data to help drive decisions. Here’s a quick overview of that data:</p> \n<p><a href=\"https://nickcraver.com/blog/content/HTTPS-ClientTimingsDatabase.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/HTTPS-ClientTimingsDatabase.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/HTTPS-ClientTimingsDatabase.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/HTTPS-ClientTimingsDatabase.png\" loading=\"lazy\" alt=\"Client Timings Database\" /> \n  </picture></a></p> \n<p>Okay, so now we have our baseline data. Time to test candidates for our CDN/Proxy setup.</p> \n<h3 id=\"cloudflare\">Cloudflare</h3> \n<p>We evaluated many CDN/DDoS proxy providers. We picked <a href=\"https://www.cloudflare.com/\">Cloudflare</a> based on their infrastructure, responsiveness, and the promise of <a href=\"https://www.cloudflare.com/website-optimization/railgun/\">Railgun</a>. So how can we do test what life <em>would</em> be like behind Cloudflare all over the world? How many servers would we need to set up to get enough data points? None!</p> \n<p>Stack Overflow has an excellent resource here: billions of hits a month. Remember those client timings we just talked about? We already have tens of millions of users hitting us every day, so why don’t we ask them? We can do just that, by embedding an <code class=\"language-plaintext highlighter-rouge\">&lt;iframe&gt;</code> in Stack Overflow pages. Cloudflare was already our <a href=\"https://cdn.sstatic.net/\">cdn.sstatic.net</a> host (our shared, cookieless static content domain) from earlier. But, this was done with <a href=\"https://en.wikipedia.org/wiki/CNAME_record\">a <code class=\"language-plaintext highlighter-rouge\">CNAME</code> DNS record</a>, we served the DNS which pointed at their DNS. To use Cloudflare as a proxy though, we needed them to serve our DNS. So first, we needed to test performance of their DNS.</p> \n<p>Practically speaking, to test performance we needed to delegate a second-level domain to them, not <code class=\"language-plaintext highlighter-rouge\">something.stackoverflow.com</code>, which would have different <a href=\"https://wiki.gandi.net/en/glossary/glue-record\">glue records</a> and sometimes isn’t handled the same way (causing 2 lookups). To clarify, <a href=\"https://en.wikipedia.org/wiki/Top-level_domain\">Top-Level Domains (TLDs)</a> are things like <code class=\"language-plaintext highlighter-rouge\">.com</code>, <code class=\"language-plaintext highlighter-rouge\">.net</code>, <code class=\"language-plaintext highlighter-rouge\">.org</code>, <code class=\"language-plaintext highlighter-rouge\">.dance</code>, <code class=\"language-plaintext highlighter-rouge\">.duck</code>, <code class=\"language-plaintext highlighter-rouge\">.fail</code>, <code class=\"language-plaintext highlighter-rouge\">.gripe</code>, <code class=\"language-plaintext highlighter-rouge\">.here</code>, <code class=\"language-plaintext highlighter-rouge\">.horse</code>, <code class=\"language-plaintext highlighter-rouge\">.ing</code>, <code class=\"language-plaintext highlighter-rouge\">.kim</code>, <code class=\"language-plaintext highlighter-rouge\">.lol</code>, <code class=\"language-plaintext highlighter-rouge\">.ninja</code>, <code class=\"language-plaintext highlighter-rouge\">.pink</code>, <code class=\"language-plaintext highlighter-rouge\">.red</code>, <code class=\"language-plaintext highlighter-rouge\">.vodka</code>. and <code class=\"language-plaintext highlighter-rouge\">.wtf</code>. Nope, <a href=\"https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains\">I’m not kidding</a> (and <a href=\"https://www.iana.org/domains/root/db\">here’s the full list</a>). <a href=\"https://en.wikipedia.org/wiki/Second-level_domain\">Second-Level Domains (SLDs)</a> are one level below, what most sites would be: <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code>, <code class=\"language-plaintext highlighter-rouge\">superuser.com</code>, etc. That’s what we need to test the behavior and performance of. Thus, <code class=\"language-plaintext highlighter-rouge\">teststackoverflow.com</code> was born. With this new domain, we could test DNS performance all over the world. By embedding the <code class=\"language-plaintext highlighter-rouge\">&lt;iframe&gt;</code> for a certain percentage of visitors (we turned it on and off for each test), we could easily get data from each DNS and hosting configuration.</p> \n<p>Note that it’s important to test for ~24hours at a minimum here. The behavior of the internet changes throughout the day as people are awake or asleep or streaming Netflix all over the world as it rolls through time zones. So to measure a single country, you really want a full day. Within weekdays, preferably (e.g. not half into a Saturday). Also be aware that shit happens. It happens all the time. The performance of the internet is not a stable thing, we’ve got the data to prove it.</p> \n<p>Our initial assumptions going into this was we’d lose some page load performance going through Cloudflare (an extra hop almost always adds latency), but we’d make it up with the increases in DNS performance. The DNS side of this paid off. Cloudflare had DNS servers far more local to the users than we do in a single data center. The performance there was far better. I hope that we can find the time to release this data soon. It’s just a lot to process (and host), and time isn’t something I have in ample supply right now.</p> \n<p>Then we began testing page load performance by proxying <code class=\"language-plaintext highlighter-rouge\">teststackoverflow.com</code> through Cloudflare, again in the <code class=\"language-plaintext highlighter-rouge\">&lt;iframe&gt;</code>. We saw the US and Canada slightly slower (due to the extra hop), but the rest of the world on par or better. This lined up with expectations overall, and we proceeded with a move behind Cloudflare’s network. A few DDoS attacks along the way sped up this migration a bit, but that’s another story. Why did we accept slightly slower performance in the US and Canada? Well at ~200-300ms page loads for most pages, that’s still pretty damn fast. But we don’t like to lose. We thought <a href=\"https://www.cloudflare.com/website-optimization/railgun/\">Railgun</a> would help us win that performance back.</p> \n<p>Once all the testing panned out, we needed to put the pieces in for DDoS protection. This involved installing additional, dedicated ISPs in our data center for the CDN/Proxy to connect to. After all, DDoS protection via a proxy isn’t very effective if you can just go around it. This meant we were serving off of 4 ISPs per data center now, with 2 sets of routers, all running <a href=\"https://en.wikipedia.org/wiki/Border_Gateway_Protocol\">BGP</a> with full tables. It also meant 2 new load balancers, dedicated to CDN/Proxy traffic.</p> \n<h4 id=\"cloudflare-railgun\">Cloudflare: Railgun</h4> \n<p>At the time, this setup also meant 2 more boxes just for <a href=\"https://www.cloudflare.com/website-optimization/railgun/\">Railgun</a>. The way Railgun works is by caching the last result of that URL in <a href=\"https://memcached.org/\">memcached</a> locally and on Cloudflare’s end. When Railgun is enabled, every page (under a size threshold) is cached on the way out. On the next request, if the entry was in Cloudflare’s edge cache and our cache (keyed by URL), we still ask the web server for it. But instead of sending the whole page back to Cloudflare, it only sends a diff. That diff is applied to their cache and served back to the client. By nature of the pipe, it also meant the <a href=\"https://en.wikipedia.org/wiki/Gzip\">gzip compression</a> for transmission moved from 9 web servers for Stack Overflow to the 1 active Railgun box…so this had to be a pretty CPU-beefy machine. I point this out because all of this had to be evaluated, purchased and deployed on our way.</p> \n<p>As an example, think about 2 users viewing a question. Take a picture of each browser. They’re <em>almost</em> the same page, so that’s a very small diff. It’s a huge optimization if we can send only that diff down most of the journey to the user.</p> \n<p>Overall, the goal here is to reduce the amount of data sent back in hopes of a performance win. And when it worked, that was indeed the case. Railgun also had another huge advantage: requests weren’t fresh connections. Another consequence of latency is the duration and speed of the ramp up of <a href=\"https://en.wikipedia.org/wiki/TCP_congestion_control#Slow_start\">TCP slow start</a>, part of the congestion control that keeps the Internet flowing. Railgun maintains a constant connection to Cloudflare edges and multiplexes user requests, all of them over a pre-primed connection not heavily delayed by slow start. The smaller diffs also lessened the need for ramp up overall.</p> \n<p>Unfortunately, we never got Railgun to work without issues in the long run. To my knowledge, we were (at the time) the largest deployment of the technology and we stressed it further than it has been pushed before. Though we tried to troubleshoot it for over a year, we ultimately gave up and moved on. It simply wasn’t saving us more than it was costing us in the end. It’s been several years now, though. If you’re evaluating Railgun, you should evaluate the current version, with <a href=\"https://www.cloudflare.com/docs/railgun/changelog.html\">the improvements they’ve made</a>, and decide for yourself.</p> \n<h3 id=\"fastly\">Fastly</h3> \n<p>Moving to <a href=\"https://www.fastly.com/\">Fastly</a> was relatively recent, but since we’re on the CDN/Proxy topic I’ll cover it now. The move itself wasn’t terribly interesting because most of the pieces needed for any proxy were done in the Cloudflare era above. But of course everyone will ask: why did we move? While Cloudflare was very appealing in many regards - mainly, many data centers, stable bandwidth pricing, and included DNS - it wasn’t the best fit for us anymore. We needed a few things that Fastly simply did to fit us better: more flexibility at the edge, faster change propagation, and the ability to fully automate configuration pushes. That’s not to say Cloudflare is bad, it was just no longer the best fit for Stack Overflow.</p> \n<p>Since actions speak louder: If I didn’t think highly of Cloudflare, my personal blog wouldn’t be behind them right now. Hi there! You’re reading it.</p> \n<p>The main feature of Fastly that was so compelling to us was <a href=\"https://en.wikipedia.org/wiki/Varnish_(software)\">Varnish</a> and the <a href=\"https://docs.fastly.com/guides/vcl/\">VCL</a>. This makes the edge highly configurable. So features that Cloudflare couldn’t readily implement (as they might affect <em>all</em> customers), we could do ourselves. This is simply a different architectural approach to how these two companies work, and the highly-configurable-in-code approach suits us very well. We also liked how open they were with details of infrastructure at conferences, in chats, etc.</p> \n<p>Here’s an example of where VCL comes in <em>very</em> handy. Recently we deployed .NET 4.6.2 which had a <a href=\"https://github.com/Microsoft/dotnet/issues/330\">very nasty bug</a> that set max-age on cache responses to over 2000 years. The quickest way to mitigate this for all of our services affected was to override that cache header as-needed at the edge. As I write this, the following VCL is active:</p> \n<div class=\"language-powershell highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nf\">sub</span><span class=\"w\"> </span><span class=\"nx\">vcl_fetch</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">beresp.http.Cache-Control</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n      </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">req.url.path</span><span class=\"w\"> </span><span class=\"nx\">~</span><span class=\"w\"> </span><span class=\"s2\">\"^/users/flair/\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n          </span><span class=\"nf\">set</span><span class=\"w\"> </span><span class=\"nx\">beresp.http.Cache-Control</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"public, max-age=180\"</span><span class=\"p\">;</span><span class=\"w\">\n      </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"kr\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n          </span><span class=\"nf\">set</span><span class=\"w\"> </span><span class=\"nx\">beresp.http.Cache-Control</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"private\"</span><span class=\"p\">;</span><span class=\"w\">\n      </span><span class=\"p\">}</span><span class=\"w\">\n  </span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre> \n </div> \n</div> \n<p>This allows us to cache user flair for 3 minutes (since it’s a decent volume of bytes), and bypass everything else. This is an easy-to-deploy global solution to workaround an urgent cache poisoning problem across all applications. We’re very, very happy with all the things we’re able to do at the edge now. Luckily we have <a href=\"https://twitter.com/alioth\">Jason Harvey</a> who picked up the VCL bits and wrote automated-pushed of our configs. We had to improve on existing libraries in Go here, so check out <a href=\"https://github.com/alienth/fastlyctl\">fastlyctl</a>, another open source bit to come out of this.</p> \n<p>Another important facet of Fastly (that Cloudflare also had, but we never utilized due to cost) is using your own certificate. As we covered earlier, we’re already using this in preparation for HTTP/2 pushes. But, Fastly doesn’t do something Cloudflare does: DNS. So we need to solve that now. Isn’t this dependency chain fun?</p> \n<h3 id=\"global-dns\">Global DNS</h3> \n<p>When moving from Cloudflare to Fastly, we had to evaluate and deploy new (to us) global DNS providers. That in itself in an entirely different post, <a href=\"http://blog.serverfault.com/2017/01/09/surviving-the-next-dns-attack/\">one that’s been written</a> by <a href=\"https://twitter.com/thefarseeker\">Mark Henderson</a>. Along the way, we were also controlling:</p> \n<ul> \n <li>Our own DNS servers (still up as a fall back)</li> \n <li>Name.com servers (for redirects not needing HTTPS)</li> \n <li>Cloudflare DNS</li> \n <li>Route 53 DNS</li> \n <li>Google DNS</li> \n <li>Azure DNS</li> \n <li>…and several others (for testing)</li> \n</ul> \n<p>This was a whole project in itself. We had to come up with means to do this efficiently, and so <a href=\"http://blog.serverfault.com/2017/04/11/introducing-dnscontrol-dns-as-code-has-arrived/\">DNSControl was born</a>. This is now an <a href=\"https://stackexchange.github.io/dnscontrol/\">open source project</a>, <a href=\"https://github.com/StackExchange/dnscontrol\">available on GitHub</a>, written in <a href=\"https://golang.org/\">Go</a>. In short: we push a change in the JavaScript config to git, and it’s deployed worldwide in under a minute. Here’s a sample config from one of our simpler-in-DNS sites, <a href=\"https://askubuntu.com/\">askubuntu.com</a>:</p> \n<div class=\"language-js highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nx\">D</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">askubuntu.com</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">REG_NAMECOM</span><span class=\"p\">,</span>\n    <span class=\"nx\">DnsProvider</span><span class=\"p\">(</span><span class=\"nx\">R53</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">),</span>\n    <span class=\"nx\">DnsProvider</span><span class=\"p\">(</span><span class=\"nx\">GOOGLECLOUD</span><span class=\"p\">,</span><span class=\"mi\">2</span><span class=\"p\">),</span>\n    <span class=\"nx\">SPF</span><span class=\"p\">,</span>\n    <span class=\"nx\">TXT</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">@</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"dl\">'</span><span class=\"s1\">google-site-verification=PgJFv7ljJQmUa7wupnJgoim3Lx22fbQzyhES7-Q9cv8</span><span class=\"dl\">'</span><span class=\"p\">),</span> <span class=\"c1\">// webmasters</span>\n    <span class=\"nx\">A</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">@</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">ADDRESS24</span><span class=\"p\">,</span> <span class=\"nx\">FASTLY_ON</span><span class=\"p\">),</span>\n    <span class=\"nx\">CNAME</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">www</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"dl\">'</span><span class=\"s1\">@</span><span class=\"dl\">'</span><span class=\"p\">),</span>\n    <span class=\"nx\">CNAME</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">chat</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"dl\">'</span><span class=\"s1\">chat.stackexchange.com.</span><span class=\"dl\">'</span><span class=\"p\">),</span>\n    <span class=\"nx\">A</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">meta</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">ADDRESS24</span><span class=\"p\">,</span> <span class=\"nx\">FASTLY_ON</span><span class=\"p\">),</span>\n<span class=\"nx\">END</span><span class=\"p\">)</span>\n</code></pre> \n </div> \n</div> \n<p>Okay great, how do you test that all of this is working? Client Timings! The <a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#preparing-for-a-proxy-client-timings\">ones we covered above</a> let us test all of this DNS deployment with real-world data, not simulations. But we also need to test that everything <em>just works</em>.</p> \n<h3 id=\"testing\">Testing</h3> \n<p>Client Timings in deploying the above was very helpful for testing performance. But it wasn’t good for testing configuration. After all, Client Timings is awesome for seeing the result, but most configuration missteps result in no page load, and therefore no timings at all. So we had to build <a href=\"https://godoc.org/github.com/StackExchange/httpunit\">httpUnit</a> (yes, the team figured out <a href=\"http://httpunit.sourceforge.net/\">the naming conflict</a> later…). This is now another <a href=\"https://github.com/StackExchange/httpunit\">open source project</a> written in Go. An example config for <code class=\"language-plaintext highlighter-rouge\">teststackoverflow.com</code>:</p> \n<div class=\"language-toml highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nn\">[[plan]]</span>\n  <span class=\"py\">label</span> <span class=\"p\">=</span> <span class=\"s\">\"teststackoverflow_com\"</span>\n  <span class=\"py\">url</span> <span class=\"p\">=</span> <span class=\"s\">\"http://teststackoverflow.com\"</span>\n  <span class=\"py\">ips</span> <span class=\"p\">=</span> <span class=\"nn\">[\"28i\"]</span>\n  <span class=\"py\">text</span> <span class=\"p\">=</span> <span class=\"s\">\"&lt;title&gt;Test Stack Overflow Domain&lt;/title&gt;\"</span>\n  <span class=\"py\">tags</span> <span class=\"p\">=</span> <span class=\"nn\">[\"so\"]</span>\n<span class=\"nn\">[[plan]]</span>\n  <span class=\"py\">label</span> <span class=\"p\">=</span> <span class=\"s\">\"tls_teststackoverflow_com\"</span>\n  <span class=\"py\">url</span> <span class=\"p\">=</span> <span class=\"s\">\"https://teststackoverflow.com\"</span>\n  <span class=\"py\">ips</span> <span class=\"p\">=</span> <span class=\"nn\">[\"28\"]</span>\n  <span class=\"py\">text</span> <span class=\"p\">=</span> <span class=\"s\">\"&lt;title&gt;Test Stack Overflow Domain&lt;/title&gt;\"</span>\n  <span class=\"py\">tags</span> <span class=\"p\">=</span> <span class=\"nn\">[\"so\"]</span>\n</code></pre> \n </div> \n</div> \n<p>It was important to test as we changed firewalls, certificates, bindings, redirects, etc. along the way. We needed to make sure every change was good before we activated it for users (by deploying it on our secondary load balancers first). httpUnit is what allowed us to do that and run an integration test suite to ensure we had no regressions.</p> \n<p>There’s another tool we developed internally (by our lovely <a href=\"https://twitter.com/yesthattom\">Tom Limoncelli</a>) for more easily managing <a href=\"https://en.wikipedia.org/wiki/Virtual_IP_address\">Virtual IP Address</a> groups on our load balancers. We test on the inactive load balancer via a secondary range, then move all traffic over, leaving the previous master in a known-good state. If anything goes wrong, we flip back. If everything goes right (yay!), we apply changes to that load balancer as well. This tool is called <code class=\"language-plaintext highlighter-rouge\">keepctl</code> (short for keepalived control) - look for this to be open sourced as soon as time allows.</p> \n<h3 id=\"preparing-the-applications\">Preparing the Applications</h3> \n<p>Almost all of the above has been just the infrastructure work. This is generally done by a team of <a href=\"http://stackoverflow.com/company/team#Engineering\">several other Site Reliability Engineers at Stack Overflow</a> and I getting things situated. There’s also so much more that needed doing inside the applications themselves. It’s a long list. I’d grab some coffee and a Snickers.</p> \n<p>One important thing to note here is that <a href=\"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/\">the architecture of Stack Overflow &amp; Stack Exchange</a> Q&amp;A sites is <a href=\"https://en.wikipedia.org/wiki/Multitenancy\">multi-tenant</a>. This means that if you hit <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code> or <code class=\"language-plaintext highlighter-rouge\">superuser.com</code> or <code class=\"language-plaintext highlighter-rouge\">bicycles.stackexchange.com</code>, you’re hitting the <em>exact</em> same thing. You’re hitting the <em>exact same <code class=\"language-plaintext highlighter-rouge\">w3wp.exe</code> process on the exact same server</em>. Based on <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host\">the <code class=\"language-plaintext highlighter-rouge\">Host</code> header</a> the browser sends, we change the context of the request. Several pieces of what follows will be clearer if you understand <code class=\"language-plaintext highlighter-rouge\">Current.Site</code> in our code is the site <em>of the request</em>. Things like <code class=\"language-plaintext highlighter-rouge\">Current.Site.Url()</code> and <code class=\"language-plaintext highlighter-rouge\">Current.Site.Paths.FaviconUrl</code> are all driven off this core concept.</p> \n<p>Another way to make this concept/setup clearer: we can run the entire Q&amp;A network off of a single process on a single server and you wouldn’t know it. We run a single process today on each of 9 servers purely for rolling builds and redundancy.</p> \n<h4 id=\"global-login\">Global Login</h4> \n<p>Quite a few of these projects seemed like good ideas on their own (and they were), but were part of a bigger HTTPS picture. Login was one of those projects. I’m covering it first, because it was rolled out much earlier than the other changes below.</p> \n<p>For the first 5-6 years Stack Overflow (and Stack Exchange) existed, you logged into a particular site. As an example, each of <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code>, <code class=\"language-plaintext highlighter-rouge\">stackexchange.com</code>, and <code class=\"language-plaintext highlighter-rouge\">gaming.stackexchange.com</code> had their own per-site cookies. Of note here: <code class=\"language-plaintext highlighter-rouge\">meta.gaming.stackexchange.com</code>’s login depended on the cookie from <code class=\"language-plaintext highlighter-rouge\">gaming.stackexchange.com</code> flowing to the subdomain. These are the “meta” sites we talked about with certificates earlier. Their logins were tied together, you always logged in through the parent. This didn’t really matter much technically, but from a user experience standpoint it sucked. You had to login to each site. <a href=\"https://stackoverflow.blog/2010/09/11/global-network-auto-login/\">We “fixed” that</a> with “global auth”, which was an <code class=\"language-plaintext highlighter-rouge\">&lt;iframe&gt;</code> in the page that logged everyone in through <code class=\"language-plaintext highlighter-rouge\">stackauth.com</code> if they were logged in elsewhere. Or it tried to. The experience was decent, but a popup bar telling you to click to reload and be logged in wasn’t really awesome. We could do better. Oh and ask <a href=\"https://twitter.com/kevinmontrose\">Kevin Montrose</a> about mobile Safari private mode. I dare you.</p> \n<p>Enter “Universal Login”. Why the name “Universal”? Because global was taken. We’re simple people. Luckily, cookies are also pretty simple. A cookie present on a parent domain (e.g. <code class=\"language-plaintext highlighter-rouge\">stackexchange.com</code>) will be sent by your browser to all subdomains (e.g. <code class=\"language-plaintext highlighter-rouge\">gaming.stackexchange.com</code>). When you zoom out from our network, we have only a handful of second-level domains:</p> \n<ul> \n <li><a href=\"https://askubuntu.com/\">askubuntu.com</a></li> \n <li><a href=\"https://mathoverflow.net/\">mathoverflow.net</a></li> \n <li><a href=\"https://serverfault.com/\">serverfault.com</a></li> \n <li><a href=\"https://stackapps.com/\">stackapps.com</a></li> \n <li><a href=\"https://stackexchange.com/\">stackexchange.com</a></li> \n <li><a href=\"https://stackoverflow.com/\">stackoverflow.com</a></li> \n <li><a href=\"https://superuser.com/\">superuser.com</a></li> \n</ul> \n<p>Yes, we have other domains that redirect to these, like <a href=\"http://askdifferent.com\">askdifferent.com</a>. But they’re only redirects and don’t have cookies or logged-in users.</p> \n<p>There’s a lot of backend work that I’m glossing over here (props to <a href=\"https://twitter.com/superdalgas\">Geoff Dalgas</a> and <a href=\"https://twitter.com/aalear\">Adam Lear</a> especially), but the general gist is that when you login, we set a cookie on these domains. We do this via third-party cookies and <a href=\"https://en.wikipedia.org/wiki/Cryptographic_nonce\">nonces</a>. When you login to any of the above domains, 6 cookies are issued via <code class=\"language-plaintext highlighter-rouge\">&lt;img&gt;</code> tags on the destination page for the other domains, effectively logging you in. This doesn’t work <em>everywhere</em> (in particular, mobile safari is quirky), but it’s a vast improvement over previous.</p> \n<p>The client code isn’t complicated, here’s what it looks like:</p> \n<div class=\"language-js highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nx\">$</span><span class=\"p\">.</span><span class=\"nx\">post</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">/users/login/universal/request</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">,</span> <span class=\"nx\">text</span><span class=\"p\">,</span> <span class=\"nx\">req</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">$</span><span class=\"p\">.</span><span class=\"nx\">each</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">arrayId</span><span class=\"p\">,</span> <span class=\"nx\">group</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"kd\">var</span> <span class=\"nx\">url</span> <span class=\"o\">=</span> <span class=\"dl\">'</span><span class=\"s1\">//</span><span class=\"dl\">'</span> <span class=\"o\">+</span> <span class=\"nx\">group</span><span class=\"p\">.</span><span class=\"nx\">Host</span> <span class=\"o\">+</span> <span class=\"dl\">'</span><span class=\"s1\">/users/login/universal.gif?authToken=</span><span class=\"dl\">'</span> <span class=\"o\">+</span> \n          <span class=\"nb\">encodeURIComponent</span><span class=\"p\">(</span><span class=\"nx\">group</span><span class=\"p\">.</span><span class=\"nx\">Token</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"dl\">'</span><span class=\"s1\">&amp;nonce=</span><span class=\"dl\">'</span> <span class=\"o\">+</span> <span class=\"nb\">encodeURIComponent</span><span class=\"p\">(</span><span class=\"nx\">group</span><span class=\"p\">.</span><span class=\"nx\">Nonce</span><span class=\"p\">);</span>\n        <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"kd\">function</span> <span class=\"p\">()</span> <span class=\"p\">{</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">#footer</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">&lt;img style=\"display:none\" src=\"</span><span class=\"dl\">'</span> <span class=\"o\">+</span> <span class=\"nx\">url</span> <span class=\"o\">+</span> <span class=\"dl\">'</span><span class=\"s1\">\"&gt;&lt;/img&gt;</span><span class=\"dl\">'</span><span class=\"p\">);</span> <span class=\"p\">});</span>\n    <span class=\"p\">});</span>\n<span class=\"p\">},</span> <span class=\"dl\">'</span><span class=\"s1\">json</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n</code></pre> \n </div> \n</div> \n<p>…but to do this, we have to move to Account-level authentication (it was previously user level), change how cookies are viewed, change how child-meta login works, and also provide integration for these new bits to other applications. For example, Careers (now Talent and Jobs) is a different codebase. We needed to make those applications view the cookies and call into the Q&amp;A application via an API to get the account. We deploy this via a NuGet library to minimize repeated code. Bottom line: you login once and you are logged into all domains. No messages, no page reloads.</p> \n<p>For the technical side, we now don’t have to worry about where the <code class=\"language-plaintext highlighter-rouge\">*.*.stackexchange.com</code> domains are. As long as they’re under <code class=\"language-plaintext highlighter-rouge\">stackexchange.com</code>, we’re good. While on the surface this had nothing to do with HTTPS, it allowed us to move things like <code class=\"language-plaintext highlighter-rouge\">meta.gaming.stackexchange.com</code> to <code class=\"language-plaintext highlighter-rouge\">gaming.meta.stackexchange.com</code> without any interruptions to users. It’s one giant, really ugly puzzle.</p> \n<h4 id=\"local-https-development\">Local HTTPS Development</h4> \n<p>To make any kind of progress here, local environments need to match dev and production as much as possible. Luckily, we’re on IIS which makes this fairly straightforward to do. There’s a tool we use to setup developer environments called “dev local setup” because, again, we’re simple people. It installs tooling (Visual Studio, git, SSMS, etc.), services (SQL Server, Redis, Elasticsearch), repositories, databases, websites, and a few other bits. We had the basic tooling setup, we just needed to add SSL/TLS certs. An abbreviated setup for Core looks like this:</p> \n<div class=\"language-powershell highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nf\">Websites</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">@(</span><span class=\"w\">\n    </span><span class=\"err\">@{</span><span class=\"w\">\n        </span><span class=\"err\">Directory</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"s2\">\"StackOverflow\"</span><span class=\"err\">;</span><span class=\"w\">\n        </span><span class=\"err\">Site</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"s2\">\"local.mse.com\"</span><span class=\"err\">;</span><span class=\"w\">\n        </span><span class=\"err\">Aliases</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"s2\">\"discuss.local.area51.lse.com\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"local.sstatic.net\"</span><span class=\"err\">;</span><span class=\"w\">\n        </span><span class=\"err\">Databases</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sites.Database\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Local.StackExchange.Meta\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Local.Area51\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Local.Area51.Meta\"</span><span class=\"err\">;</span><span class=\"w\">\n        </span><span class=\"err\">Certificate</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"bp\">$true</span><span class=\"err\">;</span><span class=\"w\">\n    </span><span class=\"err\">}</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"err\">@{</span><span class=\"w\">\n        </span><span class=\"err\">Directory</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"s2\">\"StackExchange.Website\"</span><span class=\"err\">;</span><span class=\"w\">\n        </span><span class=\"err\">Site</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"s2\">\"local.lse.com\"</span><span class=\"err\">;</span><span class=\"w\">\n        </span><span class=\"err\">Databases</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sites.Database\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Local.StackExchange\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Local.StackExchange.Meta\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Local.Area51.Meta\"</span><span class=\"err\">;</span><span class=\"w\">\n        </span><span class=\"err\">Certificate</span><span class=\"w\"> </span><span class=\"err\">=</span><span class=\"w\"> </span><span class=\"bp\">$true</span><span class=\"err\">;</span><span class=\"w\">\n    </span><span class=\"err\">}</span><span class=\"w\">\n</span><span class=\"p\">)</span><span class=\"w\">\n</span></code></pre> \n </div> \n</div> \n<p>And the code that uses this <a href=\"https://gist.github.com/NickCraver/6b5e75c153d60d0df5b0970d52412d4e\">I’ve put in a gist here: <code class=\"language-plaintext highlighter-rouge\">Register-Websites.psm1</code></a>. We setup our websites via host headers (adding those in aliases), give them certificates if directed (hmmm, we should default this to <code class=\"language-plaintext highlighter-rouge\">$true</code> now…), and grant those AppPool accounts access to the databases. Okay, so now we’re set to develop against <code class=\"language-plaintext highlighter-rouge\">https://</code> locally. Yes, I know - we really should open source this setup, but we have to strip out some specific-to-us bits in a fork somehow. One day.</p> \n<p><strong>Why is this important?</strong> Before this, we loaded static content from <code class=\"language-plaintext highlighter-rouge\">/content</code>, not from another domain. This was convenient, but also hid issues like <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS\">Cross-Origin Requests (or CORS)</a>. What may load just fine on the same domain on the same protocol may readily fail in dev and production. <a href=\"https://blog.codinghorror.com/the-works-on-my-machine-certification-program/\">“It works on my machine.”</a></p> \n<p>By having a CDN and app domains setup with the same protocols and layout we have in production, we find and fix many more issues before they leave a developer’s machine. For example, did you know that when going from an <code class=\"language-plaintext highlighter-rouge\">https://</code> page to an <code class=\"language-plaintext highlighter-rouge\">http://</code> one, <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec15.html#sec15.1.3\">the browser does not send the referer</a>? It’s a security issue, there could be sensitive bits in the URL that would be sent over <span title=\"We saw this was a typo and opted to leave it.\">paintext</span> in the referer header.</p> \n<p>“That’s bullshit Nick, we get Google referers!” Well, yes. You do. But because they <em>explicitly opt into it</em>. If you look at the Google search page, you’ll find this <code class=\"language-plaintext highlighter-rouge\">&lt;meta&gt;</code> directive:</p> \n<div class=\"language-html highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;meta</span> <span class=\"na\">content=</span><span class=\"s\">\"origin\"</span> <span class=\"na\">id=</span><span class=\"s\">\"mref\"</span> <span class=\"na\">name=</span><span class=\"s\">\"referrer\"</span><span class=\"nt\">&gt;</span>\n</code></pre> \n </div> \n</div> \n<p>…and that’s why you get it from them.</p> \n<p>Okay, we’re setup to build some stuff, where do we go from here?</p> \n<h3 id=\"mixed-content-from-you\">Mixed Content: From You</h3> \n<p>This one has a simple label with a lot of implications for a site with user-submitted content. What kind of mixed content problems had we accumulated over the years? Unfortunately, quite a few. Here’s the list of user-submitted content we had to tackle:</p> \n<ul> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> images in <a href=\"https://stackoverflow.com/questions\">questions</a>, answers, <a href=\"https://stackoverflow.com/tags\">tags</a>, wikis, etc. (all post types)</li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> avatars</li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> avatars in chat (which appear on the site in the sidebar)</li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> images in “about me” sections of profiles</li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> images in <a href=\"https://stackoverflow.com/help\">help center articles</a></li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> YouTube videos (some sites have this enabled, like <a href=\"https://gaming.stackexchange.com/\">gaming.stackexchange.com</a>)</li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> images in <a href=\"https://stackoverflow.com/help/privileges\">privilege descriptions</a></li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> images in <a href=\"http://stackoverflow.com/users/story/13249\">developer stories</a></li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> images in <a href=\"https://stackoverflow.com/jobs\">job descriptions</a></li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> images in <a href=\"https://stackoverflow.com/jobs/companies\">company pages</a></li> \n <li><code class=\"language-plaintext highlighter-rouge\">http://</code> sources in <a href=\"https://meta.stackoverflow.com/q/269753/13249\">JavaScript snippets</a>.</li> \n</ul> \n<p>Each of these had specific problems attached, I’ll stick to the interesting bits here. Note: each of the solutions I’m talking about has to be scaled to run across hundreds of sites and databases given our architecture.</p> \n<p>In each of the above cases (except snippets), there was a common first step to eliminating mixed content. You need to eliminate <em>new</em> mixed content. Otherwise, all cleanups continue indefinitely. Plug the hole, then drain the ship. To that end, <a href=\"https://meta.stackexchange.com/q/291947/135201\">we started enforcing only <code class=\"language-plaintext highlighter-rouge\">https://</code>-only image embeds across the network</a>. Once that was done and holes were plugged, we could get to work cleaning up.</p> \n<p>For images in questions, answers, and other post types we had to do a lot of analysis and see what path to take. First, we tackled the known 90%+ case: <code class=\"language-plaintext highlighter-rouge\">stack.imgur.com</code>. Stack Overflow has its own hosted instance of Imgur since before my time. When you upload an image with our editor, it goes there. The vast majority of posts take this approach, and they added proper HTTPS support for us years ago. This was a straight-forward find and replace re-bake (what we call re-processing post markdown) across the board.</p> \n<p>Then, we analyzed all the remaining image paths via our <a href=\"https://www.elastic.co/\">Elasticsearch</a> index of all content. And by we, I mean <a href=\"https://twitter.com/m0sa\">Samo</a>. He put in a ton of work on mixed-content throughout this. After seeing that many of the most repetitive domains actually supported HTTPS, we decided to:</p> \n<ol> \n <li>Try each <code class=\"language-plaintext highlighter-rouge\">&lt;img&gt;</code> source on <code class=\"language-plaintext highlighter-rouge\">https://</code> instead. If that worked, replace the link in the post.</li> \n <li>If the source didn’t support <code class=\"language-plaintext highlighter-rouge\">https://</code>, convert it to a link.</li> \n</ol> \n<p>But of course, that didn’t <em>actually</em> just work. It turns out the regex to match URLs in posts was broken for years and no one noticed…so we fixed that and re-indexed first. Oops.</p> \n<p>We’ve been asked: “why not just proxy it?” Well, that’s a legally and ethically gray area for much of our content. For example, we have photographers on <a href=\"https://photo.stackexchange.com/\">photo.stackexchange.com</a> that explicitly do not use Imgur to retain all rights. Totally understandable. If we start proxying and caching <em>the full image</em>, that gets legally tricky at best really quick. It turns out that out of millions of image embeds on the network, only a few thousand both didn’t support <code class=\"language-plaintext highlighter-rouge\">https://</code> and weren’t already 404s anyway. So, we elected to not build a complicated proxy setup. The percentages (far less than 1%) just didn’t come anywhere close to justifying it.</p> \n<p>We did <em>research</em> building a proxy though. What would it cost? How much storage would we need? Do we have enough bandwidth? We found estimates to all these questions, with some having various answers. For example, do we use Fastly site shield, or take the bandwidth brunt over the ISP pipes? Which option is faster? Which option is cheaper? Which option scales? Really, that’s another blog post all by itself, but if you have specific questions ask them in comments and I’ll try to answer.</p> \n<p>Luckily, along the way <a href=\"https://twitter.com/balpha\">balpha</a> had revamped YouTube embeds to fix a few things with HTML5. The rebake forced <code class=\"language-plaintext highlighter-rouge\">https://</code> for all as a side effect, yay! All done.</p> \n<p>The rest of the content areas were the same story: kill new mixed-content coming in, and replace what’s there. This required changes in the following code areas:</p> \n<ul> \n <li>Posts</li> \n <li>Profiles</li> \n <li>Dev Stories</li> \n <li>Help Center</li> \n <li>Jobs/Talent</li> \n <li>Company Pages</li> \n</ul> \n<p>Disclaimer: JavaScript snippets remains unsolved. It’s not so easy because:</p> \n<ol> \n <li>The resource you want may not be available over <code class=\"language-plaintext highlighter-rouge\">https://</code> (e.g. a library)</li> \n <li>Due it being JavaScript, you could just construct any URL you want. This is basically impossible to check for. \n  <ul> \n   <li>If you have a clever way to do this, <strong>please tell us</strong>. We’re stuck on usability vs. security on that one.</li> \n  </ul> </li> \n</ol> \n<h3 id=\"mixed-content-from-us\">Mixed Content: From Us</h3> \n<p>Problems don’t stop at user-submitted content. We have a fair bit of <code class=\"language-plaintext highlighter-rouge\">http://</code> baggage as well. While the moves of these things aren’t particularly interesting, in the interest of “what took so long?” they’re at least worth enumerating:</p> \n<ul> \n <li>Ad Server (Calculon)</li> \n <li>Ad Server (Adzerk)</li> \n <li>Tag Sponsorships</li> \n <li>JavaScript assumptions</li> \n <li>Area 51 (the whole damn thing really - it’s an ancient codebase)</li> \n <li>Analytics trackers (Quantcast, GA)</li> \n <li>Per-site JavaScript includes (community plugins)</li> \n <li>Everything under <code class=\"language-plaintext highlighter-rouge\">/jobs</code> on Stack Overflow (which is actually a proxy, surprise!)</li> \n <li>User flair</li> \n <li>…and almost anywhere else <code class=\"language-plaintext highlighter-rouge\">http://</code> appears in code</li> \n</ul> \n<p>JavaScript and links were a bit painful, so I’ll cover those in a little detail.</p> \n<p>JavaScript is an area some people forget, but of course it’s a thing. We had several assumptions about <code class=\"language-plaintext highlighter-rouge\">http://</code> in our JavaScript where we only passed a host down. There were also many baked-in assumptions about <code class=\"language-plaintext highlighter-rouge\">meta.</code> being the prefix for meta sites. So many. Oh so many. Send help. But they’re gone now, and the server now renders the fully qualified site roots in our options object at the top of the page. It looks something like this (abbreviated):</p> \n<div class=\"language-js highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nx\">StackExchange</span><span class=\"p\">.</span><span class=\"nx\">init</span><span class=\"p\">({</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">locale</span><span class=\"dl\">\"</span><span class=\"p\">:</span><span class=\"dl\">\"</span><span class=\"s2\">en</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">stackAuthUrl</span><span class=\"dl\">\"</span><span class=\"p\">:</span><span class=\"dl\">\"</span><span class=\"s2\">https://stackauth.com</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">site</span><span class=\"dl\">\"</span><span class=\"p\">:{</span>\n    <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span><span class=\"dl\">\"</span><span class=\"s2\">Stack Overflow</span><span class=\"dl\">\"</span>\n    <span class=\"dl\">\"</span><span class=\"s2\">childUrl</span><span class=\"dl\">\"</span><span class=\"p\">:</span><span class=\"dl\">\"</span><span class=\"s2\">https://meta.stackoverflow.com</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n    <span class=\"dl\">\"</span><span class=\"s2\">protocol</span><span class=\"dl\">\"</span><span class=\"p\">:</span><span class=\"dl\">\"</span><span class=\"s2\">http</span><span class=\"dl\">\"</span>\n  <span class=\"p\">},</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">user</span><span class=\"dl\">\"</span><span class=\"p\">:{</span>\n    <span class=\"dl\">\"</span><span class=\"s2\">gravatar</span><span class=\"dl\">\"</span><span class=\"p\">:</span><span class=\"dl\">\"</span><span class=\"s2\">&lt;div class=</span><span class=\"se\">\\\"</span><span class=\"s2\">gravatar-wrapper-32</span><span class=\"se\">\\\"</span><span class=\"s2\">&gt;&lt;img src=</span><span class=\"se\">\\\"</span><span class=\"s2\">https://i.stack.imgur.com/nGCYr.jpg</span><span class=\"se\">\\\"</span><span class=\"s2\">&gt;&lt;/div&gt;</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n    <span class=\"dl\">\"</span><span class=\"s2\">profileUrl</span><span class=\"dl\">\"</span><span class=\"p\">:</span><span class=\"dl\">\"</span><span class=\"s2\">https://stackoverflow.com/users/13249/nick-craver</span><span class=\"dl\">\"</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">});</span>\n</code></pre> \n </div> \n</div> \n<p>We had so many static links over the years in our code. For example, in the header, in the footer, in the help section…just all over the place. For each of these, the solution wasn’t that complicated: change them to use <code class=\"language-plaintext highlighter-rouge\">&lt;site&gt;.Url(\"/path\")</code>. Finding and killing these was a little fun because you can’t just search for <code class=\"language-plaintext highlighter-rouge\">\"http://\"</code>. Thank you <em>so much</em> W3C for gems like this:</p> \n<div class=\"language-xml highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"nt\">&lt;svg</span> <span class=\"na\">xmlns=</span><span class=\"s\">\"http://www.w3.org/2000/svg\"</span><span class=\"err\">...</span>\n</code></pre> \n </div> \n</div> \n<p>Yep, those are identifiers. You can’t change them. This is why I want Visual Studio to add an “exclude file types” option to the find dialog. Are you listening Visual Studio??? VS Code added it a while ago. I’m not above bribery.</p> \n<p>Okay so this isn’t really fun, it’s hunt and kill for over a thousand links in our code (including code comments, license links, etc.) But, that’s life. It had to be done. By converting them to be method calls to <code class=\"language-plaintext highlighter-rouge\">.Url()</code>, we made the links dynamically switch to HTTPS when the site was ready. For example, we couldn’t switch <code class=\"language-plaintext highlighter-rouge\">meta.*.stackexchange.com</code> sites over until they moved. The password to our data center is pickles. I didn’t think anyone would read this far and it seemed like a good place to store it. After they moved, <code class=\"language-plaintext highlighter-rouge\">.Url()</code> would keep working, and enabling <code class=\"language-plaintext highlighter-rouge\">.Url()</code> rendering https-by-default would also keep working. It changed a static thing to a dynamic thing and appropriately hooked up all of our feature flags.</p> \n<p>Oh and another important thing: it made dev and local environments work correctly, rather than always linking to production. This was pretty painful and boring, but a worthwhile set of changes. And yes, this <code class=\"language-plaintext highlighter-rouge\">.Url()</code> code includes canonicals, so Google sees that pages should be HTTPS as soon as users do.</p> \n<p>Once a site is moved to HTTPS (by enabling a feature flag), we then crawled the network to update the links to it. This is to both correct “Google juice” as we call it, and to prevent users eating a 301.</p> \n<h3 id=\"redirects-301s\">Redirects (301s)</h3> \n<p>When you move a site from HTTP, there are 2 critical things you need to do for Google:</p> \n<ul> \n <li>Update the canonical links, e.g. <code class=\"language-plaintext highlighter-rouge\">&lt;link rel=\"canonical\" href=\"https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454\" /&gt;</code></li> \n <li>301 the <code class=\"language-plaintext highlighter-rouge\">http://</code> link to the <code class=\"language-plaintext highlighter-rouge\">https://</code> version</li> \n</ul> \n<p>This isn’t complicated, it isn’t grand, but it’s very, <em>very</em> important. Stack Overflow gets most of its traffic from Google search results, so it’s imperative we don’t adversely affect that. I’d literally be out of a job if we lost traffic, it’s our livelihood. Remember those <code class=\"language-plaintext highlighter-rouge\">.internal</code> API calls? Yeah, we can’t just redirect <em>everything</em> either. So there’s a bit of logic into what gets redirected (e.g. we don’t redirect <code class=\"language-plaintext highlighter-rouge\">POST</code> requests during the transition…browsers don’t handle that well), but it’s fairly straightforward. Here’s the actual code:</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">static</span> <span class=\"k\">void</span> <span class=\"nf\">PerformHttpsRedirects</span><span class=\"p\">()</span>\n<span class=\"p\">{</span>\n    <span class=\"kt\">var</span> <span class=\"n\">https</span> <span class=\"p\">=</span> <span class=\"n\">Settings</span><span class=\"p\">.</span><span class=\"n\">HTTPS</span><span class=\"p\">;</span>\n    <span class=\"c1\">// If we're on HTTPS, never redirect back</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">Request</span><span class=\"p\">.</span><span class=\"n\">IsSecureConnection</span><span class=\"p\">)</span> <span class=\"k\">return</span><span class=\"p\">;</span>\n\n    <span class=\"c1\">// Not HTTPS-by-default? Abort.</span>\n    <span class=\"k\">if</span> <span class=\"p\">(!</span><span class=\"n\">https</span><span class=\"p\">.</span><span class=\"n\">IsDefault</span><span class=\"p\">)</span> <span class=\"k\">return</span><span class=\"p\">;</span>\n    <span class=\"c1\">// Not supposed to redirect anyone yet? Abort.</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">https</span><span class=\"p\">.</span><span class=\"n\">RedirectFor</span> <span class=\"p\">==</span> <span class=\"n\">SiteSettings</span><span class=\"p\">.</span><span class=\"n\">RedirectAudience</span><span class=\"p\">.</span><span class=\"n\">NoOne</span><span class=\"p\">)</span> <span class=\"k\">return</span><span class=\"p\">;</span>\n    <span class=\"c1\">// Don't redirect .internal or any other direct connection</span>\n    <span class=\"c1\">// ...as this would break direct HOSTS to webserver as well</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nf\">RequestIPIsInternal</span><span class=\"p\">())</span> <span class=\"k\">return</span><span class=\"p\">;</span>\n\n    <span class=\"c1\">// Only redirect GET/HEAD during the transition - we'll 301 and HSTS everything in Fastly later</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"kt\">string</span><span class=\"p\">.</span><span class=\"nf\">Equals</span><span class=\"p\">(</span><span class=\"n\">Request</span><span class=\"p\">.</span><span class=\"n\">HttpMethod</span><span class=\"p\">,</span> <span class=\"s\">\"GET\"</span><span class=\"p\">,</span> <span class=\"n\">StringComparison</span><span class=\"p\">.</span><span class=\"n\">InvariantCultureIgnoreCase</span><span class=\"p\">)</span>\n        <span class=\"p\">||</span> <span class=\"kt\">string</span><span class=\"p\">.</span><span class=\"nf\">Equals</span><span class=\"p\">(</span><span class=\"n\">Request</span><span class=\"p\">.</span><span class=\"n\">HttpMethod</span><span class=\"p\">,</span> <span class=\"s\">\"HEAD\"</span><span class=\"p\">,</span> <span class=\"n\">StringComparison</span><span class=\"p\">.</span><span class=\"n\">InvariantCultureIgnoreCase</span><span class=\"p\">))</span>\n    <span class=\"p\">{</span>\n        <span class=\"c1\">// Only redirect if we're redirecting everyone, or a crawler (if we're a crawler)</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">https</span><span class=\"p\">.</span><span class=\"n\">RedirectFor</span> <span class=\"p\">==</span> <span class=\"n\">SiteSettings</span><span class=\"p\">.</span><span class=\"n\">RedirectAudience</span><span class=\"p\">.</span><span class=\"n\">Everyone</span>\n            <span class=\"p\">||</span> <span class=\"p\">(</span><span class=\"n\">https</span><span class=\"p\">.</span><span class=\"n\">RedirectFor</span> <span class=\"p\">==</span> <span class=\"n\">SiteSettings</span><span class=\"p\">.</span><span class=\"n\">RedirectAudience</span><span class=\"p\">.</span><span class=\"n\">Crawlers</span> <span class=\"p\">&amp;&amp;</span> <span class=\"n\">Current</span><span class=\"p\">.</span><span class=\"n\">IsSearchEngine</span><span class=\"p\">))</span>\n        <span class=\"p\">{</span>\n            <span class=\"kt\">var</span> <span class=\"n\">resp</span> <span class=\"p\">=</span> <span class=\"n\">Context</span><span class=\"p\">.</span><span class=\"n\">InnerHttpContext</span><span class=\"p\">.</span><span class=\"n\">Response</span><span class=\"p\">;</span>\n            <span class=\"c1\">// 301 when we're really sure (302 is the default)</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">https</span><span class=\"p\">.</span><span class=\"n\">RedirectVia301</span><span class=\"p\">)</span>\n            <span class=\"p\">{</span>\n                <span class=\"n\">resp</span><span class=\"p\">.</span><span class=\"nf\">RedirectPermanent</span><span class=\"p\">(</span><span class=\"n\">Site</span><span class=\"p\">.</span><span class=\"nf\">Url</span><span class=\"p\">(</span><span class=\"n\">Request</span><span class=\"p\">.</span><span class=\"n\">Url</span><span class=\"p\">.</span><span class=\"n\">PathAndQuery</span><span class=\"p\">),</span> <span class=\"k\">false</span><span class=\"p\">);</span>\n            <span class=\"p\">}</span>\n            <span class=\"k\">else</span>\n            <span class=\"p\">{</span>\n                <span class=\"n\">resp</span><span class=\"p\">.</span><span class=\"nf\">Redirect</span><span class=\"p\">(</span><span class=\"n\">Site</span><span class=\"p\">.</span><span class=\"nf\">Url</span><span class=\"p\">(</span><span class=\"n\">Request</span><span class=\"p\">.</span><span class=\"n\">Url</span><span class=\"p\">.</span><span class=\"n\">PathAndQuery</span><span class=\"p\">),</span> <span class=\"k\">false</span><span class=\"p\">);</span>\n            <span class=\"p\">}</span>\n            <span class=\"n\">Context</span><span class=\"p\">.</span><span class=\"n\">InnerHttpContext</span><span class=\"p\">.</span><span class=\"n\">ApplicationInstance</span><span class=\"p\">.</span><span class=\"nf\">CompleteRequest</span><span class=\"p\">();</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre> \n </div> \n</div> \n<p>Note that we don’t start with a 301 (there’s a <code class=\"language-plaintext highlighter-rouge\">.RedirectVia301</code> setting for this), because you <em>really</em> want to test these things carefully before doing anything permanent. We’ll talk about <a href=\"https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security\">HSTS</a> and permanent consequences <a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#hsts-preloading\">a bit later</a>.</p> \n<h3 id=\"websockets\">Websockets</h3> \n<p>This one’s a quick mention. Websockets was not hard, it was the easiest thing we did…in some ways. We use websockets for real-time updates to users like reputation changes, inbox notifications, new questions being asked, new answers added, etc. This means that basically for every page open to Stack Overflow, we have a corresponding websocket connection to our load balancer.</p> \n<p>So what’s the change? Pretty simple: install a certificate, listen on <code class=\"language-plaintext highlighter-rouge\">:443</code>, and use <code class=\"language-plaintext highlighter-rouge\">wss://qa.sockets.stackexchange.com</code> instead of the <code class=\"language-plaintext highlighter-rouge\">ws://</code> (insecure) version. The latter of that was done above in prep for everything (we decided on a specific certificate here, but nothing special). The <code class=\"language-plaintext highlighter-rouge\">ws://</code> to <code class=\"language-plaintext highlighter-rouge\">wss://</code> change was simply a configuration one. During the transition we had <code class=\"language-plaintext highlighter-rouge\">ws://</code> with <code class=\"language-plaintext highlighter-rouge\">wss://</code> as a fallback, but this has since become <em>only</em> <code class=\"language-plaintext highlighter-rouge\">wss://</code>. The reasons to go with secure websockets in general are 2-fold:</p> \n<ol> \n <li>It’s a mixed content warning on <code class=\"language-plaintext highlighter-rouge\">https://</code> if you don’t.</li> \n <li>It supports more users, due to many old proxies not handling websockets well. With encrypted traffic, most pass it along without screwing it up. This is especially true for mobile users.</li> \n</ol> \n<p>The big question here was: “can we handle the load?” Our network handles quite a few concurrent websockets; as I write this we have over 600,000 <strong>concurrent</strong> connections open. Here’s a view of our HAProxy dashboard in <a href=\"https://github.com/opserver/Opserver\">Opserver</a>:</p> \n<p><a href=\"https://nickcraver.com/blog/content/HTTPS-Websockets.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/HTTPS-Websockets.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/HTTPS-Websockets.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/HTTPS-Websockets.png\" loading=\"lazy\" alt=\"HAProxy Websockets\" /> \n  </picture></a></p> \n<p>That’s a lot of connections on a) the terminators, b) the abstract named socket, and c) the frontend. It’s also much more load in HAProxy itself, due to enabling <a href=\"https://tools.ietf.org/html/rfc5077\">TLS session resumption</a>. To enable a user to reconnect faster the next time, the first negotiation results in a token a user can send back the next time. If we have enough memory and the timeout hasn’t passed, we’ll resume that session instead of negotiating a new session every time. This saves CPU and improves performance for users, but it has a cost in memory. This cost varies by key size (2048, 4096 bits? more?). We’re currently at 4,096 bit keys. With about 600,000 websockets open at any given time (the majority of our memory usage), we’re still sitting at only 19GB of RAM utilized on our 64GB load balancers. Of this, about 12GB is being utilized by HAProxy, and most of that is the TLS session cache. So…it’s not too bad, and <em>if we had to buy RAM</em>, it’d still be one of the cheapest things about this move.</p> \n<p><a href=\"https://nickcraver.com/blog/content/HTTPS-WebsocketMemory.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/HTTPS-WebsocketMemory.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/HTTPS-WebsocketMemory.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/HTTPS-WebsocketMemory.png\" loading=\"lazy\" alt=\"HAProxy Websocket Memory\" /> \n  </picture></a></p> \n<h3 id=\"unknowns\">Unknowns</h3> \n<p>I guess now’s a good time to cover the unknowns (gambles really) we took on with this move. There are a few things we couldn’t <em>really</em> know until we tested out an actual move:</p> \n<ul> \n <li>How Google Analytics traffic appeared (Do we lose referers?)</li> \n <li>How Google Webmasters transitions worked (Do the 301s work? The canonicals? The sitemaps? How fast?)</li> \n <li>How Google search analytics worked (do we see search analytics in <code class=\"language-plaintext highlighter-rouge\">https://</code>?)</li> \n <li>Will we fall in search result rankings? (scariest of all)</li> \n</ul> \n<p>There’s a lot of advice out there of people who have converted to <code class=\"language-plaintext highlighter-rouge\">https://</code>, but we’re not the usual use case. We’re not a site. We’re a network of sites across many domains. We have very little insight into how Google treats our network. Does it know <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code> and <code class=\"language-plaintext highlighter-rouge\">superuser.com</code> are related? Who knows. And we’re not holding our breath for Google to give us any insight.</p> \n<p>So, we test. In our <a href=\"https://meta.stackexchange.com/q/292058/135201\">network-wide rollout</a>, we tested a few domains first:</p> \n<ul> \n <li><a href=\"https://meta.stackexchange.com/\">meta.stackexchange.com</a></li> \n <li><a href=\"https://security.stackexchange.com/\">security.stackexchange.com</a></li> \n <li><a href=\"https://superuser.com/\">superuser.com</a></li> \n</ul> \n<p>These were chosen super carefully after a detailed review in a 3-minute meeting between Samo and I. Meta because it’s our main feedback site (that <a href=\"https://meta.stackexchange.com/q/292058/135201\">the announcement</a> is also on). Security because they have experts who may notice problems other sites don’t, especially in the HTTPS space. And last, Super User. We needed to test the search impact of our content. While meta and security are smaller and have relatively smaller traffic levels, Super User gets significantly more traffic. More importantly, it gets this traffic <em>from Google</em>, organically.</p> \n<p>The reason for a long delay between Super User and the rest of the network is we were watching and assessing the search impact. As far as we can tell: there was barely any. The amount of week-to-week change in searches, results, clicks, and positions is well within the normal up/down noise. Our company <em>depends</em> on this traffic. This was incredibly important to be damn sure about. Luckily, we were concerned for little reason and could continue rolling out.</p> \n<h3 id=\"mistakes\">Mistakes</h3> \n<p>Writing this post isn’t a very decent exercise if I didn’t also cover our screw-ups along the way. Failure is always an option. We have the experience to prove it. Let’s cover a few things we did and ended up regretting along the way.</p> \n<h4 id=\"mistakes-protocol-relative-urls\">Mistakes: Protocol-Relative URLs</h4> \n<p>When you have a URL to a resource, typically you see something like <code class=\"language-plaintext highlighter-rouge\">http://example.com</code> or <code class=\"language-plaintext highlighter-rouge\">https://example.com</code>, this includes paths for images, etc. Another option you can use is <code class=\"language-plaintext highlighter-rouge\">//example.com</code>. These are called <a href=\"https://en.wikipedia.org/wiki/Wikipedia:Protocol-relative_URL\">protocol-relative URLs</a>. We used these early on for images, JavaScript, CSS, etc. (that we served, not user-submitted content). Years later, we found out this was a bad idea, at least for us. The way protocol-relative links work is they are relative <em>to the page</em>. When you’re on <code class=\"language-plaintext highlighter-rouge\">http://stackoverflow.com</code>, <code class=\"language-plaintext highlighter-rouge\">//example.com</code> is the same as <code class=\"language-plaintext highlighter-rouge\">http://example.com</code>, and on <code class=\"language-plaintext highlighter-rouge\">https://stackoverflow.com</code>, it’s the same as <code class=\"language-plaintext highlighter-rouge\">https://example.com</code>. So what’s the problem?</p> \n<p>Well, URLs to images aren’t only used in pages, they’re also used in places like email, our API, and mobile applications. This bit us once when I normalized the pathing structure and used the same image paths everywhere. While the change drastically reduced code duplication and simplified many things, the result was protocol-relative URLs in email. Most email clients (appropriately) don’t render such images. Because they don’t know which protocol. Email is neither <code class=\"language-plaintext highlighter-rouge\">http://</code> nor <code class=\"language-plaintext highlighter-rouge\">https://</code>. You may just be viewing it in a web browser and it <em>might</em> have worked.</p> \n<p>So what do we do? Well, we switched everything everywhere to <code class=\"language-plaintext highlighter-rouge\">https://</code>. I unified all of our pathing code down to 2 variables: the root of the CDN, and the folder for the particular site. For example Stack Overflow’s stylesheet resides at: <a href=\"https://cdn.sstatic.net/Sites/stackoverflow/all.css\"><code class=\"language-plaintext highlighter-rouge\">https://cdn.sstatic.net/Sites/stackoverflow/all.css</code></a> (but with a cache breaker!). Locally, it’s <code class=\"language-plaintext highlighter-rouge\">https://local.sstatic.net/Sites/stackoverflow/all.css</code>. You can see the similarity. By calculating all routes, life is simpler. By enforcing <code class=\"language-plaintext highlighter-rouge\">https://</code>, people are getting the benefits of HTTP/2 even before the site itself switches over, since static content was already prepared. All <code class=\"language-plaintext highlighter-rouge\">https://</code> also meant we could use <strong>one</strong> property for a URL in web, email, mobile, and API. The unification also meant we have a consistent place to handle all pathing - this means cache breakers are built in <em>everywhere</em>, while still being simpler.</p> \n<p>Note: when you’re cache breaking resources like we do, for example: <code class=\"language-plaintext highlighter-rouge\">https://cdn.sstatic.net/Sites/stackoverflow/all.css?v=070eac3e8cf4</code>, please don’t do it with a build number. Our cache breakers are a <a href=\"https://en.wikipedia.org/wiki/Checksum\">checksum</a> of the file, which means you only download a new copy <em>when it actually changes</em>. Doing a build number may be slightly simpler, but it’s likely quite literally costing you money and performance at the same time.</p> \n<p>Okay, all of that’s cool - so why the hell didn’t we just do this from the start? Because HTTPS, at the time, was a performance penalty. Users would have suffered slower load times on <code class=\"language-plaintext highlighter-rouge\">http://</code> pages. For an idea of scale: we served up 4 billion requests on <code class=\"language-plaintext highlighter-rouge\">sstatic.net</code> last month, totaling 94TB. That would be a lot of collective latency back when HTTPS was slower. Now that the tables have turned on performance with HTTP/2 and our CDN/proxy setup, it’s a net win for most users as well as being simpler. Yay!</p> \n<h4 id=\"mistakes-apis-and-internal\">Mistakes: APIs and .internal</h4> \n<p>So what did we find when we got the proxies up and testing? We forgot something critical. I forgot something critical. We use HTTP for a truckload of internal APIs. Oh, right. <em>Dammit</em>. While these continued to work, they got slower, more complicated, and more brittle at the same time.</p> \n<p>Let’s say an internal API hits <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com/some-internal-route</code>. Previously, the hops there were:</p> \n<ul> \n <li>Origin app</li> \n <li>Gateway/Firewall (exiting to public IP space)</li> \n <li>Local load balancer</li> \n <li>Destination web server</li> \n</ul> \n<p>This was because <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code> used to resolve <em>to us</em>. The IP it went to was our load balancer. In a proxy scenario, in order for users to hit the nearest hop to them, they’re hitting a different IP and destination. The IP their DNS resolves to is the CDN/Proxy (Fastly) now. Well, crap. That means our path to the same place is now:</p> \n<ul> \n <li>Origin app</li> \n <li>Gateway/Firewall (exiting to public IP space)</li> \n <li>Our external router</li> \n <li>ISP (multiple hops)</li> \n <li>Proxy (Cloudflare/Fastly)</li> \n <li>ISPs (proxy path to us)</li> \n <li>Our external router</li> \n <li>Local load balancer</li> \n <li>Destination web server</li> \n</ul> \n<p>Okay…that seems worse. To make an application call from A to B, we have a drastic increase in dependencies that aren’t necessary and kill performance at the same time. I’m not saying our proxy is slow, but compared to a sub 1ms connection inside the data center…well yeah, it’s slow.</p> \n<p>A lot of internal discussion ensued about the simplest way to solve this problem. We could have made requests like <code class=\"language-plaintext highlighter-rouge\">internal.stackoverflow.com</code>, but this would require substantial app changes to how the sites work (and potentially create conflicts later). It would also have created an external leak of DNS for internal-only addresses (and created wildcard inheritance issues). We could have made <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code> resolve different internally (this is known as <a href=\"https://en.wikipedia.org/wiki/Split-horizon_DNS\">split-horizon DNS</a>), but that’s both harder to debug and creates other issues like multi-datacenter “who-wins?” scenarios.</p> \n<p>Ultimately, we ended up with a <code class=\"language-plaintext highlighter-rouge\">.internal</code> suffix to all domains we had external DNS for. For example, inside our network <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com.internal</code> resolves to an internal subnet on the back (DMZ) side of our load balancer. We did this for several reasons:</p> \n<ul> \n <li>We can override and contain a top-level domain on our internal DNS servers (Active Directory)</li> \n <li>We can strip the <code class=\"language-plaintext highlighter-rouge\">.internal</code> from the <code class=\"language-plaintext highlighter-rouge\">Host</code> header as it passes through HAProxy back to a web application (the application side isn’t even aware)</li> \n <li>If we need internal-to-DMZ SSL, we can do so with a very similar wildcard combination.</li> \n <li>Client API code is simple (if in this domain list, add <code class=\"language-plaintext highlighter-rouge\">.internal</code>)</li> \n</ul> \n<p>The client API code is done via a NuGet package/library called <code class=\"language-plaintext highlighter-rouge\">StackExchange.Network</code> mostly written by <a href=\"https://twitter.com/marcgravell\">Marc Gravell</a>. We simply call it in a static way with every URL we’re about to hit (so only in a few places, our utility fetch methods). It returns the “internalized” URL, if there is one, or returns it untouched. This means any changes to logic here can be quickly deployed to all applications with a simple NuGet update. The call is simple enough:</p> \n<div class=\"language-c# highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"n\">uri</span> <span class=\"p\">=</span> <span class=\"nf\">SubstituteInternalUrl</span><span class=\"p\">(</span><span class=\"n\">uri</span><span class=\"p\">);</span>\n</code></pre> \n </div> \n</div> \n<p>Here’s a concrete illustration for <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code> DNS behavior:</p> \n<ul> \n <li>Fastly: 151.101.193.69, 151.101.129.69, 151.101.65.69, 151.101.1.69</li> \n <li>Direct (public routers): 198.252.206.16</li> \n <li>Internal: 10.7.3.16</li> \n</ul> \n<p>Remember <a href=\"https://github.com/StackExchange/dnscontrol\">dnscontrol</a> we mentioned earlier? That keeps all of this in sync. Thanks to the JavaScript config/definitions, we can easily share all and simplify code. We match the last octet of all IPs (in all subnets, in all data centers), so with a few variables all the DNS entries both in AD and externally are aligned. This also means our HAProxy config is simpler as well, it boils down to this:</p> \n<div class=\"language-ruby highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"n\">stacklb</span><span class=\"o\">::</span><span class=\"n\">external</span><span class=\"o\">::</span><span class=\"n\">frontend_normal</span> <span class=\"p\">{</span> <span class=\"s1\">'t1_http-in'</span><span class=\"p\">:</span>\n  <span class=\"n\">section_name</span>    <span class=\"o\">=&gt;</span> <span class=\"s1\">'http-in'</span><span class=\"p\">,</span>\n  <span class=\"n\">maxconn</span>         <span class=\"o\">=&gt;</span> <span class=\"vg\">$t1_http_in_maxconn</span><span class=\"p\">,</span>\n  <span class=\"n\">inputs</span>          <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"s2\">\"${external_ip_base}.16:80\"</span>  <span class=\"o\">=&gt;</span> <span class=\"p\">[</span> <span class=\"s1\">'name stackexchange'</span> <span class=\"p\">],</span>\n    <span class=\"s2\">\"${external_ip_base}.17:80\"</span>  <span class=\"o\">=&gt;</span> <span class=\"p\">[</span> <span class=\"s1\">'name careers'</span> <span class=\"p\">],</span>\n    <span class=\"s2\">\"${external_ip_base}.18:80\"</span>  <span class=\"o\">=&gt;</span> <span class=\"p\">[</span> <span class=\"s1\">'name openid'</span> <span class=\"p\">],</span>\n    <span class=\"s2\">\"${external_ip_base}.24:80\"</span>  <span class=\"o\">=&gt;</span> <span class=\"p\">[</span> <span class=\"s1\">'name misc'</span> <span class=\"p\">],</span>\n</code></pre> \n </div> \n</div> \n<p>Overall, the API path is now faster and more reliable than before:</p> \n<ul> \n <li>Origin app</li> \n <li>Local load balancer (DMZ side)</li> \n <li>Destination web server</li> \n</ul> \n<p>A dozen problems solved, several hundred more to go.</p> \n<h4 id=\"mistakes-301-caching\">Mistakes: 301 Caching</h4> \n<p>Something we didn’t realize and should have tested is that when we started 301ing traffic from <code class=\"language-plaintext highlighter-rouge\">http://</code> to <code class=\"language-plaintext highlighter-rouge\">https://</code> for enabled sites, Fastly was caching the response. In Fastly, the <a href=\"https://docs.fastly.com/guides/vcl/manipulating-the-cache-key\">default cache key</a> doesn’t take the protocol into account. I personally disagree with this behavior, since by default enabling 301 redirects at the origin will result in infinite redirects. The problem happens with this series of events:</p> \n<ol> \n <li>A user visits a page on <code class=\"language-plaintext highlighter-rouge\">http://</code></li> \n <li>They get redirected via a 301 to <code class=\"language-plaintext highlighter-rouge\">https://</code></li> \n <li>Fastly caches that redirect</li> \n <li>Any user (including the one in #1 above) visits the same page on <code class=\"language-plaintext highlighter-rouge\">https://</code></li> \n <li>Fastly serves the 301 to <code class=\"language-plaintext highlighter-rouge\">https://</code>, even though you’re already on it</li> \n</ol> \n<p>And that’s how we get an infinite redirect. To fix this, we turned off 301s, purged Fastly cache, and investigated. After fixing it via a hash change, we worked with Fastly support <a href=\"https://docs.fastly.com/guides/vcl/manipulating-the-cache-key#purging-adjustments-when-making-additions-to-cache-keys\">which recommended adding <code class=\"language-plaintext highlighter-rouge\">Fastly-SSL</code> to the vary instead</a>, like this:</p> \n<div class=\"language-lua highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code> <span class=\"n\">sub</span> <span class=\"n\">vcl_fetch</span> <span class=\"p\">{</span>\n   <span class=\"n\">set</span> <span class=\"n\">beresp</span><span class=\"p\">.</span><span class=\"n\">http</span><span class=\"p\">.</span><span class=\"n\">Vary</span> <span class=\"o\">=</span> <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">beresp</span><span class=\"p\">.</span><span class=\"n\">http</span><span class=\"p\">.</span><span class=\"n\">Vary</span><span class=\"p\">,</span> <span class=\"n\">beresp</span><span class=\"p\">.</span><span class=\"n\">http</span><span class=\"p\">.</span><span class=\"n\">Vary</span> <span class=\"s2\">\",\"</span><span class=\"p\">,</span> <span class=\"s2\">\"\"</span><span class=\"p\">)</span> <span class=\"s2\">\"Fastly-SSL\"</span><span class=\"p\">;</span>\n</code></pre> \n </div> \n</div> \n<p>In my opinion, this should be the default behavior.</p> \n<h4 id=\"mistakes-help-center-snafu\">Mistakes: Help Center SNAFU</h4> \n<p>Remember those help posts we had to fix? Help posts are mostly per-language with few being per-site, so it makes sense for them to be shared. To not duplicate a ton of code and storage structure for just this, we do them a little differently. We store the actual Post object (same as a question or answer) in <code class=\"language-plaintext highlighter-rouge\">meta.stackexchange.com</code>, or whatever specific site the post is for. We store the resulting <code class=\"language-plaintext highlighter-rouge\">HelpPost</code> in our central <code class=\"language-plaintext highlighter-rouge\">Sites</code> database, which is just the baked HTML. In terms of mixed-content, we fixed the posts in the individual sites <em>already</em>, because they were the same posts are other things. Sweet! That was easy!</p> \n<p>After the original posts were fixed, we simply had to backfill the rebaked HTML into the Sites table. And that’s where I left off a critical bit of code. The backfill looked at <em>the current site</em> (the ones the backfill was invoked on) rather than the site the original post came from. As an example, this resulted in a <code class=\"language-plaintext highlighter-rouge\">HelpPost</code> from post 12345 on <code class=\"language-plaintext highlighter-rouge\">meta.stackechange.com</code> being replaced with whatever was in post 12345 on <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code>. Sometimes it was an answer, sometimes a question, sometimes a tag wiki. This resulted in some <a href=\"https://meta.stackoverflow.com/q/345280/13249\">very interesting help articles across the network</a>. Here are <a href=\"https://meta.stackoverflow.com/a/345282/13249\">some of the gems created</a>.</p> \n<p>At least the commit to fix my mistake was simple enough:</p> \n<p><a href=\"https://nickcraver.com/blog/content/HTTPS-HelpCommit.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/HTTPS-HelpCommit.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/HTTPS-HelpCommit.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/HTTPS-HelpCommit.png\" loading=\"lazy\" alt=\"Me being a dumbass\" /> \n  </picture></a></p> \n<p>…and re-running the backfill fixed it all. Still, that was some very public “fun”. Sorry about that.</p> \n<h3 id=\"open-source\">Open Source</h3> \n<p>Here are quick links to all the projects that resulted or improved from our HTTPS deployment. Hopefully these save the world some time:</p> \n<ul> \n <li><a href=\"https://github.com/StackExchange/blackbox\">BlackBox</a> (Safely store secrets in source control) by <a href=\"https://twitter.com/yesthattom\">Tom Limoncelli</a></li> \n <li><a href=\"https://github.com/StackExchange/capnproto-net\">capnproto-net</a> (UNSUPPORTED - <a href=\"https://capnproto.org/\">Cap’n Proto</a> for .NET) by <a href=\"https://twitter.com/marcgravell\">Marc Gravell</a></li> \n <li><a href=\"https://github.com/StackExchange/dnscontrol\">DNSControl</a> (Controlling multiple DNS providers) by <a href=\"https://twitter.com/captncraig\">Craig Peterson</a> and <a href=\"https://twitter.com/yesthattom\">Tom Limoncelli</a></li> \n <li><a href=\"https://github.com/StackExchange/httpunit\">httpUnit</a> (Integration tests for websites) by <a href=\"https://twitter.com/mjibson\">Matt Jibson</a> and <a href=\"https://twitter.com/yesthattom\">Tom Limoncelli</a></li> \n <li><a href=\"https://github.com/opserver/Opserver\">Opserver</a> (with support for Cloudflare DNS) by <a href=\"https://twitter.com/Nick_Craver\">Nick Craver</a></li> \n <li><a href=\"https://github.com/alienth/fastlyctl\">fastlyctl</a> (Fastly API calls from Go) by <a href=\"https://twitter.com/alioth\">Jason Harvey</a></li> \n <li><a href=\"https://github.com/alienth/fastly-ratelimit\">fastly-ratelimit</a> (Rate limiting based on Fastly syslog traffic) by <a href=\"https://twitter.com/alioth/\">Jason Harvey</a></li> \n</ul> \n<h3 id=\"next-steps\">Next Steps</h3> \n<p>We’re not done. There’s quite a bit left to do.</p> \n<ul> \n <li>We need to fix mixed content on our chat domains like <a href=\"https://chat.stackoverflow.com/\">chat.stackoverflow.com</a> (from user embedded images, etc.)</li> \n <li>We need to join (if we can) <a href=\"https://hstspreload.org/\">the Chrome HSTS preload list</a> on all domains where possible.</li> \n <li>We need to evaluate <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Public_Key_Pinning\">HPKP</a> and if we want to deploy it (it’s pretty dangerous - currently leaning heavily towards “no”)</li> \n <li>We need to move chat to <code class=\"language-plaintext highlighter-rouge\">https://</code></li> \n <li>We need to migrate all cookies over to secure-only</li> \n <li>We’re awaiting HAProxy 1.8 (ETA is around September) which is slated to support HTTP/2</li> \n <li>We need to utilize HTTP/2 pushes (I’m discussing this with Fastly in June - they don’t support cross-domain pushes yet)</li> \n <li>We need to move the <code class=\"language-plaintext highlighter-rouge\">https://</code> 301 out to the CDN/Proxy for performance (it was necessary to do it per-site as we rolled out)</li> \n</ul> \n<h4 id=\"hsts-preloading\">HSTS Preloading</h4> \n<p><a href=\"https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security\">HSTS</a> stands for “HTTP Strict Transport Security”. OWASP has a great little write-up <a href=\"https://www.owasp.org/index.php/HTTP_Strict_Transport_Security_Cheat_Sheet\">here</a>. It’s a fairly simple concept:</p> \n<ul> \n <li>When you visit an <code class=\"language-plaintext highlighter-rouge\">https://</code> page, we send you a header like this: <code class=\"language-plaintext highlighter-rouge\">Strict-Transport-Security: max-age=31536000</code></li> \n <li>For that duration (in seconds), your browser only visits that domain over <code class=\"language-plaintext highlighter-rouge\">https://</code></li> \n</ul> \n<p>Even if you click a link that’s <code class=\"language-plaintext highlighter-rouge\">http://</code>, your browser goes <em>directly</em> to <code class=\"language-plaintext highlighter-rouge\">https://</code>. It never goes through the <code class=\"language-plaintext highlighter-rouge\">http://</code> redirect that’s likely also set up, it goes right for SSL/TLS. This prevents people intercepting the <code class=\"language-plaintext highlighter-rouge\">http://</code> (insecure) request and hijacking it. As an example, it could redirect you to <code class=\"language-plaintext highlighter-rouge\">https://stack&lt;LooksLikeAnOButIsReallyCrazyUnicode&gt;verflow.com</code>, for which they may even have a proper SSL/TLS certificate. By never visiting there, you’re safer.</p> \n<p>But that requires hitting the site once to get the header in the first place, right? Yep, that’s right. So there’s <a href=\"https://hstspreload.org/\">HSTS preloading</a>, which is a list of domains that ships with all major browsers and how to preload them. Effectively, they get the directive to only visit <code class=\"language-plaintext highlighter-rouge\">https://</code> before the first visit. There’s <strong>never</strong> any <code class=\"language-plaintext highlighter-rouge\">http://</code> communication once this is in place.</p> \n<p>Okay cool! So what’s it take to get on that list? Here are the requirements:</p> \n<ol> \n <li>Serve a valid certificate.</li> \n <li>Redirect from HTTP to HTTPS on the same host, if you are listening on port 80.</li> \n <li>Serve all subdomains over HTTPS. \n  <ul> \n   <li>In particular, you must support HTTPS for the www subdomain if a DNS record for that subdomain exists.</li> \n  </ul> </li> \n <li>Serve an HSTS header on the base domain for HTTPS requests: \n  <ul> \n   <li>The max-age must be at least eighteen weeks (10886400 seconds).</li> \n   <li>The includeSubDomains directive must be specified.</li> \n   <li>The preload directive must be specified.</li> \n   <li>If you are serving an additional redirect from your HTTPS site, that redirect must still have the HSTS header (rather than the page it redirects to).</li> \n  </ul> </li> \n</ol> \n<p>That sounds good, right? We’ve got all our active domains on HTTPS now, with valid certificates. Nope, we’ve got a problem. Remember how we had <code class=\"language-plaintext highlighter-rouge\">meta.gaming.stackexchange.com</code> for years? While it redirects to <code class=\"language-plaintext highlighter-rouge\">gaming.meta.stackexchange.com</code> that redirect does not have a valid certificate.</p> \n<p>Using metas as an example, if we pushed <code class=\"language-plaintext highlighter-rouge\">includeSubDomains</code> on our HSTS header, we would change every link on the internet pointing at the old domains from a working redirect into a landmine. Instead of landing on an <code class=\"language-plaintext highlighter-rouge\">https://</code> site (as they do today), they’d get an invalid certificate error. Based on our traffic logs yesterday, we’re still getting 80,000 hits a day just to the child meta domains for the 301s. A lot of this is web crawlers catching up (it takes quite a while), but a lot is also human traffic from blogs, bookmarks, etc. …and some crawlers are just really stupid and never update their information based on a 301. You know who you are. And why are you still reading this? I fell asleep 3 times writing this damn thing.</p> \n<p>So what do we do? Do we set up several SAN certs with hundreds of domains on them and host that strictly for 301s piped through our infrastructure? It couldn’t reasonably be done through Fastly without a higher cost (more IPs, more certs, etc.) <a href=\"https://letsencrypt.org/\">Let’s Encrypt</a> <em>is</em> actually helpful here. Getting the cert would be low cost, if you ignore the engineering effort required to set it up and maintain it (since we don’t use it today for reasons <a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#certificates\">listed above</a>).</p> \n<p>There’s one more critical piece of archaeology here: our internal domain is <code class=\"language-plaintext highlighter-rouge\">ds.stackexchange.com</code>. Why <code class=\"language-plaintext highlighter-rouge\">ds.</code>? I’m not sure. My assumption is we didn’t know how to spell data center. This means <code class=\"language-plaintext highlighter-rouge\">includeSubDomains</code> automatically includes <em>every internal endpoint</em>. Now, most of our things are <code class=\"language-plaintext highlighter-rouge\">https://</code> already, but making everything need HTTPS for even development from the first moment internally will cause some issues and delays. It’s not that we wouldn’t want <code class=\"language-plaintext highlighter-rouge\">https://</code> everywhere inside, but that’s an entire project (mainly around certificate distribution and maintenance, as well as multi-level certificates) that you really don’t want coupled. Why not just change the internal domain? Because we don’t have a few spare months for a lateral move. It requires a lot of time and coordination to do a move like that.</p> \n<p>For the moment, I will be ramping up the HSTS <code class=\"language-plaintext highlighter-rouge\">max-age</code> duration slowly to 2 years across all Q&amp;A sites <strong>without</strong> <code class=\"language-plaintext highlighter-rouge\">includeSubDomains</code>. I’m actually going to remove this setting from the code until needed, since it’s so dangerous. Once we get all Q&amp;A site header durations ramped up, I think we can work with Google to add them to the HSTS list without <code class=\"language-plaintext highlighter-rouge\">includeSubDomains</code>, at least as a start. You can see <a href=\"https://chromium.googlesource.com/chromium/src/net/+/master/http/transport_security_state_static.json\">on the current list</a> that this does happen in rare circumstances. I hope they’ll agree for securing Stack Overflow.</p> \n<h4 id=\"chat\">Chat</h4> \n<p>In order to enable <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Secure_and_HttpOnly_cookies\"><code class=\"language-plaintext highlighter-rouge\">Secure</code> cookies</a> (ones only sent over HTTPS) as fast as possible, we’ll be redirecting chat (<a href=\"https://chat.stackoverflow.com/\">chat.stackoverflow.com</a>, <a href=\"https://chat.stackexchange.com/\">chat.stackexchange.com</a>, and <a href=\"https://chat.meta.stackexchange.com/\">chat.meta.stackexchange.com</a>) to <code class=\"language-plaintext highlighter-rouge\">https://</code>. Chat relies on the cookie on the second-level domain like all the other Universal Login apps do, so if the cookies are only sent over <code class=\"language-plaintext highlighter-rouge\">https://</code>, you can only be logged in over <code class=\"language-plaintext highlighter-rouge\">https://</code>.</p> \n<p>There’s more to think through on this, but making chat itself <code class=\"language-plaintext highlighter-rouge\">https://</code> with mixed-content while we solve those issues is still a net win. It allows us to secure the network fast and work on mixed-content in real-time chat afterwards. Look for this to happen in the next week or two. It’s next on my list.</p> \n<h4 id=\"today\">Today</h4> \n<p>So anyway, that’s where we stand today and what we’ve been up to the last 4 years. A lot of things came up with higher priority that pushed HTTPS back - this is <em>very far</em> from the only thing we’ve been working on. That’s life. The people working on this are the same ones that fight the fires we hope you never see. There are also far more people involved than mentioned here. I was narrowing the post to the complicated topics (otherwise it would have been long) that each took significant amounts of work, but many others at Stack Overflow and outside helped along the way.</p> \n<p>I know a lot of you will have many questions, concerns, complaints, and suggestions on how we can do things better. We more than welcome all of these things. We’ll watch the comments below, our metas, Reddit, Hacker News, and Twitter this week and answer/help as much as we can. Thanks for your time, and you’re crazy for reading all of this. &lt;3</p>","descriptionType":"text/html","publishedDate":"Mon, 22 May 2017 00:00:00 +0000","feedId":12609,"bgimg":"https://nickcraver.com/blog/content/HTTPS-MainCertificate.png","linkMd5":"052bb6f1bc2d1a84e7e0b850104d56df","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn89@2020_6/2020/08/25/02-05-18-379_1bc83fc3f52d5619.webp","destWidth":1136,"destHeight":1196,"sourceBytes":111298,"destBytes":84176,"author":"","articleImgCdnMap":{"https://nickcraver.com/blog/content/HTTPS-MainCertificate.png":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn89@2020_6/2020/08/25/02-05-18-379_1bc83fc3f52d5619.webp","https://nickcraver.com/blog/content/HTTPS-Layout.svg":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn9@2020_6/2020/08/25/02-05-21-337_9662fd1864b5f3ca.svg","https://nickcraver.com/blog/content/HTTPS-Teststackoverflow.png":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn29@2020_5/2020/08/25/02-05-21-398_96e4e422671033ae.webp","https://nickcraver.com/blog/content/HTTPS-ClientTimings.png":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn38@2020_2/2020/08/25/02-05-22-388_4e611aa43d2cc202.webp","https://nickcraver.com/blog/content/HTTPS-ClientTimingsDatabase.png":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn58@2020_1/2020/08/25/02-05-20-179_3be20ca72d32c7a6.webp","https://nickcraver.com/blog/content/HTTPS-Websockets.png":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn82@2020_2/2020/08/25/02-05-20-129_79c75d7fac6cd09b.webp","https://nickcraver.com/blog/content/HTTPS-WebsocketMemory.png":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn41@2020_6/2020/08/25/02-05-20-104_2976801a301fe134.webp","https://nickcraver.com/blog/content/HTTPS-HelpCommit.png":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn93@2020_1/2020/08/25/02-05-21-666_1f80d67c1f209fa7.webp"},"publishedOrCreatedDate":1598321095276},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"Stack Overflow: How We Do App Caching - 2019 Edition","link":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/","description":"<blockquote> \n <p>This is #5 in a <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">very long series of posts</a> on Stack Overflow’s architecture.<br /> Previous post (#4): <a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/\">Stack Overflow: How We Do Monitoring - 2018 Edition</a></p> \n</blockquote> \n<p>So…caching. What is it? It’s a way to get a quick payoff by not re-calculating or fetching things over and over, resulting in performance and cost wins. That’s even where the name comes from, it’s a short form of the “ca-ching!” cash register sound from the dark ages of 2014 when physical currency was still a thing, before Apple Pay. I’m a dad now, deal with it.</p> \n<p>Let’s say we need to call an API or query a database server or just take a bajillion numbers (Google says <a href=\"https://www.merriam-webster.com/dictionary/bajillion\">that’s an actual word</a>, I checked) and add them up. Those are all relatively <em>crazy</em> expensive. So we <a href=\"https://en.wikipedia.org/wiki/Cache_(computing)\">cache</a> the result – we keep it handy for re-use.</p> \n<h3 id=\"why-do-we-cache\">Why Do We Cache?</h3> \n<p>I think it’s important here to discuss <em>just how expensive</em> some of the above things are. There are several layers of caching already in play in your modern computer. \n <!--more--> As a concrete example, we’re going to use one of our web servers which currently houses a pair of <a href=\"https://ark.intel.com/products/81713/Intel-Xeon-Processor-E5-2690-v3-30M-Cache-2-60-GHz-\">Intel Xeon E5-2960 v3 CPUs</a>&nbsp;and 2133MHz DIMMs. Cache access is a “how many cycles” feature of a processor, so by knowing that we always run at 3.06GHz (performance power mode), we can derive the latencies (<a href=\"https://www.intel.co.uk/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-optimization-manual.pdf\">Intel architecture reference here</a> – these processors are in the Haswell generation):</p> \n<ul> \n <li>L1 (per core): 4 cycles or <strong>~1.3ns</strong> latency - 12x 32KB+32KB</li> \n <li>L2 (per core): 12 cycles or <strong>~3.92ns</strong> latency - 12x 256KB</li> \n <li>L3 (shared): 34 cycles or <strong>~11.11ns</strong> latency - 30MB</li> \n <li>System memory: <strong>~100ns</strong> latency - 8x 8GB</li> \n</ul> \n<p>Each cache layer is able to store more, but is farther away. It’s a trade-off in processor design with balances in play. For example, more memory per core means (almost certainly) on average putting it farther away on the chip from the core and that has costs in latency, opportunity costs, and power consumption. How far an electric charge has to travel has substantial impact at this scale; remember that distance is multiplied by <em>billions</em> every second.</p> \n<p>And I didn’t get into disk latency above because we so very rarely touch disk. Why? Well, I guess to explain that we need to…look at disks. Ooooooooh shiny disks! But please don’t touch them after running around in socks. At Stack Overflow, anything production that’s not a backup or logging server is on SSDs. Local storage generally falls into a few tiers for us:</p> \n<ul> \n <li>NVMe SSD: ~120μs (<a href=\"https://www.anandtech.com/show/8104/intel-ssd-dc-p3700-review-the-pcie-ssd-transition-begins-with-nvme/3\">source</a>)</li> \n <li>SATA or SAS SSD: ~400–600μs (<a href=\"https://www.anandtech.com/show/8104/intel-ssd-dc-p3700-review-the-pcie-ssd-transition-begins-with-nvme/3\">source</a>)</li> \n <li>Rotational HDD: 2–6ms (<a href=\"https://en.wikipedia.org/wiki/Hard_disk_drive_performance_characteristics\">source</a>)</li> \n</ul> \n<p>These numbers are changing all the time, so don’t focus on exact figures too much. What we’re trying to evaluate is the magnitude of the difference of these storage tiers. Let’s go down the list (assuming the lower bound of each, these are best case numbers):</p> \n<ul> \n <li>L1: 1.3ns</li> \n <li>L2: 3.92ns (<strong>3x slower</strong>)</li> \n <li>L3: 11.11ns (<strong>8.5x slower</strong>)</li> \n <li>DDR4 RAM: 100ns (<strong>77x slower</strong>)</li> \n <li>NVMe SSD: 120,000ns (<strong>92,307x slower</strong>)</li> \n <li>SATA/SAS SSD: 400,000ns (<strong>307,692x slower</strong>)</li> \n <li>Rotational HDD: 2–6ms (<strong>1,538,461x slower</strong>)</li> \n <li>Microsoft Live Login: 12 redirects and 5s (<strong>3,846,153,846x slower</strong>, approximately)</li> \n</ul> \n<p>If numbers aren’t your thing, <a href=\"https://people.eecs.berkeley.edu/~rcs/research/interactive_latency.html\">here’s a neat open source visualization</a> (use the slider!)&nbsp;by <a href=\"https://github.com/colin-scott\">Colin Scott</a>&nbsp;(you can even go see how they’ve evolved over time – really neat):</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Latencies.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Caching/SO-Cache-Latencies.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Caching/SO-Cache-Latencies.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Latencies.png\" loading=\"lazy\" alt=\"Cache Latencies\" /> \n  </picture></a></p> \n<p>With those performance numbers and a sense of scale in mind, let’s add some numbers that matter every day. Let’s say our data source is <code class=\"language-plaintext highlighter-rouge\">X</code>, where what <code class=\"language-plaintext highlighter-rouge\">X</code> is doesn’t matter. It could be SQL, or a microservice, or a macroservice, or a leftpad service, or Redis, or a file on disk, etc. The key here is that we’re comparing that source’s performance to that of RAM. Let’s say our source takes…</p> \n<ul> \n <li>100ns (from RAM - fast!)</li> \n <li>1ms (10,000x slower)</li> \n <li>100ms (100,000x slower)</li> \n <li>1s (1,000,000x slower)</li> \n</ul> \n<p>I don’t think we need to go further to illustrate the point: <strong>even things that take only 1 millisecond are way, <em>way</em> slower than local RAM</strong>. Remember: millisecond, microsecond, nanosecond – just in case anyone else forgets that a 1000ns != 1ms like I sometimes do…</p> \n<p>But not all cache is local. For example, we use Redis for shared caching behind our web tier (<a href=\"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/#redis\">which we’ll cover in a bit</a>). Let’s say we’re going across our network to get it. For us, that’s a 0.17ms roundtrip and you need to also send some data. For small things (our usual), that’s going to be around 0.2–0.5ms total. Still 2,000–5,000x slower than local RAM, but also a lot faster than most sources. Remember, these numbers are because we’re in a small local LAN. Cloud latency will generally be higher, so measure to see your latency.</p> \n<p>When we get the data, maybe we also want to massage it in some way. Probably Swedish. Maybe we need totals, maybe we need to filter, maybe we need to encode it, maybe we need to fudge with it randomly just to trick you. That was a test to see if you’re still reading. You passed! Whatever the reason, the commonality is generally <em>we want to do <code class=\"language-plaintext highlighter-rouge\">&lt;x&gt;</code> once</em>, and not <em>every time we serve it</em>.</p> \n<p>Sometimes we’re saving latency and sometimes we’re saving CPU. One or both of those are generally why a cache is introduced. Now let’s cover the flip side…</p> \n<h3 id=\"why-wouldnt-we-cache\">Why Wouldn’t We Cache?</h3> \n<p>For everyone who hates caching, this is the section for you! Yes, I’m totally playing both sides.</p> \n<p>Given the above and how drastic the wins are, why <em>wouldn’t</em> we cache something? Well, because <strong><em>every single decision has trade-offs</em></strong>. Every. Single. One. It could be as simple as time spent or opportunity cost, but there’s still a trade-off.</p> \n<p>When it comes to caching, adding a cache comes with some costs:</p> \n<ul> \n <li>Purging values if and when needed (cache invalidation – <a href=\"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/#cache-invalidation\">we’ll cover that in a few</a>)</li> \n <li>Memory used by the cache</li> \n <li>Latency of access to the cache (weighed against access to the source)</li> \n <li>Additional time and mental overhead spent debugging something more complicated</li> \n</ul> \n<p>Whenever a candidate for caching comes up (usually with a new feature), we need to evaluate these things…and that’s not always an easy thing to do. Although caching is an exact science, much like astrology, it’s still tricky.</p> \n<p>Here at Stack Overflow, our architecture has one overarching theme: keep it as simple as possible. Simple is easy to evaluate, reason about, debug, and change if needed. Only make it more complicated if and when it <strong><em>needs</em></strong> to be more complicated. That includes cache. Only cache if you need to. It adds more work and <a href=\"https://shouldiblamecaching.com/\">more chances for bugs</a>, so unless it’s needed: don’t. At least, not yet.</p> \n<p>Let’s start by asking some questions.</p> \n<ul> \n <li>Is it that much faster to hit cache?</li> \n <li>What are we saving?</li> \n <li>Is it worth the storage?</li> \n <li>Is it worth the cleanup of said storage (e.g. garbage collection)?</li> \n <li>Will it go on the large object heap immediately?</li> \n <li>How often do we have to invalidate it?</li> \n <li>How many hits per cache entry do we think we’ll get?</li> \n <li>Will it interact with other things that complicate invalidation?</li> \n <li>How many variants will there be?</li> \n <li>Do we have to allocate just to calculate the key?</li> \n <li>Is it a local or remote cache?</li> \n <li>Is it shared between users?</li> \n <li>Is it shared between sites?</li> \n <li>Does it rely on quantum entanglement or does debugging it just make you think that?</li> \n <li>What color is the cache?</li> \n</ul> \n<p>All of these are questions that come up and affect caching decisions. I’ll try and cover them through this post.</p> \n<h3 id=\"layers-of-cache-at-stack-overflow\">Layers of Cache at Stack Overflow</h3> \n<p>We have our own “L1”/”L2” caches here at Stack Overflow, but I’ll refrain from referring to them that way to avoid confusion with the CPU caches mentioned above. What we have is several types of cache. Let’s first quickly cover local and memory caches here for terminology before a deep dive into the common bits used by them:</p> \n<ul> \n <li><strong>“Global Cache”</strong>: In-memory cache (global, per web server, and backed by Redis on miss) \n  <ul> \n   <li>Usually things like a user’s top bar counts, shared across the network</li> \n   <li>This hits local memory (shared keyspace), and then Redis (shared keyspace, using Redis database 0)</li> \n  </ul> </li> \n <li><strong>“Site Cache”</strong>: In-memory cache (per site, per web server, and backed by Redis on miss) \n  <ul> \n   <li>Usually things like question lists or user lists that are per-site</li> \n   <li>This hits local memory (per-site keyspace, using prefixing), and then Redis (per-site keyspace, using Redis databases)</li> \n  </ul> </li> \n <li><strong>“Local Cache”</strong>: In-memory cache (per site, per web server, backed by <em>nothing</em>) \n  <ul> \n   <li>Usually things that are cheap to fetch, but huge to stream and the Redis hop isn’t worth it</li> \n   <li>This hits local memory only (per-site keyspace, using prefixing)</li> \n  </ul> </li> \n</ul> \n<p>What do we mean by “per-site”? Stack Overflow and the Stack Exchange network of sites is <a href=\"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/\">a multi-tenant architecture</a>. Stack Overflow is just one of <a href=\"https://stackexchange.com/sites#traffic\">many hundreds of sites</a>. This means one process on the web server hosts all the sites, so we need to split up the caching where needed. And we’ll have to purge it (<a href=\"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/#cache-invalidation\">we’ll cover how that works too</a>).</p> \n<h3 id=\"redis\">Redis</h3> \n<p>Before we discuss how servers and shared cache work, let’s quickly cover what the shared bits are built on: Redis. So what is <a href=\"https://redis.io/\">Redis</a>? It’s an open source key/value data store with many useful data structures, additional publish/subscriber mechanisms, and rock solid stability.</p> \n<p>Why Redis and not <code class=\"language-plaintext highlighter-rouge\">&lt;something else&gt;</code>? Well, because it works. And it works well. It seemed like a good idea when we needed a shared cache. It’s been <em>incredibly</em> rock solid. We don’t wait on it – it’s incredibly fast. We know how it works. We’re very familiar with it. We know how to monitor it. We know how to spell it. We maintain one of the most used open source libraries for it. We can tweak that library if we need.</p> \n<p>It’s a piece of infrastructure we <em>just don’t worry about</em>. We basically take it for granted (though we still have an HA setup of replicas – we’re not <em>completely</em> crazy). When making infrastructure choices, you don’t just change things for perceived possible value. Changing takes effort, takes time, and involves risk. If what you have works well and does what you need, why invest that time and effort and take a risk? Well…you don’t. There are thousands of better things you can do with your time. Like debating which cache server is best!</p> \n<p>We have a few Redis instances to separate concerns of apps (but on the same set of servers), here’s an example of what one looks like:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Caching/SO-Cache-Opserver.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Caching/SO-Cache-Opserver.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver.png\" loading=\"lazy\" alt=\"Opserver: Redis View\" /> \n  </picture></a></p> \n<p>For the curious, some quick stats from last Tuesday (2019-07-30) This is across all instances on the primary boxes (because we split them up for organization, not performance…one instance could handle everything we do quite easily):</p> \n<ul> \n <li>Our Redis physical servers have 256GB of memory, but less than 96GB used.</li> \n <li>1,586,553,473 commands processed per day (3,726,580,897 commands and 86,982 per second peak across all instances – due to replicas)</li> \n <li>Average of 2.01% CPU utilization (3.04% peak) for the entire server (&lt; 1% even for the most active instance)</li> \n <li>124,415,398 active keys (422,818,481 including replicas)</li> \n <li>Those numbers are across 308,065,226 HTTP hits (64,717,337 of which were question pages)</li> \n</ul> \n<p><sub>Note: None of these are Redis limited – we’re far from any limits. It’s just how much activity there is on our instances.</sub></p> \n<p>There are also non-cache reasons we use Redis, namely: we also use the pub/sub mechanism <a href=\"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/#websockets-httpsgithubcomstackexchangenetgain\">for our websockets</a> that provide realtime updates on scores, rep, etc. Redis 5.0 <a href=\"https://redis.io/topics/streams-intro\">added Streams</a> which is a perfect fit for our websockets and we’ll likely migrate to them when some other infrastructure pieces are in place (mainly limited by Stack Overflow Enterprise’s version at the moment).</p> \n<h4 id=\"in-memory--redis-cache\">In-Memory &amp; Redis Cache</h4> \n<p>Each of the above has an in-memory cache component and some have a backup in that lovely Redis server.</p> \n<p>In-memory is simple enough, we’re just caching things in…ya know, memory. In ASP.NET MVC 5, this used to be <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.web.httpruntime.cache?view=netframework-4.7.2\"><code class=\"language-plaintext highlighter-rouge\">HttpRuntime.Cache</code></a>. These days, in preparation for our <a href=\"https://docs.microsoft.com/en-us/aspnet/core/\">ASP.NET Core</a> move, we’ve moved on to <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.runtime.caching.memorycache\"><code class=\"language-plaintext highlighter-rouge\">MemoryCache</code></a>. The differences are tiny and don’t matter much; both generally provide a way to cache an object for some duration of time. That’s all we need here.</p> \n<p>For the above caches, we choose a “database ID”. These relate to the sites we have on the Stack Exchange Network and come from our <code class=\"language-plaintext highlighter-rouge\">Sites</code> database table. <a href=\"https://stackoverflow.com/\">Stack Overflow</a> is 1, <a href=\"https://serverfault.com/\">Server Fault</a> is 2, <a href=\"https://superuser.com/\">Super User</a> is 3, etc.</p> \n<p>For local cache, you could approach it a few ways. Ours is simple: that ID is part of the cache key. For Global Cache (shared), the ID is zero. We further (for safety) prefix each cache to avoid conflicts with general key names from whatever else might be in these app-level caches. An example key would be:</p> \n<div class=\"language-plaintext highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code>prod:1-related-questions:1234\n</code></pre> \n </div> \n</div> \n<p>That would be the related questions in the sidebar for Question 1234 on Stack Overflow (ID: 1). If we’re <strong>only</strong> in-memory, serialization doesn’t matter and we can just cache any object. However, if we’re sending that cache object somewhere (or getting one back from somewhere), we need to serialize it. And fast! That’s where <a href=\"https://github.com/mgravell/protobuf-net\">protobuf-net</a> written by our own <a href=\"https://twitter.com/marcgravell\">Marc Gravell</a> comes in. <a href=\"https://developers.google.com/protocol-buffers/docs/encoding\">Protobuf</a> is a binary encoding format that’s tremendously efficient in both speed and allocations. A simple object we want to cache may look like this:</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">RelatedQuestionsCache</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">int</span> <span class=\"n\">Count</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">Html</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre> \n </div> \n</div> \n<p>With <a href=\"https://github.com/mgravell/protobuf-net#basic-usage\">protobuf attributes</a> to control serialization, it looks like this:</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"p\">[</span><span class=\"n\">ProtoContract</span><span class=\"p\">]</span>\n<span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">RelatedQuestionsCache</span>\n<span class=\"p\">{</span>\n    <span class=\"p\">[</span><span class=\"nf\">ProtoMember</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">)]</span> <span class=\"k\">public</span> <span class=\"kt\">int</span> <span class=\"n\">Count</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"p\">[</span><span class=\"nf\">ProtoMember</span><span class=\"p\">(</span><span class=\"m\">2</span><span class=\"p\">)]</span> <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">Html</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre> \n </div> \n</div> \n<p>So let’s say we want to cache that object in Site Cache. The flow looks like this (code simplified a bit):</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"n\">T</span> <span class=\"n\">Get</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;(</span><span class=\"kt\">string</span> <span class=\"n\">key</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">// Transform to the shared cache key format, e.g. \"x\" into \"prod:1-x\"</span>\n    <span class=\"kt\">var</span> <span class=\"n\">cacheKey</span> <span class=\"p\">=</span> <span class=\"nf\">GetCacheKey</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">);</span>\n    <span class=\"c1\">// Do we have it in memory?</span>\n    <span class=\"kt\">var</span> <span class=\"n\">local</span> <span class=\"p\">=</span> <span class=\"n\">memoryCache</span><span class=\"p\">.</span><span class=\"n\">Get</span><span class=\"p\">&lt;</span><span class=\"n\">RedisWrapper</span><span class=\"p\">&gt;(</span><span class=\"n\">cacheKey</span><span class=\"p\">);</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">local</span> <span class=\"p\">!=</span> <span class=\"k\">null</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"c1\">// We've got it local - nothing more to do.</span>\n        <span class=\"k\">return</span> <span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">GetValue</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;();</span>\n    <span class=\"p\">}</span>\n    <span class=\"c1\">// Is Redis connected and readable? This makes Redis a fallback and not critical</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">redisCache</span><span class=\"p\">.</span><span class=\"nf\">CanRead</span><span class=\"p\">(</span><span class=\"n\">cacheKey</span><span class=\"p\">))</span> <span class=\"c1\">// Key is passed here for the case of Redis Cluster</span>\n    <span class=\"p\">{</span>\n    \t<span class=\"kt\">var</span> <span class=\"n\">remote</span> <span class=\"p\">=</span> <span class=\"n\">redisCache</span><span class=\"p\">.</span><span class=\"nf\">StringGetWithExpiry</span><span class=\"p\">(</span><span class=\"n\">cacheKey</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">remote</span><span class=\"p\">.</span><span class=\"n\">Value</span> <span class=\"p\">!=</span> <span class=\"k\">null</span><span class=\"p\">)</span>\n        <span class=\"p\">{</span>\n            <span class=\"c1\">// Get our shared construct for caching</span>\n       \t    <span class=\"kt\">var</span> <span class=\"n\">wrapper</span> <span class=\"p\">=</span> <span class=\"n\">RedisWrapper</span><span class=\"p\">.</span><span class=\"nf\">From</span><span class=\"p\">(</span><span class=\"n\">remote</span><span class=\"p\">);</span>\n            <span class=\"c1\">// Set it in our local memory cache so the next hit gets it faster</span>\n            <span class=\"n\">memoryCache</span><span class=\"p\">.</span><span class=\"n\">Set</span><span class=\"p\">&lt;</span><span class=\"n\">RedisWrapper</span><span class=\"p\">&gt;(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">wrapper</span><span class=\"p\">,</span> <span class=\"n\">remote</span><span class=\"p\">.</span><span class=\"n\">Expiry</span><span class=\"p\">);</span>\n            <span class=\"c1\">// Return the value we found in Redis</span>\n            <span class=\"k\">return</span> <span class=\"n\">remote</span><span class=\"p\">.</span><span class=\"n\">Value</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n    <span class=\"c1\">// No value found, sad panda</span>\n    <span class=\"k\">return</span> <span class=\"k\">null</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre> \n </div> \n</div> \n<p>Granted, this code is greatly simplified to convey the point, but we’re not leaving anything important out.</p> \n<p>Why a <code class=\"language-plaintext highlighter-rouge\">RedisWrapper&lt;T&gt;</code>? It synonymizes platform concepts by having a value with a TTL (time-to-live) with the value, just <a href=\"https://redis.io/commands/ttl\">like Redis does</a>. It also allows the caching of a <code class=\"language-plaintext highlighter-rouge\">null</code> value and makes that handling not special-cased. In other words, you can tell the difference between “It’s not cached” and “We looked it up. It was null. We cached that null. STOP ASKING!” If you’re curious about <a href=\"https://github.com/StackExchange/StackExchange.Redis/blob/3f7e5466c6bbff96a3ed1130b637a097d21f3fed/src/StackExchange.Redis/Interfaces/IDatabase.cs#L1871\"><code class=\"language-plaintext highlighter-rouge\">StringGetWithExpiry</code>, it’s a StackExchange.Redis method</a> that returns the value and the <code class=\"language-plaintext highlighter-rouge\">TTL</code> in one call by pipelining the commands (not 2 round-trip time costs).</p> \n<p>A <code class=\"language-plaintext highlighter-rouge\">Set&lt;T&gt;</code>&nbsp;for caching a value works exactly the same way:</p> \n<ol> \n <li>Cache the value in memory.</li> \n <li>Cache the same value in Redis.</li> \n <li>(Optionally) Alert the other web servers that the value has been updated and instruct them to flush their copy.</li> \n</ol> \n<h4 id=\"pipelining\">Pipelining</h4> \n<p>I want to take a moment and relay a very important thing here: our Redis connections (via <code class=\"language-plaintext highlighter-rouge\">StackExchange.Redis</code>) are pipelined. Think of it like a conveyor belt you can stick something on and it goes somewhere and circles back. You could stick thousands of things in a row on that conveyor belt before the first reaches the destination or comes back. If you put a giant thing on there, it means you have to wait to add other things.</p> \n<p>The items may be independent, but the conveyor belt is shared. In our case, the conveyor belt is the connection and the items are commands. If a large payload goes on or comes back, it occupies the belt for a bit. This means if you’re waiting on a specific thing but some nasty big item clogs up he works for a second or two, it may cause collateral damage. That’s a timeout.</p> \n<p>We often see issues filed from people putting tremendous many-megabyte payloads into Redis with low timeouts, but that doesn’t work unless the pipe is very, very fast. They don’t see the many-megabyte command timing out…they usually see things waiting <em>behind</em> it timing out.</p> \n<p>It’s important to realize that a pipeline is just like any pipe outside a computer. Whatever its narrowest constraint is, that’s where it’ll bottleneck. Except this is a dynamic pipe, more like a hose that can expand or bend or kink. The bottlenecks are not 100% constant. In practical terms, this can be <a href=\"https://docs.microsoft.com/en-us/dotnet/standard/threading/the-managed-thread-pool\">thread pool</a> exhaustion (either feeding commands in or handling them coming out). Or it may be network bandwidth. And maybe something <em>else</em> is using that network bandwidth impacting us.</p> \n<p>Remember that at these levels of latency, viewing things at 1Gb/s or 10Gb/s isn’t really using the correct unit of time. For me, it helps to not think in terms of 1Gb/s, but instead in terms of 1Mb/ms. If we’re traversing the network in about a millisecond or less, that payload really does matter and can increase the time taken by very measurable and impactful amounts. That’s all to say: think small here. The limits on any system when you’re dealing with short durations must be considered with relative constraints proportional to the same durations. When we’re talking about milliseconds, the fact that we think of most computing concepts only down to the second is often a factor that confuses thinking and discussion.</p> \n<h4 id=\"pipelining-retries\">Pipelining: Retries</h4> \n<p>The pipelined nature is also why we can’t retry commands with any confidence. In this sad world our conveyor belt has turned into the airport baggage pickup loopy thingamajig (<a href=\"https://www.merriam-webster.com/dictionary/thingamajig\">also in the dictionary</a>, for the record) we all know and love.</p> \n<p>You put an bag on the thingamajig. The bag contains something important, probably some really fancy pants. They’re going to someone who you wanted to impress. (We’re using airport luggage as a very reasonably priced alternative to UPS in this scenario.) But Mr. Fancy Pants is super nice and promised to return your bag. So nice. You did your part. The bag went on the thingamajig and went out of sight…and never make it back. Okay…<em>where</em> did it go?!? We don’t know! DAMN YOU BAG!</p> \n<p>Maybe the bag made it to the lovely person and got lost on the return trip. Or maybe it didn’t. We still don’t know! Should we send it again? What if we’re sending them a second pair of fancy pants? Will they think we think they spill ketchup a lot? That’d be weird. We don’t want to come on too strong. And now we’re just confused and bagless. So let’s talk about something that makes even less sense: cache invalidation.</p> \n<h4 id=\"cache-invalidation\">Cache Invalidation</h4> \n<p>I keep referring to purging above, so how’s that work? Redis has <a href=\"https://redis.io/topics/pubsub\">a pub/sub feature</a> where you can push a message out and subscribers all receive it (this message goes to all replicas as well). Using this simple concept, we can simply have a cache clearing channel we <a href=\"https://redis.io/commands/subscribe\"><code class=\"language-plaintext highlighter-rouge\">SUBSCRIBE</code></a> to. When we want to remove a value early (rather than waiting for TTLs to fall out naturally), we just <a href=\"https://redis.io/commands/publish\"><code class=\"language-plaintext highlighter-rouge\">PUBLISH</code></a> that key name to our channel and the listener (think event handler here) just purges the key from local cache.</p> \n<p>The steps are:</p> \n<ol> \n <li>Purge the value from Redis via <a href=\"https://redis.io/commands/del\"><code class=\"language-plaintext highlighter-rouge\">DEL</code></a> or <a href=\"https://redis.io/commands/unlink\"><code class=\"language-plaintext highlighter-rouge\">UNLINK</code></a>. Or, just replace the value with a new one…whatever state we’re after.</li> \n <li>Broadcast the key to the purge channel.</li> \n</ol> \n<p>Order is important, because reversing these would create a race and end up in a re-fetch of the old value sometimes. Note that <strong>we’re not pushing the new value out</strong>. That’s not the goal. Maybe web servers 1–5 that had the value cache won’t even ask for it again this duration…so let’s not be over-eager and wasteful. All we’re making them do is get it from Redis <em>if and when</em> it’s asked for.</p> \n<h4 id=\"combining-everything-getset\">Combining Everything: GetSet</h4> \n<p>If you look at the above, you’d think we’re doing this a lot:</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"kt\">var</span> <span class=\"n\">val</span> <span class=\"p\">=</span> <span class=\"n\">Current</span><span class=\"p\">.</span><span class=\"n\">SiteCache</span><span class=\"p\">.</span><span class=\"n\">Get</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;(</span><span class=\"n\">key</span><span class=\"p\">);</span>\n<span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">val</span> <span class=\"p\">==</span> <span class=\"k\">null</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">val</span> <span class=\"p\">=</span> <span class=\"nf\">FetchFromSource</span><span class=\"p\">();</span>\n    <span class=\"n\">Current</span><span class=\"p\">.</span><span class=\"n\">SiteCache</span><span class=\"p\">.</span><span class=\"nf\">Set</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">Timespan</span><span class=\"p\">.</span><span class=\"nf\">FromSeconds</span><span class=\"p\">(</span><span class=\"m\">30</span><span class=\"p\">));</span>\n<span class=\"p\">}</span>\n<span class=\"k\">return</span> <span class=\"n\">val</span><span class=\"p\">;</span>\n</code></pre> \n </div> \n</div> \n<p>But here’s where we can greatly improve on things. First, it’s repetitive. Ugh. But more importantly, that code will result in hundreds of simultaneous calls to <code class=\"language-plaintext highlighter-rouge\">FetchFromSource()</code> at scale when the cache expires. What if that fetch is heavy? Presumably it’s <em>somewhat</em>&nbsp;expensive, since we’ve decided to cache it in the first place. We need a better plan.</p> \n<p>This is where our most common approach comes in: <code class=\"language-plaintext highlighter-rouge\">GetSet&lt;T&gt;()</code>. Okay, so naming is hard. Let’s just agree everyone has regrets and move on. What do we <em>really</em> want to do here?</p> \n<ul> \n <li>Get a value if it’s there</li> \n <li>Calculate or fetch a value if it’s not there (and shove it in cache)</li> \n <li>Prevent calculating or fetching the same value many times</li> \n <li>Ensure users wait as little as possible</li> \n</ul> \n<p>We can use some attributes about who we are and what we do to optimize here. Let’s say you load the web page now, or a second ago, or 3 seconds from now. Does it matter? Is the Stack Overflow question going to change that much? The answer is: only if there’s anything to notice. Maybe you made an upvote, or an edit, or a comment, etc. These are things you’d notice. We must refresh any caches that pertain to those kinds of activities <em>for you</em>. But for any of hundreds of other users simultaneously loading that page, skews in data are imperceptible.</p> \n<p>That means we have wiggle room. Let’s exploit that wiggle room for performance.</p> \n<p>Here’s what <code class=\"language-plaintext highlighter-rouge\">GetSet&lt;T&gt;</code> looks like today (yes, there’s an equivalent-ish <code class=\"language-plaintext highlighter-rouge\">async</code>&nbsp;version):</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">static</span> <span class=\"n\">T</span> <span class=\"n\">GetSet</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;(</span>\n    <span class=\"k\">this</span> <span class=\"n\">ImmediateSiteCache</span> <span class=\"n\">cache</span><span class=\"p\">,</span>\n    <span class=\"kt\">string</span> <span class=\"n\">key</span><span class=\"p\">,</span>\n    <span class=\"n\">Func</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">MicroContext</span><span class=\"p\">,</span> <span class=\"n\">T</span><span class=\"p\">&gt;</span> <span class=\"n\">lookup</span><span class=\"p\">,</span>\n    <span class=\"kt\">int</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span>\n    <span class=\"kt\">int</span> <span class=\"n\">serveStaleDataSecs</span><span class=\"p\">,</span>\n    <span class=\"n\">GetSetFlags</span> <span class=\"n\">flags</span> <span class=\"p\">=</span> <span class=\"n\">GetSetFlags</span><span class=\"p\">.</span><span class=\"n\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">Server</span> <span class=\"n\">server</span> <span class=\"p\">=</span> <span class=\"n\">Server</span><span class=\"p\">.</span><span class=\"n\">PreferMaster</span><span class=\"p\">)</span>\n</code></pre> \n </div> \n</div> \n<p>The key arguments to this are <code class=\"language-plaintext highlighter-rouge\">durationSecs</code> and <code class=\"language-plaintext highlighter-rouge\">serveStaleDataSecs</code>. A call often looks something like this (it’s a contrived example for simplicity of discussion):</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"kt\">var</span> <span class=\"n\">lookup</span> <span class=\"p\">=</span> <span class=\"n\">Current</span><span class=\"p\">.</span><span class=\"n\">SiteCache</span><span class=\"p\">.</span><span class=\"n\">GetSet</span><span class=\"p\">&lt;</span><span class=\"n\">Dictionary</span><span class=\"p\">&lt;</span><span class=\"kt\">int</span><span class=\"p\">,</span> <span class=\"kt\">string</span><span class=\"p\">&gt;&gt;(</span><span class=\"s\">\"User:DisplayNames\"</span><span class=\"p\">,</span> \n   <span class=\"p\">(</span><span class=\"n\">old</span><span class=\"p\">,</span> <span class=\"n\">ctx</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"n\">ctx</span><span class=\"p\">.</span><span class=\"n\">DB</span><span class=\"p\">.</span><span class=\"n\">Query</span><span class=\"p\">&lt;(</span><span class=\"kt\">int</span> <span class=\"n\">Id</span><span class=\"p\">,</span> <span class=\"kt\">string</span> <span class=\"n\">DisplayName</span><span class=\"p\">)&gt;(</span><span class=\"s\">\"Select Id, DisplayName From Users\"</span><span class=\"p\">)</span>\n                       <span class=\"p\">.</span><span class=\"nf\">ToDictionary</span><span class=\"p\">(</span><span class=\"n\">i</span> <span class=\"p\">=&gt;</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">Id</span><span class=\"p\">),</span> \n    <span class=\"m\">60</span><span class=\"p\">,</span> <span class=\"m\">5</span><span class=\"p\">*</span><span class=\"m\">60</span><span class=\"p\">);</span>\n</code></pre> \n </div> \n</div> \n<p>This call goes to the <code class=\"language-plaintext highlighter-rouge\">Users</code> table and caches an <code class=\"language-plaintext highlighter-rouge\">Id</code>&nbsp;-&gt; <code class=\"language-plaintext highlighter-rouge\">DisplayName</code> lookup (we don’t actually do this, I just needed a simple example). The key part is the values at the end. We’re saying “cache for 60 seconds, but serve stale for 5 minutes”.</p> \n<p>The behavior is that for 60 seconds, any hits against this cache only return it. But we keep the value in memory (and Redis) for 6 minutes total. In the time between 60 seconds and 6 minutes (from the time cached), we’ll happily <em>still serve the value to users</em>. But, we’ll kick off a background refresh on another thread at the same time so future users get a fresh value. Rinse and repeat.</p> \n<p>Another important detail here is we keep a per-server local lock table (a <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2\"><code class=\"language-plaintext highlighter-rouge\">ConcurrentDictionary</code></a>) that prevents two calls from trying to run that <code class=\"language-plaintext highlighter-rouge\">lookup</code> function and getting the value at the same time. For example, there’s no win in querying the database 400 times for 400 users. Users 2 though 400 are better off waiting on the first cache to complete and our database server isn’t kinda sorta murdered in the process. Why a <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2\"><code class=\"language-plaintext highlighter-rouge\">ConcurrentDictionary&lt;string, object&gt;</code></a>&nbsp;instead of say a <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.hashset-1\"><code class=\"language-plaintext highlighter-rouge\">HashSet&lt;string&gt;</code></a>? Because we want to <code class=\"language-plaintext highlighter-rouge\">lock</code> on the <code class=\"language-plaintext highlighter-rouge\">object</code>&nbsp;in that dictionary for subsequent callers. They’re all waiting on the same fetch and that <code class=\"language-plaintext highlighter-rouge\">object</code>&nbsp;represents our fetch.</p> \n<p>If you’re curious about that <code class=\"language-plaintext highlighter-rouge\">MicroContext</code>, that goes back to being multi-tenant. Since the fetch may happen on a background thread, we need to know what it was for. Which site? Which database? What was the previous cache value? Those are things we put on the context before passing it to the background thread for the <code class=\"language-plaintext highlighter-rouge\">lookup</code> to grab a new value. Passing the old value also lets us handle an error case as desired, e.g. logging the error and still returning the old value, because giving a user slightly out-of-date data is always always better than an error page. We choose per call here though. If returning the old value is bad for some reason – just don’t do that.</p> \n<h4 id=\"types-and-things\">Types and Things</h4> \n<p>A question I often get is how do we use DTOs (<a href=\"https://en.wikipedia.org/wiki/Data_transfer_object\">data transfer objects</a>)? In short, we don’t. We only use additional types and allocations <em>when we need to</em>. For example, if we can run a <code class=\"language-plaintext highlighter-rouge\">.Query&lt;MyType&gt;(\"Select...\");</code> from Dapper and stick it into cache, we will. There’s little reason to create <em>another</em> type just to cache.</p> \n<p>If it makes sense to cache the type that’s 1:1 with a database table (e.g. <code class=\"language-plaintext highlighter-rouge\">Post</code> for the <code class=\"language-plaintext highlighter-rouge\">Posts</code> table, or <code class=\"language-plaintext highlighter-rouge\">User</code> for the <code class=\"language-plaintext highlighter-rouge\">Users</code> table), we’ll cache that. If there’s some subtype or combination of things that are the columns from a combined query, we’ll just <code class=\"language-plaintext highlighter-rouge\">.Query&lt;T&gt;</code> as that type, populating from those columns, and cache that. If that still sounds abstract, here’s a more concrete example:</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"p\">[</span><span class=\"n\">ProtoContract</span><span class=\"p\">]</span>\n<span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">UserCounts</span>\n<span class=\"p\">{</span>\n    <span class=\"p\">[</span><span class=\"nf\">ProtoMember</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">)]</span> <span class=\"k\">public</span> <span class=\"kt\">int</span> <span class=\"n\">UserId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"p\">[</span><span class=\"nf\">ProtoMember</span><span class=\"p\">(</span><span class=\"m\">2</span><span class=\"p\">)]</span> <span class=\"k\">public</span> <span class=\"kt\">int</span> <span class=\"n\">PostCount</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"p\">[</span><span class=\"nf\">ProtoMember</span><span class=\"p\">(</span><span class=\"m\">3</span><span class=\"p\">)]</span> <span class=\"k\">public</span> <span class=\"kt\">int</span> <span class=\"n\">CommentCount</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">public</span> <span class=\"n\">Dictionary</span><span class=\"p\">&lt;</span><span class=\"kt\">int</span><span class=\"p\">,</span> <span class=\"n\">UserCounts</span><span class=\"p\">&gt;</span> <span class=\"nf\">GetUserCounts</span><span class=\"p\">()</span> <span class=\"p\">=&gt;</span>\n    <span class=\"n\">Current</span><span class=\"p\">.</span><span class=\"n\">SiteCache</span><span class=\"p\">.</span><span class=\"n\">GetSet</span><span class=\"p\">&lt;</span><span class=\"n\">Dictionary</span><span class=\"p\">&lt;</span><span class=\"kt\">int</span><span class=\"p\">,</span> <span class=\"n\">UserCounts</span><span class=\"p\">&gt;&gt;(</span><span class=\"s\">\"All-User-Counts\"</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">old</span><span class=\"p\">,</span> <span class=\"n\">ctx</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span>\n    <span class=\"p\">{</span>\n        <span class=\"k\">try</span>\n        <span class=\"p\">{</span>\n            <span class=\"k\">return</span> <span class=\"n\">ctx</span><span class=\"p\">.</span><span class=\"n\">DB</span><span class=\"p\">.</span><span class=\"n\">Query</span><span class=\"p\">&lt;</span><span class=\"n\">UserCounts</span><span class=\"p\">&gt;(</span><span class=\"s\">@\"\n  Select u.Id UserId, PostCount, CommentCount\n    From Users u\n         Cross Apply (Select Count(*) PostCount From Posts p Where u.Id = p.OwnerUserId) p\n         Cross Apply (Select Count(*) CommentCount From PostComments pc Where u.Id = pc.UserId) pc\"</span><span class=\"p\">)</span>\n                <span class=\"p\">.</span><span class=\"nf\">ToDictionary</span><span class=\"p\">(</span><span class=\"n\">r</span> <span class=\"p\">=&gt;</span> <span class=\"n\">r</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">catch</span><span class=\"p\">(</span><span class=\"n\">Exception</span> <span class=\"n\">ex</span><span class=\"p\">)</span>\n        <span class=\"p\">{</span>\n            <span class=\"n\">Env</span><span class=\"p\">.</span><span class=\"nf\">LogException</span><span class=\"p\">(</span><span class=\"n\">ex</span><span class=\"p\">);</span>\n            <span class=\"k\">return</span> <span class=\"n\">old</span><span class=\"p\">;</span> <span class=\"c1\">// Return the old value</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">},</span> <span class=\"m\">60</span><span class=\"p\">,</span> <span class=\"m\">5</span><span class=\"p\">*</span><span class=\"m\">60</span><span class=\"p\">);</span>\n</code></pre> \n </div> \n</div> \n<p>In this example we are taking advantage of <a href=\"https://github.com/StackExchange/Dapper\"><code class=\"language-plaintext highlighter-rouge\">Dapper</code></a>’s built-in column mapping. (Note that it sets <code class=\"language-plaintext highlighter-rouge\">get</code>-only properties.) The type used is just for this. For example, it could even be <code class=\"language-plaintext highlighter-rouge\">private</code>, and make this method take a <code class=\"language-plaintext highlighter-rouge\">int userId</code> with the <code class=\"language-plaintext highlighter-rouge\">Dictionary&lt;int, UserCount&gt;</code> being a method-internal detail. We’re also showing how <code class=\"language-plaintext highlighter-rouge\">T old</code> and the <code class=\"language-plaintext highlighter-rouge\">MicroContext</code> are used here. If an error occurs, we log it and return the previous value.</p> \n<p>So…types. Yeah. We do whatever works. Our philosophy is to not create a lot of types unless they’re useful. DTOs generally don’t come with just the type, but also include a lot of mapping code – or more magical code (e.g. reflection) that maps across and is subject to unintentional breaks down the line. Keep. It. Simple. That’s all we’re doing here. Simple <em>also</em> means fewer allocations and instantiations. Performance is often the byproduct of simplicity.</p> \n<h4 id=\"redis-the-good-types\">Redis: The Good Types</h4> \n<p>Redis has <a href=\"https://redis.io/topics/data-types\">a variety of data types</a>. All of the key/value examples thus far use “String” type in Redis. But don’t think of this as a string data type like you’re used to in programming (for example, <code class=\"language-plaintext highlighter-rouge\">string</code> <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.string?view=netcore-2.2\">in .NET</a>, or <a href=\"https://docs.oracle.com/javase/7/docs/api/java/lang/String.html\">in Java</a>). It basically means “some bytes” in the Redis usage. It could be a string, it could be a binary image, or it could be…well, anything you can store in some bytes! But, we use most of the other data types in various ways as well:</p> \n<ul> \n <li>Redis Lists are useful for queues like our aggregator or account actions to execute in-order.</li> \n <li>Redis Sets are useful for unique lists of items like “which account IDs are in this alpha test?” (things that are unique, but not ordered).</li> \n <li>Redis Hashes are useful for things that are dictionary-like, such as “What’s the latest activity date for a site?” (where the hash key ID is site and the value is a date). We use this to determine “Do we need to run badges on site X this time?” and other questions.</li> \n <li>Redis Sorted Sets are useful for ordered things like storing the slowest 100 MiniProfiler traces per route.</li> \n</ul> \n<p>Speaking of sorted sets, we need to replace the <a href=\"https://stackoverflow.com/users\"><code class=\"language-plaintext highlighter-rouge\">/users</code> page</a> to be backed by sorted sets (one per reputation time range) with range queries instead. Marc and I planned how to do this at a company meetup in Denver many years ago but keep forgetting to do it…</p> \n<h3 id=\"monitoring-cache-performance\">Monitoring Cache Performance</h3> \n<p>There are a few things to keep an eye on here. Remember those latency factors above? It’s super slow to go off box. When we’re rendering question pages in an average of 18–20ms, taking ~0.5ms for a Redis call is a lot. A few calls quickly add up to a significant part of our rendering time.</p> \n<p>First, we’ll want to keep an eye on this at the page level. For this, we use <a href=\"https://miniprofiler.com/dotnet/\">MiniProfiler</a> to see every Redis call involved in a page load. It’s hooked up with <a href=\"https://stackexchange.github.io/StackExchange.Redis/Profiling_v2.html\">StackExchange.Redis’s profiling API</a>. Here’s an example of what that looks like on a question page, getting my live across-the-network counts for the top bar:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-MiniProfiler.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Caching/SO-Cache-MiniProfiler.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Caching/SO-Cache-MiniProfiler.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-MiniProfiler.png\" loading=\"lazy\" alt=\"MiniProfiler: Redis Calls\" /> \n  </picture></a></p> \n<p>Second, we want to keep an eye on the Redis instances. For that, we use <a href=\"https://github.com/Opserver/Opserver\">Opserver</a>. Here’s what a single instance looks like:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver-Instance.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Caching/SO-Cache-Opserver-Instance.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Caching/SO-Cache-Opserver-Instance.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver-Instance.png\" loading=\"lazy\" alt=\"Opserver: Redis Instance\" /> \n  </picture></a></p> \n<p>We have some built-in tools there to analyze key usage and the ability to group them by regex pattern. This lets us combine what we know (we’re the ones caching!) with the data to see what’s eating the most space.</p> \n<p><sub> Note: Running such an analysis should only be done on a secondary. It’s very abusive on a master at scale. Opserver will by default run such analysis on a replica and block running it on a master without an override. </sub></p> \n<h3 id=\"whats-next\">What’s Next?</h3> \n<p>.NET Core is well underway here at Stack. We’ve ported most support services and are working on the main applications now. There’s honestly not a lot of cache to the caching layer, but one interesting possibility is <a href=\"https://github.com/dotnet/corefx/issues/30503\"><code class=\"language-plaintext highlighter-rouge\">Utf8String</code></a> (which hasn’t landed yet). We cache a lot of stuff in total, lots of tiny strings in various places – things like “Related Questions” in the sidebar. If those cache entries were UTF8 instead of <a href=\"https://docs.microsoft.com/en-us/dotnet/standard/base-types/character-encoding\">the .NET default of UTF16</a>, they’d be half the size. When you’re dealing with hundreds of thousands of strings at any given time, it adds up.</p> \n<h3 id=\"story-time\">Story Time</h3> \n<p>I asked what people wanted to know about caching on Twitter and how failures happen came up a lot. For fun, let’s recall a few that stand out in my mind:</p> \n<h4 id=\"taking-redis-down-while-trying-to-save-it\">Taking Redis Down While Trying to Save It</h4> \n<p>At one point, our Redis primary cache was getting to be about 70GB total. This was on 96GB servers. When we saw the growth over time, we planned a server upgrade and transition. By the time we got hardware in place and were ready to failover to a new master server, we had reached about 90GB of cache usage. Phew, close. But we made it!</p> \n<p>…or not. I was travelling for this one, but helped planned it all out. What we didn’t account for was the memory fork that happens for a <code class=\"language-plaintext highlighter-rouge\">BGSAVE</code> in Redis (at least in that version – this was back in 2.x). We were all very relieved to have made preparations in time, so on a weekend we hit the button and fired up data replication to the new server to prepare a failover to it.</p> \n<p>And all of our websites promptly went offline.</p> \n<p>What happens in the memory fork is that data that’s changed during the migration gets shadow copied, something that isn’t released until the clone finishes…because we need the state the server was at to initialize along with all changes since then to replicate to the new node (else we lose those new changes). So the rate at which new changes rack up is your memory growth during a copy. That 6GB went fast. Really fast. Then Redis crashed, the web servers went without Redis (something they hadn’t done in years), and they <em>really</em> didn’t handle it well.</p> \n<p>So I pulled over on the side of the road, hopped on our team call, and we got the sites back up…against the new server and an empty cache. It’s important to note that Redis didn’t do anything wrong, we did. And Redis has been rock solid for a decade here. It’s one of the most stable pieces of infrastructure we have…you just don’t think about it.</p> \n<p>But anyway, another lesson learned.</p> \n<h4 id=\"accidentally-not-using-local-cache\">Accidentally Not Using Local Cache</h4> \n<p>A certain developer we have here will be reading this and cursing my name, but I love you guys and gals so let’s share anyway!</p> \n<p>When we get a cache value back from Redis in our local/remote 2-layer cache story, we actually send two commands: a fetch of the key and a <a href=\"https://redis.io/commands/ttl\"><code class=\"language-plaintext highlighter-rouge\">TTL</code></a>. The result of the TTL tells us how many seconds Redis is caching it for…that’s how long we also cache it in local server memory. We used to use a <code class=\"language-plaintext highlighter-rouge\">-1</code> sentinel value for TTL through some library code to indicate something didn’t have a TTL. The semantics changed in a refactor to <code class=\"language-plaintext highlighter-rouge\">null</code> for “no TTL”…and we got some boolean logic wrong. Oops. A rather simple statement like this from our <code class=\"language-plaintext highlighter-rouge\">Get&lt;T&gt;</code> mentioned earlier:</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">ttl</span> <span class=\"p\">!=</span> <span class=\"p\">-</span><span class=\"m\">1</span><span class=\"p\">)</span> <span class=\"c1\">// ... push into L1</span>\n</code></pre> \n </div> \n</div> \n<p>Became:</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">ttl</span> <span class=\"p\">==</span> <span class=\"k\">null</span><span class=\"p\">)</span> <span class=\"c1\">// ... push into L1</span>\n</code></pre> \n </div> \n</div> \n<p>But <em>most</em> of our caches <strong>DO</strong> have a TTL. This meant the vast majority of keys (probably something like 95% or more) were no longer caching in L1 (local server memory). Every single call to any of these keys was going to Redis and back. Redis was so resilient and fast, we didn’t notice for a few hours. The actual logic was then corrected to:</p> \n<div class=\"language-csharp highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">ttl</span> <span class=\"p\">!=</span> <span class=\"k\">null</span><span class=\"p\">)</span> <span class=\"c1\">// ... push into L1</span>\n</code></pre> \n </div> \n</div> \n<p>…and everyone lived happily ever after.</p> \n<h4 id=\"accidentally-caching-pages-for-000006-seconds\">Accidentally Caching Pages For .000006 Seconds</h4> \n<p>You read that right.</p> \n<p>Back in 2011, we found a bit of code in our page-level output caching when looking into something unrelated:</p> \n<div class=\"language-c# highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"p\">.</span><span class=\"n\">Duration</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">TimeSpan</span><span class=\"p\">(</span><span class=\"m\">60</span><span class=\"p\">);</span>\n</code></pre> \n </div> \n</div> \n<p>This was intended to cache a thing for a minute. Which would have worked great if the default constructor for <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.timespan.-ctor?view=netframework-4.8#System_TimeSpan__ctor_System_Int64_\"><code class=\"language-plaintext highlighter-rouge\">TimeSpan</code> was seconds and not ticks</a>. But! We were excited to find this. How could cache be broken? But hey, good news – wow we’re going to get such a performance boost by fixing this!</p> \n<p>Nope. Not even a little. All we saw was memory usage increase a tiny bit. CPU usage also went up.</p> \n<p>For fun: this was included at the end of in an interview <a href=\"https://channel9.msdn.com/Events/Ch9Live/MIX11/C9L105\">back at MIX 2011 with Scott Hanselman</a>. Wow. We looked so much younger then. Anyway, that leads us to…</p> \n<h4 id=\"doing-more-harm-than-good\">Doing More Harm Than Good</h4> \n<p>For many years, we used to <a href=\"https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions-1/controllers-and-routing/improving-performance-with-output-caching-cs\">output cache</a> major pages. This included the homepage, question list pages, question pages themselves, and RSS feeds.</p> \n<p>Remember earlier: when you cache, you need to vary the cache keys based on the variants of cache. Concretely, this means: anonymous, or not? mobile, or not? deflate, gzip, or no compression? Realistically, we can’t (or shouldn’t) ever output cache for logged-in users. Your stats are in the top bar and it’s per-user. You’d notice your rep was inconsistent between page views and such.</p> \n<p>Anyway, when you step back and combine these variants with the fact that about 80% of all questions are visited every two weeks, you realize that the cache hit rate is low. Really low. But the cost of memory to store those strings (most large enough to go directly on the <a href=\"https://docs.microsoft.com/en-us/dotnet/standard/garbage-collection/large-object-heap\">large object heap</a>) is very non-trivial. And the cost of the garbage collector cleaning them up is also non-trivial.</p> \n<p>It turns out those two pieces of the equation are <em>so</em> non-trivial that caching did far more harm than good. The savings we got from the relatively occasional cache hit were drastically outweighed by the cost of having and cleaning up the cache. This puzzled us a bit at first, but when you zoom out and look at the numbers, it makes perfect sense.</p> \n<p>For the past several years, Stack Overflow (and all Q&amp;A sites) output cache <em>nothing</em>. Output caching is also not present in ASP.NET Core, so phew on not using it.</p> \n<p>Full disclosure: we still cache full XML response strings (similar to, but not using output cache) specifically on some RSS feed routes. We do so because the hit rate is quite high on these routes. This specific cache has all of the downsides mentioned above, except it’s well worth it on the hit ratios.</p> \n<h4 id=\"figuring-out-that-the-world-is-crazier-than-you-are\">Figuring Out That The World Is Crazier Than You Are</h4> \n<p>When .NET 4.6.0 came out, we found a bug. I was digging into why MiniProfiler didn’t show up on the first page load locally, slowly went insane, and then grabbed <a href=\"https://twitter.com/marcgravell\">Marc Gravell</a> to go descend into madness with me.</p> \n<p>The bug happened in our cache layer due to the nature of the issue and how it specifically affected only tail calls. You can read about <a href=\"https://nickcraver.com/blog/2015/07/27/why-you-should-wait-on-dotnet-46/\">how it manifested here</a>, but the general problem is: <strong>methods weren’t called with the parameters you passed in</strong>. Ouch. This resulted in random cache durations for us and was pretty scary when you think about it. Luckily the problem with the RyuJIT was hotfixed the following month.</p> \n<h4 id=\"net-462-caching-responses-for-2017-years\">.NET 4.6.2 Caching Responses for 2,017 years</h4> \n<p>Okay this one isn’t server-side caching at all, but I’m throwing it in because it was super “fun”. Shortly after deploying .NET 4.6.2, we noticed some oddities with client cache behavior, CDN caches growing, and other crazy. It turns out, <a href=\"https://twitter.com/nick_craver/status/850403727060107265\">there was a bug in .NET 4.6.2</a>.</p> \n<p>The cause was simple enough: when comparing the <code class=\"language-plaintext highlighter-rouge\">DateTime</code> values of “now” vs. when a response cache should expire and calculating the difference between those to figure out the <code class=\"language-plaintext highlighter-rouge\">max-age</code> portion of the <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control\"><code class=\"language-plaintext highlighter-rouge\">Cache-Control</code> header</a>, the value was subtly reset to 0 on the “now” side. So let’s say:</p> \n<div class=\"language-plaintext highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code>2017-04-05 01:17:01 (cache until) - 2017-04-05 01:16:01 (now) = 60 seconds\n</code></pre> \n </div> \n</div> \n<p>Now, let’s say that “now” value was instead <code class=\"language-plaintext highlighter-rouge\">0001-01-01 00:00:00</code>…</p> \n<div class=\"language-plaintext highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code>2017-04-05 01:17:01 (cache until) - 0001-01-01 00:00:00 (now) = 63,626,951,821 seconds\n</code></pre> \n </div> \n</div> \n<p>Luckily the math is super easy. We’re telling a browser to cache that value for 2017 years, 4 months, 5 days, 1 hour, 17 minutes and 1 second. Which <em>might</em> be a tad bit of overkill. Or on CDNs, we’re telling CDNs to cache things for that long…also problematic.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Max-Age.jpg\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Caching/SO-Cache-Max-Age.webp\" /> \n   <source type=\"image/jpg\" srcset=\"/blog/content/SO-Caching/SO-Cache-Max-Age.jpg\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Max-Age.jpg\" alt=\"Oops: Max Age\" /> \n  </picture></a></p> \n<p>Well crap. We didn’t realize this early enough. (Would you have checked for this? Are we idiots?) So that was in production and a rollback was not a quick solution. So what do we do?</p> \n<p>Luckily, we had moved to Fastly at this point, <a href=\"https://docs.fastly.com/guides/vcl-tutorials/guide-to-vcl\">which uses Varnish &amp; VCL</a>. So we can just hop in there and detect these crazy <code class=\"language-plaintext highlighter-rouge\">max-age</code> values and override them to something sane. Unless, of course, you screw that up. Yep. Turns out on first push we missed a critical piece of the normal hash algorithm for cache keys on Fastly and did things like render people’s flair back when you tried to load a question. This was corrected in a few minutes, but still: oops. Sorry about that. I reviewed and okayed that code to go out personally.</p> \n<h4 id=\"when-its-sorta-redis-but-not\">When It’s Sorta Redis But Not</h4> \n<p>One issue we had was the host itself interrupting Redis and having perceptible pipeline timeouts. We looked in Redis: the slowness was random. The commands doing it didn’t form any pattern or make any sense (e.g. tiny keys). We looked at the network and packet traces from both the client and server looked clean – the pause was inside the Redis host based on the correlated timings.</p> \n<p>Okay so…what is it? Turns out after a lot of manual profiling and troubleshooting, we found <em>another</em> process on the host that spiked at the same time. It was a small spike we thought nothing of at first, but <em>how</em> it spiked was important.</p> \n<p>It turns out that a monitoring process (dammit!) was kicking off <a href=\"https://en.wikipedia.org/wiki/Vmstat\"><code class=\"language-plaintext highlighter-rouge\">vmstat</code></a> to get memory statistics. Not that often, not that abusive – it was actually pretty reasonable. But what <code class=\"language-plaintext highlighter-rouge\">vmstat</code> did was punt Redis off of the CPU core it was running on. Like a jerk. Sometimes. Randomly. Which Redis instance? Well, that depends on the order they started in. So yeah…this bug <em>seemed</em> to hop around. The changing of context to another core was enough to see timeouts with how <em>often</em> we were hitting Redis with a constant pipe.</p> \n<p>Once we found this and factored in that we have plenty of cores in these boxes, we began pinning Redis to specific cores on the physical hosts. This ensures the primary function of the servers always has priority and monitoring is secondary.</p> \n<p>Since writing this and asking for reviews, I learned that <a href=\"https://redis.io/topics/latency-monitor\">Redis now has built-in latency monitoring</a> which was added shortly after the earlier 2.8 version we were using at the time. Check out <a href=\"https://redis.io/topics/latency-monitor#latency-doctor\"><code class=\"language-plaintext highlighter-rouge\">LATENCY DOCTOR</code></a> especially. AWESOME. Thank you Salvatore Sanfilippo! He’s the lovely <a href=\"https://twitter.com/antirez\">@antirez</a>, author of Redis.</p> \n<p>Now I need to go put the <code class=\"language-plaintext highlighter-rouge\">LATENCY</code> bits into StackExchange.Redis and Opserver…</p> \n<h3 id=\"caching-faq\">Caching FAQ</h3> \n<p>I also often get a lot of questions that don’t really fit so well above, but I wanted to cover them for the curious. And since you <em>know</em> we love Q&amp;A up in here, let’s try a new section in these posts that I can easily add to as new questions come up.</p> \n<p><strong>Q</strong>: Why don’t you use <a href=\"https://redis.io/topics/cluster-tutorial\">Redis Cluster</a>?<br /> <strong>A</strong>: There are a few reasons here:</p> \n<ol> \n <li>We use <a href=\"https://redis.io/commands/select\">databases</a>, which aren’t a feature in Cluster (to minimize the message replication header size). We can get around this by moving the database ID into the cache key instead (as we do with local cache above). But, one giant database has maintainability trade-offs, like when you go to figure out which keys are using so much room.</li> \n <li>The replication topology thus far has been node to node, meaning maintenance on the master cluster would require shifting the same topology on a secondary cluster in our DR data center. This would make maintenance harder instead of easier. We’re waiting for cluster &lt;-&gt; cluster replication, rather than node &lt;-&gt; node replication there.</li> \n <li>It would require 3+ nodes to run correctly (due to elections and such). We currently only run 2 physical Redis servers per data center. Just 1 server is way more performance than we need, and the second is a replica/backup.</li> \n</ol> \n<p><strong>Q</strong>: Why don’t you use <a href=\"https://redis.io/topics/sentinel\">Redis Sentinel</a>?<br /> <strong>A</strong>: We looked into this, but the overall management of it wasn’t any simpler than we had today. The idea of connecting to an endpoint and being directed over is great, but the management is complicated enough that it’s not worth changing our current strategy given how incredibly stable Redis is. One of the biggest issues with Sentinel is the writing of the current topology state <a href=\"https://groups.google.com/forum/#!searchin/redis-db/puppet$20cluster%7Csort:date/redis-db/1JB7OkaaxZo/w1bAZ23dAgAJ\">into the same config file</a>. This makes it very unfriendly to anyone with managed configs. For example, we use <a href=\"https://puppet.com/\">Puppet</a> here and the file changes would fight with it every run.</p> \n<p><strong>Q</strong>: How do you secure <a href=\"https://stackoverflow.com/teams\">Stack Overflow for Teams</a> cache?<br /> <strong>A</strong>: We maintain an isolated network and separate Redis servers for private data. <a href=\"https://stackoverflow.com/enterprise\">Stack Overflow Enterprise</a> customers each have their own isolated network and Redis instances as well.</p> \n<p><strong>Q</strong>: What if Redis goes down?!?1!eleven<br /> <strong>A</strong>: First, there’s a backup in the data center. But let’s assume that fails too! Who doesn’t love a good apocalypse? Without Redis at all, we’d limp a bit when restarting the apps. The cold cache would hurt a bit, smack SQL Server around a little, but we’d get back up. You’d want to build slowly if Redis was down (or just hold off on building in general in this scenario). As for the data, we would lose very little. We have treated Redis as optional for local development since before the days it was an infrastructure component at all, and it remains optional today. This means it’s not the source of truth for <em>anything</em>. All cache data it contains could be re-populated from whatever the source is. That leaves us only with active queues. The queues in Redis are account merge type actions (executed sub-second – so a short queue), the aggregator (tallying network events into our central database), and some analytics (it’s okay if we lose some A/B test data for a minute). All of these are okay to have a gap on – it’d be minimal loses.</p> \n<p><strong>Q</strong>: Are there downsides to databases?<br /> <strong>A</strong>: Yes, one that I’m aware of. At a high limit, it can eventually impact performance by measurable amounts. When Redis expires keys, it loops over databases to find and clear those keys – think of it as checking each “namespace”. At a high count, it’s a bigger loop. Since this runs every 100ms, that number being big can impact performance.</p> \n<p><strong>Q</strong>: Are you going to open source the “L1”/”L2” cache implementation?<br /> <strong>A</strong>: We’ve always wanted to, but a few things have stood in the way:</p> \n<ol> \n <li>It’s very “us”. By that I mean it’s very multi-tenant focused and that’s probably not the best API surface for everyone. This means we really need to sit down and design that API. It’s a set of APIs we’d love to put into our <a href=\"https://github.com/StackExchange/StackExchange.Redis\">StackExchange.Redis client</a> directly or as another library that uses it.</li> \n <li>There has been an idea to have more core support (e.g. what we use the pub/sub mechanism for) in Redis server itself. That’s <a href=\"http://antirez.com/news/130\">coming in Redis version 6</a>, so we can do a lot less custom pub/sub and use more standard things other clients will understand there. The less we write for “just us” or “just our client”, the better it is for everyone.</li> \n <li>Time. I wish we all had more of it. It’s the most precious thing you have – never take it for granted.</li> \n</ol> \n<p><strong>Q</strong>: With pipelining, how do you handle large Redis payloads?<br /> <strong>A</strong>: We have a separate connection called “bulky” for this. It has higher timeouts and is much more rarely used. That’s <em>if</em> it should go in Redis. If a worth-of-caching item is large but not particularly expensive to fetch, we may not use Redis and simply use “Local Cache”, fetching it <code class=\"language-plaintext highlighter-rouge\">n</code> times for <code class=\"language-plaintext highlighter-rouge\">n</code> web servers. Per-user features (since user sessions are sticky to web servers on Q&amp;A) may fit this bill as well.</p> \n<p><strong>Q</strong>: What happens when someone runs <a href=\"https://redis.io/commands/keys\"><code class=\"language-plaintext highlighter-rouge\">KEYS</code></a> on production?<br /> <strong>A</strong>: Tasers, if they’ll let me. Seriously though, since Redis 2.8.0 you should at least use <a href=\"https://redis.io/commands/scan\"><code class=\"language-plaintext highlighter-rouge\">SCAN</code></a> which doesn’t block Redis for a full key dump – it does so in chunks and lets other commands go through. <code class=\"language-plaintext highlighter-rouge\">KEYS</code> can cause a production blockage in a hurry. And by “can”, I mean 100% of the time at our scale.</p> \n<p><strong>Q</strong>: What happens when someone runs <a href=\"https://redis.io/commands/flushall\"><code class=\"language-plaintext highlighter-rouge\">FLUSHALL</code></a> on production?<br /> <strong>A</strong>: It’s against policy to comment on future criminal investigations. <a href=\"https://redis.io/topics/acl\">Redis 6 is adding ACLs though</a>, which will limit the suspect pool.</p> \n<p><strong>Q</strong>: How do the police investigators figure out what happened in either of the above cases? Or any latency spike?<br /> <strong>A</strong>: Redis has a nifty feature called <a href=\"https://redis.io/commands/slowlog\"><code class=\"language-plaintext highlighter-rouge\">SLOWLOG</code></a> which (by default) logs every command over 10ms in duration. You can adjust this, but everything should be <em>very</em> fast, so that default 10ms is a relative eternity and what we keep it at. When you run <code class=\"language-plaintext highlighter-rouge\">SLOWLOG</code> you can see the last <code class=\"language-plaintext highlighter-rouge\">n</code> entries (configurable), the command, and the arguments. Opserver will show these on the instance page, making it easy to find the offender. But, it could be network latency or an unrelated CPU spike/theft on the host. (We pin the Redis instances using processor affinity to avoid this.)</p> \n<p><strong>Q</strong>: Do you use <a href=\"https://azure.microsoft.com/en-us/services/cache/\">Azure Cache for Redis</a> for <a href=\"https://stackoverflow.com/enterprise\">Stack Overflow Enterprise</a>?<br /> <strong>A</strong>: Yes, but we may not long-term. It takes <a href=\"https://feedback.azure.com/forums/169382-cache/suggestions/7049852-work-on-creation-time-of-redis-cache\">a surprisingly long time</a> to provision when creating one for test environments and such. We’re talking dozens of minutes up to an hour here. We’ll likely use containers later, which will help us control the version used across all deployment modes as well.</p> \n<p><strong>Q</strong>: Do you expect every dev to know all of this to make caching decisions?<br /> <strong>A</strong>: Absolutely not. I had to look up exact values in many places here. My goal is that developers understand a little bit about the layer beneath and relative costs of things – or at least a rough idea of them. That’s why I stress the orders of magnitude here. Those are the units you should be considering for cost/benefit evaluations on where and how you choose to cache. Most people do not run at hundreds of millions of hits a day where the cost multiplier is so high it’ll ruin your day and optimizations decisions are far less important/impactful. Do what works for you. This is what works for us, with some context on “why?” in hopes that it helps you make your decisions.</p> \n<h3 id=\"tools\">Tools</h3> \n<p>I just wanted to provide a handy list of the tools mentioned in the article as well as a few other bits we use to help with caching:</p> \n<ul> \n <li><a href=\"https://github.com/StackExchange/StackExchange.Redis\">StackExchange.Redis</a> - Our open source .NET Redis client library.</li> \n <li><a href=\"https://github.com/Opserver/Opserver\">Opserver</a> - Our open source dashboard for monitoring, including Redis.</li> \n <li><a href=\"https://github.com/MiniProfiler/dotnet/\">MiniProfiler</a> - Our open source .NET profiling tool, with which we view Redis commands issued on any page load.</li> \n <li><a href=\"https://github.com/StackExchange/Dapper\">Dapper</a> - Our open source object relational mapper for any ADO.NET data source.</li> \n <li><a href=\"https://github.com/mgravell/protobuf-net\">protobuf-net</a> - <a href=\"https://twitter.com/marcgravell\">Marc Gravell</a>’s Protocol Buffers library for idiomatic .NET.</li> \n</ul> \n<p>What’s next? The way <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">this series</a> works is I blog in order of what the community wants to know about most. I normally go by <a href=\"https://trello.com/b/0zgQjktX/blog-post-queue-for-stack-overflow-topics\">the Trello board</a> to see what’s next, but we probably have a queue jumper coming up. We’re almost done porting Stack Overflow to .NET Core and we have a lot of stories and tips to share as well as tools we’ve built to make that migration easier. The next time you see a lot of words from me may be the next Trello board item, or it may be .NET Core. If you have questions that you want to see answered in such a post, please put them <a href=\"https://trello.com/c/fpwHYK97/90-the-move-to-net-core\">on the .NET Core card</a> (open to the public) and I’ll be reviewing all of that when I start writing it. Stay tuned, and thanks for following along.</p>","descriptionType":"text/html","publishedDate":"Tue, 06 Aug 2019 00:00:00 +0000","feedId":12609,"bgimg":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Latencies.png","linkMd5":"bccdad3a6ba89c859e54afaec202e0e6","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn94@2020_6/2020/08/25/02-05-18-250_ca88f317785ba40d.webp","destWidth":3003,"destHeight":1031,"sourceBytes":39428,"destBytes":39428,"author":"","articleImgCdnMap":{"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Latencies.png":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn94@2020_6/2020/08/25/02-05-18-250_ca88f317785ba40d.webp","https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver.png":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn6@2020_2/2020/08/25/02-05-21-858_fda92d5f2ed3976d.webp","https://nickcraver.com/blog/content/SO-Caching/SO-Cache-MiniProfiler.png":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn42@2020_5/2020/08/25/02-05-21-616_7b134b13fd4d2bd4.webp","https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver-Instance.png":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn14@2020_3/2020/08/25/02-05-20-346_411c91823c39080f.webp","https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Max-Age.jpg":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn93@2020_2/2020/08/25/02-05-20-200_d398e753bad68f1f.webp"},"publishedOrCreatedDate":1598321095273},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"Stack Overflow: A Technical Deconstruction","link":"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/","description":"<blockquote> \n <p>As new posts in the series appear, I’ll add them here to serve as a master list:<br /> #1: <a href=\"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/\">Stack Overflow: The Architecture - 2016 Edition</a><br /> #2: <a href=\"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/\">Stack Overflow: The Hardware - 2016 Edition</a><br /> #3: <a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/\">Stack Overflow: How We Do Deployment - 2016 Edition</a><br /> #4: <a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/\">Stack Overflow: How We Do Monitoring - 2018 Edition</a><br /> #5: <a href=\"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/\">Stack Overflow: How We Do App Caching - 2019 Edition</a></p> \n</blockquote> \n<p>One of the reasons I love working at Stack Overflow is we’re <s>allowed</s> <em>encouraged</em> to talk about almost anything out in the open. Except for things companies <em>always</em> keep private like financials and the nuclear launch codes, everything else is fair game. That’s an awesome thing that we haven’t taken advantage of on the technical side lately. I think it’s time for an experiment in extreme openness.</p> \n<p>By sharing what we do (and I mean <em>all</em> of us), we better our world. Everyone that works at Stack shares at least one passion: improving life for all developers. Sharing how we do things is one of the best and biggest ways we can do that. It helps you. It helps me. It helps all of us.</p> \n<p>When I tell you how we do <code class=\"language-plaintext highlighter-rouge\">&lt;something&gt;</code>, a few things happen:</p> \n<ul> \n <li>You might learn something cool you didn’t know about.</li> \n <li>We might learn we’re doing it wrong.</li> \n <li>We’ll both find a better way, together…and we share that too.</li> \n <li>It helps eliminate the perception that “the big boys” always do it right. No, we screw up too.</li> \n</ul> \n<p>There’s nothing to lose here and there’s no reason to keep things to yourself unless you’re afraid of being wrong. Good news: that’s not a problem. We get it wrong all the time anyway, so I’m not really worried about that one. Failure is <em>always</em> an option. The best any of us can do is live, learn, move on, and do it better next time. \n <!--more--></p> \n<h2 id=\"heres-where-i-need-your-help\">Here’s where I need your help</h2> \n<p>I need you to tell me: what do you want to hear about? My intention is to get to a great many things, but it will take some time. What are people most interested in? How do I decide which topic to blog about next? The answer: I don’t know and I can’t decide. That’s where you come in. Please, tell me.</p> \n<p>I put together this Trello board: <a href=\"https://trello.com/b/0zgQjktX/blog-post-queue-for-stack-overflow-topics\">Blog post queue for Stack Overflow topics</a></p> \n<p>I’m also embedding it here for ease, hopefully this adds a lot of concreteness to the adventure:</p> \n<iframe src=\"https://trello.com/b/0zgQjktX.html\" frameborder=\"0\" width=\"100%\" height=\"600\"></iframe> \n<p>It’s public. You can comment and vote on topics as well as suggest new topics either on the board itself or shoot me a tweet: <a href=\"https://twitter.com/Nick_Craver\">@Nick_Craver</a>. Please, help me out by simply voting for what you want to know so I can prioritize the queue. If you see a topic and have specific questions, please comment on the card so I make sure to answer it in the post.</p> \n<p>The first post won’t be vote-driven. I think it <em>has</em> to be the architecture overview so all future references make sense. After that, I’ll go down the board and blog the highest-voted topic each time.</p> \n<p>I’ve missed blogging due to spending my nights entirely in open source lately. I don’t believe that’s necessarily the <em>best</em> or <em>only</em> way for me to help developers. Having votes for topics gives me real motivation to dedicate the time to writing them up, pulling the stats, and making the pretty pictures. For that, I thank everyone participating.</p> \n<p>If you’re curious about my writing style and what to expect, check out some of my previous posts:</p> \n<ul> \n <li><a href=\"http://blog.serverfault.com/2015/03/05/how-we-upgrade-a-live-data-center/\">How we upgrade a live data center</a></li> \n <li><a href=\"https://nickcraver.com/blog/2013/11/22/what-it-takes-to-run-stack-overflow/\">What it takes to run Stack Overflow</a></li> \n <li><a href=\"https://nickcraver.com/blog/2013/04/23/stackoverflow-com-the-road-to-ssl/\">Stackoverflow.com: the road to SSL</a></li> \n</ul> \n<p>Am I crazy? Yep, probably - that’s already a lot of topics. But I think it’ll be fun and engaging. Let’s go on this adventure together.</p>","descriptionType":"text/html","publishedDate":"Wed, 03 Feb 2016 00:00:00 +0000","feedId":12609,"bgimg":"","linkMd5":"1f69de1743dafe2167d88cd0bd13211b","bgimgJsdelivr":"","metaImg":"","author":"","publishedOrCreatedDate":1598321095269},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"Why you should wait on upgrading to .Net 4.6","link":"https://nickcraver.com/blog/2015/07/27/why-you-should-wait-on-dotnet-46/","description":"<p><strong>Update (August 11th):</strong> A patch for this bug has been released by Microsoft. Here’s their update to the advisory:</p> \n<blockquote> \n <p>We released an updated version of RyuJIT today, which resolves this advisory. The update was released as <a href=\"https://technet.microsoft.com/library/security/ms15-092.aspx\">Microsoft Security Bulletin MS15-092</a> and is available on Windows Update or via direct download as <a href=\"https://support.microsoft.com/kb/3086251\">KB3086251</a>. The update resolves: <a href=\"https://github.com/dotnet/coreclr/issues/1296\">CoreCLR #1296</a>, <a href=\"https://github.com/dotnet/coreclr/issues/1299\">CoreCLR #1299</a>, and <a href=\"https://github.com/Microsoft/visualfsharp/issues/536\">VisualFSharp #536</a>. Major thanks to the developers who reported these issues. Thanks to everyone for their patience.</p> \n</blockquote> \n<h3 id=\"original-post\">Original Post</h3> \n<p>What follows is the work of several people: <a href=\"http://blog.marcgravell.com/\">Marc Gravell</a> and I have taken lead on this at Stack Overflow and we continue to coordinate with Microsoft on a resolution. They have fixed the bug internally, but not for users. Given the severity, we can’t in good conscience let such a subtle yet high-impact bug linger silently. <strong>We are not upgrading Stack Overflow to .Net 4.6</strong>, and you shouldn’t upgrade yet either. You can find <a href=\"https://github.com/dotnet/coreclr/issues/1296\">the issue we opened on GitHub (for public awareness) here</a>. <strong>A fix has been released, see Update 5 below</strong>.</p> \n<p><strong>Update #1 (July 27th):</strong> <a href=\"https://github.com/dotnet/coreclr/pull/1298\">A pull request has been posted by Matt Michell (Microsoft)</a>.</p> \n<p><strong>Update #2 (July 28th):</strong> There are several smaller repros now (<a href=\"https://github.com/dotnet/coreclr/issues/1296#issuecomment-125568026\">including a small console app</a>). Microsoft has confirmed they are working on an expedited hotfix release but we don’t have details yet.</p> \n<p><strong>Update #3 (July 28th):</strong> Microsoft’s Rich Lander has posted an update: <a href=\"https://blogs.msdn.microsoft.com/dotnet/2015/07/28/ryujit-bug-advisory-in-the-net-framework-4-6/\">RyuJIT Bug Advisory in the .NET Framework 4.6</a>.</p> \n<p><strong>Update #4 (July 29th):</strong> There’s <a href=\"https://github.com/dotnet/coreclr/issues/1299\">another subtle bug</a> found by Andrey Akinshin and the F# Engine Exception <a href=\"https://github.com/Microsoft/visualfsharp/issues/536#issuecomment-125384182\">is confirmed to be a separate issue</a>. I still recommend disabling RyuJIT in production given <a href=\"https://github.com/dotnet/coreclr/issues?utf8=%E2%9C%93&amp;q=is%3Aissue+RyuJIT\">the increasing bug count</a>.</p> \n<p><strong>Update #5 (August 11th):</strong> A patch for this bug has been released by Microsoft, see above.</p> \n<p>This critical bug is specific to .Net 4.6 and RyuJIT (64-bit). I’ll make this big and bold so we get to the point quickly:</p> \n<h3 id=\"the-methods-you-call-can-get-different-parameter-values-than-you-passed-in\">The methods you call can get different parameter values than you passed in.</h3> \n<p></p> \n<p>The JIT (Just-in-Time compiler) in .Net (and many platforms) does something called Tail Call optimization. This happens to alleviate stack load on the last-called method in a chain. I won’t go into what a tail call is <a href=\"https://blogs.msdn.microsoft.com/davbr/2007/06/20/enter-leave-tailcall-hooks-part-2-tall-tales-of-tail-calls/\">because there’s already an excellent write up by David Broman</a>.</p> \n<p>The issue here is a bug in how RyuJIT x64 implements this optimization in certain situations. \n <!--more-->Let’s look at the specific example we hit at Stack Overflow (<a href=\"https://github.com/StackExchange/RyuJIT-TailCallBug\">we have uploaded a minimal version of this reproduction to GitHub</a>).</p> \n<p>We noticed that <a href=\"http://miniprofiler.com/\">MiniProfiler</a> (which we use to track performance) was showing only on the first page load. The profiler then failed to show again until an application recycle. This turned out to be a caching bug based on the HTTP Cache usage locally. HTTP Cache is our “L1” cache at Stack Overflow; <a href=\"https://redis.io/\">redis</a> is typically the “L2.” After over a day of debugging (and sanity checking), we tracked the crazy to here:</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"k\">void</span> <span class=\"n\">Set</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;(</span><span class=\"kt\">string</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">T</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"kt\">int</span><span class=\"p\">?</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"kt\">bool</span> <span class=\"n\">sliding</span><span class=\"p\">,</span> <span class=\"kt\">bool</span> <span class=\"n\">broadcastRemoveFromCache</span> <span class=\"p\">=</span> <span class=\"k\">false</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">SetWithPriority</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"n\">sliding</span><span class=\"p\">,</span> <span class=\"n\">CacheItemPriority</span><span class=\"p\">.</span><span class=\"n\">Default</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">void</span> <span class=\"n\">SetWithPriority</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;(</span><span class=\"kt\">string</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">T</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"kt\">int</span><span class=\"p\">?</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"kt\">bool</span> <span class=\"n\">isSliding</span><span class=\"p\">,</span> <span class=\"n\">CacheItemPriority</span> <span class=\"n\">priority</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">key</span> <span class=\"p\">=</span> <span class=\"nf\">KeyInContext</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">);</span>\n\n    <span class=\"nf\">RawSet</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"n\">isSliding</span><span class=\"p\">,</span> <span class=\"n\">priority</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">void</span> <span class=\"nf\">RawSet</span><span class=\"p\">(</span><span class=\"kt\">string</span> <span class=\"n\">cacheKey</span><span class=\"p\">,</span> <span class=\"kt\">object</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"kt\">int</span><span class=\"p\">?</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"kt\">bool</span> <span class=\"n\">isSliding</span><span class=\"p\">,</span> <span class=\"n\">CacheItemPriority</span> <span class=\"n\">priority</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"kt\">var</span> <span class=\"n\">absolute</span> <span class=\"p\">=</span> <span class=\"p\">!</span><span class=\"n\">isSliding</span> <span class=\"p\">&amp;&amp;</span> <span class=\"n\">durationSecs</span><span class=\"p\">.</span><span class=\"n\">HasValue</span> \n                   <span class=\"p\">?</span> <span class=\"n\">DateTime</span><span class=\"p\">.</span><span class=\"n\">UtcNow</span><span class=\"p\">.</span><span class=\"nf\">AddSeconds</span><span class=\"p\">(</span><span class=\"n\">durationSecs</span><span class=\"p\">.</span><span class=\"n\">Value</span><span class=\"p\">)</span> \n                   <span class=\"p\">:</span> <span class=\"n\">Cache</span><span class=\"p\">.</span><span class=\"n\">NoAbsoluteExpiration</span><span class=\"p\">;</span>\n    <span class=\"kt\">var</span> <span class=\"n\">sliding</span> <span class=\"p\">=</span> <span class=\"n\">isSliding</span> <span class=\"p\">&amp;&amp;</span> <span class=\"n\">durationSecs</span><span class=\"p\">.</span><span class=\"n\">HasValue</span> \n                  <span class=\"p\">?</span> <span class=\"n\">TimeSpan</span><span class=\"p\">.</span><span class=\"nf\">FromSeconds</span><span class=\"p\">(</span><span class=\"n\">durationSecs</span><span class=\"p\">.</span><span class=\"n\">Value</span><span class=\"p\">)</span> \n                  <span class=\"p\">:</span> <span class=\"n\">Cache</span><span class=\"p\">.</span><span class=\"n\">NoSlidingExpiration</span><span class=\"p\">;</span>\n\n    <span class=\"n\">HttpRuntime</span><span class=\"p\">.</span><span class=\"n\">Cache</span><span class=\"p\">.</span><span class=\"nf\">Insert</span><span class=\"p\">(</span><span class=\"n\">cacheKey</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"k\">null</span><span class=\"p\">,</span> <span class=\"n\">absolute</span><span class=\"p\">,</span> <span class=\"n\">sliding</span><span class=\"p\">,</span> <span class=\"n\">priority</span><span class=\"p\">,</span> <span class=\"k\">null</span><span class=\"p\">);</span>\n<span class=\"p\">}</span></code></pre> \n</figure> \n<p>What was happening? We were setting the MiniProfiler cache duration (passed to <code class=\"language-plaintext highlighter-rouge\">Set&lt;T&gt;</code>) as 3600 seconds. But often (~98% of the time), we were seeing it immediately expire from HTTP cache. Next we narrowed this down to being a bug <strong>only when optimizations are enabled</strong> (the “Optimize Code” checkbox on your project’s build properties). At this point sanity is out the window and you debug <em>everything</em>.</p> \n<p>Here’s what that code looks like now. Note: I have slightly shortened it to fit this page. <a href=\"https://github.com/StackExchange/RyuJIT-TailCallBug/blob/master/StackRedis/Caches.Local.cs#L403\">The unaltered code is on GitHub here</a>.</p> \n<figure class=\"highlight\"> \n <pre><code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"k\">void</span> <span class=\"n\">Set</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;(</span><span class=\"kt\">string</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">T</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"kt\">int</span><span class=\"p\">?</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"kt\">bool</span> <span class=\"n\">sliding</span><span class=\"p\">,</span> <span class=\"kt\">bool</span> <span class=\"n\">broadcastRemoveFromCache</span> <span class=\"p\">=</span> <span class=\"k\">false</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">LocalCache</span><span class=\"p\">.</span><span class=\"nf\">OnLogDuration</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"s\">\"LocalCache.Set\"</span><span class=\"p\">);</span>\n    <span class=\"n\">SetWithPriority</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"n\">sliding</span><span class=\"p\">,</span> <span class=\"n\">CacheItemPriority</span><span class=\"p\">.</span><span class=\"n\">Default</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">void</span> <span class=\"n\">SetWithPriority</span><span class=\"p\">&lt;</span><span class=\"n\">T</span><span class=\"p\">&gt;(</span><span class=\"kt\">string</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">T</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"kt\">int</span><span class=\"p\">?</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"kt\">bool</span> <span class=\"n\">isSliding</span><span class=\"p\">,</span> <span class=\"n\">CacheItemPriority</span> <span class=\"n\">priority</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">LocalCache</span><span class=\"p\">.</span><span class=\"nf\">OnLogDuration</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"s\">\"LocalCache.SetWithPriority\"</span><span class=\"p\">);</span>\n    <span class=\"n\">key</span> <span class=\"p\">=</span> <span class=\"nf\">KeyInContext</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">);</span>\n\n    <span class=\"nf\">RawSet</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"n\">isSliding</span><span class=\"p\">,</span> <span class=\"n\">priority</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">void</span> <span class=\"nf\">RawSet</span><span class=\"p\">(</span><span class=\"kt\">string</span> <span class=\"n\">cacheKey</span><span class=\"p\">,</span> <span class=\"kt\">object</span> <span class=\"k\">value</span><span class=\"p\">,</span> <span class=\"kt\">int</span><span class=\"p\">?</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"kt\">bool</span> <span class=\"n\">isSliding</span><span class=\"p\">,</span> <span class=\"n\">CacheItemPriority</span> <span class=\"n\">priority</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">LocalCache</span><span class=\"p\">.</span><span class=\"nf\">OnLogDuration</span><span class=\"p\">(</span><span class=\"n\">cacheKey</span><span class=\"p\">,</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"s\">\"RawSet\"</span><span class=\"p\">);</span>\n    <span class=\"kt\">var</span> <span class=\"n\">absolute</span> <span class=\"p\">=</span> <span class=\"p\">!</span><span class=\"n\">isSliding</span> <span class=\"p\">&amp;&amp;</span> <span class=\"n\">durationSecs</span><span class=\"p\">.</span><span class=\"n\">HasValue</span> \n                   <span class=\"p\">?</span> <span class=\"n\">DateTime</span><span class=\"p\">.</span><span class=\"n\">UtcNow</span><span class=\"p\">.</span><span class=\"nf\">AddSeconds</span><span class=\"p\">(</span><span class=\"n\">durationSecs</span><span class=\"p\">.</span><span class=\"n\">Value</span><span class=\"p\">)</span> \n                   <span class=\"p\">:</span> <span class=\"n\">Cache</span><span class=\"p\">.</span><span class=\"n\">NoAbsoluteExpiration</span><span class=\"p\">;</span>\n    <span class=\"kt\">var</span> <span class=\"n\">sliding</span> <span class=\"p\">=</span> <span class=\"n\">isSliding</span> <span class=\"p\">&amp;&amp;</span> <span class=\"n\">durationSecs</span><span class=\"p\">.</span><span class=\"n\">HasValue</span> \n                  <span class=\"p\">?</span> <span class=\"n\">TimeSpan</span><span class=\"p\">.</span><span class=\"nf\">FromSeconds</span><span class=\"p\">(</span><span class=\"n\">durationSecs</span><span class=\"p\">.</span><span class=\"n\">Value</span><span class=\"p\">)</span> \n                  <span class=\"p\">:</span> <span class=\"n\">Cache</span><span class=\"p\">.</span><span class=\"n\">NoSlidingExpiration</span><span class=\"p\">;</span>\n\n    <span class=\"n\">HttpRuntime</span><span class=\"p\">.</span><span class=\"n\">Cache</span><span class=\"p\">.</span><span class=\"nf\">Insert</span><span class=\"p\">(</span><span class=\"n\">cacheKey</span><span class=\"p\">,</span> <span class=\"k\">value</span><span class=\"p\">,</span> <span class=\"k\">null</span><span class=\"p\">,</span> <span class=\"n\">absolute</span><span class=\"p\">,</span> <span class=\"n\">sliding</span><span class=\"p\">,</span> <span class=\"n\">priority</span><span class=\"p\">,</span> <span class=\"n\">Removed</span><span class=\"p\">);</span>\n    <span class=\"kt\">var</span> <span class=\"n\">evt</span> <span class=\"p\">=</span> <span class=\"n\">Added</span><span class=\"p\">;</span>\n    <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">evt</span> <span class=\"p\">!=</span> <span class=\"k\">null</span><span class=\"p\">)</span> <span class=\"nf\">evt</span><span class=\"p\">(</span><span class=\"n\">cacheKey</span><span class=\"p\">,</span> <span class=\"k\">value</span><span class=\"p\">,</span> <span class=\"n\">absolute</span><span class=\"p\">,</span> <span class=\"n\">sliding</span><span class=\"p\">,</span> <span class=\"n\">priority</span><span class=\"p\">,</span> <span class=\"n\">durationSecs</span><span class=\"p\">,</span> <span class=\"n\">isSliding</span><span class=\"p\">);</span>\n<span class=\"p\">}</span></code></pre> \n</figure> \n<p>This is nothing fancy, all we have is some methods calling each other. Here’s the scary result of those <code class=\"language-plaintext highlighter-rouge\">LocalCache.OnLogDuration</code> calls:</p> \n<ul> \n <li>LocalCache.Set: 3600</li> \n <li>LocalCache.SetWithPriority: 3600</li> \n <li>RawSet: <em>null</em>, or 114, or 97, or some other seemingly random value</li> \n</ul> \n<p>Here’s an example test run from <a href=\"https://github.com/StackExchange/RyuJIT-TailCallBug\">the GitHub repo</a>: <a href=\"https://nickcraver.com/blog/content/Blog-RyuJIT-Results.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/Blog-RyuJIT-Results.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/Blog-RyuJIT-Results.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/Blog-RyuJIT-Results.png\" loading=\"lazy\" alt=\"RyuJIT Tail Tests\" /> \n  </picture></a></p> \n<p><strong>The method we called did not get the parameters we passed</strong>. That’s it. The net result of this is that local cache (which we use <em>very</em> heavily) is either unreliable or non-existent. This would add a tremendous amount of load to our entire infrastructure, making Stack Overflow much slower and likely leading to a full outage.</p> \n<p>That’s not why we’re telling you about this though. Let’s step back and look at the big picture. What are some other variable names we could use?</p> \n<ul> \n <li><code class=\"language-plaintext highlighter-rouge\">amountToWithdraw</code></li> \n <li><code class=\"language-plaintext highlighter-rouge\">qtyOfStockToBuy</code></li> \n <li><code class=\"language-plaintext highlighter-rouge\">carbonCopyToAccountId</code></li> \n <li><code class=\"language-plaintext highlighter-rouge\">voltage</code></li> \n <li><code class=\"language-plaintext highlighter-rouge\">targetAltitude</code></li> \n <li><code class=\"language-plaintext highlighter-rouge\">rotorVelocity</code></li> \n <li><code class=\"language-plaintext highlighter-rouge\">oxygenPressure</code></li> \n <li><code class=\"language-plaintext highlighter-rouge\">dosageMilliliters</code></li> \n</ul> \n<p>Does that help put things in perspective?</p> \n<p>This bug is not obvious for several reasons:</p> \n<ul> \n <li>It only happens with optimizations enabled. For most developers and projects, that’s not in <code class=\"language-plaintext highlighter-rouge\">DEBUG</code> and won’t show locally. \n  <ul> \n   <li>That means you’ll only see this in <code class=\"language-plaintext highlighter-rouge\">RELEASE</code>, which for most people is <strong>only production</strong>.</li> \n  </ul> </li> \n <li>Attaching a debugger alters the behavior. This almost always hides the issue.</li> \n <li>Adding a <code class=\"language-plaintext highlighter-rouge\">Debug.WriteLine()</code> will often fix the issue because of the tail change.</li> \n <li>It won’t reproduce in certain scenarios (e.g. we can’t repro this in a console application or VS hosting, only IIS).</li> \n <li>Given the nature of the bug, as far as we can tell, it can equally affect any framework library as well.</li> \n <li>It can happen in a NuGet library (most of which are <code class=\"language-plaintext highlighter-rouge\">RELEASE</code>); the issue may not be in your code at all.</li> \n</ul> \n<p>To address an obvious question: is this a security issue? Answer: it can be. It’s not something you could actively exploit in almost all cases, since stack variables are the things being swapped around here. However, it can be an issue indirectly. For example, if your code makes an assumption with a <code class=\"language-plaintext highlighter-rouge\">null</code> param like <code class=\"language-plaintext highlighter-rouge\">if (user == null) { user = SystemUser; }</code>, then a <code class=\"language-plaintext highlighter-rouge\">null</code> passed in will certainly be a problem, giving other users that access sporadically. A more common example of this would be a value for a <code class=\"language-plaintext highlighter-rouge\">Role</code> enum being passed incorrectly.</p> \n<h2 id=\"recommendations\">Recommendations</h2> \n<ol> \n <li>Do not install .Net 4.6 in production.</li> \n <li>If you have installed .Net 4.6, disable RyuJIT immediately (<strong>this is a temporary fix and should be removed when an update is released</strong>). You can disable RyuJIT via a registry setting (note: this requires an application pool recycle to take effect). \n  <ul> \n   <li>Under <code class=\"language-plaintext highlighter-rouge\">HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\.NETFramework</code> add a <code class=\"language-plaintext highlighter-rouge\">useLegacyJit</code> <code class=\"language-plaintext highlighter-rouge\">DWORD</code> with a value of <code class=\"language-plaintext highlighter-rouge\">1</code></li> \n   <li>Or via PowerShell:</li> \n  </ul> </li> \n</ol> \n<figure class=\"highlight\"> \n <pre><code class=\"language-powershell\" data-lang=\"powershell\"><span class=\"nf\">Set-ItemProperty</span><span class=\"w\"> </span><span class=\"nt\">-Path</span><span class=\"w\"> </span><span class=\"nx\">HKLM:\\Software\\Microsoft\\.NETFramework</span><span class=\"w\"> </span><span class=\"nt\">-Name</span><span class=\"w\"> </span><span class=\"nx\">useLegacyJit</span><span class=\"w\"> </span><span class=\"nt\">-Type</span><span class=\"w\"> </span><span class=\"nx\">DWord</span><span class=\"w\"> </span><span class=\"nt\">-Value</span><span class=\"w\"> </span><span class=\"nx\">1</span></code></pre> \n</figure> \n<p>Be aware, <a href=\"https://github.com/Microsoft/dotnet/blob/master/docs/testing-with-ryujit.md\">the <code class=\"language-plaintext highlighter-rouge\">web.config</code> method (#3)</a> of disabling RyuJIT <strong>does not work</strong>. Outside of IIS hosting, applying this fix via <code class=\"language-plaintext highlighter-rouge\">app.config</code> <em>does</em> work.</p> \n<p>We are talking with and pushing Microsoft to get a fix for this shipped ASAP. We recognize releasing a fix for .Net on the Microsoft side isn’t a small deal. Our disclosure is prompted by the reality that a fix cannot be released, distributed, and applied immediately.</p>","descriptionType":"text/html","publishedDate":"Mon, 27 Jul 2015 00:00:00 +0000","feedId":12609,"bgimg":"https://nickcraver.com/blog/content/Blog-RyuJIT-Results.png","linkMd5":"72dfcd52e6f4cf3a40b6d3fd11274c3b","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn9@2020_2/2020/08/25/02-05-18-341_81c0c503cc9fc87c.webp","destWidth":1678,"destHeight":510,"sourceBytes":44579,"destBytes":98316,"author":"","articleImgCdnMap":{"https://nickcraver.com/blog/content/Blog-RyuJIT-Results.png":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn9@2020_2/2020/08/25/02-05-18-341_81c0c503cc9fc87c.webp"},"publishedOrCreatedDate":1598321095272},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"Stack Overflow: The Architecture - 2016 Edition","link":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","description":"<blockquote> \n <p>This is #1 in a <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">very long series of posts</a> on Stack Overflow’s architecture. Welcome. Previous post (#0): <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">Stack Overflow: A Technical Deconstruction</a> Next post (#2): <a href=\"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/\">Stack Overflow: The Hardware - 2016 Edition</a></p> \n</blockquote> \n<p>To get an idea of what all of this stuff “does,” let me start off with an update on the average day at Stack Overflow. So you can compare to the <a href=\"https://nickcraver.com/blog/2013/11/22/what-it-takes-to-run-stack-overflow/\">previous numbers from November 2013</a>, here’s a day of statistics from February 9th, 2016 with differences since November 12th, 2013:</p> \n<ul> \n <li><strong>209,420,973</strong> <span class=\"note\">(+61,336,090)</span> HTTP requests to our load balancer</li> \n <li><strong>66,294,789</strong> <span class=\"note\">(+30,199,477)</span> of those were page loads</li> \n <li><strong>1,240,266,346,053</strong> <span class=\"note\">(+406,273,363,426)</span> bytes (1.24 TB) of HTTP traffic sent</li> \n <li><strong>569,449,470,023</strong> <span class=\"note\">(+282,874,825,991)</span> bytes (569 GB) total received</li> \n <li><strong>3,084,303,599,266</strong> <span class=\"note\">(+1,958,311,041,954)</span> bytes (3.08 TB) total sent</li> \n <li><strong>504,816,843</strong> <span class=\"note\">(+170,244,740)</span> SQL Queries (from HTTP requests alone)</li> \n <li><strong>5,831,683,114</strong> <span class=\"note\">(+5,418,818,063)</span> Redis hits</li> \n <li><strong>17,158,874</strong> <span class=\"note\">(not tracked in 2013)</span> Elastic searches</li> \n <li><strong>3,661,134</strong> <span class=\"note\">(+57,716)</span> Tag Engine requests</li> \n <li><strong>607,073,066</strong> <span class=\"note\">(+48,848,481)</span> ms (168 hours) spent running SQL queries</li> \n <li><strong>10,396,073</strong> <span class=\"note\">(-88,950,843)</span> ms (2.8 hours) spent on Redis hits</li> \n <li><strong>147,018,571</strong> <span class=\"note\">(+14,634,512)</span> ms (40.8 hours) spent on Tag Engine requests</li> \n <li><strong>1,609,944,301</strong> <span class=\"note\">(-1,118,232,744)</span> ms (447 hours) spent processing in ASP.Net</li> \n <li><strong>22.71</strong> <span class=\"note\">(-5.29)</span> ms average (19.12 ms in ASP.Net) for 49,180,275 question page renders</li> \n <li><strong>11.80</strong> <span class=\"note\">(-53.2)</span> ms average (8.81 ms in ASP.Net) for 6,370,076 home page renders</li> \n</ul> \n<p>You may be wondering about the drastic ASP.Net reduction in processing time compared to 2013 (which was 757 hours) despite 61 million more requests a day. That’s due to both <a href=\"http://blog.serverfault.com/2015/03/05/how-we-upgrade-a-live-data-center/\">a hardware upgrade in early 2015</a> as well as a lot of performance tuning inside the applications themselves. Please don’t forget: <a href=\"https://blog.codinghorror.com/performance-is-a-feature/\">performance is still a feature</a>. If you’re curious about more hardware specifics than I’m about to provide—fear not. The next post will be an appendix with detailed hardware specs for all of the servers that run the sites (I’ll update this with a link when it’s live). \n <!--more--></p> \n<p>So what’s changed in the last 2 years? Besides replacing some servers and network gear, not much. Here’s a top-level list of hardware that runs the sites today (noting what’s different since 2013):</p> \n<ul> \n <li>4 Microsoft SQL Servers (new hardware for 2 of them)</li> \n <li>11 IIS Web Servers (new hardware)</li> \n <li>2 <a href=\"https://redis.io/\">Redis</a> Servers (new hardware)</li> \n <li>3 Tag Engine servers (new hardware for 2 of the 3)</li> \n <li>3 <a href=\"https://www.elastic.co/\">Elasticsearch</a> servers (same)</li> \n <li>4 <a href=\"https://www.haproxy.org/\">HAProxy</a> Load Balancers (added 2 to support CloudFlare)</li> \n <li>2 Networks (each a <a href=\"https://www.cisco.com/c/en/us/products/collateral/switches/nexus-5000-series-switches/data_sheet_c78-618603.html\">Nexus 5596 Core</a> + <a href=\"https://www.cisco.com/c/en/us/products/switches/nexus-2232tm-10ge-fabric-extender/index.html\">2232TM Fabric Extenders</a>, upgraded to 10Gbps everywhere)</li> \n <li>2 Fortinet <a href=\"https://www.fortinet.com/products/firewalls/firewall/fortigate-mid-range.html\">800C</a> Firewalls (replaced Cisco 5525-X ASAs)</li> \n <li>2 Cisco <a href=\"https://www.cisco.com/c/en/us/products/routers/asr-1001-router/index.html\">ASR-1001</a> Routers (replaced Cisco 3945 Routers)</li> \n <li>2 Cisco <a href=\"https://www.cisco.com/c/en/us/products/routers/asr-1001-x-router/index.html\">ASR-1001-x</a> Routers (new!)</li> \n</ul> \n<p>What do we <strong><em>need</em></strong> to run Stack Overflow? <a href=\"https://nickcraver.com/blog/2013/11/22/what-it-takes-to-run-stack-overflow/#core-hardware\">That hasn’t changed much since 2013</a>, but due to the optimizations and new hardware mentioned above, we’re down to <strong><em>needing</em></strong> only 1 web server. We have unintentionally tested this, successfully, a few times. To be clear: I’m saying it works. I’m not saying it’s a good idea. It’s fun though, every time.</p> \n<p>Now that we have some baseline numbers for an idea of scale, let’s see how we make those fancy web pages. Since few systems exist in complete isolation (and ours is no exception), architecture decisions often make far less sense without a bigger picture of how those pieces fit into the whole. That’s the goal here, to cover the big picture. Many <a href=\"https://trello.com/b/0zgQjktX/blog-post-queue-for-stack-overflow-topics\">subsequent posts</a> will do deep dives into specific areas. This will be a logistical overview with hardware highlights only; the next post will have the hardware details.</p> \n<p>For those of you here to see what the hardware looks like these days, here are a few pictures I took of rack A (it has a matching sister rack B) during <a href=\"http://blog.serverfault.com/2015/03/05/how-we-upgrade-a-live-data-center/\">our February 2015 upgrade</a>:</p> \n<div style=\"text-align: center;\"> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Top.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture/SO-Architecture-RackB-Top.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Architecture/SO-Architecture-RackB-Top.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Top.jpg\" alt=\"Rack B - Top\" style=\"width:384px;height:512px;padding:5px;\" /> \n   </picture></a> <a href=\"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Bottom.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture/SO-Architecture-RackB-Bottom.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Architecture/SO-Architecture-RackB-Bottom.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Bottom.jpg\" alt=\"Rack B - Bottom\" style=\"width:384px;height:512px;padding:5px;\" /> \n   </picture></a></p> \n</div> \n<p>…and if you’re into that kind of thing, <a href=\"https://imgur.com/a/X1HoY\">here’s the entire 256 image album from that week</a> (you’re damn right that number’s intentional). Now, let’s dig into layout. Here’s a logical overview of the major systems in play:</p> \n<p><img src=\"https://nickcraver.com/blog/content/SO-Architecture-Overview-Logical.svg\" alt=\"Logical Overview\" /></p> \n<h3 id=\"ground-rules\">Ground Rules</h3> \n<p>Here are some rules that apply globally so I don’t have to repeat them with every setup:</p> \n<ul> \n <li>Everything is redundant.</li> \n <li>All servers and network gear have at least 2x 10Gbps connectivity.</li> \n <li>All servers have 2 power feeds via 2 power supplies from 2 UPS units backed by 2 generators and 2 utility feeds.</li> \n <li>All servers have a redundant partner between rack A and B.</li> \n <li>All servers and services are doubly redundant via another data center (Colorado), though I’m mostly talking about New York here.</li> \n <li>Everything is redundant.</li> \n</ul> \n<h3 id=\"the-internets\">The Internets</h3> \n<p>First, you have to find us—that’s <a href=\"https://en.wikipedia.org/wiki/Domain_Name_System\">DNS</a>. Finding us needs to be fast, so we farm this out to <a href=\"https://www.cloudflare.com/\">CloudFlare</a> (currently) because they have DNS servers nearer to almost everyone around the world. We update our DNS records via an API and they do the “hosting” of DNS. But since we’re jerks with deeply-rooted trust issues, we still have our own DNS servers as well. Should the apocalypse happen (probably caused by the GPL, <a href=\"https://twitter.com/JasonPunyon\">Punyon</a>, or caching) and people still want to program to take their mind off of it, we’ll flip them on.</p> \n<p>After you find our secret hideout, HTTP traffic comes from one of our four ISPs (Level 3, Zayo, Cogent, and Lightower in New York) and flows through one of our four edge routers. We peer with our ISPs using <a href=\"https://en.wikipedia.org/wiki/Border_Gateway_Protocol\">BGP</a> (fairly standard) in order to control the flow of traffic and provide several avenues for traffic to reach us most efficiently. These <a href=\"https://www.cisco.com/c/en/us/products/routers/asr-1001-router/index.html\">ASR-1001</a> and <a href=\"https://www.cisco.com/c/en/us/products/routers/asr-1001-x-router/index.html\">ASR-1001-X</a> routers are in 2 pairs, each servicing 2 ISPs in active/active fashion—so we’re redundant here. Though they’re all on the same physical 10Gbps network, external traffic is in separate isolated external <a href=\"https://en.wikipedia.org/wiki/Virtual_LAN\">VLANs</a> which the load balancers are connected to as well. After flowing through the routers, you’re headed for a load balancer.</p> \n<p>I suppose this may be a good time to mention we have a 10Gbps <a href=\"https://en.wikipedia.org/wiki/Multiprotocol_Label_Switching\">MPLS</a> between our 2 data centers, but it is not directly involved in serving the sites. We use this for data replication and quick recovery in the cases where we need a burst. “But Nick, that’s not redundant!” Well, you’re technically correct (<a href=\"https://www.youtube.com/watch?v=hou0lU8WMgo\">the best kind of correct</a>), that’s a single point of failure on its face. But wait! We maintain 2 more failover <a href=\"https://en.wikipedia.org/wiki/Open_Shortest_Path_First\">OSPF</a> routes (the MPLS is #1, these are #2 and 3 by cost) via our ISPs. Each of the sets mentioned earlier connects to the corresponding set in Colorado, and they load balance traffic between in the failover situation. We could make both sets connect to both sets and have 4 paths but, well, whatever. Moving on.</p> \n<h3 id=\"load-balancers-haproxy\">Load Balancers (HAProxy)</h3> \n<p>The load balancers are running <a href=\"https://www.haproxy.org/\">HAProxy</a> 1.5.15 on <a href=\"https://www.centos.org/\">CentOS 7</a>, our preferred flavor of Linux. TLS (SSL) traffic is also terminated in HAProxy. We’ll be looking hard at HAProxy 1.7 soon for <a href=\"https://en.wikipedia.org/wiki/HTTP/2\">HTTP/2</a> support.</p> \n<p>Unlike all other servers with a dual 10Gbps LACP network link, each load balancer has 2 pairs of 10Gbps: one for the external network and one for the DMZ. These boxes run 64GB or more of memory to more efficiently handle SSL negotiation. When we can cache more TLS sessions in memory for reuse, there’s less to recompute on subsequent connections to the same client. This means we can resume sessions both faster and cheaper. Given that RAM is pretty cheap dollar-wise, it’s an easy choice.</p> \n<p>The load balancers themselves are a pretty simple setup. We listen to different sites on various IPs (mostly for certificate concerns and DNS management) and route to various backends based mostly on the host header. The only things of note we do here is rate limiting and some header captures (sent from our web tier) into the <a href=\"https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#3.1-log\">HAProxy syslog message</a> so we can record performance metrics for every single request. We’ll <a href=\"https://trello.com/c/1Oc9cC6u/11-monitoring\">cover that later too</a>.</p> \n<h3 id=\"web-tier-iis-85-aspnet-mvc-523-and-net-461\">Web Tier (IIS 8.5, ASP.Net MVC 5.2.3, and .Net 4.6.1)</h3> \n<p>The load balancers feed traffic to 9 servers we refer to as “primary” (01-09) and 2 “dev/meta” (10-11, our staging environment) web servers. The primary servers run things like Stack Overflow, Careers, and all Stack Exchange sites except <a href=\"https://meta.stackoverflow.com/\">meta.stackoverflow.com</a> and <a href=\"https://meta.stackexchange.com/\">meta.stackexchange.com</a>, which run on the last 2 servers. The primary Q&amp;A Application itself is multi-tenant. This means that a single application serves the requests for all Q&amp;A sites. Put another way: we can run the entire Q&amp;A network off of a single application pool on a single server. Other applications like Careers, API v2, Mobile API, etc. are separate. Here’s what the primary and dev tiers look like in IIS:</p> \n<div style=\"text-align: center;\"> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB01.png\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture-IIS-NY-WEB01.webp\" /> \n    <source type=\"image/png\" srcset=\"/blog/content/SO-Architecture-IIS-NY-WEB01.png\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB01.png\" loading=\"lazy\" alt=\"IIS in NY-WEB01\" /> \n   </picture></a> <a href=\"https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB10.png\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture-IIS-NY-WEB10.webp\" /> \n    <source type=\"image/png\" srcset=\"/blog/content/SO-Architecture-IIS-NY-WEB10.png\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB10.png\" loading=\"lazy\" alt=\"IIS in NY-WEB10\" /> \n   </picture></a></p> \n</div> \n<p>Here’s what Stack Overflow’s distribution across the web tier looks like in <a href=\"https://github.com/Opserver/Opserver\">Opserver</a> (our internal monitoring dashboard):</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Architecture-Opserver-HAProxy.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture-Opserver-HAProxy.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Architecture-Opserver-HAProxy.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Architecture-Opserver-HAProxy.png\" loading=\"lazy\" alt=\"HAProxy in Opserver\" /> \n  </picture></a></p> \n<p>…and here’s what those web servers look like from a utilization perspective:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Architecture-Opserver-WebTier.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture-Opserver-WebTier.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Architecture-Opserver-WebTier.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Architecture-Opserver-WebTier.png\" loading=\"lazy\" alt=\"Web Tier in Opserver\" /> \n  </picture></a></p> \n<p>I’ll go into why we’re so overprovisioned in future posts, but the highlight items are: rolling builds, headroom, and redundancy.</p> \n<h3 id=\"service-tier-iis-aspnet-mvc-523-net-461-and-httpsys\">Service Tier (IIS, ASP.Net MVC 5.2.3, .Net 4.6.1, and HTTP.SYS)</h3> \n<p>Behind those web servers is the very similar “service tier.” It’s also running IIS 8.5 on Windows 2012R2. This tier runs internal services to support the production web tier and other internal systems. The two big players here are “Stack Server” which runs the tag engine and is based on <code class=\"language-plaintext highlighter-rouge\">http.sys</code> (not behind IIS) and the Providence API (IIS-based). Fun fact: I have to set affinity on each of these 2 processes to land on separate sockets because Stack Server just steamrolls the L2 and L3 cache when refreshing question lists on a 2-minute interval.</p> \n<p>These service boxes do heavy lifting with the tag engine and backend APIs where we need redundancy, but not 9x redundancy. For example, loading all of the posts and their tags that change every <code class=\"language-plaintext highlighter-rouge\">n</code> minutes from the database (currently 2) isn’t that cheap. We don’t want to do that load 9 times on the web tier; 3 times is enough and gives us enough safety. We also configure these boxes differently on the hardware side to be better optimized for the different computational load characteristics of the tag engine and elastic indexing jobs (which also run here). The “tag engine” is a relatively complicated topic in itself and will be a <a href=\"https://trello.com/c/DqklJDSF/29-tag-engine\">dedicated post</a>. The basics are: when you visit <code class=\"language-plaintext highlighter-rouge\">/questions/tagged/java</code>, you’re hitting the tag engine to see which questions match. It does <em>all</em> of our tag matching outside of <code class=\"language-plaintext highlighter-rouge\">/search</code>, so the <a href=\"https://meta.stackoverflow.com/questions/308875/new-navigation-release-candidate\">new navigation</a>, etc. are all using this service for data.</p> \n<h3 id=\"cache--pubsub-redis\">Cache &amp; Pub/Sub (Redis)</h3> \n<p>We use <a href=\"https://Redis.io/\">Redis</a> for a few things here and it’s rock solid. Despite doing about 160 billion ops a month, every instance is below 2% CPU. Usually much lower:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Architecture-Redis-Utilization.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture-Redis-Utilization.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Architecture-Redis-Utilization.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Architecture-Redis-Utilization.png\" loading=\"lazy\" alt=\"Redis in Bosun\" /> \n  </picture></a></p> \n<p>We have an L1/L2 cache system with Redis. “L1” is HTTP Cache on the web servers or whatever application is in play. “L2” is falling back to Redis and fetching the value out. Our values are stored in the <a href=\"https://developers.google.com/protocol-buffers/\">Protobuf format</a>, via <a href=\"https://github.com/mgravell/protobuf-net\">protobuf-dot-net</a> by Marc Gravell. For a client, we’re using <a href=\"https://github.com/StackExchange/StackExchange.Redis\">StackExchange.Redis</a>—written in-house and open source. When one web server gets a cache miss in both L1 and L2, it fetches the value from source (a database query, API call, etc.) and puts the result in both local cache and Redis. The next server wanting the value may miss L1, but would find the value in L2/Redis, saving a database query or API call.</p> \n<p>We also run many Q&amp;A sites, so each site has its own L1/L2 caching: by key prefix in L1 and by database ID in L2/Redis. We’ll go deeper on this in a <a href=\"https://trello.com/c/OztwfkG7/16-caching-Redis\">future post</a>.</p> \n<p>Alongside the 2 main Redis servers (master/slave) that run all the site instances, we also have a machine learning instance slaved across 2 more dedicated servers (due to memory). This is used for recommending questions on the home page, better matching to jobs, etc. It’s a platform called Providence, <a href=\"https://kevinmontrose.com/2015/01/27/providence-machine-learning-at-stack-exchange/\">covered by Kevin Montrose here</a>.</p> \n<p>The main Redis servers have 256GB of RAM (about 90GB in use) and the Providence servers have 384GB of RAM (about 125GB in use).</p> \n<p>Redis isn’t just for cache though, it also has a publish &amp; subscriber mechanism where one server can publish a message and all other subscribers receive it—including downstream clients on Redis slaves. We use this mechanism to clear L1 caches on other servers when one web server does a removal for consistency, but there’s another great use: websockets.</p> \n<h3 id=\"websockets-httpsgithubcomstackexchangenetgain\">Websockets (https://github.com/StackExchange/NetGain)</h3> \n<p>We use websockets to push real-time updates to users such as notifications in the top bar, vote counts, <a href=\"https://meta.stackoverflow.com/questions/308875/new-navigation-release-candidate\">new nav</a> counts, new answers and comments, and a few other bits.</p> \n<p>The socket servers themselves are using raw sockets running on the web tier. It’s a very thin application on top of our open source library: <a href=\"https://github.com/StackExchange/NetGain\"><code class=\"language-plaintext highlighter-rouge\">StackExchange.NetGain</code></a>. During peak, we have about 500,000 <strong>concurrent</strong> websocket connections open. That’s a lot of browsers. Fun fact: some of those browsers have been open for over 18 months. We’re not sure why. Someone should go check if those developers are still alive. Here’s what this week’s concurrent websocket pattern looks like:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Architecture-Bosun-Websockets.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture-Bosun-Websockets.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Architecture-Bosun-Websockets.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Architecture-Bosun-Websockets.png\" loading=\"lazy\" alt=\"Websocket connection counts from Bosun\" /> \n  </picture></a></p> \n<p>Why websockets? They’re tremendously more efficient than polling at our scale. We can simply push more data with fewer resources this way, while being more instant to the user. They’re not without issues though—ephemeral port and file handle exhaustion on the load balancer are fun issues <a href=\"https://trello.com/c/7nv66g78/58-websockets\">we’ll cover later</a>.</p> \n<h3 id=\"search-elasticsearch\">Search (Elasticsearch)</h3> \n<p>Spoiler: there’s not a lot to get excited about here. The web tier is doing pretty vanilla searches against <a href=\"https://www.elastic.co/products/elasticsearch\">Elasticsearch</a> 1.4, using the very slim high-performance <code class=\"language-plaintext highlighter-rouge\">StackExchange.Elastic</code> client. Unlike most things, we have no plans to open source this simply because it only exposes a very slim subset of the API we use. I strongly believe releasing it would do more harm than good with developer confusion. We’re using elastic for <code class=\"language-plaintext highlighter-rouge\">/search</code>, calculating related questions, and suggestions when asking a question.</p> \n<p>Each Elastic cluster (there’s one in each data center) has 3 nodes, and each site has its own index. Careers has an additional few indexes. What makes our setup a little non-standard in the elastic world: our 3 server clusters are a bit beefier than average with all SSD storage, 192GB of RAM, and dual 10Gbps network each.</p> \n<p>The same application domains (yeah, we’re screwed with .Net Core here…) in Stack Server that host the tag engine also continually index items in Elasticsearch. We do some simple tricks here such as <a href=\"https://msdn.microsoft.com/en-us/library/ms182776.aspx\"><code class=\"language-plaintext highlighter-rouge\">ROWVERSION</code> in SQL Server</a> (the data source) compared against a “last position” document in Elastic. Since it behaves like a sequence, we can simply grab and index any items that have changed since the last pass.</p> \n<p>The main reason we’re on Elasticsearch instead of something like SQL full-text search is scalability and better allocation of money. SQL CPUs are comparatively very expensive, Elastic is cheap and has far more features these days. Why not <a href=\"https://lucene.apache.org/solr/\">Solr</a>? We want to search across the entire network (many indexes at once), and this wasn’t supported at decision time. The reason we’re not on 2.x yet is <a href=\"https://github.com/elastic/elasticsearch/issues/8870\">a major change to “types”</a> means we need to reindex everything to upgrade. I just don’t have enough time to make the needed changes and migration plan yet.</p> \n<h3 id=\"databases-sql-server\">Databases (SQL Server)</h3> \n<p>We’re using SQL Server as our <a href=\"https://en.wikipedia.org/wiki/Single_source_of_truth\">single source of truth</a>. All data in Elastic and Redis comes from SQL Server. We run 2 SQL Server clusters with <a href=\"https://msdn.microsoft.com/en-us/library/hh510230.aspx\">AlwaysOn Availability Groups</a>. Each of these clusters has 1 master (taking almost all of the load) and 1 replica in New York. Additionally, they have 1 replica in Colorado (our DR data center). All replicas are asynchronous.</p> \n<p>The first cluster is a set of Dell R720xd servers, each with 384GB of RAM, 4TB of PCIe SSD space, and 2x 12 cores. It hosts the Stack Overflow, Sites (bad name, I’ll explain later), PRIZM, and Mobile databases.</p> \n<p>The second cluster is a set of Dell R730xd servers, each with 768GB of RAM, 6TB of PCIe SSD space, and 2x 8 cores. This cluster runs <em>everything else</em>. That list includes <a href=\"https://talent.stackoverflow.com\">Talent</a>, <a href=\"https://openid.stackexchange.com/\">Open ID</a>, <a href=\"https://chat.stackoverflow.com/\">Chat</a>, <a href=\"https://github.com/NickCraver/StackExchange.Exceptional\">our Exception log</a>, and every other Q&amp;A site (e.g. <a href=\"https://superuser.com/\">Super User</a>, <a href=\"https://serverfault.com/\">Server Fault</a>, etc.).</p> \n<p>CPU utilization on the database tier is something we like to keep very low, but it’s actually a little high at the moment due to some plan cache issues we’re addressing. As of right now, NY-SQL02 and 04 are masters, 01 and 03 are replicas we just restarted today during some SSD upgrades. Here’s what the past 24 hours looks like:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Architecture-Opserver-DBTier.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Architecture-Opserver-DBTier.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Architecture-Opserver-DBTier.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Architecture-Opserver-DBTier.png\" loading=\"lazy\" alt=\"DB Tier in Opserver\" /> \n  </picture></a></p> \n<p>Our usage of SQL is pretty simple. Simple is fast. Though some queries can be crazy, our interaction with SQL itself is fairly vanilla. We have some legacy <a href=\"https://msdn.microsoft.com/en-us/library/bb425822.aspx\">Linq2Sql</a>, but all new development is using <a href=\"https://github.com/StackExchange/dapper-dot-net\">Dapper</a>, our open source Micro-ORM using <a href=\"https://en.wikipedia.org/wiki/Plain_Old_CLR_Object\">POCOs</a>. Let me put this another way: Stack Overflow has only 1 stored procedure in the database and I intend to move that last vestige into code.</p> \n<h3 id=\"libraries\">Libraries</h3> \n<p>Okay, let’s change gears to something that can more directly help <em>you</em>. I’ve mentioned a few of these up above, but I’ll provide a list here of many open-source .Net libraries we maintain for the world to use. We open sourced them because they have no core business value but can help the world of developers. I hope you find these useful today:</p> \n<ul> \n <li><a href=\"https://github.com/StackExchange/dapper-dot-net\">Dapper</a> (.Net Core) - High-performance Micro-ORM for ADO.Net</li> \n <li><a href=\"https://github.com/StackExchange/StackExchange.Redis\">StackExchange.Redis</a> - High-performance Redis client</li> \n <li><a href=\"http://miniprofiler.com/\">MiniProfiler</a> - Lightweight profiler we run on every page (also supports Ruby, Go, and Node)</li> \n <li><a href=\"https://github.com/NickCraver/StackExchange.Exceptional\">Exceptional</a> - Error logger for SQL, JSON, MySQL, etc.</li> \n <li><a href=\"https://github.com/kevin-montrose/Jil\">Jil</a> - High-performance JSON (de)serializer</li> \n <li><a href=\"https://github.com/kevin-montrose/sigil\">Sigil</a> - A .Net CIL generation helper (for when C# isn’t fast enough)</li> \n <li><a href=\"https://github.com/StackExchange/NetGain\">NetGain</a> - High-performance websocket server</li> \n <li><a href=\"https://github.com/opserver/Opserver/tree/overhaul\">Opserver</a> - Monitoring dashboard polling most systems directly and feeding from Orion, Bosun, or WMI as well.</li> \n <li><a href=\"https://bosun.org/\">Bosun</a> - Backend monitoring system, written in Go</li> \n</ul> \n<p>Next up is a detailed current hardware list of what runs our code. After that, we go down <a href=\"https://trello.com/b/0zgQjktX/blog-post-queue-for-stack-overflow-topics\">the list</a>. Stay tuned.</p>","descriptionType":"text/html","publishedDate":"Wed, 17 Feb 2016 00:00:00 +0000","feedId":12609,"bgimg":"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Top.jpg","linkMd5":"40aa1cb2c085d883e8930442ece834ff","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn5@2020_4/2020/08/25/02-05-18-630_470488dce2bcaea7.webp","destWidth":768,"destHeight":1024,"sourceBytes":194380,"destBytes":134644,"author":"","articleImgCdnMap":{"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Top.jpg":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn5@2020_4/2020/08/25/02-05-18-630_470488dce2bcaea7.webp","https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Bottom.jpg":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn73@2020_1/2020/08/25/02-05-21-695_f956f2b6f72766df.webp","https://nickcraver.com/blog/content/SO-Architecture-Overview-Logical.svg":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn33@2020_3/2020/08/25/02-05-21-398_af9ac7c2b502957a.svg","https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB01.png":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn5@2020_2/2020/08/25/02-05-21-451_ef1ceabaff6d76a9.webp","https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB10.png":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn13@2020_4/2020/08/25/02-05-21-804_068063319ad86357.webp","https://nickcraver.com/blog/content/SO-Architecture-Opserver-HAProxy.png":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn49@2020_6/2020/08/25/02-05-20-393_6b8bed0261b3d6a5.webp","https://nickcraver.com/blog/content/SO-Architecture-Opserver-WebTier.png":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn22@2020_4/2020/08/25/02-05-21-585_9a2d465d33cbfdf1.webp","https://nickcraver.com/blog/content/SO-Architecture-Redis-Utilization.png":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn65@2020_3/2020/08/25/02-05-21-908_23ddf3f177675c59.webp","https://nickcraver.com/blog/content/SO-Architecture-Bosun-Websockets.png":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn38@2020_6/2020/08/25/02-05-20-170_046a4a8d649c3d28.webp","https://nickcraver.com/blog/content/SO-Architecture-Opserver-DBTier.png":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn34@2020_1/2020/08/25/02-05-22-472_4cfcd7289a615678.webp"},"publishedOrCreatedDate":1598321095269},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"Stack Overflow: The Hardware - 2016 Edition","link":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","description":"<blockquote> \n <p>This is #2 in a <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">very long series of posts</a> on Stack Overflow’s architecture.<br /> Previous post (#1): <a href=\"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/\">Stack Overflow: The Architecture - 2016 Edition</a><br /> Next post (#3): <a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/\">Stack Overflow: How We Do Deployment - 2016 Edition</a></p> \n</blockquote> \n<p>Who loves hardware? Well, I do and this is my blog so I win. If you <em>don’t</em> love hardware then I’d go ahead and close the browser.</p> \n<p>Still here? Awesome. Or your browser is crazy slow, in which case you should think about some new hardware.</p> \n<p>I’ve repeated many, <em>many</em> times: <strong><a href=\"https://blog.codinghorror.com/performance-is-a-feature/\">performance is a feature</a></strong>. Since your code is only as fast as the hardware it runs on, the hardware definitely matters. Just like any other platform, Stack Overflow’s architecture comes in layers. Hardware is the foundation layer for us, and having it in-house affords us many luxuries not available in other scenarios…like running on someone else’s servers. It also comes with direct and indirect costs. But that’s not the point of this post, <a href=\"https://trello.com/c/4e6TOnA7/87-on-prem-vs-aws-azure-etc-why-the-cloud-isn-t-for-us\">that comparison will come later</a>. For now, I want to provide a detailed inventory of our infrastructure for reference and comparison purposes. And pictures of servers. Sometimes naked servers. This web page could have loaded much faster, but I couldn’t help myself.</p> \n<p>In many posts through this series I will give a lot of numbers and specs. When I say “our SQL server utilization is almost always at 5–10% CPU,” well, that’s great. But, 5–10% <em>of what?</em> That’s when we need a point of reference. This hardware list is meant to both answer those questions and serve as a source for comparison when looking at other platforms and what utilization may look like there, how much capacity to compare to, etc. \n <!--more--></p> \n<h2 id=\"how-we-do-hardware\">How We Do Hardware</h2> \n<p>Disclaimer: I don’t do this alone. George Beech (<a href=\"https://twitter.com/GABeech\">@GABeech</a>) is my main partner in crime when speccing hardware here at Stack. We carefully spec out each server for its intended purpose. What we don’t do is order in bulk and assign tasks later. We’re not alone in this process though; you have to know what’s going to run on the hardware to spec it optimally. We’ll work with the developer(s) and/or other site reliability engineers to best accommodate what is intended live on the box.</p> \n<p>We’re also looking at what’s best <em>in the system</em>. Each server is not an island. How it fits into the overall architecture is definitely a consideration. What services can share this platform? This data store? This log system? There is inherent value in managing fewer things, or at least fewer variations of anything.</p> \n<p>When we spec out our hardware, we look at a myriad of requirements that help determine what to order. I’ve never really written this mental checklist down, so let’s give it a shot:</p> \n<ul> \n <li>Is this a scale up or scale out problem? (Are we buying one bigger machine or a few smaller ones?) \n  <ul> \n   <li>How much redundancy do we need/want? (How much headroom and failover capability?)</li> \n  </ul> </li> \n <li>Storage: \n  <ul> \n   <li>Will this server/application touch disk? (Do we need anything besides the spinny OS drives?) \n    <ul> \n     <li>If so, how much? (How much bandwidth? How many small files? Does it need SSDs?)</li> \n     <li>If SSDs, what’s the write load? (Are we talking Intel S3500/3700s? P360x? P3700s?) \n      <ul> \n       <li>How much SSD capacity do we need? (And should it be a 2-tier solution with HDDs as well?)</li> \n       <li>Is this data totally transient? (Are SSDs without capacitors, which are far cheaper, a better fit?)</li> \n      </ul> </li> \n    </ul> </li> \n   <li>Will the storage needs likely expand? (Do we get a 1U/10-bay server or a 2U/26-bay server?)</li> \n   <li>Is this a data warehouse type scenario? (Are we looking at 3.5” drives? If so, in a 12 or 16 drives per 2U chassis?) \n    <ul> \n     <li>Is the storage trade-off for the 3.5” backplane worth the 120W TDP limit on processing?</li> \n    </ul> </li> \n   <li>Do we need to expose the disks directly? (Does the controller need to support pass-through?)</li> \n  </ul> </li> \n <li>Memory: \n  <ul> \n   <li>How much memory does it need? (What <em>must</em> we buy?)</li> \n   <li>How much memory <em>could</em> it use? (What’s <em>reasonable</em> to buy?)</li> \n   <li>Do we think it will need more memory later? (What memory channel configuration should we go with?)</li> \n   <li>Is this a memory-access-heavy application? (Do we want to max out the clock speed?) \n    <ul> \n     <li>Is it highly parallel access? (Do we want to spread the same space across more DIMMs?)</li> \n    </ul> </li> \n  </ul> </li> \n <li>CPU: \n  <ul> \n   <li>What kind of processing are we looking at? (Do we need base CPUs or power?)</li> \n   <li>Is it heavily parallel? (Do we want fewer, faster cores? Or, does it call for more, slower cores?) \n    <ul> \n     <li>In what ways? Will there be heavy L2/L3 cache contention? (Do we need a huge L3 cache for performance?)</li> \n    </ul> </li> \n   <li>Is it mostly single core performance? (Do we want maximum clock?) \n    <ul> \n     <li>If so, how many processes at once? (Which turbo spread do we want here?)</li> \n    </ul> </li> \n  </ul> </li> \n <li>Network: \n  <ul> \n   <li>Do we need additional 10Gb network connectivity? (Is this a “through” machine, such as a load balancer?)</li> \n   <li>How much balance do we need on Tx/Rx buffers? (What CPU core count balances best?)</li> \n  </ul> </li> \n <li>Redundancy: \n  <ul> \n   <li>Do we need servers in the DR data center as well? \n    <ul> \n     <li>Do we need the same number, or is less redundancy acceptable?</li> \n    </ul> </li> \n  </ul> </li> \n <li>Do we need a power cord? No. No we don’t.</li> \n</ul> \n<p>Now, let’s see what hardware in our New York QTS data center serves the sites. Secretly, it’s really New Jersey, but let’s just keep that between us. Why do we say it’s the NY data center? Because we don’t want to rename all those NY- servers. I’ll note in the list below when and how Denver differs slightly in specs or redundancy levels.</p> \n<p><a href=\"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/#\" class=\"button toggle-stack-overflow-the-hardware-2016-edition\" style=\"min-width: 110px;\">Hide Pictures</a> (in case you’re using this as a hardware reference list later)</p> \n<h2 id=\"servers-running-stack-overflow--stack-exchange-sites\">Servers Running Stack Overflow &amp; Stack Exchange Sites</h2> \n<p>A few global truths so I need not repeat them in each server spec below:</p> \n<ul> \n <li>OS drives are not included unless they’re special. Most servers use a pair of 250 or 500GB SATA HDDs for the OS partition, <strong>always</strong> in a RAID 1. Boot time is not a concern we have and <em>even if it were</em>, the vast majority of our boot time on any physical server isn’t dependent on drive speed (for example, checking 768GB of memory).</li> \n <li>All servers are connected by 2 or more 10Gb network links in active/active <a href=\"https://en.wikipedia.org/wiki/Link_aggregation#Link_Aggregation_Control_Protocol\">LACP</a>.</li> \n <li>All servers run on 208V single phase power (via 2 PSUs feeding from 2 PDUs backed by 2 sources).</li> \n <li>All servers in New York have cable arms, all servers in Denver do not (local engineer’s preference).</li> \n <li>All servers have both an <a href=\"http://en.community.dell.com/techcenter/systems-management/w/wiki/3204.dell-remote-access-controller-drac-idrac\">iDRAC</a> connection (via the management network) and a KVM connection.</li> \n</ul> \n<h4 id=\"network\">Network</h4> \n<ul> \n <li>2x Cisco Nexus <a href=\"https://www.cisco.com/c/en/us/products/switches/nexus-5596up-switch/index.html\">5596UP</a> core switches (96 SFP+ ports each at 10 Gbps)</li> \n <li>10x Cisco Nexus <a href=\"https://www.cisco.com/c/en/us/products/switches/nexus-2232tm-10ge-fabric-extender/index.html\">2232TM</a> Fabric Extenders (<strong>2 per rack</strong> - each has 32 BASE-T ports each at 10Gbps + 8 SFP+ 10Gbps uplinks)</li> \n <li>2x Fortinet <a href=\"http://www.fortinet.com/products/fortigate/enterprise-firewalls.html\">800C</a> Firewalls</li> \n <li>2x Cisco <a href=\"https://www.cisco.com/c/en/us/products/routers/asr-1001-router/index.html\">ASR-1001</a> Routers</li> \n <li>2x Cisco <a href=\"https://www.cisco.com/c/en/us/products/routers/asr-1001-x-router/index.html\">ASR-1001-x</a> Routers</li> \n <li>6x Cisco <a href=\"https://www.cisco.com/c/en/us/support/switches/catalyst-2960s-48ts-l-switch/model.html\">2960S-48TS-L</a> Management network switches (<strong>1 Per Rack</strong> - 48 1Gbps ports + 4 SFP 1Gbps)</li> \n <li>1x Dell <a href=\"http://accessories.us.dell.com/sna/productdetail.aspx?c=us&amp;l=en&amp;s=bsd&amp;cs=04&amp;sku=A7546775\">DMPU4032</a> KVM</li> \n <li>7x Dell <a href=\"http://accessories.us.dell.com/sna/productdetail.aspx?c=us&amp;l=en&amp;s=bsd&amp;cs=04&amp;sku=A7546777\">DAV2216</a> KVM Aggregators (<strong>1–2 per rack</strong> - each uplinks to the DPMU4032)</li> \n</ul> \n<p><em>Note: Each FEX has 80 Gbps of uplink bandwidth to its core, and the cores have a 160 Gbps port channel between them. Due to being a more recent install, the hardware in our Denver data center is slightly newer. All 4 routers are <a href=\"https://www.cisco.com/c/en/us/products/routers/asr-1001-x-router/index.html\">ASR-1001-x</a> models and the 2 cores are <a href=\"https://www.cisco.com/c/en/us/products/switches/nexus-56128p-switch/index.html\">Cisco Nexus 56128P</a>, which have 96 SFP+ 10Gbps ports and 8 QSFP+ 40Gbps ports each. This saves 10Gbps ports for future expansion since we can bond the cores with 4x 40Gbps links, instead of eating 16x 10Gbps ports as we do in New York.</em></p> \n<div class=\"pics-stack-overflow-the-hardware-2016-edition\"> \n <p>Here’s what the network gear looks like in New York:</p> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Rack.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Network-NewYork-Rack-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Network-NewYork-Rack-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Rack-Small.jpg\" alt=\"New York Rack\" style=\"float: right; width: 477px; height: 708px;\" /> \n   </picture></a> <a href=\"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fiber.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Network-NewYork-Fiber-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Network-NewYork-Fiber-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fiber-Small.jpg\" alt=\"New York Fiber\" style=\"width: 477px; height: 346px; padding-right: 16px; padding-bottom: 16px;\" /> \n   </picture></a> <a href=\"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fortinet.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Network-NewYork-Fortinet-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Network-NewYork-Fortinet-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fortinet-Small.jpg\" alt=\"New York Fortinet\" style=\"width: 477px; height: 346px;\" /> \n   </picture></a></p> \n <p>…and in Denver:</p> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Raw.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Network-Denver-Raw-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Network-Denver-Raw-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Raw-Small.jpg\" alt=\"Denver network before install\" /> \n   </picture></a></p> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Racked.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Network-Denver-Racked-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Network-Denver-Racked-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Racked-Small.jpg\" alt=\"Denver Network - Racked\" style=\"width: 477px; height: 620px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Installed.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Network-Denver-Installed-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Network-Denver-Installed-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Installed-Small.jpg\" alt=\"Denver Network - Installed\" style=\"width: 477px; height: 620px;\" /> \n   </picture></a></p> \n <p>Give a shout to <a href=\"https://twitter.com/thefarseeker\">Mark Henderson</a>, one of our Site Reliability Engineers who made a special trip to the New York DC to get me some high-res, current photos for this post.</p> \n</div> \n<h4 id=\"sql-servers-stack-overflow-cluster\">SQL Servers (Stack Overflow Cluster)</h4> \n<ul> \n <li>2 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r720xd/pd\">R720xd</a> Servers, each with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/75283/Intel-Xeon-Processor-E5-2697-v2-30M-Cache-2_70-GHz\">E5-2697v2</a> Processors (12 cores @2.7–3.5GHz each)</li> \n <li>384 GB of RAM (24x 16 GB DIMMs)</li> \n <li>1x Intel <a href=\"https://www.intel.com/content/www/us/en/solid-state-drives/solid-state-drives-dc-p3608-series.html\">P3608</a> 4 TB NVMe PCIe SSD (RAID 0, 2 controllers per card)</li> \n <li>24x Intel <a href=\"https://ark.intel.com/products/56584/Intel-SSD-710-Series-200GB-2_5in-SATA-3Gbs-25nm-MLC\">710</a> 200 GB SATA SSDs (RAID 10)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<h4 id=\"sql-servers-stack-exchange-and-everything-else-cluster\">SQL Servers (Stack Exchange “…and everything else” Cluster)</h4> \n<ul> \n <li>2 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r730xd/pd\">R730xd</a> Servers, each with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/83361/Intel-Xeon-Processor-E5-2667-v3-20M-Cache-3_20-GHz\">E5-2667v3</a> Processors (8 cores @3.2–3.6GHz each)</li> \n <li>768 GB of RAM (24x 32 GB DIMMs)</li> \n <li>3x Intel <a href=\"https://ark.intel.com/products/79620/Intel-SSD-DC-P3700-Series-2_0TB-12-Height-PCIe-3_0-20nm-MLC\">P3700</a> 2 TB NVMe PCIe SSD (RAID 0)</li> \n <li>24x 10K Spinny 1.2 TB SATA HDDs (RAID 10)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<p><em>Note: Denver SQL hardware is identical in spec, but there is only 1 SQL server for each corresponding pair in New York.</em></p> \n<div class=\"pics-stack-overflow-the-hardware-2016-edition\"> \n <p>Here’s what the SQL Servers in New York looked like while getting their PCIe SSD upgrades in February:</p> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Hardware-SQL-Inside.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-SQL-Inside-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-SQL-Inside-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-SQL-Inside-Small.jpg\" alt=\"SQL Server - Inside\" style=\"width: 477px; height: 354px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-SQL-SSDs.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-SQL-SSDs-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-SQL-SSDs-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-SQL-SSDs-Small.jpg\" alt=\"SQL Server - SSDs\" style=\"width: 477px; height: 354px;\" /> \n   </picture></a> <a href=\"https://nickcraver.com/blog/content/SO-Hardware-SQL-Front.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-SQL-Front-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-SQL-Front-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-SQL-Front-Small.jpg\" alt=\"SQL Server - Front\" style=\"width: 477px; height: 354px; padding-top: 16px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-SQL-Top.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-SQL-Top-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-SQL-Top-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-SQL-Top-Small.jpg\" alt=\"SQL Server - Top\" style=\"width: 477px; height: 354px; padding-top: 16px;\" /> \n   </picture></a></p> \n</div> \n<h4 id=\"web-servers\">Web Servers</h4> \n<ul> \n <li>11 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r630/pd\">R630</a> Servers, each with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/81713/Intel-Xeon-Processor-E5-2690-v3-30M-Cache-2_60-GHz\">E5-2690v3</a> Processors (12 cores @2.6–3.5GHz each)</li> \n <li>64 GB of RAM (8x 8 GB DIMMs)</li> \n <li>2x Intel <a href=\"https://ark.intel.com/products/56567/Intel-SSD-320-Series-300GB-2_5in-SATA-3Gbs-25nm-MLC\">320</a> 300GB SATA SSDs (RAID 1)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<div class=\"pics-stack-overflow-the-hardware-2016-edition\"> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Web-Tier-Front-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Web-Tier-Front-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front-Small.jpg\" alt=\"Web Tier - Front\" style=\"width: 477px; height: 354px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Back.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Web-Tier-Back-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Web-Tier-Back-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Back-Small.jpg\" alt=\"Web Tier - Back\" style=\"width: 477px; height: 354px;\" /> \n   </picture></a> <a href=\"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Unboxed.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Web-Tier-Unboxed-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Web-Tier-Unboxed-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Unboxed-Small.jpg\" alt=\"Web Tier - Unboxed\" style=\"width: 477px; height: 354px; padding-top: 16px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front2.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Web-Tier-Front2-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Web-Tier-Front2-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front2-Small.jpg\" alt=\"Web Tier - Front 2\" style=\"width: 477px; height: 354px; padding-top: 16px;\" /> \n   </picture></a></p> \n</div> \n<h4 id=\"service-servers-workers\">Service Servers (Workers)</h4> \n<ul> \n <li>2 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r630/pd\">R630</a> Servers, each with: \n  <ul> \n   <li>Dual <a href=\"https://ark.intel.com/products/81900/Intel-Xeon-Processor-E5-2643-v3-20M-Cache-3_40-GHz\">E5-2643 v3</a> Processors (6 cores @3.4–3.7GHz each)</li> \n   <li>64 GB of RAM (8x 8 GB DIMMs)</li> \n  </ul> </li> \n <li>1 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r620/pd\">R620</a> Server, with: \n  <ul> \n   <li>Dual <a href=\"https://ark.intel.com/products/64589/Intel-Xeon-Processor-E5-2667-15M-Cache-2_90-GHz-8_00-GTs-Intel-QPI\">E5-2667</a> Processors (6 cores @2.9–3.5GHz each)</li> \n   <li>32 GB of RAM (8x 4 GB DIMMs)</li> \n  </ul> </li> \n <li>2x Intel <a href=\"https://ark.intel.com/products/56567/Intel-SSD-320-Series-300GB-2_5in-SATA-3Gbs-25nm-MLC\">320</a> 300GB SATA SSDs (RAID 1)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<p><em>Note: NY-SERVICE03 is still an R620, due to not being old enough for replacement at the same time. It will be upgraded later this year.</em></p> \n<h4 id=\"redis-servers-cache\">Redis Servers (Cache)</h4> \n<ul> \n <li>2 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r630/pd\">R630</a> Servers, each with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/81909/Intel-Xeon-Processor-E5-2687W-v3-25M-Cache-3_10-GHz\">E5-2687W v3</a> Processors (10 cores @3.1–3.5GHz each)</li> \n <li>256 GB of RAM (16x 16 GB DIMMs)</li> \n <li>2x Intel <a href=\"https://ark.intel.com/products/66250/Intel-SSD-520-Series-240GB-2_5in-SATA-6Gbs-25nm-MLC\">520</a> 240GB SATA SSDs (RAID 1)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<h4 id=\"elasticsearch-servers-search\">Elasticsearch Servers (Search)</h4> \n<ul> \n <li>3 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r620/pd\">R620</a> Servers, each with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/64583/Intel-Xeon-Processor-E5-2680-20M-Cache-2_70-GHz-8_00-GTs-Intel-QPI\">E5-2680</a> Processors (8 cores @2.7–3.5GHz each)</li> \n <li>192 GB of RAM (12x 16 GB DIMMs)</li> \n <li>2x Intel <a href=\"https://ark.intel.com/products/75685/Intel-SSD-DC-S3500-Series-800GB-2_5in-SATA-6Gbs-20nm-MLC\">S3500</a> 800GB SATA SSDs (RAID 1)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<h4 id=\"haproxy-servers-load-balancers\">HAProxy Servers (Load Balancers)</h4> \n<ul> \n <li>2 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r620/pd\">R620</a> Servers (CloudFlare Traffic), each with: \n  <ul> \n   <li>Dual <a href=\"https://ark.intel.com/products/81900/Intel-Xeon-Processor-E5-2643-v3-20M-Cache-3_40-GHz\">E5-2637 v2</a> Processors (4 cores @3.5–3.8GHz each)</li> \n   <li>192 GB of RAM (12x 16 GB DIMMs)</li> \n   <li>6x Seagate <a href=\"https://www.amazon.com/SEAGATE-ST91000640NS-Constellation-6-0Gb-internal/dp/B004HZEF2I\">Constellation 7200RPM</a> 1TB SATA HDDs (RAID 10) (Logs)</li> \n   <li>Dual 10 Gbps network (Intel X540/I350 NDC) - Internal (DMZ) Traffic</li> \n   <li>Dual 10 Gbps network (Intel X540) - External Traffic</li> \n  </ul> </li> \n <li>2 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r620/pd\">R620</a> Servers (Direct Traffic), each with: \n  <ul> \n   <li>Dual <a href=\"https://ark.intel.com/products/64590/Intel-Xeon-Processor-E5-2650-20M-Cache-2_00-GHz-8_00-GTs-Intel-QPI\">E5-2650</a> Processors (8 cores @2.0–2.8GHz each)</li> \n   <li>64 GB of RAM (4x 16 GB DIMMs)</li> \n   <li>2x Seagate <a href=\"https://www.amazon.com/SEAGATE-ST91000640NS-Constellation-6-0Gb-internal/dp/B004HZEF2I\">Constellation 7200RPM</a> 1TB SATA HDDs (RAID 10) (Logs)</li> \n   <li>Dual 10 Gbps network (Intel X540/I350 NDC) - Internal (DMZ) Traffic</li> \n   <li>Dual 10 Gbps network (Intel X540) - External Traffic</li> \n  </ul> </li> \n</ul> \n<p><em>Note: These servers were ordered at different times and as a result, differ in spec. Also, the two CloudFlare load balancers have more memory for a memcached install (which we no longer run today) for CloudFlare’s <a href=\"https://www.cloudflare.com/railgun/\">Railgun</a>.</em></p> \n<div class=\"pics-stack-overflow-the-hardware-2016-edition\"> \n <p>The service, redis, search, and load balancer boxes above are all 1U servers in a stack. Here’s what that stack looks like in New York:</p> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Service-Redis-Search-Front.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Service-Redis-Search-Front-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Service-Redis-Search-Front-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Service-Redis-Search-Front-Small.jpg\" alt=\"Redis &amp; Search - Front\" style=\"width: 477px; height: 354px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Service-Rear.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Service-Rear-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Service-Rear-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Service-Rear-Small.jpg\" alt=\"Service - Rear\" style=\"width: 477px; height: 354px;\" /> \n   </picture></a> <a href=\"https://nickcraver.com/blog/content/SO-Hardware-Redis-Inside.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Redis-Inside-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Redis-Inside-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Redis-Inside-Small.jpg\" alt=\"Redis - Inside\" style=\"width: 477px; height: 354px; padding-top: 16px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Service-Inside.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Service-Inside-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Service-Inside-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Service-Inside-Small.jpg\" alt=\"Service - Inside\" style=\"width: 477px; height: 354px; padding-top: 16px;\" /> \n   </picture></a></p> \n</div> \n<h2 id=\"servers-for-other-bits\">Servers for Other Bits</h2> \n<p>We have other servers not directly or indirectly involved in serving site traffic. These are either only tangentially related (e.g., domain controllers which are seldom used for application pool authentication and run as VMs) or are for nonessential purposes like monitoring, log storage, backups, etc.</p> \n<p>Since this post is meant to be an appendix for many future posts <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">in the series</a>, I’m including all of the interesting “background” servers as well. This also lets me share more server porn with you, and who doesn’t love that?</p> \n<h4 id=\"vm-servers-vmware-currently\">VM Servers (VMWare, Currently)</h4> \n<ul> \n <li>2 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-fx/pd\">FX2s</a> Blade Chassis, each with 2 of 4 blades populated \n  <ul> \n   <li>4 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-fx/pd#Misc\">FC630</a> Blade Servers (2 per chassis), each with: \n    <ul> \n     <li>Dual <a href=\"https://ark.intel.com/products/81900/Intel-Xeon-Processor-E5-2643-v3-20M-Cache-3_40-GHz\">E5-2698 v3</a> Processors (16 cores @2.3–3.6GHz each)</li> \n     <li>768 GB of RAM (24x 32 GB DIMMs)</li> \n     <li>2x 16GB SD Cards (Hypervisor - no local storage)</li> \n    </ul> </li> \n   <li>Dual 4x 10 Gbps network (FX IOAs - BASET)</li> \n  </ul> </li> \n <li>1 EqualLogic <a href=\"http://www.dell.com/us/business/p/equallogic-ps6210-series/pd\">PS6210X</a> iSCSI SAN \n  <ul> \n   <li>24x Dell 10K RPM 1.2TB SAS HDDs (RAID10)</li> \n   <li>Dual 10Gb network (10-BASET)</li> \n  </ul> </li> \n <li>1 EqualLogic <a href=\"http://www.dell.com/us/business/p/equallogic-ps6110x/pd\">PS6110X</a> iSCSI SAN \n  <ul> \n   <li>24x Dell 10K RPM 900GB SAS HDDs (RAID10)</li> \n   <li>Dual 10Gb network (SFP+)</li> \n  </ul> </li> \n</ul> \n<div class=\"pics-stack-overflow-the-hardware-2016-edition\"> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-VMs-Blades-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-VMs-Blades-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades-Small.jpg\" alt=\"VM Blades - 1\" style=\"width: 477px; height: 708px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades2.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-VMs-Blades2-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-VMs-Blades2-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades2-Small.jpg\" alt=\"VM Blades - 2\" style=\"width: 477px; height: 708px;\" /> \n   </picture></a> <a href=\"https://nickcraver.com/blog/content/SO-Hardware-VMs-Front.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-VMs-Front-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-VMs-Front-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-VMs-Front-Small.jpg\" alt=\"VMs - Front\" style=\"width: 477px; height: 708px; padding-top: 16px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-VMs-Rear.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-VMs-Rear-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-VMs-Rear-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-VMs-Rear-Small.jpg\" alt=\"VMs - Rear\" style=\"width: 477px; height: 708px; padding-top: 16px;\" /> \n   </picture></a></p> \n</div> \n<p>There a few more noteworthy servers behind the scenes that aren’t VMs. These perform background tasks, help us troubleshoot with logging, store tons of data, etc.</p> \n<h4 id=\"machine-learning-servers-providence\">Machine Learning Servers (Providence)</h4> \n<p>These servers are idle about 99% of the time, but do heavy lifting for a nightly processing job: refreshing Providence. They also serve as an inside-the-datacenter place to test new algorithms on large datasets.</p> \n<ul> \n <li>2 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r620/pd\">R620</a> Servers, each with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/75283/Intel-Xeon-Processor-E5-2697-v2-30M-Cache-2_70-GHz\">E5-2697 v2</a> Processors (12 cores @2.7–3.5GHz each)</li> \n <li>384 GB of RAM (24x 16 GB DIMMs)</li> \n <li>4x Intel <a href=\"https://ark.intel.com/products/75336/Intel-SSD-530-Series-480GB-2_5in-SATA-6Gbs-20nm-MLC\">530</a> 480GB SATA SSDs (RAID 10)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<h4 id=\"machine-learning-redis-servers-still-providence\">Machine Learning Redis Servers (Still Providence)</h4> \n<p>This is the redis data store for Providence. The usual setup is one master, one slave, and one instance used for testing the latest version of our ML algorithms. While not used to serve the Q&amp;A sites, this data is used when serving job matches on Careers as well as the sidebar job listings.</p> \n<ul> \n <li>3 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r720xd/pd\">R720xd</a> Servers, each with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/75269/Intel-Xeon-Processor-E5-2650-v2-20M-Cache-2_60-GHz\">E5-2650 v2</a> Processors (8 cores @2.6–3.4GHz each)</li> \n <li>384 GB of RAM (24x 16 GB DIMMs)</li> \n <li>4x Samsung <a href=\"https://www.samsung.com/semiconductor/products/flash-storage/client-ssd\">840 Pro</a> 480 GB SATA SSDs (RAID 10)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<h4 id=\"logstash-servers-for-ya-knowlogs\">Logstash Servers (For ya know…logs)</h4> \n<p>Our Logstash cluster (using Elasticsearch for storage) stores logs from, well, everything. We plan to replicate HTTP logs in here but are hitting performance issues. However, we do aggregate all network device logs, syslogs, and Windows and Linux system logs here so we can get a network overview or search for issues very quickly. This is also used as a data source in Bosun to get additional information when alerts fire. The total cluster’s raw storage is 6x12x4 = 288 TB.</p> \n<ul> \n <li>6 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r720xd/pd\">R720xd</a> Servers, each with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/75272/Intel-Xeon-Processor-E5-2660-v2-25M-Cache-2_20-GHz\">E5-2660 v2</a> Processors (10 cores @2.2–3.0GHz each)</li> \n <li>192 GB of RAM (12x 16 GB DIMMs)</li> \n <li>12x 7200 RPM Spinny 4 TB SATA HDDs (RAID 0 x3 - 4 drives per)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<h4 id=\"http-logging-sql-server\">HTTP Logging SQL Server</h4> \n<p>This is where we log every single HTTP hit to our load balancers (sent from HAProxy via syslog) to a SQL database. We only record a few top level bits like URL, Query, UserAgent, timings for SQL, Redis, etc. in here – so it all goes into a Clustered Columnstore Index per day. We use this for troubleshooting user issues, detecting botnets, etc.</p> \n<ul> \n <li>1 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r730xd/pd\">R730xd</a> Server with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/81706/Intel-Xeon-Processor-E5-2660-v3-25M-Cache-2_60-GHz\">E5-2660 v3</a> Processors (10 cores @2.6–3.3GHz each)</li> \n <li>256 GB of RAM (16x 16 GB DIMMs)</li> \n <li>2x Intel <a href=\"https://ark.intel.com/products/80995/Intel-SSD-DC-P3600-Series-2_0TB-2_5in-PCIe-3_0-20nm-MLC\">P3600</a> 2 TB NVMe PCIe SSD (RAID 0)</li> \n <li>16x Seagate <a href=\"http://www.seagate.com/internal-hard-drives/enterprise-hard-drives/hdd/enterprise-capacity-3-5-hdd/?sku=ST6000NM0024\">ST6000NM0024</a> 7200RPM Spinny 6 TB SATA HDDs (RAID 10)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<h4 id=\"development-sql-server\">Development SQL Server</h4> \n<p>We like for dev to simulate production as much as possible, so SQL matches as well…or at least it used to. We’ve upgraded production processors since this purchase. We’ll be refreshing this box with a 2U solution at the same time as we upgrade the Stack Overflow cluster later this year.</p> \n<ul> \n <li>1 Dell <a href=\"http://www.dell.com/us/business/p/poweredge-r620/pd\">R620</a> Server with:</li> \n <li>Dual <a href=\"https://ark.intel.com/products/64594/Intel-Xeon-Processor-E5-2620-15M-Cache-2_00-GHz-7_20-GTs-Intel-QPI\">E5-2620</a> Processors (6 cores @2.0–2.5GHz each)</li> \n <li>384 GB of RAM (24x 16 GB DIMMs)</li> \n <li>8x Intel <a href=\"https://ark.intel.com/products/71916/Intel-SSD-DC-S3700-Series-800GB-2_5in-SATA-6Gbs-25nm-MLC\">S3700</a> 800 GB SATA SSDs (RAID 10)</li> \n <li>Dual 10 Gbps network (Intel X540/I350 NDC)</li> \n</ul> \n<div class=\"pics-stack-overflow-the-hardware-2016-edition\"> \n <p>That’s it for the hardware actually serving the sites or that’s generally interesting. We, of course, have other servers for the background tasks such as logging, monitoring, backups, etc. If you’re especially curious about specs of any other systems, just ask in comments and I’m happy to detail them out. Here’s what the full setup looks like in New York as of a few weeks ago:</p> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Racks.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Racks-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Racks-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Racks-Small.jpg\" alt=\"Racks - Left Aisle\" style=\"width: 477px; height: 708px; padding-right: 16px;\" /> \n   </picture></a><a href=\"https://nickcraver.com/blog/content/SO-Hardware-Racks2.jpg\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Hardware-Racks2-Small.webp\" /> \n    <source type=\"image/jpg\" srcset=\"/blog/content/SO-Hardware-Racks2-Small.jpg\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Hardware-Racks2-Small.jpg\" alt=\"Racks - Right Aisle\" style=\"width: 477px; height: 708px;\" /> \n   </picture></a></p> \n</div> \n<p>What’s next? The way <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">this series</a> works is I blog in order of what the community wants to know about most. Going by <a href=\"https://trello.com/b/0zgQjktX/blog-post-queue-for-stack-overflow-topics\">the Trello board</a>, it looks like <a href=\"https://trello.com/c/bh4GZ30c/25-deployment\">Deployment</a> is the next most interesting topic. So next time expect to learn how code goes from a developers machine to production and everything involved along the way. I’ll cover database migrations, rolling builds, CI infrastructure, how our dev environment is set up, and share stats on all things deployment.</p> \n<script> (function () { var pics = document.querySelectorAll('.pics-stack-overflow-the-hardware-2016-edition'), a = document.querySelector('.toggle-stack-overflow-the-hardware-2016-edition'); a.addEventListener('click', function(e) { e.preventDefault(); var hide = this.innerHTML === 'Hide Pictures'; for (var i = 0; i &lt; pics.length; i++) { pics[i].style.display = hide ? 'none' : 'block'; } this.innerHTML = hide ? 'Show Pictures' : 'Hide Pictures'; localStorage.setItem('hide-stack-overflow-the-hardware-2016-edition', hide); return false; }, false); if (localStorage.getItem('hide-stack-overflow-the-hardware-2016-edition') === 'true') { a.dispatchEvent(new Event('click')); } })(); </script>","descriptionType":"text/html","publishedDate":"Tue, 29 Mar 2016 00:00:00 +0000","feedId":12609,"bgimg":"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Rack-Small.jpg","linkMd5":"ba8afca96fcf06846d46525e6eee54a0","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn98@2020_1/2020/08/25/02-05-18-365_1cf5a335a0f7b250.webp","destWidth":944,"destHeight":1416,"sourceBytes":408754,"destBytes":182778,"author":"","articleImgCdnMap":{"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Rack-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn98@2020_1/2020/08/25/02-05-18-365_1cf5a335a0f7b250.webp","https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fiber-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn49@2020_3/2020/08/25/02-05-22-729_c8486a292235d868.webp","https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fortinet-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn57@2020_6/2020/08/25/02-05-21-763_a593860141fbc11b.webp","https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Raw-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn23@2020_5/2020/08/25/02-05-20-323_a64670832732795c.webp","https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Racked-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn74@2020_5/2020/08/25/02-05-22-891_e159cecf727f932f.webp","https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Installed-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn69@2020_5/2020/08/25/02-05-22-859_8f554f2b4853410b.webp","https://nickcraver.com/blog/content/SO-Hardware-SQL-Inside-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn10@2020_1/2020/08/25/02-05-20-212_de3dbef7e47d2a82.webp","https://nickcraver.com/blog/content/SO-Hardware-SQL-SSDs-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn97@2020_2/2020/08/25/02-05-20-219_115c103ba6796acf.webp","https://nickcraver.com/blog/content/SO-Hardware-SQL-Front-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn77@2020_2/2020/08/25/02-05-22-271_554f635d0e6cf6d5.webp","https://nickcraver.com/blog/content/SO-Hardware-SQL-Top-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn61@2020_6/2020/08/25/02-05-20-239_c818a2fedf36f905.webp","https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn53@2020_6/2020/08/25/02-05-20-396_edee98dae04298f5.webp","https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Back-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn26@2020_4/2020/08/25/02-05-21-506_59fdf52ed573fc13.webp","https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Unboxed-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn18@2020_2/2020/08/25/02-05-20-194_bee83ba3c6a065f7.webp","https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front2-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn94@2020_2/2020/08/25/02-05-21-375_8367225145a149e7.webp","https://nickcraver.com/blog/content/SO-Hardware-Service-Redis-Search-Front-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn33@2020_2/2020/08/25/02-05-20-272_b69a8c69d221e019.webp","https://nickcraver.com/blog/content/SO-Hardware-Service-Rear-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn1@2020_6/2020/08/25/02-05-21-478_52f48dd2a5f382f3.webp","https://nickcraver.com/blog/content/SO-Hardware-Redis-Inside-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn50@2020_3/2020/08/25/02-05-20-555_f87fc21aa9ba9000.webp","https://nickcraver.com/blog/content/SO-Hardware-Service-Inside-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn18@2020_1/2020/08/25/02-05-21-681_3c9e3a673e2227c6.webp","https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn98@2020_4/2020/08/25/02-05-21-447_6142640a38aa0f64.webp","https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades2-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn62@2020_2/2020/08/25/02-05-21-851_9e119fd4dfd63b96.webp","https://nickcraver.com/blog/content/SO-Hardware-VMs-Front-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn49@2020_6/2020/08/25/02-05-21-701_c953805d2d6a110a.webp","https://nickcraver.com/blog/content/SO-Hardware-VMs-Rear-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn77@2020_4/2020/08/25/02-05-22-859_4e936f157c3a58b5.webp","https://nickcraver.com/blog/content/SO-Hardware-Racks-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn45@2020_6/2020/08/25/02-05-21-697_6fd05a6304796595.webp","https://nickcraver.com/blog/content/SO-Hardware-Racks2-Small.jpg":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn14@2020_3/2020/08/25/02-05-22-041_476d9eaf3426324d.webp"},"publishedOrCreatedDate":1598321095269},{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","title":"Stack Overflow: How We Do Monitoring - 2018 Edition","link":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","description":"<blockquote> \n <p>This is #4 in a <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">very long series of posts</a> on Stack Overflow’s architecture.<br /> Previous post (#3): <a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/\">Stack Overflow: How We Do Deployment - 2016 Edition</a></p> \n</blockquote> \n<p>What is monitoring? As far as I can tell, it means different things to different people. But we more or less agree on the concept. I think. Maybe. Let’s find out! When someone says monitoring, I think of:</p> \n<div style=\"max-width:400px;text-align: center;margin: 0 auto;\"> \n <p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Monitored.png\" target=\"_blank\"> \n   <picture> \n    <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Monitored.webp\" /> \n    <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Monitored.png\" /> \n    <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Monitored.png\" loading=\"lazy\" alt=\"You are being monitored!\" /> \n   </picture></a></p> \n</div> \n<p>…but evidently some people think of other things. Those people are obviously wrong, but let’s continue. When I’m not a walking zombie after reading a 10,000 word blog post some idiot wrote, I see monitoring as the process of keeping an eye on your stuff, like a security guard sitting at a desk full of cameras somewhere. Sometimes they fall asleep–that’s monitoring going down. Sometimes they’re distracted with a doughnut delivery–that’s an upgrade outage. Sometimes the camera is on a loop–I don’t know where I was going with that one, but someone’s probably robbing you. And then you have the fire alarm. You don’t need a human to trigger that. The same applies when a door gets opened, maybe that’s wired to a siren. Or maybe it’s not. Or maybe the siren broke in 1984.</p> \n<p>I know what you’re thinking: Nick, what the hell? \n <!--more--> My point is only that monitoring any application isn’t that much different from monitoring anything else. Some things you can automate. Some things you can’t. Some things have thresholds for which alarms are valid. Sometimes you’ll get those thresholds wrong (especially on holidays). And sometimes, when setting up further automation isn’t quite worth it, you just make using human eyes easier.</p> \n<p>What I’ll discuss here is what <em>we</em> do. It’s not the same for everyone. What’s important and “worth it” will be different for almost everyone. As with <em>everything</em> else in life, it’s full of trade-off decisions. Below are the ones we’ve made so far. They’re not perfect. They are evolving. And when new data or priorities arise, we will change earlier decisions when it warrants doing so. That’s how brains are supposed to work.</p> \n<p>And once again this post got longer and longer as I wrote it (but a lot of pictures make up that scroll bar!). So, links for your convenience:</p> \n<ul> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#types-of-data\">Types of Data</a> \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#logs\">Logs</a> \n    <ul> \n     <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#logs-haproxy\">Logs: HAProxy</a></li> \n    </ul> </li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-checks\">Health Checks</a> \n    <ul> \n     <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-checks-httpunit\">Health Checks: httpUnit</a></li> \n     <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-checks-fastly\">Health Checks: Fastly</a></li> \n     <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-checks-external\">Health Checks: External</a></li> \n    </ul> </li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#metrics\">Metrics</a></li> \n  </ul> </li> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#alerting\">Alerting</a></li> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun\">Bosun</a> \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun-metrics\">Bosun: Metrics</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun-alerting\">Bosun: Alerting</a></li> \n  </ul> </li> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#grafana\">Grafana</a></li> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#client-timings\">Client Timings</a></li> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#miniprofiler\">MiniProfiler</a></li> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver\">Opserver</a> \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-primary-dashboard\">Opserver: Primary Dashboard</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-sql-server\">Opserver: SQL Server</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-redis\">Opserver: Redis</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-elasticsearch\">Opserver: Elasticsearch</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-exceptions\">Opserver: Exceptions</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-haproxy\">Opserver: HAProxy</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-faqs\">Opserver: FAQs</a></li> \n  </ul> </li> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#where-do-we-go-next\">Where Do We Go Next?</a> \n  <ul> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-check-next-steps\">Health Check Next Steps</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun-next-steps\">Bosun Next Steps</a></li> \n   <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#metrics-next-steps\">Metrics Next Steps</a></li> \n  </ul> </li> \n <li><a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#tools-summary\">Tools Summary</a></li> \n</ul> \n<h3 id=\"types-of-data\">Types of Data</h3> \n<p>Monitoring generally consists of a few types of data (I’m absolutely arbitrarily making some groups here):</p> \n<ul> \n <li>Logs: Rich, detailed text and data but not awesome for alerting</li> \n <li>Metrics: Tagged numbers of data for telemetry–good for alerting, but lacking in detail</li> \n <li>Health Checks: Is it up? Is it down? Is it sideways? Very specific, often for alerting</li> \n <li>Profiling: Performance data from the application to see how long things are taking</li> \n <li>…and other complex combinations for specific use cases that don’t really fall into any one of these.</li> \n</ul> \n<h4 id=\"logs\">Logs</h4> \n<p>Let’s talk about <a href=\"https://www.youtube.com/watch?v=2C7mNr5WMjA\">logs</a>. You can log almost anything!</p> \n<ul> \n <li>Info messages? Yep.</li> \n <li>Errors? Heck yeah!</li> \n <li>Traffic? Sure!</li> \n <li>Email? Careful, GDPR.</li> \n <li>Anything else? Well, I guess.</li> \n</ul> \n<p>Sounds good. I can log whatever I want! What’s the catch? Well, it’s a trade-off. Have you ever run a program with tons of console output? Run the same program without it? Goes faster, doesn’t it? Logging has a few costs. First, you often need to allocate strings for the logging itself. That’s memory and garbage collection (for .NET and some other platforms). When you’re logging <em>somewhere</em>, that usually that means disk space. If we’re traversing a network (and to some degree locally), it also means bandwidth and latency.</p> \n<p>…and I was just kidding about <a href=\"https://en.wikipedia.org/wiki/General_Data_Protection_Regulation\">GDPR</a> only being a concern for email…<strong>GDPR is a concern for all of the above</strong>. Keep retention and compliance in mind when logging anything. It’s another cost to consider.</p> \n<p>Let’s say none of those are significant problems and we want to log all the things. Tempting, isn’t it? Well, then we can have too much of a good thing. What happens when you need to look at those logs? It’s more to dig through. It can make finding the problem much harder and slower. With all logging, it’s a balance of logging what you think you’ll need vs. what you end up needing. You’ll get it wrong. All the time. And you’ll find a newly added feature didn’t have the right logging when things went wrong. And you’ll finally figure that out (probably after it goes south)…and add that logging. That’s life. Improve and move on. Don’t dwell on it, just take the lesson and learn from it. You’ll think about it more in code reviews and such afterwards.</p> \n<p>So what do we log? It depends on the system. For any systems we build, we <strong><em>always</em></strong> log errors. (Otherwise, why even throw them?). We do this with <a href=\"https://github.com/NickCraver/StackExchange.Exceptional\">StackExchange.Exceptional</a>, an open source .NET error logger I maintain. It logs to SQL Server. These are viewable in-app or via Opserver (<a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver\">which we’ll talk more about in a minute</a>).</p> \n<p>For systems like <a href=\"https://redis.io/\">Redis</a>, <a href=\"https://www.elastic.co/products/elasticsearch\">Elasticsearch</a>, and <a href=\"https://www.microsoft.com/en-us/sql-server/sql-server-2017\">SQL Server</a>, we’re simply logging to local disk using their built-in mechanisms for logging and log rotation. For other SNMP-based systems like network gear, we forward all of that to our <a href=\"https://www.elastic.co/products/logstash\">Logstash</a> cluster which we have <a href=\"https://www.elastic.co/products/kibana\">Kibana</a> in front of for querying. A lot of the above is also queried at alert time by <a href=\"https://bosun.org\">Bosun</a> for details and trends, which we’ll dive into next.</p> \n<h4 id=\"logs-haproxy\">Logs: HAProxy</h4> \n<p>We also log a minimal summary of public HTTP requests (only top level…no cookies, no form data, etc.) that go through <a href=\"https://www.haproxy.org/\">HAProxy</a> (our load balancer) because when someone can’t log in, an account gets merged, or any of a hundred other bug reports come in it’s immensely valuable to go see what flow led them to disaster. We do this in SQL Server via <a href=\"http://www.nikoport.com/columnstore/\">clustered columnstore indexes</a>. For the record, <a href=\"https://twitter.com/jarrod_dixon\">Jarrod Dixon</a> first suggested and started the HTTP logging about 8 years ago and we all told him he was an insane lunatic and it was a tremendous waste of resources. Please no one tell him he was totally right. A new per-month storage format will be coming soon, but that’s another story.</p> \n<p>In those requests, we use profiling <a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#miniprofiler\">that we’ll talk about shortly</a> and send headers to HAProxy with certain performance numbers. HAProxy captures and strips those headers into the syslog row we forward for processing into SQL. Those headers include:</p> \n<ul> \n <li>ASP.NET Overall Milliseconds (encompasses those below)</li> \n <li>SQL Count (queries) &amp; Milliseconds</li> \n <li>Redis Count (hits) &amp; Milliseconds</li> \n <li>HTTP Count (requests sent) &amp; Milliseconds</li> \n <li>Tag Engine Count (queries) &amp; Milliseconds</li> \n <li>Elasticsearch Count (hits) &amp; Milliseconds</li> \n</ul> \n<p>If something gets better or worse we can easily query and compare historical data. It’s also useful in ways we never really thought about. For example, we’ll see a request and the count of SQL queries run and it’ll tell us how far down a code path a user went. Or when SQL connection pools pile up, we can look at all requests from a particular server at a particular time to see what caused that contention. All we’re doing here is tracking a count of calls and time for <code class=\"language-plaintext highlighter-rouge\">n</code> services. It’s super simple, but also extremely effective.</p> \n<p>The thing that listens for syslog and saves to SQL is called the Traffic Processing Service, because we planned for it to send reports one day.</p> \n<p>Alongside those headers, the <a href=\"https://cbonte.github.io/haproxy-dconv/1.7/configuration.html#8.2.3\">default HAProxy log row format</a> has a few other timings per request:</p> \n<ul> \n <li>TR: Time a client took to send us the request (fairly useless when <a href=\"https://en.wikipedia.org/wiki/HTTP_persistent_connection\">keepalive</a> is in play)</li> \n <li>Tw: Time spent waiting in queues</li> \n <li>Tc: Time spent waiting to connect to the web server</li> \n <li>Tr: Time the web server took to fully render a response</li> \n</ul> \n<p>As another example of simple but important, the delta between <code class=\"language-plaintext highlighter-rouge\">Tr</code> and the <code class=\"language-plaintext highlighter-rouge\">AspNetDurationMs</code> header (a timer started and ended on the very start and tail of a request) tells us how much time was spent in the OS, waiting for a thread in IIS, etc.</p> \n<h4 id=\"health-checks\">Health Checks</h4> \n<p>Health checks are things that check…well, health. “Is this healthy?” has four general answers:</p> \n<ul> \n <li><strong>Yes</strong>: “ALL GOOD CAPTAIN!”</li> \n <li><strong>No</strong>: “@#$%! We’re down!”</li> \n <li><strong>Kinda</strong>: “Well, I guess we’re <em>technically</em> online…”</li> \n <li><strong>Unknown</strong>: “No clue…they won’t answer the phone”</li> \n</ul> \n<p>The conventions on these are generally green, red, yellow, and grey (or gray, whatever) respectively. Health checks have a few general usages. In any load distribution setup such as a cluster of servers working together or a load balancer in front of a group of servers, health checks are a way to see if a member is up to a role or task. For example in Elasticsearch if a node is down, it’ll rebalance shards and load across the other members…and do so again when the node returns to healthy. In a web tier, a load balancer will stop sending traffic to a down node and continue to balance it across the healthy ones.</p> \n<p>For HAProxy, we use the built-in health checks with a caveat. As of late 2018 when I’m writing this post, we’re in <a href=\"https://docs.microsoft.com/en-us/aspnet/mvc/mvc5\">ASP.NET MVC5</a> and still working on our transition to <a href=\"https://docs.microsoft.com/en-us/dotnet/core/\">.NET Core</a>. An important detail is that our error page is a redirect, for example <code class=\"language-plaintext highlighter-rouge\">/questions</code> to <code class=\"language-plaintext highlighter-rouge\">/error?aspxerrorpath=/questions</code>. It’s an implementation detail of how the old .NET infrastructure works, but when combined with HAProxy, it’s an issue. For example if you have:</p> \n<div class=\"language-plaintext highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code>server ny-web01 10.x.x.1:80 check\n</code></pre> \n </div> \n</div> \n<p>…then it will accept a <code class=\"language-plaintext highlighter-rouge\">200-399</code> <a href=\"https://en.wikipedia.org/wiki/List_of_HTTP_status_codes\">HTTP status code response</a>. (Also remember: it’s making a HEAD request only.) A <code class=\"language-plaintext highlighter-rouge\">400</code> or <code class=\"language-plaintext highlighter-rouge\">500</code> will trigger unhealthy, but our <a href=\"https://en.wikipedia.org/wiki/HTTP_302\"><code class=\"language-plaintext highlighter-rouge\">302</code> redirect</a> will not. A browser would get a <code class=\"language-plaintext highlighter-rouge\">5xx</code> status code <strong><em>after following the redirect</em></strong>, but HAProxy isn’t doing that. It’s only doing the initial hit and a “healthy” <code class=\"language-plaintext highlighter-rouge\">302</code> is all it sees. Luckily, you can change this with <code class=\"language-plaintext highlighter-rouge\">http-check expect 200</code> (or any status code or range or regex–<a href=\"https://cbonte.github.io/haproxy-dconv/1.7/configuration.html#4.2-http-check%20expect\">here are the docs</a>) on the same backend. This means <strong>only</strong> a <code class=\"language-plaintext highlighter-rouge\">200</code> is allowed from our health check endpoint. Yes, it’s bitten us more than once.</p> \n<p>Different apps vary on what the health check endpoint is, but for <a href=\"https://stackoverflow.com/\">stackoverflow.com</a>, it’s the home page. We’ve debated changing this a few times, but the reality is the home page checks things we may not otherwise check, and a holistic check is important. By this I mean, “If users hit the same page, would it work?” If we made a health check that hit the database and some caches and sanity checked the big things that we know need to be online, that’s great and it’s way better than nothing. But let’s say we put a bug in the code and a cache that doesn’t even seem that important doesn’t reload right and it turns out it was needed to render the top bar for all users. It’s now breaking every page. A health check route running some code wouldn’t trigger, but just the act of loading the master view ensures a huge number of dependencies are evaluated and working for the check.</p> \n<p>If you’re curious, that’s not a hypothetical. You know that little dot on the review queue that indicates a lot of items currently in queue? Yeah…fun Tuesday.</p> \n<p>We also have health checks inside libraries. The simplest manifestation of this is a <a href=\"https://en.wikipedia.org/wiki/Heartbeat_(computing)\">heartbeat</a>. This is something that for example <a href=\"https://github.com/StackExchange/StackExchange.Redis\">StackExchange.Redis</a> uses to routinely check if the socket connection to Redis is active. We use the same approach to see if the socket is still open and working to websocket consumers on Stack Overflow. This is a monitoring of sorts not heavily used here, but it is used.</p> \n<p>Other health checks we have in place include our tag engine servers. We could load balance this through HAProxy (which would add a hop) but making every web tier server aware of every tag server directly has been a better option for us. We can 1) choose how to spread load, 2) much more easily test new builds, and 3) get per-server op count counts metrics and performance data. All of that is another post, but for this topic: we have a simple “ping” health check that pokes the tag server once a second and gets just a little data from it, such as when it last updated from the database.</p> \n<p>So, that’s a thing. Your health checks can absolutely be used to communicate as much state as you want. If having it provides some advantage and the overhead is worth it (e.g. are you running another query?), have at it. The Microsoft .NET team has been working on <a href=\"https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/implement-resilient-applications/monitor-app-health\">a unified way to do health checks in ASP.NET Core</a>, but I’m not sure if we’ll go that way or not. I hope we can provide some ideas and unify things there when we get to it…more thoughts on that towards the end.</p> \n<p>However, keep in mind that health checks also generally run often. Very often. Their expense and expansiveness should be related to the frequency they’re running at. If you’re hitting it once every 100ms, once a second, once every 5 seconds, or once a minute, what you’re checking and how many dependencies are evaluated (and take a while to check…) very much matters. For example a 100ms check can’t take 200ms. That’s trying to do too much.</p> \n<p>Another note here is a health check can generally reflect a few levels of “up”. One is “I’m here”, which is as basic as it gets. The other is “I’m ready to serve”. The latter is much more important for almost every use case. But don’t phrase it quite like that to the machines, you’ll want to be in their favor when the uprising begins.</p> \n<p>A practical example of this happens at Stack Overflow: when you flip an HAProxy backend server from <code class=\"language-plaintext highlighter-rouge\">MAINT</code>&nbsp;(maintenance mode) to <code class=\"language-plaintext highlighter-rouge\">ENABLE</code>, the assumption is that the backend is up until a health check says otherwise. However, when you go from <code class=\"language-plaintext highlighter-rouge\">DRAIN</code>&nbsp;to <code class=\"language-plaintext highlighter-rouge\">ENABLE</code>, the assumption is the service is down, and must pass 3 health checks before getting traffic. When we’re dealing with thread pool growth limitations and caches trying to spin up (like our Redis connections), we can get very nasty thread pool starvation issues because of how the health check behaves. The impact is drastic. When we spin up slowly from a drain, it takes about 8-20 seconds to be fully ready to serve traffic on a freshly built web server. If we go from maintenance which slams the server with traffic during startup, it takes 2-3 minutes. The health check and traffic influx may seem like salient details, but it’s critical to our <a href=\"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/\">deployment pipeline</a>.</p> \n<h4 id=\"health-checks-httpunit\">Health Checks: httpUnit</h4> \n<p>An internal tool (again, open sourced!) is <a href=\"https://github.com/StackExchange/httpunit\">httpUnit</a>. It’s a fairly simple-to-use tool we use to check endpoints for compliance. Does this URL return the status code we expect? How about some text to check for? Is the certificate valid? (We couldn’t connect if it isn’t.) Does the firewall allow the rule?</p> \n<p>By having something continually checking this and feeding into alerts when it fails, we can quickly identify issues, especially those from invalid config changes to the infrastructure. We can also readily test new configurations or infrastructure, firewall rules, etc. before user load is applied. For more details, see <a href=\"https://github.com/StackExchange/httpunit\">the GitHub README</a>.</p> \n<h4 id=\"health-checks-fastly\">Health Checks: Fastly</h4> \n<p>If we zoom out from the data center, we need to see what’s hitting us. That’s usually our CDN &amp; proxy: <a href=\"https://www.fastly.com/\">Fastly</a>. Fastly has a concept of <a href=\"https://docs.fastly.com/guides/basic-setup/working-with-services\">services</a>, which are akin to HAProxy backends when you think about it like a load balancer. Fastly also has <a href=\"https://docs.fastly.com/guides/basic-configuration/working-with-health-checks\">health checks</a> built in. In each of our data centers, we have two sets of ISPs coming in for redundancy. We can configure things in Fastly to optimize uptime here.</p> \n<p>Let’s say our NY data center is primary at the moment, and CO is our backup. In that case, we want to try:</p> \n<ol> \n <li>NY primary ISPs</li> \n <li>NY secondary ISPs</li> \n <li>CO primary ISPs</li> \n <li>CO secondary ISPs</li> \n</ol> \n<p>The reason for primary and secondary ISPs has to do with best transit options, commits, overages, etc. With that in mind, we want to prefer one set over another. With health checks, we can very quickly failover from #1 through #4. Let’s say someone cuts the fiber on both ISPs in #1 or <a href=\"https://en.wikipedia.org/wiki/Border_Gateway_Protocol\">BGP</a> <a href=\"https://youtu.be/yhVDhcuRY1I?t=29\">goes wonky</a>, then #2 kicks in immediately. We may drop thousands of requests before it happens, but we’re talking about an order of seconds and users just refreshing the page are probably back in business. Is it perfect? No. Is it better than being down indefinitely? Hell yeah.</p> \n<h4 id=\"health-checks-external\">Health Checks: External</h4> \n<p>We also use some external health checks. Monitoring a global service, well…globally, is important. Are we up? Is Fastly up? Are we up here? Are we up there? Are we up in Siberia? Who knows!? We could get a bunch of nodes on a bunch of providers and monitor things with lots of set up and configuration…or we could just pay someone many orders of magnitude less money to outsource it. We use <a href=\"https://www.pingdom.com/\">Pingdom</a> for this. When things go down, it alerts us.</p> \n<h4 id=\"metrics\">Metrics</h4> \n<p>What are metrics? They can take a few forms, but for us they’re tagged <a href=\"https://en.wikipedia.org/wiki/Time_series\">time series data</a>. In short, this means you have a name, a timestamp, a value, and in our case, some tags. For example, a single entry looks like:</p> \n<ul> \n <li>Name: <code class=\"language-plaintext highlighter-rouge\">dotnet.memory.gc_collections</code></li> \n <li>Time: <code class=\"language-plaintext highlighter-rouge\">2018-01-01 18:30:00</code> (Of course it’s UTC, we’re not barbarians.)</li> \n <li>Value: <code class=\"language-plaintext highlighter-rouge\">129,389,139</code></li> \n <li>Tags: Server: <code class=\"language-plaintext highlighter-rouge\">NY-WEB01</code>, Application: <code class=\"language-plaintext highlighter-rouge\">StackExchange-Network</code></li> \n</ul> \n<p>The value in an entry can also take a few forms, but the general case is counters. Counters report an ever-increasing value (often reset to <code class=\"language-plaintext highlighter-rouge\">0</code> on restarts and such though). By taking the difference in value over time, you can find out the value delta in that window. For example, if we had 129,389,039 ten minutes before, we know that process on that server in those ten minutes ran 100 Gen 0 garbage collection passes. Another case is just reporting an absolute point-in-time value, for example “This GPU is currently 87°”. So what do we use to handle Metrics? In just a minute <a href=\"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun\">we’ll talk about Bosun</a>.</p> \n<h3 id=\"alerting\">Alerting</h3> \n<p>Alrighty, what do we do with all that data? ALERTS! As we all know, “alert” is an anagram that comes from “le rat”, meaning “one who squealed to authorities”.</p> \n<p>This happens at several levels and we customize it to the team in question and how they operate best. For the SRE (<a href=\"https://en.wikipedia.org/wiki/Site_Reliability_Engineering\">Site Reliability Engineering</a>) team, Bosun is our primary alerting source internally. For a detailed view of how alerts in Bosun work, I recommend watching <a href=\"https://www.usenix.org/conference/lisa14/conference-program/presentation/brandt\">Kyle’s presentation at LISA</a> (starting about 15 minutes in). In general, we’re alerting when:</p> \n<ul> \n <li>Something is down or warning directly (e.g. iDRAC logs)</li> \n <li>Trends don’t match previous trends (e.g. fewer <code class=\"language-plaintext highlighter-rouge\">x</code> events than normal–fun fact: this tends to false alarm over the holidays)</li> \n <li>Something is heading towards a wall (e.g. disk space or network maxing out)</li> \n <li>Something is past a threshold (e.g. a queue somewhere is building)</li> \n</ul> \n<p>…and lots of other little things, but those are the big categories that come to mind.</p> \n<p>If any problems are bad enough, we go to the next level: waking someone up. That’s when things get real. Some things that we monitor do not pass go and get their $200. They just go straight to <a href=\"https://www.pagerduty.com/\">PagerDuty</a> and wake up the on-call SRE. If that SRE doesn’t acknowledge, it escalates to another soon after. Significant others <em>love</em> when all this happens! Things of this magnitude are:</p> \n<ul> \n <li>stackoverflow.com (or any other important property) going offline (as seen by Pingdom)</li> \n <li>Significantly high error rates</li> \n</ul> \n<p>Now that we have all the boring stuff out of the way, let’s dig into the tools. Yummy tools!</p> \n<h3 id=\"bosun\">Bosun</h3> \n<p><a href=\"https://bosun.org\">Bosun</a> is our internal data collection tool for metrics and metadata. <a href=\"https://github.com/bosun-monitor/\">It’s open source</a>. Nothing out there really did what we wanted with metrics and alerting, so Bosun was created about four years ago and has helped us tremendously. We can add the metrics we want whenever we want, new functionality as we need, etc. It has all the benefits of an in-house system. And it has all of the costs too. I’ll get to that later. It’s written in <a href=\"https://golang.org/\">Go</a>, primarily because the vast majority of the metrics collection is agent-based. The agent, <a href=\"https://github.com/bosun-monitor/bosun/tree/master/cmd/scollector\">scollector</a> (heavily based on principles from <a href=\"http://opentsdb.net/docs/build/html/user_guide/utilities/tcollector.html\">tcollector</a>) needed to run on all platforms and Go was our top choice for this. “Hey Nick, what about .NET Core??” Yeah, maybe, but it’s not quite there yet. The story is getting more compelling, though. Right now we can deploy a single executable very easily and Go is still ahead there.</p> \n<p>Bosun is backed by <a href=\"https://github.com/OpenTSDB/opentsdb\">OpenTSDB</a> for storage. It’s a <a href=\"https://en.wikipedia.org/wiki/Time_series_database\">time-series database</a> built on top of <a href=\"https://hbase.apache.org/\">HBase</a> that’s made to be very scalable. At least that’s what people tell us. The problems we hit at Stack Exchange/Stack Overflow usually come from efficiency and throughput perspectives. We do a lot with a little hardware. In some ways, this is impressive and we’re proud of it. In other ways, it bends and breaks things that aren’t designed to run that way. In the OpenTSDB case, we don’t <em>need</em> lots of hardware to run it from a space standpoint, but the way HBase is designed we have to give it more hardware (especially on the network front). It’s an HBase replication issue when dealing with tiny amounts of data that I don’t want to get too far into here, as that’s a post all by itself. A long one. For some definition of long.</p> \n<p>Let’s just say it’s a pain in the ass and it costs money to work around, so much so that we’ve tried to get Bosun backed by SQL Server clustered column store indexes instead. We have this working, but the queries for certain cardinalities aren’t spectacular and cause high CPU usage. Things like getting aggregate bandwidth for the Nexus switch cores summing up 400x more data points than most other metrics is not awesome. Most stuff runs great. Logging 50–100k metrics per second only uses ~5% CPU on a decent server–that’s not an issue. Certain queries are the pain point and we haven’t returned to that problem…it’s a “maybe” on if we can solve it and how much time that would take. Anyway, that’s another post too.</p> \n<p>If you want to know more about our Bosun setup and configuration, <a href=\"http://kbrandt.com/post/bosun_arch/\">Kyle Brandt has an awesome architecture post here.</a></p> \n<h4 id=\"bosun-metrics\">Bosun: Metrics</h4> \n<p>In the .NET case, we’re sending metrics with <a href=\"https://github.com/StackExchange/BosunReporter\">BosunReporter</a>, another open source <a href=\"https://www.nuget.org/packages/BosunReporter/\">NuGet library</a> we maintain. It looks like this:</p> \n<div class=\"language-c# highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"c1\">// Set it up once globally</span>\n<span class=\"kt\">var</span> <span class=\"n\">collector</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">MetricsCollector</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nf\">BosunOptions</span><span class=\"p\">(</span><span class=\"n\">ex</span> <span class=\"p\">=&gt;</span> <span class=\"nf\">HandleException</span><span class=\"p\">(</span><span class=\"n\">ex</span><span class=\"p\">))</span>\n<span class=\"p\">{</span>\n\t<span class=\"n\">MetricsNamePrefix</span> <span class=\"p\">=</span> <span class=\"s\">\"MyApp\"</span><span class=\"p\">,</span>\n\t<span class=\"n\">BosunUrl</span> <span class=\"p\">=</span> <span class=\"s\">\"https://bosun.mydomain.com\"</span><span class=\"p\">,</span>\n\t<span class=\"n\">PropertyToTagName</span> <span class=\"p\">=</span> <span class=\"n\">NameTransformers</span><span class=\"p\">.</span><span class=\"n\">CamelToLowerSnakeCase</span><span class=\"p\">,</span>\n\t<span class=\"n\">DefaultTags</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Dictionary</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">,</span> <span class=\"kt\">string</span><span class=\"p\">&gt;</span>\n\t\t<span class=\"p\">{</span> <span class=\"p\">{</span><span class=\"s\">\"host\"</span><span class=\"p\">,</span> <span class=\"n\">NameTransformers</span><span class=\"p\">.</span><span class=\"nf\">Sanitize</span><span class=\"p\">(</span><span class=\"n\">Environment</span><span class=\"p\">.</span><span class=\"n\">MachineName</span><span class=\"p\">.</span><span class=\"nf\">ToLower</span><span class=\"p\">())}</span> <span class=\"p\">}</span>\n<span class=\"p\">});</span>\n\n<span class=\"c1\">// Whenever you want a metric, create one! This should be likely be static somewhere</span>\n<span class=\"c1\">// Arguments: metric name, unit name, description</span>\n<span class=\"k\">private</span> <span class=\"k\">static</span> <span class=\"n\">searchCounter</span> <span class=\"p\">=</span> <span class=\"n\">collector</span><span class=\"p\">.</span><span class=\"n\">CreateMetric</span><span class=\"p\">&lt;</span><span class=\"n\">Counter</span><span class=\"p\">&gt;(</span><span class=\"s\">\"web.search.count\"</span><span class=\"p\">,</span> <span class=\"s\">\"searches\"</span><span class=\"p\">,</span> <span class=\"s\">\"Searches against /search\"</span><span class=\"p\">);</span>\n\n<span class=\"c1\">// ...and whenever the event happens, increment the counter</span>\n<span class=\"n\">searchCounter</span><span class=\"p\">.</span><span class=\"nf\">Increment</span><span class=\"p\">();</span>\n</code></pre> \n </div> \n</div> \n<p>That’s pretty much it. We now have a counter of data flowing into Bosun. We can add more tags–for example, we are including which server it’s happening on (via the <code class=\"language-plaintext highlighter-rouge\">host</code> tag), but we could add the application pool in IIS, or the Q&amp;A site the user’s hitting, etc. For more details, check out <a href=\"https://github.com/StackExchange/BosunReporter\">the BosunReporter README</a>. It’s awesome.</p> \n<p>Many other systems can send metrics, and scollector <a href=\"https://bosun.org/scollector/\">has a ton built-in</a> for Redis, Windows, Linux, etc. Another external example that we use for critical monitoring is a small Go service that listens to <a href=\"https://docs.fastly.com/guides/detailed-product-descriptions/about-fastlys-realtime-log-streaming-features\">the real-time stream of Fastly logs</a>. Sometimes Fastly may return a 503 because it couldn’t reach us, or because…who knows? Anything between us and them could go wrong. Maybe it’s severed sockets, or a routing issue, or a bad certificate. Whatever the cause, we want to alert when these requests are failing and users are feeling it. This small service just listens to the log stream, parses a bit of info from each entry, and sends aggregate metrics to Bosun. This isn’t open source at the moment because…well I’m not sure we’ve ever mentioned it exists. If there’s demand for such a thing, shout and we’ll take a look.</p> \n<h4 id=\"bosun-alerting\">Bosun: Alerting</h4> \n<p>A key feature of Bosun I really love is the ability to test an alert against history while designing it. This helps seeing <em>when it would have triggered</em>. It’s an awesome sanity check. Let’s be honest, monitoring isn’t perfect, it was never perfect, and it won’t ever be perfect. A lot of monitoring comes from lessons learned, because the things that go wrong often include things you never even considered going wrong…and that means you didn’t have monitoring and/or alerts on them from day 1. Alerts are often added <em>after</em> something goes wrong. Despite your best intentions and careful planning, you will miss things and alerts will be added after the first incident. That’s okay. It’s in the past. All you can do <em>now</em> is make things better in the hopes that it doesn’t happen again. Whether you’re designing ahead of time or in retrospect, this feature is awesome:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert.png\" loading=\"lazy\" alt=\"Bosun Alert Editor\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert-Test.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert-Test.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert-Test.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert-Test.png\" loading=\"lazy\" alt=\"Bosun Alert Test\" /> \n  </picture></a></p> \n<p>You can see on November 18th there was one system that got low enough to trigger a warning here, but otherwise all green. Sanity checking if an alert is noisy before anyone ever gets notified? I love it.</p> \n<p>And then we have critical errors that are so urgent they need to be addressed ASAP. For those cases, we post them to our internal chat rooms. These are things like errors creating a <a href=\"https://stackoverflow.com/teams\">Stack Overflow Team</a> (You’re trying to give us money and we’re erroring? Not. Cool.) or a scheduled task is failing. We also have metrics monitoring (via Bosun) errors in a few ways:</p> \n<ul> \n <li>From our Exceptional error logs (summed up per application)</li> \n <li>From Fastly and HAProxy</li> \n</ul> \n<p>If we’re seeing a high error rate for any reason on either of these, messages with details land in chat a minute or two after. (Since they’re aggregate count based, they can’t be immediate.)</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Chat-Alerts.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Chat-Alerts.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Chat-Alerts.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Chat-Alerts.png\" loading=\"lazy\" alt=\"Bosun Chat Alerts\" /> \n  </picture></a></p> \n<p>These messages with links let us quickly dig into the issue. Did the network blip? Is there a routing issue between us and <a href=\"https://www.fastly.com/\">Fastly</a> (our proxy and CDN)? Did some bad code go out and it’s erroring like crazy? Did someone trip on a power cable? Did some idiot plug both power feeds into the same failing UPS? All of these are extremely important and we want to dig into them ASAP.</p> \n<p>Another way alerts are relayed is email. Bosun has some nice functionality here that assists us. An email may be a simple alert. Let’s say disk space is running low or CPU is high and a simple graph of that in the email tells a lot. …and then we have more complex alerts. Let’s say we’re throwing over our allowed threshold of errors in the shared error store. Okay great, we’ve been alerted! But…which app was it? Was it a one-off spike? Ongoing? Here’s where the ability to define queries for more data from SQL or Elasticsearch come in handy (remember all that logging?). We can add breakdowns and details to the email itself. You can be better informed to handle (or even decide to ignore) an email alert without digging further. Here’s an example email from NY-TSDB03’s CPU spiking a few days ago:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email.png\" loading=\"lazy\" alt=\"Bosun: Email\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email2.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email2.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email2.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email2.png\" loading=\"lazy\" alt=\"Bosun: Email\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email3.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email3.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email3.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email3.png\" loading=\"lazy\" alt=\"Bosun: Email\" /> \n  </picture></a></p> \n<p>We also include the last 10 incidents for this alert on the systems in question so you can easily identify a pattern, see why they were dismissed, etc. They’re just not in this particular email I was using as an example.</p> \n<h3 id=\"grafana\">Grafana</h3> \n<p>Okay cool. Alerts are nice, but I just want to see some data… I got you fam!</p> \n<p>After all, what good is all that data if you can’t see it? Presentation and accessibility matter. Being able to quickly consume the data is important. Graphical vizualizations for time series data are an excellent way of exploring. When it comes to monitoring, you have to either 1) be looking at the data, or 2) have rock solid 100% coverage with alerts so no one has to ever look at the data. And #2 isn’t possible. When a problem is found, often you’ll need to go back and see when it started. “HOW HAVE WE NOT NOTICED THIS IN 2 WEEKS?!?” isn’t as uncommon as you’d think. So, historical views help.</p> \n<p>This is where we use <a href=\"https://grafana.com/\">Grafana</a>. It’s an excellent open source tool, for which we provide <a href=\"https://grafana.com/plugins/bosun-app/installation\">a Bosun plugin</a> so it can be a data source. (Technically you can use OpenTSDB directly, but this adds functionality.) Our use of Grafana is probably best explained in pictures, so a few examples are in order.</p> \n<p>Here’s a status dashboard showing how Fastly is doing. Since we’re behind them for DDoS protection and faster content delivery, their current status is also very much our current status.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Fastly.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Fastly.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Fastly.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Fastly.png\" loading=\"lazy\" alt=\"Grafana: Fastly\" /> \n  </picture></a></p> \n<p>This is just a random dashboard that I think is pretty cool. It’s traffic broken down by country of origin. It’s split into major continents and you can see how traffic rolls around the world as people are awake.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Continents.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Continents.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Continents.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Continents.png\" loading=\"lazy\" alt=\"Grafana: Continents\" /> \n  </picture></a></p> \n<p>If you follow me on Twitter, you’re likely aware <a href=\"https://github.com/aspnet/AspNetCore/issues/3409#issuecomment-436677987\">we’re having some garbage collection issues with .NET Core</a>. Needing to keep an eye on this isn’t new though. We’ve had this dashboard for years:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-GC.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Grafana-GC.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Grafana-GC.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-GC.png\" loading=\"lazy\" alt=\"Grafana: Garbage Collection\" /> \n  </picture></a></p> \n<p>Note: Don’t go by any numbers above for scale of any sort, these screenshots were taken on a holiday weekend.</p> \n<h3 id=\"client-timings\">Client Timings</h3> \n<p>An important note about <strong><em>everything</em></strong> above is that <strong>it’s server side</strong>. Did you think about it until now? If you did, awesome. A lot of people don’t think that way until one day when it matters. But it’s always important.</p> \n<p>It’s critical to remember that how fast you render a webpage doesn’t matter. Yes, I said that. It doesn’t matter, not directly anyway. The only thing that matters is how fast users <em>think</em> your site is. How fast does it <em>feel</em>? This manifests in many ways on the client experience, from the initial painting of a page to when content blinks in (please don’t blink or shift!), ads render, etc.</p> \n<p>Things that factor in here are, for example, how long did it take to…</p> \n<ul> \n <li>Connect over TCP? (<a href=\"https://daniel.haxx.se/blog/2018/11/11/http-3/\">HTTP/3</a> isn’t here yet)</li> \n <li>Negotiate the TLS connection?</li> \n <li>Finish sending the request?</li> \n <li>Get the first byte?</li> \n <li>Get the last byte?</li> \n <li>Initially paint the page?</li> \n <li>Issue requests for resources in the page?</li> \n <li>Render all the things?</li> \n <li>Finish attaching JavaScript handlers?</li> \n</ul> \n<p>…hmmm, good questions! These are the things that matter to the user experience. Our question pages render in 18ms. I think that’s awesome. And I might even be biased. …but it also doesn’t mean crap to a user if it takes forever to get to them.</p> \n<p>So, what can we do? Years back, I threw together a client timings pipeline when the pieces we needed first became available in browsers. The concept is simple: use the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Navigation_timing_API\">navigation timings API</a> available in web browsers and record it. That’s it. There’s some sanity checks in there (you wouldn’t believe the number of NTP clock corrections that yield invalid timings from syncs <em>during a render</em> making clocks go backwards…), but otherwise that’s pretty much it. For 5% of requests to Stack Overflow (or any Q&amp;A site on our network), we ask the browser to send these timings. We can adjust this percentage at will.</p> \n<p>For a description of how this works, you can visit <a href=\"https://teststackoverflow.com/\">teststackoverflow.com</a>. Here’s what it looks like:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Breakdown.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Breakdown.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Breakdown.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Breakdown.png\" loading=\"lazy\" alt=\"Client Timings: Breakdown\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-JSON.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-JSON.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-JSON.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-JSON.png\" loading=\"lazy\" alt=\"Client Timings: JSON\" /> \n  </picture></a></p> \n<p>This domain isn’t <em>exactly</em> monitoring, but it kind of is. We use it to test things like <a href=\"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/\">when we switched to HTTPS</a> what the impact for everyone would be with connection times around the world (that’s why I originally created the timings pipeline). It was also used <a href=\"https://blog.serverfault.com/2017/01/09/surviving-the-next-dns-attack/\">when we added DNS providers</a>, something we now have several of after <a href=\"https://en.wikipedia.org/wiki/2016_Dyn_cyberattack\">the Dyn DNS attack</a> in 2016. How? Sometimes I sneakily embed it as an <code class=\"language-plaintext highlighter-rouge\">&lt;iframe&gt;</code> on <code class=\"language-plaintext highlighter-rouge\">stackoverflow.com</code> to throw a lot of traffic at it so we can test something. But don’t tell anyone, it’ll just be between you and me.</p> \n<p>Okay, so now we have some data. If we take that for 5% of traffic, send it to a server, plop it in a giant clustered columnstore in SQL and send some metrics to Bosun along the way, we have something useful. We can test before and after configs, looking at the data. We can also keep an eye on current traffic and look for problems. We use Grafana for the last part, and it looks like this:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Grafana.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Grafana.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Grafana.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Grafana.png\" loading=\"lazy\" alt=\"Client Timings: Grafana\" /> \n  </picture></a></p> \n<p>Note: that’s a 95% percentile view, the median total render time is the white dots towards the bottom (under 500ms most days).</p> \n<h3 id=\"miniprofiler\">MiniProfiler</h3> \n<p>Sometimes the data you want to capture is more specific and detailed than the scenarios above. In our case, we decided almost a decade ago that we wanted to see how long a webpage takes to render in the corner of every single page view. Equally important to monitoring anything is <em>looking at it</em>. Making it visible on every single page you look at is a good way of making that happen. And thus, <a href=\"https://miniprofiler.com/\">MiniProfiler</a> was born. It comes in a few flavors (the projects vary a bit): <a href=\"https://github.com/MiniProfiler/dotnet\">.NET</a>, <a href=\"https://github.com/MiniProfiler/rack-mini-profiler\">Ruby</a>, <a href=\"https://github.com/MiniProfiler/go\">Go</a>, and <a href=\"https://github.com/MiniProfiler/node\">Node.js</a>. We’re looking at the .NET version I maintain here:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler.png\" loading=\"lazy\" alt=\"MiniProfiler\" /> \n  </picture></a></p> \n<p>The number is all you see by default, but you can expand it to see a breakdown of which things took how long, in tree form. The commands that are linked there are also viewable, so you can quickly see the SQL or Elastic query that ran, or the HTTP call made, or the Redis key fetched, etc. Here’s what that looks like:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Queries.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Queries.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Queries.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Queries.png\" loading=\"lazy\" alt=\"MiniProfiler: Queries\" /> \n  </picture></a></p> \n<p>Note: If you’re thinking, that’s <strong><em>way</em></strong> longer than we say our question renders take on average (or even 99th percentile), yes, it is. That’s because I’m a moderator here and we load a lot more stuff for moderators.</p> \n<p>Since MiniProfiler has minimal overhead, we can run it on every request. To that end, we keep a sample of profiles per-MVC-route in Redis. For example, we keep the 100 slowest profiles of any route at a given time. This allows us to see what users may be hitting that we aren’t. Or maybe anonymous users use a different query and it’s slow…we need to see that. We can see the routes being slow in Bosun, the hits in HAProxy logs, and the profile snapshots to dig in. All of this without seeing any code at all, that’s a powerful overview combination. MiniProfiler is awesome (like I’m not biased…) but it is also part of a bigger set of tools here.</p> \n<p>Here’s a view of what those snapshots and aggregate summaries looks like:</p> \n<table> \n <thead> \n  <tr> \n   <th>Snapshots</th> \n   <th>Summary</th> \n  </tr> \n </thead> \n <tbody> \n  <tr> \n   <td><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots.png\" target=\"_blank\"> \n     <picture> \n      <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots.webp\" /> \n      <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots.png\" /> \n      <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots.png\" loading=\"lazy\" alt=\"MiniProfiler Snapshots\" /> \n     </picture></a></td> \n   <td><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots2.png\" target=\"_blank\"> \n     <picture> \n      <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots2.webp\" /> \n      <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots2.png\" /> \n      <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots2.png\" loading=\"lazy\" alt=\"MiniProfiler Summary\" /> \n     </picture></a></td> \n  </tr> \n </tbody> \n</table> \n<p>…we should probably put an example of that in the repo. I’ll try and get around to it soon.</p> \n<p>MiniProfiler was started by <a href=\"https://twitter.com/marcgravell\">Marc Gravell</a>, <a href=\"https://twitter.com/samsaffron\">Sam Saffron</a>, and <a href=\"https://twitter.com/jarrod_dixon\">Jarrod Dixon</a>. I am the primary maintainer since 4.x, but these gentleman are responsible for it existing. We put MiniProfiler in all of our applications.</p> \n<p>Note: see those GUIDs in the screenshots? That’s MiniProfiler just generating an ID. We now use that as a “Request ID” and it gets logged in those HAProxy logs and to any exceptions as well. Little things like this help tie the world together and let you correlate things easily.</p> \n<h3 id=\"opserver\">Opserver</h3> \n<p>So, what is <a href=\"https://github.com/opserver/Opserver\">Opserver</a>? It’s a web-based dashboard and monitoring tool I started when SQL Server’s built-in monitoring lied to us one day. About 5 years ago, we had an issue where SQL Server AlwaysOn Availability Groups showed green on the SSMS dashboard (powered by the primary), but the replicas hadn’t seen new data for days. This was an example of extremely broken monitoring. What happened was the HADR thread pool exhausted and stopped updating a view that had a state of “all good”. I’d link you to the Connect item but they just deleted them all. I’m not bitter. The design of such isn’t necessarily flawed, but when caching/storing the state of a thing, <strong>it needs to have a timestamp</strong>. If it hasn’t been updated in <code class=\"language-plaintext highlighter-rouge\">&lt;pick a threshold&gt;</code>, that’s a red alert. Nothing about the state can be trusted. Anyway, enter Opserver. The first thing it did was monitor each SQL node rather than trusting the master.</p> \n<p>Since then, I’ve added monitoring for our other systems we wanted in a quick web-based view. We can see all servers (based on Bosun, or Orion, or WMI directly). Here is an overview of where Opserver is today:</p> \n<h4 id=\"opserver-primary-dashboard\">Opserver: Primary Dashboard</h4> \n<p>The landing dashboard is a server list showing an overview of what’s up. Users can search by name, service tag, IP address, VM host, etc. You can also drill down to all-time history graphs for CPU, memory, and network on each node.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers.png\" loading=\"lazy\" alt=\"Dashboard\" /> \n  </picture></a></p> \n<p>Within each node looks like this:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node.png\" loading=\"lazy\" alt=\"Dashboard: Node\" /> \n  </picture></a></p> \n<p>If using Bosun and running Dell servers, we’ve added hardware metadata like this:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node-Hardware.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node-Hardware.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node-Hardware.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node-Hardware.png\" loading=\"lazy\" alt=\"Dashboard: Node Hardware\" /> \n  </picture></a></p> \n<h4 id=\"opserver-sql-server\">Opserver: SQL Server</h4> \n<p>In the SQL dashboard, we can see server status and how the availability groups are doing. We can see how much activity each node has and which one is primary (in blue) at any given time. The bottom section is <a href=\"https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server\">AlwaysOn Availability Groups</a>, we can see who’s primary for each, how far behind replication is, and how much queues are backed up. If things go south and a replica is unhealthy, some more indicators pop in like which databases are having issues and the free disk space on the primary for all drives involved in T-logs (since they will start growing if replication remains down):</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL.png\" loading=\"lazy\" alt=\"SQL Dashboard\" /> \n  </picture></a></p> \n<p>There’s also a top-level all-jobs view for quick monitoring and enabling/disabling:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Jobs.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Jobs.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Jobs.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Jobs.png\" loading=\"lazy\" alt=\"SQL Jobs\" /> \n  </picture></a></p> \n<p>And in the per-instance view we can see the stats about the server, caches, etc., that we’ve found relevant over time.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Instance.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Instance.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Instance.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Instance.png\" loading=\"lazy\" alt=\"SQL Instance\" /> \n  </picture></a></p> \n<p>For each instance, we also report top queries (based on plan cache, not query store yet), active-right now queries (based on <a href=\"http://whoisactive.com/\">sp_whoisactive</a>), connections, and database info.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top.png\" loading=\"lazy\" alt=\"SQL Top Queries\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Active.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Active.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Active.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Active.png\" loading=\"lazy\" alt=\"SQL Active Queries\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Connections.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Connections.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Connections.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Connections.png\" loading=\"lazy\" alt=\"SQL Connections\" /> \n  </picture></a></p> \n<p>…and if you want to drill down into a top query, it looks like this:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top-Query.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top-Query.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top-Query.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top-Query.png\" loading=\"lazy\" alt=\"SQL Top Queries\" /> \n  </picture></a></p> \n<p>In the databases view, there are drill downs to see tables, indexes, views, stored procedures, storage usage, etc.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Databases.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Databases.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Databases.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Databases.png\" loading=\"lazy\" alt=\"SQL Databases\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database.png\" loading=\"lazy\" alt=\"SQL Database\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Table.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Table.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Table.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Table.png\" loading=\"lazy\" alt=\"SQL Database Table\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Storage.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Storage.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Storage.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Storage.png\" loading=\"lazy\" alt=\"SQL Database Storage\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Unused-Indexes.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Unused-Indexes.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Unused-Indexes.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Unused-Indexes.png\" loading=\"lazy\" alt=\"SQL Unused Indexes\" /> \n  </picture></a></p> \n<h4 id=\"opserver-redis\">Opserver: Redis</h4> \n<p>For Redis, we want to see the topology chain of primary and replicas as well as the overall status of each instance:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Instance.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Instance.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Instance.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Instance.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<p>Note that you can kill client connections, get the active config, change server topologies, and analyze the data in each database (configurable via <a href=\"https://twitter.com/Nick_Craver/status/1051221337413431298\">Regexes</a>). The last one is a heavy <a href=\"https://redis.io/commands/keys\"><code class=\"language-plaintext highlighter-rouge\">KEYS</code></a> and <a href=\"https://redis.io/commands/debug-object\"><code class=\"language-plaintext highlighter-rouge\">DEBUG OBJECT</code></a> scan, so we run it on a replica node or are allowed to force running it on a master (for safety). Analysis looks like this:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Analyze.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Analyze.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Analyze.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Analyze.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<h4 id=\"opserver-elasticsearch\">Opserver: Elasticsearch</h4> \n<p>For Elasticsearch, we usually want to see things in a cluster view since that’s how it behaves. What isn’t seen below is that when an index goes yellow or red. When that happens, new sections of the dashboard appear showing shards that are in trouble, what they’re doing (initializing, relocating, etc.), and counts appear in each cluster summarizing how many are in which status.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic-Node.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic-Node.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic-Node.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic-Node.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<p>Note: the PagerDuty tab up there pulls from the PagerDuty API and displays on-call information, who’s primary, secondary, allows you to see and claim incidents, etc. Since it’s almost 100% not data you’d want to share, there’s no screenshot here. :) It also has a configurable raw HTML section to give visitors instructions on what to do or who to reach out to.</p> \n<h4 id=\"opserver-exceptions\">Opserver: Exceptions</h4> \n<p>Exceptions in Opserver are based on <a href=\"https://github.com/NickCraver/StackExchange.Exceptional\">StackExchange.Exceptional</a>. In this case specifically, we’re looking at the SQL Server storage provider for Exceptional. Opserver is a way for many applications to share a single database and table layout and have developers view their exceptions in one place.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<p>The top level view here can just be applications (the default), or it can be configured in groups. In the above case, we’re configuring application groups by team so a team can bookmark or quickly click on the exceptions they’re responsible for. In the per-exception page, the detail looks like this:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Stack.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Stack.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Stack.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Stack.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Command.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Command.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Command.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Command.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<p>There are also details recorded like request headers (with security filters so we don’t log authentication cookies for example), query parameters, and any other custom data added to an exception.</p> \n<p>Note: you can configure multiple stores, for instance we have New York and Colorado above. These are separate databases allowing all applications to log to a very-local store and still get to them from a single dashboard.</p> \n<h4 id=\"opserver-haproxy\">Opserver: HAProxy</h4> \n<p>The HAProxy section is pretty straightforward–we’re simply presenting the current HAProxy status and allowing control of it. Here’s what the main dashboard looks like:</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<p>For each background group, specific backend server, entire server, or entire tier, it also allows some control. We can take a backend server out of rotation, or an entire backend down, or a web server out of all backends if we need to shut it down for emergency maintenance, etc.</p> \n<p><a href=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy-Control.png\" target=\"_blank\"> \n  <picture> \n   <source type=\"image/webp\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy-Control.webp\" /> \n   <source type=\"image/png\" srcset=\"/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy-Control.png\" /> \n   <img src=\"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy-Control.png\" loading=\"lazy\" alt=\"Redis\" /> \n  </picture></a></p> \n<h4 id=\"opserver-faqs\">Opserver: FAQs</h4> \n<p>I get the same questions about Opserver routinely, so let’s knock a few of them out:</p> \n<ul> \n <li>Opserver does <strong>not</strong> require a data store of any kind for itself (it’s all config and in-memory state). \n  <ul> \n   <li>This may happen in the future to enhance functionality, but there are no plans to require anything.</li> \n  </ul> </li> \n <li>Only the dashboard tab and per-node view is powered by Bosun, Orion, or WMI - all other screens like SQL, Elastic, Redis, etc. have no dependency…Opserver monitors these directly.</li> \n <li>Authentication is both global and per-tab pluggable (who can view and who’s an admin are separate), but built-in configuration is via groups and Active Directory is included. \n  <ul> \n   <li>On admin vs. viewer: A viewer gets a read-only view. For example, HAProxy controls wouldn’t be shown.</li> \n  </ul> </li> \n <li>All tabs are not required–each is independent and only appears if configured. \n  <ul> \n   <li>For example, if you wanted to only use Opserver as an Elastic or Exceptions dashboard, go nuts.</li> \n  </ul> </li> \n</ul> \n<p><strong>Note</strong>: Opserver is currently being ported to ASP.NET Core as I have time at night. This should allow it to run without IIS and hopefully run on other platforms as well soon. Some things like AD auth to SQL Servers from Linux and such is still on the figure-it-out list. If you’re looking to deploy Opserver, just be aware deployment and configuration will change drastically soon (it’ll be simpler) and it may be better to wait.</p> \n<h3 id=\"where-do-we-go-next\">Where Do We Go Next?</h3> \n<p>Monitoring is an ever-evolving thing. For just about everyone, I think. But I can only speak of plans I’m involved in…so what do <em>we</em> do next?</p> \n<h4 id=\"health-check-next-steps\">Health Check Next Steps</h4> \n<p>Health check improvements are something I’ve had in mind for a while, but haven’t found the time for. When you’re monitoring things, the source of truth is a matter of concern. There’s what a thing <strong><em>is</em></strong> and what a thing <strong><em>should be</em></strong>. Who defines the latter? I think we can improve things here on the dependency front and have it generally usable across the board (…and I really hope someone’s already doing similar, tell me if so!). What if we had a simple structure from the health checks like this:</p> \n<div class=\"language-c# highlighter-rouge\"> \n <div class=\"highlight\"> \n  <pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">HealthResult</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">AppName</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">ServerName</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">HealthStatus</span> <span class=\"n\">Status</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">List</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;</span> <span class=\"n\">Tags</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">List</span><span class=\"p\">&lt;</span><span class=\"n\">HealthResult</span><span class=\"p\">&gt;</span> <span class=\"n\">Dependencies</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">Dictionary</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">,</span> <span class=\"kt\">string</span><span class=\"p\">&gt;</span> <span class=\"n\">Attributes</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"k\">public</span> <span class=\"k\">enum</span> <span class=\"n\">HealthStatus</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">Healthy</span><span class=\"p\">,</span>\n    <span class=\"n\">Warning</span><span class=\"p\">,</span>\n    <span class=\"n\">Critical</span><span class=\"p\">,</span>\n    <span class=\"n\">Unknown</span>\n<span class=\"p\">}</span>\n</code></pre> \n </div> \n</div> \n<p>This is just me thinking out loud here, but the key part is the <code class=\"language-plaintext highlighter-rouge\">Dependencies</code>. What if you asked a web server “Hey buddy, how ya doing?” and it returned not a simple JSON object, but a tree of them? But each level is all the same thing, so overall we’d have a recursive list of dependencies. For example, a dependency list that included Redis–if we couldn’t reach 1 of 2 Redis nodes, we’d have 2 dependencies in the list, a <code class=\"language-plaintext highlighter-rouge\">Healthy</code> for one and a <code class=\"language-plaintext highlighter-rouge\">Critical</code> or <code class=\"language-plaintext highlighter-rouge\">Unknown</code> for the other in the dependency list and the web server would be <code class=\"language-plaintext highlighter-rouge\">Warning</code> instead of <code class=\"language-plaintext highlighter-rouge\">Healthy</code>.</p> \n<p>The main point here is: <strong>the monitoring system doesn’t need to know about dependencies</strong>. The systems themselves define them and return them. This way we don’t get into config skew where what’s being monitored doesn’t match what should be there. This can happen often in deployments with topology or dependency changes.</p> \n<p>This may be a terrible idea, but it’s a general one I have for Opserver (or any script really) to get a health reading and the <em>why</em> of a health reading. If we lose another node, these <code class=\"language-plaintext highlighter-rouge\">n</code> things break. Or, we see the common cause of <code class=\"language-plaintext highlighter-rouge\">n</code> health warnings. By pointing at a few endpoints, we could get a tree view of everything. Need to add more data for your use case? Sure! It’s JSON, so just inherit from the object and add more stuff as needed. It’s an easily extensible model. I think. I need to take the time to build this…maybe it’s full of problems. Or maybe someone reading this will tell me it’s already done (hey you!).</p> \n<h4 id=\"bosun-next-steps\">Bosun Next Steps</h4> \n<p>Bosun has largely been in maintenance mode due to a lack of resources and other priorities. We haven’t done as much as we’d like because we need to have the discussion on the best path forward. Have other tools caught up and filled the gaps that caused us to build it in the first place? Has SQL 2017 or 2019 already improved the queries we had issues with lowering the bar greatly? We need to take some time and look at the landscape and evaluate what we want to do. This is something we want to get into during Q1 2019.</p> \n<p>We know of some things we’d like to do, such as improving the alert editing experience and some other UI areas. We just need to weigh some things and figure out where our time is best spent as with all things.</p> \n<h4 id=\"metrics-next-steps\">Metrics Next Steps</h4> \n<p>We are drastically under-utilizing metrics across our applications. We know this. The system was built for SREs and developers primarily, but showing developers all the benefits and how powerful metrics are (including how easy they are to add) is something we haven’t done well. This is a topic we discussed at a company meetup last month. They’re so, so cheap to add and we could do a lot better. Views differ here, but I think it’s mostly a training and awareness issue we’ll strive to improve.</p> \n<p>The health checks above…maybe we easily allow integrating metrics from BosunReporter there as well (probably only when asked for) to make one decently powerful API to check the health and status of a service. This would allow a pull model for the same metrics we normally push. It needs to be as cheap as possible and allocate little, though.</p> \n<h3 id=\"tools-summary\">Tools Summary</h3> \n<p>I mentioned several tools we’ve built and open sourced above. Here’s a handy list for reference:</p> \n<ul> \n <li><a href=\"https://bosun.org\">Bosun</a>: Go-based monitoring and alerting system – primary developed by <a href=\"https://twitter.com/kylembrandt\">Kyle Brandt</a>, <a href=\"https://twitter.com/captncraig\">Craig Peterson</a>, and <a href=\"https://twitter.com/mjibson\">Matt Jibson</a>.</li> \n <li><a href=\"https://grafana.com/plugins/bosun-app\">Bosun: Grafana Plugin</a>: A data source plugin for Grafana – developed by <a href=\"https://twitter.com/kylembrandt\">Kyle Brandt</a>.</li> \n <li><a href=\"https://github.com/StackExchange/BosunReporter\">BosunReporter</a>: .NET metrics collector/sender for Bosun – developed by <a href=\"https://twitter.com/bretcope\">Bret Copeland</a>.</li> \n <li><a href=\"https://github.com/StackExchange/httpunit\">httpUnit</a>: Go-based HTTP monitor for testing compliance of web endpoints – developed by <a href=\"https://twitter.com/mjibson\">Matt Jibson</a> and <a href=\"https://twitter.com/yesthattom\">Tom Limoncelli</a>.</li> \n <li><a href=\"https://github.com/MiniProfiler/dotnet\">MiniProfiler</a>: .NET-based (with other languages available like Node and Ruby) lightweight profiler for seeing page render times in real-time – created by <a href=\"https://twitter.com/marcgravell\">Marc Gravell</a>, <a href=\"https://twitter.com/samsaffron\">Sam Saffron</a>, and <a href=\"https://twitter.com/jarrod_dixon\">Jarrod Dixon</a> and maintained by <a href=\"https://twitter.com/Nick_Craver\">Nick Craver</a>.</li> \n <li><a href=\"https://github.com/opserver/Opserver\">Opserver</a>: ASP.NET-based monitoring dashboard for Bosun, SQL, Elasticsearch, Redis, Exceptions, and HAProxy – developed by <a href=\"https://twitter.com/Nick_Craver\">Nick Craver</a>.</li> \n <li><a href=\"https://github.com/NickCraver/StackExchange.Exceptional\">StackExchange.Exceptional</a>: .NET exception logger to SQL, MySQL, Postgres, etc. – developed by <a href=\"https://twitter.com/Nick_Craver\">Nick Craver</a>.</li> \n</ul> \n<p>…and all of these tools have additional contributions from our developer and SRE teams as well as the community at large.</p> \n<p>What’s next? The way <a href=\"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/\">this series</a> works is I blog in order of what the community wants to know about most. Going by <a href=\"https://trello.com/b/0zgQjktX/blog-post-queue-for-stack-overflow-topics\">the Trello board</a>, it looks like <a href=\"https://trello.com/c/OztwfkG7/16-caching-redis\">Caching</a> is the next most interesting topic. So next time expect to learn how we cache data both on the web tier and Redis, how we handle cache invalidation, and take advantage of pub/sub for various tasks along the way.</p>","descriptionType":"text/html","publishedDate":"Thu, 29 Nov 2018 00:00:00 +0000","feedId":12609,"bgimg":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Monitored.png","linkMd5":"713967dc9aad30c7ea15c222a5315b0f","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn2@2020_1/2020/08/25/02-05-18-864_48f7af1bce241e2f.webp","destWidth":2400,"destHeight":2400,"sourceBytes":60378,"destBytes":217242,"author":"","articleImgCdnMap":{"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Monitored.png":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn2@2020_1/2020/08/25/02-05-18-864_48f7af1bce241e2f.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert.png":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn37@2020_5/2020/08/25/02-05-21-626_e027db79f0d129d2.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert-Test.png":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn74@2020_4/2020/08/25/02-05-20-273_e77e7a5100e5fe03.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Chat-Alerts.png":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn21@2020_1/2020/08/25/02-05-20-603_49febe8224a7d3bc.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email.png":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn90@2020_3/2020/08/25/02-05-21-811_a9863ce42bea64c7.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email2.png":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn73@2020_4/2020/08/25/02-05-20-337_cfdb8d140ceff399.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email3.png":"https://cdn.jsdelivr.net/gh/myreaderx/cdn89@2020_5/2020/08/25/02-05-20-582_d11822164e5c6e7d.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Fastly.png":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn60@2020_1/2020/08/25/02-05-20-051_7d396549bbd0cd4b.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Continents.png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn37@2020_5/2020/08/25/02-05-20-760_932b7688fa491b18.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-GC.png":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn21@2020_5/2020/08/25/02-05-20-070_a0bc23795fd3f09e.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Breakdown.png":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn61@2020_3/2020/08/25/02-05-22-614_3da41c799143791b.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-JSON.png":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn30@2020_4/2020/08/25/02-05-22-230_7fdae4ae8c35dc2d.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Grafana.png":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn42@2020_1/2020/08/25/02-05-20-234_aabfe45358e5821a.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler.png":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn57@2020_4/2020/08/25/02-05-22-620_a4e14321e5a842eb.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Queries.png":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn97@2020_3/2020/08/25/02-05-21-684_24fe096200243ba8.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots.png":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn70@2020_3/2020/08/25/02-05-21-781_a073648027e2e043.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots2.png":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn90@2020_1/2020/08/25/02-05-21-136_6942935c7e393ae3.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers.png":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn45@2020_6/2020/08/25/02-05-20-131_ed6fe3294babc436.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node.png":"https://cdn.jsdelivr.net/gh/myreaderx/cdn9@2020_6/2020/08/25/02-05-22-015_5fd60705c19f7b98.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node-Hardware.png":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn30@2020_6/2020/08/25/02-05-20-408_d55cf0f665dba5fb.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL.png":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn85@2020_5/2020/08/25/02-05-21-162_447680e837ea9a9a.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Jobs.png":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn17@2020_5/2020/08/25/02-05-20-387_14a51063d261baeb.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Instance.png":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn82@2020_6/2020/08/25/02-05-22-773_89e401ad7eeae145.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top.png":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn21@2020_5/2020/08/25/02-05-22-142_47e04a9e144e506a.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Active.png":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn86@2020_4/2020/08/25/02-05-21-850_5431f5f5567a0451.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Connections.png":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn69@2020_4/2020/08/25/02-05-20-111_5411d5a3633dc4dc.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top-Query.png":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn89@2020_1/2020/08/25/02-05-23-217_3a06f1f45409cd54.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Databases.png":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn85@2020_6/2020/08/25/02-05-23-038_0daae771294260cb.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database.png":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn54@2020_2/2020/08/25/02-05-21-554_a3e2befb0fc27a8d.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Table.png":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn46@2020_2/2020/08/25/02-05-20-298_b5a3745c38e14def.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Storage.png":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn81@2020_5/2020/08/25/02-05-21-236_363d40c4bb978e92.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Unused-Indexes.png":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn66@2020_6/2020/08/25/02-05-22-895_e0e544c019fd8f9c.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis.png":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn81@2020_5/2020/08/25/02-05-22-403_9acf7b6379ce6dd9.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Instance.png":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn93@2020_3/2020/08/25/02-05-23-335_633bd44ed5d09b10.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Analyze.png":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn26@2020_2/2020/08/25/02-05-22-112_408fe2058ad71b2d.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic.png":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn65@2020_6/2020/08/25/02-05-20-114_5deeb4a011b141c0.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic-Node.png":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn78@2020_4/2020/08/25/02-05-21-340_df0e161ee7379a8f.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions.png":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn2@2020_1/2020/08/25/02-05-20-110_7b8687a276c5c9b6.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Stack.png":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn6@2020_1/2020/08/25/02-05-20-117_62cc19852d44b7c6.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Command.png":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn17@2020_2/2020/08/25/02-05-21-847_8d525ecb790ac568.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy.png":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn57@2020_4/2020/08/25/02-05-20-125_8c08f7f8b4ceb78f.webp","https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy-Control.png":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn41@2020_1/2020/08/25/02-05-22-887_300a94aa8b41a903.webp"},"publishedOrCreatedDate":1598321095278}],"record":{"createdTime":"2020-08-25 10:04:55","updatedTime":"2020-08-25 10:04:55","feedId":12609,"fetchDate":"Tue, 25 Aug 2020 02:04:55 +0000","fetchMs":205,"handleMs":1061,"totalMs":30516,"newArticles":0,"totalArticles":10,"status":1,"type":0,"ip":"52.49.203.214","hostName":"europe-25.herokuapp.com","requestId":"d9a2408a07c0440eab40b64c61fa6b5f_12609","contentType":"application/xml","totalBytes":12789736,"bgimgsTotal":7,"bgimgsGithubTotal":7,"articlesImgsTotal":102,"articlesImgsGithubTotal":102,"successGithubMap":{"myreaderx8":4,"myreaderx14":4,"myreaderx7":4,"myreaderx15":4,"myreaderx16":4,"myreaderx6":4,"myreaderx32":4,"myreaderx4":3,"myreaderx10":4,"myreaderx11":4,"myreaderx33":3,"myreaderx3":3,"myreaderx12":4,"myreaderx2":4,"myreaderx1":3,"myreaderx13":3,"myreaderx30":3,"myreaderx31":4,"myreaderx18":3,"myreaderx19":4,"myreaderx":2,"myreaderx25":3,"myreaderx27":3,"myreaderx21":4,"myreaderx22":4,"myreaderx23":4,"myreaderx24":4,"myreaderx5oss":2,"myreaderx29":3},"failGithubMap":{}},"feed":{"createdTime":"2020-08-25 04:37:47","updatedTime":"2020-08-25 04:37:47","id":12609,"name":"Nick Craver","url":"https://nickcraver.com/blog/feed.xml","subscriber":null,"website":null,"icon":"https://nickcraver.com/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx65/cdn3@2020_6/2020/08/25/02-04-54-434_28e073409094786f.ico","description":"Software Imagineering","weekly":null,"link":"https://nickcraver.com"},"noPictureArticleList":[],"tmpCommonImgCdnBytes":774194,"tmpBodyImgCdnBytes":12015542,"tmpBgImgCdnBytes":0,"extra4":{"start":1598321093975,"total":0,"statList":[{"spend":243,"msg":"获取xml内容"},{"spend":1061,"msg":"解释文章"},{"spend":0,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":4582,"msg":"正文链接上传到cdn"}]},"extra5":102,"extra6":102,"extra7ImgCdnFailResultVector":[],"extra10_invalidATagHrefValue":{"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Translations-1.png":"https://nickcraver.com/blog/content/SO-Deployment-Translations-1.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Stars.png":"https://nickcraver.com/blog/content/SO-Deployment-Stars.png","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/content/SO-Caching/SO-Cache-Max-Age.jpg":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Max-Age.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#cdnproxy-countering-latency-with-cloudflare--fastly":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#cdnproxy-countering-latency-with-cloudflare--fastly","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Jobs.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Jobs.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#building-without-breaking":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#building-without-breaking","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture-Opserver-HAProxy.png":"https://nickcraver.com/blog/content/SO-Architecture-Opserver-HAProxy.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy-Control.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy-Control.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Active.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Active.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Grafana-GC.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-GC.png","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_#cache-invalidation":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/#cache-invalidation","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Unused-Indexes.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Unused-Indexes.png","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-SQL-SSDs.jpg":"https://nickcraver.com/blog/content/SO-Hardware-SQL-SSDs.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#haproxy-serving-up-https":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#haproxy-serving-up-https","https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/_/blog/2018/11/29/stack-overflow-how-we-do-monitoring/":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#step-3-finding-moonspeak-translation":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-3-finding-moonspeak-translation","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Migration-Log.png":"https://nickcraver.com/blog/content/SO-Deployment-Migration-Log.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#opserver-haproxy":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-haproxy","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#quick-specs":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#quick-specs","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Web-Tier-Front2.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front2.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#hsts-preloading":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#hsts-preloading","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node-Hardware.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node-Hardware.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#opserver-faqs":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-faqs","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/2016/02/03/stack-overflow-a-technical-deconstruction/":"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/2016/02/03/stack-overflow-a-technical-deconstruction/":"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#next-steps":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#next-steps","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/content/HTTPS-Layout.svg":"https://nickcraver.com/blog/content/HTTPS-Layout.svg","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Network-Denver-Raw.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Raw.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#unknowns":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#unknowns","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Databases.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Databases.png","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions.png","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture-Opserver-WebTier.png":"https://nickcraver.com/blog/content/SO-Architecture-Opserver-WebTier.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#where-do-we-go-next":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#where-do-we-go-next","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#step-4-translation-dump-javascript-edition":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-4-translation-dump-javascript-edition","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Network-NewYork-Rack.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Rack.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database.png","https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/_/blog/2019/08/06/stack-overflow-how-we-do-app-caching/":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_#":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/#","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#metrics-next-steps":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#metrics-next-steps","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#types-of-data":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#types-of-data","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#health-checks-httpunit":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-checks-httpunit","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#health-checks":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-checks","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Monitored.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Monitored.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#performance-http2":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#performance-http2","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/2013/04/23/stackoverflow-com-the-road-to-ssl/":"https://nickcraver.com/blog/2013/04/23/stackoverflow-com-the-road-to-ssl/","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#branches":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#branches","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#metrics":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#metrics","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#step-5-msbuild":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-5-msbuild","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#preparing-for-a-proxy-client-timings":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#preparing-for-a-proxy-client-timings","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert-Test.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert-Test.png","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-VMs-Rear.jpg":"https://nickcraver.com/blog/content/SO-Hardware-VMs-Rear.jpg","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Migrations.png":"https://nickcraver.com/blog/content/SO-Deployment-Migrations.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#tiers":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#tiers","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#opserver-exceptions":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-exceptions","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/content/SO-Caching/SO-Cache-Opserver-Instance.png":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver-Instance.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#tools-summary":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#tools-summary","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node.png","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-VMs-Blades.jpg":"https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades.jpg","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Dev-Build-Steps.png":"https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Steps.png","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/2018/11/29/stack-overflow-how-we-do-monitoring/":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#opserver-elasticsearch":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-elasticsearch","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/2016/02/03/stack-overflow-a-technical-deconstruction/":"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/#websockets-httpsgithubcomstackexchangenetgain":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/#websockets-httpsgithubcomstackexchangenetgain","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Stack.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Stack.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#whats-in-the-build":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#whats-in-the-build","https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/_/blog/2013/04/23/stackoverflow-com-the-road-to-ssl/":"https://nickcraver.com/blog/2013/04/23/stackoverflow-com-the-road-to-ssl/","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/2013/11/22/what-it-takes-to-run-stack-overflow/#core-hardware":"https://nickcraver.com/blog/2013/11/22/what-it-takes-to-run-stack-overflow/#core-hardware","https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/_/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#step-7-importing-english-strings":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-7-importing-english-strings","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#opserver":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#local-https-development":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#local-https-development","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Grafana.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Grafana.png","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-SQL-Inside.jpg":"https://nickcraver.com/blog/content/SO-Hardware-SQL-Inside.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#health-checks-fastly":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-checks-fastly","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Racks2.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Racks2.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#mistakes-apis-and-internal":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes-apis-and-internal","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/content/SO-Caching/SO-Cache-Opserver.png":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/content/HTTPS-HelpCommit.png":"https://nickcraver.com/blog/content/HTTPS-HelpCommit.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#websockets":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#websockets","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Command.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Command.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#localizationtranslations-moonspeak":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#localizationtranslations-moonspeak","https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/_/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-VMs-Front.jpg":"https://nickcraver.com/blog/content/SO-Hardware-VMs-Front.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#mixed-content-from-you":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mixed-content-from-you","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/2016/02/03/stack-overflow-a-technical-deconstruction/":"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Analyze.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Analyze.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#mixed-content-from-us":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mixed-content-from-us","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture/SO-Architecture-RackB-Bottom.jpg":"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Bottom.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Storage.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Storage.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#testing":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#testing","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#redirects-301s":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#redirects-301s","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Web-Tier-Back.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Back.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/content/HTTPS-Teststackoverflow.png":"https://nickcraver.com/blog/content/HTTPS-Teststackoverflow.png","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture-IIS-NY-WEB10.png":"https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB10.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#database-migrations":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#database-migrations","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#opserver-primary-dashboard":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-primary-dashboard","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#health-check-next-steps":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-check-next-steps","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Network-Denver-Racked.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Racked.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/content/HTTPS-WebsocketMemory.png":"https://nickcraver.com/blog/content/HTTPS-WebsocketMemory.png","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-SQL-Top.jpg":"https://nickcraver.com/blog/content/SO-Hardware-SQL-Top.jpg","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_#redis":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/#redis","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Chat.png":"https://nickcraver.com/blog/content/SO-Deployment-Chat.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#bosun-alerting":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun-alerting","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/content/HTTPS-MainCertificate.png":"https://nickcraver.com/blog/content/HTTPS-MainCertificate.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/content/HTTPS-ClientTimingsDatabase.png":"https://nickcraver.com/blog/content/HTTPS-ClientTimingsDatabase.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#step-8-deploy-website":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-8-deploy-website","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Instance.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Instance.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#the-human-steps":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#the-human-steps","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#mistakes-protocol-relative-urls":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes-protocol-relative-urls","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#alerting":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#alerting","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Network-NewYork-Fiber.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fiber.jpg","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/content/SO-Caching/SO-Cache-Latencies.png":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Latencies.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/content/HTTPS-ClientTimings.png":"https://nickcraver.com/blog/content/HTTPS-ClientTimings.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#cloudflare-railgun":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#cloudflare-railgun","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#step-6-translation-dump-c-edition":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-6-translation-dump-c-edition","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_/blog/content/HTTPS-Websockets.png":"https://nickcraver.com/blog/content/HTTPS-Websockets.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#global-dns":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#global-dns","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#mistakes-301-caching":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes-301-caching","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#source":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#source","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#health-checks-external":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#health-checks-external","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#logs":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#logs","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Migrations-Table.png":"https://nickcraver.com/blog/content/SO-Deployment-Migrations-Table.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Continents.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Continents.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Queries.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Queries.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#steps-1--2-migrations":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#steps-1--2-migrations","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#today":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#today","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#certificates-child-metas-metastackexchangecom":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#certificates-child-metas-metastackexchangecom","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Service-Inside.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Service-Inside.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Table.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Table.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Chat-Alerts.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Chat-Alerts.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#global-login":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#global-login","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#open-source":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#open-source","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email2.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email2.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Fastly.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Fastly.png","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Web-Tier-Unboxed.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Unboxed.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Instance.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Instance.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Breakdown.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Breakdown.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/2017/05/22/https-on-stack-overflow/":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","https://nickcraver.com/blog/2015/07/27/why-you-should-wait-on-dotnet-46/_/blog/content/Blog-RyuJIT-Results.png":"https://nickcraver.com/blog/content/Blog-RyuJIT-Results.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#logs-haproxy":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#logs-haproxy","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Dev-Build-Log.png":"https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Log.png","https://nickcraver.com/blog/2020/02/11/binding-redirects/_/blog/2016/02/03/stack-overflow-a-technical-deconstruction/":"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots.png","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture/SO-Architecture-RackB-Top.jpg":"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Top.jpg","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Racks.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Racks.jpg","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#git-on-premises":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#git-on-premises","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Translations-2.png":"https://nickcraver.com/blog/content/SO-Deployment-Translations-2.png","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/2016/02/03/stack-overflow-a-technical-deconstruction/":"https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Service-Rear.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Service-Rear.jpg","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Network-Denver-Installed.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Installed.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#bosun-next-steps":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun-next-steps","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/#service-tier-iis-aspnet-mvc-523-net-461-and-httpsys":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/#service-tier-iis-aspnet-mvc-523-net-461-and-httpsys","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture-Redis-Utilization.png":"https://nickcraver.com/blog/content/SO-Architecture-Redis-Utilization.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#mistakes-help-center-snafu":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes-help-center-snafu","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Service-Redis-Search-Front.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Service-Redis-Search-Front.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top-Query.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top-Query.png","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture-Bosun-Websockets.png":"https://nickcraver.com/blog/content/SO-Architecture-Bosun-Websockets.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#step-9-new-strings-hook":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#step-9-new-strings-hook","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#opserver-sql-server":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-sql-server","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_#the-build-system":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/#the-build-system","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Connections.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Connections.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#certificates":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#certificates","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Pinbot.png":"https://nickcraver.com/blog/content/SO-Deployment-Pinbot.png","https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/_/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#bosun-metrics":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun-metrics","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Dev-Builds.png":"https://nickcraver.com/blog/content/SO-Deployment-Dev-Builds.png","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture-Opserver-DBTier.png":"https://nickcraver.com/blog/content/SO-Architecture-Opserver-DBTier.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#fastly":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#fastly","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/content/SO-Architecture-IIS-NY-WEB01.png":"https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB01.png","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Web-Tier-Front.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler.png","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#bosun":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#bosun","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots2.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots2.png","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Network-NewYork-Fortinet.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fortinet.jpg","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-Redis-Inside.jpg":"https://nickcraver.com/blog/content/SO-Hardware-Redis-Inside.jpg","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#opserver-redis":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#opserver-redis","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#mistakes":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#mistakes","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-JSON.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-JSON.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic-Node.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic-Node.png","https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/_/blog/content/SO-Deployment-Translations-3.png":"https://nickcraver.com/blog/content/SO-Deployment-Translations-3.png","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#cloudflare":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#cloudflare","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#client-timings":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#client-timings","https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/_/blog/content/SO-Caching/SO-Cache-MiniProfiler.png":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-MiniProfiler.png","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#miniprofiler":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#miniprofiler","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-VMs-Blades2.jpg":"https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades2.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#preparing-the-applications":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#preparing-the-applications","https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/_/blog/2013/11/22/what-it-takes-to-run-stack-overflow/":"https://nickcraver.com/blog/2013/11/22/what-it-takes-to-run-stack-overflow/","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#the-beginning":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#the-beginning","https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/_/blog/content/SO-Hardware-SQL-Front.jpg":"https://nickcraver.com/blog/content/SO-Hardware-SQL-Front.jpg","https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/_#chat":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/#chat","https://nickcraver.com/blog/2016/02/03/stack-overflow-a-technical-deconstruction/_/blog/2013/11/22/what-it-takes-to-run-stack-overflow/":"https://nickcraver.com/blog/2013/11/22/what-it-takes-to-run-stack-overflow/","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_#grafana":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/#grafana","https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/_/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email3.png":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email3.png"},"extra111_proxyServerAndStatMap":{"http://europe-56.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-018.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://europe68.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-002.herokuapp.com/":{"failCount":0,"successCount":5,"resultList":[200,200,200,200,200]},"http://us-034.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-022.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://europe-60.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-030.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-52.herokuapp.com/":{"failCount":0,"successCount":5,"resultList":[200,200,200,200,200]},"http://us-026.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-006.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-038.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://europe64.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-010.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://europe-59.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]},"http://europe-22.herokuapp.com/":{"failCount":0,"successCount":5,"resultList":[200,200,200,200,200]},"http://us-014.herokuapp.com/":{"failCount":0,"successCount":6,"resultList":[200,200,200,200,200,200]},"http://us-029.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Stars.png","sourceStatusCode":200,"destWidth":692,"destHeight":202,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn13@2020_2/2020/08/25/02-05-18-394_1d1733ddc311fae4.webp","sourceBytes":21171,"destBytes":17610,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1110,"convertSpendMs":32,"createdTime":"2020-08-25 10:05:18","host":"us-002*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94,98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"20.7 KB","destSize":"17.2 KB","compressRate":"83.2%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/Blog-RyuJIT-Results.png","sourceStatusCode":200,"destWidth":1678,"destHeight":510,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn9@2020_2/2020/08/25/02-05-18-341_81c0c503cc9fc87c.webp","sourceBytes":44579,"destBytes":98316,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1150,"convertSpendMs":60,"createdTime":"2020-08-25 10:05:18","host":"us-014*","referer":"https://nickcraver.com/blog/2015/07/27/why-you-should-wait-on-dotnet-46/","linkMd5ListStr":"72dfcd52e6f4cf3a40b6d3fd11274c3b,72dfcd52e6f4cf3a40b6d3fd11274c3b","githubUser":"myreaderx19","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"43.5 KB","destSize":"96 KB","compressRate":"220.5%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/HTTPS-MainCertificate.png","sourceStatusCode":200,"destWidth":1136,"destHeight":1196,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn89@2020_6/2020/08/25/02-05-18-379_1bc83fc3f52d5619.webp","sourceBytes":111298,"destBytes":84176,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1183,"convertSpendMs":85,"createdTime":"2020-08-25 10:05:18","host":"us-010*","referer":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","linkMd5ListStr":"052bb6f1bc2d1a84e7e0b850104d56df,052bb6f1bc2d1a84e7e0b850104d56df","githubUser":"myreaderx1","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"108.7 KB","destSize":"82.2 KB","compressRate":"75.6%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Latencies.png","sourceStatusCode":200,"destWidth":3003,"destHeight":1031,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn94@2020_6/2020/08/25/02-05-18-250_ca88f317785ba40d.webp","sourceBytes":39428,"destBytes":39428,"feedId":12609,"totalSpendMs":1592,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:18","host":"europe-22*","referer":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/","linkMd5ListStr":"bccdad3a6ba89c859e54afaec202e0e6,bccdad3a6ba89c859e54afaec202e0e6","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"38.5 KB","destSize":"38.5 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Top.jpg","sourceStatusCode":200,"destWidth":768,"destHeight":1024,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn5@2020_4/2020/08/25/02-05-18-630_470488dce2bcaea7.webp","sourceBytes":194380,"destBytes":134644,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1548,"convertSpendMs":223,"createdTime":"2020-08-25 10:05:18","host":"us-026*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff,40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx8","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"189.8 KB","destSize":"131.5 KB","compressRate":"69.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Rack-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":1416,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn98@2020_1/2020/08/25/02-05-18-365_1cf5a335a0f7b250.webp","sourceBytes":408754,"destBytes":182778,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1791,"convertSpendMs":84,"createdTime":"2020-08-25 10:05:18","host":"europe-60*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0,ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"399.2 KB","destSize":"178.5 KB","compressRate":"44.7%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Monitored.png","sourceStatusCode":200,"destWidth":2400,"destHeight":2400,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn2@2020_1/2020/08/25/02-05-18-864_48f7af1bce241e2f.webp","sourceBytes":60378,"destBytes":217242,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1701,"convertSpendMs":555,"createdTime":"2020-08-25 10:05:18","host":"us-038*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f,713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx14","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"59 KB","destSize":"212.2 KB","compressRate":"359.8%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Translations-2.png","sourceStatusCode":200,"destWidth":1092,"destHeight":358,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn66@2020_5/2020/08/25/02-05-20-084_e0a1733547566164.webp","sourceBytes":16686,"destBytes":53440,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1016,"convertSpendMs":21,"createdTime":"2020-08-25 10:05:19","host":"us-038*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx33","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"16.3 KB","destSize":"52.2 KB","compressRate":"320.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Chat.png","sourceStatusCode":200,"destWidth":1348,"destHeight":732,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn53@2020_2/2020/08/25/02-05-20-085_d9b0524a848fd69e.webp","sourceBytes":57687,"destBytes":50940,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1027,"convertSpendMs":30,"createdTime":"2020-08-25 10:05:19","host":"us-010*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"56.3 KB","destSize":"49.7 KB","compressRate":"88.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/HTTPS-ClientTimingsDatabase.png","sourceStatusCode":200,"destWidth":2122,"destHeight":268,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn58@2020_1/2020/08/25/02-05-20-179_3be20ca72d32c7a6.webp","sourceBytes":18088,"destBytes":18088,"feedId":12609,"totalSpendMs":949,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:20","host":"us-018*","referer":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","linkMd5ListStr":"052bb6f1bc2d1a84e7e0b850104d56df","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"17.7 KB","destSize":"17.7 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Migrations.png","sourceStatusCode":200,"destWidth":1680,"destHeight":358,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn25@2020_3/2020/08/25/02-05-20-008_5f890e42625d97b2.webp","sourceBytes":15444,"destBytes":15444,"feedId":12609,"totalSpendMs":1112,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe-60*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"15.1 KB","destSize":"15.1 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Translations-1.png","sourceStatusCode":200,"destWidth":1950,"destHeight":276,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn33@2020_1/2020/08/25/02-05-20-150_c5277baef17c65a1.webp","sourceBytes":11464,"destBytes":34064,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":948,"convertSpendMs":22,"createdTime":"2020-08-25 10:05:20","host":"us-006*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"11.2 KB","destSize":"33.3 KB","compressRate":"297.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Migration-Log.png","sourceStatusCode":200,"destWidth":1846,"destHeight":902,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn30@2020_6/2020/08/25/02-05-20-170_43d8067036221185.webp","sourceBytes":47502,"destBytes":47502,"feedId":12609,"totalSpendMs":1007,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:20","host":"us-018*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx7","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"46.4 KB","destSize":"46.4 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-SQL-Inside-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn10@2020_1/2020/08/25/02-05-20-212_de3dbef7e47d2a82.webp","sourceBytes":299939,"destBytes":118980,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1101,"convertSpendMs":51,"createdTime":"2020-08-25 10:05:20","host":"us-034*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx13","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"292.9 KB","destSize":"116.2 KB","compressRate":"39.7%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-SQL-SSDs-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn97@2020_2/2020/08/25/02-05-20-219_115c103ba6796acf.webp","sourceBytes":226317,"destBytes":108486,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1132,"convertSpendMs":50,"createdTime":"2020-08-25 10:05:20","host":"us-006*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"221 KB","destSize":"105.9 KB","compressRate":"47.9%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert-Test.png","sourceStatusCode":200,"destWidth":1316,"destHeight":1046,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn74@2020_4/2020/08/25/02-05-20-273_e77e7a5100e5fe03.webp","sourceBytes":29609,"destBytes":47814,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1065,"convertSpendMs":46,"createdTime":"2020-08-25 10:05:20","host":"us-034*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"28.9 KB","destSize":"46.7 KB","compressRate":"161.5%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Dev-Builds.png","sourceStatusCode":200,"destWidth":2000,"destHeight":1256,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn78@2020_6/2020/08/25/02-05-20-206_40905c86d0e476b1.webp","sourceBytes":222739,"destBytes":143818,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1189,"convertSpendMs":74,"createdTime":"2020-08-25 10:05:20","host":"us-002*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx5oss","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"217.5 KB","destSize":"140.4 KB","compressRate":"64.6%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/HTTPS-WebsocketMemory.png","sourceStatusCode":200,"destWidth":1796,"destHeight":930,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn41@2020_6/2020/08/25/02-05-20-104_2976801a301fe134.webp","sourceBytes":31674,"destBytes":31674,"feedId":12609,"totalSpendMs":1319,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe-56*","referer":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","linkMd5ListStr":"052bb6f1bc2d1a84e7e0b850104d56df","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"30.9 KB","destSize":"30.9 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-SQL-Top-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":725,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn61@2020_6/2020/08/25/02-05-20-239_c818a2fedf36f905.webp","sourceBytes":146837,"destBytes":127970,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1190,"convertSpendMs":61,"createdTime":"2020-08-25 10:05:20","host":"us-006*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx2","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"143.4 KB","destSize":"125 KB","compressRate":"87.2%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email2.png","sourceStatusCode":200,"destWidth":1819,"destHeight":1470,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn73@2020_4/2020/08/25/02-05-20-337_cfdb8d140ceff399.webp","sourceBytes":77091,"destBytes":48070,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1217,"convertSpendMs":215,"createdTime":"2020-08-25 10:05:20","host":"us-014*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"75.3 KB","destSize":"46.9 KB","compressRate":"62.4%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Table.png","sourceStatusCode":200,"destWidth":2644,"destHeight":1037,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn46@2020_2/2020/08/25/02-05-20-298_b5a3745c38e14def.webp","sourceBytes":63832,"destBytes":88134,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1236,"convertSpendMs":121,"createdTime":"2020-08-25 10:05:20","host":"us-034*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"62.3 KB","destSize":"86.1 KB","compressRate":"138.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Service-Redis-Search-Front-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":629,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn33@2020_2/2020/08/25/02-05-20-272_b69a8c69d221e019.webp","sourceBytes":130926,"destBytes":48526,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1250,"convertSpendMs":101,"createdTime":"2020-08-25 10:05:20","host":"us-026*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"127.9 KB","destSize":"47.4 KB","compressRate":"37.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Stack.png","sourceStatusCode":200,"destWidth":2977,"destHeight":1190,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn6@2020_1/2020/08/25/02-05-20-117_62cc19852d44b7c6.webp","sourceBytes":132992,"destBytes":132992,"feedId":12609,"totalSpendMs":1375,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe-56*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"129.9 KB","destSize":"129.9 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Grafana.png","sourceStatusCode":200,"destWidth":3840,"destHeight":2160,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn42@2020_1/2020/08/25/02-05-20-234_aabfe45358e5821a.webp","sourceBytes":441874,"destBytes":441874,"feedId":12609,"totalSpendMs":1315,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:20","host":"us-002*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx7","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"431.5 KB","destSize":"431.5 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn53@2020_6/2020/08/25/02-05-20-396_edee98dae04298f5.webp","sourceBytes":196711,"destBytes":76018,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1299,"convertSpendMs":153,"createdTime":"2020-08-25 10:05:20","host":"us-030*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"192.1 KB","destSize":"74.2 KB","compressRate":"38.6%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture-Opserver-HAProxy.png","sourceStatusCode":200,"destWidth":1744,"destHeight":570,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn49@2020_6/2020/08/25/02-05-20-393_6b8bed0261b3d6a5.webp","sourceBytes":109469,"destBytes":100218,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1191,"convertSpendMs":63,"createdTime":"2020-08-25 10:05:20","host":"us-022*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx2","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"106.9 KB","destSize":"97.9 KB","compressRate":"91.5%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver-Instance.png","sourceStatusCode":200,"destWidth":2610,"destHeight":1027,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn14@2020_3/2020/08/25/02-05-20-346_411c91823c39080f.webp","sourceBytes":151121,"destBytes":126410,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1360,"convertSpendMs":115,"createdTime":"2020-08-25 10:05:20","host":"us-022*","referer":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/","linkMd5ListStr":"bccdad3a6ba89c859e54afaec202e0e6","githubUser":"myreaderx14","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"147.6 KB","destSize":"123.4 KB","compressRate":"83.6%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Connections.png","sourceStatusCode":200,"destWidth":2649,"destHeight":1124,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn69@2020_4/2020/08/25/02-05-20-111_5411d5a3633dc4dc.webp","sourceBytes":91666,"destBytes":91666,"feedId":12609,"totalSpendMs":1548,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe-56*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx22","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"89.5 KB","destSize":"89.5 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Chat-Alerts.png","sourceStatusCode":200,"destWidth":2188,"destHeight":220,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn21@2020_1/2020/08/25/02-05-20-603_49febe8224a7d3bc.webp","sourceBytes":19291,"destBytes":34308,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":986,"convertSpendMs":47,"createdTime":"2020-08-25 10:05:20","host":"us-030*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"18.8 KB","destSize":"33.5 KB","compressRate":"177.8%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions.png","sourceStatusCode":200,"destWidth":3014,"destHeight":1152,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn2@2020_1/2020/08/25/02-05-20-110_7b8687a276c5c9b6.webp","sourceBytes":115068,"destBytes":115068,"feedId":12609,"totalSpendMs":1572,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe68*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"112.4 KB","destSize":"112.4 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy.png","sourceStatusCode":200,"destWidth":2947,"destHeight":1503,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn57@2020_4/2020/08/25/02-05-20-125_8c08f7f8b4ceb78f.webp","sourceBytes":124182,"destBytes":124182,"feedId":12609,"totalSpendMs":1575,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe-59*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx22","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"121.3 KB","destSize":"121.3 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic.png","sourceStatusCode":200,"destWidth":2684,"destHeight":1162,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn65@2020_6/2020/08/25/02-05-20-114_5deeb4a011b141c0.webp","sourceBytes":93666,"destBytes":93666,"feedId":12609,"totalSpendMs":1579,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe68*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"91.5 KB","destSize":"91.5 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture-Bosun-Websockets.png","sourceStatusCode":200,"destWidth":1964,"destHeight":812,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn38@2020_6/2020/08/25/02-05-20-170_046a4a8d649c3d28.webp","sourceBytes":56551,"destBytes":56066,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1593,"convertSpendMs":54,"createdTime":"2020-08-25 10:05:19","host":"europe68*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"55.2 KB","destSize":"54.8 KB","compressRate":"99.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Jobs.png","sourceStatusCode":200,"destWidth":2646,"destHeight":1419,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn17@2020_5/2020/08/25/02-05-20-387_14a51063d261baeb.webp","sourceBytes":168664,"destBytes":337804,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1461,"convertSpendMs":152,"createdTime":"2020-08-25 10:05:20","host":"us-010*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx8","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"164.7 KB","destSize":"329.9 KB","compressRate":"200.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/HTTPS-Websockets.png","sourceStatusCode":200,"destWidth":2078,"destHeight":1348,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn82@2020_2/2020/08/25/02-05-20-129_79c75d7fac6cd09b.webp","sourceBytes":71756,"destBytes":71756,"feedId":12609,"totalSpendMs":1589,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe64*","referer":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","linkMd5ListStr":"052bb6f1bc2d1a84e7e0b850104d56df","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"70.1 KB","destSize":"70.1 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Raw-Small.jpg","sourceStatusCode":200,"destWidth":1940,"destHeight":733,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn23@2020_5/2020/08/25/02-05-20-323_a64670832732795c.webp","sourceBytes":329356,"destBytes":222640,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1443,"convertSpendMs":113,"createdTime":"2020-08-25 10:05:20","host":"us-029*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"321.6 KB","destSize":"217.4 KB","compressRate":"67.6%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email3.png","sourceStatusCode":200,"destWidth":1839,"destHeight":1475,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx/cdn89@2020_5/2020/08/25/02-05-20-582_d11822164e5c6e7d.webp","sourceBytes":137845,"destBytes":74608,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1432,"convertSpendMs":390,"createdTime":"2020-08-25 10:05:20","host":"us-030*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"134.6 KB","destSize":"72.9 KB","compressRate":"54.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node-Hardware.png","sourceStatusCode":200,"destWidth":2400,"destHeight":1252,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn30@2020_6/2020/08/25/02-05-20-408_d55cf0f665dba5fb.webp","sourceBytes":156752,"destBytes":203580,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1481,"convertSpendMs":113,"createdTime":"2020-08-25 10:05:20","host":"us-038*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx23","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"153.1 KB","destSize":"198.8 KB","compressRate":"129.9%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Steps.png","sourceStatusCode":200,"destWidth":2032,"destHeight":1320,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn69@2020_5/2020/08/25/02-05-20-418_0e1118c2d90e2cdb.webp","sourceBytes":218434,"destBytes":167786,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1566,"convertSpendMs":323,"createdTime":"2020-08-25 10:05:19","host":"us-026*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx30","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"213.3 KB","destSize":"163.9 KB","compressRate":"76.8%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Redis-Inside-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn50@2020_3/2020/08/25/02-05-20-555_f87fc21aa9ba9000.webp","sourceBytes":227950,"destBytes":114184,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1540,"convertSpendMs":307,"createdTime":"2020-08-25 10:05:20","host":"us-52*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"222.6 KB","destSize":"111.5 KB","compressRate":"50.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Max-Age.jpg","sourceStatusCode":200,"destWidth":1108,"destHeight":384,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn93@2020_2/2020/08/25/02-05-20-200_d398e753bad68f1f.webp","sourceBytes":69627,"destBytes":38478,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":962,"convertSpendMs":25,"createdTime":"2020-08-25 10:05:20","host":"us-018*","referer":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/","linkMd5ListStr":"bccdad3a6ba89c859e54afaec202e0e6","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"68 KB","destSize":"37.6 KB","compressRate":"55.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Fastly.png","sourceStatusCode":200,"destWidth":3840,"destHeight":2160,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn60@2020_1/2020/08/25/02-05-20-051_7d396549bbd0cd4b.webp","sourceBytes":205562,"destBytes":205562,"feedId":12609,"totalSpendMs":1786,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe-60*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"200.7 KB","destSize":"200.7 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Unboxed-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn18@2020_2/2020/08/25/02-05-20-194_bee83ba3c6a065f7.webp","sourceBytes":275187,"destBytes":94130,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1795,"convertSpendMs":44,"createdTime":"2020-08-25 10:05:19","host":"europe64*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx23","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"268.7 KB","destSize":"91.9 KB","compressRate":"34.2%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Migrations-Table.png","sourceStatusCode":200,"destWidth":1950,"destHeight":530,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn86@2020_6/2020/08/25/02-05-20-563_dd9c133c81405e9b.webp","sourceBytes":48988,"destBytes":214548,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1667,"convertSpendMs":357,"createdTime":"2020-08-25 10:05:20","host":"us-52*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx3","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"47.8 KB","destSize":"209.5 KB","compressRate":"438%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers.png","sourceStatusCode":200,"destWidth":2667,"destHeight":818,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn45@2020_6/2020/08/25/02-05-20-131_ed6fe3294babc436.webp","sourceBytes":60164,"destBytes":60164,"feedId":12609,"totalSpendMs":1800,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe64*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"58.8 KB","destSize":"58.8 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-Continents.png","sourceStatusCode":200,"destWidth":3840,"destHeight":2160,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn37@2020_5/2020/08/25/02-05-20-760_932b7688fa491b18.webp","sourceBytes":217466,"destBytes":356182,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1818,"convertSpendMs":598,"createdTime":"2020-08-25 10:05:20","host":"us-014*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"212.4 KB","destSize":"347.8 KB","compressRate":"163.8%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Storage.png","sourceStatusCode":200,"destWidth":2811,"destHeight":1243,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn81@2020_5/2020/08/25/02-05-21-236_363d40c4bb978e92.webp","sourceBytes":94537,"destBytes":165024,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1130,"convertSpendMs":92,"createdTime":"2020-08-25 10:05:21","host":"us-010*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx30","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"92.3 KB","destSize":"161.2 KB","compressRate":"174.6%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Grafana-GC.png","sourceStatusCode":200,"destWidth":3840,"destHeight":2160,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn21@2020_5/2020/08/25/02-05-20-070_a0bc23795fd3f09e.webp","sourceBytes":390228,"destBytes":390228,"feedId":12609,"totalSpendMs":2329,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:19","host":"europe-22*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx19","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"381.1 KB","destSize":"381.1 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots2.png","sourceStatusCode":200,"destWidth":1233,"destHeight":1384,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx5oss/cdn90@2020_1/2020/08/25/02-05-21-136_6942935c7e393ae3.webp","sourceBytes":44320,"destBytes":44320,"feedId":12609,"totalSpendMs":1313,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe-60*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx5oss","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"43.3 KB","destSize":"43.3 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Front2-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":629,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn94@2020_2/2020/08/25/02-05-21-375_8367225145a149e7.webp","sourceBytes":192785,"destBytes":87612,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1250,"convertSpendMs":38,"createdTime":"2020-08-25 10:05:21","host":"us-038*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"188.3 KB","destSize":"85.6 KB","compressRate":"45.4%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":1259,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn98@2020_4/2020/08/25/02-05-21-447_6142640a38aa0f64.webp","sourceBytes":180972,"destBytes":144452,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1222,"convertSpendMs":104,"createdTime":"2020-08-25 10:05:21","host":"us-026*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx3","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"176.7 KB","destSize":"141.1 KB","compressRate":"79.8%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Web-Tier-Back-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn26@2020_4/2020/08/25/02-05-21-506_59fdf52ed573fc13.webp","sourceBytes":211776,"destBytes":83868,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1126,"convertSpendMs":43,"createdTime":"2020-08-25 10:05:21","host":"us-006*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx14","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"206.8 KB","destSize":"81.9 KB","compressRate":"39.6%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB01.png","sourceStatusCode":200,"destWidth":272,"destHeight":288,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn5@2020_2/2020/08/25/02-05-21-451_ef1ceabaff6d76a9.webp","sourceBytes":4378,"destBytes":14186,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1123,"convertSpendMs":7,"createdTime":"2020-08-25 10:05:21","host":"us-002*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"4.3 KB","destSize":"13.9 KB","compressRate":"324%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Service-Rear-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn1@2020_6/2020/08/25/02-05-21-478_52f48dd2a5f382f3.webp","sourceBytes":196601,"destBytes":83216,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1156,"convertSpendMs":54,"createdTime":"2020-08-25 10:05:21","host":"us-014*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"192 KB","destSize":"81.3 KB","compressRate":"42.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Elastic-Node.png","sourceStatusCode":200,"destWidth":2646,"destHeight":1489,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn78@2020_4/2020/08/25/02-05-21-340_df0e161ee7379a8f.webp","sourceBytes":134883,"destBytes":218108,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1369,"convertSpendMs":111,"createdTime":"2020-08-25 10:05:21","host":"us-022*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx33","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"131.7 KB","destSize":"213 KB","compressRate":"161.7%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/HTTPS-Teststackoverflow.png","sourceStatusCode":200,"destWidth":1958,"destHeight":600,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn29@2020_5/2020/08/25/02-05-21-398_96e4e422671033ae.webp","sourceBytes":28658,"destBytes":28658,"feedId":12609,"totalSpendMs":1274,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe68*","referer":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","linkMd5ListStr":"052bb6f1bc2d1a84e7e0b850104d56df","githubUser":"myreaderx8","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"28 KB","destSize":"28 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL.png","sourceStatusCode":200,"destWidth":2681,"destHeight":1579,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn85@2020_5/2020/08/25/02-05-21-162_447680e837ea9a9a.webp","sourceBytes":132126,"destBytes":132126,"feedId":12609,"totalSpendMs":1569,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe-22*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"129 KB","destSize":"129 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Pinbot.png","sourceStatusCode":200,"destWidth":834,"destHeight":398,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx27/cdn2@2020_4/2020/08/25/02-05-21-784_876df4b594f1b846.webp","sourceBytes":36150,"destBytes":20042,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":945,"convertSpendMs":14,"createdTime":"2020-08-25 10:05:21","host":"us-034*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx27","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"35.3 KB","destSize":"19.6 KB","compressRate":"55.4%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture-Opserver-WebTier.png","sourceStatusCode":200,"destWidth":2456,"destHeight":644,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn22@2020_4/2020/08/25/02-05-21-585_9a2d465d33cbfdf1.webp","sourceBytes":149875,"destBytes":149448,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1237,"convertSpendMs":72,"createdTime":"2020-08-25 10:05:21","host":"us-018*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx13","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"146.4 KB","destSize":"145.9 KB","compressRate":"99.7%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-MiniProfiler.png","sourceStatusCode":200,"destWidth":2829,"destHeight":1227,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn42@2020_5/2020/08/25/02-05-21-616_7b134b13fd4d2bd4.webp","sourceBytes":116306,"destBytes":116306,"feedId":12609,"totalSpendMs":1161,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"us-022*","referer":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/","linkMd5ListStr":"bccdad3a6ba89c859e54afaec202e0e6","githubUser":"myreaderx23","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"113.6 KB","destSize":"113.6 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Service-Inside-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn18@2020_1/2020/08/25/02-05-21-681_3c9e3a673e2227c6.webp","sourceBytes":229804,"destBytes":117406,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1330,"convertSpendMs":170,"createdTime":"2020-08-25 10:05:21","host":"us-030*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"224.4 KB","destSize":"114.7 KB","compressRate":"51.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database.png","sourceStatusCode":200,"destWidth":2811,"destHeight":937,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn54@2020_2/2020/08/25/02-05-21-554_a3e2befb0fc27a8d.webp","sourceBytes":55262,"destBytes":55262,"feedId":12609,"totalSpendMs":1337,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe-60*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx7","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"54 KB","destSize":"54 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Email.png","sourceStatusCode":200,"destWidth":2042,"destHeight":1134,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx33/cdn90@2020_3/2020/08/25/02-05-21-811_a9863ce42bea64c7.webp","sourceBytes":40492,"destBytes":76010,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1120,"convertSpendMs":96,"createdTime":"2020-08-25 10:05:21","host":"us-006*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx33","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"39.5 KB","destSize":"74.2 KB","compressRate":"187.7%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/HTTPS-Layout.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn9@2020_6/2020/08/25/02-05-21-337_9662fd1864b5f3ca.svg","sourceBytes":149602,"destBytes":149602,"feedId":12609,"totalSpendMs":1608,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe64*","referer":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","linkMd5ListStr":"052bb6f1bc2d1a84e7e0b850104d56df","githubUser":"myreaderx1","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"146.1 KB","destSize":"146.1 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Snapshots.png","sourceStatusCode":200,"destWidth":1145,"destHeight":1038,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn70@2020_3/2020/08/25/02-05-21-781_a073648027e2e043.webp","sourceBytes":80032,"destBytes":144364,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1199,"convertSpendMs":44,"createdTime":"2020-08-25 10:05:21","host":"us-002*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"78.2 KB","destSize":"141 KB","compressRate":"180.4%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Caching/SO-Cache-Opserver.png","sourceStatusCode":200,"destWidth":2243,"destHeight":258,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx3/cdn6@2020_2/2020/08/25/02-05-21-858_fda92d5f2ed3976d.webp","sourceBytes":35712,"destBytes":35712,"feedId":12609,"totalSpendMs":1066,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"us-022*","referer":"https://nickcraver.com/blog/2019/08/06/stack-overflow-how-we-do-app-caching/","linkMd5ListStr":"bccdad3a6ba89c859e54afaec202e0e6","githubUser":"myreaderx3","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"34.9 KB","destSize":"34.9 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Bosun-Alert.png","sourceStatusCode":200,"destWidth":2676,"destHeight":1433,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn37@2020_5/2020/08/25/02-05-21-626_e027db79f0d129d2.webp","sourceBytes":123123,"destBytes":216122,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1472,"convertSpendMs":160,"createdTime":"2020-08-25 10:05:21","host":"us-034*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"120.2 KB","destSize":"211.1 KB","compressRate":"175.5%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-VMs-Blades2-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":1259,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn62@2020_2/2020/08/25/02-05-21-851_9e119fd4dfd63b96.webp","sourceBytes":171518,"destBytes":129758,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1226,"convertSpendMs":118,"createdTime":"2020-08-25 10:05:21","host":"us-026*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"167.5 KB","destSize":"126.7 KB","compressRate":"75.7%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fortinet-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":629,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn57@2020_6/2020/08/25/02-05-21-763_a593860141fbc11b.webp","sourceBytes":185653,"destBytes":92406,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1281,"convertSpendMs":39,"createdTime":"2020-08-25 10:05:21","host":"us-038*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"181.3 KB","destSize":"90.2 KB","compressRate":"49.8%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Active.png","sourceStatusCode":200,"destWidth":2691,"destHeight":1169,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx29/cdn86@2020_4/2020/08/25/02-05-21-850_5431f5f5567a0451.webp","sourceBytes":65014,"destBytes":119192,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1247,"convertSpendMs":105,"createdTime":"2020-08-25 10:05:21","host":"us-018*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx29","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"63.5 KB","destSize":"116.4 KB","compressRate":"183.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture-Overview-Logical.svg","sourceStatusCode":200,"destWidth":0,"destHeight":0,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn33@2020_3/2020/08/25/02-05-21-398_af9ac7c2b502957a.svg","sourceBytes":167226,"destBytes":167226,"feedId":12609,"totalSpendMs":1645,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe-56*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx19","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"163.3 KB","destSize":"163.3 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture-IIS-NY-WEB10.png","sourceStatusCode":200,"destWidth":332,"destHeight":494,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn13@2020_4/2020/08/25/02-05-21-804_068063319ad86357.webp","sourceBytes":7154,"destBytes":26750,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1285,"convertSpendMs":10,"createdTime":"2020-08-25 10:05:21","host":"europe-22*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"7 KB","destSize":"26.1 KB","compressRate":"373.9%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Exceptions-Command.png","sourceStatusCode":200,"destWidth":2980,"destHeight":967,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx25/cdn17@2020_2/2020/08/25/02-05-21-847_8d525ecb790ac568.webp","sourceBytes":50228,"destBytes":50228,"feedId":12609,"totalSpendMs":1314,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe-60*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx25","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"49.1 KB","destSize":"49.1 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler-Queries.png","sourceStatusCode":200,"destWidth":2935,"destHeight":1676,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx18/cdn97@2020_3/2020/08/25/02-05-21-684_24fe096200243ba8.webp","sourceBytes":105028,"destBytes":105028,"feedId":12609,"totalSpendMs":1507,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe-56*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx18","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"102.6 KB","destSize":"102.6 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/HTTPS-HelpCommit.png","sourceStatusCode":200,"destWidth":2022,"destHeight":928,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx30/cdn93@2020_1/2020/08/25/02-05-21-666_1f80d67c1f209fa7.webp","sourceBytes":91220,"destBytes":91220,"feedId":12609,"totalSpendMs":1522,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:21","host":"europe68*","referer":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","linkMd5ListStr":"052bb6f1bc2d1a84e7e0b850104d56df","githubUser":"myreaderx30","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"89.1 KB","destSize":"89.1 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture-Redis-Utilization.png","sourceStatusCode":200,"destWidth":2352,"destHeight":796,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn65@2020_3/2020/08/25/02-05-21-908_23ddf3f177675c59.webp","sourceBytes":212882,"destBytes":210772,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1459,"convertSpendMs":153,"createdTime":"2020-08-25 10:05:21","host":"us-014*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"207.9 KB","destSize":"205.8 KB","compressRate":"99%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Racks-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":1416,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn45@2020_6/2020/08/25/02-05-21-697_6fd05a6304796595.webp","sourceBytes":420575,"destBytes":201038,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1600,"convertSpendMs":80,"createdTime":"2020-08-25 10:05:21","host":"us-010*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"410.7 KB","destSize":"196.3 KB","compressRate":"47.8%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-SQL-Front-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":708,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn77@2020_2/2020/08/25/02-05-22-271_554f635d0e6cf6d5.webp","sourceBytes":186484,"destBytes":75536,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1542,"convertSpendMs":393,"createdTime":"2020-08-25 10:05:21","host":"us-52*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"182.1 KB","destSize":"73.8 KB","compressRate":"40.5%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Racks2-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":1416,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn14@2020_3/2020/08/25/02-05-22-041_476d9eaf3426324d.webp","sourceBytes":394493,"destBytes":185320,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1841,"convertSpendMs":417,"createdTime":"2020-08-25 10:05:21","host":"us-52*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"385.2 KB","destSize":"181 KB","compressRate":"47%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Analyze.png","sourceStatusCode":200,"destWidth":2647,"destHeight":980,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx16/cdn26@2020_2/2020/08/25/02-05-22-112_408fe2058ad71b2d.webp","sourceBytes":74887,"destBytes":137116,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1350,"convertSpendMs":147,"createdTime":"2020-08-25 10:05:21","host":"us-026*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx16","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"73.1 KB","destSize":"133.9 KB","compressRate":"183.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-JSON.png","sourceStatusCode":200,"destWidth":2296,"destHeight":1672,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx24/cdn30@2020_4/2020/08/25/02-05-22-230_7fdae4ae8c35dc2d.webp","sourceBytes":75272,"destBytes":132398,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1287,"convertSpendMs":212,"createdTime":"2020-08-25 10:05:21","host":"us-014*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx24","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"73.5 KB","destSize":"129.3 KB","compressRate":"175.9%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top.png","sourceStatusCode":200,"destWidth":2771,"destHeight":1185,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx1/cdn21@2020_5/2020/08/25/02-05-22-142_47e04a9e144e506a.webp","sourceBytes":177124,"destBytes":409598,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1356,"convertSpendMs":167,"createdTime":"2020-08-25 10:05:21","host":"us-038*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx1","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"173 KB","destSize":"400 KB","compressRate":"231.2%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Servers-Node.png","sourceStatusCode":200,"destWidth":2691,"destHeight":1576,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx/cdn9@2020_6/2020/08/25/02-05-22-015_5fd60705c19f7b98.webp","sourceBytes":98296,"destBytes":180728,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1486,"convertSpendMs":105,"createdTime":"2020-08-25 10:05:21","host":"us-010*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"96 KB","destSize":"176.5 KB","compressRate":"183.9%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-VMs-Front-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":1416,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn49@2020_6/2020/08/25/02-05-21-701_c953805d2d6a110a.webp","sourceBytes":359295,"destBytes":141912,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1862,"convertSpendMs":109,"createdTime":"2020-08-25 10:05:21","host":"europe-22*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"350.9 KB","destSize":"138.6 KB","compressRate":"39.5%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture-Opserver-DBTier.png","sourceStatusCode":200,"destWidth":2444,"destHeight":436,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx13/cdn34@2020_1/2020/08/25/02-05-22-472_4cfcd7289a615678.webp","sourceBytes":70671,"destBytes":65424,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1058,"convertSpendMs":36,"createdTime":"2020-08-25 10:05:22","host":"us-002*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx13","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"69 KB","destSize":"63.9 KB","compressRate":"92.6%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Architecture/SO-Architecture-RackB-Bottom.jpg","sourceStatusCode":200,"destWidth":768,"destHeight":1024,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn73@2020_1/2020/08/25/02-05-21-695_f956f2b6f72766df.webp","sourceBytes":195249,"destBytes":139490,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1933,"convertSpendMs":48,"createdTime":"2020-08-25 10:05:21","host":"europe64*","referer":"https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/","linkMd5ListStr":"40aa1cb2c085d883e8930442ece834ff","githubUser":"myreaderx2","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"190.7 KB","destSize":"136.2 KB","compressRate":"71.4%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Network-NewYork-Fiber-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":629,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx21/cdn49@2020_3/2020/08/25/02-05-22-729_c8486a292235d868.webp","sourceBytes":138821,"destBytes":50988,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1008,"convertSpendMs":31,"createdTime":"2020-08-25 10:05:22","host":"us-018*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx21","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"135.6 KB","destSize":"49.8 KB","compressRate":"36.7%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Dev-Build-Log.png","sourceStatusCode":200,"destWidth":1876,"destHeight":606,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx23/cdn54@2020_4/2020/08/25/02-05-22-675_d68bc522d4a388b6.webp","sourceBytes":130077,"destBytes":105452,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1109,"convertSpendMs":57,"createdTime":"2020-08-25 10:05:22","host":"us-006*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx23","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"127 KB","destSize":"103 KB","compressRate":"81.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis.png","sourceStatusCode":200,"destWidth":2646,"destHeight":1515,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn81@2020_5/2020/08/25/02-05-22-403_9acf7b6379ce6dd9.webp","sourceBytes":202228,"destBytes":319658,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":2041,"convertSpendMs":643,"createdTime":"2020-08-25 10:05:21","host":"us-030*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx22","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"197.5 KB","destSize":"312.2 KB","compressRate":"158.1%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-ClientTimings-Breakdown.png","sourceStatusCode":200,"destWidth":2289,"destHeight":852,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx12/cdn61@2020_3/2020/08/25/02-05-22-614_3da41c799143791b.webp","sourceBytes":31846,"destBytes":31846,"feedId":12609,"totalSpendMs":1251,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:22","host":"europe-56*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx12","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"31.1 KB","destSize":"31.1 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/HTTPS-ClientTimings.png","sourceStatusCode":200,"destWidth":2716,"destHeight":840,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx14/cdn38@2020_2/2020/08/25/02-05-22-388_4e611aa43d2cc202.webp","sourceBytes":133884,"destBytes":133884,"feedId":12609,"totalSpendMs":1573,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:22","host":"europe64*","referer":"https://nickcraver.com/blog/2017/05/22/https-on-stack-overflow/","linkMd5ListStr":"052bb6f1bc2d1a84e7e0b850104d56df","githubUser":"myreaderx14","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"130.7 KB","destSize":"130.7 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-MiniProfiler.png","sourceStatusCode":200,"destWidth":1440,"destHeight":1538,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx32/cdn57@2020_4/2020/08/25/02-05-22-620_a4e14321e5a842eb.webp","sourceBytes":59912,"destBytes":59912,"feedId":12609,"totalSpendMs":1330,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:22","host":"europe68*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx32","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"58.5 KB","destSize":"58.5 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Installed-Small.jpg","sourceStatusCode":200,"destWidth":954,"destHeight":1272,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx10/cdn69@2020_5/2020/08/25/02-05-22-859_8f554f2b4853410b.webp","sourceBytes":200488,"destBytes":116040,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1206,"convertSpendMs":108,"createdTime":"2020-08-25 10:05:22","host":"us-022*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx10","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"195.8 KB","destSize":"113.3 KB","compressRate":"57.9%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Deployment-Translations-3.png","sourceStatusCode":200,"destWidth":2116,"destHeight":900,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx19/cdn45@2020_6/2020/08/25/02-05-22-842_0d980df37fcf38e4.webp","sourceBytes":55980,"destBytes":205668,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1290,"convertSpendMs":186,"createdTime":"2020-08-25 10:05:22","host":"us-030*","referer":"https://nickcraver.com/blog/2016/05/03/stack-overflow-how-we-do-deployment-2016-edition/","linkMd5ListStr":"98f7d9bbe42bf70a9d5975a7fdda0f94","githubUser":"myreaderx19","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"54.7 KB","destSize":"200.8 KB","compressRate":"367.4%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-Network-Denver-Racked-Small.jpg","sourceStatusCode":200,"destWidth":954,"destHeight":1272,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx15/cdn74@2020_5/2020/08/25/02-05-22-891_e159cecf727f932f.webp","sourceBytes":217212,"destBytes":128886,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1191,"convertSpendMs":79,"createdTime":"2020-08-25 10:05:22","host":"us-010*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx15","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"212.1 KB","destSize":"125.9 KB","compressRate":"59.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-HAProxy-Control.png","sourceStatusCode":200,"destWidth":2201,"destHeight":829,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx8/cdn41@2020_1/2020/08/25/02-05-22-887_300a94aa8b41a903.webp","sourceBytes":88822,"destBytes":140278,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1546,"convertSpendMs":376,"createdTime":"2020-08-25 10:05:22","host":"us-52*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx8","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"86.7 KB","destSize":"137 KB","compressRate":"157.9%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Instance.png","sourceStatusCode":200,"destWidth":2680,"destHeight":1591,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx6/cdn82@2020_6/2020/08/25/02-05-22-773_89e401ad7eeae145.webp","sourceBytes":110946,"destBytes":110946,"feedId":12609,"totalSpendMs":1465,"convertSpendMs":0,"createdTime":"2020-08-25 10:05:22","host":"europe-60*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx6","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"108.3 KB","destSize":"108.3 KB","compressRate":"100%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Database-Unused-Indexes.png","sourceStatusCode":200,"destWidth":2643,"destHeight":1389,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx7/cdn66@2020_6/2020/08/25/02-05-22-895_e0e544c019fd8f9c.webp","sourceBytes":131456,"destBytes":222444,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1476,"convertSpendMs":147,"createdTime":"2020-08-25 10:05:22","host":"us-034*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx7","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"128.4 KB","destSize":"217.2 KB","compressRate":"169.2%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Databases.png","sourceStatusCode":200,"destWidth":2691,"destHeight":1169,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx2/cdn85@2020_6/2020/08/25/02-05-23-038_0daae771294260cb.webp","sourceBytes":87240,"destBytes":152908,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1319,"convertSpendMs":124,"createdTime":"2020-08-25 10:05:22","host":"us-038*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx2","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"85.2 KB","destSize":"149.3 KB","compressRate":"175.3%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Hardware-VMs-Rear-Small.jpg","sourceStatusCode":200,"destWidth":944,"destHeight":1259,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx31/cdn77@2020_4/2020/08/25/02-05-22-859_4e936f157c3a58b5.webp","sourceBytes":190016,"destBytes":148106,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1723,"convertSpendMs":73,"createdTime":"2020-08-25 10:05:22","host":"europe-22*","referer":"https://nickcraver.com/blog/2016/03/29/stack-overflow-the-hardware-2016-edition/","linkMd5ListStr":"ba8afca96fcf06846d46525e6eee54a0","githubUser":"myreaderx31","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"185.6 KB","destSize":"144.6 KB","compressRate":"77.9%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-SQL-Top-Query.png","sourceStatusCode":200,"destWidth":2650,"destHeight":1473,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx11/cdn89@2020_1/2020/08/25/02-05-23-217_3a06f1f45409cd54.webp","sourceBytes":137081,"destBytes":224138,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1494,"convertSpendMs":221,"createdTime":"2020-08-25 10:05:22","host":"us-026*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx11","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"133.9 KB","destSize":"218.9 KB","compressRate":"163.5%"},{"code":1,"isDone":false,"source":"https://nickcraver.com/blog/content/SO-Monitoring/SO-Monitoring-Opserver-Redis-Instance.png","sourceStatusCode":200,"destWidth":2646,"destHeight":1559,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx22/cdn93@2020_3/2020/08/25/02-05-23-335_633bd44ed5d09b10.webp","sourceBytes":123702,"destBytes":194336,"targetWebpQuality":75,"feedId":12609,"totalSpendMs":1534,"convertSpendMs":324,"createdTime":"2020-08-25 10:05:22","host":"us-014*","referer":"https://nickcraver.com/blog/2018/11/29/stack-overflow-how-we-do-monitoring/","linkMd5ListStr":"713967dc9aad30c7ea15c222a5315b0f","githubUser":"myreaderx22","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"120.8 KB","destSize":"189.8 KB","compressRate":"157.1%"}],"successGithubMap":{"myreaderx8":4,"myreaderx14":4,"myreaderx7":4,"myreaderx15":4,"myreaderx16":4,"myreaderx6":4,"myreaderx32":4,"myreaderx4":3,"myreaderx10":4,"myreaderx11":4,"myreaderx33":3,"myreaderx3":3,"myreaderx12":4,"myreaderx2":4,"myreaderx1":3,"myreaderx13":3,"myreaderx30":3,"myreaderx31":4,"myreaderx18":3,"myreaderx19":4,"myreaderx":2,"myreaderx25":3,"myreaderx27":3,"myreaderx21":4,"myreaderx22":4,"myreaderx23":4,"myreaderx24":4,"myreaderx5oss":2,"myreaderx29":3},"failGithubMap":{}}