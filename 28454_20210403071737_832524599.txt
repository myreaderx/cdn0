{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2021-04-03 15:14:08","updatedTime":"2021-04-03 15:14:08","title":"Browser Image Compressionで画像をアップロード前に圧縮する[Javascript]","link":"http://bashalog.c-brains.jp/21/03/08-190000.php","description":"\n                  <p>どうもfujiharaです。本日は画像をアップロード前に圧縮できる\n<a href=\"https://www.npmjs.com/package/browser-image-compression\" target='_blank'>BrowserImageCompression</a>をご紹介します。</p>\n\n<h2>インストール</h2>\n<pre>\n<code>\nnpm install browser-image-compression --save\nor\nyarn add browser-image-compression\n</code>\n</pre>\n\n<h2>コード</h2>\n<p>以下が簡単な確認用コードになります。(react-create-appで作成)</p>\n\n<pre>\n<code>\nimport './App.css';\nimport { useState } from 'react';\nimport imageCompression from 'browser-image-compression';\n\n<p>function App() {<br />\n  const [image_url, setImageUrl] = useState('');<br />\n  const compressOption = {<br />\n    maxSizeMB: 1,<br />\n    maxWidthOrHeight: 1024<br />\n  };</p>\n\n<p>  return (<br />\n    &#60;div className=\"App\"&#62;<br />\n      &#60;form onSubmit={async (e) =&#62; {<br />\n        e.preventDefau&#60;();<br />\n        const form = new FormData(e.target);<br />\n        const postForm = new FormData();<br />\n        const file = form.get('image');<br />\n        const compressFile = await imageCompression(file ,compressOption);<br />\n        postForm.append('image', compressFile, file.name);<br />\n        alert(`default_size: ${file.size} \\n compressed_size: ${compressFile.size}`);</p>\n\n<p>        // fetch postForm<br />\n      }}<br />\n      &#62;<br />\n        &#60;input name=\"image\" accept=\"image/jpeg,image/png\" type=\"file\"<br />\n          onChange={async (e) =&#62; {<br />\n            setImageUrl('');<br />\n            if (!e.target.files[0]) {<br />\n              return;<br />\n            }<br />\n            const img = e.target.files[0];<br />\n            try {<br />\n              const compressFile = await imageCompression(img, compressOption);<br />\n              const url = await imageCompression.getDataUrlFromFile(compressFile);<br />\n              setImageUrl(url);<br />\n            } catch (error) {<br />\n              console.log(error);<br />\n            }<br />\n          }}<br />\n        /&#62;<br />\n        {image_url && &#60;figure&#62;<br />\n          &#60;img src={image_url} alt=''/&#62;<br />\n        &#60;/figure&#62;<br />\n        }<br />\n        &#60;div className='mod-button'&#62;<br />\n          &#60;button type=\"submit\"&#62;送信&#60;/button&#62;<br />\n        &#60;/div&#62;<br />\n      &#60;/form&#62;<br />\n    &#60;/div&#62;<br />\n  );<br />\n}</p>\n\n<p>export defau&#60; App;<br />\n</code><br />\n</pre></p>\n\n<p><a href=\"http://bashalog.c-brains.jp/images/fujihara_20210304.gif\"><img alt=\"fujihara_20210304.gif\" src=\"http://bashalog.c-brains.jp/assets_c/2021/03/fujihara_20210304-thumb-1148x716-3582.gif\" width=\"1148\" height=\"716\" class=\"mt-image-center\" style=\"text-align: center; display: block; margin: 0 auto 20px;\" /></a></p>\n\n<h2>説明</h2>\n<p>ファイルを選択したときと、送信ボタンを押した時に圧縮処理が入っています。\n圧縮時のオプションですが、最大サイズを1Mにし最大縦横を1024pxにしました。\nまずonChange箇所です。inputが変わった時にまず\nimgタグに使用するsrcの初期化を行い、ファイルが選択されていない場合は終了。選択されている場合は\n圧縮しURLを取得するとimgタグのsrcに入るようしています。\n(表示された画像は圧縮後のもの）</p>\n\n<pre>\n<code>\n          onChange={async (e) =&#62; {\n            setImageUrl('');\n            if (!e.target.files[0]) {\n              return;\n            }\n            const img = e.target.files[0];\n            try {\n              const compressFile = await imageCompression(img, compressOption);\n              const url = await imageCompression.getDataUrlFromFile(compressFile);\n              setImageUrl(url);\n            } catch (error) {\n              console.log(error);\n            }\n          }}\n</code>\n</pre>\n\n<p>次にformのsubmit時です。onChangeの時と同様に、通常ファイルを取得・圧縮して、\nFormDataにアタッチしています。\n(ファイルオブジェクトをステートに持ちたくないため、onChangeの時と圧縮処理が2重になっています）\n今回は送信せずに圧縮前後でのファイルサイズをalertするだけになっています。\n</p>\n\n<pre>\n<code>\n        e.preventDefault();\n        const form = new FormData(e.target);\n        const postForm = new FormData();\n        const file = form.get('image');\n        const compressFile = await imageCompression(file ,compressOption);\n        postForm.append('image', compressFile, file.name);\n        alert(`default_size: ${file.size} \\n compressed_size: ${compressFile.size}`);\n\n<p>        //fetch data....<br />\n</code><br />\n</pre></p>\n\n<h2>まとめ</h2>\n<p>いかがでしたでしょうか、これでユーザーがスマホの場合などに送信するパケットを抑えることができます。\n今回設定したオプションは最大ファイルサイズ、縦横幅（比率を保ったまま圧縮）です。\n他のオプションもあるので公式サイトで確認してみてください。\n</p>\n            ","descriptionType":"text/html","publishedDate":"Mon, 08 Mar 2021 10:00:00 +0000","feedId":28454,"bgimg":"http://bashalog.c-brains.jp/assets_c/2021/03/fujihara_20210304-thumb-1148x716-3582.gif","linkMd5":"768c713a61aec1a79ab6d334cfdfad9a","bgimgJsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn53@2020_3/2021/04/03/07-17-04-372_d37e77dda9955d92.webp","destWidth":1148,"destHeight":716,"sourceBytes":708515,"destBytes":1921658,"author":"fujihara","articleImgCdnMap":{"http://bashalog.c-brains.jp/assets_c/2021/03/fujihara_20210304-thumb-1148x716-3582.gif":"https://cdn.jsdelivr.net/gh/myreaderx/cdn57@2020_1/2021/04/03/07-17-36-029_d37e77dda9955d92.webp"},"publishedOrCreatedDate":1617434048189}],"record":{"createdTime":"2021-04-03 15:14:08","updatedTime":"2021-04-03 15:14:08","feedId":28454,"fetchDate":"Sat, 03 Apr 2021 07:14:08 +0000","fetchMs":920,"handleMs":9,"totalMs":210024,"newArticles":0,"totalArticles":30,"status":1,"type":0,"ip":"5b459d886058db9a6adca33fd0f75907","hostName":"us-035*","requestId":"984d9ff09cc6495f8499d22929422634_28454","contentType":"text/xml","totalBytes":1921658,"bgimgsTotal":1,"bgimgsGithubTotal":1,"articlesImgsTotal":1,"articlesImgsGithubTotal":1,"successGithubMap":{"myreaderx4":1,"myreaderx":1},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 02:44:10","updatedTime":"2020-09-07 04:47:47","id":28454,"name":"バシャログ。","url":"http://bashalog.c-brains.jp/index.xml","subscriber":114,"website":null,"icon":"http://bashalog.c-brains.jp/favicon.ico","icon_jsdelivr":"https://cdn.jsdelivr.net/gh/myreaderx62/cdn63@2020_1/2020/09/06/20-47-46-875_d818c23c759f7b14.ico","description":"横浜のシーブレイン Web制作スタッフによる技術情報ブログ。WebデザインやFireworks、WordPress、EC-CUBE、CakePHPなどの情報が満載！","weekly":null,"link":null},"noPictureArticleList":[],"tmpCommonImgCdnBytes":0,"tmpBodyImgCdnBytes":1921658,"tmpBgImgCdnBytes":0,"extra4":{"start":1617434047086,"total":0,"statList":[{"spend":1094,"msg":"获取xml内容"},{"spend":9,"msg":"解释文章"},{"spend":58320,"msg":"上传封面图到cdn"},{"spend":0,"msg":"修正封面图上传失败重新上传"},{"spend":88589,"msg":"正文链接上传到cdn"}]},"extra5":1,"extra6":1,"extra7ImgCdnFailResultVector":[null,null,null],"extra10_invalidATagHrefValue":{},"extra111_proxyServerAndStatMap":{"http://us-009.herokuapp.com/":{"failCount":1,"successCount":0,"resultList":[null]},"http://europe-60.herokuapp.com/":{"failCount":0,"successCount":1,"resultList":[200]}},"extra12ImgCdnSuccessResultVector":[{"code":1,"isDone":false,"source":"http://bashalog.c-brains.jp/assets_c/2021/03/fujihara_20210304-thumb-1148x716-3582.gif","sourceStatusCode":200,"destWidth":1148,"destHeight":716,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx4/cdn53@2020_3/2021/04/03/07-17-04-372_d37e77dda9955d92.webp","sourceBytes":708515,"destBytes":1921658,"targetWebpQuality":75,"feedId":28454,"totalSpendMs":56418,"convertSpendMs":53711,"createdTime":"2021-04-03 15:16:08","host":"us-021*","referer":"http://bashalog.c-brains.jp/21/03/08-190000.php","linkMd5ListStr":"768c713a61aec1a79ab6d334cfdfad9a,768c713a61aec1a79ab6d334cfdfad9a","githubUser":"myreaderx4","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"691.9 KB","destSize":"1.8 MB","compressRate":"271.2%"},{"code":1,"isDone":false,"source":"http://bashalog.c-brains.jp/assets_c/2021/03/fujihara_20210304-thumb-1148x716-3582.gif","sourceStatusCode":200,"destWidth":1148,"destHeight":716,"fixedGithubDest":"https://cdn.jsdelivr.net/gh/myreaderx/cdn57@2020_1/2021/04/03/07-17-36-029_d37e77dda9955d92.webp","sourceBytes":708515,"destBytes":1921658,"targetWebpQuality":75,"feedId":28454,"totalSpendMs":28081,"convertSpendMs":24387,"createdTime":"2021-04-03 15:17:08","host":"europe-60*","referer":"http://bashalog.c-brains.jp/21/03/08-190000.php","linkMd5ListStr":"768c713a61aec1a79ab6d334cfdfad9a,768c713a61aec1a79ab6d334cfdfad9a","githubUser":"myreaderx","githubHttpCode":201,"extra22GetBytesInfo":"1、没有Referer字段","extra23historyStatusCode":[200],"sourceSize":"691.9 KB","destSize":"1.8 MB","compressRate":"271.2%"}],"successGithubMap":{"myreaderx4":1,"myreaderx":1},"failGithubMap":{}}